<html><head></head><body>
		<div>
			<div id="_idContainer254" class="Content">
			</div>
		</div>
		<div id="_idContainer255" class="Content">
			<h1 id="_idParaDest-214"><a id="_idTextAnchor229"/>7. Advanced Form Validation and Model Forms</h1>
		</div>
		<div id="_idContainer287" class="Content">
			<p class="callout-heading">Overview</p>
			<p class="callout">Continuing your journey with the Bookr application, you will begin this chapter by adding a new form to your app with custom multi-field validation and form cleaning. You will learn how to set the initial values on your form and customize the widgets (the HTML input elements that are being generated). Then you will be introduced to the <strong class="source-inline">ModelForm</strong> class, which allows a form to be automatically created from a model. You will use it in a view to automatically save the new or changed <strong class="source-inline">Model</strong> instance.</p>
			<p class="callout">By the end of this chapter, you will know how to add extra multi-field validation to Django forms, how to customize and set form widgets for fields, how to use <strong class="source-inline">ModelForms</strong> to automatically create a form from a Django model, and how to automatically create <strong class="source-inline">Model</strong> instances from <strong class="source-inline">ModelForms</strong>.</p>
			<h1 id="_idParaDest-215"><a id="_idTextAnchor230"/>Introduction</h1>
			<p>This chapter builds upon the knowledge we gained in <em class="italic">Chapter 6</em>, <em class="italic">Forms</em>, where we learned how to submit data from an HTML form to a Django view, both with a manually built HTML form and with a Django form. We used Django's <strong class="source-inline">form</strong> library to build and automatically validate forms with basic validation. For example, now we can build forms that check whether a date is entered in its desired format, whether a number is input where a user must enter their age, and whether a dropdown is selected before the user clicks the <strong class="source-inline">Submit</strong> button. However, most large-scale websites require validation that is a bit more advanced.</p>
			<p>For instance, a certain field might only be required if another field is set. Let's say we want to add a checkbox to allow users to sign up for our monthly newsletter. It has a textbox below it that lets them enter their email address. With some basic validation, we can check whether:</p>
			<ul>
				<li>The user has checked the checkbox.</li>
				<li>The user has entered their email address. </li>
			</ul>
			<p>When the user clicks the <strong class="source-inline">Submit</strong> button, we will be able to validate whether both fields are actioned. But what if the user doesn't want to sign up for our newsletter? If they click the <strong class="source-inline">Submit</strong> button, ideally, both fields should be blank. That's where validating each individual field might not work. </p>
			<p>Another example could be a case where we have two fields and each has a maximum value of, say, 50. But the total of values added to each one must be less than 75. We will start the chapter by looking at how to write custom validation rules to solve such problems.</p>
			<p>Later, as we progress in the chapter, we will look at how to set initial values on a form. This can be useful when automatically filling out information that is already known to the user. For example, we can automatically put a user's contact information into a form if that user is logged in.</p>
			<p>We will finish the chapter by looking at model forms, which will let us automatically create a form from a Django <strong class="source-inline">Model</strong> class. This cuts down the amount of code that needs to be written to create a new <strong class="source-inline">Model</strong> instance.</p>
			<h1 id="_idParaDest-216"><a id="_idTextAnchor231"/>Custom Field Validation and Cleaning</h1>
			<p>We have seen how a Django form converts values from an HTTP request, which are strings, into Python objects. In a non-custom Django form, the target type is dependent on the field class. For example, the Python type derived from <strong class="source-inline">IntegerField</strong> is <strong class="source-inline">int</strong>, and string values are given to us verbatim, as the user entered them. But we can also implement methods on our <strong class="source-inline">Form</strong> class to alter the output values from our fields in any way we choose. The allows us to clean or filter the user's input data to fit what we expect better. We could round an integer to the nearest multiple of ten to fit into a batch size for ordering specific items. Or we could transform an email address to lowercase so that the data is consistent for searching.</p>
			<p>We can also implement some custom validators. We will look at a couple of different ways of validating fields: by writing a custom validator, and by writing a custom <strong class="source-inline">clean</strong> method for the field. Each method has its pros and cons: a custom validator can be applied to different fields and forms, so you do not have to write the validation logic for each field; a custom <strong class="source-inline">clean</strong> method must be implemented on each form you want to clean, but is more powerful and allows validation using other fields in the form or changing the cleaned value that the field returns.</p>
			<h2 id="_idParaDest-217"><a id="_idTextAnchor232"/>Custom Validators</h2>
			<p>A validator is simply a function that accepts a value and raises <strong class="source-inline">django.core.exceptions.ValidationError</strong> if the value is invalid – the validity is determined by the code you write. The value is a Python object (that is, <strong class="source-inline">cleaned_data</strong> that has already been converted from the <strong class="source-inline">POST</strong> request string).</p>
			<p>Here is a simple example that validates whether a value is lowercase:</p>
			<p class="source-code">from django.core.exceptions import ValidationError</p>
			<p class="source-code">def validate_lowercase(value):</p>
			<p class="source-code">  if value.lower() != value:</p>
			<p class="source-code">    raise ValidationError("{} is not lowercase."\</p>
			<p class="source-code">                          .format(value))</p>
			<p>Notice the function does not return anything, for either success or failure. It will just raise <strong class="source-inline">ValidationError</strong> if the value is not valid.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Note that the behavior and handling of <strong class="source-inline">ValidationError</strong> differ from how other exceptions behave in Django. Normally, if you raise an exception in your view, you will end up with a <strong class="source-inline">500</strong> response from Django (if you do not handle the exception in your code). </p>
			<p class="callout">When raising <strong class="source-inline">ValidationError</strong> in your validation/cleaning code, the Django <strong class="source-inline">form</strong> class will catch the error for you and then the <strong class="source-inline">is_valid</strong> method of <strong class="source-inline">form</strong> will return <strong class="source-inline">False</strong>. You do not have to write <strong class="source-inline">try</strong>/<strong class="source-inline">except</strong> handlers around the code that might raise <strong class="source-inline">ValidationError</strong>.</p>
			<p>The validator can be passed to the <strong class="source-inline">validators</strong> argument of a field constructor on a form, inside a list; for example, to our <strong class="source-inline">text_input</strong> field from our <strong class="source-inline">ExampleForm</strong>:</p>
			<p class="source-code">class ExampleForm(forms.Form):</p>
			<p class="source-code">  text_input = forms.CharField(validators=[validate_lowercase])</p>
			<p>Now, if we submit the form and the fields contain uppercase values, we will get an error, as shown in the following figure:</p>
			<div>
				<div id="_idContainer256" class="IMG---Figure">
					<img src="image/B15509_07_01.jpg" alt="Figure 7.1: Lowercase text validator in action&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.1: Lowercase text validator in action</p>
			<p>The validator function can be used on any number of fields. In our example, if we wanted lots of fields to have lowercase enforced, <strong class="source-inline">validate_lowercase</strong> could be passed to all of them. Let's now look at how we could implement this another way, with a custom <strong class="source-inline">clean</strong> method. </p>
			<h2 id="_idParaDest-218"><a id="_idTextAnchor233"/>Cleaning Methods</h2>
			<p>A <strong class="source-inline">clean</strong> method is created on the <strong class="source-inline">Form</strong> class and is named in the format <strong class="source-inline">clean_field-name</strong>. For example, the <strong class="source-inline">clean</strong> method for <strong class="source-inline">text_input</strong> would be called <strong class="source-inline">clean_text_input</strong>, the <strong class="source-inline">clean</strong> method for <strong class="source-inline">books_you_own</strong> would be <strong class="source-inline">clean_books_you_own</strong>, and so on.</p>
			<p>Cleaning methods take no arguments; instead, they should use the <strong class="source-inline">cleaned_data</strong> attribute on <strong class="source-inline">self</strong> to access the field data. This dictionary will contain the data after being cleaned in the standard Django way, as we saw in the previous example. The <strong class="source-inline">clean</strong> method must return the cleaned value, which will replace the original value in the <strong class="source-inline">cleaned_data</strong> dictionary. Even if the method does not change the value, a value must be returned. You can also use the <strong class="source-inline">clean </strong>method to raise <strong class="source-inline">ValidationError</strong>, and the error will be attached to the field (the same as with a validator).</p>
			<p>Let's re-implement the lowercase validator as a <strong class="source-inline">clean</strong> method, like this:</p>
			<p class="source-code">class ExampleForm(forms.Form):</p>
			<p class="source-code">   text_input = forms.CharField()</p>
			<p class="source-code">  …</p>
			<p class="source-code">  def clean_text_input(self):</p>
			<p class="source-code">    value = self.cleaned_data['text_input']</p>
			<p class="source-code">    if value.lower() != value:</p>
			<p class="source-code">      raise ValidationError("{} is not lowercase."\</p>
			<p class="source-code">                            .format(value))\</p>
			<p class="source-code">    return value</p>
			<p>You can see the logic is essentially the same, except we must return the validated value at the end. If we submit the form, we get the same result as the previous time we tried (<em class="italic">Figure 7.1</em>).</p>
			<p>Let's look at one more cleaning example. Instead of raising an exception when the value is invalid, we could just convert the value to lowercase. We would implement that with this code:</p>
			<p class="source-code">class ExampleForm(forms.Form):</p>
			<p class="source-code">  text_input = forms.CharField()</p>
			<p class="source-code">  …</p>
			<p class="source-code">  def clean_text_input(self):</p>
			<p class="source-code">    value = self.cleaned_data['text_input']</p>
			<p class="source-code">    return value.lower()</p>
			<p>Now, consider that we enter text into the input as uppercase:</p>
			<div>
				<div id="_idContainer257" class="IMG---Figure">
					<img src="image/B15509_07_02.jpg" alt="Figure 7.2: ALL UPPERCASE text entered&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.2: ALL UPPERCASE text entered</p>
			<p>If we were to examine the cleaned data using our debug output from the view, we would see that it is lowercase:</p>
			<div>
				<div id="_idContainer258" class="IMG---Figure">
					<img src="image/B15509_07_03.jpg" alt="Figure 7.3: The cleaned data has been transformed to lowercase&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.3: The cleaned data has been transformed to lowercase</p>
			<p>These were just a couple of simple examples of how to validate fields using both validators and <strong class="source-inline">clean</strong> methods. You can, of course, make each type of validation much more complex if you wish and transform the data in more complex ways using a <strong class="source-inline">clean</strong> method.</p>
			<p>So far, you have only learned simple methods for form validation, where you have treated each field independently. A field is valid (or not) based only on the information it contains and nothing else. What if the validity of one field depends on what the user entered into another field? An example of this might be that you have an <strong class="source-inline">email</strong> field to collect someone's email address if they want to be signed up to a mailing list. The field is only required if they check a checkbox that indicates they wanted to be signed up. Neither of these fields is required on their own – we do not want the checkbox to be required to be checked, but if it is checked, then the <strong class="source-inline">email</strong> field should be required too.</p>
			<p>In the next section, we will show how you can validate a form whose fields depend on each other by overriding the <strong class="source-inline">clean</strong> method in your form.</p>
			<h2 id="_idParaDest-219"><a id="_idTextAnchor234"/>Multi-Field Validation</h2>
			<p>We have just looked at the <strong class="source-inline">clean_&lt;field-name&gt;</strong> methods that can be added to a Django form, to clean a specific field. Django also allows us to override the <strong class="source-inline">clean</strong> method, in which we can access all the <strong class="source-inline">cleaned_data</strong> from all fields, and we know that all custom field methods have been called. This allows the validation of fields based on another field's data.</p>
			<p>Referring to our previous example with a form that has an email address that is only required if a checkbox is checked, we will see how we can implement this using the <strong class="source-inline">clean</strong> method.</p>
			<p>First, create a <strong class="source-inline">Form</strong> class and add two fields – make them both optional with the <strong class="source-inline">required=False</strong> argument:</p>
			<p class="source-code">class NewsletterSignupForm(forms.Form):</p>
			<p class="source-code">  signup = forms.BooleanField\</p>
			<p class="source-code">           (label="Sign up to newsletter?", required=False)</p>
			<p class="source-code">  email = forms.EmailField\</p>
			<p class="source-code">          (help_text="Enter your email address to subscribe", \</p>
			<p class="source-code">           required=False)</p>
			<p>We have also introduced two new arguments that can be used for any field:</p>
			<ul>
				<li><strong class="source-inline">label</strong><p>This allows setting the label text for a field. As we have seen, Django will automatically generate label text from the field name. If you set the <strong class="source-inline">label</strong> argument, you can override this default. Use this argument if you want to have a more descriptive label.</p></li>
				<li><strong class="source-inline">help_text</strong><p>If you need to have more information displayed regarding what input a field requires, you can use this argument. By default, it is displayed after the field.</p></li>
			</ul>
			<p>When rendered, the form looks like this:</p>
			<p> </p>
			<div>
				<div id="_idContainer259" class="IMG---Figure">
					<img src="image/B15509_07_04.jpg" alt="Figure 7.4: Email signup form with custom label and help text&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.4: Email signup form with custom label and help text</p>
			<p>If we were to submit the form now, without entering any data, nothing would happen. Neither field is required, so the form validates fine.</p>
			<p>Now we can add the multi-field validation to the <strong class="source-inline">clean</strong> method. We will check whether the <strong class="source-inline">signup</strong> checkbox is checked, and then check that the <strong class="source-inline">email</strong> field has a value. The built-in Django methods have already validated that the email address is valid at this point, so we then just need to check that a value exists for it. We will then use the <strong class="source-inline">add_error</strong> method to set an error for the <strong class="source-inline">email</strong> field. This is a method you haven't seen before but it's very simple; it takes two arguments – the name of the field to set the error on, and the text of the error.</p>
			<p>Here is the code for the <strong class="source-inline">clean</strong> method:</p>
			<p class="source-code">class NewsletterSignupForm(forms.Form):</p>
			<p class="source-code">  …</p>
			<p class="source-code">  def clean(self):</p>
			<p class="source-code">    cleaned_data = super().clean()</p>
			<p class="source-code">    if cleaned_data["signup"] and not cleaned_data.get("email"):</p>
			<p class="source-code">    self.add_error\</p>
			<p class="source-code">    ("email", \</p>
			<p class="source-code">     "Your email address is required if signing up for the newsletter.")</p>
			<p>Your <strong class="source-inline">clean</strong> method must always call the <strong class="source-inline">super().clean()</strong> method to retrieve the cleaned data. When <strong class="source-inline">add_error</strong> is called to add errors to the form, the form will no longer validate (the <strong class="source-inline">is_valid</strong> method returns <strong class="source-inline">False</strong>).</p>
			<p>Now if we submit the form without the checkbox checked, there is still no error generated, but if you check the checkbox without an email address, you will receive the error we just wrote the code for:</p>
			<div>
				<div id="_idContainer260" class="IMG---Figure">
					<img src="image/B15509_07_05.jpg" alt="Figure 7.5: Error displayed when attempting to sign up with no email address&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.5: Error displayed when attempting to sign up with no email address</p>
			<p>You might notice that we are retrieving the email from the <strong class="source-inline">cleaned_data</strong> dictionary using the <strong class="source-inline">get</strong> method. The reason for doing this is if the <strong class="source-inline">email</strong> value in the form is invalid, then the <strong class="source-inline">email</strong> key will not exist in the dictionary. The browser should prevent the user from submitting the form if an invalid email has been entered, but a user might be using an older browser that does not support this client-side validation, so for safety, we use the <strong class="source-inline">get</strong> method. Since the <strong class="source-inline">signup</strong> field is <strong class="source-inline">BooleanField</strong>, and not required, it will only be invalid if a custom validation function is used. We are not using one here, so it is safe to access its value using square bracket notation.</p>
			<p>There is one more validation scenario to consider before moving on to our first exercise, and that is adding errors that are not specific to any field. Django calls these <em class="italic">non-field errors</em>. There are many scenarios where you might want to use these when multiple fields are dependent on each other. </p>
			<p>Take, for example, a shopping website. Your order form could have two numeric fields whose totals could not exceed a certain value. If the total were exceeded, the value of either field could be decreased to bring the total below the maximum value, so the error is not specific to either one of the fields. To add a non-field error, call the <strong class="source-inline">add_error</strong> method with <strong class="source-inline">None</strong> as the first argument.</p>
			<p>Let us look at how to implement this. In this example, we will have a form where the user can specify a certain number of items to order, for item A or item B. The user cannot order more than 100 items in total. The fields will have a <strong class="source-inline">max_value</strong> of <strong class="source-inline">100</strong>, and <strong class="source-inline">min_value</strong> of <strong class="source-inline">0</strong>, but custom validation in the <strong class="source-inline">clean</strong> method will need to be written to handle the validation of the total amount:</p>
			<p class="source-code">class OrderForm(forms.Form):</p>
			<p class="source-code">  item_a = forms.IntegerField(min_value=0, max_value=100)</p>
			<p class="source-code">  item_b = forms.IntegerField(min_value=0, max_value=100)\</p>
			<p class="source-code">  def clean(self):</p>
			<p class="source-code">    cleaned_data = super().clean()</p>
			<p class="source-code">    if cleaned_data.get("item_a", 0) + cleaned_data.get\</p>
			<p class="source-code">                                       ("item_b", 0) &gt; 100:</p>
			<p class="source-code">      self.add_error\</p>
			<p class="source-code">      (None, \</p>
			<p class="source-code">       "The total number of items must be 100 or less.")</p>
			<p>The fields (<strong class="source-inline">item_a</strong> and <strong class="source-inline">item_b</strong>) are added in the normal way, with standard validation rules. You can see that we have used the <strong class="source-inline">clean</strong> method the same way we used it before. Moreover, we have implemented the maximum item logic inside this method. The following line is what registers the non-field error if the maximum items are exceeded:</p>
			<p class="source-code">self.add_error(None, \</p>
			<p class="source-code">               "The total number of items must be 100 or less.")</p>
			<p>Once again, we access the values of <strong class="source-inline">item_a</strong> and <strong class="source-inline">item_b</strong> using the <strong class="source-inline">get</strong> method, with a default value of <strong class="source-inline">0</strong>. This is in case the user has an older browser (from 2011 or earlier) and was able to submit the form with invalid values.</p>
			<p>In a browser, the field-level validation ensures values between 0 and 100 have been entered in each field, and prevents the form from being submitted otherwise:</p>
			<div>
				<div id="_idContainer261" class="IMG---Figure">
					<img src="image/B15509_07_06.jpg" alt="Figure 7.6: The form cannot be submitted if one field exceeds the maximum value&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.6: The form cannot be submitted if one field exceeds the maximum value</p>
			<p>However, if we put in two values that sum to more than 100, we can see how Django displays the non-field error:</p>
			<div>
				<div id="_idContainer262" class="IMG---Figure">
					<img src="image/B15509_07_07.jpg" alt="Figure 7.7: Django non-field error displayed at the start of the form&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.7: Django non-field error displayed at the start of the form</p>
			<p>Django non-field errors are always displayed at the start of a form, before other fields or errors. In the next exercise, we will build a form that implements a validation function, a field clean method, and a form clean method.</p>
			<h2 id="_idParaDest-220"><a id="_idTextAnchor235"/>Exercise 7.01: Custom Clean and Validation Methods</h2>
			<p>In this exercise, you will build a new form that allows the user to create an order for books or magazines. It must have the following validation criteria:</p>
			<ul>
				<li>The user may order up to 80 magazines and/or 50 books, but the total number of items must not be more than 100. </li>
				<li>The user can choose to receive an order confirmation, and if they do, they must enter an email address.</li>
				<li>The user should not enter an email address if they have not chosen to receive an order confirmation.</li>
				<li>To ensure they are part of our company, the email address must be part of our company domain (in our case, we will just use <strong class="source-inline">example.com</strong>). </li>
				<li>For consistency with other email addresses in our fictional company, the address should be converted to lowercase. </li>
			</ul>
			<p>This sounds like a lot of rules, but with Django, it is simple if we tackle them one by one. We will carry on with the <strong class="source-inline">form_project</strong> app we started in <em class="italic">Chapter 6</em>, <em class="italic">Forms</em>. If you haven't completed <em class="italic">Chapter 6</em>, <em class="italic">Forms</em>, you can download the code from <a href="http://packt.live/2LRCczP">http://packt.live/2LRCczP</a>:</p>
			<ol>
				<li>In PyCharm, open the <strong class="source-inline">form_example</strong> app's <strong class="source-inline">forms.py</strong> file. <p class="callout-heading">Note</p><p class="callout">Make sure the Django dev server is not running, otherwise, it may crash as you make changes to this file, causing PyCharm to jump into the debugger.</p></li>
				<li>Since our work with <strong class="source-inline">ExampleForm</strong> is done, you can remove it from this file.</li>
				<li>Create a new class called <strong class="source-inline">OrderForm</strong> that inherits from <strong class="source-inline">forms.Form</strong>:<p class="source-code">class OrderForm(forms.Form):</p></li>
				<li>Add four fields to the class as follows:<ul><li><strong class="source-inline">magazine_count,</strong> <strong class="source-inline">IntegerField</strong> with <strong class="source-inline">min_value</strong> of <strong class="source-inline">0</strong> and <strong class="source-inline">max_value</strong> of <strong class="source-inline">80</strong></li><li><strong class="source-inline">book_count</strong>, <strong class="source-inline">IntegerField</strong> with <strong class="source-inline">min_value</strong> of <strong class="source-inline">0</strong> and <strong class="source-inline">max_value</strong> of <strong class="source-inline">50</strong></li><li><strong class="source-inline">send_confirmation</strong>, <strong class="source-inline">BooleanField</strong>, which is not required</li><li><strong class="source-inline">email</strong>, <strong class="source-inline">EmailField</strong>, which is also not required<p>The class should look like this:</p><p class="source-code">class OrderForm(forms.Form):</p><p class="source-code">  magazine_count = forms.IntegerField\</p><p class="source-code">                   (min_value=0, max_value=80)</p><p class="source-code">  book_count = forms.IntegerField\</p><p class="source-code">               (min_value=0, max_value=50)</p><p class="source-code">  send_confirmation = forms.BooleanField\</p><p class="source-code">                      (required=False)</p><p class="source-code">  email = forms.EmailField(required=False)</p></li></ul></li>
				<li>Add a validation function to check that the user's email address is on the right domain. First, <strong class="source-inline">ValidationError</strong> needs to be imported; add this line at the top of the file:<p class="source-code">from django.core.exceptions import ValidationError</p><p>Then write this function after the <strong class="source-inline">import</strong> line (before the <strong class="source-inline">OrderForm</strong> class implementation):</p><p class="source-code">def validate_email_domain(value):</p><p class="source-code">  if value.split("@")[-1].lower()!= "example.com":\</p><p class="source-code">      raise ValidationError\</p><p class="source-code">      ("The email address must be on the domain example.com.")</p><p>The function splits the email address on the <strong class="source-inline">@</strong> symbol, then checks whether the part after it is equal to <strong class="source-inline">example.com</strong>. This function alone would validate non-email addresses. For example, the string <strong class="source-inline">not-valid@someotherdomain@example.com</strong> would not cause <strong class="source-inline">ValidationError</strong> to be raised in this function. This is acceptable in our case because as we are using <strong class="source-inline">EmailField</strong>, the other standard field validators will check the email address validity.</p></li>
				<li>Add the <strong class="source-inline">validate_email_domain</strong> function as a validator to the <strong class="source-inline">email</strong> field on <strong class="source-inline">OrderForm</strong>. Update the <strong class="source-inline">EmailField</strong> constructor call to add a <strong class="source-inline">validators</strong> argument, passing in a list containing the validation function:<p class="source-code">class OrderForm(forms.Form):</p><p class="source-code">  …</p><p class="source-code">  <strong class="bold">email = forms.EmailField\</strong></p><p class="source-code"><strong class="bold">          (required=False, \</strong></p><p class="source-code"><strong class="bold">           validators=[validate_email_domain])</strong></p></li>
				<li>Add a <strong class="source-inline">clean_email</strong> method to the form to make sure the email address is lowercase:<p class="source-code">class OrderForm(forms.Form):</p><p class="source-code">  # truncated for brevity</p><p class="source-code">  <strong class="bold">def clean_email(self):</strong></p><p class="source-code"><strong class="bold">  return self.cleaned_data['email'].lower()</strong></p></li>
				<li>Now, add the <strong class="source-inline">clean</strong> method to perform all the cross-field validation. First, we will just add the logic for making sure that an email address is only entered if an order confirmation is requested:<p class="source-code">class OrderForm(forms.Form):</p><p class="source-code">  # truncated for brevity</p><p class="source-code"><strong class="bold">  def clean(self):</strong></p><p class="source-code"><strong class="bold">    cleaned_data = super().clean()</strong></p><p class="source-code"><strong class="bold">    if cleaned_data["send_confirmation"] and \</strong></p><p class="source-code"><strong class="bold">    not cleaned_data.get("email"):</strong></p><p class="source-code"><strong class="bold">        </strong><strong class="bold">self.add_error\</strong></p><p class="source-code"><strong class="bold">        ("email", \</strong></p><p class="source-code"><strong class="bold">         "Please enter an email address to "\</strong></p><p class="source-code"><strong class="bold">         "receive the confirmation message.")\</strong></p><p class="source-code"><strong class="bold">    elif cleaned_data.get("email") and \</strong></p><p class="source-code"><strong class="bold">    not cleaned_data["send_confirmation"]:</strong></p><p class="source-code"><strong class="bold">        self.add_error("send_confirmation", \</strong></p><p class="source-code"><strong class="bold">                       "Please check this if you want to receive \</strong></p><p class="source-code"><strong class="bold">                       "a confirmation email.")</strong></p><p>This will add an error to the <strong class="source-inline">email</strong> field if <strong class="source-inline">Send confirmation</strong> is checked but no email address is added: </p><div id="_idContainer263" class="IMG---Figure"><img src="image/B15509_07_08.jpg" alt="Figure 7.8: Error if Send confirmation is checked but no email address is added&#13;&#10;"/></div><p class="figure-caption">Figure 7.8: Error if Send confirmation is checked but no email address is added</p><p>Similarly, an error will be added to <strong class="source-inline">email</strong> if an email address is entered but <strong class="source-inline">Send confirmation</strong> is not checked:</p><div id="_idContainer264" class="IMG---Figure"><img src="image/B15509_07_09.jpg" alt="Figure 7.9: Error because an email has been entered but the user &#13;&#10;has not chosen to receive confirmation&#13;&#10;"/></div><p class="figure-caption">Figure 7.9: Error because an email has been entered but the user has not chosen to receive confirmation</p></li>
				<li>Add the final check, also inside the <strong class="source-inline">clean</strong> method. The total number of items should not be more than 100. We will add a non-field error if the sum of <strong class="source-inline">magazine_count</strong> and <strong class="source-inline">book_count</strong> is greater than 100:<p class="source-code">class OrderForm(forms.Form):</p><p class="source-code">  …</p><p class="source-code">  def clean(self):</p><p class="source-code">    …</p><p class="source-code">    <strong class="bold">item_total = cleaned_data.get("magazine_count", 0) \</strong></p><p class="source-code"><strong class="bold">                 + cleaned_data.get("book_count", 0)</strong></p><p class="source-code"><strong class="bold">    if item_total &gt; 100:</strong></p><p class="source-code"><strong class="bold">      self.add_error(None, \</strong></p><p class="source-code"><strong class="bold">                     "The total number of items "\</strong></p><p class="source-code"><strong class="bold">                     "must be 100 or less.")</strong></p><p>This will add a non-field error by passing <strong class="source-inline">None</strong> as the first argument to the <strong class="source-inline">add_error</strong> call.</p><p class="callout-heading">Note</p><p class="callout">Refer to <a href="http://packt.live/3nMP3R7">http://packt.live/3nMP3R7</a> for the complete code.</p><p>Save <strong class="source-inline">forms.py</strong>.</p></li>
				<li>Open the <strong class="source-inline">reviews</strong> app's <strong class="source-inline">views.py</strong> file. We will change the form <strong class="source-inline">import</strong> so that <strong class="source-inline">OrderForm</strong> is being imported instead of <strong class="source-inline">ExampleForm</strong>. Consider the following import line:<p class="source-code">from .forms import ExampleForm, SearchForm</p><p>Change it as follows:</p><p class="source-code">from .forms import OrderForm, SearchForm</p></li>
				<li>In the <strong class="source-inline">form_example</strong> view, change the two lines that use <strong class="source-inline">ExampleForm</strong> to use <strong class="source-inline">OrderForm</strong> instead. Consider the following line of code:<p class="source-code">form = ExampleForm(request.POST)</p><p>Change this as follows:</p><p class="source-code">form = OrderForm(request.POST)</p><p>Similarly, consider the following line of code:</p><p class="source-code">form = ExampleForm()</p><p>Change this as follows:</p><p class="source-code">form = OrderForm()</p><p>The rest of the function can stay as it is.</p><p>We don't have to make changes to the template. Start the Django dev server and navigate to <strong class="source-inline">http://127.0.0.1:8000/form-example/</strong> in your browser. You should see the form rendered as in <em class="italic">Figure 7.10</em>:</p><div id="_idContainer265" class="IMG---Figure"><img src="image/B15509_07_10.jpg" alt="Figure 7.10: OrderForm in the browser&#13;&#10;"/></div><p class="figure-caption">Figure 7.10: OrderForm in the browser</p></li>
				<li>Try submitting the form with a <strong class="source-inline">Magazine count</strong> of <strong class="source-inline">80</strong> and <strong class="source-inline">Book count</strong> of <strong class="source-inline">50</strong>. The browser will allow this, but as they sum to more than 100, an error will be triggered by the <strong class="source-inline">clean</strong> method in the form and displayed on the page:<div id="_idContainer266" class="IMG---Figure"><img src="image/B15509_07_11.jpg" alt="Figure 7.11: A non-field error displayed on the form when &#13;&#10;the maximum number of allowed items is exceeded&#13;&#10;"/></div><p class="figure-caption">Figure 7.11: A non-field error displayed on the form when the maximum number of allowed items is exceeded</p></li>
				<li>Try submitting the form with <strong class="source-inline">Send confirmation</strong> checked but the <strong class="source-inline">Email</strong> field blank. Then fill the <strong class="source-inline">Email</strong> textbox but uncheck <strong class="source-inline">Send confirmation</strong>. Either combination will give an error that both must be present. The error will differ based on which field is missing:<div id="_idContainer267" class="IMG---Figure"><img src="image/B15509_07_12.jpg" alt="Figure 7.12: Error message if no email address is present&#13;&#10;"/></div><p class="figure-caption">Figure 7.12: Error message if no email address is present</p></li>
				<li>Now try submitting the form with <strong class="source-inline">Send confirmation</strong> checked and an email address that is on the <strong class="source-inline">example.com</strong> domain. You should receive a message that your email address must have the domain <strong class="source-inline">example.com</strong>. You should also receive a message that <strong class="source-inline">email</strong> must be set – since email does not end up in the <strong class="source-inline">cleaned_data</strong> dictionary, as it is not valid:<div id="_idContainer268" class="IMG---Figure"><img src="image/B15509_07_13.jpg" alt="Figure 7.13: The error message is shown when the email domain is not example.com&#13;&#10;"/></div><p class="figure-caption">Figure 7.13: The error message is shown when the email domain is not example.com</p></li>
				<li>Finally, enter valid values for <strong class="source-inline">Magazine count</strong> and <strong class="source-inline">Book count</strong> (such as <strong class="source-inline">20</strong> and <strong class="source-inline">20</strong>). Check <strong class="source-inline">Send confirmation</strong>, and enter <strong class="source-inline">UserName@Example.Com</strong> as the email (make sure you match the letter case, including the mixed uppercase and lowercase characters):<div id="_idContainer269" class="IMG---Figure"><img src="image/B15509_07_14.jpg" alt="Figure 7.14: The form after being submitted with valid values&#13;&#10;"/></div><p class="figure-caption">Figure 7.14: The form after being submitted with valid values</p></li>
				<li>Switch to PyCharm and look in the debug console. You'll see that the email has been converted to lowercase when it is printed by our debug code:<div id="_idContainer270" class="IMG---Figure"><img src="image/B15509_07_15.jpg" alt="Figure 7.15: Email in lowercase, as well as other fields&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 7.15: Email in lowercase, as well as other fields</p>
			<p>This is our <strong class="source-inline">clean_email</strong> method in action – even though we entered data in both uppercase and lowercase, it has been converted to all lowercase.</p>
			<p>In this exercise, we created a new <strong class="source-inline">OrderForm</strong> that implemented form and field clean methods. We used a custom validator to ensure that the <strong class="source-inline">Email</strong> field met our specific validation rules – only a specific domain was allowed. We used a custom field cleaning method (<strong class="source-inline">clean_email</strong>) to convert the email address to lowercase. We then implemented a <strong class="source-inline">clean</strong> method to validate the forms that were dependent on each other. In this method, we added both field and non-field errors. In the next section, we will cover how to add placeholders and initial values to the form.</p>
			<h2 id="_idParaDest-221"><a id="_idTextAnchor236"/>Placeholders and Initial Values</h2>
			<p>There are two things our first manually built form had that our current Django form still does not have –placeholders and initial values. Adding placeholders is simple; they are just added as an attribute to the widget constructor for the form field. This is similar to what we have already seen for setting the type of <strong class="source-inline">DateField</strong> in our previous examples.</p>
			<p>Here is an example:</p>
			<p class="source-code">class ExampleForm(forms.Form):</p>
			<p class="source-code">  text_field = forms.CharField\</p>
			<p class="source-code">               (widget=forms.TextInput\</p>
			<p class="source-code">               (attrs={"placeholder": "Text Placeholder"}))</p>
			<p class="source-code">  password_field = forms.CharField(\</p>
			<p class="source-code">    widget=forms.PasswordInput\</p>
			<p class="source-code">           (attrs={"placeholder": "Password Placeholder"}))</p>
			<p class="source-code">  email_field = forms.EmailField\</p>
			<p class="source-code">                (widget=forms.EmailInput\</p>
			<p class="source-code">                 (attrs={"placeholder": "Email Placeholder"}))</p>
			<p class="source-code">  text_area = forms.CharField\</p>
			<p class="source-code">              (widget=forms.Textarea\</p>
			<p class="source-code">              (attrs={"placeholder": "Text Area Placeholder"}))</p>
			<p>This is what the preceding form looks like when rendered in the browser:</p>
			<div>
				<div id="_idContainer271" class="IMG---Figure">
					<img src="image/B15509_07_16.jpg" alt="Figure 7.16: Django form with placeholders&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.16: Django form with placeholders</p>
			<p>Of course, if we are manually setting <strong class="source-inline">Widget</strong> for each field, we need to know which <strong class="source-inline">Widget</strong> class to use. The ones that support placeholders are <strong class="source-inline">TextInput</strong>, <strong class="source-inline">NumberInput</strong>, <strong class="source-inline">EmailInput</strong>, <strong class="source-inline">URLInput</strong>, <strong class="source-inline">PasswordInput</strong>, and <strong class="source-inline">Textarea</strong>.</p>
			<p>While we are examining the <strong class="source-inline">Form</strong> class itself, we will look at the first of two ways of setting an initial value for a field. We can do it by using the <strong class="source-inline">initial</strong> argument on a <strong class="source-inline">Field</strong> constructor, like this:</p>
			<p class="source-code">text_field = forms.CharField(initial="Initial Value", …)</p>
			<p>The other method is to pass in a dictionary of data when instantiating the form in our view. The keys are the field names. The dictionary should have zero or more items (that is, an empty dictionary is valid). Any extra keys are ignored. This dictionary should be supplied as the <strong class="source-inline">initial</strong> argument in our view as follows:</p>
			<p class="source-code">initial = {"text_field": "Text Value", \</p>
			<p class="source-code">           "email_field": "user@example.com"}</p>
			<p class="source-code">form = ExampleForm(initial=initial)</p>
			<p>Or for a <strong class="source-inline">POST</strong> request, pass in <strong class="source-inline">request.POST</strong> as the first argument, as usual:</p>
			<p class="source-code">initial = {"text_field": "Text Value", \</p>
			<p class="source-code">           "email_field": "user@example.com"}</p>
			<p class="source-code">form = ExampleForm(request.POST, initial=initial)</p>
			<p>Values in <strong class="source-inline">request.POST</strong> will override values in <strong class="source-inline">initial</strong>. This means that even if we have an initial value for a required field, if it is left blank when submitted, then it will not validate. The field will not fall back to the value in <strong class="source-inline">initial</strong>.</p>
			<p>Whether you decide to set initial values in the <strong class="source-inline">Form</strong> class itself or the view is up to you and depends on your use case. If you had a form that was used in multiple views but usually had the same value, it would be better to set the <strong class="source-inline">initial</strong> value in the form. Otherwise, it can be more flexible to use <strong class="source-inline">setting</strong> in the view.</p>
			<p>In the next exercise, we will add placeholders and initial values to the <strong class="source-inline">OrderForm</strong> class from the previous exercise.</p>
			<h2 id="_idParaDest-222"><a id="_idTextAnchor237"/>Exercise 7.02: Placeholders and Initial Values</h2>
			<p>In this exercise, you will enhance the <strong class="source-inline">OrderForm</strong> class by adding placeholder text. You will simulate passing an initial email address to the form. It will be a hardcoded address, but once the user can log in, it could be an email address associated with their account – you will learn about sessions and authentication in <em class="italic">Chapter 9</em>,<em class="italic"> Sessions and Authentication</em>:</p>
			<ol>
				<li value="1">In PyCharm, open the <strong class="source-inline">reviews</strong> app's <strong class="source-inline">forms.py</strong> file. You will add placeholders to the <strong class="source-inline">magazine_count</strong>, <strong class="source-inline">book_count</strong>, and <strong class="source-inline">email</strong> fields on the <strong class="source-inline">OrderForm</strong>, which means also setting the <strong class="source-inline">widget</strong>.<p>To the <strong class="source-inline">magazine_count</strong> field, add a <strong class="source-inline">NumberInput</strong> <strong class="source-inline">widget</strong> with <strong class="source-inline">placeholder</strong> in the <strong class="source-inline">attrs</strong> dictionary. The <strong class="source-inline">placeholder</strong> should be set to <em class="italic">Number of Magazines</em>. Write the following code:</p><p class="source-code">magazine_count = forms.IntegerField\</p><p class="source-code">                 (min_value=0, max_value=80,\</p><p class="source-code">                  widget=forms.NumberInput\</p><p class="source-code">                  (attrs={"placeholder": "Number of Magazines"}))</p></li>
				<li>Add a placeholder to the <strong class="source-inline">book_count</strong> field in the same manner. The placeholder text should be <strong class="source-inline">Number of Books</strong>:<p class="source-code">book_count = forms.IntegerField\</p><p class="source-code">             (min_value=0, max_value=50,\</p><p class="source-code">              widget=forms.NumberInput\</p><p class="source-code">              (attrs={"placeholder": "Number of Books"}))</p></li>
				<li>The final change to <strong class="source-inline">OrderForm</strong> is to add a placeholder to the email field. This time the widget is <strong class="source-inline">EmailInput</strong>. The placeholder text should be <strong class="source-inline">Your company email address</strong>:<p class="source-code">email = forms.EmailField\</p><p class="source-code">        (required=False, validators=[validate_email_domain],\</p><p class="source-code">         widget=forms.EmailInput\</p><p class="source-code">         (attrs={"placeholder": "Your company email address"}))</p><p>Note that the <strong class="source-inline">clean_email</strong> and <strong class="source-inline">clean</strong> methods should remain as they were in <em class="italic">Exercise 7.01, Custom Clean and Validation Methods</em>. Save the file.</p></li>
				<li>Open the <strong class="source-inline">reviews</strong> app's <strong class="source-inline">views.py</strong> file. In the <strong class="source-inline">form_example</strong> view function, create a new dictionary variable called <strong class="source-inline">initial</strong> with one key, <strong class="source-inline">email</strong>, like this:<p class="source-code">initial = {"email": "user@example.com"}</p></li>
				<li>In the two places that you are instantiating <strong class="source-inline">OrderForm</strong>, also pass in the <strong class="source-inline">initial</strong> variable using the <strong class="source-inline">initial</strong> kwarg. The first instance is as follows:<p class="source-code">form = OrderForm(request.POST, initial=initial)</p><p>The second instance is as follows:</p><p class="source-code">form = OrderForm(initial=initial)</p><p>The complete code for <strong class="source-inline">views.py</strong> can be found at <a href="http://packt.live/3szaPM6">http://packt.live/3szaPM6</a>.</p><p>Save the <strong class="source-inline">views.py</strong> file.</p></li>
				<li>Start the Django dev server if it is not already running. Browse to <strong class="source-inline">http://127.0.0.1:8000/form-example/</strong> in your browser. You should see that your form now has placeholders and an initial value set:<div id="_idContainer272" class="IMG---Figure"><img src="image/B15509_07_17.jpg" alt="Figure 7.17: Order form with initial values and placeholders&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 7.17: Order form with initial values and placeholders</p>
			<p>In this exercise, we added placeholders to form fields. This was done by setting a <strong class="source-inline">form</strong> widget when defining the <strong class="source-inline">form</strong> field on the form class and setting a <em class="italic">placeholder</em> value in the <strong class="source-inline">attrs</strong> dictionary. We also set an initial value for the form using a dictionary and passing it to the <strong class="source-inline">form</strong> instance using the <strong class="source-inline">initial</strong> kwarg. </p>
			<p>In the next section, we will talk about how to work with Django models using data from forms, and how <strong class="source-inline">ModelForm</strong> makes this easier.</p>
			<h2 id="_idParaDest-223"><a id="_idTextAnchor238"/>Creating or Editing Django Models</h2>
			<p>You have seen how to define a form, and in <em class="italic">Chapter 2</em>, <em class="italic">Models and Migrations</em>, you learned how to create Django model instances. By using these things together, you could build a view that displayed a form and also saved a model instance to the database. This gives you an easy method to save data without having to write a lot of boilerplate code or create custom forms. In Bookr, we will use this method to allow users to add reviews without requiring access to the Django admin site. Without using <strong class="source-inline">ModelForm</strong>, we could do something like this:</p>
			<ul>
				<li>We can create a form based on an existing model, for example, <strong class="source-inline">Publisher</strong>. The form would be called <strong class="source-inline">PublisherForm</strong>.</li>
				<li>We can manually define the fields on <strong class="source-inline">PublisherForm</strong>, using the same rules defined on the <strong class="source-inline">Publisher</strong> model, as shown here:<p class="source-code">class PublisherForm(forms.Form):</p><p class="source-code">  name = forms.CharField(max_length=50)</p><p class="source-code">  website = forms.URLField()</p><p class="source-code">  …</p></li>
				<li>In the view, the <strong class="source-inline">initial</strong> values would be retrieved from the model queried from the database, then passed to the form using the <strong class="source-inline">initial</strong> argument. If we were creating a new instance, the <strong class="source-inline">initial</strong> value would be blank – something like this:<p class="source-code">if create:</p><p class="source-code">  initial = {}</p><p class="source-code">else:</p><p class="source-code">  publisher = Publisher.objects.get(pk=pk)</p><p class="source-code">  initial = {"name": publisher.name, \</p><p class="source-code">             "website": publisher.website, …}</p><p class="source-code">form = PublisherForm(initial=initial)</p></li>
				<li>Then, in the <strong class="source-inline">POST</strong> flow of the view, we can either create or update the model based on <strong class="source-inline">cleaned_data</strong>:<p class="source-code">form = PublisherForm(request.POST, initial=initial)</p><p class="source-code">if create:</p><p class="source-code">  publisher = Publisher()</p><p class="source-code">else:</p><p class="source-code">  publisher = Publisher.objects.get(pk=pk)</p><p class="source-code">publisher.name = form.cleaned_data['name']</p><p class="source-code">publisher.website = forms.cleaned_data['website']</p><p class="source-code">…</p><p class="source-code">publisher.save()</p></li>
			</ul>
			<p>This is a lot of work, and we have to consider how much duplicated logic we have. For example, we are defining the length of the name in the <strong class="source-inline">name</strong> form field. If we made a mistake here, we could allow a longer name in the field than the model allows. We also have to remember to set all the fields in the <strong class="source-inline">initial</strong> dictionary, as well as setting the values on the new or updated model with <strong class="source-inline">cleaned_data</strong> from the form. There are many opportunities to make mistakes here, as well as remembering to add or remove field setting data for each of these steps if the model changes. All this code would have to be duplicated for each Django model you work with as well, expounding the duplication problem.</p>
			<h2 id="_idParaDest-224"><a id="_idTextAnchor239"/>The ModelForm Class</h2>
			<p>Luckily, Django provides a method of building <strong class="source-inline">Model</strong> instances from forms much more simply, with the <strong class="source-inline">ModelForm</strong> class. <strong class="source-inline">ModelForm</strong> is a form that is built automatically from a particular model. It will inherit the validation rules from the model (such as whether fields are required or the maximum length of <strong class="source-inline">CharField</strong> instances, and so on). It provides an extra <strong class="source-inline">__init__</strong> argument (called <strong class="source-inline">instance</strong>) to automatically populate the initial values from an existing model. It also adds a <strong class="source-inline">save</strong> method to automatically persist the form data to the database. All that needs to be done to set up <strong class="source-inline">ModelForm</strong> is to specify its model and what fields should be used: this is done on the <strong class="source-inline">class Meta</strong> attribute of the <strong class="source-inline">form</strong> class. Let us see how to build a form from <strong class="source-inline">Publisher</strong>.</p>
			<p>Inside the file that contains the form (for example, the <strong class="source-inline">forms.py</strong> file we have been working with), the only change is that the model must be imported:</p>
			<p class="source-code">from .models import Publisher</p>
			<p>Then the <strong class="source-inline">Form</strong> class can then be defined. The class requires a <strong class="source-inline">class Meta</strong> attribute, which in turn must define a <strong class="source-inline">model</strong> attribute and either <strong class="source-inline">fields</strong> or <strong class="source-inline">excludes</strong> attributes:</p>
			<p class="source-code">class PublisherForm(forms.ModelForm):</p>
			<p class="source-code">  class Meta:</p>
			<p class="source-code">    model = Publisher</p>
			<p class="source-code">    fields = ("name", "website", "email")</p>
			<p><strong class="source-inline">fields</strong> is a list or tuple of the fields to include in the form. When manually setting the list of fields, if you add extra fields to the model, you must also add their name here to have them displayed on the form. </p>
			<p>You can also use the special value <strong class="source-inline">__all__</strong> instead of a list or tuple to automatically include all the fields, like this:</p>
			<p class="source-code">class PublisherForm(forms.ModelForm):</p>
			<p class="source-code">  class Meta:</p>
			<p class="source-code">    model = Publisher</p>
			<p class="source-code">    fields = "__all__"</p>
			<p>If the <strong class="source-inline">model</strong> field has its <strong class="source-inline">editable</strong> attribute set to <strong class="source-inline">False</strong>, then it will not be automatically included.</p>
			<p>On the contrary, the <strong class="source-inline">exclude</strong> attribute sets the fields to not display in the form. Any fields added to the model will automatically be added to the form. We could define the preceding form using <strong class="source-inline">exclude</strong> with any empty tuple since we want all the fields. The code is like this:</p>
			<p class="source-code">class PublisherForm(forms.ModelForm):</p>
			<p class="source-code">  class Meta:</p>
			<p class="source-code">    model = Publisher</p>
			<p class="source-code">    exclude = ()</p>
			<p>This saves some work because you don't need to add a field to both the model and in the <strong class="source-inline">fields</strong> list, however, it is not as safe, as you might automatically expose fields to the end user that you don't want to. For example, if you had a <strong class="source-inline">User</strong> model with <strong class="source-inline">UserForm</strong>, you might add an <strong class="source-inline">is_admin</strong> field to the <strong class="source-inline">User</strong> model to give admin users extra privileges. If this field did not have the <strong class="source-inline">exclude</strong> attribute, it would be displayed to the user. A user would then be able to make themselves an administrator, which is something you probably wouldn't want.</p>
			<p>Whichever of these three approaches to choosing the forms to display that we decide to use, in our case, they will display the same in the browser. This is because we are choosing to display <em class="italic">all</em> the fields. They all look like this when rendered in the browser:</p>
			<div>
				<div id="_idContainer273" class="IMG---Figure">
					<img src="image/B15509_07_18.jpg" alt="Figure 7.18: PublisherForm&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.18: PublisherForm</p>
			<p>Note that <strong class="source-inline">help_text</strong> from the <strong class="source-inline">Publisher</strong> model is automatically rendered as well.</p>
			<p>Usage in a view is similar to the other forms we have seen. Also, as mentioned, there is an extra argument that can be provided, called <strong class="source-inline">instance</strong>. This can be set to <strong class="source-inline">None</strong>, which will render an empty form.</p>
			<p>Assuming, in your view function, you have some method of determining whether you are creating or editing a model instance (we will discuss how to do this later), this will determine a variable called <strong class="source-inline">is_create</strong> (<strong class="source-inline">True</strong> if creating an instance, or <strong class="source-inline">False</strong> if editing an existing one). Your view function to create the form could then be written like this:</p>
			<p class="source-code">if is_create:</p>
			<p class="source-code">  instance = None</p>
			<p class="source-code">else:</p>
			<p class="source-code">  instance = get_object_or_404(Publisher, pk=pk)</p>
			<p class="source-code">if request.method == "POST":</p>
			<p class="source-code">  form = PublisherForm(request.POST, instance=instance)</p>
			<p class="source-code">  if form.is_valid():</p>
			<p class="source-code">    # we'll cover this branch soon</p>
			<p class="source-code">else:</p>
			<p class="source-code">  form = PublisherForm(instance=instance)</p>
			<p>As you can see, in either branch, the instance is passed to the <strong class="source-inline">PublisherForm</strong> constructor, although it is <strong class="source-inline">None</strong> if we are in create mode.</p>
			<p>If the form is valid, we can then save the <strong class="source-inline">model</strong> instance. This is done simply by calling the <strong class="source-inline">save</strong> method on the form. This will automatically create the instance, or simply save changes to the old one:</p>
			<p class="source-code">if form.is_valid():</p>
			<p class="source-code">  form.save()</p>
			<p class="source-code">  return redirect(success_url)</p>
			<p>The <strong class="source-inline">save</strong> method returns the <strong class="source-inline">model</strong> instance that was saved. It takes one optional argument, <strong class="source-inline">commit</strong>, which determines whether the changes should be written to the database. You can pass <strong class="source-inline">False</strong> instead, which allows you to make additional changes to the instance before manually saving the changes. This would be required to set attributes that have not been included in the form. As we mentioned, maybe you would set the <strong class="source-inline">is_admin</strong> flag to <strong class="source-inline">False</strong> on a <strong class="source-inline">User</strong> instance:</p>
			<p class="source-code">if form.is_valid():</p>
			<p class="source-code">  new_user = form.save(False)</p>
			<p class="source-code">  new_user.is_admin = False</p>
			<p class="source-code">  new_user.save()</p>
			<p class="source-code">  return redirect(success_url)</p>
			<p>In <em class="italic">Activity 7.02</em>, <em class="italic">Review Creation UI</em>, at the end of this chapter, we will be using this feature as well.</p>
			<p>If your model uses <strong class="source-inline">ManyToMany</strong> fields, and you also call <strong class="source-inline">form.save(False)</strong>, you should also call <strong class="source-inline">form.save_m2m()</strong> to save any many-to-many relationships that have been set. It is not necessary to call this method if you call the form <strong class="source-inline">save</strong> method with <strong class="source-inline">commit</strong> set to <strong class="source-inline">True</strong> (that is, the default).</p>
			<p>Model forms can be customized by making changes to their <strong class="source-inline">Meta</strong> attributes. The <strong class="source-inline">widgets</strong> attribute can be set. It can contain a dictionary keyed on the field names, with widget classes or instances as the values. For example, this is how to set up <strong class="source-inline">PublisherForm</strong> to have placeholders:</p>
			<p class="source-code">class PublisherForm(forms.ModelForm):</p>
			<p class="source-code">  class Meta:</p>
			<p class="source-code">    model = Publisher</p>
			<p class="source-code">    fields = "__all__"</p>
			<p class="source-code">    widgets = {"name": forms.TextInput\</p>
			<p class="source-code">               (attrs={"placeholder": "The publisher's name."})}</p>
			<p>The values behave the same as setting the <strong class="source-inline">kwarg</strong> widget in the field definition; they can be a class or an instance. For example, to display <strong class="source-inline">CharField</strong> as a password input, the <strong class="source-inline">PasswordInput</strong> class can be used; it does not need to be instantiated:</p>
			<p class="source-code">widgets = {"password": forms.PasswordInput}</p>
			<p>Model forms can also be augmented with extra fields added in the same way as they are added to a normal form. For example, suppose we wanted to give the option of sending a notification email after saving a <strong class="source-inline">Publisher</strong> object. We can add an <strong class="source-inline">email_on_save</strong> field to <strong class="source-inline">PublisherForm</strong> like this:</p>
			<p class="source-code">class PublisherForm(forms.ModelForm):</p>
			<p class="source-code">  email_on_save = forms.BooleanField\</p>
			<p class="source-code">                  (required=False, \</p>
			<p class="source-code">                   help_text="Send notification email on save")</p>
			<p class="source-code">  class Meta:</p>
			<p class="source-code">    model = Publisher</p>
			<p class="source-code">    fields = "__all__"</p>
			<p>When rendered, the form looks like this:</p>
			<div>
				<div id="_idContainer274" class="IMG---Figure">
					<img src="image/B15509_07_19.jpg" alt="Figure 7.19: PublisherForm with an additional field&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.19: PublisherForm with an additional field</p>
			<p>Additional fields are placed after the <strong class="source-inline">Model</strong> fields. The extra fields are not handled automatically – they do not exist on the model, so Django won't attempt to save them on the <strong class="source-inline">model</strong> instance. Instead, you should handle the saving of their values by examining the <strong class="source-inline">cleaned_data</strong> values of the form, as you would with a standard form, for example (inside your view function):</p>
			<p class="source-code">if form.is_valid():</p>
			<p class="source-code">  if form.cleaned_data.get("email_on_save"):</p>
			<p class="source-code">    send_email()</p>
			<p class="source-code">      # assume this function is defined elsewhere</p>
			<p class="source-code">  # save the instance regardless of sending the email or not</p>
			<p class="source-code">  form.save()  </p>
			<p class="source-code">  return redirect(success_url)</p>
			<p>In the next exercise, you will write a new view function to create or edit a <strong class="source-inline">Publisher</strong>.</p>
			<h2 id="_idParaDest-225"><a id="_idTextAnchor240"/>Exercise 7.03: Creating and Editing a Publisher</h2>
			<p>In this exercise, we will return to Bookr. We want to add the ability to create and edit a <strong class="source-inline">Publisher</strong> without using the Django admin. To do this, we will add a <strong class="source-inline">ModelForm</strong> for the <strong class="source-inline">Publisher</strong> model. It will be used in a new view function. The view function will take an optional argument, <strong class="source-inline">pk</strong>, which will either be the ID of the <strong class="source-inline">Publisher</strong> being edited or <strong class="source-inline">None</strong> to create a new <strong class="source-inline">Publisher</strong>. We will add two new URL maps to facilitate this. When this is complete, we will be able to see and update any publisher using their ID. For example, information for <strong class="source-inline">Publisher 1</strong> will be viewable/editable at URL path <strong class="source-inline">/publishers/1</strong>:</p>
			<ol>
				<li value="1">In PyCharm, open the <strong class="source-inline">reviews</strong> app's <strong class="source-inline">forms.py</strong> file. After the <strong class="source-inline">forms</strong> import, also import the <strong class="source-inline">Publisher</strong> model:<p class="source-code">from .models import Publisher</p></li>
				<li>Create a <strong class="source-inline">PublisherForm</strong> class, inheriting from <strong class="source-inline">forms.ModelForm</strong>:<p class="source-code">class PublisherForm(forms.ModelForm):</p></li>
				<li>Define the <strong class="source-inline">class Meta</strong> attribute on <strong class="source-inline">PublisherForm</strong>. The attributes that <strong class="source-inline">Meta</strong> requires are the model (<strong class="source-inline">Publisher</strong>) and fields (<strong class="source-inline">"__all__"</strong>):<p class="source-code">class PublisherForm(forms.ModelForm):</p><p class="source-code">  class Meta:</p><p class="source-code">    model = Publisher</p><p class="source-code">    fields = "__all__"</p><p>Save <strong class="source-inline">forms.py</strong>.</p><p class="callout-heading">Note</p><p class="callout">The complete file can be found at <a href="http://packt.live/3qh9bww">http://packt.live/3qh9bww</a>.</p></li>
				<li>Open the <strong class="source-inline">reviews</strong> app's <strong class="source-inline">views.py</strong> file. At the top of the file, import <strong class="source-inline">PublisherForm</strong>:<p class="source-code">from .forms import PublisherForm, SearchForm</p></li>
				<li>Make sure you import the <strong class="source-inline">get_object_or_404</strong> and <strong class="source-inline">redirect</strong> functions from <strong class="source-inline">django.shortcuts</strong>, if you aren't already:<p class="source-code">from django.shortcuts import render, get_object_or_404, redirect</p></li>
				<li>Also make sure you're importing the <strong class="source-inline">Publisher</strong> model if you aren't already. You may already be importing this and other models:<p class="source-code">from .models import Book, Contributor, Publisher</p></li>
				<li>The final import you will need is the <strong class="source-inline">messages</strong> module. This will allow us to register a message letting the user know that a <strong class="source-inline">Publisher</strong> object was edited or created:<p class="source-code">from django.contrib import messages</p><p>Once again, add this import if you do not already have it.</p></li>
				<li>Create a new view function called <strong class="source-inline">publisher_edit</strong>. It takes two arguments, <strong class="source-inline">request</strong> and <strong class="source-inline">pk</strong> (the ID of the <strong class="source-inline">Publisher</strong> object to edit). This is optional, and if it is <strong class="source-inline">None</strong>, then a <strong class="source-inline">Publisher</strong> object will be created instead:<p class="source-code">def publisher_edit(request, pk=None):</p></li>
				<li>Inside the view function, we need to try to load the existing <strong class="source-inline">Publisher</strong> instance if <strong class="source-inline">pk</strong> is not <strong class="source-inline">None</strong>. Otherwise, the value of <strong class="source-inline">publisher</strong> should be <strong class="source-inline">None</strong>:<p class="source-code">def publisher_edit(request, pk=None):</p><p class="source-code">  if pk is not None:</p><p class="source-code">    publisher = get_object_or_404(Publisher, pk=pk)</p><p class="source-code">  else:</p><p class="source-code">    publisher = None</p></li>
				<li>After getting a <strong class="source-inline">Publisher</strong> instance or <strong class="source-inline">None</strong>, complete the branch for a <strong class="source-inline">POST</strong> request. Instantiate the form in the same way as seen earlier in the chapter, but now make sure that it takes <strong class="source-inline">instance</strong> as a kwarg. Then, if the form is valid, save it using the <strong class="source-inline">form.save()</strong> method. The method will return the updated <strong class="source-inline">Publisher</strong> instance, which is stored in the <strong class="source-inline">updated_publisher</strong> variable. Then, register a different success message depending on whether the <strong class="source-inline">Publisher</strong> instance was created or updated. Finally, redirect back to this <strong class="source-inline">publisher_edit</strong> view, since <strong class="source-inline">updated_publisher</strong> will always have an ID at this point:<p class="source-code">def publisher_edit(request, pk=None):</p><p class="source-code">  …</p><p class="source-code">  if request.method == "POST":</p><p class="source-code">    form = PublisherForm(request.POST, instance=publisher)</p><p class="source-code">    if form.is_valid():</p><p class="source-code">    updated_publisher = form.save()</p><p class="source-code">      if publisher is None:</p><p class="source-code">        messages.success\</p><p class="source-code">        (request, "Publisher \"{}\" was created."\</p><p class="source-code">                  .format(updated_publisher))</p><p class="source-code">      else:</p><p class="source-code">        messages.success\</p><p class="source-code">        (request, "Publisher \"{}\" was updated."\</p><p class="source-code">                  .format(updated_publisher))\</p><p class="source-code">      return redirect("publisher_edit", updated_publisher.pk)</p><p>If the form is not valid, the execution falls through to just return the <strong class="source-inline">render</strong> function call with the invalid form (this will be implemented in <em class="italic">step 12</em>). The redirect uses a named URL map, which will be added later in the exercise.</p></li>
				<li>Next, fill in the non-<strong class="source-inline">POST</strong> branch of the code. In this case, just instantiate the form with the <strong class="source-inline">instance</strong>:<p class="source-code">def publisher_edit(request, pk=None):</p><p class="source-code">  …</p><p class="source-code">  if request.method == "POST":</p><p class="source-code">    …</p><p class="source-code">  else:</p><p class="source-code">    form = PublisherForm(instance=publisher)</p></li>
				<li>Finally, you can reuse the <strong class="source-inline">form-example.html</strong> file that you've used in previous exercises. Render it with the <strong class="source-inline">render</strong> function, passing in the HTTP method and <strong class="source-inline">form</strong> as the context:<p class="source-code">def publisher_edit(request, pk=None):</p><p class="source-code">  …</p><p class="source-code">  return render(request, "form-example.html", \</p><p class="source-code">                {"method": request.method, "form": form}) </p><p>Save this file. You can refer to it at <a href="http://packt.live/3nI62En">http://packt.live/3nI62En</a>.</p></li>
				<li>Open <strong class="source-inline">urls.py</strong> in the <strong class="source-inline">reviews</strong> directory. Add two new URL maps; they will both go to the <strong class="source-inline">publisher_edit</strong> view. One will capture the ID of <strong class="source-inline">Publisher</strong> we want to edit and pass it into the view as the <strong class="source-inline">pk</strong> argument. The other will use the word <strong class="source-inline">new</strong> instead, and will not pass the <strong class="source-inline">pk</strong>, which will indicate we want to create a new <strong class="source-inline">Publisher</strong>.<p>To your <strong class="source-inline">urlpatterns</strong> variable, add the path <strong class="source-inline">'publishers/&lt;int:pk&gt;/'</strong> mapping to the view <strong class="source-inline">reviews.views.publisher_edit</strong>, with the name of <strong class="source-inline">'publisher_edit'</strong>.</p><p>Also, add the path <strong class="source-inline">'publishers/new/'</strong> mapping to the <strong class="source-inline">reviews.views.publisher_edit</strong> view, with the name of <strong class="source-inline">'publisher_create'</strong>:</p><p class="source-code">urlpatterns = [</p><p class="source-code">  …</p><p class="source-code">  path('publishers/&lt;int:pk&gt;/',views.publisher_edit, \</p><p class="source-code">        name='publisher_edit'),\</p><p class="source-code">  path('publishers/new/',views.publisher_edit, \</p><p class="source-code">        name='publisher_create')]</p><p>Since the second mapping does not capture anything, the <strong class="source-inline">pk</strong> that is passed to the <strong class="source-inline">publisher_detail</strong> view function is <strong class="source-inline">None</strong>.</p><p>Save the <strong class="source-inline">urls.py</strong> file. The completed version for reference is at <a href="http://packt.live/39CpUnw">http://packt.live/39CpUnw</a>.</p></li>
				<li>Create a <strong class="source-inline">form-example.html</strong> file inside the <strong class="source-inline">reviews</strong> app's <strong class="source-inline">templates</strong> directory. Since this is a standalone template (it does not extend any other templates), we need to render the messages inside it. Add this code just after the opening <strong class="source-inline">&lt;body&gt;</strong> tag to iterate through all the messages and display them:<p class="source-code">{% for message in messages %}</p><p class="source-code">&lt;p&gt;&lt;em&gt;{{ message.level_tag|title }}:&lt;/em&gt; {{ message }}&lt;/p&gt;</p><p class="source-code">{% endfor %}</p><p>This will loop over the messages we have added and display the tag (in our case, <strong class="source-inline">Success</strong>) and then the message.</p></li>
				<li>Then, add the normal form rendering and submission code:<p class="source-code">&lt;form method="post"&gt;</p><p class="source-code">  {% csrf_token %}</p><p class="source-code">  {{ form.as_p }}</p><p class="source-code">  &lt;p&gt;</p><p class="source-code">    &lt;input type="submit" value="Submit"&gt;</p><p class="source-code">  &lt;/p&gt;</p><p class="source-code">&lt;/form&gt;</p><p>Save and close this file.</p><p>You can refer to the full version of this file at <a href="http://packt.live/38I8XZx">http://packt.live/38I8XZx</a>.</p></li>
				<li>Start the Django dev server, then navigate to <strong class="source-inline">http://127.0.0.1:8000/publishers/new/</strong>. You should see a blank <strong class="source-inline">PublisherForm</strong> being displayed:<p> </p><div id="_idContainer275" class="IMG---Figure"><img src="image/B15509_07_20.jpg" alt="Figure 7.20: Blank publisher form&#13;&#10;"/></div><p class="figure-caption">Figure 7.20: Blank publisher form</p></li>
				<li>The form has inherited the model's validation rules, so you cannot submit the form with too many characters for <strong class="source-inline">Name</strong>, or with an invalid <strong class="source-inline">Website</strong> or <strong class="source-inline">Email</strong>. Put in some valid information, then submit the form. After submission, you should see the success message and the form will be populated with information that was saved to the database:<div id="_idContainer276" class="IMG---Figure"><img src="image/B15509_07_21.jpg" alt="Figure 7.21: Form after submission&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 7.21: Form after submission</p>
			<p>Notice that the URL has also been updated and now includes the ID of the publisher that was created. In this case, it is <strong class="source-inline">http://127.0.0.1:8000/publishers/19/</strong> but the ID on your setup will depend on how many <strong class="source-inline">Publisher</strong> instances were already in your database. </p>
			<p>Notice that if you refresh the page, you will not receive a message confirming whether you want to re-send the form data. This is because we redirected after saving, so it is safe to refresh this page as many times as you want, and no new <strong class="source-inline">Publisher</strong> instances will be created. If you had not redirected it, then every time the page was refreshed, a new <strong class="source-inline">Publisher</strong> instance would be created.</p>
			<p>If you have other <strong class="source-inline">Publisher</strong> instances in your database, you can change the ID in the URL to edit other ones. Since the ID in this instance is <strong class="source-inline">3</strong>, we can assume that <strong class="source-inline">Publisher</strong> <strong class="source-inline">1</strong> and <strong class="source-inline">Publisher</strong> <strong class="source-inline">2</strong> already exist and can substitute in their IDs to see the existing data. Here is the view of the existing <strong class="source-inline">Publisher 1</strong> (at <strong class="source-inline">http://127.0.0.1:8000/publishers/1/</strong>) – your information may be different:</p>
			<div>
				<div id="_idContainer277" class="IMG---Figure">
					<img src="image/B15509_07_22.jpg" alt="Figure 7.22: Existing Publisher 1 information&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.22: Existing Publisher 1 information</p>
			<p>Try making changes to the existing <strong class="source-inline">Publisher</strong> instance. Notice that after you save, the message is different – it is telling the user that the <strong class="source-inline">Publisher</strong> instance was <em class="italic">updated</em> rather than <em class="italic">created</em>:</p>
			<p> </p>
			<div>
				<div id="_idContainer278" class="IMG---Figure">
					<img src="image/B15509_07_23.jpg" alt="Figure 7.23: Publisher after updating instead of creating&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.23: Publisher after updating instead of creating</p>
			<p>In this exercise, we implemented a <strong class="source-inline">ModelForm</strong> from a model (<strong class="source-inline">PublisherForm</strong> was created from <strong class="source-inline">Publisher</strong>) and saw how Django automatically generated the form fields with the correct validation rules. We then used the form's built-in <strong class="source-inline">save</strong> method to save changes to the <strong class="source-inline">Publisher</strong> instance (or automatically create it) inside the <strong class="source-inline">publisher_edit</strong> view. We mapped two URLs to the view. The first URL, which was for editing an existing <strong class="source-inline">Publisher</strong>, passed <strong class="source-inline">pk</strong> to the view. The other did not pass <strong class="source-inline">pk</strong> to the view, indicating that the <strong class="source-inline">Publisher</strong> instance should be created. Finally, we used the browser to experiment with creating a new <strong class="source-inline">Publisher</strong> instance and then editing an existing one.</p>
			<h2 id="_idParaDest-226"><a id="_idTextAnchor241"/>Activity 7.01: Styling and Integrating the Publisher Form</h2>
			<p>In <em class="italic">Exercise 7.03</em>, <em class="italic">Creating and Editing a Publisher</em>, you added <strong class="source-inline">PublisherForm</strong> to create and edit <strong class="source-inline">Publisher</strong> instances. You built this with a standalone template that did not extend any other templates, so it lacked the global styles. In this activity, you will build a generic form detail page that will display a Django form, similar to <strong class="source-inline">form-example.html</strong> but extending from a base template. The template will accept a variable to display the type of model being edited. You will also update the main <strong class="source-inline">base.html</strong> template to render the Django messages, using Bootstrap styling.</p>
			<p>These steps will help you complete this activity:</p>
			<ol>
				<li value="1">Start by editing the <strong class="source-inline">base.html</strong> project. Wrap the <strong class="source-inline">content</strong> block in a container <strong class="source-inline">div</strong> for a nicer layout with some spacing. Surround the existing <strong class="source-inline">content</strong> block with a <strong class="source-inline">&lt;div&gt;</strong> element with <strong class="source-inline">class="container-fluid"</strong>.</li>
				<li>Render each <strong class="source-inline">message</strong> in <strong class="source-inline">messages</strong> (similar to <em class="italic">step 14</em> of <em class="italic">Exercise 7.03</em>, <em class="italic">Creating and Editing a Publisher</em>). Add the <strong class="source-inline">{% for %}</strong> block after the <strong class="source-inline">&lt;div&gt;</strong> you just created but before the <strong class="source-inline">content</strong> block. You should use the Bootstrap framework classes – this snippet will help you:<p class="source-code">&lt;div class="alert alert-{% if message.level_tag   == 'error' %}danger{% else %}{    {message.level_tag }}{% endif %}"</p><p class="source-code">    role="alert"&gt;</p><p class="source-code">  {{ message }}</p><p class="source-code">&lt;/div&gt;</p><p>The Bootstrap class and Django <strong class="source-inline">message</strong> tags have corresponding names for the most part (for example, <strong class="source-inline">success</strong> and <strong class="source-inline">alert-success</strong>). The exception is Django's <strong class="source-inline">error</strong> tag. The corresponding Bootstrap class is <strong class="source-inline">alert-danger</strong>. See more information about Bootstrap alerts at <a href="https://getbootstrap.com/docs/4.0/components/alerts/">https://getbootstrap.com/docs/4.0/components/alerts/</a>. This is why you need to use the <strong class="source-inline">if</strong> template tag in this snippet.</p></li>
				<li>Create a new template called <strong class="source-inline">instance-form.html</strong>, inside the <strong class="source-inline">reviews</strong> app's namespaced <strong class="source-inline">templates</strong> directory.</li>
				<li><strong class="source-inline">instance-form.html</strong> should extend from the <strong class="source-inline">reviews</strong> app's <strong class="source-inline">base.html</strong>.</li>
				<li>The context being passed to this template will contain a variable called <strong class="source-inline">instance</strong>. This will be the <strong class="source-inline">Publisher</strong> instance being edited, or <strong class="source-inline">None</strong> if we are creating a new <strong class="source-inline">Publisher</strong> instance. The context will also contain a <strong class="source-inline">model_type</strong> variable, which is a string indicating the model type (in this case, <strong class="source-inline">Publisher</strong>). Use these two variables to populate the <strong class="source-inline">title</strong> block template tag:<p>If the instance is <strong class="source-inline">None</strong>, the title should be <strong class="source-inline">New Publisher</strong>.</p><p>Otherwise, the title should be <strong class="source-inline">Editing Publisher &lt;Publisher Name&gt;</strong>.</p></li>
				<li><strong class="source-inline">instance-form.html</strong> should contain a <strong class="source-inline">content</strong> <strong class="source-inline">block</strong> template tag to override the <strong class="source-inline">base.html</strong> <strong class="source-inline">content</strong> block.</li>
				<li>Add an <strong class="source-inline">&lt;h2&gt;</strong> element inside the <strong class="source-inline">content</strong> block and populate it using the same logic as the title. For better styling, wrap the publisher name in an <strong class="source-inline">&lt;em&gt;</strong> element.</li>
				<li>Add a <strong class="source-inline">&lt;form&gt;</strong> element to the template with a <strong class="source-inline">method</strong> of <strong class="source-inline">post</strong>. Since we are posting back to the same URL, an <strong class="source-inline">action</strong> does not need to be specified.</li>
				<li>Include the CSRF token template tag in the <strong class="source-inline">&lt;form&gt;</strong> body.</li>
				<li>Render the Django form (its context variable will be <strong class="source-inline">form</strong>) inside <strong class="source-inline">&lt;form&gt;</strong>, using the <strong class="source-inline">as_p</strong> method.</li>
				<li>Add a <strong class="source-inline">submit</strong> <strong class="source-inline">&lt;button&gt;</strong> to the form. Its text should depend on whether you are editing or creating. Use the text <strong class="source-inline">Save</strong> for editing or <strong class="source-inline">Create</strong> for creating. You can use the Bootstrap classes for the button styling here. It should have the attribute <strong class="source-inline">class="btn btn-primary"</strong>.</li>
				<li>In <strong class="source-inline">reviews/views.py</strong>, the <strong class="source-inline">publisher_edit</strong> view does not need many changes. Update the <strong class="source-inline">render</strong> call to render <strong class="source-inline">instance-form.html</strong> instead of <strong class="source-inline">form-example.html</strong>.</li>
				<li>Update the context dictionary being passed to the <strong class="source-inline">render</strong> call. It should include the <strong class="source-inline">Publisher</strong> instance (the <strong class="source-inline">publisher</strong> variable that was already defined) and <strong class="source-inline">model_type</strong> string. The context dictionary already includes <strong class="source-inline">form</strong> (a <strong class="source-inline">PublisherForm</strong> instance). You can remove the <strong class="source-inline">method</strong> key.</li>
				<li>Since we're finished with the <strong class="source-inline">form-example.html</strong> template, it can be deleted.<p>When you've finished, the <strong class="source-inline">Publisher</strong> creation page (at <strong class="source-inline">http://127.0.0.1:8000/publishers/new/</strong>) should look like <em class="italic">Figure 7.24</em>:</p><div id="_idContainer279" class="IMG---Figure"><img src="image/B15509_07_24.jpg" alt="Figure 7.24: The Publisher creation page&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 7.24: The Publisher creation page</p>
			<p>When editing a <strong class="source-inline">Publisher</strong> (for example, at the URL <strong class="source-inline">http://127.0.0.1:8000/publishers/1/</strong>), your page should look like <em class="italic">Figure 7.25</em>:</p>
			<div>
				<div id="_idContainer280" class="IMG---Figure">
					<img src="image/B15509_07_25.jpg" alt="Figure 7.25: The Editing Publisher page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.25: The Editing Publisher page</p>
			<p>After saving a <strong class="source-inline">Publisher</strong> instance, whether creating or editing, you should see the success message at the top of the page (<em class="italic">Figure 7.26</em>):</p>
			<div>
				<div id="_idContainer281" class="IMG---Figure">
					<img src="image/B15509_07_26.jpg" alt="Figure 7.26: Success message rendered as a Bootstrap alert&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.26: Success message rendered as a Bootstrap alert</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The solution to this activity can be found at <a href="http://packt.live/2Nh1NTJ">http://packt.live/2Nh1NTJ</a>.</p>
			<h2 id="_idParaDest-227">Activity 7.02: Review Crea<a id="_idTextAnchor242"/>tion UI</h2>
			<p><em class="italic">Activity 7.01</em>, <em class="italic">Styling and Integrating the Publisher Form</em>, was quite extensive; however, by completing it, you have created a foundation that makes it easier to add other <em class="italic">edit</em> and <em class="italic">create</em> views. You will experience this first-hand in this activity when you will build forms for creating and editing reviews. Because the <strong class="source-inline">instance-form.html</strong> template was made generically, you can reuse it in other views.</p>
			<p>In this activity, you will create a review <strong class="source-inline">ModelForm</strong>, then add a <strong class="source-inline">review_edit</strong> view to create or edit a <strong class="source-inline">Review</strong> instance. You can reuse <strong class="source-inline">instance-form.html</strong> from <em class="italic">Activity 7.01</em>, <em class="italic">Styling and Integrating the Publisher Form</em>, and pass in different context variables to make it work with the <strong class="source-inline">Review</strong> model. When working with reviews, you will operate within the context of a book, that is, the <strong class="source-inline">review_edit</strong> view must accept a book's <strong class="source-inline">pk</strong> as an argument. You will fetch the <strong class="source-inline">Book</strong> instance separately and assign it to the <strong class="source-inline">Review</strong> instance that you create.</p>
			<p>These steps will help you complete this activity:</p>
			<ol>
				<li value="1">In <strong class="source-inline">forms.py</strong>, add a <strong class="source-inline">ReviewForm</strong> subclass of <strong class="source-inline">ModelForm</strong>; its model should be <strong class="source-inline">Review</strong> (make sure you <strong class="source-inline">import</strong> the <strong class="source-inline">Review</strong> model).<p><strong class="source-inline">ReviewForm</strong> should exclude the <strong class="source-inline">date_edited</strong> and <strong class="source-inline">book</strong> fields since the user should not be setting these in the form. The database allows any rating, but we can override the <strong class="source-inline">rating</strong> field with an <strong class="source-inline">IntegerField</strong> that requires a minimum value of <em class="italic">0</em> and a maximum value of <em class="italic">5</em>.</p></li>
				<li>Create a new view called <strong class="source-inline">review_edit</strong>. It should accept two arguments after <strong class="source-inline">request</strong>: <strong class="source-inline">book_pk</strong>, which is required, and <strong class="source-inline">review_pk</strong>, which is optional (defaults to <strong class="source-inline">None</strong>). Fetch the <strong class="source-inline">Book</strong> instance and <strong class="source-inline">Review</strong> instance using the <strong class="source-inline">get_object_or_404</strong> shortcut (call it once for each type). When fetching the review, make sure the review belongs to the book. If <strong class="source-inline">review_pk</strong> is <strong class="source-inline">None</strong>, then the <strong class="source-inline">Review</strong> instance should be <strong class="source-inline">None</strong> too.</li>
				<li>If the <strong class="source-inline">request</strong> method is <strong class="source-inline">POST</strong>, then instantiate a <strong class="source-inline">ReviewForm</strong> using <strong class="source-inline">request.POST</strong> and the review instance. Make sure you <strong class="source-inline">import</strong> the <strong class="source-inline">ReviewForm</strong>.<p>If the form is valid, save the form but set the <strong class="source-inline">commit</strong> argument to <strong class="source-inline">save</strong> to <strong class="source-inline">False</strong>. Then, set the <strong class="source-inline">book</strong> attribute on the returned <strong class="source-inline">Review</strong> instance to the book fetched in <em class="italic">step 2</em>. </p></li>
				<li>If the <strong class="source-inline">Review</strong> instance was being updated instead of created, then you should also set the <strong class="source-inline">date_edited</strong> attribute to the current date and time. Use the <strong class="source-inline">from</strong> <strong class="source-inline">django.utils.timezone.now()</strong> function. Then, save the <strong class="source-inline">Review</strong> instance.</li>
				<li>Finish the valid form branch by registering a success message and redirecting back to the<strong class="source-inline"> book_detail</strong> view. Since the <strong class="source-inline">Review</strong> model doesn't really contain a meaningful text description, use the book title in the message. For example, <strong class="source-inline">Review for "&lt;book title&gt;" created</strong>.</li>
				<li>If the <strong class="source-inline">request</strong> method is not <strong class="source-inline">POST</strong>, instantiate a <strong class="source-inline">ReviewForm</strong> and just pass in the <strong class="source-inline">Review</strong> instance. </li>
				<li>Render the <strong class="source-inline">instance-form.html</strong> template. In the context dictionary, include the same items as were used in <strong class="source-inline">publisher_view</strong>: <strong class="source-inline">form</strong>, <strong class="source-inline">instance</strong>, and <strong class="source-inline">model_type</strong> (<strong class="source-inline">Review</strong>). Include two extra items, <strong class="source-inline">related_model_type</strong>, which should be <strong class="source-inline">Book</strong>, and <strong class="source-inline">related_instance</strong>, which will be the <strong class="source-inline">Book</strong> instance.</li>
				<li>Edit <strong class="source-inline">instance-form.html</strong> to add a place to display the related instance information added in <em class="italic">step 6</em>. Under the <strong class="source-inline">&lt;h2&gt;</strong> element, add a <strong class="source-inline">&lt;p&gt;</strong> element that is only displayed if both <strong class="source-inline">related_model_type</strong> and <strong class="source-inline">related_instance</strong> are set. It should show the text <strong class="source-inline">For &lt;related_model_type&gt; &lt;related_instance&gt;</strong>. For example: <strong class="source-inline">For Book Advanced Deep Learning with Keras</strong>. Put the <strong class="source-inline">related_instance</strong> output in an <strong class="source-inline">&lt;em&gt;</strong> element for better readability.</li>
				<li>In the <strong class="source-inline">reviews</strong> app's <strong class="source-inline">urls.py</strong> file, add URL maps to the <strong class="source-inline">review_edit</strong> view. The URLs <strong class="source-inline">/books/</strong> and <strong class="source-inline">/books/&lt;pk&gt;/</strong> are already configured. Add the URLs <strong class="source-inline">/books/&lt;book_pk&gt;/reviews/new/</strong> to create a review, and <strong class="source-inline">/books/&lt;book_pk&gt;/reviews/&lt;review_pk&gt;/</strong> to edit a review. Make sure you give these names such as <strong class="source-inline">review_create</strong> and <strong class="source-inline">review_edit</strong>.</li>
				<li>Inside the <strong class="source-inline">book_detail.html</strong> template, add links that a user can click to create or edit a review. Add a link inside the <strong class="source-inline">content</strong> block, just before the <strong class="source-inline">endblock</strong> closing template tag. It should use the <strong class="source-inline">url</strong> template tag to link to the <strong class="source-inline">review_edit</strong> view when in creation mode. Also, use the attribute <strong class="source-inline">class="btn btn-primary"</strong> to make the link display like a Bootstrap button. The link text should be <strong class="source-inline">Add Review</strong>.</li>
				<li>Finally, add a link to edit a review, inside the <strong class="source-inline">for</strong> loop that iterates over <strong class="source-inline">Reviews</strong> for <strong class="source-inline">Book</strong>. After all the instances of <strong class="source-inline">text-info</strong> <strong class="source-inline">&lt;span&gt;</strong>, add a link to the <strong class="source-inline">review_edit</strong> view using the <strong class="source-inline">url</strong> template tag. You will need to provide <strong class="source-inline">book.pk</strong> and <strong class="source-inline">review.pk</strong> as arguments. The text of the link should be <strong class="source-inline">Edit Review</strong>. When you are finished, the <strong class="source-inline">Review Comments</strong> page should look like <em class="italic">Figure 7.27</em>:<div id="_idContainer282" class="IMG---Figure"><img src="image/B15509_07_27.jpg" alt="Figure 7.27: Book detail page with added Add Review button&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 7.27: Book detail page with added Add Review button</p>
			<p>You can see the <strong class="source-inline">Add Review</strong> button. Clicking it will take you to the <strong class="source-inline">Create Book Review</strong> page, which should look like <em class="italic">Figure 7.28</em>:</p>
			<div>
				<div id="_idContainer283" class="IMG---Figure">
					<img src="image/B15509_07_28.jpg" alt="Figure 7.28: Review creation page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.28: Review creation page</p>
			<p>Enter some details in the form and click <strong class="source-inline">Create</strong>. You will be redirected to the <strong class="source-inline">Book Details</strong> page, and you should see the success message and your review, as in <em class="italic">Figure 7.29</em>:</p>
			<div>
				<div id="_idContainer284" class="IMG---Figure">
					<img src="image/B15509_07_29.jpg" alt="Figure 7.29: Book Details page with review added&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.29: Book Details page with review added</p>
			<p>You can also see the <strong class="source-inline">Edit Review</strong> link, and if you click it, you will be taken to a form that is pre-populated with your review data (see <em class="italic">Figure 7.30</em>):</p>
			<div>
				<div id="_idContainer285" class="IMG---Figure">
					<img src="image/B15509_07_30.jpg" alt="Figure 7.30: Review form when editing a review&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.30: Review form when editing a review</p>
			<p>After saving an existing review, you should see the <strong class="source-inline">Modified on</strong> date is updated on the <strong class="source-inline">Book Details</strong> page (<em class="italic">Figure 7.31</em>):</p>
			<div>
				<div id="_idContainer286" class="IMG---Figure">
					<img src="image/B15509_07_31.jpg" alt="Figure 7.31: The Modified on date is now populated&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.31: The Modified on date is now populated</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The solution to this activity can be found at <a href="http://packt.live/2Nh1NTJ">http://packt.live/2Nh1NTJ</a>.</p>
			<h1 id="_idParaDest-228"><a id="_idTextAnchor243"/>Summary</h1>
			<p>This chapter was a deep dive into forms. We saw how to enhance Django forms with custom validation advanced rules for cleaning data and validating fields. We saw how custom cleaning methods can transform the data that we get out of forms. A nice feature we saw that can be added to forms is the ability to set initial and placeholder values on fields, so the user does not have to fill them out.</p>
			<p>We then looked at how to use the <strong class="source-inline">ModelForm</strong> class to automatically create a form from a Django model. We saw how to only show some fields to the user and how to apply custom form validation rules to the <strong class="source-inline">ModelForm</strong>. We also saw how Django can automatically save the new or updated model instance to the database inside the view. In the activities for this chapter, we enhanced Bookr some more by adding forms for creating and editing publishers and submitting reviews. The next chapter will carry on the theme of submitting user input, and along with that, we'll discuss how Django handles uploading and downloading files.</p>
		</div>
		<div>
			<div id="_idContainer288" class="Content">
			</div>
		</div>
	</body></html>