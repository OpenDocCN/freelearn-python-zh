<html><head></head><body>
<section data-number="0.10" id="chapter-7-basics-of-classes-and-objects">
<h2 class="likechapterhead" data-number="0.10"><span><span class="kobospan" id="kobo.1.1">7</span></span><br class="tipbox1"/> <span id="x1-3760007"/><span class="kobospan" id="kobo.2.1">Basics of Classes and Objects</span></h2>
<p class="normal"><span class="kobospan" id="kobo.3.1">The point of computing is to process data. </span><span class="kobospan" id="kobo.3.2">We often encapsulate the processing and the data into a single definition. </span><span class="kobospan" id="kobo.3.3">We can organize objects into classes with a common collection of attributes to define their internal state and common behavior. </span><span class="kobospan" id="kobo.3.4">Each instance of a class is a distinct object with unique internal state and behavior.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.4.1">This concept of state and behavior applies particularly well to the way games work. </span><span class="kobospan" id="kobo.4.2">When building something like an interactive game, the user’s actions update the game state. </span><span class="kobospan" id="kobo.4.3">Each of the player’s possible actions is a method to change the state of the game. </span><span class="kobospan" id="kobo.4.4">In many games this leads to a lot of animation to show the transition from state to state. </span><span class="kobospan" id="kobo.4.5">In a single-player arcade-style game, the enemies or opponents will often be separate objects, each with an internal state that changes based on other enemy actions and the player’s actions.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.5.1">On the other hand, if we consider a card or dice game, there may be very few states possible. </span><span class="kobospan" id="kobo.5.2">A game like </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.6.1">Zonk </span></span><span class="kobospan" id="kobo.7.1">involves a player rolling (and rerolling) dice as long as their score improves. </span><span class="kobospan" id="kobo.7.2">If a subsequent roll fails to improve their hand of dice, their turn is over. </span><span class="kobospan" id="kobo.7.3">The hand’s state is the pool of dice that comprise the scoring subset, often pushed to one side of the table. </span><span class="kobospan" id="kobo.7.4">In a six-dice game, there will be from one to six scoring dice as distinct states. </span><span class="kobospan" id="kobo.7.5">Additionally, when all dice are scoring, the player can begin the rolling process again by rerolling all of the dice. </span><span class="kobospan" id="kobo.7.6">This leads to an additional ”over-the-top” state that the players must also bear in mind.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.8.1">The point of object-oriented design is to define the current state with the attributes of an object. </span><span class="kobospan" id="kobo.8.2">Each object is defined as an instance of a class of similar objects. </span><span class="kobospan" id="kobo.8.3">We write the class definitions in Python and use these to create objects. </span><span class="kobospan" id="kobo.8.4">The methods defined in the class cause the state changes on an object.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.9.1">In this chapter, we will look at the following recipes:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><a href="ch011_split_000.xhtml#x1-3770001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.10.1">Using a class to encapsulate data and processing</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch011_split_000.xhtml#x1-3830002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.11.1">Essential type hints for class definitions</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch011_split_000.xhtml#x1-3890003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.12.1">Designing classes with lots of processing</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch011_split_000.xhtml#x1-3950004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.13.1">Using typing.NamedTuple for immutable objects</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch011_split_000.xhtml#x1-4010005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.14.1">Using dataclasses for mutable objects</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch011_split_000.xhtml#x1-4070006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.15.1">Using frozen dataclasses for immutable objects</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch011_split_001.xhtml#x1-4130007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.16.1">Optimizing small objects with </span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.17.1">_</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.18.1">_slots</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.19.1">_</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.20.1">_</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch011_split_001.xhtml#x1-4190008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.21.1">Using more sophisticated collections</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch011_split_001.xhtml#x1-4250009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.22.1">Extending a built-in collection – a list that does statistics</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch011_split_001.xhtml#x1-43100010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.23.1">Using properties for lazy attributes</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch011_split_001.xhtml#x1-43700011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.24.1">Creating contexts and context managers</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch011_split_001.xhtml#x1-44300012" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.25.1">Managing multiple contexts with multiple resources</span></span></a></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.26.1">The subject of object-oriented design is quite large. </span><span class="kobospan" id="kobo.26.2">In this chapter, we’ll cover some of the essentials. </span><span class="kobospan" id="kobo.26.3">We’ll start with some foundational concepts, such as how a class definition encapsulates state and processing details for all instances of a class. </span><span id="x1-376001r764"/></p>
<section data-number="0.10.1" id="using-a-class-to-encapsulate-data-and-processing">
<h1 class="unnumbered" data-number="0.10.1"><span><span class="kobospan" id="kobo.27.1">7.1 </span></span> <span id="x1-3770001"/><span class="kobospan" id="kobo.28.1">Using a class to encapsulate data and processing</span></h1>
<p class="normal"><span class="kobospan" id="kobo.29.1">Class design is influenced</span><span id="dx1-377001"/><span class="kobospan" id="kobo.30.1"> by the SOLID design</span><span id="dx1-377002"/><span class="kobospan" id="kobo.31.1"> principles. </span><span class="kobospan" id="kobo.31.2">The Single Responsibility and Interface Segregation principles offer helpful advice. </span><span class="kobospan" id="kobo.31.3">Taken together, these principles advise us that a class should have methods narrowly focused on a single, well-defined responsibility.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.32.1">Another way of considering a class is as a group of closely-related functions working with common data. </span><span class="kobospan" id="kobo.32.2">We call these methods for working with the data. </span><span class="kobospan" id="kobo.32.3">A class definition should contain the smallest collection of methods for working with the object’s data.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.33.1">We’d like to create class definitions based on a narrow allocation of responsibilities. </span><span class="kobospan" id="kobo.33.2">How can we define responsibilities effectively? </span><span class="kobospan" id="kobo.33.3">What’s a good way to design a class? </span><span id="x1-377003r762"/></p>
<section data-number="0.10.1.1" id="getting-ready-52">
<h2 class="likechapterhead" data-number="0.10.1.1"><span><span class="kobospan" id="kobo.34.1">7.1.1 </span></span> <span id="x1-3780001"/><span class="kobospan" id="kobo.35.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.36.1">Let’s look at a simple, stateful object – a pair of dice. </span><span class="kobospan" id="kobo.36.2">The context for this is an application that simulates a simple game like </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.37.1">Craps</span></span><span class="kobospan" id="kobo.38.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.39.1">A software object can be viewed as analogous to a thing – a noun. </span><span class="kobospan" id="kobo.39.2">The behaviors of the class can then be viewed as verbs. </span><span class="kobospan" id="kobo.39.3">This identification with nouns and verbs gives us a hint as to how we can proceed to design classes to work effectively.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.40.1">This leads us to several steps of preparation. </span><span class="kobospan" id="kobo.40.2">We’ll provide concrete examples of these steps using a pair of dice for game simulation. </span><span class="kobospan" id="kobo.40.3">We proceed as follows:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-378002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.41.1">Write down simple sentences that describe what an instance of the class does. </span><span class="kobospan" id="kobo.41.2">We can call these the problem statements. </span><span class="kobospan" id="kobo.41.3">It’s essential to focus on single-verb sentences, with a focus on only the nouns and verbs. </span><span class="kobospan" id="kobo.41.4">Here are some examples:</span></p>
<ul class="calibre17">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.42.1">The game of </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.43.1">Craps </span></span><span class="kobospan" id="kobo.44.1">has two standard dice.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.45.1">Each die has six faces, with point values from one to six.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.46.1">Dice are rolled by a player. </span><span class="kobospan" id="kobo.46.2">While writers and editors prefer the active voice version, ”A player rolls the dice,” the dice are often acted upon by other objects, making passive-voice sentences slightly more useful.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.47.1">The total of the dice changes the state of the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.48.1">Craps </span></span><span class="kobospan" id="kobo.49.1">game. </span><span class="kobospan" id="kobo.49.2">Those rules are separate from the dice.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.50.1">If the two dice match, the number was described as being rolled “the hard way”. </span><span class="kobospan" id="kobo.50.2">If the two dice do not match, the roll was described as being made “the easy way”.</span></p></li>
</ul>
</div></li>
<li class="calibre7"><div id="x1-378004x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.51.1">Identify all of the nouns in the sentences. </span><span class="kobospan" id="kobo.51.2">In this example, the nouns include dice, faces, point values, and a player. </span><span class="kobospan" id="kobo.51.3">The nouns identify different classes of objects that may be </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.52.1">collaborators</span></span><span class="kobospan" id="kobo.53.1">, like player and game. </span><span class="kobospan" id="kobo.53.2">Nouns may also identify attributes of objects, like face and point value.</span></p>
</div></li>
<li class="calibre7"><div id="x1-378006x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.54.1">Identify all the verbs in the sentences. </span><span class="kobospan" id="kobo.54.2">Verbs often become methods of the class in question. </span><span class="kobospan" id="kobo.54.3">In this example, verbs include roll and match.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.55.1">This information helps define</span><span id="dx1-378007"/><span class="kobospan" id="kobo.56.1"> the state and behavior</span><span id="dx1-378008"/><span class="kobospan" id="kobo.57.1"> of the objects. </span><span class="kobospan" id="kobo.57.2">Having this background information will help us write the class definition. </span><span id="x1-378009r768"/></p>
</section>
<section data-number="0.10.1.2" id="how-to-do-it...-52">
<h2 class="likechapterhead" data-number="0.10.1.2"><span><span class="kobospan" id="kobo.58.1">7.1.2 </span></span> <span id="x1-3790002"/><span class="kobospan" id="kobo.59.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.60.1">Since the simulation we’re writing involves random throws of dice, we’ll depend on </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.61.1">from</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.62.1"> random</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.63.1"> import</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.64.1"> randint</span></span></span></span><span class="kobospan" id="kobo.65.1"> to provide the useful </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.66.1">randint()</span></span></span></span><span class="kobospan" id="kobo.67.1"> function. </span><span class="kobospan" id="kobo.67.2">The steps for defining a class are as follows:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-379002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.68.1">Start writing the class with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.69.1">class</span></span></span></span><span class="kobospan" id="kobo.70.1"> statement:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.71.1">
class Dice:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-379006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.72.1">Initialize the object’s attributes within the body of an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.73.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.74.1"> method. </span><span class="kobospan" id="kobo.74.2">We’ll model the internal state of the dice with a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.75.1">faces</span></span></span></span><span class="kobospan" id="kobo.76.1"> attribute. </span><span class="kobospan" id="kobo.76.2">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.77.1">self</span></span></span></span><span class="kobospan" id="kobo.78.1"> variable is required to be sure that we’re referencing an attribute of a given instance of a class. </span><span class="kobospan" id="kobo.78.2">We’ll provide a type hint on each attribute to be sure it’s used properly throughout the class definition:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.79.1">
    def __init__(self) -&gt; None: 
 
        self.faces: tuple[int, int] = (0, 0)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-379011x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.80.1">Define the object’s methods based on the verbs in the description. </span><span class="kobospan" id="kobo.80.2">When the player rolls the dice, a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.81.1">roll()</span></span></span></span><span class="kobospan" id="kobo.82.1"> method can set the values shown on the faces of the two dice. </span><span class="kobospan" id="kobo.82.2">We implement this with a method to set the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.83.1">faces</span></span></span></span><span class="kobospan" id="kobo.84.1"> attribute of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.85.1">self</span></span></span></span><span class="kobospan" id="kobo.86.1"> object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.87.1">
    def roll(self) -&gt; None: 
 
        self.faces = (randint(1,6), randint(1,6))</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.88.1">This method mutates the internal state of the object. </span><span class="kobospan" id="kobo.88.2">We’ve elected to not return a value.</span></p>
</div></li>
<li class="calibre7"><div id="x1-379016x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.89.1">After a player rolls the dice, a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.90.1">total()</span></span></span></span><span class="kobospan" id="kobo.91.1"> method helps compute the total of the dice:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.92.1">
    def total(self) -&gt; int: 
 
        return sum(self.faces)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-379021x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.93.1">Additional methods can provide answers to questions about the state of the dice. </span><span class="kobospan" id="kobo.93.2">In this case, the total was made ”the hard way” when both dice match:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.94.1">
    def hardway(self) -&gt; bool: 
 
        return self.faces[0] == self.faces[1] 
 
    def easyway(self) -&gt; bool: 
 
        return self.faces[0] != self.faces[1]                                                                

                                                                     
     </span></code></pre>
</div></li>
</ol>
<p class="normal1"><span id="x1-379027r769"/></p>
</section>
<section data-number="0.10.1.3" id="how-it-works...-52">
<h2 class="likechapterhead" data-number="0.10.1.3"><span><span class="kobospan" id="kobo.95.1">7.1.3 </span></span> <span id="x1-3800003"/><span class="kobospan" id="kobo.96.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.97.1">The core idea</span><span id="dx1-380001"/><span class="kobospan" id="kobo.98.1"> here is to use ordinary</span><span id="dx1-380002"/><span class="kobospan" id="kobo.99.1"> rules of grammar – nouns, verbs, and adjectives – as a way to identify basic features of a class. </span><span class="kobospan" id="kobo.99.2">In our example, dice are real things. </span><span class="kobospan" id="kobo.99.3">We try to avoid using abstract terms such as randomizers or event generators. </span><span class="kobospan" id="kobo.99.4">It’s easier to describe the tangible features of real things, and then define an implementation to match the tangible features.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.100.1">The idea of rolling the dice is an example physical action that we can model with a method definition. </span><span class="kobospan" id="kobo.100.2">This action of rolling the dice changes the state of the object. </span><span class="kobospan" id="kobo.100.3">In rare cases – 1 time in 36 – the next state will happen to match the previous state.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.101.1">Here’s an example of using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.102.1">Dice</span></span></span></span><span class="kobospan" id="kobo.103.1"> class:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-380004x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.104.1">First, we’ll seed the random number generator with a fixed value so that we can get a fixed sequence of results:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.105.1">
&gt;&gt;&gt; import random 
 
&gt;&gt;&gt; random.seed(1)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-380009x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.106.1">We’ll create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.107.1">Dice</span></span></span></span><span class="kobospan" id="kobo.108.1"> object, and assign it to a variable, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.109.1">d1</span></span></span></span><span class="kobospan" id="kobo.110.1">. </span><span class="kobospan" id="kobo.110.2">We can then set its state with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.111.1">roll()</span></span></span></span><span class="kobospan" id="kobo.112.1"> method. </span><span class="kobospan" id="kobo.112.2">We’ll then look at the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.113.1">total()</span></span></span></span><span class="kobospan" id="kobo.114.1"> method to see what was rolled. </span><span class="kobospan" id="kobo.114.2">We’ll examine</span><span id="dx1-380010"/><span class="kobospan" id="kobo.115.1"> the state by looking</span><span id="dx1-380011"/><span class="kobospan" id="kobo.116.1"> at the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.117.1">faces</span></span></span></span><span class="kobospan" id="kobo.118.1"> attribute:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.119.1">
&gt;&gt;&gt; d1 = Dice() 
 
&gt;&gt;&gt; d1.roll() 
 
&gt;&gt;&gt; d1.total() 
 
7 
 
&gt;&gt;&gt; d1.faces 
 
(2, 5)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span id="x1-380019r775"/></p>
</section>
<section data-number="0.10.1.4" id="theres-more...-44">
<h2 class="likechapterhead" data-number="0.10.1.4"><span><span class="kobospan" id="kobo.120.1">7.1.4 </span></span> <span id="x1-3810004"/><span class="kobospan" id="kobo.121.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.122.1">Capturing the essential internal state and methods that cause state change is the first step in good class design. </span><span class="kobospan" id="kobo.122.2">We can summarize some helpful design</span><span id="dx1-381001"/><span class="kobospan" id="kobo.123.1"> principles using the acronym </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.124.1">SOLID</span></span><span class="kobospan" id="kobo.125.1">:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.126.1">Single Responsibility Principle</span></span><span class="kobospan" id="kobo.127.1">: A class should have one clearly defined responsibility.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.128.1">Open/Closed Principle</span></span><span class="kobospan" id="kobo.129.1">: A class should be open to extension – generally via inheritance – but closed to modification. </span><span class="kobospan" id="kobo.129.2">We should design our classes so that we don’t need to tweak the code to add or change features.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.130.1">Liskov Substitution Principle</span></span><span class="kobospan" id="kobo.131.1">: We need to design inheritance so that a subclass can be used in place of the superclass.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.132.1">Interface Segregation Principle</span></span><span class="kobospan" id="kobo.133.1">: When writing a problem statement, we want to be sure that collaborating classes have as few dependencies as possible. </span><span class="kobospan" id="kobo.133.2">In many cases, this principle will lead us to decompose large problems into many small class definitions.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.134.1">Dependency Inversion Principle</span></span><span class="kobospan" id="kobo.135.1">: It’s less than ideal for a class to depend directly on other classes. </span><span class="kobospan" id="kobo.135.2">It’s better if a class depends on an abstraction, and a concrete implementation class is substituted</span><span id="dx1-381002"/><span class="kobospan" id="kobo.136.1"> for the abstract class.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.137.1">The goal is to create classes that have the necessary behavior and also adhere to the design principles so they can be extended and reused. </span><span id="x1-381003r778"/></p>
</section>
<section data-number="0.10.1.5" id="see-also-51">
<h2 class="likechapterhead" data-number="0.10.1.5"><span><span class="kobospan" id="kobo.138.1">7.1.5 </span></span> <span id="x1-3820005"/><span class="kobospan" id="kobo.139.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.140.1">See the </span><a href="ch011_split_001.xhtml#x1-43100010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.141.1">Using properties for lazy attributes</span></span></a><span class="kobospan" id="kobo.142.1"> recipe, where we’ll look at the choice between an eager attribute and a lazy property.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.143.1">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.144.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.145.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.146.1">8</span></span></a><span class="kobospan" id="kobo.147.1">, we’ll look in more depth at class design techniques.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.148.1">See </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.149.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.150.1"> </span></span><a href="ch019_split_000.xhtml#x1-79400015" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.151.1">15</span></span></a><span class="kobospan" id="kobo.152.1">, for recipes on how to write appropriate unit tests for the class.</span></p></li>
</ul>
<p class="normal1"><span id="x1-382001r767"/></p>
</section>
</section>
<section data-number="0.10.2" id="essential-type-hints-for-class-definitions">
<h1 class="unnumbered" data-number="0.10.2"><span><span class="kobospan" id="kobo.153.1">7.2 </span></span> <span id="x1-3830002"/><span class="kobospan" id="kobo.154.1">Essential type hints for class definitions</span></h1>
<p class="normal"><span class="kobospan" id="kobo.155.1">A class name is also a type</span><span id="dx1-383001"/><span class="kobospan" id="kobo.156.1"> hint, allowing a direct reference between a variable and the class that should define the objects associated with the variable. </span><span class="kobospan" id="kobo.156.2">This relationship lets tools such as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.157.1">mypy </span></span><span class="kobospan" id="kobo.158.1">reason about our programs</span><span id="dx1-383002"/><span class="kobospan" id="kobo.159.1"> to be sure that object references and method references appear to match the type hints in our code.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.160.1">In addition to the class name, we’ll use type hints in three common places within a class definition:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.161.1">In method definitions, we’ll use type hints to annotate the parameters and the return type.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.162.1">In the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.163.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.164.1"> method, we may need to provide hints for the instance variables that define the state of the object.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.165.1">Inside the attributes of the class overall. </span><span class="kobospan" id="kobo.165.2">These are not common and type hints are rare here.</span></p></li>
</ul>
<p class="normal1"><span id="x1-383003r779"/></p>
<section data-number="0.10.2.1" id="getting-ready-53">
<h2 class="likechapterhead" data-number="0.10.2.1"><span><span class="kobospan" id="kobo.166.1">7.2.1 </span></span> <span id="x1-3840001"/><span class="kobospan" id="kobo.167.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.168.1">We’re going to examine a class</span><span id="dx1-384001"/><span class="kobospan" id="kobo.169.1"> with a variety of type hints. </span><span class="kobospan" id="kobo.169.2">In this example, our class will model a handful of dice. </span><span class="kobospan" id="kobo.169.3">We’ll allow rerolling selected dice, making the instance of the class stateful.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.170.1">The collection of dice can be set by a first roll, where all the dice are rolled. </span><span class="kobospan" id="kobo.170.2">The class allows subsequent rolls of a subset of dice. </span><span class="kobospan" id="kobo.170.3">The number of rolls is counted as well.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.171.1">The type hints will reflect the nature of the collection of dice, the integer counts, a floating-point average value, and a string representation of the hand as a whole. </span><span class="kobospan" id="kobo.171.2">This will show a number of type hints and how to write them. </span><span id="x1-384002r781"/></p>
</section>
<section data-number="0.10.2.2" id="how-to-do-it...-53">
<h2 class="likechapterhead" data-number="0.10.2.2"><span><span class="kobospan" id="kobo.172.1">7.2.2 </span></span> <span id="x1-3850002"/><span class="kobospan" id="kobo.173.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-385002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.174.1">This definition will involve random numbers as well as type hints for sets and lists. </span><span class="kobospan" id="kobo.174.2">We import the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.175.1">random</span></span></span></span><span class="kobospan" id="kobo.176.1"> module:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.177.1">
import random                                                                

                                                                     
     </span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-385006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.178.1">Define the class. </span><span class="kobospan" id="kobo.178.2">This creates a new type:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.179.1">
class Dice:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-385010x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.180.1">It’s rare for class-level variables to require a type hint. </span><span class="kobospan" id="kobo.180.2">They’re almost always created with assignment statements that make the type information</span><span id="dx1-385011"/><span class="kobospan" id="kobo.181.1"> clear to a person or a tool like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.182.1">mypy</span></span><span class="kobospan" id="kobo.183.1">. </span><span class="kobospan" id="kobo.183.2">In this case, we want all instances of our class of dice to share a common random number generator object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.184.1">
    RNG = random.Random()</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-385015x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.185.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.186.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.187.1"> method creates the instance variables that define the state of the object. </span><span class="kobospan" id="kobo.187.2">In this case, we’ll save some configuration details, plus some internal state. </span><span class="kobospan" id="kobo.187.3">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.188.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.189.1"> method also has the initialization parameters. </span><span class="kobospan" id="kobo.189.2">Generally, we’ll put the type hints on these parameters. </span><span class="kobospan" id="kobo.189.3">Other internal state variables may require type hints to show what kinds of values will be assigned by other methods of the class. </span><span class="kobospan" id="kobo.189.4">In this example, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.190.1">faces</span></span></span></span><span class="kobospan" id="kobo.191.1"> attribute has no initial value; we state that when it is set, it will be a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.192.1">List[int]</span></span></span></span><span class="kobospan" id="kobo.193.1"> object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.194.1">
    def __init__(self, n: int, sides: int = 6) -&gt; None: 
 
        self.n_dice = n 
 
        self.sides = sides 
 
        self.faces: list[int] 
 
        self.roll_number = 0</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-385023x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.195.1">Methods that compute new derived values</span><span id="dx1-385024"/><span class="kobospan" id="kobo.196.1"> can be annotated with their return type information. </span><span class="kobospan" id="kobo.196.2">Here are three examples to return a string representation, compute the total, and also compute an average of the dice. </span><span class="kobospan" id="kobo.196.3">These functions have return types of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.197.1">str</span></span></span></span><span class="kobospan" id="kobo.198.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.199.1">int</span></span></span></span><span class="kobospan" id="kobo.200.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.201.1">float</span></span></span></span><span class="kobospan" id="kobo.202.1">, as shown:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.203.1">
    def __str__(self) -&gt; str: 
 
        return ", ".join( 
 
            f"{i}: {f}" 
 
            for i, f in enumerate(self.faces) 
 
        ) 
 
 
 
    def total(self) -&gt; int: 
 
        return sum(self.faces) 
 
 
 
    def average(self) -&gt; float: 
 
        return sum(self.faces) / self.n_dice</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-385038x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.204.1">For methods with parameters, we include type hints on the parameters as well as a return type. </span><span class="kobospan" id="kobo.204.2">In this case, the methods that change the internal state also return values. </span><span class="kobospan" id="kobo.204.3">The return value from both methods is a list of dice faces, described as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.205.1">list[int]</span></span></span></span><span class="kobospan" id="kobo.206.1">. </span><span class="kobospan" id="kobo.206.2">The parameter for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.207.1">reroll()</span></span></span></span><span class="kobospan" id="kobo.208.1"> method is a set of dice to be rolled again. </span><span class="kobospan" id="kobo.208.2">This is shown as a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.209.1">set[int]</span></span></span></span><span class="kobospan" id="kobo.210.1"> requiring a set of integers. </span><span class="kobospan" id="kobo.210.2">Python is a little more flexible than this, and we’ll look at some alternatives:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.211.1">
    def first_roll(self) -&gt; list[int]: 
 
        self.roll_number = 0 
 
        self.faces = [ 
 
            self.RNG.randint(1, self.sides) 
 
            for _ in range(self.n_dice) 
 
        ] 
 
        return self.faces 
 
 
 
    def reroll(self, positions: set[int]) -&gt; list[int]: 
 
        self.roll_number += 1 
 
        for p in positions: 
 
            self.faces[p] = self.RNG.randint(1, self.sides) 
 
        return self.faces</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span id="x1-385053r782"/></p>
</section>
<section data-number="0.10.2.3" id="how-it-works...-53">
<h2 class="likechapterhead" data-number="0.10.2.3"><span><span class="kobospan" id="kobo.212.1">7.2.3 </span></span> <span id="x1-3860003"/><span class="kobospan" id="kobo.213.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.214.1">The type hint information</span><span id="dx1-386001"/><span class="kobospan" id="kobo.215.1"> is used by programs</span><span id="dx1-386002"/><span class="kobospan" id="kobo.216.1"> such as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.217.1">mypy </span></span><span class="kobospan" id="kobo.218.1">to be sure that the instances of the class are used properly throughout the application.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.219.1">If we try to write a function like the following:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.220.1">
 
 
def example_mypy_failure() -&gt; None: 
 
    d = Dice(2.5) 
 
    d.first_roll() 
 
    print(d)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.221.1">The attempt to create an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.222.1">Dice</span></span></span></span><span class="kobospan" id="kobo.223.1"> class using a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.224.1">float</span></span></span></span><span class="kobospan" id="kobo.225.1"> value for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.226.1">n</span></span></span></span><span class="kobospan" id="kobo.227.1"> parameter represents a conflict with the type hints. </span><span class="kobospan" id="kobo.227.2">The hint for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.228.1">Dice</span></span></span></span><span class="kobospan" id="kobo.229.1"> class’s </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.230.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.231.1"> method claimed the argument value should be an integer. </span><span class="kobospan" id="kobo.231.2">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.232.1">mypy </span></span><span class="kobospan" id="kobo.233.1">program reports the following:</span></p>
<pre class="programlisting" id="listing-38"><code class="calibre13"><span class="kobospan" id="kobo.234.1">src/ch07/recipe_02_bad.py:9: error: Argument 1 to "Dice" has incompatible type "float"; expected "int"  [arg-type]</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.235.1">If we try to execute the application, it will raise a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.236.1">TypeError</span></span></span></span><span class="kobospan" id="kobo.237.1"> exception in another place. </span><span class="kobospan" id="kobo.237.2">The error will manifest when evaluating the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.238.1">d.first_roll()</span></span></span></span><span class="kobospan" id="kobo.239.1"> method. </span><span class="kobospan" id="kobo.239.2">The exception is raised here because the body of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.240.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.241.1"> method works well with values of any type. </span><span class="kobospan" id="kobo.241.2">The hints claim specific types are expected, but at runtime, any object can be provided. </span><span class="kobospan" id="kobo.241.3">The hints are not checked during execution.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.242.1">Similarly, when we use other methods, the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.243.1">mypy </span></span><span class="kobospan" id="kobo.244.1">program checks to be sure our use of the method matches the expectations defined by the type hints. </span><span class="kobospan" id="kobo.244.2">Here’s another example:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.245.1">
 
 
    r1: list[str] = d.first_roll()</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.246.1">This assignment statement has a type hint for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.247.1">r1</span></span></span></span><span class="kobospan" id="kobo.248.1"> variable that doesn’t match the type hint for the return type from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.249.1">first_roll()</span></span></span></span><span class="kobospan" id="kobo.250.1"> method. </span><span class="kobospan" id="kobo.250.2">This conflict</span><span id="dx1-386011"/><span class="kobospan" id="kobo.251.1"> is found by </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.252.1">mypy </span></span><span class="kobospan" id="kobo.253.1">and reported</span><span id="dx1-386012"/><span class="kobospan" id="kobo.254.1"> as an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.255.1">Incompatible</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.256.1"> types</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.257.1"> in</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.258.1"> assignment</span></span></span></span><span class="kobospan" id="kobo.259.1"> error. </span><span id="x1-386013r789"/></p>
</section>
<section data-number="0.10.2.4" id="theres-more...-45">
<h2 class="likechapterhead" data-number="0.10.2.4"><span><span class="kobospan" id="kobo.260.1">7.2.4 </span></span> <span id="x1-3870004"/><span class="kobospan" id="kobo.261.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.262.1">One of the type hints in this example is too specific. </span><span class="kobospan" id="kobo.262.2">The function for re-rolling the dice, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.263.1">reroll()</span></span></span></span><span class="kobospan" id="kobo.264.1">, has a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.265.1">positions</span></span></span></span><span class="kobospan" id="kobo.266.1"> parameter. </span><span class="kobospan" id="kobo.266.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.267.1">positions</span></span></span></span><span class="kobospan" id="kobo.268.1"> parameter is used in a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.269.1">for</span></span></span></span><span class="kobospan" id="kobo.270.1"> statement, which means the object must be some kind of iterable object.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.271.1">The mistake was providing a type hint, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.272.1">set[int]</span></span></span></span><span class="kobospan" id="kobo.273.1">, which is only one of many kinds of iterable objects. </span><span class="kobospan" id="kobo.273.2">We can generalize this definition by switching the type hint from the very specific </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.274.1">set[int]</span></span></span></span><span class="kobospan" id="kobo.275.1"> to the more general </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.276.1">Iterable[int]</span></span></span></span><span class="kobospan" id="kobo.277.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.278.1">Relaxing the hint means that any set, list, or tuple object can be a valid argument value for this parameter. </span><span class="kobospan" id="kobo.278.2">The only other code change required is to import </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.279.1">Iterable</span></span></span></span><span class="kobospan" id="kobo.280.1"> from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.281.1">collections.abc</span></span></span></span><span class="kobospan" id="kobo.282.1"> module.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.283.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.284.1">for</span></span></span></span><span class="kobospan" id="kobo.285.1"> statement has a specific protocol for getting the iterator object from an iterable collection, assigning values to a variable, and executing the indented body. </span><span class="kobospan" id="kobo.285.2">This protocol is defined by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.286.1">Iterable</span></span></span></span><span class="kobospan" id="kobo.287.1"> type hint. </span><span class="kobospan" id="kobo.287.2">There are many such protocol-based types, and they allow us to provide type hints that match Python’s inherent flexibility with respect to type. </span><span id="x1-387001r792"/></p>
</section>
<section data-number="0.10.2.5" id="see-also-52">
<h2 class="likechapterhead" data-number="0.10.2.5"><span><span class="kobospan" id="kobo.288.1">7.2.5 </span></span> <span id="x1-3880005"/><span class="kobospan" id="kobo.289.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.290.1">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.291.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.292.1"> </span></span><a href="ch007_split_000.xhtml#x1-1610003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.293.1">3</span></span></a><span class="kobospan" id="kobo.294.1">, in the </span><a href="ch007_split_000.xhtml#x1-1620001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.295.1">Function parameters and type hints</span></span></a><span class="kobospan" id="kobo.296.1"> recipe, a number of similar concepts are shown.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.297.1">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.298.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.299.1"> </span></span><a href="ch008_split_000.xhtml#x1-2240004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.300.1">4</span></span></a><span class="kobospan" id="kobo.301.1">, the </span><a href="ch008_split_001.xhtml#x1-2560005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.302.1">Writing list-related type hints</span></span></a><span class="kobospan" id="kobo.303.1"> and </span><a href="ch008_split_001.xhtml#x1-2800009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.304.1">Writing set-related</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.305.1">type hints</span></span></a><span class="kobospan" id="kobo.306.1"> recipes address additional detailed type hinting.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.307.1">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.308.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.309.1"> </span></span><a href="ch009.xhtml#x1-2890005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.310.1">5</span></span></a><span class="kobospan" id="kobo.311.1">, the </span><a href="ch009.xhtml#x1-3040003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.312.1">Writing dictionary-related type hints</span></span></a><span class="kobospan" id="kobo.313.1"> recipe also addresses type hinting.</span></p></li>
</ul>
<p class="normal1"><span id="x1-388001r780"/></p>
</section>
</section>
<section data-number="0.10.3" id="designing-classes-with-lots-of-processing">
<h1 class="unnumbered" data-number="0.10.3"><span><span class="kobospan" id="kobo.314.1">7.3 </span></span> <span id="x1-3890003"/><span class="kobospan" id="kobo.315.1">Designing classes with lots of processing</span></h1>
<p class="normal"><span class="kobospan" id="kobo.316.1">Some of the time, an object</span><span id="dx1-389001"/><span class="kobospan" id="kobo.317.1"> will contain all of the data</span><span id="dx1-389002"/><span class="kobospan" id="kobo.318.1"> that defines its internal state. </span><span class="kobospan" id="kobo.318.2">There are cases, however, where a class doesn’t hold the data, but instead is designed to consolidate processing for data held in separate containers.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.319.1">Some prime examples of this design are statistical algorithms, which are often outside the data being analyzed. </span><span class="kobospan" id="kobo.319.2">The data might be in a built-in list or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.320.1">Counter</span></span></span></span><span class="kobospan" id="kobo.321.1"> object; the processing is defined in a class separate from the data container. </span><span id="x1-389003r793"/></p>
<section data-number="0.10.3.1" id="getting-ready-54">
<h2 class="likechapterhead" data-number="0.10.3.1"><span><span class="kobospan" id="kobo.322.1">7.3.1 </span></span> <span id="x1-3900001"/><span class="kobospan" id="kobo.323.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.324.1">It’s quite common to do analysis on data that’s already been summarized into groups or bins. </span><span class="kobospan" id="kobo.324.2">We might, for example, have a vast data file with a large number of measurements of an industrial process.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.325.1">For background, see the</span><span id="dx1-390001"/><span class="kobospan" id="kobo.326.1"> NIST Aerosol Particle Size case study: </span><a class="url" href="https://www.itl.nist.gov/div898/handbook/pmc/section6/pmc62.htm"><span class="url1"><span class="kobospan" id="kobo.327.1">https://www.itl.nist.gov/div898/handbook/pmc/section6/pmc62.htm</span></span></a></p>
<p class="normal1"><span class="kobospan" id="kobo.328.1">Rather than analyze the voluminous raw data, it’s often much faster to first summarize the important variables, then analyze the summarized data. </span><span class="kobospan" id="kobo.328.2">The summary data can be kept in a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.329.1">Counter</span></span></span></span><span class="kobospan" id="kobo.330.1"> object. </span><span class="kobospan" id="kobo.330.2">The data looks like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.331.1">
 
 
data = Counter({7: 80, 
 
         6: 67, 
 
         8: 62, 
 
         9: 50,</span></code></pre>
<pre class="programlisting" id="listing-39"><code class="calibre13"><span class="kobospan" id="kobo.332.1">... </span><span class="kobospan" id="kobo.332.2">Details omitted ...</span></code></pre>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.333.1">
 
 
         2: 3, 
 
         3: 2, 
 
         1: 1})</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.334.1">The keys (</span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.335.1">7</span></span></span></span><span class="kobospan" id="kobo.336.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.337.1">6</span></span></span></span><span class="kobospan" id="kobo.338.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.339.1">8</span></span></span></span><span class="kobospan" id="kobo.340.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.341.1">9</span></span></span></span><span class="kobospan" id="kobo.342.1">, and so on) are codes reflecting the particle size. </span><span class="kobospan" id="kobo.342.2">The actual sizes varied from </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.343.1">109</span></span></span></span><span class="kobospan" id="kobo.344.1"> to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.345.1">119</span></span></span></span><span class="kobospan" id="kobo.346.1">. </span><span class="kobospan" id="kobo.346.2">Computing the actual size, </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.347.1">c</span></span><span class="kobospan" id="kobo.348.1">, from the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.349.1">s </span></span><span class="kobospan" id="kobo.350.1">code is done with </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.351.1">c </span></span><span class="kobospan" id="kobo.352.1">= </span><span><span class="kobospan" id="kobo.353.1">⌊</span></span><span class="kobospan" id="kobo.354.1">2(</span><span class="cmti-10x-x"><span class="kobospan" id="kobo.355.1">s </span></span><span><span class="kobospan" id="kobo.356.1">− </span></span><span class="kobospan" id="kobo.357.1">109)</span><span><span class="kobospan" id="kobo.358.1">⌋</span></span><span class="kobospan" id="kobo.359.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.360.1">(The units aren’t provided in the NIST background information. </span><span class="kobospan" id="kobo.360.2">Since a lot of the data reflects electronic chip wafers and fabrication, the units are likely something very small.)</span></p>
<p class="normal1"><span class="kobospan" id="kobo.361.1">We want to compute</span><span id="dx1-390012"/><span class="kobospan" id="kobo.362.1"> some statistics</span><span id="dx1-390013"/><span class="kobospan" id="kobo.363.1"> on this </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.364.1">Counter</span></span></span></span><span class="kobospan" id="kobo.365.1"> object without being forced to work with the original voluminous dataset. </span><span class="kobospan" id="kobo.365.2">In general, there are two general design strategies for designing classes to store and process data:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.366.1">Extend </span></span><span class="kobospan" id="kobo.367.1">the storage class definition, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.368.1">Counter</span></span></span></span><span class="kobospan" id="kobo.369.1"> in this case, to add statistical processing. </span><span class="kobospan" id="kobo.369.2">We’ll cover this in detail in the </span><a href="ch011_split_001.xhtml#x1-4250009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.370.1">Extending a</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.371.1">built-in collection – a list that does statistics</span></span></a><span class="kobospan" id="kobo.372.1"> recipe.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.373.1">Wrap </span></span><span class="kobospan" id="kobo.374.1">a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.375.1">Counter</span></span></span></span><span class="kobospan" id="kobo.376.1"> object in a class that provides the additional features required. </span><span class="kobospan" id="kobo.376.2">When we do this, though, we have two more choices:</span></p>
<ul class="calibre25">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.377.1">Expose the underlying </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.378.1">Counter</span></span></span></span><span class="kobospan" id="kobo.379.1"> object. </span><span class="kobospan" id="kobo.379.2">We’ll focus on this.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.380.1">Write special methods to make the wrapper appear to also be a collection, encapsulating the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.381.1">Counter</span></span></span></span><span class="kobospan" id="kobo.382.1"> object. </span><span class="kobospan" id="kobo.382.2">We’ll look at this in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.383.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.384.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.385.1">8</span></span></a><span class="kobospan" id="kobo.386.1">.</span></p></li>
</ul></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.387.1">For this recipe, we’ll focus on the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.388.1">wrap </span></span><span class="kobospan" id="kobo.389.1">variant where we define a statistical computation class that exposes a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.390.1">Counter</span></span></span></span><span class="kobospan" id="kobo.391.1"> object. </span><span class="kobospan" id="kobo.391.2">We have two ways to design this compute-intensive processing:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.392.1">An </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.393.1">Eager </span></span><span class="kobospan" id="kobo.394.1">implementation computes the statistics</span><span id="dx1-390014"/><span class="kobospan" id="kobo.395.1"> as soon as possible. </span><span class="kobospan" id="kobo.395.2">The values become simple attributes. </span><span class="kobospan" id="kobo.395.3">We’ll focus on this choice.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.396.1">A </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.397.1">Lazy </span></span><span class="kobospan" id="kobo.398.1">approach</span><span id="dx1-390015"/><span class="kobospan" id="kobo.399.1"> doesn’t compute anything until the value is required via a method function or property. </span><span class="kobospan" id="kobo.399.2">We’ll look at this in the </span><a href="ch011_split_001.xhtml#x1-43100010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.400.1">Using</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.401.1">properties for lazy attributes</span></span></a><span class="kobospan" id="kobo.402.1"> recipe.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.403.1">The essential algorithm for both designs is the same. </span><span class="kobospan" id="kobo.403.2">The only question is when the work of the computation gets done. </span><span id="x1-390016r795"/></p>
</section>
<section data-number="0.10.3.2" id="how-to-do-it...-54">
<h2 class="likechapterhead" data-number="0.10.3.2"><span><span class="kobospan" id="kobo.404.1">7.3.2 </span></span> <span id="x1-3910002"/><span class="kobospan" id="kobo.405.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-391002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.406.1">Import the appropriate class</span><span id="dx1-391003"/><span class="kobospan" id="kobo.407.1"> from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.408.1">collections</span></span></span></span><span class="kobospan" id="kobo.409.1"> module. </span><span class="kobospan" id="kobo.409.2">The computation</span><span id="dx1-391004"/><span class="kobospan" id="kobo.410.1"> uses </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.411.1">math.sqrt()</span></span></span></span><span class="kobospan" id="kobo.412.1">. </span><span class="kobospan" id="kobo.412.2">Be sure to add the needed </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.413.1">import</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.414.1"> math</span></span></span></span><span class="kobospan" id="kobo.415.1"> also:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.416.1">
from collections import Counter 
 
import math</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-391009x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.417.1">Define the class with a descriptive name:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.418.1">
                                                                     

                                                                     
class CounterStatistics:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-391013x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.419.1">Write the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.420.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.421.1"> method to include the object where the data is located. </span><span class="kobospan" id="kobo.421.2">In this case, the type hint is </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.422.1">Counter[int]</span></span></span></span><span class="kobospan" id="kobo.423.1"> because the keys used in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.424.1">Counter</span></span></span></span><span class="kobospan" id="kobo.425.1"> object will be integers:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.426.1">
    def __init__(self, raw_counter: Counter[int]) -&gt;  None: 
 
        self.raw_counter = raw_counter</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-391018x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.427.1">Initialize any other local variables in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.428.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.429.1"> method that might be useful. </span><span class="kobospan" id="kobo.429.2">Since we’re going to calculate values eagerly, the most eager possible time is when the object is created. </span><span class="kobospan" id="kobo.429.3">We’ll write references to some yet to be defined functions:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.430.1">
        self.mean = self.compute_mean() 
 
        self.stddev = self.compute_stddev()</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-391023x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.431.1">Define the required methods for the various values. </span><span class="kobospan" id="kobo.431.2">Here’s the calculation of the mean:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.432.1">
    def compute_mean(self) -&gt; float: 
 
        total, count = 0.0, 0 
 
        for value, frequency in self.raw_counter.items(): 
 
            total += value * frequency 
 
            count += frequency 
 
        return total / count</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-391032x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.433.1">Here’s how we can calculate the standard deviation:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.434.1">
    def compute_stddev(self) -&gt; float: 
 
        total, count = 0.0, 0 
 
        for value, frequency in self.raw_counter.items(): 
 
            total += frequency * (value - self.mean) ** 2 
 
            count += frequency 
 
        return math.sqrt(total / (count - 1))</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.435.1">Note that this calculation</span><span id="dx1-391040"/><span class="kobospan" id="kobo.436.1"> requires that the mean</span><span id="dx1-391041"/><span class="kobospan" id="kobo.437.1"> is computed first and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.438.1">self.mean</span></span></span></span><span class="kobospan" id="kobo.439.1"> instance variable has been created. </span><span class="kobospan" id="kobo.439.2">This internal state change from no known mean to a known mean to a known standard deviation is a potential complication that requires clear documentation.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.440.1">The raw data for this example is at </span><a class="url" href="https://www.itl.nist.gov/div898/handbook//datasets/NEGIZ4.DAT"><span class="url1"><span class="kobospan" id="kobo.441.1">https://www.itl.nist.gov/div898/handbook//datasets/NEGIZ4.DAT</span></span></a><span class="kobospan" id="kobo.442.1">. </span><span class="kobospan" id="kobo.442.2">This file has an awkwardly complicated layout because there are 50 lines of header text in front of the data. </span><span class="kobospan" id="kobo.442.3">Further, the file isn’t in a common CSV format. </span><span class="kobospan" id="kobo.442.4">For these reasons, it’s easier to work with summarized data.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.443.1">The repository of code for this book includes a file named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.444.1">data/binned.csv</span></span></span></span><span class="kobospan" id="kobo.445.1"> that has the binned summary data. </span><span class="kobospan" id="kobo.445.2">This data has three columns: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.446.1">size_code</span></span></span></span><span class="kobospan" id="kobo.447.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.448.1">size</span></span></span></span><span class="kobospan" id="kobo.449.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.450.1">frequency</span></span></span></span><span class="kobospan" id="kobo.451.1">. </span><span class="kobospan" id="kobo.451.2">We’re only interested in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.452.1">size_code</span></span></span></span><span class="kobospan" id="kobo.453.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.454.1">frequency</span></span></span></span><span class="kobospan" id="kobo.455.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.456.1">Here’s how we can build a suitable </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.457.1">Counter</span></span></span></span><span class="kobospan" id="kobo.458.1"> object from this file:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.459.1">
 
 
&gt;&gt;&gt; from pathlib import Path 
 
&gt;&gt;&gt; import csv 
 
&gt;&gt;&gt; from collections import Counter 
 
 
 
&gt;&gt;&gt; data_path = Path.cwd() / "data" / "binned.csv" 
 
&gt;&gt;&gt; with data_path.open() as data_file: 
 
... </span><span class="kobospan" id="kobo.459.2">    reader = csv.DictReader(data_file) 
 
... </span><span class="kobospan" id="kobo.459.3">    extract = { 
 
... </span><span class="kobospan" id="kobo.459.4">        int(row[’size_code’]): int(row[’frequency’]) 
 
... </span><span class="kobospan" id="kobo.459.5">        for row in reader 
 
... </span><span class="kobospan" id="kobo.459.6">    } 
 
&gt;&gt;&gt; data = Counter(extract)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.460.1">We’ve used a dictionary comprehension to create a mapping from </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.461.1">size_code</span></span></span></span><span class="kobospan" id="kobo.462.1"> to the frequency of that code value. </span><span class="kobospan" id="kobo.462.2">This is then provided to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.463.1">Counter</span></span></span></span><span class="kobospan" id="kobo.464.1"> class to build a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.465.1">Counter</span></span></span></span><span class="kobospan" id="kobo.466.1"> object named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.467.1">data</span></span></span></span><span class="kobospan" id="kobo.468.1"> from this existing summary. </span><span class="kobospan" id="kobo.468.2">We can provide this data to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.469.1">CounterStatistics</span></span></span></span><span class="kobospan" id="kobo.470.1"> class to get useful summary statistics from the binned data. </span><span class="kobospan" id="kobo.470.2">This looks like the following example:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.471.1">
 
 
&gt;&gt;&gt; stats = CounterStatistics(data) 
 
&gt;&gt;&gt; print(f"Mean: {stats.mean:.1f}") 
 
Mean: 10.4 
 
&gt;&gt;&gt; print(f"Standard Deviation: {stats.stddev:.2f}") 
 
Standard Deviation: 4.17</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.472.1">We provided the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.473.1">data</span></span></span></span><span class="kobospan" id="kobo.474.1"> object to create an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.475.1">CounterStatistics</span></span></span></span><span class="kobospan" id="kobo.476.1"> class. </span><span class="kobospan" id="kobo.476.2">Creating this instance will also immediately compute the summary statistics. </span><span class="kobospan" id="kobo.476.3">No additional explicit method evaluations are required. </span><span class="kobospan" id="kobo.476.4">These values are available as the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.477.1">stats.mean</span></span></span></span><span class="kobospan" id="kobo.478.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.479.1">stats.stddev</span></span></span></span><span class="kobospan" id="kobo.480.1"> attributes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.481.1">The processing cost to compute</span><span id="dx1-391061"/><span class="kobospan" id="kobo.482.1"> the statistics</span><span id="dx1-391062"/><span class="kobospan" id="kobo.483.1"> is paid initially. </span><span class="kobospan" id="kobo.483.2">As we’ll see below, a tiny incremental cost can be associated with any change to the underlying data. </span><span id="x1-391063r798"/></p>
</section>
<section data-number="0.10.3.3" id="how-it-works...-54">
<h2 class="likechapterhead" data-number="0.10.3.3"><span><span class="kobospan" id="kobo.484.1">7.3.3 </span></span> <span id="x1-3920003"/><span class="kobospan" id="kobo.485.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.486.1">This class encapsulates two complex algorithms, but doesn’t include any of the data for those algorithms. </span><span class="kobospan" id="kobo.486.2">The data is kept separately, in a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.487.1">Counter</span></span></span></span><span class="kobospan" id="kobo.488.1"> object. </span><span class="kobospan" id="kobo.488.2">We wrote a high-level specification for the processing and placed it in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.489.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.490.1"> method. </span><span class="kobospan" id="kobo.490.2">Then we wrote methods to implement the processing steps that were specified. </span><span class="kobospan" id="kobo.490.3">We can set as many attributes as are needed, making this a very flexible approach.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.491.1">The advantage of this design is that the attribute values can be used repeatedly. </span><span class="kobospan" id="kobo.491.2">The cost of computation for the mean and standard deviation is paid once; each time an attribute value is used, no further processing is required.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.492.1">The disadvantage of this design is that any changes to the state of the underlying </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.493.1">Counter</span></span></span></span><span class="kobospan" id="kobo.494.1"> object will render the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.495.1">CounterStatistics</span></span></span></span><span class="kobospan" id="kobo.496.1"> object’s state obsolete and incorrect. </span><span class="kobospan" id="kobo.496.2">If, for example, we added a few hundred more data values, the mean and standard deviation would need to be recomputed. </span><span class="kobospan" id="kobo.496.3">A design</span><span id="dx1-392001"/><span class="kobospan" id="kobo.497.1"> that eagerly computes</span><span id="dx1-392002"/><span class="kobospan" id="kobo.498.1"> values is appropriate when the underlying </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.499.1">Counter</span></span></span></span><span class="kobospan" id="kobo.500.1"> object isn’t going to change. </span><span id="x1-392003r807"/></p>
</section>
<section data-number="0.10.3.4" id="theres-more...-46">
<h2 class="likechapterhead" data-number="0.10.3.4"><span><span class="kobospan" id="kobo.501.1">7.3.4 </span></span> <span id="x1-3930004"/><span class="kobospan" id="kobo.502.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.503.1">If we need to do computations on stateful, mutable objects, we have several choices:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.504.1">Encapsulate the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.505.1">Counter</span></span></span></span><span class="kobospan" id="kobo.506.1"> object and make changes via the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.507.1">CounterStatistics</span></span></span></span><span class="kobospan" id="kobo.508.1"> class. </span><span class="kobospan" id="kobo.508.2">This requires some care to expose enough methods of the data collection. </span><span class="kobospan" id="kobo.508.3">We’ll defer this kind of design until </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.509.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.510.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.511.1">8</span></span></a><span class="kobospan" id="kobo.512.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.513.1">Use lazy computations. </span><span class="kobospan" id="kobo.513.2">See the </span><a href="ch011_split_001.xhtml#x1-43100010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.514.1">Using properties for lazy attributes</span></span></a><span class="kobospan" id="kobo.515.1"> recipe in this chapter.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.516.1">Add a method to implement the computation of mean and standard deviation, so these can be recomputed after changing the underlying </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.517.1">Counter</span></span></span></span><span class="kobospan" id="kobo.518.1"> object. </span><span class="kobospan" id="kobo.518.2">This leads to refactoring the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.519.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.520.1"> method to use this new computation method. </span><span class="kobospan" id="kobo.520.2">We’ll leave this as an exercise for the reader.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.521.1">Write documentation explaining the requirement to create a new </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.522.1">CounterStatistics</span></span></span></span><span class="kobospan" id="kobo.523.1"> instance each time the underlying </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.524.1">Counter</span></span></span></span><span class="kobospan" id="kobo.525.1"> object changes. </span><span class="kobospan" id="kobo.525.2">This involves no code, merely an explicit statement of the constraints on the object’s state.</span></p></li>
</ul>
<p class="normal1"><span id="x1-393001r808"/></p>
</section>
<section data-number="0.10.3.5" id="see-also-53">
<h2 class="likechapterhead" data-number="0.10.3.5"><span><span class="kobospan" id="kobo.526.1">7.3.5 </span></span> <span id="x1-3940005"/><span class="kobospan" id="kobo.527.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.528.1">In the </span><a href="ch011_split_001.xhtml#x1-4250009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.529.1">Extending a built-in collection – a list that does statistics</span></span></a><span class="kobospan" id="kobo.530.1"> recipe, we’ll look at a different design approach where these new summary functions are used to extend a class definition.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.531.1">We’ll look at a different approach in the </span><a href="ch011_split_001.xhtml#x1-43100010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.532.1">Using properties for lazy</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.533.1">attributes</span></span></a><span class="kobospan" id="kobo.534.1"> recipe. </span><span class="kobospan" id="kobo.534.2">This alternative recipe will use properties to compute the attributes as needed.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.535.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.536.1">wrap=extend</span></span></span></span><span class="kobospan" id="kobo.537.1"> design choice is also looked at in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.538.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.539.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.540.1">8</span></span></a><span class="kobospan" id="kobo.541.1">.</span></p></li>
</ul>
<p class="normal1"><span id="x1-394001r794"/></p>
</section>
</section>
<section data-number="0.10.4" id="using-typing.namedtuple-for-immutable-objects">
<h1 class="unnumbered" data-number="0.10.4"><span><span class="kobospan" id="kobo.542.1">7.4 </span></span> <span id="x1-3950004"/><span class="kobospan" id="kobo.543.1">Using typing.NamedTuple for immutable objects</span></h1>
<p class="normal"><span class="kobospan" id="kobo.544.1">In some cases, an object</span><span id="dx1-395001"/><span class="kobospan" id="kobo.545.1"> is a container of rather complex</span><span id="dx1-395002"/><span class="kobospan" id="kobo.546.1"> data, but doesn’t really do very much processing on that data. </span><span class="kobospan" id="kobo.546.2">Indeed, in many cases, we’ll define a class that doesn’t require any unique method functions. </span><span class="kobospan" id="kobo.546.3">These classes are relatively passive containers of data items, without a lot of processing.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.547.1">In many cases, Python’s built-in container classes – </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.548.1">list</span></span></span></span><span class="kobospan" id="kobo.549.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.550.1">set</span></span></span></span><span class="kobospan" id="kobo.551.1">, or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.552.1">dict</span></span></span></span><span class="kobospan" id="kobo.553.1"> – can cover your use cases. </span><span class="kobospan" id="kobo.553.2">The small problem is that the syntax for accessing an item in a dictionary or a list isn’t quite as elegant as the syntax for accessing an attribute of an object.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.554.1">How can we create a class that allows us to use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.555.1">object.attribute</span></span></span></span><span class="kobospan" id="kobo.556.1"> syntax instead of the more elaborate </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.557.1">object[’attribute’]</span></span></span></span><span class="kobospan" id="kobo.558.1">? </span><span id="x1-395003r809"/></p>
<section data-number="0.10.4.1" id="getting-ready-55">
<h2 class="likechapterhead" data-number="0.10.4.1"><span><span class="kobospan" id="kobo.559.1">7.4.1 </span></span> <span id="x1-3960001"/><span class="kobospan" id="kobo.560.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.561.1">There are two cases for any kind of class design:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.562.1">Is it stateless (or immutable)? </span><span class="kobospan" id="kobo.562.2">Does it embody attributes with values that never change? </span><span class="kobospan" id="kobo.562.3">This is a good example of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.563.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.564.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.565.1">Is it stateful (or mutable)? </span><span class="kobospan" id="kobo.565.2">Will there be state changes for one or more attributes? </span><span class="kobospan" id="kobo.565.3">This is the default for Python class definitions. </span><span class="kobospan" id="kobo.565.4">An ordinary class is stateful. </span><span class="kobospan" id="kobo.565.5">We can simplify creating stateful objects using the </span><a href="ch011_split_000.xhtml#x1-4010005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.566.1">Using dataclasses for mutable objects</span></span></a><span class="kobospan" id="kobo.567.1"> recipe.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.568.1">We’ll define a class to describe simple playing cards that have a rank and a suit. </span><span class="kobospan" id="kobo.568.2">Since a card’s rank and suit don’t change, we’ll create a small stateless class for this. </span><span class="kobospan" id="kobo.568.3">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.569.1">typing.NamedTuple</span></span></span></span><span class="kobospan" id="kobo.570.1"> class serves as a handy base class for these kinds of class definitions. </span><span id="x1-396001r811"/></p>
</section>
<section data-number="0.10.4.2" id="how-to-do-it...-55">
<h2 class="likechapterhead" data-number="0.10.4.2"><span><span class="kobospan" id="kobo.571.1">7.4.2 </span></span> <span id="x1-3970002"/><span class="kobospan" id="kobo.572.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-397002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.573.1">We’ll define stateless objects as a subclass of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.574.1">typing.NamedTuple</span></span></span></span><span class="kobospan" id="kobo.575.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.576.1">
from typing import NamedTuple
                                                                     

                                                                     </span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-397006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.577.1">Define the class name as an extension to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.578.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.579.1">. </span><span class="kobospan" id="kobo.579.2">Include the attributes with their individual type hints:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.580.1">
class Card(NamedTuple): 
 
    rank: int 
 
    suit: str</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.581.1">Here’s how we can use this class definition to create </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.582.1">Card</span></span></span></span><span class="kobospan" id="kobo.583.1"> objects:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.584.1">
 
 
&gt;&gt;&gt; eight_hearts = Card(rank=8, suit=’\N{White Heart Suit}’) 
 
&gt;&gt;&gt; eight_hearts 
 
Card(rank=8, suit=’’) 
 
 
 
&gt;&gt;&gt; eight_hearts.rank 
 
8 
 
 
 
&gt;&gt; eight_hearts.suit 
 
’’ 
 
 
 
&gt;&gt;&gt; eight_hearts[0]</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.585.1">We’ve created a new class, named</span><span id="dx1-397023"/> <span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.586.1">Card</span></span></span></span><span class="kobospan" id="kobo.587.1">, which has two attribute</span><span id="dx1-397024"/><span class="kobospan" id="kobo.588.1"> names: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.589.1">rank</span></span></span></span><span class="kobospan" id="kobo.590.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.591.1">suit</span></span></span></span><span class="kobospan" id="kobo.592.1">. </span><span class="kobospan" id="kobo.592.2">After defining the class, we can create an instance of the class. </span><span class="kobospan" id="kobo.592.3">We built a single </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.593.1">Card</span></span></span></span><span class="kobospan" id="kobo.594.1"> object, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.595.1">eight_hearts</span></span></span></span><span class="kobospan" id="kobo.596.1">, with a rank of eight and a suit of </span><span><span class="kobospan" id="kobo.597.1">♡</span></span><span class="kobospan" id="kobo.598.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.599.1">We can refer to attributes of this object with their name or their position within the tuple. </span><span class="kobospan" id="kobo.599.2">When we use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.600.1">eight_hearts.rank</span></span></span></span><span class="kobospan" id="kobo.601.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.602.1">eight_hearts[0]</span></span></span></span><span class="kobospan" id="kobo.603.1">, we’ll see the value of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.604.1">rank</span></span></span></span><span class="kobospan" id="kobo.605.1"> attribute because this attribute is defined first in the sequence of attribute names.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.606.1">This kind of object is immutable. </span><span class="kobospan" id="kobo.606.2">Here’s an example of attempting to change the instance attributes:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.607.1">
 
 
&gt;&gt;&gt; eight_hearts.suit = ’\N{Black Spade Suit}’ 
 
Traceback (most recent call last): 
 
... 
 
AttributeError: can’t set attribute</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.608.1">We attempted to change the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.609.1">suit</span></span></span></span><span class="kobospan" id="kobo.610.1"> attribute of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.611.1">eight_hearts</span></span></span></span><span class="kobospan" id="kobo.612.1"> object. </span><span class="kobospan" id="kobo.612.2">This raised an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.613.1">AttributeError</span></span></span></span><span class="kobospan" id="kobo.614.1"> exception showing that instances of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.615.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.616.1"> are immutable.</span></p>
<div class="tipbox" id="tcolobox-13">
<div class="note">
<p class="normal1"><span class="kobospan" id="kobo.617.1">A tuple can contain objects of any type.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.618.1">When a tuple contains mutable items, like lists, sets, or dictionaries, those objects remain mutable.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.619.1">Only the top-level containing tuple is immutable. </span><span class="kobospan" id="kobo.619.2">Lists, sets, or dictionaries within a tuple are mutable.</span></p>
</div>
</div>
<p class="normal1"><span id="x1-397030r812"/></p>
</section>
<section data-number="0.10.4.3" id="how-it-works...-55">
<h2 class="likechapterhead" data-number="0.10.4.3"><span><span class="kobospan" id="kobo.620.1">7.4.3 </span></span> <span id="x1-3980003"/><span class="kobospan" id="kobo.621.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.622.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.623.1">typing.NamedTuple</span></span></span></span><span class="kobospan" id="kobo.624.1"> class lets us define</span><span id="dx1-398001"/><span class="kobospan" id="kobo.625.1"> a new subclass</span><span id="dx1-398002"/><span class="kobospan" id="kobo.626.1"> that has a well-defined list of attributes. </span><span class="kobospan" id="kobo.626.2">A number of methods are created automatically to provide a minimal level of Python behavior. </span><span class="kobospan" id="kobo.626.3">We can see an instance will display a readable text representation showing the values of the various attributes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.627.1">In the case of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.628.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.629.1"> subclass, the behavior is based on the way a built-in tuple instance works. </span><span class="kobospan" id="kobo.629.2">The order of the attributes defines the comparison between tuples. </span><span class="kobospan" id="kobo.629.3">Our definition of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.630.1">Card</span></span></span></span><span class="kobospan" id="kobo.631.1">, for example, lists the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.632.1">rank</span></span></span></span><span class="kobospan" id="kobo.633.1"> attribute first. </span><span class="kobospan" id="kobo.633.2">This means that we can easily sort cards by rank. </span><span class="kobospan" id="kobo.633.3">For two cards of equal rank, the suits will be sorted into order. </span><span class="kobospan" id="kobo.633.4">Because a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.634.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.635.1"> is also a tuple, it works well as a member of a set or a key for a dictionary.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.636.1">The two attributes, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.637.1">rank</span></span></span></span><span class="kobospan" id="kobo.638.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.639.1">suit</span></span></span></span><span class="kobospan" id="kobo.640.1"> in this example, are named as part of the class definition, but are implemented as instance variables. </span><span class="kobospan" id="kobo.640.2">A variation on the tuple’s </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.641.1">__new__()</span></span></span></span><span class="kobospan" id="kobo.642.1"> method is created for us. </span><span class="kobospan" id="kobo.642.2">This method has two parameters matching the instance variable names. </span><span class="kobospan" id="kobo.642.3">The automatically created method will assign argument values to the instance variables when the object is created. </span><span id="x1-398003r817"/></p>
</section>
<section data-number="0.10.4.4" id="theres-more...-47">
<h2 class="likechapterhead" data-number="0.10.4.4"><span><span class="kobospan" id="kobo.643.1">7.4.4 </span></span> <span id="x1-3990004"/><span class="kobospan" id="kobo.644.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.645.1">We can add methods to this class definition. </span><span class="kobospan" id="kobo.645.2">For example, if each card has a number of points, we might want to extend the class to look like this example:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.646.1">
 
 
class CardPoints(NamedTuple): 
 
    rank: int 
 
    suit: str 
 
 
 
    def points(self) -&gt; int: 
 
        if 1 &lt;= self.rank &lt; 10: 
 
            return self.rank 
 
        else: 
 
            return 10</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.647.1">We’ve written a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.648.1">CardsPoints</span></span></span></span><span class="kobospan" id="kobo.649.1"> class with a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.650.1">points()</span></span></span></span><span class="kobospan" id="kobo.651.1"> method that returns the points assigned to each rank. </span><span class="kobospan" id="kobo.651.2">This point rule applies to games like </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.652.1">Cribbage</span></span><span class="kobospan" id="kobo.653.1">, not to games like </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.654.1">Blackjack</span></span><span class="kobospan" id="kobo.655.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.656.1">Because this is a tuple, the methods cannot add new attributes or change the attributes. </span><span class="kobospan" id="kobo.656.2">In some cases, we build complex tuples from other tuples. </span><span id="x1-399011r818"/></p>
</section>
<section data-number="0.10.4.5" id="see-also-54">
<h2 class="likechapterhead" data-number="0.10.4.5"><span><span class="kobospan" id="kobo.657.1">7.4.5 </span></span> <span id="x1-4000005"/><span class="kobospan" id="kobo.658.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.659.1">In the </span><a href="ch011_split_000.xhtml#x1-3890003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.660.1">Designing classes with lots of processing</span></span></a><span class="kobospan" id="kobo.661.1"> recipe, we looked at a class that is entirely processing and almost no data. </span><span class="kobospan" id="kobo.661.2">It acts as the polar opposite of this class.</span></p></li>
</ul>
<p class="normal1"><span id="x1-400001r810"/></p>
</section>
</section>
<section data-number="0.10.5" id="using-dataclasses-for-mutable-objects">
<h1 class="unnumbered" data-number="0.10.5"><span><span class="kobospan" id="kobo.662.1">7.5 </span></span> <span id="x1-4010005"/><span class="kobospan" id="kobo.663.1">Using dataclasses for mutable objects</span></h1>
<p class="normal"><span class="kobospan" id="kobo.664.1">We’ve noted two general</span><span id="dx1-401001"/><span class="kobospan" id="kobo.665.1"> kinds of objects</span><span id="dx1-401002"/><span class="kobospan" id="kobo.666.1"> in Python:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.667.1">Immutable</span></span><span class="kobospan" id="kobo.668.1">: During design, we’ll ask if something</span><span id="dx1-401003"/><span class="kobospan" id="kobo.669.1"> has attributes with values that never change. </span><span class="kobospan" id="kobo.669.2">If the answer is yes, see the </span><a href="ch011_split_000.xhtml#x1-3950004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.670.1">Using</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.671.1">typing.NamedTuple for immutable objects</span></span></a><span class="kobospan" id="kobo.672.1"> recipe, which offers a way to build class definitions for immutable objects.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.673.1">Mutable</span></span><span class="kobospan" id="kobo.674.1">: Will there be state changes</span><span id="dx1-401004"/><span class="kobospan" id="kobo.675.1"> for one or more attributes? </span><span class="kobospan" id="kobo.675.2">In this case, we can either build a class from the ground up, or we can leverage the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.676.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.677.1"> decorator to create a class definition from a few attributes and type hints. </span><span class="kobospan" id="kobo.677.2">This case is the focus of this recipe.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.678.1">How can we leverage the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.679.1">dataclasses</span></span></span></span><span class="kobospan" id="kobo.680.1"> library to help design mutable objects? </span><span id="x1-401005r820"/></p>
<section data-number="0.10.5.1" id="getting-ready-56">
<h2 class="likechapterhead" data-number="0.10.5.1"><span><span class="kobospan" id="kobo.681.1">7.5.1 </span></span> <span id="x1-4020001"/><span class="kobospan" id="kobo.682.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.683.1">We’ll look closely at a mutable</span><span id="dx1-402001"/><span class="kobospan" id="kobo.684.1"> object with an internal</span><span id="dx1-402002"/><span class="kobospan" id="kobo.685.1"> state to represent a hand of cards. </span><span class="kobospan" id="kobo.685.2">While individual cards are immutable, they can be inserted into a hand and removed from a hand. </span><span class="kobospan" id="kobo.685.3">In a game like Cribbage, the hand has a number of state changes. </span><span class="kobospan" id="kobo.685.4">Initially, six cards are dealt to both players. </span><span class="kobospan" id="kobo.685.5">The players will each lay away a pair of cards to create the crib. </span><span class="kobospan" id="kobo.685.6">The remaining four cards are then played alternately to create scoring opportunities. </span><span class="kobospan" id="kobo.685.7">The hands are then counted in isolation, with a slightly different mix of scoring opportunities. </span><span class="kobospan" id="kobo.685.8">The dealer gets the score from counting the cards in the crib as an extra hand. </span><span class="kobospan" id="kobo.685.9">(Yes, it’s unfair initially, but the deal alternates, so it’s eventually fair.)</span></p>
<p class="normal1"><span class="kobospan" id="kobo.686.1">We’ll look at a simple collection to hold the cards and discard two that form the crib. </span><span id="x1-402003r822"/></p>
</section>
<section data-number="0.10.5.2" id="how-to-do-it...-56">
<h2 class="likechapterhead" data-number="0.10.5.2"><span><span class="kobospan" id="kobo.687.1">7.5.2 </span></span> <span id="x1-4030002"/><span class="kobospan" id="kobo.688.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-403002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.689.1">To define data classes, we’ll import the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.690.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.691.1"> decorator:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.692.1">
from dataclasses import dataclass</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-403006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.693.1">Define the new class using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.694.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.695.1"> decorator:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.696.1">
@dataclass 
 
class CribbageHand:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-403011x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.697.1">Define the various attributes with appropriate type hints. </span><span class="kobospan" id="kobo.697.2">For this example, we’ll expect a player to have a collection of cards represented by </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.698.1">list[CardPoints]</span></span></span></span><span class="kobospan" id="kobo.699.1">. </span><span class="kobospan" id="kobo.699.2">Because each card is unique, we could also use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.700.1">set[CardPoints]</span></span></span></span><span class="kobospan" id="kobo.701.1"> type hint:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.702.1">
    cards: list[CardPoints]</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-403015x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.703.1">Define any methods that change the state of the object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.704.1">
 
 
    def to_crib(self, card1: CardPoints, card2: CardPoints) -&gt; None: 
 
        self.cards.remove(card1)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.705.1">Here’s the complete class definition, properly indented:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.706.1">
 
 
 
 
@dataclass 
 
class CribbageHand: 
 
    cards: list[CardPoints] 
 
 
 
    def to_crib(self, card1: CardPoints, card2: CardPoints) -&gt; None: 
 
        self.cards.remove(card1) 
 
        self.cards.remove(card2)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.707.1">This definition provides</span><span id="dx1-403029"/><span class="kobospan" id="kobo.708.1"> a single instance</span><span id="dx1-403030"/><span class="kobospan" id="kobo.709.1"> variable, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.710.1">self.cards</span></span></span></span><span class="kobospan" id="kobo.711.1">, that can be used by any method that is written. </span><span class="kobospan" id="kobo.711.2">Because we provided a type hint, the mypy program can check the class to be sure that it is being used properly.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.712.1">Here’s how it looks when we create an instance of this </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.713.1">CribbageHand</span></span></span></span><span class="kobospan" id="kobo.714.1"> class:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.715.1">
 
 
&gt;&gt;&gt; cards = [ 
 
... </span><span class="kobospan" id="kobo.715.2">CardPoints(rank=3, suit=’\N{WHITE DIAMOND SUIT}’), 
 
... </span><span class="kobospan" id="kobo.715.3">CardPoints(rank=6, suit=’\N{BLACK SPADE SUIT}’), 
 
... </span><span class="kobospan" id="kobo.715.4">CardPoints(rank=7, suit=’\N{WHITE DIAMOND SUIT}’), 
 
... </span><span class="kobospan" id="kobo.715.5">CardPoints(rank=1, suit=’\N{BLACK SPADE SUIT}’), 
 
... </span><span class="kobospan" id="kobo.715.6">CardPoints(rank=6, suit=’\N{WHITE DIAMOND SUIT}’), 
 
... </span><span class="kobospan" id="kobo.715.7">CardPoints(rank=10, suit=’\N{WHITE HEART SUIT}’)] 
 
&gt;&gt;&gt; ch1 = CribbageHand(cards) 
 
 
 
&gt;&gt;&gt; from pprint import pprint 
 
&gt;&gt;&gt; pprint(ch1) 
 
CribbageHand(cards=[CardPoints(rank=3, suit=’’), 
 
                    CardPoints(rank=6, suit=’’), 
 
                    CardPoints(rank=7, suit=’’), 
 
                    CardPoints(rank=1, suit=’’), 
 
                    CardPoints(rank=6, suit=’’), 
 
                    CardPoints(rank=10, suit=’’)]) 
 
 
 
&gt;&gt;&gt; [c.points() for c in ch1.cards] 
 
[3, 6, 7, 1, 6, 10]
                                                                     

                                                                     </span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.716.1">In the following example, the player decided (perhaps unwisely) to lay away the 3</span><span><span class="kobospan" id="kobo.717.1">♢ </span></span><span class="kobospan" id="kobo.718.1">and A</span><span><span class="kobospan" id="kobo.719.1">♠ </span></span><span class="kobospan" id="kobo.720.1">cards for the crib:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.721.1">
 
 
&gt;&gt;&gt; ch1.to_crib( 
 
... </span><span class="kobospan" id="kobo.721.2">    CardPoints(rank=3, suit=’\N{WHITE DIAMOND SUIT}’), 
 
... </span><span class="kobospan" id="kobo.721.3">    CardPoints(rank=1, suit=’\N{BLACK SPADE SUIT}’)) 
 
 
 
&gt;&gt;&gt; pprint(ch1) 
 
CribbageHand(cards=[CardPoints(rank=6, suit=’’), 
 
                    CardPoints(rank=7, suit=’’), 
 
                    CardPoints(rank=6, suit=’’), 
 
                    CardPoints(rank=10, suit=’’)]) 
 
 
 
&gt;&gt;&gt; [c.points() for c in ch1.cards] 
 
[6, 7, 6, 10]</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.722.1">After the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.723.1">to_crib()</span></span></span></span><span class="kobospan" id="kobo.724.1"> method removed</span><span id="dx1-403065"/><span class="kobospan" id="kobo.725.1"> two cards</span><span id="dx1-403066"/><span class="kobospan" id="kobo.726.1"> from the hand, the remaining four cards were displayed. </span><span class="kobospan" id="kobo.726.2">Another list comprehension was created with the point values of the remaining four cards. </span><span id="x1-403067r823"/></p>
</section>
<section data-number="0.10.5.3" id="how-it-works...-56">
<h2 class="likechapterhead" data-number="0.10.5.3"><span><span class="kobospan" id="kobo.727.1">7.5.3 </span></span> <span id="x1-4040003"/><span class="kobospan" id="kobo.728.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.729.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.730.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.731.1"> decorator helps us define a class with several useful methods as well as a list of attributes drawn from the named variables and their type hints. </span><span class="kobospan" id="kobo.731.2">We can see that an instance displays a readable text representation showing the values of the various attributes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.732.1">The attributes are named as part of the class definition, but are actually implemented as instance variables. </span><span class="kobospan" id="kobo.732.2">In this example, there’s only one attribute, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.733.1">cards</span></span></span></span><span class="kobospan" id="kobo.734.1">. </span><span class="kobospan" id="kobo.734.2">A very sophisticated </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.735.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.736.1"> method is created for us. </span><span class="kobospan" id="kobo.736.2">In this example, it will have a parameter that matches the name of each instance variable and will assign the argument value to a matching instance variable.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.737.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.738.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.739.1"> decorator has a number of options to help us choose what features we want in the class. </span><span class="kobospan" id="kobo.739.2">Here are the options we can select from and the default settings:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.740.1">init=True</span></span></span></span><span class="kobospan" id="kobo.741.1">: By default, an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.742.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.743.1"> method will be created with parameters to match the instance variables.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.744.1">repr=True</span></span></span></span><span class="kobospan" id="kobo.745.1">: By default, a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.746.1">__repr__()</span></span></span></span><span class="kobospan" id="kobo.747.1"> method will be created to return a string showing the state of the object.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.748.1">eq=True</span></span></span></span><span class="kobospan" id="kobo.749.1">: By default, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.750.1">__eq__()</span></span></span></span><span class="kobospan" id="kobo.751.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.752.1">__ne__()</span></span></span></span><span class="kobospan" id="kobo.753.1"> methods are provided. </span><span class="kobospan" id="kobo.753.2">These methods implement the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.754.1">==</span></span></span></span><span class="kobospan" id="kobo.755.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.756.1">!=</span></span></span></span><span class="kobospan" id="kobo.757.1"> operators.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.758.1">order=False</span></span></span></span><span class="kobospan" id="kobo.759.1">: The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.760.1">__lt__()</span></span></span></span><span class="kobospan" id="kobo.761.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.762.1">__le__()</span></span></span></span><span class="kobospan" id="kobo.763.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.764.1">__gt__()</span></span></span></span><span class="kobospan" id="kobo.765.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.766.1">__ge__()</span></span></span></span><span class="kobospan" id="kobo.767.1"> methods are not created automatically. </span><span class="kobospan" id="kobo.767.2">These methods implement the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.768.1">&lt;</span></span></span></span><span class="kobospan" id="kobo.769.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.770.1">&lt;=</span></span></span></span><span class="kobospan" id="kobo.771.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.772.1">&gt;</span></span></span></span><span class="kobospan" id="kobo.773.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.774.1">&gt;=</span></span></span></span><span class="kobospan" id="kobo.775.1"> operators.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.776.1">unsafe_hash=False</span></span></span></span><span class="kobospan" id="kobo.777.1">: Normally, mutable objects do not have hash values, and cannot be used as keys for dictionaries or elements of a set. </span><span class="kobospan" id="kobo.777.2">It’s possible to have a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.778.1">__hash__()</span></span></span></span><span class="kobospan" id="kobo.779.1"> method added automatically, but this is rarely a sensible choice for mutable objects, which is why</span><span id="dx1-404001"/><span class="kobospan" id="kobo.780.1"> the option is called an ”unsafe” hash.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.781.1">frozen=False</span></span></span></span><span class="kobospan" id="kobo.782.1">: This creates an immutable object. </span><span class="kobospan" id="kobo.782.2">See the </span><a href="ch011_split_000.xhtml#x1-4070006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.783.1">Using frozen</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.784.1">dataclasses for immutable objects</span></span></a><span class="kobospan" id="kobo.785.1"> recipe in this chapter for more details.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.786.1">Because a great deal of code</span><span id="dx1-404002"/><span class="kobospan" id="kobo.787.1"> is written for us, we can focus</span><span id="dx1-404003"/><span class="kobospan" id="kobo.788.1"> on the attributes of the class definition. </span><span class="kobospan" id="kobo.788.2">We can write the methods that are truly distinctive and avoid writing ”boilerplate” methods that have obvious definitions. </span><span id="x1-404004r831"/></p>
</section>
<section data-number="0.10.5.4" id="theres-more...-48">
<h2 class="likechapterhead" data-number="0.10.5.4"><span><span class="kobospan" id="kobo.789.1">7.5.4 </span></span> <span id="x1-4050004"/><span class="kobospan" id="kobo.790.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.791.1">A hand of cards requires an initialization method to provide the collection</span><span id="dx1-405001"/><span class="kobospan" id="kobo.792.1"> of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.793.1">Card</span></span></span></span><span class="kobospan" id="kobo.794.1"> objects. </span><span class="kobospan" id="kobo.794.2">A default </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.795.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.796.1"> method can populate the collection.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.797.1">Consider creating a deck of cards, in contrast to a hand of cards. </span><span class="kobospan" id="kobo.797.2">The initial deck of cards is an example of a dataclass that doesn’t need an initialization method to set the instance variables. </span><span class="kobospan" id="kobo.797.3">Instead, a deck of cards needs a customized </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.798.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.799.1"> method without any parameters; it always creates the same collection of 52 </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.800.1">Card</span></span></span></span><span class="kobospan" id="kobo.801.1"> objects. </span><span class="kobospan" id="kobo.801.2">This means we’ll use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.802.1">init=False</span></span></span></span><span class="kobospan" id="kobo.803.1"> in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.804.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.805.1"> decorator to define this method for a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.806.1">Deck</span></span></span></span><span class="kobospan" id="kobo.807.1"> class definition.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.808.1">The general pattern for </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.809.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.810.1"> definitions is to provide class-level names, which are used to both define the instance variables and also create the initialization method, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.811.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.812.1">. </span><span class="kobospan" id="kobo.812.2">This covers a common use case for stateful objects.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.813.1">In some cases, however, we want to define a class-level variable that is </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.814.1">not </span></span><span class="kobospan" id="kobo.815.1">used to create instance variables, but will remain a class-level variable. </span><span class="kobospan" id="kobo.815.2">This is done with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.816.1">ClassVar</span></span></span></span><span class="kobospan" id="kobo.817.1"> type hint. </span><span class="kobospan" id="kobo.817.2">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.818.1">ClassVar</span></span></span></span><span class="kobospan" id="kobo.819.1"> type indicates a class-level variable that is not part</span><span id="dx1-405002"/><span class="kobospan" id="kobo.820.1"> of the instance variables or the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.821.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.822.1"> method.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.823.1">In the following example, we’ll create a class variable with a sequence of suit strings:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.824.1">
 
 
 
 
import random 
 
 
 
from typing import ClassVar 
 
 
 
@dataclass(init=False) 
 
class Deck: 
 
    SUITS: ClassVar[tuple[str, ...]] = ( 
 
    ’\N{Black Club Suit}’, 
 
    ’\N{White Diamond Suit}’, 
 
    ’\N{White Heart Suit}’, 
 
    ’\N{Black Spade Suit}’ 
 
    ) 
 
 
 
    cards: list[CardPoints] 
 
 
 
    def __init__(self) -&gt; None: 
 
        self.cards = [ 
 
            CardPoints(rank=r, suit=s) 
 
            for r in range(1, 14)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.825.1">This example class definition provides a class-level variable, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.826.1">SUITS</span></span></span></span><span class="kobospan" id="kobo.827.1">, which is part of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.828.1">Deck</span></span></span></span><span class="kobospan" id="kobo.829.1"> class. </span><span class="kobospan" id="kobo.829.2">This variable is a tuple of the characters used to define the suits.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.830.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.831.1">cards</span></span></span></span><span class="kobospan" id="kobo.832.1"> variable has a hint claiming it will have the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.833.1">list[CardPoints]</span></span></span></span><span class="kobospan" id="kobo.834.1"> type. </span><span class="kobospan" id="kobo.834.2">This information is used by the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.835.1">mypy </span></span><span class="kobospan" id="kobo.836.1">program to confirm that the body of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.837.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.838.1"> method performs the proper initialization of this attribute. </span><span class="kobospan" id="kobo.838.2">It also confirms that this attribute is used appropriately by other classes. </span><span id="x1-405024r832"/></p>
</section>
<section data-number="0.10.5.5" id="see-also-55">
<h2 class="likechapterhead" data-number="0.10.5.5"><span><span class="kobospan" id="kobo.839.1">7.5.5 </span></span> <span id="x1-4060005"/><span class="kobospan" id="kobo.840.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.841.1">See the </span><a href="ch011_split_000.xhtml#x1-3950004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.842.1">Using typing.NamedTuple for immutable objects</span></span></a><span class="kobospan" id="kobo.843.1"> recipe for a way to build class definitions for stateless objects.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.844.1">The </span><a href="ch011_split_000.xhtml#x1-3770001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.845.1">Using a class to encapsulate data and processing</span></span></a><span class="kobospan" id="kobo.846.1"> recipe covers techniques for building a class without the additional methods created by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.847.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.848.1"> decorator.</span></p></li>
</ul>
<p class="normal1"><span id="x1-406001r821"/></p>
</section>
</section>
<section data-number="0.10.6" id="using-frozen-dataclasses-for-immutable-objects">
<h1 class="unnumbered" data-number="0.10.6"><span><span class="kobospan" id="kobo.849.1">7.6 </span></span> <span id="x1-4070006"/><span class="kobospan" id="kobo.850.1">Using frozen dataclasses for immutable objects</span></h1>
<p class="normal"><span class="kobospan" id="kobo.851.1">In the </span><a href="ch011_split_000.xhtml#x1-3950004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.852.1">Using typing.NamedTuple for immutable objects</span></span></a><span class="kobospan" id="kobo.853.1"> recipe, we saw</span><span id="dx1-407001"/><span class="kobospan" id="kobo.854.1"> how to define</span><span id="dx1-407002"/><span class="kobospan" id="kobo.855.1"> a class that has a fixed set of attributes. </span><span class="kobospan" id="kobo.855.2">The attributes can be checked by the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.856.1">mypy </span></span><span class="kobospan" id="kobo.857.1">program to ensure that they’re being used properly. </span><span class="kobospan" id="kobo.857.2">In some cases, we might want to make use of the slightly more flexible dataclass to create an immutable object.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.858.1">One potential reason for using a dataclass is because it can have more complex field definitions than a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.859.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.860.1"> subclass. </span><span class="kobospan" id="kobo.860.2">Another potential reason is the ability to customize the initialization and the hashing function that is created. </span><span class="kobospan" id="kobo.860.3">Because a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.861.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.862.1"> is essentially a tuple, there’s limited ability to fine-tune the behavior of the instances in this class. </span><span id="x1-407003r834"/></p>
<section data-number="0.10.6.1" id="getting-ready-57">
<h2 class="likechapterhead" data-number="0.10.6.1"><span><span class="kobospan" id="kobo.863.1">7.6.1 </span></span> <span id="x1-4080001"/><span class="kobospan" id="kobo.864.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.865.1">We’ll revisit the idea of defining simple playing cards with rank and suit. </span><span class="kobospan" id="kobo.865.2">The rank can be modeled by an integer between 1 (ace) and 13 (king.) The suit can be modeled by a single Unicode character from the set </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.866.1">{’</span></span><span><span class="kobospan" id="kobo.867.1">♠</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.868.1">’,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.869.1"> ’</span></span><span><span class="kobospan" id="kobo.870.1">♡</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.871.1">’,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.872.1"> ’</span></span><span><span class="kobospan" id="kobo.873.1">♢</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.874.1">’,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.875.1"> ’</span></span><span><span class="kobospan" id="kobo.876.1">♣</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.877.1">’}</span></span></span></span><span class="kobospan" id="kobo.878.1">. </span><span class="kobospan" id="kobo.878.2">Since a card’s rank and suit don’t change, we’ll create a small, frozen dataclass for this. </span><span id="x1-408001r836"/></p>
</section>
<section data-number="0.10.6.2" id="how-to-do-it...-57">
<h2 class="likechapterhead" data-number="0.10.6.2"><span><span class="kobospan" id="kobo.879.1">7.6.2 </span></span> <span id="x1-4090002"/><span class="kobospan" id="kobo.880.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-409002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.881.1">From the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.882.1">dataclasses</span></span></span></span><span class="kobospan" id="kobo.883.1"> module, import the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.884.1">dataclass</span></span></span></span><span class="kobospan" id="kobo.885.1"> decorator:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.886.1">
from dataclasses import dataclass</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-409006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.887.1">Start the class definition with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.888.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.889.1"> decorator, using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.890.1">frozen=True</span></span></span></span><span class="kobospan" id="kobo.891.1"> option to ensure that the objects are immutable. </span><span class="kobospan" id="kobo.891.2">We’ve also included </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.892.1">order=True</span></span></span></span><span class="kobospan" id="kobo.893.1"> so that the comparison operators are defined, allowing instances of this class to be sorted into order:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.894.1">
@dataclass(frozen=True, order=True) 
 
class Card:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-409011x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.895.1">Provide the attribute names</span><span id="dx1-409012"/><span class="kobospan" id="kobo.896.1"> and type hints</span><span id="dx1-409013"/><span class="kobospan" id="kobo.897.1"> for the attributes of each instance of this class:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.898.1">
                                                                     

                                                                     
    rank: int 
 
    suit: str</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.899.1">We can use these objects in code as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.900.1">
 
 
&gt;&gt;&gt; eight_hearts = Card(rank=8, suit=’\N{White Heart Suit}’) 
 
 
 
&gt;&gt;&gt; eight_hearts 
 
Card(rank=8, suit=’’) 
 
 
 
&gt;&gt;&gt; eight_hearts.rank 
 
8 
 
 
 
&gt;&gt;&gt; eight_hearts.suit 
 
’’</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.901.1">We’ve created an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.902.1">Card</span></span></span></span><span class="kobospan" id="kobo.903.1"> class with a specific value for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.904.1">rank</span></span></span></span><span class="kobospan" id="kobo.905.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.906.1">suit</span></span></span></span><span class="kobospan" id="kobo.907.1"> attributes. </span><span class="kobospan" id="kobo.907.2">Because the object is immutable, any attempt to change the state will result in an exception that looks like the following example:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.908.1">
 
 
&gt;&gt;&gt; eight_hearts.suit = ’\N{Black Spade Suit}’ 
 
Traceback (most recent call last): 
 
... 
 
dataclasses.FrozenInstanceError: cannot assign to field ’suit’</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.909.1">This shows an attempt to change an attribute of a frozen dataclass instance. </span><span class="kobospan" id="kobo.909.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.910.1">dataclasses.FrozenInstanceError</span></span></span></span><span class="kobospan" id="kobo.911.1"> exception is raised to signal that this kind of operation is not permitted. </span><span id="x1-409033r837"/></p>
</section>
<section data-number="0.10.6.3" id="how-it-works...-57">
<h2 class="likechapterhead" data-number="0.10.6.3"><span><span class="kobospan" id="kobo.912.1">7.6.3 </span></span> <span id="x1-4100003"/><span class="kobospan" id="kobo.913.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.914.1">This </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.915.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.916.1"> decorator</span><span id="dx1-410001"/><span class="kobospan" id="kobo.917.1"> adds a number</span><span id="dx1-410002"/><span class="kobospan" id="kobo.918.1"> of built-in methods to a class definition. </span><span class="kobospan" id="kobo.918.2">As we noted in the </span><a href="ch011_split_000.xhtml#x1-4010005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.919.1">Using dataclasses for mutable objects</span></span></a><span class="kobospan" id="kobo.920.1"> recipe, there are a number of features that can be enabled or disabled. </span><span class="kobospan" id="kobo.920.2">Each feature may lead us to include one or several individual methods in the class definition. </span><span id="x1-410003r843"/></p>
</section>
<section data-number="0.10.6.4" id="theres-more...-49">
<h2 class="likechapterhead" data-number="0.10.6.4"><span><span class="kobospan" id="kobo.921.1">7.6.4 </span></span> <span id="x1-4110004"/><span class="kobospan" id="kobo.922.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.923.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.924.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.925.1"> initialization method is quite sophisticated. </span><span class="kobospan" id="kobo.925.2">We’ll look at one feature that’s sometimes handy for defining optional attributes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.926.1">Consider a class that can hold a hand of cards. </span><span class="kobospan" id="kobo.926.2">While the common use case provides a set of cards to initialize the hand, we can also have hands that might be built incrementally, starting with an empty collection and adding cards during the game.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.927.1">We can define this kind of optional attribute using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.928.1">field()</span></span></span></span><span class="kobospan" id="kobo.929.1"> function from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.930.1">dataclasses</span></span></span></span><span class="kobospan" id="kobo.931.1"> module. </span><span class="kobospan" id="kobo.931.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.932.1">field()</span></span></span></span><span class="kobospan" id="kobo.933.1"> function lets us provide</span><span id="dx1-411001"/><span class="kobospan" id="kobo.934.1"> a function to build default values, called </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.935.1">default_factory</span></span></span></span><span class="kobospan" id="kobo.936.1">. </span><span class="kobospan" id="kobo.936.2">We’d use it as shown in the following example:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.937.1">
 
 
from dataclasses import dataclass, field 
 
 
 
@dataclass(frozen=True, order=True) 
 
class Hand: 
 
    cards: list[CardPoints] = field(default_factory=list)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.938.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.939.1">Hand</span></span></span></span><span class="kobospan" id="kobo.940.1"> dataclass has a single attribute, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.941.1">cards</span></span></span></span><span class="kobospan" id="kobo.942.1">, which is a list of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.943.1">CardPoints</span></span></span></span><span class="kobospan" id="kobo.944.1"> objects. </span><span class="kobospan" id="kobo.944.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.945.1">field()</span></span></span></span><span class="kobospan" id="kobo.946.1"> function provides a default factory: in the event no initial value is provided, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.947.1">list()</span></span></span></span><span class="kobospan" id="kobo.948.1"> function will be executed to create a new, empty list.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.949.1">We can create two kinds of hands with this dataclass. </span><span class="kobospan" id="kobo.949.2">Here’s the conventional example, where we deal six cards:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.950.1">
 
 
&gt;&gt;&gt; cards = [ 
 
... </span><span class="kobospan" id="kobo.950.2">CardPoints(rank=3, suit=’\N{WHITE DIAMOND SUIT}’), 
 
... </span><span class="kobospan" id="kobo.950.3">CardPoints(rank=6, suit=’\N{BLACK SPADE SUIT}’), 
 
... </span><span class="kobospan" id="kobo.950.4">CardPoints(rank=7, suit=’\N{WHITE DIAMOND SUIT}’), 
 
... </span><span class="kobospan" id="kobo.950.5">CardPoints(rank=1, suit=’\N{BLACK SPADE SUIT}’), 
 
... </span><span class="kobospan" id="kobo.950.6">CardPoints(rank=6, suit=’\N{WHITE DIAMOND SUIT}’), 
 
... </span><span class="kobospan" id="kobo.950.7">CardPoints(rank=10, suit=’\N{WHITE HEART SUIT}’)] 
 
&gt;&gt;&gt; 
 
&gt;&gt;&gt; h = Hand(cards)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.951.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.952.1">Hands()</span></span></span></span><span class="kobospan" id="kobo.953.1"> type expects a single attribute, matching the definition of the attributes in the class. </span><span class="kobospan" id="kobo.953.2">This is optional, and we can build an empty hand as shown in this example:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.954.1">
 
 
&gt;&gt;&gt; crib = Hand() 
 
&gt;&gt;&gt; d3 = CardPoints(rank=3, suit=’\N{WHITE DIAMOND SUIT}’) 
 
&gt;&gt;&gt; h.cards.remove(d3) 
 
&gt;&gt;&gt; crib.cards.append(d3) 
 
 
 
&gt;&gt;&gt; from pprint import pprint 
 
&gt;&gt;&gt; pprint(crib) 
 
Hand(cards=[CardPoints(rank=3, suit=’’)])</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.955.1">In this example, we’ve created a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.956.1">Hand()</span></span></span></span><span class="kobospan" id="kobo.957.1"> instance with no argument values, assigned to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.958.1">crib</span></span></span></span><span class="kobospan" id="kobo.959.1"> variable. </span><span class="kobospan" id="kobo.959.2">Because the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.960.1">cards</span></span></span></span><span class="kobospan" id="kobo.961.1"> attribute was defined with a field that provided a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.962.1">default_factory</span></span></span></span><span class="kobospan" id="kobo.963.1">, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.964.1">list()</span></span></span></span><span class="kobospan" id="kobo.965.1"> function will be used to create an empty list for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.966.1">cards</span></span></span></span><span class="kobospan" id="kobo.967.1"> attribute. </span><span id="x1-411027r844"/></p>
</section>
<section data-number="0.10.6.5" id="see-also-56">
<h2 class="likechapterhead" data-number="0.10.6.5"><span><span class="kobospan" id="kobo.968.1">7.6.5 </span></span> <span id="x1-4120005"/><span class="kobospan" id="kobo.969.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.970.1">The </span><a href="ch011_split_000.xhtml#x1-4010005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.971.1">Using dataclasses for mutable objects</span></span></a><span class="kobospan" id="kobo.972.1"> recipe covers some additional topics on using dataclasses to avoid some of the complexities of writing class definitions.</span></p></li>
</ul>
<p class="normal1"><span id="x1-412001r835"/></p>
</section>
</section>
</section>


<section data-number="0.10" id="chapter-7-basics-of-classes-and-objects">
<section data-number="0.10.7" id="optimizing-small-objects-with-__slots__">
<h1 class="unnumbered" data-number="0.10.7"><span><span class="kobospan" id="kobo.973.1">7.7 </span></span> <span id="x1-4130007"/><span class="kobospan" id="kobo.974.1">Optimizing small objects with __slots__</span></h1>
<p class="normal"><span class="kobospan" id="kobo.975.1">The general case for an object allows</span><span id="dx1-413001"/><span class="kobospan" id="kobo.976.1"> a dynamic collection</span><span id="dx1-413002"/><span class="kobospan" id="kobo.977.1"> of attributes. </span><span class="kobospan" id="kobo.977.2">There’s a special case for an object with a fixed collection of attributes based on the tuple class. </span><span class="kobospan" id="kobo.977.3">We looked at both of these in the </span><a href="ch011_split_000.xhtml#x1-3950004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.978.1">Using typing.NamedTuple for</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.979.1">immutable objects</span></span></a><span class="kobospan" id="kobo.980.1"> recipe.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.981.1">There’s a middle ground. </span><span class="kobospan" id="kobo.981.2">We can also define an object with a fixed number of attributes, but the values of the attributes can be changed. </span><span class="kobospan" id="kobo.981.3">By changing the class from an unlimited collection of attributes to a fixed set of attributes, it turns out that we can also save memory and processing time.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.982.1">How can we create optimized classes with a fixed set of attributes? </span><span id="x1-413003r848"/></p>
<section data-number="0.10.7.1" id="getting-ready-58">
<h2 class="likechapterhead" data-number="0.10.7.1"><span><span class="kobospan" id="kobo.983.1">7.7.1 </span></span> <span id="x1-4140001"/><span class="kobospan" id="kobo.984.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.985.1">Generally, Python allows</span><span id="dx1-414001"/><span class="kobospan" id="kobo.986.1"> adding attributes</span><span id="dx1-414002"/><span class="kobospan" id="kobo.987.1"> to an object. </span><span class="kobospan" id="kobo.987.2">This can be undesirable, particularly when working with a large number of objects. </span><span class="kobospan" id="kobo.987.3">The flexibility of the way most class definitions use a dictionary has a cost in memory use. </span><span class="kobospan" id="kobo.987.4">Using specific </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.988.1">__slots__</span></span></span></span><span class="kobospan" id="kobo.989.1"> names limits the class to the named attributes, saving memory.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.990.1">The card game of Cribbage, for example, has a few components:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.991.1">A deck of cards.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.992.1">Two players, who will alternate in the role of dealer and opponent.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.993.1">This small domain of things seems like a candidate for a class definition. </span><span class="kobospan" id="kobo.993.2">Each player has a hand of cards and a score. </span><span class="kobospan" id="kobo.993.3">The player’s role is an interesting complication. </span><span class="kobospan" id="kobo.993.4">There are import differences in the two roles.</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.994.1">The player who is the dealer gets the crib cards.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.995.1">If the starter card is a Jack, the player in the dealer role gets points for this.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.996.1">The opponent plays the first card.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.997.1">The opponent counts their hand first.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.998.1">The dealer plays from their hand, but counts their hand and the crib.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.999.1">The specific order of play and counting hands is important because the first player to pass 120 points is the winner, no matter what state the game is in.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1000.1">It seems like the Cribbage game includes a deck of cards and two players. </span><span class="kobospan" id="kobo.1000.2">The crib – which belongs to the dealer – can be seen as a feature of the game overall. </span><span class="kobospan" id="kobo.1000.3">We’ll look at ways to switch the role between dealer and opponent when a new round of play starts. </span><span id="x1-414003r850"/></p>
</section>
<section data-number="0.10.7.2" id="how-to-do-it...-58">
<h2 class="likechapterhead" data-number="0.10.7.2"><span><span class="kobospan" id="kobo.1001.1">7.7.2 </span></span> <span id="x1-4150002"/><span class="kobospan" id="kobo.1002.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1003.1">We’ll leverage the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1004.1">__slots__</span></span></span></span><span class="kobospan" id="kobo.1005.1"> special name when creating the class:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-415002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1006.1">Define the class with a descriptive name:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1007.1">
class Cribbage:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-415006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1008.1">Define the list of attribute</span><span id="dx1-415007"/><span class="kobospan" id="kobo.1009.1"> names. </span><span class="kobospan" id="kobo.1009.2">This identifies</span><span id="dx1-415008"/><span class="kobospan" id="kobo.1010.1"> the only two attributes that are allowed for instances of this class. </span><span class="kobospan" id="kobo.1010.2">Any attempt to add another attribute will raise an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1011.1">AttributeError</span></span></span></span><span class="kobospan" id="kobo.1012.1"> exception:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1013.1">
    __slots__ = (’deck’, ’players’, ’crib’, ’dealer’, ’opponent’)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-415012x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1014.1">Add an initialization method. </span><span class="kobospan" id="kobo.1014.2">This must create instance variables for the named slots:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1015.1">
    def __init__( 
 
            self, 
 
            deck: Deck, 
 
            player1: Player, 
 
            player2: Player 
 
    ) -&gt; None: 
 
        self.deck = deck 
 
        self.players = [player1, player2] 
 
        random.shuffle(self.players) 
 
        self.dealer, self.opponent = self.players 
 
        self.crib = Hand()</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1016.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1017.1">Deck</span></span></span></span><span class="kobospan" id="kobo.1018.1"> class definition is shown in the </span><a href="ch011_split_000.xhtml#x1-4010005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1019.1">Using dataclasses for mutable</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1020.1">objects</span></span></a><span class="kobospan" id="kobo.1021.1"> recipe in this chapter.</span></p>
</div></li>
<li class="calibre7"><div id="x1-415026x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1022.1">Add methods to update the collection. </span><span class="kobospan" id="kobo.1022.2">For this example, we’ve defined a method to switch roles.</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1023.1">
    def new_deal(self) -&gt; None: 
 
        self.deck.shuffle() 
 
        self.players = list(reversed(self.players)) 
 
        self.dealer, self.opponent = self.players 
 
        self.crib = Hand()                                                                

                                                                     
     </span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1024.1">Here’s how we can use this class to build a hand of cards. </span><span class="kobospan" id="kobo.1024.2">We’ll need the definition of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1025.1">Card</span></span></span></span><span class="kobospan" id="kobo.1026.1"> class based on the example in the </span><a href="ch011_split_000.xhtml#x1-3950004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1027.1">Using typing.NamedTuple for</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1028.1">immutable objects</span></span></a><span class="kobospan" id="kobo.1029.1"> recipe:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1030.1">
 
 
&gt;&gt;&gt; deck = Deck() 
 
&gt;&gt;&gt; c = Cribbage(deck, Player("1"), Player("2")) 
 
&gt;&gt;&gt; c.dealer 
 
Player(name=’2’) 
 
&gt;&gt;&gt; c.opponent 
 
Player(name=’1’) 
 
&gt;&gt;&gt; c.new_deal() 
 
&gt;&gt;&gt; c.dealer 
 
Player(name=’1’) 
 
&gt;&gt;&gt; c.opponent 
 
Player(name=’2’)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1031.1">The initial </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1032.1">Cribbage</span></span></span></span><span class="kobospan" id="kobo.1033.1"> object</span><span id="dx1-415045"/><span class="kobospan" id="kobo.1034.1"> was created</span><span id="dx1-415046"/><span class="kobospan" id="kobo.1035.1"> with a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1036.1">Deck</span></span></span></span><span class="kobospan" id="kobo.1037.1"> and two </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1038.1">Player</span></span></span></span><span class="kobospan" id="kobo.1039.1"> instances. </span><span class="kobospan" id="kobo.1039.2">These three objects filled in the the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1040.1">deck</span></span></span></span><span class="kobospan" id="kobo.1041.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1042.1">players</span></span></span></span><span class="kobospan" id="kobo.1043.1"> slots. </span><span class="kobospan" id="kobo.1043.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1044.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.1045.1"> method then randomized the players, making one of them the dealer and the other the opponent. </span><span class="kobospan" id="kobo.1045.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1046.1">crib</span></span></span></span><span class="kobospan" id="kobo.1047.1"> was initialized to an empty </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1048.1">Hand</span></span></span></span><span class="kobospan" id="kobo.1049.1"> instance.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1050.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1051.1">new_deal()</span></span></span></span><span class="kobospan" id="kobo.1052.1"> method makes a number of changes to the state of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1053.1">Cribbage</span></span></span></span><span class="kobospan" id="kobo.1054.1"> instance. </span><span class="kobospan" id="kobo.1054.2">This is revealed when the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1055.1">dealer</span></span></span></span><span class="kobospan" id="kobo.1056.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1057.1">opponent</span></span></span></span><span class="kobospan" id="kobo.1058.1"> attributes are examined.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1059.1">Here’s what happens if we try to create a new attribute:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1060.1">
 
 
&gt;&gt;&gt; c.some_other_attribute = True 
 
Traceback (most recent call last): 
 
... 
 
AttributeError: ’Cribbage’ object has no attribute ’some_other_attribute’
                                                                     

                                                                     </span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1061.1">We attempted to create an attribute named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1062.1">some_other_attribute</span></span></span></span><span class="kobospan" id="kobo.1063.1"> on the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1064.1">Cribbage</span></span></span></span><span class="kobospan" id="kobo.1065.1"> object, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1066.1">c</span></span></span></span><span class="kobospan" id="kobo.1067.1">. </span><span class="kobospan" id="kobo.1067.2">This raised an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1068.1">AttributeError</span></span></span></span><span class="kobospan" id="kobo.1069.1"> exception. </span><span class="kobospan" id="kobo.1069.2">Using </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1070.1">__slots__</span></span></span></span><span class="kobospan" id="kobo.1071.1"> means that new attributes cannot be added to an instance of the class. </span><span id="x1-415052r851"/></p>
</section>
<section data-number="0.10.7.3" id="how-it-works...-58">
<h2 class="likechapterhead" data-number="0.10.7.3"><span><span class="kobospan" id="kobo.1072.1">7.7.3 </span></span> <span id="x1-4160003"/><span class="kobospan" id="kobo.1073.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1074.1">When we create an object</span><span id="dx1-416001"/><span class="kobospan" id="kobo.1075.1"> instance, the steps in the process</span><span id="dx1-416002"/><span class="kobospan" id="kobo.1076.1"> are defined in part by the object’s class and the built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1077.1">type()</span></span></span></span><span class="kobospan" id="kobo.1078.1"> function. </span><span class="kobospan" id="kobo.1078.2">Implicitly, a class has a special </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1079.1">__new__()</span></span></span></span><span class="kobospan" id="kobo.1080.1"> method that handles the internal house-keeping required to create a new, empty object. </span><span class="kobospan" id="kobo.1080.2">After this, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1081.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.1082.1"> method creates and initializes the attributes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1083.1">Python has three essential paths for creating instances of a class:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1084.1">The default behavior, defined by the built-ins </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1085.1">object</span></span></span></span><span class="kobospan" id="kobo.1086.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1087.1">type()</span></span></span></span><span class="kobospan" id="kobo.1088.1">, is used when we define a class without doing anything unusual. </span><span class="kobospan" id="kobo.1088.2">Each instance contains a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1089.1">__dict__</span></span></span></span><span class="kobospan" id="kobo.1090.1"> attribute that is used to hold all other attributes. </span><span class="kobospan" id="kobo.1090.2">Because the object’s attributes are kept in a dictionary, we can add, change, and delete attributes freely. </span><span class="kobospan" id="kobo.1090.3">This flexibility requires the use of additional memory for the dictionary object inside each instance.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1091.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1092.1">__slots__</span></span></span></span><span class="kobospan" id="kobo.1093.1"> behavior avoids creating the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1094.1">__dict__</span></span></span></span><span class="kobospan" id="kobo.1095.1"> attribute. </span><span class="kobospan" id="kobo.1095.2">Because the object has only the attributes named in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1096.1">__slots__</span></span></span></span><span class="kobospan" id="kobo.1097.1"> sequence, we can’t add or delete attributes. </span><span class="kobospan" id="kobo.1097.2">We can change the values of the defined attributes. </span><span class="kobospan" id="kobo.1097.3">This lack of flexibility means that less memory is used for each object.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1098.1">The subclass of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1099.1">tuple</span></span></span></span><span class="kobospan" id="kobo.1100.1"> behavior defines immutable objects. </span><span class="kobospan" id="kobo.1100.2">An easy way to create these classes is with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1101.1">typing.NamedTuple</span></span></span></span><span class="kobospan" id="kobo.1102.1"> as a parent class. </span><span class="kobospan" id="kobo.1102.2">Once built, the instances are immutable and cannot be changed. </span><span class="kobospan" id="kobo.1102.3">While it’s possible to directly subclass </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1103.1">tuple</span></span></span></span><span class="kobospan" id="kobo.1104.1">, the extra features of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1105.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.1106.1"> seem to make this ideal.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1107.1">A large application might be constrained by the amount of memory used, and switching the class with the largest number of instances to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1108.1">__slots__</span></span></span></span><span class="kobospan" id="kobo.1109.1"> can lead to an improvement in performance. </span><span id="x1-416003r858"/></p>
</section>
<section data-number="0.10.7.4" id="theres-more...-50">
<h2 class="likechapterhead" data-number="0.10.7.4"><span><span class="kobospan" id="kobo.1110.1">7.7.4 </span></span> <span id="x1-4170004"/><span class="kobospan" id="kobo.1111.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1112.1">It’s possible to tailor the way the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1113.1">__new__()</span></span></span></span><span class="kobospan" id="kobo.1114.1"> method works to replace the default </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1115.1">__dict__</span></span></span></span><span class="kobospan" id="kobo.1116.1"> attribute with a different kind of dictionary. </span><span class="kobospan" id="kobo.1116.2">This is an advanced technique because it exposes the inner workings of classes and objects.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1117.1">Python relies on a metaclass to create instances of a class. </span><span class="kobospan" id="kobo.1117.2">The default metaclass is the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1118.1">type</span></span></span></span><span class="kobospan" id="kobo.1119.1"> class. </span><span class="kobospan" id="kobo.1119.2">The idea is that the metaclass provides a few pieces of functionality that are used to create each object. </span><span class="kobospan" id="kobo.1119.3">Once the empty object has been created, then the class’s </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1120.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.1121.1"> method will initialize the empty object.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1122.1">Generally, a metaclass will provide a definition of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1123.1">__new__()</span></span></span></span><span class="kobospan" id="kobo.1124.1">, and perhaps </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1125.1">__prepare__()</span></span></span></span><span class="kobospan" id="kobo.1126.1">, if there’s a need to customize the object. </span><span class="kobospan" id="kobo.1126.2">There’s a widely used example in the Python Language Reference document that tweaks the namespace used to create a class.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1127.1">For more</span><span id="dx1-417001"/><span class="kobospan" id="kobo.1128.1"> details, see </span><a class="url" href="https://docs.python.org/3/reference/datamodel.html#metaclass-example"><span class="url1"><span class="kobospan" id="kobo.1129.1">https://docs.python.org/3/reference/datamodel.html#metaclass-example</span></span></a><span class="kobospan" id="kobo.1130.1">. </span><span id="x1-417002r859"/></p>
</section>
<section data-number="0.10.7.5" id="see-also-57">
<h2 class="likechapterhead" data-number="0.10.7.5"><span><span class="kobospan" id="kobo.1131.1">7.7.5 </span></span> <span id="x1-4180005"/><span class="kobospan" id="kobo.1132.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1133.1">The more common cases of an immutable object or a completely flexible object are covered in the </span><a href="ch011_split_000.xhtml#x1-3950004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1134.1">Using typing.NamedTuple for</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1135.1">immutable objects</span></span></a><span class="kobospan" id="kobo.1136.1"> recipe.</span></p></li>
</ul>
<p class="normal1"><span id="x1-418001r849"/></p>
</section>
</section>
<section data-number="0.10.8" id="using-more-sophisticated-collections">
<h1 class="unnumbered" data-number="0.10.8"><span><span class="kobospan" id="kobo.1137.1">7.8 </span></span> <span id="x1-4190008"/><span class="kobospan" id="kobo.1138.1">Using more sophisticated collections</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1139.1">Python has a wide variety</span><span id="dx1-419001"/><span class="kobospan" id="kobo.1140.1"> of built-in collections. </span><span class="kobospan" id="kobo.1140.2">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1141.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1142.1"> </span></span><a href="ch008_split_000.xhtml#x1-2240004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1143.1">4</span></span></a><span class="kobospan" id="kobo.1144.1">, we looked at them closely. </span><span class="kobospan" id="kobo.1144.2">In the </span><a href="ch008_split_000.xhtml#x1-2250001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1145.1">Choosing a data structure</span></span></a><span class="kobospan" id="kobo.1146.1"> recipe, we provided a kind of decision tree to help locate the appropriate data structure from the available choices.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1147.1">When we consider built-in types and other data structures in the standard library, we have more choices, and more decisions to make. </span><span class="kobospan" id="kobo.1147.2">How can we choose the right data structure for our problem? </span><span id="x1-419002r860"/></p>
<section data-number="0.10.8.1" id="getting-ready-59">
<h2 class="likechapterhead" data-number="0.10.8.1"><span><span class="kobospan" id="kobo.1148.1">7.8.1 </span></span> <span id="x1-4200001"/><span class="kobospan" id="kobo.1149.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1150.1">Before we put data into a collection, we’ll need to consider how we’ll gather the data, and what we’ll do with the collection once we have it. </span><span class="kobospan" id="kobo.1150.2">The big question is always how we’ll identify a particular item within the collection. </span><span class="kobospan" id="kobo.1150.3">We’ll look at a few key questions that we need to answer to help select</span><span id="dx1-420001"/><span class="kobospan" id="kobo.1151.1"> a proper collection for our needs.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1152.1">Here’s an overview of some of the alternative collections. </span><span class="kobospan" id="kobo.1152.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1153.1">collections</span></span></span></span><span class="kobospan" id="kobo.1154.1"> module contains a number of variations on the built-in collections. </span><span class="kobospan" id="kobo.1154.2">These include the following:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1155.1">deque</span></span></span></span><span class="kobospan" id="kobo.1156.1">: A double-ended queue. </span><span class="kobospan" id="kobo.1156.2">This is a mutable sequence with optimizations for pushing and popping from each end. </span><span class="kobospan" id="kobo.1156.3">Note that the class name starts with a lowercase letter; this is atypical for Python.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1157.1">defaultdict</span></span></span></span><span class="kobospan" id="kobo.1158.1">: A mapping that can provide a default value for a missing key. </span><span class="kobospan" id="kobo.1158.2">Note that the class name starts with a lowercase letter; this is atypical for Python.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1159.1">Counter</span></span></span></span><span class="kobospan" id="kobo.1160.1">: A mapping that is designed to count the number of occurrences of distinct keys. </span><span class="kobospan" id="kobo.1160.2">This is sometimes</span><span id="dx1-420002"/><span id="dx1-420003"/><span class="kobospan" id="kobo.1161.1"> called a multiset or a bag.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1162.1">ChainMap</span></span></span></span><span class="kobospan" id="kobo.1163.1">: A mapping that combines several dictionaries into a single mapping.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1164.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1165.1">heapq</span></span></span></span><span class="kobospan" id="kobo.1166.1"> module includes a priority queue implementation. </span><span class="kobospan" id="kobo.1166.2">This is a specialized library that leverages the built-in list sequence to maintain items in a sorted order.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1167.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1168.1">bisect</span></span></span></span><span class="kobospan" id="kobo.1169.1"> module includes methods for searching a sorted list. </span><span class="kobospan" id="kobo.1169.2">This creates some overlap between the dictionary features and the list features.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1170.1">Additionally, there’s an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1171.1">OrderedDict</span></span></span></span><span class="kobospan" id="kobo.1172.1"> class in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1173.1">collections</span></span></span></span><span class="kobospan" id="kobo.1174.1"> module. </span><span class="kobospan" id="kobo.1174.2">Starting with Python 3.7, the dictionary keys for an ordinary dictionary are retained in the order they were created, making the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1175.1">OrderedDict</span></span></span></span><span class="kobospan" id="kobo.1176.1"> class redundant. </span><span id="x1-420004r862"/></p>
</section>
<section data-number="0.10.8.2" id="how-to-do-it...-59">
<h2 class="likechapterhead" data-number="0.10.8.2"><span><span class="kobospan" id="kobo.1177.1">7.8.2 </span></span> <span id="x1-4210002"/><span class="kobospan" id="kobo.1178.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1179.1">There are a number of questions we need to answer to decide if we need a library data collection instead of one of the built-in collections:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-421002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1180.1">Is the structure a buffer between the producer and the consumer? </span><span class="kobospan" id="kobo.1180.2">Does some part of the algorithm produce data items and another part consume the data items?</span></p>
<ul class="calibre17">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1181.1">A queue is</span><span id="dx1-421003"/><span class="kobospan" id="kobo.1182.1"> used for </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1183.1">First-In-First-Out </span></span><span class="kobospan" id="kobo.1184.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1185.1">FIFO</span></span><span class="kobospan" id="kobo.1186.1">) processing. </span><span class="kobospan" id="kobo.1186.2">Items are inserted at one end and consumed from the other end. </span><span class="kobospan" id="kobo.1186.3">We can use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1187.1">list.append()</span></span></span></span><span class="kobospan" id="kobo.1188.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1189.1">list.pop(0)</span></span></span></span><span class="kobospan" id="kobo.1190.1"> to simulate this, though </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1191.1">collections.deque</span></span></span></span><span class="kobospan" id="kobo.1192.1"> will be more efficient; we can use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1193.1">deque.append()</span></span></span></span><span class="kobospan" id="kobo.1194.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1195.1">deque.popleft()</span></span></span></span><span class="kobospan" id="kobo.1196.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1197.1">A stack is</span><span id="dx1-421004"/><span class="kobospan" id="kobo.1198.1"> used for </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1199.1">Last-In-First-Out </span></span><span class="kobospan" id="kobo.1200.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1201.1">LIFO</span></span><span class="kobospan" id="kobo.1202.1">) processing. </span><span class="kobospan" id="kobo.1202.2">Items are inserted and consumed from the same end. </span><span class="kobospan" id="kobo.1202.3">We can use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1203.1">list.append()</span></span></span></span><span class="kobospan" id="kobo.1204.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1205.1">list.pop()</span></span></span></span><span class="kobospan" id="kobo.1206.1"> to simulate this, though </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1207.1">collections.deque</span></span></span></span><span class="kobospan" id="kobo.1208.1"> will be more efficient; we can use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1209.1">deque.append()</span></span></span></span><span class="kobospan" id="kobo.1210.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1211.1">deque.pop()</span></span></span></span><span class="kobospan" id="kobo.1212.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1213.1">A priority queue (or heap queue) keeps the queue sorted in some order, distinct from the arrival order. </span><span class="kobospan" id="kobo.1213.2">We can try to simulate this by using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1214.1">list.append()</span></span></span></span><span class="kobospan" id="kobo.1215.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1216.1">list.sort(key=lambda</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1217.1"> x:x.priority)</span></span></span></span><span class="kobospan" id="kobo.1218.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1219.1">list.pop(-1)</span></span></span></span><span class="kobospan" id="kobo.1220.1"> operations to keep items in priority order. </span><span class="kobospan" id="kobo.1220.2">Performing a sort after each insert can make it inefficient. </span><span class="kobospan" id="kobo.1220.3">Using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1221.1">heapq</span></span></span></span><span class="kobospan" id="kobo.1222.1"> module can be more efficient. </span><span class="kobospan" id="kobo.1222.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1223.1">heapq</span></span></span></span><span class="kobospan" id="kobo.1224.1"> module has functions for creating and updating heaps.</span></p></li>
</ul>
</div></li>
<li class="calibre7"><div id="x1-421006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1225.1">How do we want to deal with missing keys</span><span id="dx1-421007"/><span class="kobospan" id="kobo.1226.1"> from a dictionary?</span></p>
<ul class="calibre17">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1227.1">Raise an exception. </span><span class="kobospan" id="kobo.1227.2">This is the way the built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1228.1">dict</span></span></span></span><span class="kobospan" id="kobo.1229.1"> class works.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1230.1">Create a default item. </span><span class="kobospan" id="kobo.1230.2">This is how </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1231.1">collections.defaultdict</span></span></span></span><span class="kobospan" id="kobo.1232.1"> works. </span><span class="kobospan" id="kobo.1232.2">We must provide a function that returns the default value. </span><span class="kobospan" id="kobo.1232.3">Common examples include </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1233.1">defaultdict(int)</span></span></span></span><span class="kobospan" id="kobo.1234.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1235.1">defaultdict(float)</span></span></span></span><span class="kobospan" id="kobo.1236.1"> to use a default value of 0 or 0.0. </span><span class="kobospan" id="kobo.1236.2">We can also use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1237.1">defauldict(list)</span></span></span></span><span class="kobospan" id="kobo.1238.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1239.1">defauldict(set)</span></span></span></span><span class="kobospan" id="kobo.1240.1"> to create dictionary-of-list or dictionary-of-set structures.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1241.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1242.1">defaultdict(int)</span></span></span></span><span class="kobospan" id="kobo.1243.1"> used to create a dictionary for counting items is so common that the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1244.1">collections.Counter</span></span></span></span><span class="kobospan" id="kobo.1245.1"> class does exactly this.</span></p></li>
</ul>
</div></li>
<li class="calibre7"><div id="x1-421009x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1246.1">How do we want to handle the order of keys in a dictionary? </span><span class="kobospan" id="kobo.1246.2">Generally, Python above version 3.6 keeps the keys in insertion order. </span><span class="kobospan" id="kobo.1246.3">If we want a different order, we’ll have to sort them manually.</span></p>
</div></li>
<li class="calibre7"><div id="x1-421011x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1247.1">How will we build the dictionary?</span></p>
<ul class="calibre17">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1248.1">We have a simple algorithm to create items. </span><span class="kobospan" id="kobo.1248.2">In this case, a built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1249.1">dict</span></span></span></span><span class="kobospan" id="kobo.1250.1"> object may be sufficient.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1251.1">We have multiple dictionaries that will need to be merged. </span><span class="kobospan" id="kobo.1251.2">This can happen when reading configuration files. </span><span class="kobospan" id="kobo.1251.3">We might have an individual configuration, a system-wide configuration, and a default application configuration that all need to be merged into a single dictionary using a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1252.1">ChainMap</span></span></span></span><span class="kobospan" id="kobo.1253.1"> collection.</span></p></li>
</ul>
</div></li>
</ol>
<p class="normal1"><span id="x1-421012r863"/></p>
</section>
<section data-number="0.10.8.3" id="how-it-works...-59">
<h2 class="likechapterhead" data-number="0.10.8.3"><span><span class="kobospan" id="kobo.1254.1">7.8.3 </span></span> <span id="x1-4220003"/><span class="kobospan" id="kobo.1255.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1256.1">There are two principle resource</span><span id="dx1-422001"/><span class="kobospan" id="kobo.1257.1"> constraints on data processing:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1258.1">Storage</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1259.1">Time</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1260.1">All of our programming must respect these constraints. </span><span class="kobospan" id="kobo.1260.2">In most cases, the two are inverses: anything we do to reduce storage use tends to increase processing time, and anything we do to reduce processing time increases storage use. </span><span class="kobospan" id="kobo.1260.3">Algorithm and data structure design seeks to find an optimal balance among the constraints.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1261.1">The time aspect is formalized via a complexity metric. </span><span class="kobospan" id="kobo.1261.2">There are several ways to describe the complexity</span><span id="dx1-422002"/><span class="kobospan" id="kobo.1262.1"> of an algorithm:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1263.1">Complexity </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1264.1">O</span></span><span class="kobospan" id="kobo.1265.1">(1) doesn’t change with the volume of data. </span><span class="kobospan" id="kobo.1265.2">For some collections, the actual overall long-term average is nearly </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1266.1">O</span></span><span class="kobospan" id="kobo.1267.1">(1) with minor exceptions. </span><span class="kobospan" id="kobo.1267.2">Many dictionary operations are </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1268.1">O</span></span><span class="kobospan" id="kobo.1269.1">(1). </span><span class="kobospan" id="kobo.1269.2">Appending to a list, and popping from the end of a list is very fast, making a LIFO stack very efficient. </span><span class="kobospan" id="kobo.1269.3">Popping from the front of a list is </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1270.1">O</span></span><span class="kobospan" id="kobo.1271.1">(</span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1272.1">n</span></span><span class="kobospan" id="kobo.1273.1">), making a FIFO queue built from a simple list rather expensive; the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1274.1">deque</span></span></span></span><span class="kobospan" id="kobo.1275.1"> class and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1276.1">heapq</span></span></span></span><span class="kobospan" id="kobo.1277.1"> module remedy this with better designs.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1278.1">Complexity described as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1279.1">O</span></span><span class="kobospan" id="kobo.1280.1">(log </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1281.1">n</span></span><span class="kobospan" id="kobo.1282.1">) means the cost grows more slowly than the volume of data, </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1283.1">n</span></span><span class="kobospan" id="kobo.1284.1">. </span><span class="kobospan" id="kobo.1284.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1285.1">bisect</span></span></span></span><span class="kobospan" id="kobo.1286.1"> module lets us search a sorted list more efficiently than the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1287.1">list</span></span></span></span><span class="kobospan" id="kobo.1288.1"> class by dividing the list into halves. </span><span class="kobospan" id="kobo.1288.2">Note that sorting the list in the first place is </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1289.1">O</span></span><span class="kobospan" id="kobo.1290.1">(</span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1291.1">n</span></span><span class="kobospan" id="kobo.1292.1">log </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1293.1">n</span></span><span class="kobospan" id="kobo.1294.1">), so there needs to be a great many searches to amortize the cost of sorting.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1295.1">Complexity described as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1296.1">O</span></span><span class="kobospan" id="kobo.1297.1">(</span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1298.1">n</span></span><span class="kobospan" id="kobo.1299.1">) means the cost grows as the volume of data, </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1300.1">n</span></span><span class="kobospan" id="kobo.1301.1">, grows. </span><span class="kobospan" id="kobo.1301.2">Finding an item in a list has this complexity. </span><span class="kobospan" id="kobo.1301.3">If the item is at the end of the list, all </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1302.1">n </span></span><span class="kobospan" id="kobo.1303.1">items must be checked. </span><span class="kobospan" id="kobo.1303.2">Sets and mappings don’t have this problem, and have nearly </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1304.1">O</span></span><span class="kobospan" id="kobo.1305.1">(1) complexity.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1306.1">A complexity described as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1307.1">O</span></span><span class="kobospan" id="kobo.1308.1">(</span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1309.1">n</span></span><span class="kobospan" id="kobo.1310.1">log </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1311.1">n</span></span><span class="kobospan" id="kobo.1312.1">) grows more quickly than the volume of data. </span><span class="kobospan" id="kobo.1312.2">Sorting a list tends to have this complexity. </span><span class="kobospan" id="kobo.1312.3">For this reason, it helps to minimize or eliminate sorting large volumes of data.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1313.1">There are even worse cases. </span><span class="kobospan" id="kobo.1313.2">Some algorithms have a complexity of </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1314.1">O</span></span><span class="kobospan" id="kobo.1315.1">(</span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1316.1">n</span></span><sup class="calibre15"><span class="cmr1"><span class="kobospan" id="kobo.1317.1">2</span></span></sup><span class="kobospan" id="kobo.1318.1">), </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1319.1">O</span></span><span class="kobospan" id="kobo.1320.1">(2</span><sup class="calibre15"><span class="cmmi"><span class="kobospan" id="kobo.1321.1">n</span></span></sup><span class="kobospan" id="kobo.1322.1">), or even </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1323.1">O</span></span><span class="kobospan" id="kobo.1324.1">(</span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1325.1">n</span></span><span class="kobospan" id="kobo.1326.1">!). </span><span class="kobospan" id="kobo.1326.2">We’d like to avoid these kinds of very expensive algorithms through clever design and good choice of data structure. </span><span class="kobospan" id="kobo.1326.3">These can be deceptive in practice. </span><span class="kobospan" id="kobo.1326.4">We may be able to work out an </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1327.1">O</span></span><span class="kobospan" id="kobo.1328.1">(2</span><sup class="calibre15"><span class="cmmi"><span class="kobospan" id="kobo.1329.1">n</span></span></sup><span class="kobospan" id="kobo.1330.1">) algorithm that seems to perform well on small test cases where </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1331.1">n </span></span><span class="kobospan" id="kobo.1332.1">is 3 or 4. </span><span class="kobospan" id="kobo.1332.2">In these cases, there are only 8 or 16 combinations. </span><span class="kobospan" id="kobo.1332.3">If real data involves 70 items, the number</span><span id="dx1-422003"/><span class="kobospan" id="kobo.1333.1"> of combinations is on the order of 10</span><sup class="calibre15"><span class="cmr1"><span class="kobospan" id="kobo.1334.1">22</span></span></sup><span class="kobospan" id="kobo.1335.1">, a number with 22 digits.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1336.1">The various data structures</span><span id="dx1-422004"/><span class="kobospan" id="kobo.1337.1"> available in the standard library reflect a number of time and storage trade-offs. </span><span id="x1-422005r864"/></p>
</section>
<section data-number="0.10.8.4" id="theres-more...-51">
<h2 class="likechapterhead" data-number="0.10.8.4"><span><span class="kobospan" id="kobo.1338.1">7.8.4 </span></span> <span id="x1-4230004"/><span class="kobospan" id="kobo.1339.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1340.1">As a concrete and extreme example, let’s look at searching a web log file for a particular sequence of events. </span><span class="kobospan" id="kobo.1340.2">We have two overall design strategies:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1341.1">Read all of the events into a list structure with something like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1342.1">file.read().splitlines()</span></span></span></span><span class="kobospan" id="kobo.1343.1">. </span><span class="kobospan" id="kobo.1343.2">We can then use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1344.1">for</span></span></span></span><span class="kobospan" id="kobo.1345.1"> statement to iterate through the list looking for the combination of events. </span><span class="kobospan" id="kobo.1345.2">While the initial read may take some time, the search will be very fast because the log is all in memory.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1346.1">Read and process each individual event from a log file. </span><span class="kobospan" id="kobo.1346.2">When a log entry is part of the searched-for pattern, it makes sense to save only this event in a subset of the log. </span><span class="kobospan" id="kobo.1346.3">We might use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1347.1">defaultdict</span></span></span></span><span class="kobospan" id="kobo.1348.1"> with a session ID or client IP address as the key and a list of events as the value. </span><span class="kobospan" id="kobo.1348.2">This will take longer to read the logs, but the resulting structure in memory will be much smaller than a list of all log entries.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1349.1">The first algorithm, reading everything into memory, can be wildly impractical. </span><span class="kobospan" id="kobo.1349.2">On a large web server, the logs might involve hundreds of gigabytes of data. </span><span class="kobospan" id="kobo.1349.3">Logs can easily be too large to fit into any computer’s memory.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1350.1">The second approach has a number of alternative implementations:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1351.1">Single process</span></span><span class="kobospan" id="kobo.1352.1">: The general approach</span><span id="dx1-423001"/><span class="kobospan" id="kobo.1353.1"> to most of the Python recipes here assumes that we’re creating an application that runs as a single process.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1354.1">Multiple processes</span></span><span class="kobospan" id="kobo.1355.1">: We might expand the row-by-row search</span><span id="dx1-423002"/><span class="kobospan" id="kobo.1356.1"> into a multi-processing application using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1357.1">multiprocessing</span></span></span></span><span class="kobospan" id="kobo.1358.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1359.1">concurrent.futures</span></span></span></span><span class="kobospan" id="kobo.1360.1"> packages. </span><span class="kobospan" id="kobo.1360.2">These packages let us create a collection of worker processes, each of which can process a subset of the available data and return the results to a consumer that combines the results. </span><span class="kobospan" id="kobo.1360.3">On a modern multiprocessor, multi-core computer, this can be a very effective use of resources.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1361.1">Multiple hosts</span></span><span class="kobospan" id="kobo.1362.1">: The extreme case requires multiple</span><span id="dx1-423003"/><span class="kobospan" id="kobo.1363.1"> servers, each of which handles a subset of the data. </span><span class="kobospan" id="kobo.1363.2">This requires more elaborate coordination among the hosts to share result sets. </span><span class="kobospan" id="kobo.1363.3">Generally, it can work out well</span><span id="dx1-423004"/><span class="kobospan" id="kobo.1364.1"> to use a framework such as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1365.1">Dask </span></span><span class="kobospan" id="kobo.1366.1">or </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1367.1">Spark </span></span><span class="kobospan" id="kobo.1368.1">for this kind</span><span id="dx1-423005"/><span class="kobospan" id="kobo.1369.1"> of processing. </span><span class="kobospan" id="kobo.1369.2">While the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1370.1">multiprocessing</span></span></span></span><span class="kobospan" id="kobo.1371.1"> module is quite sophisticated, tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1372.1">Dask </span></span><span class="kobospan" id="kobo.1373.1">are even more suitable for large-scale computation.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1374.1">We’ll often decompose a large search into map and reduce processing. </span><span class="kobospan" id="kobo.1374.2">The map phase applies some processing or filtering to every item in the collection. </span><span class="kobospan" id="kobo.1374.3">The reduce phase combines map results into summary or aggregate objects. </span><span class="kobospan" id="kobo.1374.4">In many cases, there is a complex hierarchy of Map-Reduce stages applied to the results of previous Map-Reduce operations. </span><span id="x1-423006r865"/></p>
</section>
<section data-number="0.10.8.5" id="see-also-58">
<h2 class="likechapterhead" data-number="0.10.8.5"><span><span class="kobospan" id="kobo.1375.1">7.8.5 </span></span> <span id="x1-4240005"/><span class="kobospan" id="kobo.1376.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1377.1">See the </span><a href="ch008_split_000.xhtml#x1-2250001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1378.1">Choosing a data structure</span></span></a><span class="kobospan" id="kobo.1379.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1380.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1381.1"> </span></span><a href="ch008_split_000.xhtml#x1-2240004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1382.1">4</span></span></a><span class="kobospan" id="kobo.1383.1">, for a foundational set of decisions for selecting data structures.</span></p></li>
</ul>
<p class="normal1"><span id="x1-424001r861"/></p>
</section>
</section>
<section data-number="0.10.9" id="extending-a-built-in-collection-a-list-that-does-statistics">
<h1 class="unnumbered" data-number="0.10.9"><span><span class="kobospan" id="kobo.1384.1">7.9 </span></span> <span id="x1-4250009"/><span class="kobospan" id="kobo.1385.1">Extending a built-in collection – a list that does statistics</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1386.1">In the </span><a href="ch011_split_000.xhtml#x1-3890003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1387.1">Designing classes with lots of processing</span></span></a><span class="kobospan" id="kobo.1388.1"> recipe, we looked</span><span id="dx1-425001"/><span class="kobospan" id="kobo.1389.1"> at a way to distinguish between a complex algorithm and a collection. </span><span class="kobospan" id="kobo.1389.2">We showed how to encapsulate the algorithm and the data into separate classes. </span><span class="kobospan" id="kobo.1389.3">The alternative design strategy is to extend the collection to incorporate a useful algorithm.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1390.1">How can we extend Python’s built-in collections? </span><span class="kobospan" id="kobo.1390.2">How can we add features to the built-in list? </span><span id="x1-425002r866"/></p>
<section data-number="0.10.9.1" id="getting-ready-60">
<h2 class="likechapterhead" data-number="0.10.9.1"><span><span class="kobospan" id="kobo.1391.1">7.9.1 </span></span> <span id="x1-4260001"/><span class="kobospan" id="kobo.1392.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1393.1">We’ll create a sophisticated list class where each instance can compute the sums and averages of the items in the list. </span><span class="kobospan" id="kobo.1393.2">This will require an application to put only numbers in the list; otherwise, there will be </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1394.1">ValueError</span></span></span></span><span class="kobospan" id="kobo.1395.1"> exceptions raised.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1396.1">We’re going to show methods that explicitly use generator expressions as places where additional processing can be included. </span><span class="kobospan" id="kobo.1396.2">Rather than use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1397.1">sum(self)</span></span></span></span><span class="kobospan" id="kobo.1398.1">, we’re going to emphasize </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1399.1">sum(v</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1400.1"> for</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1401.1"> v</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1402.1"> in</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1403.1"> self)</span></span></span></span><span class="kobospan" id="kobo.1404.1"> because there are two common future extensions: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1405.1">sum(m(v)</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1406.1"> for</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1407.1"> v</span></span></span></span> <span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1408.1">in</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1409.1"> self)</span></span></span></span><span class="kobospan" id="kobo.1410.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1411.1">sum(v</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1412.1"> for</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1413.1"> v</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1414.1"> in</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1415.1"> self</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1416.1"> if</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1417.1"> f(v))</span></span></span></span><span class="kobospan" id="kobo.1418.1">. </span><span class="kobospan" id="kobo.1418.2">These are the mapping and filtering alternatives where a mapping function, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1419.1">m(v)</span></span></span></span><span class="kobospan" id="kobo.1420.1">, is applied to each item; or a filter function, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1421.1">f(v)</span></span></span></span><span class="kobospan" id="kobo.1422.1">, is applied to pass or reject each item. </span><span class="kobospan" id="kobo.1422.2">Computing a sum of squares, for example, applies a mapping to compute the square of each value before summing. </span><span id="x1-426001r868"/></p>
</section>
<section data-number="0.10.9.2" id="how-to-do-it...-60">
<h2 class="likechapterhead" data-number="0.10.9.2"><span><span class="kobospan" id="kobo.1423.1">7.9.2 </span></span> <span id="x1-4270002"/><span class="kobospan" id="kobo.1424.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-427002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1425.1">Pick a name for the list that also does simple statistics. </span><span class="kobospan" id="kobo.1425.2">Define the class as an extension to the built-in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1426.1">list </span></span><span class="kobospan" id="kobo.1427.1">class:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1428.1">
                                                                     

                                                                     
class StatsList(list[float]):</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1429.1">We can stick with a generic type hint of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1430.1">list</span></span></span></span><span class="kobospan" id="kobo.1431.1">. </span><span class="kobospan" id="kobo.1431.2">This is often too broad. </span><span class="kobospan" id="kobo.1431.3">Since the structure will contain numbers, it’s more sensible to use the narrower hint of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1432.1">list[float]</span></span></span></span><span class="kobospan" id="kobo.1433.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1434.1">When working with numeric data, </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1435.1">mypy </span></span><span class="kobospan" id="kobo.1436.1">treats the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1437.1">float</span></span></span></span><span class="kobospan" id="kobo.1438.1"> type as a superclass</span><span id="dx1-427005"/><span class="kobospan" id="kobo.1439.1"> for both </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1440.1">float</span></span></span></span><span class="kobospan" id="kobo.1441.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1442.1">int</span></span></span></span><span class="kobospan" id="kobo.1443.1">, saving us from having to define an explicit </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1444.1">Union[float,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1445.1"> int]</span></span></span></span><span class="kobospan" id="kobo.1446.1">.</span></p>
</div></li>
<li class="calibre7"><div id="x1-427007x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1447.1">Define the additional processing</span><span id="dx1-427008"/><span class="kobospan" id="kobo.1448.1"> as methods. </span><span class="kobospan" id="kobo.1448.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1449.1">self</span></span></span></span><span class="kobospan" id="kobo.1450.1"> variable will be an object that has inherited all of the attributes and methods from the superclass. </span><span class="kobospan" id="kobo.1450.2">In this case, the superclass is </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1451.1">list[float]</span></span></span></span><span class="kobospan" id="kobo.1452.1">. </span><span class="kobospan" id="kobo.1452.2">We’ll use a generator expression here as a place where future changes might be incorporated. </span><span class="kobospan" id="kobo.1452.3">Here’s a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1453.1">sum()</span></span></span></span><span class="kobospan" id="kobo.1454.1"> method:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1455.1">
    def sum(self) -&gt; float: 
 
        return sum(v for v in self)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-427013x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1456.1">Here’s another method that we often apply to a list. </span><span class="kobospan" id="kobo.1456.2">This counts items and returns the size. </span><span class="kobospan" id="kobo.1456.3">We’ve used a generator expression to make it easy to add mappings or filter criteria if that ever becomes necessary:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1457.1">
    def size(self) -&gt; float: 
 
        return sum(1 for v in self)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-427018x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1458.1">Here’s the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1459.1">mean </span></span><span class="kobospan" id="kobo.1460.1">method:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1461.1">
    def mean(self) -&gt; float: 
 
        return self.sum() / self.size()</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-427023x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1462.1">Here are some additional methods. </span><span class="kobospan" id="kobo.1462.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1463.1">sum2()</span></span></span></span><span class="kobospan" id="kobo.1464.1"> method computes the sum of squares of values in the list. </span><span class="kobospan" id="kobo.1464.2">This is used to compute variance. </span><span class="kobospan" id="kobo.1464.3">The variance is then used to compute the standard deviation of the values in the list. </span><span class="kobospan" id="kobo.1464.4">Unlike with the previous </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1465.1">sum()</span></span></span></span><span class="kobospan" id="kobo.1466.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1467.1">count()</span></span></span></span><span class="kobospan" id="kobo.1468.1"> methods, where there’s no mapping, in this case, the generator expression includes a mapping transformation:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1469.1">
    def sum2(self) -&gt; float: 
 
        return sum(v ** 2 for v in self) 
 
    def variance(self) -&gt; float: 
 
        return ( 
 
          (self.sum2() - self.sum() ** 2 / self.size()) 
 
          / (self.size() - 1) 
 
        ) 
 
    def stddev(self) -&gt; float: 
 
        return math.sqrt(self.variance())</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1470.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1471.1">StatsList</span></span></span></span><span class="kobospan" id="kobo.1472.1"> class definition inherits all the features of a list object. </span><span class="kobospan" id="kobo.1472.2">It is extended by the methods that we added. </span><span class="kobospan" id="kobo.1472.3">Here’s an example of creating an instance in this collection:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1473.1">
 
 
&gt;&gt;&gt; subset1 = StatsList([10, 8, 13, 9, 11]) 
 
&gt;&gt;&gt; data = StatsList([14, 6, 4, 12, 7, 5]) 
 
&gt;&gt;&gt; data.extend(subset1)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1474.1">We’ve created two </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1475.1">StatsList</span></span></span></span><span class="kobospan" id="kobo.1476.1"> objects, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1477.1">subset1</span></span></span></span><span class="kobospan" id="kobo.1478.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1479.1">data</span></span></span></span><span class="kobospan" id="kobo.1480.1">, from literal</span><span id="dx1-427038"/><span class="kobospan" id="kobo.1481.1"> lists of objects. </span><span class="kobospan" id="kobo.1481.2">We used the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1482.1">extend()</span></span></span></span><span class="kobospan" id="kobo.1483.1"> method, inherited from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1484.1">list</span></span></span></span><span class="kobospan" id="kobo.1485.1"> superclass, to combine the two objects. </span><span class="kobospan" id="kobo.1485.2">Here’s the resulting object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1486.1">
 
 
&gt;&gt;&gt; data 
 
[14, 6, 4, 12, 7, 5, 10, 8, 13, 9, 11]</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1487.1">Here’s how we can use the additional methods that we defined on this object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1488.1">
                                                                     

                                                                     
 
 
&gt;&gt;&gt; data.mean() 
 
9.0 
 
&gt;&gt;&gt; data.variance() 
 
11.0</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1489.1">We’ve displayed the results of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1490.1">mean()</span></span></span></span><span class="kobospan" id="kobo.1491.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1492.1">variance()</span></span></span></span><span class="kobospan" id="kobo.1493.1"> methods. </span><span class="kobospan" id="kobo.1493.2">All the features of the built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1494.1">list</span></span></span></span><span class="kobospan" id="kobo.1495.1"> class are also present in our extension. </span><span id="x1-427047r869"/></p>
</section>
<section data-number="0.10.9.3" id="how-it-works...-60">
<h2 class="likechapterhead" data-number="0.10.9.3"><span><span class="kobospan" id="kobo.1496.1">7.9.3 </span></span> <span id="x1-4280003"/><span class="kobospan" id="kobo.1497.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1498.1">One of the essential features of class definition is the concept of inheritance. </span><span class="kobospan" id="kobo.1498.2">When we create a superclass-subclass relationship, the subclass inherits all of the features of the superclass. </span><span class="kobospan" id="kobo.1498.3">This is sometimes</span><span id="dx1-428001"/><span class="kobospan" id="kobo.1499.1"> called the generalization-specialization relationship. </span><span class="kobospan" id="kobo.1499.2">The superclass is a more generalized class; the subclass is more specialized because it adds or modifies features.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1500.1">All of the built-in classes can be extended to add features. </span><span class="kobospan" id="kobo.1500.2">In this example, we added some statistical processing that created a subclass that’s a specialized kind of list of numbers.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1501.1">There’s an important tension between the two design strategies:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1502.1">Extending</span></span><span class="kobospan" id="kobo.1503.1">: In this case, we extended a class to add features. </span><span class="kobospan" id="kobo.1503.2">The features are deeply entrenched with this single data structure, and we can’t easily use them for a different kind of sequence.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1504.1">Wrapping</span></span><span class="kobospan" id="kobo.1505.1">: In designing classes with lots of processing, we kept the processing separate from the collection. </span><span class="kobospan" id="kobo.1505.2">This leads to some more complexity in juggling two objects.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1506.1">It’s difficult to suggest that one of these is inherently superior to the other. </span><span class="kobospan" id="kobo.1506.2">In many cases, we’ll find that wrapping may have an advantage because it seems to be a better fit to the SOLID design principles. </span><span class="kobospan" id="kobo.1506.3">However, there will often be cases</span><span id="dx1-428002"/><span class="kobospan" id="kobo.1507.1"> where it’s appropriate to extend a built-in collection. </span><span id="x1-428003r878"/></p>
</section>
<section data-number="0.10.9.4" id="theres-more...-52">
<h2 class="likechapterhead" data-number="0.10.9.4"><span><span class="kobospan" id="kobo.1508.1">7.9.4 </span></span> <span id="x1-4290004"/><span class="kobospan" id="kobo.1509.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1510.1">The idea of generalization can lead to superclasses that are abstractions. </span><span class="kobospan" id="kobo.1510.2">Because an abstract class is incomplete, it requires a subclass to extend it and provide missing implementation details. </span><span class="kobospan" id="kobo.1510.3">We can’t make an instance of an abstract class because it would be missing features that make it useful.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1511.1">As we noted in the </span><a href="ch008_split_000.xhtml#x1-2250001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1512.1">Choosing a data structure</span></span></a><span class="kobospan" id="kobo.1513.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1514.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1515.1"> </span></span><a href="ch008_split_000.xhtml#x1-2240004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1516.1">4</span></span></a><span class="kobospan" id="kobo.1517.1">, there are abstract superclasses for all of the built-in collections. </span><span class="kobospan" id="kobo.1517.2">Rather than starting from a concrete class, we can also start our design from an abstract base class.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1518.1">We could, for example, start a class definition like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1519.1">
 
 
from collections.abc import MutableMapping 
 
 
 
class MyFancyMapping(MutableMapping[int, int]): 
 
    ... </span><span class="kobospan" id="kobo.1519.2"># etc.</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1520.1">In order to finish this class, we’ll need to provide an implementation for a number of special methods:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1521.1">__getitem__()</span></span></span></span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1522.1">__setitem__()</span></span></span></span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1523.1">__delitem__()</span></span></span></span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1524.1">__iter__()</span></span></span></span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1525.1">__len__()</span></span></span></span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1526.1">Each of these methods is missing from the abstract class; they have no concrete implementation in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1527.1">Mapping</span></span></span></span><span class="kobospan" id="kobo.1528.1"> class. </span><span class="kobospan" id="kobo.1528.2">Once we’ve provided workable implementations for each method, we can then make instances</span><span id="dx1-429006"/><span class="kobospan" id="kobo.1529.1"> of the new subclass. </span><span id="x1-429007r879"/></p>
</section>
<section data-number="0.10.9.5" id="see-also-59">
<h2 class="likechapterhead" data-number="0.10.9.5"><span><span class="kobospan" id="kobo.1530.1">7.9.5 </span></span> <span id="x1-4300005"/><span class="kobospan" id="kobo.1531.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1532.1">In the </span><a href="ch011_split_000.xhtml#x1-3890003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1533.1">Designing classes with lots of processing</span></span></a><span class="kobospan" id="kobo.1534.1"> recipe, we took a different approach. </span><span class="kobospan" id="kobo.1534.2">In that recipe, we left the complex algorithms in a separate class.</span></p></li>
</ul>
<p class="normal1"><span id="x1-430001r867"/></p>
</section>
</section>
<section data-number="0.10.10" id="using-properties-for-lazy-attributes">
<h1 class="unnumbered" data-number="0.10.10"><span><span class="kobospan" id="kobo.1535.1">7.10 </span></span> <span id="x1-43100010"/><span class="kobospan" id="kobo.1536.1">Using properties for lazy attributes</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1537.1">In the </span><a href="ch011_split_000.xhtml#x1-3890003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1538.1">Designing classes with lots of processing</span></span></a><span class="kobospan" id="kobo.1539.1"> recipe, we defined</span><span id="dx1-431001"/><span class="kobospan" id="kobo.1540.1"> a class</span><span id="dx1-431002"/><span class="kobospan" id="kobo.1541.1"> that eagerly computed a number of attributes of the data in a collection. </span><span class="kobospan" id="kobo.1541.2">The idea there was to compute the values as soon as possible, so that the attributes would have no further computational cost.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1542.1">We described this as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1543.1">eager </span></span><span class="kobospan" id="kobo.1544.1">processing, since the work was done</span><span id="dx1-431003"/><span class="kobospan" id="kobo.1545.1"> as soon as possible. </span><span class="kobospan" id="kobo.1545.2">The other approach is </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1546.1">lazy </span></span><span class="kobospan" id="kobo.1547.1">processing, where the work is done</span><span id="dx1-431004"/><span class="kobospan" id="kobo.1548.1"> as late as possible.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1549.1">What if we have values that are used rarely, and are very expensive to compute? </span><span class="kobospan" id="kobo.1549.2">What can we do to minimize the up-front computation, and only compute values when they are truly needed? </span><span id="x1-431005r881"/></p>
<section data-number="0.10.10.1" id="getting-ready...">
<h2 class="likechapterhead" data-number="0.10.10.1"><span><span class="kobospan" id="kobo.1550.1">7.10.1 </span></span> <span id="x1-4320001"/><span class="kobospan" id="kobo.1551.1">Getting ready...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1552.1">For background, see the</span><span id="dx1-432001"/><span class="kobospan" id="kobo.1553.1"> NIST Aerosol Particle Size case study: </span><a class="url" href="https://www.itl.nist.gov/div898/handbook/pmc/section6/pmc62.htm"><span class="url1"><span class="kobospan" id="kobo.1554.1">https://www.itl.nist.gov/div898/handbook/pmc/section6/pmc62.htm</span></span></a></p>
<p class="normal1"><span class="kobospan" id="kobo.1555.1">See the </span><a href="ch011_split_000.xhtml#x1-3890003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1556.1">Designing classes with lots of processing</span></span></a><span class="kobospan" id="kobo.1557.1"> recipe in this chapter</span><span id="dx1-432002"/><span class="kobospan" id="kobo.1558.1"> for more details</span><span id="dx1-432003"/><span class="kobospan" id="kobo.1559.1"> on this dataset. </span><span class="kobospan" id="kobo.1559.2">Rather than work with the raw data, it can help to work with summary information contained in a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1560.1">Counter</span></span></span></span><span class="kobospan" id="kobo.1561.1"> object. </span><span class="kobospan" id="kobo.1561.2">The recipe shows a mapping from particle size to number to a count of times the particular size was measured.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1562.1">We want to compute some statistics on this </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1563.1">Counter</span></span></span></span><span class="kobospan" id="kobo.1564.1">. </span><span class="kobospan" id="kobo.1564.2">We have two overall strategies for doing this:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1565.1">Extend</span></span><span class="kobospan" id="kobo.1566.1">: We covered this in detail in the </span><a href="ch011_split_001.xhtml#x1-4250009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1567.1">Extending a built-in collection</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1568.1">– a list that does statistics</span></span></a><span class="kobospan" id="kobo.1569.1"> recipe, and we will look at other examples of extending a class in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1570.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1571.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1572.1">8</span></span></a><span class="kobospan" id="kobo.1573.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1574.1">Wrap</span></span><span class="kobospan" id="kobo.1575.1">: We can wrap the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1576.1">Counter</span></span></span></span><span class="kobospan" id="kobo.1577.1"> object in another class that provides just the features we need. </span><span class="kobospan" id="kobo.1577.2">We’ll look at this in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1578.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1579.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1580.1">8</span></span></a><span class="kobospan" id="kobo.1581.1">.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1582.1">A common variation on wrapping creates a statistical computation object separate from the data collection object. </span><span class="kobospan" id="kobo.1582.2">This variation on wrapping often leads to an elegant solution.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1583.1">No matter which class architecture we choose, we also have two ways to design the processing:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1584.1">Eager</span></span><span class="kobospan" id="kobo.1585.1">: This means we’ll compute the statistics</span><span id="dx1-432004"/><span class="kobospan" id="kobo.1586.1"> as soon as possible. </span><span class="kobospan" id="kobo.1586.2">This was the approach followed in the </span><a href="ch011_split_000.xhtml#x1-3890003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1587.1">Designing classes with lots of</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1588.1">processing</span></span></a><span class="kobospan" id="kobo.1589.1"> recipe.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1590.1">Lazy</span></span><span class="kobospan" id="kobo.1591.1">: This means we won’t compute anything</span><span id="dx1-432005"/><span class="kobospan" id="kobo.1592.1"> until it’s required via a method function or property. </span><span class="kobospan" id="kobo.1592.2">In the </span><a href="ch011_split_001.xhtml#x1-4250009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1593.1">Extending a built-in collection</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1594.1">– a list that does statistics</span></span></a><span class="kobospan" id="kobo.1595.1"> recipe, we added methods to a collection class. </span><span class="kobospan" id="kobo.1595.2">These additional methods are examples of lazy calculation. </span><span class="kobospan" id="kobo.1595.3">The statistical values are computed only when required.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1596.1">The essential math for both designs is the same. </span><span class="kobospan" id="kobo.1596.2">The only question is when the computation is done. </span><span id="x1-432006r883"/></p>
</section>
<section data-number="0.10.10.2" id="how-to-do-it...-61">
<h2 class="likechapterhead" data-number="0.10.10.2"><span><span class="kobospan" id="kobo.1597.1">7.10.2 </span></span> <span id="x1-4330002"/><span class="kobospan" id="kobo.1598.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-433002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1599.1">Define the class with a descriptive name:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1600.1">
class LazyCounterStatistics:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-433006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1601.1">Write the initialization</span><span id="dx1-433007"/><span class="kobospan" id="kobo.1602.1"> method to include</span><span id="dx1-433008"/><span class="kobospan" id="kobo.1603.1"> the object to which this object will be connected. </span><span class="kobospan" id="kobo.1603.2">We’ve defined a method function that takes a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1604.1">Counter</span></span></span></span><span class="kobospan" id="kobo.1605.1"> object as an argument value. </span><span class="kobospan" id="kobo.1605.2">This </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1606.1">Counter</span></span></span></span><span class="kobospan" id="kobo.1607.1"> object is saved as part of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1608.1">Counter_Statistics</span></span></span></span><span class="kobospan" id="kobo.1609.1"> instance:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1610.1">
                                                                     

                                                                     
    def __init__(self, raw_counter: Counter[int]) -&gt; None: 
 
        self.raw_counter = raw_counter</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-433013x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1611.1">Define some useful helper methods. </span><span class="kobospan" id="kobo.1611.2">Each of these is decorated with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1612.1">@property</span></span></span></span><span class="kobospan" id="kobo.1613.1"> to make it behave like a simple attribute:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1614.1">
    @property 
 
    def sum(self) -&gt; float: 
 
        return sum( 
 
            f * v 
 
            for v, f in self.raw_counter.items() 
 
        ) 
 
    @property 
 
    def count(self) -&gt; float: 
 
        return sum( 
 
            f 
 
            for v, f in self.raw_counter.items() 
 
        )</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-433028x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1615.1">Define the required methods for the various values. </span><span class="kobospan" id="kobo.1615.2">Here’s the calculation of the mean. </span><span class="kobospan" id="kobo.1615.3">This too is decorated with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1616.1">@property</span></span></span></span><span class="kobospan" id="kobo.1617.1">. </span><span class="kobospan" id="kobo.1617.2">The other methods can be referenced as if they are attributes, even though they are proper method functions:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1618.1">
    @property 
 
    def mean(self) -&gt; float: 
 
        return self.sum / self.count</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-433034x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1619.1">Here’s how we can calculate the standard deviation. </span><span class="kobospan" id="kobo.1619.2">Note that we’ve been using </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1620.1">math.sqrt()</span></span></span></span><span class="kobospan" id="kobo.1621.1">. </span><span class="kobospan" id="kobo.1621.2">Be sure to add the required import </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1622.1">math</span></span></span></span><span class="kobospan" id="kobo.1623.1"> statement in the Python module:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1624.1">
    @property 
 
    def sum2(self) -&gt; float: 
 
        return sum( 
 
            f * v ** 2 
 
            for v, f in self.raw_counter.items() 
 
        ) 
 
    @property 
 
    def variance(self) -&gt; float: 
 
      return ( 
 
          (self.sum2 - self.sum ** 2 / self.count) / 
 
          (self.count - 1) 
 
      ) 
 
    @property 
 
    def stddev(self) -&gt; float: 
 
        return math.sqrt(self.variance)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1625.1">To show how this works, we’ll apply an instance of this class to some summarized data. </span><span class="kobospan" id="kobo.1625.2">The repository of code for this book includes a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1626.1">data/binned.csv</span></span></span></span><span class="kobospan" id="kobo.1627.1"> file that has the binned summary data. </span><span class="kobospan" id="kobo.1627.2">This data has three columns: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1628.1">size_code</span></span></span></span><span class="kobospan" id="kobo.1629.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1630.1">size</span></span></span></span><span class="kobospan" id="kobo.1631.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1632.1">frequency</span></span></span></span><span class="kobospan" id="kobo.1633.1">. </span><span class="kobospan" id="kobo.1633.2">We’re only interested in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1634.1">size_code</span></span></span></span><span class="kobospan" id="kobo.1635.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1636.1">frequency</span></span></span></span><span class="kobospan" id="kobo.1637.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1638.1">Here’s how we can build a suitable</span><span id="dx1-433051"/> <span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1639.1">Counter</span></span></span></span><span class="kobospan" id="kobo.1640.1"> object</span><span id="dx1-433052"/><span class="kobospan" id="kobo.1641.1"> from this file:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1642.1">
 
 
&gt;&gt;&gt; from pathlib import Path 
 
&gt;&gt;&gt; import csv 
 
&gt;&gt;&gt; from collections import Counter 
 
 
 
&gt;&gt;&gt; data_path = Path.cwd() / "data" / "binned.csv" 
 
&gt;&gt;&gt; with data_path.open() as data_file: 
 
... </span><span class="kobospan" id="kobo.1642.2">    reader = csv.DictReader(data_file) 
 
... </span><span class="kobospan" id="kobo.1642.3">    extract = { 
 
... </span><span class="kobospan" id="kobo.1642.4">        int(row[’size_code’]): int(row[’frequency’]) 
 
... </span><span class="kobospan" id="kobo.1642.5">        for row in reader 
 
... </span><span class="kobospan" id="kobo.1642.6">    } 
 
&gt;&gt;&gt; data = Counter(extract)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1643.1">We’ve used a dictionary comprehension to create a mapping from </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1644.1">size_code</span></span></span></span><span class="kobospan" id="kobo.1645.1"> to the frequency of that code value. </span><span class="kobospan" id="kobo.1645.2">This is then provided to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1646.1">Counter</span></span></span></span><span class="kobospan" id="kobo.1647.1"> class to build a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1648.1">Counter</span></span></span></span><span class="kobospan" id="kobo.1649.1"> object named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1650.1">data</span></span></span></span><span class="kobospan" id="kobo.1651.1"> from this existing summary.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1652.1">Here’s how we can analyze the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1653.1">Counter</span></span></span></span><span class="kobospan" id="kobo.1654.1"> object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1655.1">                                                                     

                                                                     

 
 
&gt;&gt;&gt; stats = LazyCounterStatistics(data) 
 
&gt;&gt;&gt; print(f"Mean: {stats.mean:.1f}") 
 
Mean: 10.4 
 
&gt;&gt;&gt; print(f"Standard Deviation: {stats.stddev:.2f}") 
 
Standard Deviation: 4.17</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1656.1">We provided the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1657.1">data</span></span></span></span><span class="kobospan" id="kobo.1658.1"> object to create an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1659.1">LazyCounterStatistics</span></span></span></span><span class="kobospan" id="kobo.1660.1"> class, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1661.1">stats</span></span></span></span><span class="kobospan" id="kobo.1662.1"> variable. </span><span class="kobospan" id="kobo.1662.2">When we print the value for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1663.1">stats.mean</span></span></span></span><span class="kobospan" id="kobo.1664.1"> property and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1665.1">stats.stddev</span></span></span></span><span class="kobospan" id="kobo.1666.1"> property, the methods are invoked to do the appropriate calculations of the various values.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1667.1">The cost for the computation is not paid until a client object requests the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1668.1">stats.mean</span></span></span></span><span class="kobospan" id="kobo.1669.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1670.1">stats.stddev</span></span></span></span><span class="kobospan" id="kobo.1671.1"> property values. </span><span class="kobospan" id="kobo.1671.2">This will invoke a cascade of computation to compute these values.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1672.1">When the underlying data</span><span id="dx1-433072"/><span class="kobospan" id="kobo.1673.1"> is changed, the entire computation</span><span id="dx1-433073"/><span class="kobospan" id="kobo.1674.1"> is performed again. </span><span class="kobospan" id="kobo.1674.2">This can be costly in the rare case of highly dynamic data. </span><span class="kobospan" id="kobo.1674.3">In the more common case of analyzing previously summarized data, this is quite efficient. </span><span id="x1-433074r884"/></p>
</section>
<section data-number="0.10.10.3" id="how-it-works...-61">
<h2 class="likechapterhead" data-number="0.10.10.3"><span><span class="kobospan" id="kobo.1675.1">7.10.3 </span></span> <span id="x1-4340003"/><span class="kobospan" id="kobo.1676.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1677.1">The idea of lazy calculation works out well when the value is used rarely. </span><span class="kobospan" id="kobo.1677.2">In this example, the count is computed twice as part of computing the variance and standard deviation.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1678.1">A naïve lazy design may not be optimal in some cases when values are recomputed frequently. </span><span class="kobospan" id="kobo.1678.2">This is an easy problem to fix in general. </span><span class="kobospan" id="kobo.1678.3">We can always create additional local variables to cache intermediate results instead of recomputing them. </span><span class="kobospan" id="kobo.1678.4">We’ll look at this later in this recipe.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1679.1">To make this class look like it has performed eager calculations, we used the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1680.1">@property</span></span></span></span><span class="kobospan" id="kobo.1681.1"> decorator. </span><span class="kobospan" id="kobo.1681.2">This makes a method appear to be an attribute. </span><span class="kobospan" id="kobo.1681.3">This can only work for methods that have no argument values.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1682.1">In all cases, an attribute that’s computed eagerly can be replaced by a lazy property. </span><span class="kobospan" id="kobo.1682.2">The principle reason for creating eager attribute variables is to optimize computation costs. </span><span class="kobospan" id="kobo.1682.3">In the case where a computed result may not always</span><span id="dx1-434001"/><span class="kobospan" id="kobo.1683.1"> be used, a lazy property</span><span id="dx1-434002"/><span class="kobospan" id="kobo.1684.1"> can avoid an expensive calculation. </span><span id="x1-434003r892"/></p>
</section>
<section data-number="0.10.10.4" id="theres-more...-53">
<h2 class="likechapterhead" data-number="0.10.10.4"><span><span class="kobospan" id="kobo.1685.1">7.10.4 </span></span> <span id="x1-4350004"/><span class="kobospan" id="kobo.1686.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1687.1">There are some situations in which we can further optimize a property to limit the amount of additional computation that’s done when a value changes. </span><span class="kobospan" id="kobo.1687.2">This requires a careful analysis of the use cases in order to understand the pattern of updates to the underlying data.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1688.1">In the situation where a collection is loaded with data and an analysis is performed, we can cache results to save computing them a second time. </span><span class="kobospan" id="kobo.1688.2">We might do something like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1689.1">
 
 
from typing import cast 
 
 
 
class CachingLazyCounterStatistics: 
 
    def __init__(self, raw_counter: Counter[int]) -&gt; None: 
 
        self.raw_counter = raw_counter 
 
        self._sum: float | None = None 
 
        self._count: float | None = None 
 
 
 
    @property 
 
    def sum(self) -&gt; float: 
 
        if self._sum is None: 
 
            self._sum = sum( 
 
                f * v 
 
                for v, f in self.raw_counter.items() 
 
            ) 
 
        return self._sum</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1690.1">This technique uses two attributes to save the results of the sum and count calculations, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1691.1">self._sum</span></span></span></span><span class="kobospan" id="kobo.1692.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1693.1">self._count</span></span></span></span><span class="kobospan" id="kobo.1694.1">. </span><span class="kobospan" id="kobo.1694.2">These values will be computed once and returned as often as needed with no additional cost for recalculation.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1695.1">The type hints show these attributes</span><span id="dx1-435018"/><span class="kobospan" id="kobo.1696.1"> as being optional. </span><span class="kobospan" id="kobo.1696.2">Once the values for </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1697.1">self._sum</span></span></span></span><span class="kobospan" id="kobo.1698.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1699.1">self._count</span></span></span></span><span class="kobospan" id="kobo.1700.1"> have been computed, the values are no longer optional, but will be present. </span><span class="kobospan" id="kobo.1700.2">We describe</span><span id="dx1-435019"/><span class="kobospan" id="kobo.1701.1"> this to tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1702.1">mypy </span></span><span class="kobospan" id="kobo.1703.1">with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1704.1">cast()</span></span></span></span><span class="kobospan" id="kobo.1705.1"> type hint. </span><span class="kobospan" id="kobo.1705.2">This hint tells type-checking tools to consider </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1706.1">self._sum</span></span></span></span><span class="kobospan" id="kobo.1707.1"> as being a float object, not a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1708.1">float</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1709.1"> |</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1710.1"> None</span></span></span></span><span class="kobospan" id="kobo.1711.1"> object. </span><span class="kobospan" id="kobo.1711.2">There’s no cost to this function as it does nothing; its purpose is to annotate the processing to show the design intent.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1712.1">This caching optimization is helpful if the state of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1713.1">raw_counter</span></span></span></span><span class="kobospan" id="kobo.1714.1"> object never changes. </span><span class="kobospan" id="kobo.1714.2">In an application that updates the underlying </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1715.1">Counter</span></span></span></span><span class="kobospan" id="kobo.1716.1">, this cached value would become out of date. </span><span class="kobospan" id="kobo.1716.2">That kind of application would need to reset the internal cache values of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1717.1">self._sum</span></span></span></span><span class="kobospan" id="kobo.1718.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1719.1">self._count</span></span></span></span><span class="kobospan" id="kobo.1720.1"> when the underlying </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1721.1">Counter</span></span></span></span><span class="kobospan" id="kobo.1722.1"> is updated. </span><span id="x1-435020r893"/></p>
</section>
<section data-number="0.10.10.5" id="see-also...">
<h2 class="likechapterhead" data-number="0.10.10.5"><span><span class="kobospan" id="kobo.1723.1">7.10.5 </span></span> <span id="x1-4360005"/><span class="kobospan" id="kobo.1724.1">See also...</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1725.1">In the </span><a href="ch011_split_000.xhtml#x1-3890003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1726.1">Designing classes with lots of processing</span></span></a><span class="kobospan" id="kobo.1727.1"> recipe, we defined a class that eagerly computed a number of attributes. </span><span class="kobospan" id="kobo.1727.2">This represents a different strategy for managing the cost of the computation.</span></p></li>
</ul>
<p class="normal1"><span id="x1-436001r882"/></p>
</section>
</section>
<section data-number="0.10.11" id="creating-contexts-and-context-managers">
<h1 class="unnumbered" data-number="0.10.11"><span><span class="kobospan" id="kobo.1728.1">7.11 </span></span> <span id="x1-43700011"/><span class="kobospan" id="kobo.1729.1">Creating contexts and context managers</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1730.1">A number of Python</span><span id="dx1-437001"/><span class="kobospan" id="kobo.1731.1"> objects behave like context</span><span id="dx1-437002"/><span class="kobospan" id="kobo.1732.1"> managers. </span><span class="kobospan" id="kobo.1732.2">Some of the most visible examples are file objects. </span><span class="kobospan" id="kobo.1732.3">We generally use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1733.1">with</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1734.1"> path.open()</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1735.1"> as</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1736.1"> file:</span></span></span></span><span class="kobospan" id="kobo.1737.1"> to process a file in a context that can guarantee the resources are released. </span><span class="kobospan" id="kobo.1737.2">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1738.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1739.1"> </span></span><a href="ch006_split_000.xhtml#x1-840002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1740.1">2</span></span></a><span class="kobospan" id="kobo.1741.1">, the </span><a href="ch006_split_001.xhtml#x1-15200011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1742.1">Managing a context using the with statement</span></span></a><span class="kobospan" id="kobo.1743.1"> recipe covers the basics of using a file-based context manager.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1744.1">How can we create our own classes that act as context managers? </span><span id="x1-437003r895"/></p>
<section data-number="0.10.11.1" id="getting-ready-61">
<h2 class="likechapterhead" data-number="0.10.11.1"><span><span class="kobospan" id="kobo.1745.1">7.11.1 </span></span> <span id="x1-4380001"/><span class="kobospan" id="kobo.1746.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1747.1">We’ll look at a function from </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1748.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1749.1"> </span></span><a href="ch007_split_000.xhtml#x1-1610003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1750.1">3</span></span></a><span class="kobospan" id="kobo.1751.1">, in the </span><a href="ch007_split_001.xhtml#x1-1940006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1752.1">Picking an order for</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1753.1">parameters based on partial functions</span></span></a><span class="kobospan" id="kobo.1754.1"> recipe. </span><span class="kobospan" id="kobo.1754.2">This recipe introduced a function, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1755.1">haversine()</span></span></span></span><span class="kobospan" id="kobo.1756.1">, which has a context-like parameter used to adjust the answer from dimensionless radians to a useful unit of measure, such as kilometers, nautical miles, or US statute miles. </span><span class="kobospan" id="kobo.1756.2">In many ways, this distance factor is a kind of context, used to define the kinds of computations that are done.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1757.1">What we want is to be able to use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1758.1">with</span></span></span></span><span class="kobospan" id="kobo.1759.1"> statement to describe an object that doesn’t change very quickly; indeed the change acts as a kind of boundary, defining the scope of computations. </span><span class="kobospan" id="kobo.1759.2">We might want to use code like the following:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1760.1">
 
 
&gt;&gt;&gt; with Distance(r=NM) as nm_dist: 
 
... </span><span class="kobospan" id="kobo.1760.2">    print(f"{nm_dist(p1, p2)=:.2f}") 
 
... </span><span class="kobospan" id="kobo.1760.3">    print(f"{nm_dist(p2, p3)=:.2f}") 
 
nm_dist(p1, p2)=39.72 
 
nm_dist(p2, p3)=30.74</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1761.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1762.1">Distance(r=NM)</span></span></span></span><span class="kobospan" id="kobo.1763.1"> constructor provides the definition of the context, creating a new object, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1764.1">nm_dist</span></span></span></span><span class="kobospan" id="kobo.1765.1">, that has been configured to perform the required calculation in nautical miles. </span><span class="kobospan" id="kobo.1765.2">This can be used only within the body of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1766.1">with</span></span></span></span><span class="kobospan" id="kobo.1767.1"> statement.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1768.1">This </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1769.1">Distance</span></span></span></span><span class="kobospan" id="kobo.1770.1"> class definition can be seen as creating a partial function, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1771.1">nm_dist()</span></span></span></span><span class="kobospan" id="kobo.1772.1">. </span><span class="kobospan" id="kobo.1772.2">This function provides a fixed unit-of-measure parameter, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1773.1">r</span></span></span></span><span class="kobospan" id="kobo.1774.1">, for a number of following computations using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1775.1">haversine()</span></span></span></span><span class="kobospan" id="kobo.1776.1"> function.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1777.1">There are a number of other ways</span><span id="dx1-438007"/><span class="kobospan" id="kobo.1778.1"> to create partial</span><span id="dx1-438008"/><span class="kobospan" id="kobo.1779.1"> functions, including a lambda object, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1780.1">functools.partial()</span></span></span></span><span class="kobospan" id="kobo.1781.1"> function, and callable objects. </span><span class="kobospan" id="kobo.1781.2">We looked at the partial function alternative in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1782.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1783.1"> </span></span><a href="ch007_split_000.xhtml#x1-1610003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1784.1">3</span></span></a><span class="kobospan" id="kobo.1785.1">, in the </span><a href="ch007_split_001.xhtml#x1-1940006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1786.1">Picking an order for</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1787.1">parameters based on partial functions</span></span></a><span class="kobospan" id="kobo.1788.1"> recipe. </span><span id="x1-438009r897"/></p>
</section>
<section data-number="0.10.11.2" id="how-to-do-it...-62">
<h2 class="likechapterhead" data-number="0.10.11.2"><span><span class="kobospan" id="kobo.1789.1">7.11.2 </span></span> <span id="x1-4390002"/><span class="kobospan" id="kobo.1790.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1791.1">A context manager class has two special methods that we need to define:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-439002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1792.1">Start with a meaningful class name:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1793.1">
class Distance:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-439006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1794.1">Define an initializer that creates any unique features of the context. </span><span class="kobospan" id="kobo.1794.2">In this case, we want to set the units of distance that are used:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1795.1">
    def __init__(self, r: float) -&gt; None: 
 
        self.r = r</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-439011x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1796.1">Define the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1797.1">__enter__()</span></span></span></span><span class="kobospan" id="kobo.1798.1"> method. </span><span class="kobospan" id="kobo.1798.2">This is called when the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1799.1">with</span></span></span></span><span class="kobospan" id="kobo.1800.1"> statement block begins. </span><span class="kobospan" id="kobo.1800.2">The statement </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1801.1">with</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1802.1"> Distance(r=NM)</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1803.1"> as</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1804.1"> nm_dist</span></span></span></span><span class="kobospan" id="kobo.1805.1"> does two things. </span><span class="kobospan" id="kobo.1805.2">First, it creates the instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1806.1">Distance</span></span></span></span><span class="kobospan" id="kobo.1807.1"> class, then it calls the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1808.1">__enter__()</span></span></span></span><span class="kobospan" id="kobo.1809.1"> method of that object to start the context. </span><span class="kobospan" id="kobo.1809.2">The return value from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1810.1">__enter__()</span></span></span></span><span class="kobospan" id="kobo.1811.1"> method is assigned to a local variable via the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1812.1">as</span></span></span></span><span class="kobospan" id="kobo.1813.1"> clause. </span><span class="kobospan" id="kobo.1813.2">This isn’t always required. </span><span class="kobospan" id="kobo.1813.3">For simple cases, the context manager often returns itself. </span><span class="kobospan" id="kobo.1813.4">If this method needs to return an instance in the same class, note that the class hasn’t been fully defined yet, and the class name type hint must be provided as a string. </span><span class="kobospan" id="kobo.1813.5">For this recipe, we’ll return a function, with the type hint based on </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1814.1">Callable</span></span></span></span><span class="kobospan" id="kobo.1815.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1816.1">
    def __enter__(self) -&gt; Callable[[Point, Point], float]: 
 
        return self.distance</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-439016x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1817.1">Define the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1818.1">__exit__()</span></span></span></span><span class="kobospan" id="kobo.1819.1"> method. </span><span class="kobospan" id="kobo.1819.2">When the context</span><span id="dx1-439017"/><span class="kobospan" id="kobo.1820.1"> finishes, this method</span><span id="dx1-439018"/><span class="kobospan" id="kobo.1821.1"> is invoked. </span><span class="kobospan" id="kobo.1821.2">This is where resources are released and cleanup can happen. </span><span class="kobospan" id="kobo.1821.3">In this example, nothing more needs to be done. </span><span class="kobospan" id="kobo.1821.4">The details of any exception are provided to this method; the method can silence the exception or allow it to propagate. </span><span class="kobospan" id="kobo.1821.5">If the return value from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1822.1">__exit__()</span></span></span></span><span class="kobospan" id="kobo.1823.1"> method is </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1824.1">True</span></span></span></span><span class="kobospan" id="kobo.1825.1">, the exception is silenced. </span><span class="kobospan" id="kobo.1825.2">A return value of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1826.1">False</span></span></span></span><span class="kobospan" id="kobo.1827.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1828.1">None</span></span></span></span><span class="kobospan" id="kobo.1829.1"> will allow the exception to be seen outside the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1830.1">with</span></span></span></span><span class="kobospan" id="kobo.1831.1"> statement:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1832.1">
    def __exit__( 
 
        self, 
 
        exc_type: type[Exception] | None, 
 
        exc_val: Exception | None, 
 
        exc_tb: TracebackType | None 
 
    ) -&gt; bool | None: 
 
        return None</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-439028x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1833.1">Create a class (or define the methods of this class) that works within the context. </span><span class="kobospan" id="kobo.1833.2">In this case, the method will make use of a separately defined </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1834.1">haversine()</span></span></span></span><span class="kobospan" id="kobo.1835.1"> function from </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1836.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1837.1"> </span></span><a href="ch007_split_000.xhtml#x1-1610003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1838.1">3</span></span></a><span class="kobospan" id="kobo.1839.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1840.1">
    def distance(self, p1: Point, p2: Point) -&gt; float: 
 
        return haversine( 
 
            p1.lat, p1.lon, p2.lat, p2.lon, R=self.r 
 
        )</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1841.1">Most context-manager classes require a fairly large number of imports:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1842.1">
 
 
from collections.abc import Callable 
 
from types import TracebackType 
 
from typing import NamedTuple</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1843.1">This class has been defined</span><span id="dx1-439038"/><span class="kobospan" id="kobo.1844.1"> to work with objects</span><span id="dx1-439039"/><span class="kobospan" id="kobo.1845.1"> of the class </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1846.1">Point</span></span></span></span><span class="kobospan" id="kobo.1847.1">. </span><span class="kobospan" id="kobo.1847.2">This can be a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1848.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.1849.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1850.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.1851.1">, or some other class that provides the required two attributes. </span><span class="kobospan" id="kobo.1851.2">Here’s the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1852.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.1853.1"> definition:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1854.1">
 
 
class Point(NamedTuple): 
 
    lat: float 
 
    lon: float</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1855.1">This class definition provides a class, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1856.1">Point</span></span></span></span><span class="kobospan" id="kobo.1857.1">, with the required attribute names. </span><span id="x1-439044r899"/></p>
</section>
<section data-number="0.10.11.3" id="how-it-works...-62">
<h2 class="likechapterhead" data-number="0.10.11.3"><span><span class="kobospan" id="kobo.1858.1">7.11.3 </span></span> <span id="x1-4400003"/><span class="kobospan" id="kobo.1859.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1860.1">The context manager relies on the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1861.1">with</span></span></span></span><span class="kobospan" id="kobo.1862.1"> statement doing a large number of things.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1863.1">We’ll put the following construct under a microscope:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1864.1">
 
 
&gt;&gt;&gt; p1 = Point(38.9784, -76.4922) 
 
&gt;&gt;&gt; p2 = Point(36.8443, -76.2922) 
 
&gt;&gt;&gt; nm_distance = Distance(r=NM) 
 
&gt;&gt;&gt; with nm_distance as nm_calc: 
 
... </span><span class="kobospan" id="kobo.1864.2">    print(f"{nm_calc(p1, p2)=:.2f}") 
 
nm_calc(p1, p2)=128.48</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1865.1">The first line creates an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1866.1">Distance</span></span></span></span><span class="kobospan" id="kobo.1867.1"> class. </span><span class="kobospan" id="kobo.1867.2">This has a value for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1868.1">r</span></span></span></span><span class="kobospan" id="kobo.1869.1"> parameter equal to the constant </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1870.1">NM</span></span></span></span><span class="kobospan" id="kobo.1871.1">, allowing us to do computations in nautical miles. </span><span class="kobospan" id="kobo.1871.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1872.1">Distance</span></span></span></span><span class="kobospan" id="kobo.1873.1"> instance is assigned to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1874.1">nm_distance</span></span></span></span><span class="kobospan" id="kobo.1875.1"> variable.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1876.1">When the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1877.1">with</span></span></span></span><span class="kobospan" id="kobo.1878.1"> statement starts execution, the context manager object is notified by having the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1879.1">__enter__()</span></span></span></span><span class="kobospan" id="kobo.1880.1"> method executed. </span><span class="kobospan" id="kobo.1880.2">In this case, the value returned by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1881.1">__enter__()</span></span></span></span><span class="kobospan" id="kobo.1882.1"> method is a function, with the type </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1883.1">Callable[[Point,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1884.1"> Point],</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1885.1"> float]</span></span></span></span><span class="kobospan" id="kobo.1886.1">. </span><span class="kobospan" id="kobo.1886.2">The function accepts two </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1887.1">Point</span></span></span></span><span class="kobospan" id="kobo.1888.1"> objects and returns a floating-point result. </span><span class="kobospan" id="kobo.1888.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1889.1">as</span></span></span></span><span class="kobospan" id="kobo.1890.1"> clause assigns this function object to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1891.1">nm_calc</span></span></span></span><span class="kobospan" id="kobo.1892.1"> name.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1893.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1894.1">print()</span></span></span></span><span class="kobospan" id="kobo.1895.1"> function does its work using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1896.1">nm_calc</span></span></span></span><span class="kobospan" id="kobo.1897.1"> object. </span><span class="kobospan" id="kobo.1897.2">The object is a function that will compute a distance from two </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1898.1">Point</span></span></span></span><span class="kobospan" id="kobo.1899.1"> instances.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1900.1">When the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1901.1">with</span></span></span></span><span class="kobospan" id="kobo.1902.1"> statement finishes, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1903.1">__exit__()</span></span></span></span><span class="kobospan" id="kobo.1904.1"> method will be executed. </span><span class="kobospan" id="kobo.1904.2">For more complex context managers, this may involve closing files or releasing network connections. </span><span class="kobospan" id="kobo.1904.3">There are a great many kinds of context cleanup that might be necessary. </span><span class="kobospan" id="kobo.1904.4">In this case, there’s nothing that needs to be done to clean up the context.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1905.1">This has the advantage of defining</span><span id="dx1-440008"/><span class="kobospan" id="kobo.1906.1"> a fixed boundary</span><span id="dx1-440009"/><span class="kobospan" id="kobo.1907.1"> in which the partial function is used. </span><span class="kobospan" id="kobo.1907.2">In some cases, the computation inside the context manager might involve a database or complex web services, leading to a more complex </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1908.1">__exit__()</span></span></span></span><span class="kobospan" id="kobo.1909.1"> method. </span><span id="x1-440010r907"/></p>
</section>
<section data-number="0.10.11.4" id="theres-more">
<h2 class="likechapterhead" data-number="0.10.11.4"><span><span class="kobospan" id="kobo.1910.1">7.11.4 </span></span> <span id="x1-4410004"/><span class="kobospan" id="kobo.1911.1">There’s more…</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1912.1">The operation of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1913.1">__exit__()</span></span></span></span><span class="kobospan" id="kobo.1914.1"> method is central</span><span id="dx1-441001"/><span class="kobospan" id="kobo.1915.1"> to making best use of a context manager. </span><span class="kobospan" id="kobo.1915.2">In the previous example, we use the following ”do nothing” </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1916.1">__exit__()</span></span></span></span><span class="kobospan" id="kobo.1917.1"> method:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1918.1">
 
 
    def __exit__( 
 
        self, 
 
        exc_type: type[Exception] | None, 
 
        exc_val: Exception | None, 
 
        exc_tb: TracebackType | None 
 
    ) -&gt; bool | None: 
 
        # Cleanup goes here. 
 
        return None
                                                                     

                                                                     </span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1919.1">The point here is to allow any exception to propagate normally. </span><span class="kobospan" id="kobo.1919.2">We often see any cleanup processing replacing the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1920.1">#</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1921.1"> Cleanup</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1922.1"> goes</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1923.1"> here.</span></span></span></span><span class="kobospan" id="kobo.1924.1"> comment. </span><span class="kobospan" id="kobo.1924.2">This is where buffers are flushed, files are closed, and error log messages are written.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1925.1">Sometimes, we’ll need to handle specific exception details. </span><span class="kobospan" id="kobo.1925.2">Consider the following snippet of an interactive session:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1926.1">
 
 
&gt;&gt;&gt; p1 = Point(38.9784, -76.4922) 
 
&gt;&gt;&gt; p2 = Point(36.8443, -76.2922) 
 
&gt;&gt;&gt; with Distance(None) as nm_dist: 
 
... </span><span class="kobospan" id="kobo.1926.2">    print(f"{nm_dist(p1, p2)=:.2f}") 
 
Traceback (most recent call last): 
 
... 
 
TypeError: unsupported operand type(s) for *: ’NoneType’ and ’int’</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1927.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1928.1">Distance</span></span></span></span><span class="kobospan" id="kobo.1929.1"> object was initialized with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1930.1">r</span></span></span></span><span class="kobospan" id="kobo.1931.1"> argument value set to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1932.1">None</span></span></span></span><span class="kobospan" id="kobo.1933.1">. </span><span class="kobospan" id="kobo.1933.2">While this code will lead</span><span id="dx1-441019"/><span class="kobospan" id="kobo.1934.1"> to warnings from tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1935.1">mypy</span></span><span class="kobospan" id="kobo.1936.1">, it’s syntactically valid. </span><span class="kobospan" id="kobo.1936.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1937.1">TypeError</span></span></span></span><span class="kobospan" id="kobo.1938.1"> traceback, however, doesn’t point to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1939.1">Distance</span></span></span></span><span class="kobospan" id="kobo.1940.1">; it points to a line of code within the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1941.1">haversine()</span></span></span></span><span class="kobospan" id="kobo.1942.1"> function.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1943.1">We might want to report a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1944.1">ValueError</span></span></span></span><span class="kobospan" id="kobo.1945.1"> instead of this </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1946.1">TypeError</span></span></span></span><span class="kobospan" id="kobo.1947.1">. </span><span class="kobospan" id="kobo.1947.2">Here’s a variation on the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1948.1">Distance</span></span></span></span><span class="kobospan" id="kobo.1949.1"> class, which conceals the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1950.1">TypeError</span></span></span></span><span class="kobospan" id="kobo.1951.1">, replacing it with a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1952.1">ValueError</span></span></span></span><span class="kobospan" id="kobo.1953.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1954.1">
 
 
class Distance_2: 
 
    def __init__(self, r: float) -&gt; None: 
 
        self.r = r 
 
 
 
    def __enter__(self) -&gt; Callable[[Point, Point], float]: 
 
        return self.distance 
 
 
 
    def __exit__( 
 
        self, 
 
        exc_type: type[Exception] | None, 
 
        exc_val: Exception | None, 
 
        exc_tb: TracebackType | None 
 
    ) -&gt; bool | None: 
 
        if exc_type is TypeError: 
 
            raise ValueError(f"Invalid r={self.r!r}") 
 
        return None 
 
 
 
    def distance(self, p1: Point, p2: Point) -&gt; float: 
 
        return haversine(p1.lat, p1.lon, p2.lat, p2.lon, R=self.r)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1955.1">This shows how we can examine the details of the exception in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1956.1">__exit__()</span></span></span></span><span class="kobospan" id="kobo.1957.1"> method. </span><span class="kobospan" id="kobo.1957.2">The information provided parallels the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1958.1">sys.exc_info()</span></span></span></span><span class="kobospan" id="kobo.1959.1"> function, and includes the exception’s type, the exception object, and a traceback object with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1960.1">types.TracebackType</span></span></span></span><span class="kobospan" id="kobo.1961.1"> type. </span><span id="x1-441040r909"/></p>
</section>
<section data-number="0.10.11.5" id="see-also-60">
<h2 class="likechapterhead" data-number="0.10.11.5"><span><span class="kobospan" id="kobo.1962.1">7.11.5 </span></span> <span id="x1-4420005"/><span class="kobospan" id="kobo.1963.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1964.1">In the </span><a href="ch006_split_001.xhtml#x1-15200011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1965.1">Managing a context using the with statement</span></span></a><span class="kobospan" id="kobo.1966.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1967.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1968.1"> </span></span><a href="ch006_split_000.xhtml#x1-840002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1969.1">2</span></span></a><span class="kobospan" id="kobo.1970.1">, we cover the basics of using a file-based context manager.</span></p></li>
</ul>
<p class="normal1"><span id="x1-442001r896"/></p>
</section>
</section>
<section data-number="0.10.12" id="managing-multiple-contexts-with-multiple-resources">
<h1 class="unnumbered" data-number="0.10.12"><span><span class="kobospan" id="kobo.1971.1">7.12 </span></span> <span id="x1-44300012"/><span class="kobospan" id="kobo.1972.1">Managing multiple contexts with multiple resources</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1973.1">We often use context managers</span><span id="dx1-443001"/><span class="kobospan" id="kobo.1974.1"> with open files. </span><span class="kobospan" id="kobo.1974.2">Because the context manager can guarantee the OS resources are released, doing so prevents resource leaks. </span><span class="kobospan" id="kobo.1974.3">It can be used to prevent files from being closed without having all buffers flushed to persistent storage.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1975.1">When multiple resources are being processed, it often means multiple context managers will be needed. </span><span class="kobospan" id="kobo.1975.2">For example, if we have three open files, we could require three nested </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1976.1">with</span></span></span></span><span class="kobospan" id="kobo.1977.1"> statements? </span><span class="kobospan" id="kobo.1977.2">How can we optimize or simplify multiple </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1978.1">with</span></span></span></span><span class="kobospan" id="kobo.1979.1"> statements? </span><span id="x1-443002r913"/></p>
<section data-number="0.10.12.1" id="getting-ready-62">
<h2 class="likechapterhead" data-number="0.10.12.1"><span><span class="kobospan" id="kobo.1980.1">7.12.1 </span></span> <span id="x1-4440001"/><span class="kobospan" id="kobo.1981.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1982.1">We’ll look at creating a plan for a journey with multiple legs. </span><span class="kobospan" id="kobo.1982.2">Our starting data collection is a list of points that define our route. </span><span class="kobospan" id="kobo.1982.3">For example, traveling through Chesapeake Bay may involve starting in Annapolis, Maryland, sailing to Solomon’s Island, Deltaville, Virginia, and then Norfolk, Virginia. </span><span class="kobospan" id="kobo.1982.4">For planning purposes, we’d like to think of this as three legs, instead of four points. </span><span class="kobospan" id="kobo.1982.5">A leg has a distance and takes time to traverse: computing time, speed, and distance is the essence of the planning problem.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1983.1">We’ll start with some foundational definitions before we run the recipe. </span><span class="kobospan" id="kobo.1983.2">First is the definition of a single point, with attributes of latitude and longitude:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1984.1">
 
 
@dataclass(frozen=True) 
 
class Point: 
 
    lat: float 
 
    lon: float</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1985.1">A point can be built with a statement like this: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1986.1">p</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1987.1"> =</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1988.1"> Point(38.9784,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1989.1"> -76.4922)</span></span></span></span><span class="kobospan" id="kobo.1990.1">. </span><span class="kobospan" id="kobo.1990.2">This lets us refer to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1991.1">p.lat</span></span></span></span><span class="kobospan" id="kobo.1992.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1993.1">p.lon</span></span></span></span><span class="kobospan" id="kobo.1994.1"> in subsequent computations. </span><span class="kobospan" id="kobo.1994.2">The use of attribute names makes the code much easier to read.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1995.1">A leg is a pair of points. </span><span class="kobospan" id="kobo.1995.2">We can define it as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1996.1">
 
 
@dataclass 
 
class Leg: 
 
    start: Point 
 
    end: Point 
 
    distance: float = field(init=False)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1997.1">We’ve created this as a mutable</span><span id="dx1-444012"/><span class="kobospan" id="kobo.1998.1"> object. </span><span class="kobospan" id="kobo.1998.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1999.1">distance</span></span></span></span><span class="kobospan" id="kobo.2000.1"> attribute has an initial value defined by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2001.1">dataclasses.field()</span></span></span></span><span class="kobospan" id="kobo.2002.1"> function. </span><span class="kobospan" id="kobo.2002.2">The use of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2003.1">init=False</span></span></span></span><span class="kobospan" id="kobo.2004.1"> means the attribute is not provided when the object is initialized; it must be supplied after initialization.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2005.1">Here’s a context manager to create </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2006.1">Leg</span></span></span></span><span class="kobospan" id="kobo.2007.1"> objects from </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2008.1">Point</span></span></span></span><span class="kobospan" id="kobo.2009.1"> instances. </span><span class="kobospan" id="kobo.2009.2">This is similar to the context managers shown in the </span><a href="ch011_split_001.xhtml#x1-43700011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.2010.1">Creating contexts and context</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.2011.1">managers</span></span></a><span class="kobospan" id="kobo.2012.1"> recipe. </span><span class="kobospan" id="kobo.2012.2">There is a tiny but important difference here. </span><span class="kobospan" id="kobo.2012.3">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2013.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.2014.1"> saves a value for </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2015.1">self.r</span></span></span></span><span class="kobospan" id="kobo.2016.1"> to set the distance unit context. </span><span class="kobospan" id="kobo.2016.2">The default value is nautical miles:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2017.1">
 
 
 
 
from types import TracebackType 
 
 
 
class LegMaker: 
 
    def __init__(self, r: float=NM) -&gt; None: 
 
        self.last_point: Point | None = None 
 
        self.last_leg: Leg | None = None 
 
        self.r = r 
 
 
 
    def __enter__(self) -&gt; "LegMaker": 
 
        return self 
 
 
 
    def __exit__( 
 
        self, 
 
        exc_type: type[Exception] | None, 
 
        exc_val: Exception | None, 
 
        exc_tb: TracebackType | None 
 
    ) -&gt; bool | None: 
 
        return None</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.2018.1">The important method, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2019.1">waypoint()</span></span></span></span><span class="kobospan" id="kobo.2020.1">, accepts a waypoint</span><span id="dx1-444033"/><span class="kobospan" id="kobo.2021.1"> and creates a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2022.1">Leg</span></span></span></span><span class="kobospan" id="kobo.2023.1"> object. </span><span class="kobospan" id="kobo.2023.2">The very first waypoint, the starting point for the voyage, will return </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2024.1">None</span></span></span></span><span class="kobospan" id="kobo.2025.1">. </span><span class="kobospan" id="kobo.2025.2">All subsequent points will return a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2026.1">Leg</span></span></span></span><span class="kobospan" id="kobo.2027.1"> object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2028.1">
 
 
    def waypoint(self, next_point: Point) -&gt; Leg | None: 
 
        leg: Leg | None 
 
        if self.last_point is None: 
 
            # Special case for the first leg 
 
            self.last_point = next_point 
 
            leg = None 
 
        else: 
 
            leg = Leg(self.last_point, next_point) 
 
            d = haversine( 
 
                leg.start.lat, leg.start.lon, 
 
                leg.end.lat, leg.end.lon, 
 
                R=self.r 
 
            ) 
 
            leg.distance = round(d) 
 
            self.last_point = next_point 
 
        return leg</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.2029.1">This method uses a cached </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2030.1">Point</span></span></span></span><span class="kobospan" id="kobo.2031.1"> object, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2032.1">self.last_point</span></span></span></span><span class="kobospan" id="kobo.2033.1">, and the next point, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2034.1">next_point</span></span></span></span><span class="kobospan" id="kobo.2035.1">, to create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2036.1">Leg</span></span></span></span><span class="kobospan" id="kobo.2037.1"> instance and then update that instance.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2038.1">If we want to create an output file in CSV format, we’ll need to use two context managers: one to create </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2039.1">Leg</span></span></span></span><span class="kobospan" id="kobo.2040.1"> objects, and another to manage the open file. </span><span class="kobospan" id="kobo.2040.2">We’ll put this complex multi-context processing into a single function. </span><span id="x1-444051r915"/></p>
</section>
<section data-number="0.10.12.2" id="how-to-do-it...-63">
<h2 class="likechapterhead" data-number="0.10.12.2"><span><span class="kobospan" id="kobo.2041.1">7.12.2 </span></span> <span id="x1-4450002"/><span class="kobospan" id="kobo.2042.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-445002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2043.1">We’ll be working with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2044.1">csv</span></span></span></span><span class="kobospan" id="kobo.2045.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2046.1">pathlib</span></span></span></span><span class="kobospan" id="kobo.2047.1"> modules. </span><span class="kobospan" id="kobo.2047.2">Additionally, this recipe will also make use of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2048.1">Iterable</span></span></span></span><span class="kobospan" id="kobo.2049.1"> type hint, and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2050.1">asdict</span></span></span></span><span class="kobospan" id="kobo.2051.1"> function from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2052.1">dataclasses</span></span></span></span><span class="kobospan" id="kobo.2053.1"> module:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2054.1">
from collections.abc import Iterable 
 
import csv 
 
from dataclasses import asdict 
 
from pathlib import Path</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-445009x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2055.1">Since we’ll be creating a CSV file, we need to define the headers to be used for the CSV output:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2056.1">
HEADERS = ["start_lat", "start_lon", "end_lat", "end_lon", "distance"]</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-445013x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2057.1">Define a function to transform</span><span id="dx1-445014"/><span class="kobospan" id="kobo.2058.1"> complex objects into a dictionary suitable for writing each individual row. </span><span class="kobospan" id="kobo.2058.2">The input is a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2059.1">Leg</span></span></span></span><span class="kobospan" id="kobo.2060.1"> object; the output is a dictionary with keys that match the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2061.1">HEADERS</span></span></span></span><span class="kobospan" id="kobo.2062.1"> list of column names:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2063.1">
def flat_dict(leg: Leg) -&gt; dict[str, float]: 
 
    struct = asdict(leg) 
 
    return dict( 
 
        start_lat=struct["start"]["lat"], 
 
        start_lon=struct["start"]["lon"], 
 
        end_lat=struct["end"]["lat"], 
 
        end_lon=struct["end"]["lon"], 
 
        distance=struct["distance"], 
 
    )</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-445026x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2064.1">Define the function with a meaningful name. </span><span class="kobospan" id="kobo.2064.2">We’ll provide two parameters: a list of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2065.1">Point</span></span></span></span><span class="kobospan" id="kobo.2066.1"> objects and a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2067.1">Path</span></span></span></span><span class="kobospan" id="kobo.2068.1"> object showing where the CSV file should be created. </span><span class="kobospan" id="kobo.2068.2">We’ve used </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2069.1">Iterable[Point]</span></span></span></span><span class="kobospan" id="kobo.2070.1"> as a type hint so this function can accept any iterable collection of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2071.1">Point</span></span></span></span><span class="kobospan" id="kobo.2072.1"> instances:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2073.1">
def make_route_file( 
 
    points: Iterable[Point], target: Path 
 
) -&gt; None:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-445032x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2074.1">Start the two contexts with a single </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2075.1">with</span></span></span></span><span class="kobospan" id="kobo.2076.1"> statement. </span><span class="kobospan" id="kobo.2076.2">This will invoke both </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2077.1">__enter__()</span></span></span></span><span class="kobospan" id="kobo.2078.1"> methods to prepare both contexts for work. </span><span class="kobospan" id="kobo.2078.2">This line can get long:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2079.1">
    with ( 
 
        LegMaker(r=NM) as legger, 
 
        target.open(’w’, newline=’’) as csv_file 
 
    ):</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-445039x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2080.1">Once the contexts are ready for work, we can create a CSV writer and begin writing rows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2081.1">
        writer = csv.DictWriter(csv_file, HEADERS) 
 
        writer.writeheader() 
 
        for point in points: 
 
            leg = legger.waypoint(point) 
 
            if leg is not None: 
 
                writer.writerow(flat_dict(leg))</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-445048x7" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2082.1">At the end of the context, do any final summary</span><span id="dx1-445049"/><span class="kobospan" id="kobo.2083.1"> processing. </span><span class="kobospan" id="kobo.2083.2">This is not indented within the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2084.1">with</span></span></span></span><span class="kobospan" id="kobo.2085.1"> statement’s body; it is at the same indentation level as the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2086.1">with</span></span></span></span><span class="kobospan" id="kobo.2087.1"> keyword itself:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2088.1">
        print(f"Finished creating {target}")</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.2089.1">By keeping this </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.2090.1">outside </span></span><span class="kobospan" id="kobo.2091.1">the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2092.1">with</span></span></span></span><span class="kobospan" id="kobo.2093.1"> context, this message provides important evidence that the files were properly closed and all of the computations were completed.</span></p>
</div></li>
</ol>
<p class="normal1"><span id="x1-445052r920"/></p>
</section>
<section data-number="0.10.12.3" id="how-it-works...-63">
<h2 class="likechapterhead" data-number="0.10.12.3"><span><span class="kobospan" id="kobo.2094.1">7.12.3 </span></span> <span id="x1-4460003"/><span class="kobospan" id="kobo.2095.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.2096.1">The compound </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2097.1">with</span></span></span></span><span class="kobospan" id="kobo.2098.1"> statement created a number of context managers for us. </span><span class="kobospan" id="kobo.2098.2">All of the managers will have their </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2099.1">__enter__()</span></span></span></span><span class="kobospan" id="kobo.2100.1"> methods used to both start processing and, optionally, return an object usable within the context. </span><span class="kobospan" id="kobo.2100.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2101.1">LegMaker</span></span></span></span><span class="kobospan" id="kobo.2102.1"> class defined an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2103.1">__enter__()</span></span></span></span><span class="kobospan" id="kobo.2104.1"> method that returned the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2105.1">LegMaker</span></span></span></span><span class="kobospan" id="kobo.2106.1"> instance. </span><span class="kobospan" id="kobo.2106.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2107.1">Path.open()</span></span></span></span><span class="kobospan" id="kobo.2108.1"> method returns a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2109.1">TextIO</span></span></span></span><span class="kobospan" id="kobo.2110.1"> object; these are also context managers.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2111.1">When the context exits at the end of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2112.1">with</span></span></span></span><span class="kobospan" id="kobo.2113.1"> statement, all of the context manager </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2114.1">__exit__()</span></span></span></span><span class="kobospan" id="kobo.2115.1"> methods are called. </span><span class="kobospan" id="kobo.2115.2">This allows each context manager to do any finalization. </span><span class="kobospan" id="kobo.2115.3">In the case of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2116.1">TextIO</span></span></span></span><span class="kobospan" id="kobo.2117.1"> objects, this closes the external files, releasing any of the OS resources being used.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2118.1">In the case of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2119.1">LegMaker</span></span></span></span><span class="kobospan" id="kobo.2120.1"> object, there is no finalization processing on context exit. </span><span class="kobospan" id="kobo.2120.2">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2121.1">LegMaker</span></span></span></span><span class="kobospan" id="kobo.2122.1"> object was created; the value returned from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2123.1">__enter__()</span></span></span></span><span class="kobospan" id="kobo.2124.1"> method is a reference to a method of this object. </span><span class="kobospan" id="kobo.2124.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2125.1">legger</span></span></span></span><span class="kobospan" id="kobo.2126.1"> callable will continue to operate correctly even outside the context. </span><span class="kobospan" id="kobo.2126.2">This is an odd special case that occurs in instances where there is no cleanup in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2127.1">__exit__()</span></span></span></span><span class="kobospan" id="kobo.2128.1"> method. </span><span class="kobospan" id="kobo.2128.2">If it’s important to prevent further use of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2129.1">legger</span></span></span></span><span class="kobospan" id="kobo.2130.1"> callable, then the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2131.1">__exit__()</span></span></span></span><span class="kobospan" id="kobo.2132.1"> method needs to make an explicit state change inside the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2133.1">LegMaker</span></span></span></span><span class="kobospan" id="kobo.2134.1"> object so it raises an exception. </span><span class="kobospan" id="kobo.2134.2">One approach is for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2135.1">__exit__()</span></span></span></span><span class="kobospan" id="kobo.2136.1"> method to set the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2137.1">self.r</span></span></span></span><span class="kobospan" id="kobo.2138.1"> value to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2139.1">None</span></span></span></span><span class="kobospan" id="kobo.2140.1">, which would prevent</span><span id="dx1-446001"/><span class="kobospan" id="kobo.2141.1"> further use of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2142.1">waypoint()</span></span></span></span><span class="kobospan" id="kobo.2143.1"> method. </span><span id="x1-446002r928"/></p>
</section>
<section data-number="0.10.12.4" id="theres-more...-54">
<h2 class="likechapterhead" data-number="0.10.12.4"><span><span class="kobospan" id="kobo.2144.1">7.12.4 </span></span> <span id="x1-4470004"/><span class="kobospan" id="kobo.2145.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.2146.1">A context manager’s job is to isolate details of resource management. </span><span class="kobospan" id="kobo.2146.2">The most common examples are files and network connections. </span><span class="kobospan" id="kobo.2146.3">We’ve shown the use of a context manager around an algorithm to help manage a cache with a single </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2147.1">Point</span></span></span></span><span class="kobospan" id="kobo.2148.1"> object.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2149.1">When working with very large datasets, it’s often helpful to use compression. </span><span class="kobospan" id="kobo.2149.2">This can create a different kind of context around the processing. </span><span class="kobospan" id="kobo.2149.3">The built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2150.1">open()</span></span></span></span><span class="kobospan" id="kobo.2151.1"> method is generally assigned to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2152.1">io.open()</span></span></span></span><span class="kobospan" id="kobo.2153.1"> function in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2154.1">io</span></span></span></span><span class="kobospan" id="kobo.2155.1"> module. </span><span class="kobospan" id="kobo.2155.2">This means we can often replace </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2156.1">io.open()</span></span></span></span><span class="kobospan" id="kobo.2157.1"> with a function such as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2158.1">bz2.open()</span></span></span></span><span class="kobospan" id="kobo.2159.1"> to work with compressed files.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2160.1">We can replace an uncompressed file context manager</span><span id="dx1-447001"/><span class="kobospan" id="kobo.2161.1"> with something like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2162.1">
 
 
import bz2 
 
 
 
def make_route_bz2(points: Iterable[Point], target: Path) -&gt; None: 
 
    with ( 
 
        LegMaker(r=NM) as legger, 
 
        bz2.open(target, "wt") as archive 
 
    ): 
 
        writer = csv.DictWriter(archive, HEADERS) 
 
        writer.writeheader() 
 
        for point in points: 
 
            leg = legger.waypoint(point) 
 
            if leg is not None: 
 
                writer.writerow(flat_dict(leg)) 
 
    print(f"Finished creating {target}")</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.2163.1">We’ve replaced the original </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2164.1">path.open()</span></span></span></span><span class="kobospan" id="kobo.2165.1"> method with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2166.1">bz2.open(path)</span></span></span></span><span class="kobospan" id="kobo.2167.1">. </span><span class="kobospan" id="kobo.2167.2">The rest of the context processing remains identical. </span><span class="kobospan" id="kobo.2167.3">This flexibility allows us to work with text files initially and later convert them to compressed files when the volume of data grows. </span><span id="x1-447017r929"/></p>
</section>
<section data-number="0.10.12.5" id="see-also-61">
<h2 class="likechapterhead" data-number="0.10.12.5"><span><span class="kobospan" id="kobo.2168.1">7.12.5 </span></span> <span id="x1-4480005"/><span class="kobospan" id="kobo.2169.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.2170.1">In the </span><a href="ch006_split_001.xhtml#x1-15200011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.2171.1">Managing a context using the with statement</span></span></a><span class="kobospan" id="kobo.2172.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.2173.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.2174.1"> </span></span><a href="ch006_split_000.xhtml#x1-840002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.2175.1">2</span></span></a><span class="kobospan" id="kobo.2176.1">, we cover the basics of using a file-based context manager.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.2177.1">The </span><a href="ch011_split_001.xhtml#x1-43700011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.2178.1">Creating contexts and context managers</span></span></a><span class="kobospan" id="kobo.2179.1"> recipe covers the core of creating a class that is a context manager.</span></p></li>
</ul>
<p class="normal1"><span id="x1-448001r914"/></p>
</section>
</section>
<section data-number="0.10.15" id="join-our-community-discord-space-7">
<h1 class="unnumbered" data-number="0.10.15"><span id="x1-45100014"/><span class="kobospan" id="kobo.2180.1">Join our community Discord space</span></h1>
<p class="normal"><span class="kobospan" id="kobo.2181.1">Join our Python Discord workspace to discuss and find out more about the book: </span><a class="url" href="https://packt.link/dHrHU"><span class="url1"><span class="kobospan" id="kobo.2182.1">https://packt.link/dHrHU</span></span></a></p>
<p class="normal1"><span class="kobospan" id="kobo.2183.1"><img alt="PIC" src="../media/file1.png" class="calibre9"/></span> <span id="x1-451001r766"/></p>
</section>
</section>
</body></html>