<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Adding Ajax Effects</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Using<code class="literal"> jquery.multiselect.js</code>
</p></li><li class="listitem"><p>Creating a<code class="literal"> select_or_add</code> widget</p></li><li class="listitem"><p>Using an autocompletion plugin</p></li><li class="listitem"><p>Creating a drop-down date selector</p></li><li class="listitem"><p>Improving the built-in<code class="literal"> ajax</code> function</p></li><li class="listitem"><p>Using a slider to represent a number</p></li><li class="listitem"><p>Using jqGrid and web2py</p></li><li class="listitem"><p>Improving data tables with WebGrid</p></li><li class="listitem"><p>Ajaxing your search functions</p></li><li class="listitem"><p>Creating sparklines</p></li></ul></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec01"/>Introduction</h1></div></div></div><p>In this chapter, we discuss examples of integration of jQuery plugins with web2py. These plugins help in making forms and tables more interactive and friendly to the user, thus improving the usability of your application. In particular, we provide examples of how to improve the multi-select drop-down with an interactive<span class="strong"><strong> add option</strong></span> button, how to replace an input field with a slider, and how to display tabular data using<code class="literal"> jqGrid</code> and<code class="literal"> WebGrid</code>.</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec02"/>Using jquery.multiselect.js</h1></div></div></div><p>The default rendering of<code class="literal">&lt;select multiple="true"&gt;..&lt;/select&gt;</code> is quite ugly and not intuitive to use, in particular, when you need to select multiple non-contiguous options. This is not an HTML shortcoming, but a poor design of most browsers. Anyway, the presentation of the multiple<code class="literal"> select</code> can be overwritten using JavaScript. Here, we will be using a jQuery plugin called<code class="literal"> jquery.multiselect.js</code>. Notice that this jQuery plugin comes as standard and enabled with PluginWiki, but we assume that you are not using PluginWiki.<a id="id177" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec01"/>Getting ready</h2></div></div></div><p>You will need to download<code class="literal"> jquery.muliselect.js</code> from<a class="ulink" href="http://abeautifulsite.net/2008/04/jquery-multiselect"> http://abeautifulsite.net/2008/04/jquery-multiselect</a>, and place the corresponding files into<code class="literal"> static/js/jquery.multiselect.js</code> and<code class="literal"> static/css/jquery.multiselect.css</code>.<a id="id178" class="indexterm"/>
</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec02"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>In your view, simply add the following before<code class="literal"> {{extend 'layout.html}}:</code>
<a id="id179" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
{{
	response.files.append('http://ajax.googleapis.com/ajax\
		/libs/jqueryui/1.8.9/jquery-ui.js')
	response.files.append('http://ajax.googleapis.com/ajax\
		/libs/jqueryui/1.8.9/themes/ui-darkness/jquery-ui.css')
	response.files.append(URL('static','js/jquery.multiSelect.js'))
 response.files.append(URL('static','css/jquery.\
		multiSelect.css'))
}}
</pre></div></li><li class="listitem"><p>Place the following after<code class="literal"> {{extend 'layout.html'}}:</code>
</p><div class="informalexample"><pre class="programlisting">
&lt;script&gt;
	jQuery(document).ready(function(){jQuery('[multiple]').
		multiSelect();});
&lt;/script&gt;
</pre></div><p>That is all. All your multiple <code class="literal">select</code> will be nicely styled.
</p></li><li class="listitem"><p>Consider the following action:</p><div class="informalexample"><pre class="programlisting">
def index():
	is_fruits =
		IS_IN_SET(['Apples','Oranges','Bananas','Kiwis','Lemons'],
		multiple=True)
	form = SQLFORM.factory(Field('fruits','list:string',
		requires=is_fruits))
	if form.accepts(request,session):
		response.flash = 'Yummy!'
	return dict(form=form)
</pre></div><p>This action can be tried with the following view:
</p><div class="informalexample"><pre class="programlisting">
{{
	response.files.append('http://ajax.googleapis.com/ajax\
		/libs/jqueryui/1.8.9/jquery-ui.js')
	response.files.append('http://ajax.googleapis.com/ajax\
		/libs/jqueryui/1.8.9/themes/ui-darkness/jquery-ui.css')
	response.files.append(URL('static','js/jquery.multiSelect.js'))
	response.files.append(URL('static','css/jquery.\
		multiSelect.css'))
}}
{{extend 'layout.html}}
&lt;script&gt;
	jQuery(document).ready(function(){jQuery('[multiple]').
		multiSelect();});
&lt;/script&gt;
{{=form}}
</pre></div><p>Here is a screenshot of how it looks:
<a id="id180" class="indexterm"/>
</p></li></ol></div><div class="mediaobject"><img src="images/5467OS_05_29.jpg" alt="How to do it..."/></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec03"/>Creating a select_or_add widget</h1></div></div></div><p>This widget will create a object with an<span class="strong"><strong> Add</strong></span> button next to it, allowing users to add new categories and so on, on the fly without having to visit a different screen. It works with<code class="literal"> IS_IN_DB</code>, and uses web2py components and jQueryUI dialogs.</p><p>This widget was inspired by the<code class="literal"> OPTION_WITH_ADD_LINK</code> slice, which can be found at the following link:<a id="id181" class="indexterm"/>
</p><p>
<a class="ulink" href="http://web2pyslices.com/main/slices/take_slice/11">http://web2pyslices.com/main/slices/take_slice/11</a>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec03"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Place the following code into a model file. For example,<code class="literal"> models/select_or_add_widget.py:</code>
</p><div class="informalexample"><pre class="programlisting">
class SelectOrAdd(object):

def __init__(self, controller=None, function=None,
	form_title=None, button_text = None, dialog_width=450):
		if form_title == None:
			self.form_title = T('Add New')
		else:
			self.form_title = T(form_title)
		if button_text == None:
			self.button_text = T('Add')
		else:
			self.button_text = T(button_text)
			self.dialog_width = dialog_width
			self.controller = controller
			self.function = function
			
def widget(self, field, value):
	#generate the standard widget for this field
	from gluon.sqlhtml import OptionsWidget
	select_widget = OptionsWidget.widget(field, value)
	
	#get the widget's id (need to know later on so can tell
	#receiving controller what to update)
	my_select_id = select_widget.attributes.get('_id', None)
	add_args = [my_select_id]
	
	#create a div that will load the specified controller via ajax
	form_loader_div = DIV(LOAD(c=self.controller, f=self.function,
		args=add_args,ajax=True), _id=my_select_id+"_dialog-form",
		_title=self.form_title)
		
	#generate the "add" button that will appear next the options
	#widget and open our dialog
	activator_button = A(T(self.button_text),
		_id=my_select_id+"_option_add_trigger")
		
	#create javascript for creating and opening the dialog
	js = 'jQuery( "#%s_dialog-form" ).dialog({autoOpen: false,
		show: "blind", hide: "explode", width: %s});' %
		(my_select_id, self.dialog_width)
	js += 'jQuery( "#%s_option_add_trigger" ).click(function() {
		jQuery( "#%s_dialog-form" ).dialog( "open" );return
		false;}); ' % (my_select_id, my_select_id) 			#decorate
		our activator button for good measure
	js += 'jQuery(function() { jQuery( "#%s_option_add_trigger"
	).button({text: true, icons: { primary: "ui-icon-circle-
	plus"} }); });' % (my_select_id)
	jq_script=SCRIPT(js, _type="text/javascript")
	
	wrapper = DIV(_id=my_select_id+"_adder_wrapper")
	wrapper.components.extend([select_widget, form_loader_div,
		activator_button, jq_script])
	return wrapper
</pre></div></li><li class="listitem"><p>You assign the widget to a field using the following:</p><div class="informalexample"><pre class="programlisting">
# Initialize the widget
add_option = SelectOrAdd(form_title="Add a new something",
	controller="product", function="add_category", button_text =
	"Add New", dialog_width=500)
</pre></div><p>The widget accepts the following arguments:
<a id="id182" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<code class="literal">form_title: string:</code> This will appear as the jQueryUI dialog-box's title. The default value is<code class="literal"> Add New</code>.</p></li><li class="listitem"><p>
<code class="literal">controller: string:</code> This is the name of the controller that will handle record creation.</p></li><li class="listitem"><p>
<code class="literal">function: string</code>. This is the name of the function that will handle record creation. It should create a form, accept it, and be prepared to issue JavaScript to interact with the widget - see<code class="literal"> add_category</code> in<span class="emphasis"><em> step 4.)</em></span>
</p></li><li class="listitem"><p>
<code class="literal">button_text: string</code>. This is the text that should appear on the button that will activate our form dialog-box. The default value is<code class="literal"> Add</code>.</p></li><li class="listitem"><p>
<code class="literal">dialog_width: integer</code>. This is the desired width in pixels of the dialog-box. Default is<code class="literal"> 450</code>.</p></li></ul></div></li><li class="listitem"><p>Define your database tables in<code class="literal"> models/db.py</code>, as follows:</p><div class="informalexample"><pre class="programlisting">
db.define_table('category',
	Field('name', 'string', notnull=True, unique=True),
	Field('description', 'text')
)
db.define_table('product',
	Field('category_id', db.category, requires=IS_IN_DB(db,
		'category.id', 'category.name')),
	Field('name', 'string', notnull=True),
	Field('description', 'text'),
	Field('price', 'decimal(10,2)', notnull=True)
)

# assign widget to field
	db.product.category_id.widget = add_option.widget
</pre></div></li><li class="listitem"><p>Create your controller functions:</p><div class="informalexample"><pre class="programlisting">
#This is the main function, the one your users go to
def create():
	#Initialize the widget
	add_option = SelectOrAdd(form_title="Add new Product Category",
							controller="product",
							function="add_category",
							button_text = "Add New")
	#assign widget to field
	db.product.category_id.widget = add_option.widget
	form = SQLFORM(db.product)
	if form.accepts(request, session):
		response.flash = "New product created"
	elif form.errors:
		response.flash = "Please fix errors in form"
	else:
		response.flash = "Please fill in the form"
		
	#you need jQuery for the widget to work; include here or just
	#put it in your master layout.html
	response.files.append("http://ajax.googleapis.com/ajax/\
	libs/jqueryui/1.8.9/jquery-ui.js")
	response.files.append("http://ajax.googleapis.com/ajax/\
	libs/jqueryui/1.8.9/themes/smoothness/jquery-ui.css")
	return dict(message="Create your product", form = form)
	
def add_category():
	#this is the controller function that will appear in our dialog
	form = SQLFORM(db.category)
	if form.accepts(request):
		#Successfully added new item
		#do whatever else you may want
		#Then let the user know adding via our widget worked
		response.flash = T("Added")
		target = request.args[0]
		#close the widget's dialog box
		response.js = 'jQuery("#%s_dialog-form" ).dialog(\
"close" );' % target

		#update the options they can select their new category in the
		#main form
		response.js += \
		"""jQuery("#%s")\
		.append("&lt;option value='%s'&gt;%s&lt;/option&gt;");""" % \
		(target, form.vars.id, form.vars.name)
		#and select the one they just added
		response.js += """jQuery("#%s").val("%s");""" % \
		(target, form.vars.id)
		
		#finally, return a blank form in case for some reason they
		#wanted to add another option
		return form
	
	elif form.errors:
		# silly user, just send back the form and it'll still be in
		# our dialog box complete with error messages
		return form
		
	else:
		#hasn't been submitted yet, just give them the fresh blank
		#form
		return form
</pre></div><p>Here is a screenshot showing the widget in action:
</p><div class="mediaobject"><img src="images/5467OS_05_30.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Click on the<span class="strong"><strong> Add New</strong></span> button, and the dialog-box opens. (Hmm, can't type my own widget's name right!).<a id="id183" class="indexterm"/>
</p><div class="mediaobject"><img src="images/5467OS_05_31.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Click on<span class="strong"><strong> Submit</strong></span>, and the new option is created and automatically selected in the main form.<a id="id184" class="indexterm"/>
</p></li></ol></div><div class="mediaobject"><img src="images/5467OS_05_32.jpg" alt="How to do it..."/></div><p>You can get the source or a sample application from bitbucket, at the following link:<a id="id185" class="indexterm"/>
</p><p>
<a class="ulink" href="http://https://bitbucket.org/bmeredyk/web2py-select_or_add_option-widget/src">https://bitbucket.org/bmeredyk/web2py-select_or_add_option-widget/src</a>
</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec04"/>Using an autocompletion plugin</h1></div></div></div><p>Although web2py comes with its own autocomplete plugin, its behavior is a kind of magic and, if it does not suit you, you may prefer to use a jQuery plugin for autocompletion.<a id="id186" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec04"/>Getting ready</h2></div></div></div><p>Download the necessary files from the following website:</p><p>
<a class="ulink" href="http://bassistance.de/jquery-plugins/jquery-plugin-autocomplete/">http://bassistance.de/jquery-plugins/jquery-plugin-autocomplete/</a>
</p><p>Unzip the files into<code class="literal"> static/autocomplete</code>. Make sure you have the following files:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<code class="literal">static/autocomplete/jquery.autocomplete.js</code>
</p></li><li class="listitem"><p>
<code class="literal">static/autocomplete/jquery.autocomplete.css</code>
</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec05"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>First of all, define the following widget in your model:</p><div class="informalexample"><pre class="programlisting">
def autocomplete_widget(field,value):
	response.files.append(URL('static','autocomplete/jquery.\
autocomplete.js'))
	response.files.append(URL('static','autocomplete/jquery.\
autocomplete.css'))
	print response.files
	import uuid
	from gluon.serializers import json
	id = "autocomplete-" + str(uuid.uuid4())
	wrapper = DIV(_id=id)
	inp = SQLFORM.widgets.string.widget(field,value)
	rows = field._db(field._table['id']&gt;0).
		select(field,distinct=True)
	items = [str(t[field.name]) for t in rows]
	scr = SCRIPT("jQuery('#%s input').autocomplete({source: %s});" % \
(id, json(items)))
	wrapper.append(inp)
	wrapper.append(scr)
	return wrapper
</pre></div><p>This widget creates a normal <code class="literal">&lt;input/&gt;</code> widget inp followed by a script that registers the autocomplete plugin. It also passes to the plugin, a list of possible values, obtained by existing values of the field itself.
</p></li><li class="listitem"><p>Now, in your model or controller, you simply assign this widget to any string field. For example:</p><div class="informalexample"><pre class="programlisting">db.define_table('person',Field('name'))
db.person.name.widget = autocomplete_widget
</pre></div></li><li class="listitem"><p>If you want the widget to get values from a different table/field, you just need to change the following lines:<a id="id187" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">rows = field._db(field._table['id']&gt;0).select(field,distinct=True)
items = [str(t[field.name]) for t in rows]
</pre></div><p>Change them to the following:
</p><div class="informalexample"><pre class="programlisting">rows = field._db(query).select(otherfield,distinct=True)
items = [str(t[otherfield.name]) for t in rows]
</pre></div></li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ch05lvl2sec06"/>There is more...</h3></div></div></div><p>A limitation with this approach is that all possible values will be fetched when the widget is rendered and embedded in the page. This approach has two limitations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Serving the page gets slower and slower, as more options exist for the autocompletion</p></li><li class="listitem"><p>It exposes your entire data to the visitor</p></li></ul></div><p>There is a solution. The plugin can fetch the data using an Ajax callback. To fetch the items remotely using an Ajax call, we can modify the widget as follows:</p><div class="informalexample"><pre class="programlisting">
def autocomplete_widget(field,value):
	import uuid
	id = "autocomplete-" + str(uuid.uuid4())
	callback_url = URL('get_items')
	wrapper = DIV(_id=id)
	inp = SQLFORM.widgets.string.widget(field,value)
	scr = SCRIPT("jQuery('#%s input').
		autocomplete('%s',{extraParams:{field:'%s',table:'%s'}});" % \
		(id, callback_url,field.name,field._tablename))
	wrapper.append(inp)
	wrapper.append(scr)
	return wrapper
</pre></div><p>Now you need to implement your own<code class="literal"> callback_url</code>.</p><div class="informalexample"><pre class="programlisting">
def get_items():
	MINCHARS = 2 # characters required to trigger response
	MAXITEMS = 20 # numer of items in response
	query = request.vars.q
	fieldname = request.vars.field
	tablename = request.vars.table
	if len(query.strip()) &gt; MINCHARS and fieldname and tablename:
		field = db[tablename][fielfname]
		rows = db(field.upper().startswith(qery)).
			select(field,distinct=True,limitby=(0,MINITEMS))
		items = [str(row[fieldname]) for row in rows]
	else:
		items = []
	
	return '\n'.join(items)
</pre></div><p>Here is an example of how it works:<a id="id188" class="indexterm"/>
</p><div class="mediaobject"><img src="images/5467OS_05_33.jpg" alt="There is more..."/></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec05"/>Creating a drop-down date selector</h1></div></div></div><p>Sometimes, you might not like the normal pop-up calendar selector, and want to create a widget that allows selecting the year, month, and day of the month separately, using dropdown lists. Here we present a widget to do it.<a id="id189" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec07"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>In one of your models, write the following widget:</p><div class="informalexample"><pre class="programlisting">
def select_datewidget(field,value):
	MINYEAR = 2000
	MAXYEAR = 2020
	import datetime
	now = datetime.date.today()
	dtval = value or now.isoformat()
	year,month,day= str(dtval).split("-")
	dt = SQLFORM.widgets.string.widget(field,value)
	id = dt['_id']
	dayid = id+'__day'
	monthid = id+'__month'
	yearid = id+'__year'
	wrapperid = id+'__wrapper'
	wrapper = DIV(_id=wrapperid)
	day = SELECT([OPTION(str(i).zfill(2)) for i in range(1,32)],
		value=day,_id=dayid)
	month = SELECT([OPTION(datetime.date(2008,i,1).strftime('%B'),
		_value=str(i).zfill(2)) for i in range(1,13)],
		value=month,_id=monthid)
	year = SELECT([OPTION(i) for i in range(MINYEAR,MAXYEAR)],
		value=year,_id=yearid)
	jqscr = SCRIPT("""
		jQuery('#%s').hide();
		var curval = jQuery('#%s').val();
		if(curval) {
			var pieces = curval.split('-');
			jQuery('#%s').val(pieces[0]);
			jQuery('#%s').val(pieces[1]);
			jQuery('#%s').val(pieces[2]);
		}
		jQuery('#%s select').change(function(e) {
			jQuery('#%s').val(
				jQuery('#%s').val()+'-'+jQuery('#%s').val()+'-
					'+jQuery('#%s').val());
	});
	
	""" % (id,id,yearid,monthid,dayid,
		wrapperid,id,yearid,monthid,dayid))
	wrapper.components.extend([month,day,year,dt,jqscr])
	return wrapper
</pre></div></li><li class="listitem"><p>Create a test form in your controller, and set the field to use the widget:<a id="id190" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
def index():
	form = SQLFORM.factory(
		Field('posted','date',default=request.now,
		widget=select_datewidget))
		
	if form.accepts(request,session):
		response.flash = "New record added"
	return dict(form=form)
</pre></div><p>Here is how it looks:
</p></li></ol></div><div class="mediaobject"><img src="images/5467OS_05_34.jpg" alt="How to do it..."/></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec06"/>Improving the built-in ajax function</h1></div></div></div><p>Web2py comes with a<code class="literal"> static/js/web2py_ajax.js</code> file, which defines an ajax function. It is a wrapper around<code class="literal"> jQuery.ajax</code>, but provides an even simpler syntax. Yet, this function is designed to be intentionally minimalist. In this recipe, we show you how to rewrite it, so that it displays a spinning image while performing the Ajax request in the background.<a id="id191" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec08"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>First of all, you need a spinning icon. Choose one for example from this web site:<a class="ulink" href="http://www.freeiconsdownload.com/Free_Downloads.asp?id=585"> http://www.freeiconsdownload.com/Free_Downloads.asp?id=585</a>, and save it in<code class="literal"> static/images/loading.gif</code>.</p></li><li class="listitem"><p>Then, edit the ajax function in the file<code class="literal"> static/js/web2py_ajax.js</code>, as follows (for older web2py applications, this function is in<code class="literal"> views/web2py_ajax.html):</code>
</p><div class="informalexample"><pre class="programlisting">
function ajax(u,s,t) {
	/* app_loading_image contains the img html
		set in layout.html before including web2py_ajax.html */
	jQuery("#"+t).html(app_loading_image);
	var query="";
	for(i=0; i&lt;s.length; i++) {
		if(i&gt;0) query=query+"&amp;";
		query=query+encodeURIComponent(s[i])+"="+
			encodeURIComponent(document.getElementById(s[i]).value);
	}
	// window.alert(loading_image);
	jQuery.ajax({type: "POST", url: u, data: query,
		success: function(msg) {
			if(t==':eval') eval(msg);
			else document.getElementById(t).innerHTML=msg;
		}
	});
};
</pre></div></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec07"/>Using a slider to represent a number</h1></div></div></div><p>jQuery UI comes with a handy slider that can be used to represent numerical fields in a range as opposed to a boring<code class="literal">&lt;input/&gt;</code> tag.<a id="id192" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec09"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Create a model file called<code class="literal"> models/plugin_slider.py</code>, and define the following:</p><div class="informalexample"><pre class="programlisting">
def slider_widget(field,value):
	response.files.append("http://ajax.googleapis.com/ajax\
/libs/jqueryui/1.8.9/jquery-ui.js")
	response.files.append("http://ajax.googleapis.com/ajax\
/libs/jqueryui/1.8.9/themes/ui-darkness/jquery-ui.css")
	id = '%s_%s' % (field._tablename,field.name)
	wrapper = DIV(_id="slider_wrapper",_style="width: 200px;text-\
align:center;")
	wrapper.append(DIV(_id=id+'__slider'))
	wrapper.append(SPAN(INPUT(_id=id, _style="display: none;"),
		_id=id+'__value'))
	wrapper.append(SQLFORM.widgets.string.widget(field,value))
	
	wrapper.append(SCRIPT("""
		jQuery('#%(id)s__value').text('%(value)s');
		jQuery('#%(id)s').val('%(value)s');
		jQuery('#%(id)s').hide();
		jQuery('#%(id)s__slider').slider({
			value:'%(value)s',
			stop: function(event, ui){
				jQuery('#%(id)s__value').text(ui.value);
				jQuery('#%(id)s').val(ui.value);
		}});
		""" % dict(id=id, value=value)))
	return wrapper
</pre></div></li><li class="listitem"><p>Create a test table, and set the widget to our new slider widget:</p><div class="informalexample"><pre class="programlisting">
db.define_table("product",
	Field("quantity","integer", default=0))
</pre></div></li><li class="listitem"><p>Then, use the slider by creating a form in your controller:</p><div class="informalexample"><pre class="programlisting">
def index():
	db.product.quantity.widget=slider_widget
	form = SQLFORM(db.product)
	if form.accepts(request,session):
		response.flash = "Got it"
	inventory = db(db.product).select()
	return dict(form=form,inventory=inventory)
</pre></div><div class="mediaobject"><img src="images/5467OS_05_35.jpg" alt="How to do it..."/></div></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec08"/>Using jqGrid and web2py</h1></div></div></div><p>
<span class="strong"><strong>jqGrid</strong></span> is an Ajax-enabled JavaScript control built on jQuery that provides a solution for representing and manipulating tabular data. You can think of it as a replacement for the web2py<code class="literal"> SQLTABLE</code> helper. jqGrid is a client-side solution, and it loads data dynamically through Ajax callbacks, thus providing pagination, search popup, inline editing, and so on. jqGrid is integrated into PluginWiki, but, here, we discuss it as a standalone for web2py programs that do not use the plugin. jqGrid deserves a book of its own, and here we only discuss its basic features and simplest integration.<a id="id193" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec10"/>Getting ready</h2></div></div></div><p>You will need jQuery (that comes with web2py), jQuery.UI, and one or more themes which you can get directly from Google but you will also need jqGrid, which you can get from:</p><p>
<a class="ulink" href="http://www.trirand.com/blog">http://www.trirand.com/blog</a>
</p><p>We will also assume we have a table with stuff that you can pre-populate with random data:</p><div class="informalexample"><pre class="programlisting">
from gluon.contrib.populate import populate

db.define_table('stuff',
	Field('name'),
	Field('quantity', 'integer'),
	Field('price', 'double'))
	
if db(db.stuff).count() == 0:
	populate(db.stuff, 50)
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec11"/>How to do it...</h2></div></div></div><p>First of all, you need a helper that will display the jqGrid, and we can define this in a model. For example,<code class="literal"> models/plugin_qgrid.py:</code>
</p><div class="informalexample"><pre class="programlisting">
def JQGRID(table,fieldname=None, fieldvalue=None, col_widths=[],
			colnames=[], _id=None, fields=[],
			col_width=80, width=700, height=300, dbname='db'):
	# &lt;styles&gt; and &lt;script&gt; section
		response.files.append('http://ajax.googleapis.com/ajax\
/libs/jqueryui/1.8.9/jquery-ui.js')
	response.files.append('http://ajax.googleapis.com/ajax\
	/libs/jqueryui/1.8.9/themes/ui-darkness/jquery-ui.css')
	for f in ['jqgrid/ui.jqgrid.css',
				'jqgrid/i18n/grid.locale-en.js',
				'jqgrid/jquery.jqGrid.min.js']:
		response.files.append(URL('static',f))
		
	# end &lt;style&gt; and &lt;script&gt; section
	from gluon.serializers import json
	_id = _id or 'jqgrid_%s' % table._tablename
	if not fields:
		fields = [field.name for field in table if field.readable]
	else:
		fields = fields
	if col_widths:
		if isinstance(col_widths,(list,tuple)):
			col_widths = [str(x) for x in col_widths]
		if width=='auto':
			width=sum([int(x) for x in col_widths])
	elif not col_widths:
		col_widths = [col_width for x in fields]
		colnames = [(table[x].label or x) for x in fields]
		colmodel = [{'name':x,'index':x, 'width':col_widths[i],
					'sortable':True} \
					for i,x in enumerate(fields)]
					
	callback = URL('jqgrid',
					vars=dict(dbname=dbname,
								tablename=table._tablename,
								columns=','.join(fields),
								fieldname=fieldname or '',
								fieldvalue=fieldvalue,
								),
					hmac_key=auth.settings.hmac_key,
					salt=auth.user_id)
	script="""
	jQuery(function(){
	jQuery("#%(id)s").jqGrid({
	url:'%(callback)s',
	datatype: "json",
	colNames: %(colnames)s,
	colModel:%(colmodel)s,
	rowNum:10, rowList:[20,50,100],
	pager: '#%(id)s_pager',
	viewrecords: true,
	height:%(height)s
	});
	jQuery("#%(id)s").jqGrid('navGrid','#%(id)s_pager',{
	search:true,add:false,
	edit:false,del:false
	});
	jQuery("#%(id)s").setGridWidth(%(width)s,false);
	jQuery('select.ui-pg-selbox,input.ui-g-
	input').css('width','50px');
	});
	""" % dict(callback=callback, colnames=json(colnames),
				colmodel=json(colmodel),id=_id,
				height=height,width=width)
				
	return TAG[''](TABLE(_id=_id),
					DIV(_id=_id+"_pager"),
					SCRIPT(script))
</pre></div><p>We can use this in our control as follows:</p><div class="informalexample"><pre class="programlisting">
@auth.requires_login()
def index():
	return dict(mygrid = JQGRID(db.stuff))
</pre></div><p>This function simply generates all the required JavaScript, but does not pass any data to it. Instead, it passes a callback function URL (<code class="literal">jqgrid</code>), which is digitally signed for security. We need to implement this callback.<a id="id194" class="indexterm"/>
</p><p>We can define the callback in the same controller of the index action:</p><div class="informalexample"><pre class="programlisting">
def jqgrid():
	from gluon.serializers import json
	import cgi
	hash_vars = 'dbname|tablename|columns|fieldname|
		fieldvalue|user'.split('|')
	if not URL.verify(request,hmac_key=auth.settings.hmac_key,
		hash_vars=hash_vars,salt=auth.user_id):
		raise HTTP(404)
		
	dbname = request.vars.dbname or 'db'
	tablename = request.vars.tablename or error()
	columns = (request.vars.columns or error()).split(',')
	rows=int(request.vars.rows or 25)
	page=int(request.vars.page or 0)
	sidx=request.vars.sidx or 'id'
	sord=request.vars.sord or 'asc'
	searchField=request.vars.searchField
	searchString=request.vars.searchString
	searchOper={'eq':lambda a,b: a==b,
		'nq':lambda a,b: a!=b,
		'gt':lambda a,b: a&gt;b,
		'ge':lambda a,b: a&gt;=b,
		'lt':lambda a,b: a&lt;b,
		'le':lambda a,b: a&lt;=b,
		'bw':lambda a,b: a.startswith(b),
		'bn':lambda a,b: ~a.startswith(b),
		'ew':lambda a,b: a.endswith(b),
		'en':lambda a,b: ~a.endswith(b),
		'cn':lambda a,b: a.contains(b),
		'nc':lambda a,b: ~a.contains(b),
		'in':lambda a,b: a.belongs(b.split()),
		'ni':lambda a,b: ~a.belongs(b.split())}\
		
	[request.vars.searchOper or 'eq']
	table=globals()[dbname][tablename]
	
	if request.vars.fieldname:
		names = request.vars.fieldname.split('|')
		values = request.vars.fieldvalue.split('|')
		query = reduce(lambda a,b:a&amp;b,
			[table[names[i]]==values[i] for i in range(len(names))])
			
	else:
	query = table.id&gt;0
	dbset = table._db(query)
	
	if searchField:
		dbset=dbset(searchOper(table[searchField],searchString))
		orderby = table[sidx]
		
	if sord=='desc': orderby=~orderby
		limitby=(rows*(page-1),rows*page)
		fields = [table[f] for f in columns]
		records = dbset.select(orderby=orderby,limitby=limitby,*fields)
		nrecords = dbset.count()
		items = {}
		items['page']=page
		items['total']=int((nrecords+(rows-1))/rows)
		items['records']=nrecords
		readable_fields=[f.name for f in fields if f.readable]
		def f(value,fieldname):
			r = table[fieldname].represent
		if r: value=r(value)
		try: return value.xml()
		except: return cgi.escape(str(value))
		items['rows']=[{'id':r.id,'cell':[f(r[x],x) for x in
			readable_fields]} \
			for r in records]
		return json(items)
</pre></div><p>Both the<code class="literal"> JQGRID</code> helper and the<code class="literal"> jqgrid</code> action are canned, very similar to the PluginWiki<code class="literal"> jgGrid</code> widget, and probably require no modification. The<code class="literal"> jqgrid</code> action is called by the code generated by the helper. It checks whether the URL is properly signed (the user is authorized to access the callback) or not, parses all data in the request to determine what the user wants, including building a query from the<code class="literal"> jqgrid</code> search pop-up, and performs the<code class="literal"> select</code> and<code class="literal"> return</code> on the data through JSON.</p><p>Notice that you can use multiple<code class="literal"> JQGRID(table)</code> in multiple actions, and you do not need to pass any other parameter other than the table to be displayed. Yet, you may want to pass extra parameters to the helper:<a id="id195" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<code class="literal">fieldname</code> and<code class="literal"> fieldvalue</code> attributes are user to pre-filter results, based on<code class="literal"> table[fieldname]==fieldvalue</code>
</p></li><li class="listitem"><p>
<code class="literal">col_widths</code> is a list of column widths in pixels</p></li><li class="listitem"><p>
<code class="literal">colnames</code> is a list of column names to replace<code class="literal"> field.name</code>
</p></li><li class="listitem"><p>
<code class="literal">_id</code> is the tag ID for the grid</p></li><li class="listitem"><p>
<code class="literal">fields</code> is a list of field names to be displayed</p></li><li class="listitem"><p>
<code class="literal">col_width=80</code> is the default width of each column</p></li><li class="listitem"><p>
<code class="literal">width=700</code> and<code class="literal"> height=300</code> are the size of the grid</p></li><li class="listitem"><p>
<code class="literal">dbname='db'</code> is the name of the database to be utilized by the callback, in case you have more than one, or you use a name that is not<code class="literal"> db</code>
</p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec09"/>Improving data tables with WebGrid</h1></div></div></div><p>In this recipe we will build a module called WebGrid that you can think of a replacement or web2py's SQLTABLE. Yet is is smarter: it supports paging, sorting, editing and it is easy to use and customize. It is intentionally designed not to require session nor jQuery plugins.<a id="id196" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec12"/>Getting ready</h2></div></div></div><p>Download<code class="literal"> webgrid.py</code> from<a class="ulink" href="http://web2pyslices.com/main/static/share/webgrid.py"> http://web2pyslices.com/main/static/share/webgrid.py</a>, and store it in the<code class="literal"> modules/</code> folder.</p><p>You may want to download a demo application from<a class="ulink" href="http://web2pyslices.com/main/static/share/web2py.app.webgrid.w2p">http://web2pyslices.com/main/static/share/web2py.app.webgrid.w2p</a>, but this is not necessary for WebGrid to work.</p><p>We will assume the scaffolding application with<code class="literal"> crud</code> defined, and the following code:</p><div class="informalexample"><pre class="programlisting">
db.define_table('stuff',
	Field('name'),
	Field('location'),
	Field('quantity','integer'))
</pre></div><p>We have in mind a simple inventory system.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec13"/>How to do it...</h2></div></div></div><p>We will explain it backwards for a change. First, we will show you how to use it.<a id="id197" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Add the<code class="literal"> webgrid.py</code> module to your<code class="literal"> modules</code> folder (see the<span class="emphasis"><em> Getting ready</em></span> section for the instructions on how to install it). In your controller, add the following code:</p><div class="informalexample"><pre class="programlisting">
def index():
	import webgrid
	grid = webgrid.WebGrid(crud)
	grid.datasource = db(db.stuff.id&gt;0)
	grid.pagesize = 10
	return dict(grid=grid()) # notice the ()
</pre></div><p>The datasource can be a <code class="literal">Set, Rows, Table</code>, or <code class="literal">list of Tables. Joins</code> are also supported.
</p><div class="informalexample"><pre class="programlisting">
grid.datasource = db(db.stuff.id&gt;0) 				# Set
grid.datasource = db(db.stuff.id&gt;0).select() 	# Rows
grid.datasource = db.stuff 							# Table
grid.datasource = [db.stuff,db.others] 				# list of Tables
grid.datasource = db(db.stuff.id==db.other.thing) 	#	join
</pre></div><p>The main row components of the WebGrid are <code class="literal">header, filter, datarow, pager, page_total,</code> and <code class="literal">footer
</code>
</p></li><li class="listitem"><p>You can link to<code class="literal"> crud</code> functions using<code class="literal"> action_links</code>. Just tell it where<code class="literal"> crud</code> is exposed:</p><div class="informalexample"><pre class="programlisting">grid.crud_function = 'data'
</pre></div></li><li class="listitem"><p>You can turn<code class="literal"> rows</code> on and off:</p><div class="informalexample"><pre class="programlisting">
grid.enabled_rows = ['header','filter',
'pager','totals','footer','add_links']
</pre></div></li><li class="listitem"><p>You can control the<code class="literal"> fields</code> and<code class="literal"> field_headers:</code>
</p><div class="informalexample"><pre class="programlisting">
grid.fields = ['stuff.name','stuff.location','stuff.quantity']
grid.field_headers = ['Name','Location','Quantity']
</pre></div></li><li class="listitem"><p>You can control the<code class="literal"> action_links</code> (links to<code class="literal"> crud</code> actions) and<code class="literal"> action_headers:</code>
</p><div class="informalexample"><pre class="programlisting">
grid.action_links = ['view','edit','delete']
grid.action_headers = ['view','edit','delete']
</pre></div></li><li class="listitem"><p>You will want to modify<code class="literal"> crud.settings.[action]_next</code>, so that it redirects to your WebGrid page after completing:</p><div class="informalexample"><pre class="programlisting">
if request.controller == 'default' and request.function == 'data':
	if request.args:
		crud.settings[request.args(0)+'_next'] = URL('index')
</pre></div></li><li class="listitem"><p>You can get page<code class="literal"> totals</code> for numeric fields:</p><div class="informalexample"><pre class="programlisting">grid.totals = ['stuff.quantity']
</pre></div></li><li class="listitem"><p>You can set<code class="literal"> filters</code> on columns:</p><div class="informalexample"><pre class="programlisting">grid.filters = ['stuff.name','stuff.created']
</pre></div></li><li class="listitem"><p>You can modify the<code class="literal"> query</code> that<code class="literal"> filters</code> use (not available if your datasource is a<code class="literal"> Rows</code> object; use<code class="literal"> rows.find):</code>
</p><div class="informalexample"><pre class="programlisting">grid.filter_query = lambda f,v: f==v
</pre></div></li><li class="listitem"><p>You can control which request<code class="literal"> vars</code> are allowed to override the<code class="literal"> grid</code> settings:<a id="id198" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
grid.allowed_vars =
	['pagesize','pagenum','sortby','ascending','groupby','totals']
</pre></div><p>The WebGrid will use a field's represent function, if present, when rendering the cell. If you need more control, you can completely override the way a row is rendered.
</p></li><li class="listitem"><p>The functions that render each row can be replaced with your own<code class="literal"> lambda</code> or function:</p><div class="informalexample"><pre class="programlisting">grid.view_link = lambda row: ...
grid.edit_link = lambda row: ...
grid.delete_link = lambda row: ...
grid.header = lambda fields: ...
grid.datarow = lambda row: ...
grid.footer = lambda fields: ...
grid.pager = lambda pagecount: ...
grid.page_total = lambda:
</pre></div></li><li class="listitem"><p>Here are some useful variables for building your own rows:</p><div class="informalexample"><pre class="programlisting">grid.joined # tells you if your datasource is a join
grid.css_prefix # used for css
grid.tablenames
grid.response # the datasource result
grid.colnames # column names of datasource result
grid.pagenum
grid.pagecount
grid.total # the count of datasource result
</pre></div><p>For example, let's customize the footer:
</p><div class="informalexample"><pre class="programlisting">
grid.footer = lambda fields : TFOOT(TD("This is my footer" ,
	_colspan=len(grid.action_links)+len(fields),
	_style="text-align:center;"),
	_class=grid.css_prefix + '-webgrid footer')
</pre></div></li><li class="listitem"><p>You can also customize messages:</p><div class="informalexample"><pre class="programlisting">grid.messages.confirm_delete = 'Are you sure?'
grid.messages.no_records = 'No records'
grid.messages.add_link = '[add %s]'
grid.messages.page_total = "Total:"
</pre></div></li><li class="listitem"><p>You can also also use the<code class="literal"> row_created</code> event to modify the row when it is created. Let's add a column to the header:<a id="id199" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
def on_row_created(row,rowtype,record):
	if rowtype=='header':
		row.components.append(TH(' '))
grid.row_created = on_row_created
</pre></div></li><li class="listitem"><p>Let's move the action links to the right-hand side:</p><div class="informalexample"><pre class="programlisting">
def links_right(tablerow,rowtype,rowdata):
	if rowtype != 'pager':
	links = tablerow.components[:3]
	del tablerow.components[:3]
	tablerow.components.extend(links)
grid.row_created = links_right
</pre><div class="mediaobject"><img src="images/5467OS_05_36.jpg" alt="How to do it..."/></div></div></li></ol></div><p>If you are using multiple grids on the same page, they must have unique names.<a id="id200" class="indexterm"/>
</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec10"/>Ajaxing your search functions</h1></div></div></div><p>In this recipe, we describe the code demonstrated in this video:</p><p>
<a class="ulink" href="http://www.youtube.com/watch?v=jGuW43sdv6E">http://www.youtube.com/watch?v=jGuW43sdv6E</a>
</p><p>It is very similar to autocompletion. It lets you type code in an input field, sends the text to the server through Ajax, and displays the results returned by the server. It can be used, for example, to perform live search. It differs from autocompletion, because the text is not necessarily picked from one table (it can originate from a more complex search condition implemented server-side), and the results are not used to populate an input field.<a id="id201" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec14"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>We need to start with a model and, for this example, we picked this one:</p><div class="informalexample"><pre class="programlisting">
db.define_table('country',
	Field('iso'),
	Field('name'),
	Field('printable_name'),
	Field('iso3'),
	Field('numcode'))
</pre></div></li><li class="listitem"><p>We populate this model with the following data:</p><div class="informalexample"><pre class="programlisting">
if not db(db.country).count():
	for (iso,name,printable_name,iso3,numcode) in [
		('UY','URUGUAY','Uruguay','URY','858'),
		('UZ','UZBEKISTAN','Uzbekistan','UZB','860'),
		('VU','VANUATU','Vanuatu','VUT','548'),
		('VE','VENEZUELA','Venezuela','VEN','862'),
		('VN','VIETNAM','Viet Nam','VNM','704'),
		('VG','VIRGIN ISLANDS, BRITISH','Virgin Islands,
			British','VGB','092'),
		('VI','VIRGIN ISLANDS, U.S.','Virgin Islands,
			U.s.','VIR','850'),
		('EH','WESTERN SAHARA','Western Sahara','ESH','732'),
		('YE','YEMEN','Yemen','YEM','887'),
		('ZM','ZAMBIA','Zambia','ZMB','894'),
		('ZW','ZIMBABWE','Zimbabwe','ZWE','716')]:
db.country.insert(iso=iso,name=name,printable_name=printable_name,
	iso3=iso3,numcode=numcode)
</pre></div></li><li class="listitem"><p>Create the following css file<code class="literal"> static/css/livesearch.css:</code>
<a id="id202" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
#livesearchresults {
	background: #ffffff;
	padding: 5px 10px;
	max-height: 400px;
	overflow: auto;
	position: absolute;
	z-index: 99;
	border: 1px solid #A9A9A9;
	border-width: 0 1px 1px 1px;
	-webkit-box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.3);
	-moz-box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.3);
	-box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.3);
}

#livesearchresults a{
	color:#666666;
}
input#livesearch {
	font-size:12px;
	color:#666666;
	background-color:#ffffff;
	padding-top:5px;
	width:200px;
	height:20px;
	border:1px solid #999999;
}
</pre></div></li><li class="listitem"><p>Create the following JavaScript file<code class="literal"> static/js/livesearch.js:</code>
</p><div class="informalexample"><pre class="programlisting">
function livesearch(value){
	if(value != ""){
		jQuery("#livesearchresults").show();
		jQuery.post(livesearch_url,
			{keywords:value},
			function(result){
				jQuery("#livesearchresults").html(result);
			}
		);
	}
	
	else{
		jQuery("#livesearchresults").hide();
	}
}

function updatelivesearch(value){
	jQuery("#livesearch").val(value);jQuery("#livesearchresults").
		hide();
}

jQuery(function(){jQuery("#livesearchresults").hide();});
</pre></div></li><li class="listitem"><p>Now create a simple controller action:</p><div class="informalexample"><pre class="programlisting">
def index():
	return dict()
</pre></div></li><li class="listitem"><p>The simple controller action is associated to the following<code class="literal"> views/default/index.html</code>, which uses the livesearch JS and CSS created in<span class="emphasis"><em> steps 3</em></span> and<span class="emphasis"><em> 4:</em></span>
</p><div class="informalexample"><pre class="programlisting">
&lt;script type="text/javascript"&gt;
	/* url definition for livesearch ajax call */
	var livesearch_url = "{{=URL('ajaxlivesearch')}}";
&lt;/script&gt;
{{response.files.append(URL('static','css/livesearch.css'))}}
{{response.files.append(URL('static','js/livesearch.js'))}}
{{extend 'layout.html'}}

&lt;label for="livesearch"&gt;Search country:&lt;/label&gt;&lt;br /&gt;
&lt;input type="text" id="livesearch" name="country" autocomplete="off" onkeyup="livesearch(this.value);" /&gt;&lt;br /&gt;
&lt;div id="livesearchresults"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem"><p>Finally, in the same controller as the<code class="literal"> index</code> function, implement the Ajax callback:</p><div class="informalexample"><pre class="programlisting">
def ajaxlivesearch():
	keywords = request.vars.keywords
	print "Keywords: " + str(keywords)
	
	if keywords:
		query = reduce(lambda a,b:a&amp;b,
			[db.country.printable_name.contains(k) for k in \
			keywords.split()])
			
	countries = db(query).select()
	items = []
	
	for c in countries:
		items.append(DIV(A(c.printable_name, _href="#",
			_id="res%s"%c.iso,
			_onclick="updatelivesearch(jQuery('#res%s').
			html())"%c.iso)))
	return DIV(*items)
</pre></div><p>Here is how it looks:
</p></li></ol></div><div class="mediaobject"><img src="images/5467OS_05_37.jpg" alt="How to do it..."/></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec11"/>Creating sparklines</h1></div></div></div><p>
<code class="literal">Sparklines</code> are small graphs, typically embedded in text, that summarize a time series or similar information. The<code class="literal"> jquery.sparklines</code> plugin provides several different chart styles and a useful variety of display options. You can combine the sparklines plugin with the<code class="literal"> jquery.timers</code> plugin to display data that's changing in real time. This recipe shows one way to accomplish that.<a id="id204" class="indexterm"/>
</p><p>Sparkline charts are really useful in applications where you need to visually compare lots of similar data series. Here's a link to a chapter in<span class="emphasis"><em> Edward Tufte's, Beautiful Evidence</em></span> with more info:</p><p>
<a class="ulink" href="http://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=0001OR">http://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=0001OR</a>
</p><p>We will create an index that shows five to 25 bar charts displaying random numbers, reversely sorted to emulate Pareto charts. The charts update once-per-second with new data from the server.</p><p>Here's what the display will look like:</p><div class="mediaobject"><img src="images/5467OS_05_38.jpg" alt="Creating sparklines"/></div><p>This example assumes that you can use a single JSON query to get the data for all the sparklines at once, and that you know at the time the view is rendered how many graphs are to be displayed. The trick is choosing a suitable scheme for generating graph IDs, in this case<code class="literal"> ["dynbar0", "dynbar1",....]</code>, and using the same ID strings as keys for the dictionary, returned from the JSON service function. This makes it simple to use the web2py view templating methods, to generate<code class="literal"> jquery.sparkline()</code> calls that update the sparklines with data returned from the service function.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec15"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>First of all, you need to download the following:<a id="id205" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<a class="ulink" href="http://plugins.jquery.com/project/sparklines">http://plugins.jquery.com/project/sparklines, into "static/js/jquery.sparkline.js"</a>
</p></li><li class="listitem"><p>And the timer,<a class="ulink" href="http://plugins.jquery.com/project/timers"> http://plugins.jquery.com/project/timers</a>, into<code class="literal"> static/js/jquery.timers-1.2.js</code>
</p></li></ul></div></li><li class="listitem"><p>Then, in your<code class="literal"> layout.html</code>, before including<code class="literal"> web2py_ajax.html</code>, add the following:</p><div class="informalexample"><pre class="programlisting">response.files.append(URL('static','js/jquery.sparkline.js'))
response.files.append(URL('static','js/jquery.timers-1.2.js'))
</pre></div></li><li class="listitem"><p>Add the following actions to your controller:</p><div class="informalexample"><pre class="programlisting">
def index():
	return dict(message="hello from sparkline.py",
		ngraphs=20, chartmin=0, chartmax=20)
		
def call():
	return service()
		
@service.json
def sparkdata(ngraphs,chartmin,chartmax):
	import random
	ngraphs = int(ngraphs)
	chartmin = int(chartmin)
	chartmax = int(chartmax)
	
	d = dict()
	for n in xrange(ngraphs):
	id = "dynbar" + str(n)
	### data for bar graph.
	### 9 random ints between chartmax and chartmin
	data = [random.choice(range(chartmin,chartmax))\
			for i in xrange(9)]
	### simulate a Pareto plot
	data.sort()
	data.reverse()
	d[id] = data
return d
</pre></div></li><li class="listitem"><p>Then, create<code class="literal"> views/default/index.html</code>, as follows:<a id="id206" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
{{extend 'layout.html'}}
{{
	chartoptions =
		XML("{type:'bar',barColor:'green','chartRangeMin':'%d',
		'chartRangeMax':'%d'}" % (chartmin,chartmax))
		jsonurl = URL('call/json/sparkdata/\
		%(ngraphs)d/%(chartmin)d/%(chartmax)d' % locals())
}}

&lt;script type="text/javascript"&gt;
	jQuery(function() {
		jQuery(this).everyTime(1000,function(i) {
			jQuery.getJSON('{{=jsonurl}}', function(data) {
				{{for n in xrange(ngraphs):}}
				jQuery("#dynbar{{=n}}").sparkline(data.dynbar{{=n}},
				{{ =chartoptions }} );
				{{pass}}
				});
		});
	});
&lt;/script&gt;
&lt;h1&gt;This is the sparkline.html template&lt;/h1&gt;
{{for n in xrange(ngraphs):}}
&lt;p&gt;
	Bar chart with dynamic data: &lt;span id="dynbar{{=n}}"
		class="dynamicbar"&gt;Loading..&lt;/span&gt;
&lt;/p&gt;
{{pass}}
{{=BEAUTIFY(response._vars)}}
</pre></div></li></ol></div></div></div></div></div>
</body></html>