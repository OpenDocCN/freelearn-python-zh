<html><head></head><body><div><div><h1 id="_idParaDest-320"><em class="italic"><a id="_idTextAnchor324"/></em><a href="B16119_11_Final_PD_ePub.xhtml#_idTextAnchor324"><em class="italic">Chapter 11</em></a>: Kanban Views and Client-Side QWeb</h1>
			<p><strong class="bold">Kanban views</strong> support lean processes, providing a visual representation of the work in progress and the status of each work item. This can be an important tool to streamline business processes.</p>
			<p>This chapter introduces <strong class="bold">kanban board</strong> concepts, and how they are implemented in <strong class="bold">Odoo</strong> by using the kanban view type, stage columns, and kanban states.</p>
			<p>Kanban views are powered by <strong class="bold">QWeb</strong> – the template engine used by Odoo. It is <strong class="bold">XML</strong>-based and used to generate <strong class="bold">HTML</strong> fragments and pages. It is also used for reports and website pages, so it is an important part of Odoo that developers should be familiar with.</p>
			<p>In this chapter, we will show how to organize a kanban view in several areas, such as the title and main content, as well as how to use the QWeb syntax to apply the widgets and effects that are available.</p>
			<p>The QWeb template language will be described in detail to provide a complete understanding of its features.</p>
			<p>The later sections will explain how to extend the QWeb templates used in kanban views and present useful techniques for this. Here, you will learn how to add web assets that you intend to be used in these views, such as <strong class="bold">CSS</strong> and <strong class="bold">JavaScript</strong>.</p>
			<p>The following topics will be covered in this chapter:</p>
			<ul>
				<li>Introducing kanban boards</li>
				<li>Designing kanban views</li>
				<li>Designing kanban cards</li>
				<li>Exploring the QWeb template language</li>
				<li>Extending kanban views</li>
				<li>Adding CSS and JavaScript assets</li>
			</ul>
			<p>By the end of this chapter, you will understand kanban boards and be able to design your own kanban views.</p>
			<h1 id="_idParaDest-321"><a id="_idTextAnchor325"/>Technical requirements</h1>
			<p>This chapter continues enhancing the <code>library_checkout</code> addon module from <a href="B16119_10_Final_PD_ePub.xhtml#_idTextAnchor287"><em class="italic">Chapter 10</em></a>, <em class="italic">Backend Views – Designing the User Interface</em>. The corresponding code can be found in the <code>ch11/</code> directory of the <strong class="bold">GitHub</strong> repository at <a href="https://github.com/PacktPublishing/Odoo-15-Development-Essentials">https://github.com/PacktPublishing/Odoo-15-Development-Essentials.</a></p>
			<h1 id="_idParaDest-322"><a id="_idTextAnchor326"/>Introducing kanban boards</h1>
			<p><em class="italic">Kanban</em> is <a id="_idIndexMarker904"/>a Japanese word literally meaning <em class="italic">billboard</em> and is associated with lean manufacturing. More recently, <em class="italic">kanban boards</em> have <a id="_idIndexMarker905"/>become popular in the software industry with the adoption of <strong class="bold">agile</strong> methodologies.</p>
			<p>A kanban board <a id="_idIndexMarker906"/>provides a visual representation of a work queue. The board is organized into columns, which represent the <em class="italic">stages</em> of the work process. Work items are <a id="_idIndexMarker907"/>represented by <em class="italic">cards</em> placed on the appropriate column of the board. New work items start from the leftmost column and travel through the board until they reach the rightmost column, which represents the completed work.</p>
			<p>The simplicity and visual impact of kanban boards make them a good tool to support simple business processes. A basic example<a id="_idIndexMarker908"/> of a kanban board has three columns: <em class="italic">To Do</em>, <em class="italic">Doing</em>, and <em class="italic">Done</em>, as shown in the following diagram:</p>
			<p class="figure-caption">`</p>
			<div><div><img src="img/Figure_11.1_B16119.jpg" alt="Figure 11.1 – An example of a kanban board&#13;&#10;" width="725" height="302"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.1 – An example of a kanban board</p>
			<p>In many cases, a<a id="_idIndexMarker909"/> kanban board is a more effective way to manage a process when compared to heavier workflow engines.</p>
			<p>Odoo supports kanban views – along with the classic list and form views – to support kanban boards. Now that we know what a kanban board is, let's learn how to use one.</p>
			<h2 id="_idParaDest-323"><a id="_idTextAnchor327"/>Supporting kanban boards in Odoo</h2>
			<p>Browsing the Odoo <a id="_idIndexMarker910"/>apps, we can see two different ways to use kanban views. One is a simple <em class="italic">card list</em>, which is used in places such as contacts, products, employees, and apps. The other is a kanban board, which is organized in columns representing the steps of a process.</p>
			<p>For simple card lists, a good example is the <strong class="bold">Contacts</strong> kanban view. The contact cards have an image on the left-hand side and a bold title in the main area, followed by a list of values:</p>
			<div><div><img src="img/Figure_11.2_B16119.jpg" alt="Figure 11.2 – The Contacts kanban view&#13;&#10;" width="1185" height="531"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.2 – The Contacts kanban view</p>
			<p>While this contacts view uses a <em class="italic">kanban view</em>, it is not a <em class="italic">kanban board</em>.</p>
			<p>Examples of kanban boards can be found on the <em class="italic">CRM</em> app's <strong class="bold">Pipeline</strong> page or on the <strong class="bold">Project Tasks</strong> page. An example of the <strong class="bold">Pipeline</strong> page is shown in <em class="italic">Figure 11.3</em>:</p>
			<div><div><img src="img/Figure_11.3_B16119.jpg" alt="Figure 11.3 – The CRM Pipeline kanban board&#13;&#10;" width="1266" height="666"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.3 – The CRM Pipeline kanban board</p>
			<p>The most<a id="_idIndexMarker911"/> important difference between this kanban board and the <strong class="bold">Contacts</strong> kanban view is the card organization in columns. This is done using the <strong class="bold">Group By</strong> feature, which<a id="_idIndexMarker912"/> is similar to what list views use. Usually, the grouping is done in a <em class="italic">stage</em> field. One very useful feature of kanban views is that they support dragging and dropping cards between columns, which automatically assigns the corresponding value to the field the view is grouped by.</p>
			<p>The <strong class="bold">CRM</strong> <strong class="bold">Pipeline</strong> page cards have a bit more structure. The main card area also has a title, followed by a list of relevant information, as well as a footer area. In this footer area, we can see a priority widget on the left-hand side, followed by an activities indicator, and on the right-hand side, we can see a small image of the responsible user.</p>
			<p>It's not visible in the figure shown in this chapter, but the cards also have an options menu on the top-right, which is shown when hovering the mouse pointer over it. This menu allows us to, for example, change a color indicator for the card.</p>
			<p>Looking at the cards in both examples, we can see some differences. In fact, their design is quite flexible, and there isn't a single way to design a kanban card. But these two examples provide a starting point for your designs.</p>
			<p>We will be using the more elaborate structure as a model for the cards on our checkouts kanban board.</p>
			<h2 id="_idParaDest-324"><a id="_idTextAnchor328"/>Understanding kanban states</h2>
			<p>On a kanban board, work<a id="_idIndexMarker913"/> items start in the leftmost column, and while the work is in progress, they travel through the columns until reaching the rightmost column, which shows the completed items. This implies a <em class="italic">push strategy</em>, which means when work on a column is done, the work item is <em class="italic">pushed</em> to the next column.</p>
			<p>A push strategy tends to lead to a build-up of work items in progress, which can be inefficient. Lean approaches advise using a <em class="italic">pull strategy</em> instead. Here, each stage <em class="italic">pulls</em> work from the previous one when it is ready to start the next work item.</p>
			<p>Odoo supports the pull strategy with the use of kanban states. Each record work item has a kanban state field signaling its flow status: <em class="italic">In progress</em> (gray), <em class="italic">Blocked</em> (red), or <em class="italic">Ready</em> (green).</p>
			<p>When the work needed in a stage is completed, instead of moving the card to the next column, it is marked as <em class="italic">Ready</em>. This gives a visual indication that the work item is ready to be pulled by the next stage. Additionally, if something is preventing the work from moving ahead, it can be marked as <em class="italic">Blocked</em>, giving a visual indication that help is needed to unblock this work item.</p>
			<p>As an example, kanban states are used in the <strong class="bold">Project Tasks</strong> kanban view. In the following screenshot, we can see the kanban state <em class="italic">gray-red-green</em> indicator in the bottom-right of each card. Also, note the progress bar at the top of each column, which provides a visual indication of the items in each state:</p>
			<div><div><img src="img/Figure_11.4_B16119.jpg" alt="Figure 11.4 – The project task kanban view with the kanban states&#13;&#10;" width="1021" height="680"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.4 – The project task kanban view with the kanban states</p>
			<p>The <a id="_idIndexMarker914"/>kanban state is meaningful in each stage, so it should be reset when an item moves to another stage.</p>
			<p>You have now learned about the different views in a kanban board and what they look like. Now, we will move on to learning how to design them.</p>
			<h1 id="_idParaDest-325"><a id="_idTextAnchor329"/>Designing kanban views</h1>
			<p>The book checkout <a id="_idIndexMarker915"/>process can use a kanban view to visualize the work in progress. In this case, the kanban board columns could represent the checkout stages, and each checkout could be represented by a card.</p>
			<p>This is what the library checkout kanban view will look like when complete:</p>
			<div><div><img src="img/Figure_11.5_B16119.jpg" alt="Figure 11.5 –  Library checkouts kanban view&#13;&#10;" width="1125" height="483"/>
				</div>
			</div>
			<p class="figure-caption">Figure 11.5 –  Library checkouts kanban view</p>
			<p>Form views mostly use Odoo-specific XML elements such as <code>&lt;field&gt;</code> and <code>&lt;group&gt;</code>. They also use some HTML elements such as <code>&lt;h1&gt;</code> or <code>&lt;div&gt;</code>, but their use is limited. Kanban views are quite the opposite. They are HTML-based and additionally support two Odoo-specific elements: <code>&lt;field&gt;</code> and <code>&lt;button&gt;</code>.</p>
			<p>With kanban views, the<a id="_idIndexMarker916"/> final HTML presented in the web client is dynamically generated from QWeb templates. The QWeb engine processes special XML tags and attributes in the templates to produce the final HTML. This allows a lot of control of how the content is rendered, but it also makes the view design more complex.</p>
			<p>As a kanban view design is so flexible, different design structures can be used. A good approach is to find an existing kanban view that would fit well with the use case at hand, inspect it, and use it as a reference.</p>
			<h2 id="_idParaDest-326"><a id="_idTextAnchor330"/>Creating a minimal viable kanban view</h2>
			<p>Kanban views <a id="_idIndexMarker917"/>allow for a rich user interface and can quickly get complex. The first step in learning how to design kanban views is to create a minimum viable view.</p>
			<p>To add a kanban view to the <code>library_checkout</code> module, follow these steps: </p>
			<ol>
				<li>Add <code>kanban</code> in <code>view_mode</code> of the window action. To do this, edit the <code>views/library_menu.xml</code> file and update the value set in the <code>view_mode</code> field to match the following:<pre>  &lt;record id="action_library_checkout"
          model="ir.actions.act_window"&gt;
    &lt;field name="name"&gt;Checkouts&lt;/field&gt;
    &lt;field name="res_model"&gt;library.checkout&lt;/field&gt;
    &lt;field name="view_mode"&gt;
      <code>kanban</code> was added at the beginning of the list to have it as the default view type.</p></li>
				<li>The new kanban view will be added in a new XML file, <code>views/checkout_kanban_<a id="_idTextAnchor331"/>view.xml</code>. So, add this file to the <code>__manifest__.py</code> module in the <code>data</code> key:<pre>    "data": [
        "security/ir.model.access.csv",
        "views/library_menu.xml",
        "views/checkout_view.xml",
<strong class="bold">        "views/checkout_kanban_view.xml",</strong>
        "wizard/checkout_mass_message_wizard_view.xml"
         ,
        "data/stage_data.xml",
    ],</pre></li>
				<li>Finally, add the <a id="_idIndexMarker919"/>XML code for a minimal kanban view in the <code>views/checkout_kanban_view.xml</code> file by using the following code:<pre>&lt;odoo&gt;
  &lt;record id="library_checkout_kanban" 
    model="ir.ui.view"&gt;
    &lt;field name="model"&gt;library.checkout&lt;/field&gt;
    &lt;field name="arch" type="xml"&gt;
<strong class="bold">&lt;kanban&gt;</strong>
<strong class="bold">  &lt;templates&gt;</strong>
<strong class="bold">    &lt;t t-name="kanban-box"&gt;</strong>
<strong class="bold">      &lt;div&gt;</strong>
<strong class="bold">        &lt;field name="name" /&gt;</strong>
<strong class="bold">      &lt;/div&gt;</strong>
<strong class="bold">    &lt;/t&gt;</strong>
<strong class="bold">  &lt;/templates&gt;</strong>
<strong class="bold">&lt;/kanban&gt;</strong>
    &lt;/field&gt;
  &lt;/record&gt;
&lt;/odoo&gt;</pre></li>
			</ol>
			<p>In the previous code, a kanban view is declared inside a <code>&lt;kanban&gt;</code> element. Kanban views are described using the QWeb template language. The templates are added inside a <code>&lt;templates&gt;</code> sub-element.</p>
			<p>The main template for each kanban card is described in the  <code>&lt;t t-name="kanban-box"&gt;</code> element. This QWeb template is minimal. It is an HTML <code>&lt;div&gt;</code> element containing an <a id="_idIndexMarker920"/>Odoo-specific <code>&lt;field&gt;</code> widget, which is also used in form and tree views.</p>
			<p>This provides a pretty basic <em class="italic">kanban view</em> XML structure to start building from. To be a <em class="italic">kanban board</em>, it needs to feature columns for each process stage.</p>
			<h2 id="_idParaDest-327"><a id="_idTextAnchor332"/>Presenting kanban board columns</h2>
			<p>Kanban boards<a id="_idIndexMarker921"/> present the work items organized in columns, where each column is a stage in the process. New work items start on the left-hand columns and then travel through the columns until they arrive at the right-hand side, completed.</p>
			<p>Kanban views present items in columns when grouping by a field. For a kanban board, the view should be grouped by a stage or state field – often, <code>stage_id</code> is used.</p>
			<p>The <code>default_group_by</code> attribute sets a default column group for the kanban view. To have a kanban board for the book checkouts, edit the <code>&lt;kanban&gt;</code> element to look like this:</p>
			<pre>&lt;kanban <strong class="bold">default_group_by="stage_id"</strong>&gt;</pre>
			<p>When opening this view, it will be grouped by stage by default (which is similar to <em class="italic">Figure 11.4</em>). The user is still able to change the applied <code>group_by</code> options used for list views.</p>
			<h2 id="_idParaDest-328"><a id="_idTextAnchor333"/>Understanding kanban view attributes and elements</h2>
			<p>Kanban views support a few additional attributes<a id="_idIndexMarker922"/> to fine-tune their behavior.</p>
			<p>The <code>&lt;kanban&gt;</code> top element supports <a id="_idIndexMarker923"/>these attributes:</p>
			<ul>
				<li><code>default_group_by</code>: This sets the field to use for the default column groups.</li>
				<li><code>default_order</code>: This sets a default order to use for the kanban items.</li>
				<li><code>quick_create="false"</code>: This disables the <code>quick_create</code> option to create new items by providing just a title description, using the plus sign at the right-hand side of each column header. The <code>false</code> value is a JavaScript literal and must be in lowercase.</li>
				<li><code>quick_create_view</code>: This can optionally be used to set a specific form view to use for the <code>quick_create</code> function. It should be set with the XML ID of the form view.</li>
				<li><code>class</code>: This adds a<a id="_idIndexMarker924"/> CSS class to the root element of the rendered kanban view. A relevant class is <code>o_kanban_small_column</code>, which makes columns somewhat more compact than the default. Additional classes <a id="_idIndexMarker925"/>may be made available through the CSS assets provided by the module.</li>
				<li><code>group_create</code>, <code>group_edit</code>, <code>group_delete</code>, and <code>quick_create_view</code>: These can be set to <code>false</code> to disable the corresponding action on the kanban columns. For example, <code>group_create="false"</code> removes the vertical <strong class="bold">Add new column</strong> bar on the right side of the screen.</li>
				<li><code>records_draggable="false"</code>: This disables the ability to drag records between columns.</li>
			</ul>
			<p>The <code>&lt;kanban&gt;</code> element can contain these elements:</p>
			<ul>
				<li><code>&lt;field&gt;</code>: This is used to declare the fields used by the QWeb templates that need to be retrieved from the server. This is necessary when those fields are used in QWeb evaluation expressions. It is not needed for fields used in a template <code>&lt;field&gt;</code> element.</li>
				<li><code>&lt;progressbar&gt;</code>: This element adds a progress bar widget on the group column headers.</li>
				<li><code>&lt;templates&gt;</code>: This element is required where the kanban card QWeb templates are declared.</li>
			</ul>
			<p>An example for the <code>&lt;templates&gt;</code> element can be seen in the minimal kanban view presented previously. An example of the <code>&lt;progressbar&gt;</code> element is provided next.</p>
			<h2 id="_idParaDest-329"><a id="_idTextAnchor334"/>Adding a progress bar to group columns</h2>
			<p>A <strong class="bold">progress bar</strong> can <a id="_idIndexMarker926"/>show a total number for the column and a colored bar representing the column record sub-states. The CRM Pipeline page uses it to provide a summary for the lead activities, from <strong class="bold">planned</strong> to <strong class="bold">overdue</strong>. Another example is the use of kanban states, as used by the <strong class="bold">Project Tasks</strong> kanban board.</p>
			<p>For this, first <code>kanban_state</code> needs to <a id="_idIndexMarker927"/>be added to the model, and then, it <a id="_idIndexMarker928"/>can be used in the view. To do so, apply the following steps:</p>
			<ol>
				<li value="1">Add the field to the <code>library.checkout</code> model, editing the <code>models/library_checkout.py</code> file as follows:<pre># class Checkout(models.Model):
<strong class="bold">    kanban_state = fields.Selection(</strong>
<strong class="bold">        [("normal", "In Progress"),</strong>
<strong class="bold">         ("blocked", "Blocked"),</strong>
<strong class="bold">         ("done", "Ready for next stage")],</strong>
<strong class="bold">        "Kanban State",</strong>
<strong class="bold">        default="normal")</strong></pre></li>
				<li>When changing the stage in the same file at the beginning of the <code>write()</code> method, add the business logic to reset <code>kanban_state</code>, as follows:<pre>    def write(self, vals):
<strong class="bold">        # reset kanban state when changing stage</strong>
<strong class="bold">        if "stage_id" in vals and "kanban_state" </strong>
<strong class="bold">          </strong><strong class="bold">not in vals:</strong>
<strong class="bold">            vals["kanban_state"] = "normal"</strong>
        # Code before write ...
        # ...
        return True</pre></li>
			</ol>
			<p>This completes the model changes needed for the time being. Here, we are focusing on adding the <a id="_idIndexMarker929"/>progress bar – the kanban status widget will<a id="_idIndexMarker930"/> be added in a later section.</p>
			<p>The <code>&lt;progressbar&gt;</code> element is one of the three element types allowed inside a <code>&lt;kanban&gt;</code> tag, along with <code>&lt;field&gt;</code> and <code>&lt;templates&gt;</code>.</p>
			<p>To add it to the <code>&lt;kanban&gt;</code> view definition, edit the element to add the following highlighted code:</p>
			<pre>&lt;kanban&gt;
<strong class="bold">  &lt;progressbar field="kanban_state" </strong>
<strong class="bold">   colors='{</strong>
<strong class="bold">     "done": "success",</strong>
<strong class="bold">     "blocked": "danger",</strong>
<strong class="bold">     "normal": "muted"}'</strong>
<strong class="bold">   sum_fields="num_books" </strong>
<strong class="bold">  /&gt;</strong>
  &lt;templates&gt;
    &lt;t t-name="kanban-box"&gt;
      &lt;div&gt;
        &lt;field name="name" /&gt;
      &lt;/div&gt;
    &lt;/t&gt;
  &lt;/templates&gt;
&lt;/kanban&gt;</pre>
			<p>The previous code adds the progress bar widget. The <code>field</code> attribute sets the model field to use, and the <code>colors</code> attribute maps the field values to the <code>"danger"</code>, <code>"warning"</code>, <code>"success"</code>, or <code>"muted"</code> colors.</p>
			<p>By default, the<a id="_idIndexMarker931"/> column total indicator counts the number<a id="_idIndexMarker932"/> of items in each column. This can be changed to be the sum of the values in a model field. In the previous code, the optional <code>sum_fields</code> attribute was added to present the total number of books in each column's requests.</p>
			<p>At this point, we have a functioning kanban view. However, the kanban cards can display richer features. The next section focuses on this, where we will further expand the templates used to render the kanban card content.</p>
			<h1 id="_idParaDest-330"><a id="_idTextAnchor335"/>Designing kanban cards</h1>
			<p>The design of a<a id="_idIndexMarker933"/> kanban card is quite flexible and uses HTML that is produced from QWeb templates declared in the <code>&lt;templates&gt;</code> element.</p>
			<p>The content area will often feature several other areas. Using the CRM Pipeline as a blueprint, the following sections can be found:</p>
			<ul>
				<li>A title section, with the lead short summary</li>
				<li>A content section, with the amount, customer name, and lead tags</li>
				<li>A left footer section, with the priority and activities widgets</li>
				<li>A right footer section, with the salesperson avatar</li>
				<li>A top-right menu button, which in this case, is visible on mouse hover</li>
			</ul>
			<p>This section implements the previous kanban card structure, and it populates each section to showcase the most important features. The first step for designing kanban cards is to lay out<a id="_idIndexMarker934"/> the kanban card skeleton, which is described next.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The proposed kanban skeleton, as well as certain CSS classes used, is based on the CRM Pipeline kanban view. Odoo modules can provide specific CSS classes and use them in the kanban card design. So, these can vary when inspecting the kanban view templates from different modules.</p>
			<h2 id="_idParaDest-331"><a id="_idTextAnchor336"/>Organizing the kanban card layout</h2>
			<p>The kanban card <a id="_idIndexMarker935"/>minimal design will now be expanded to a skeleton including several areas, which we will now describe.</p>
			<p>The kanban card is defined inside the <code>&lt;templates&gt;</code> section in an element with <code>t-name="kanban-box"</code>. This can be an HTML element or a QWeb <code>t-</code> directive. The definition created earlier in this chapter uses the neutral <code>&lt;t&gt;</code> QWeb element: <code>&lt;t t-name="kanban-box"&gt;</code>.</p>
			<p>Moving ahead, the kanban view template and the QWeb template should be edited to mark the areas to be worked on, as shown by the following code:</p>
			<pre>&lt;kanban&gt;
<strong class="bold">  &lt;!-- Field list to ensure is loaded ... --&gt;</strong>
  &lt;templates&gt;
    &lt;t t-name="kanban-box"&gt;
      &lt;div <strong class="bold">class="oe_kanban_global_click"</strong>&gt;
        &lt;div class="o_dropdown_kanban dropdown"&gt;
<strong class="bold">          &lt;!-- Top-right drop down menu ... --&gt;</strong>
        &lt;/div&gt;
        &lt;div class="oe_kanban_content"&gt;
          &lt;div class="o_kanban_record_title"&gt;
<strong class="bold">            &lt;!-- Title area ... --&gt;</strong>
<strong class="bold">            &lt;field name="name" /&gt;</strong>
          &lt;/div&gt;
          &lt;div class="o_kanban_record_body"&gt;
<strong class="bold">            &lt;!-- Other content area  </strong><strong class="bold">... --&gt;</strong>
          &lt;/div&gt;
          &lt;div class="o_kanban_record_bottom"&gt;
            &lt;div class="oe_kanban_bottom_left"&gt;
<strong class="bold">              &lt;!-- Left side footer... --&gt;</strong>
            &lt;/div&gt;
            &lt;div class="oe_kanban_bottom_right"&gt;
<strong class="bold">                &lt;!-- Right side footer... --&gt;</strong>
            &lt;/div&gt;
          &lt;/div&gt; &lt;!-- o_kanban_record_bottom --&gt;
          &lt;div class="oe_clear"/&gt;
        &lt;/div&gt; &lt;!-- oe_kanban_content --&gt;
      &lt;/div&gt; &lt;!-- oe_kanban_global_click --&gt;
&lt;/t&gt;</pre>
			<p>The previous QWeb<a id="_idIndexMarker936"/> template code provides a skeleton for all the areas usually seen in kanban cards.</p>
			<p>When the <code>t-name</code> QWeb attribute is used in a <code>&lt;t&gt;</code> element, this element can have only one child element. This was the case in the preceding code, and the <code>&lt;div&gt;</code> child element must contain all the other kanban view elements.</p>
			<p>It is worth noting that this overarching <code>&lt;div&gt;</code> element uses the <code>class="oe_kanban_global_click"</code> attribute. This makes the card clickable, and when the user does so, the corresponding form view will be opened in a similar way to what happens<a id="_idIndexMarker937"/> with list views.</p>
			<p>The next task is to focus on each of the highlighted areas and add content to them.</p>
			<h2 id="_idParaDest-332"><a id="_idTextAnchor337"/>Adding a title and other content fields</h2>
			<p>Now that we have a basic <a id="_idIndexMarker938"/>kanban card skeleton, the title and additional <a id="_idIndexMarker939"/>data can be added.</p>
			<p>These will go inside the <code>&lt;div class="oe_kanban_content"&gt;</code> element. The skeleton being used has sections for these: the <code>&lt;div class="o_kanban_record_title"&gt;</code> and <code>&lt;div class="o_kanban_record_body"&gt;</code> elements.</p>
			<p>The following code expands this section to highlight the card title and add the checkout request date and the requesting library member ID:</p>
			<pre>          &lt;div class="o_kanban_record_title"&gt;
<strong class="bold">            &lt;!-- Title area ... --&gt;</strong>
<strong class="bold">            &lt;strong&gt;&lt;field name="name" /&gt;&lt;/strong&gt;</strong>
          &lt;/div&gt;
          &lt;div class="o_kanban_record_body"&gt;
<strong class="bold">            &lt;!-- Other content area ... --&gt;</strong>
<strong class="bold">            &lt;div&gt;&lt;fields name="request_date" /&gt;&lt;/div&gt;</strong>
<strong class="bold">            &lt;div&gt;</strong>
<strong class="bold">              &lt;field name="member_id" </strong>
<strong class="bold">                widget="many2one_avatar"/&gt;</strong>
<strong class="bold">            &lt;/div&gt;</strong>
          &lt;/div&gt;</pre>
			<p>In this case, regular HTML elements can be used. For example, the <code>&lt;strong&gt;</code> element was used to highlight the title. Also, <code>&lt;field&gt;</code> elements can be used to render field values, which will be rendered using the appropriate formatting in a similar way to what happens in form views. In the previous code, <code>request_date</code> uses a <code>&lt;field&gt;</code> element, and so its content will be rendered using the Odoo-configured date format. It is wrapped in a <code>&lt;div&gt;</code> element so that there is a line break between several fields.</p>
			<p>The <code>member_id</code> many-to-one object is<a id="_idIndexMarker940"/> also added by using a specific widget that presents the corresponding avatar image along with the name, <code>widget="many2one_avatar"</code>.</p>
			<p>Now that we have added some basic data elements to the card, let's look at the drop-down menu area.</p>
			<h2 id="_idParaDest-333"><a id="_idTextAnchor338"/>Adding the drop-down options menu</h2>
			<p>Kanban cards can have an<a id="_idIndexMarker941"/> options menu on the top-right corner. Common options include being able to edit or delete the record, set a color for the card, or run any action that can be called from a button.</p>
			<p>The following is the baseline HTML code for the options menu to be added to the top of the <code>oe_kanban_content</code> element:</p>
			<pre>        &lt;div class="o_dropdown_kanban dropdown"&gt;
          &lt;!-- Top-right drop down menu ... --&gt;
<strong class="bold">          &lt;a class="dropdown-toggle btn"</strong>
<strong class="bold">             role="button" data-toggle="dropdown"</strong>
<strong class="bold">             title="Dropdown menu" href="#"&gt;</strong>
<strong class="bold">            &lt;span class="fa fa-ellipsis-v" /&gt;</strong>
<strong class="bold">          &lt;/a&gt;</strong>
<strong class="bold">          &lt;div class="dropdown-menu" role="menu"&gt;</strong>
<strong class="bold">            &lt;!-- Edit menu option --&gt;</strong>
<strong class="bold">            &lt;t t-if="widget.editable"&gt;</strong>
<strong class="bold">              &lt;a role="menuitem" type="edit"</strong>
<strong class="bold">                 class="dropdown-item"&gt;Edit&lt;/a&gt;</strong>
<strong class="bold">            &lt;/t&gt;</strong>
<strong class="bold">            &lt;!-- Delete menu option --&gt;</strong>
<strong class="bold">            </strong><strong class="bold">&lt;t t-if="widget.deletable"&gt;</strong>
<strong class="bold">              &lt;a role="menuitem" type="delete"</strong>
<strong class="bold">                 class="dropdown-item"&gt;Delete&lt;/a&gt;</strong>
<strong class="bold">            &lt;/t&gt;</strong>
<strong class="bold">            &lt;!-- Separator line --&gt;</strong>
<strong class="bold">            &lt;div role="separator" class=</strong>
<strong class="bold">              "dropdown-divider"/&gt;</strong>
<strong class="bold">            &lt;!-- Color picker option: --&gt;</strong>
<strong class="bold">            &lt;ul class="oe_kanban_colorpicker" </strong>
<strong class="bold">              </strong><strong class="bold">data-field="color" /&gt;</strong>
<strong class="bold">            &lt;!-- Set as Done menu option --&gt;</strong>
<strong class="bold">            &lt;a t-if="record.state != 'done'" </strong>
<strong class="bold">               role="menuitem" class="dropdown-item"</strong>
<strong class="bold">               name="button_done" type="object"&gt;Set </strong>
<strong class="bold">               as Done&lt;/a&gt;</strong>
<strong class="bold">          &lt;/div&gt;</strong>
        &lt;/div&gt;</pre>
			<p>Here, there are QWeb expressions using fields that may not be loaded into the view. In particular, the last <code>t-if</code> expression uses the record's <code>state</code> field. To ensure this field is available in the form, it should be added just after the <code>&lt;kanban&gt;</code> element:</p>
			<pre>&lt;kanban&gt;
  &lt;!-- Field list to ensure is loaded ... --&gt;
<strong class="bold">  &lt;field name="state" /&gt;</strong></pre>
			<p>Let's break down the <a id="_idIndexMarker942"/>drop-down menu code and look at the key elements added:</p>
			<ul>
				<li>The ellipsis icon, in an HTML anchor (<code>&lt;a&gt;</code>) element, to present the menu button.</li>
				<li>A <code>&lt;div class="dropdown-menu" role="menu"&gt;</code> element, containing the menu options.</li>
				<li>The <code>&lt;a&gt;</code> element with <code>type="edit".</code></li>
				<li>The <code>&lt;a&gt;</code> element with <code>type="delete".</code></li>
				<li>A separator line, using <code>&lt;div role="separator" class="dropdown-divider"/&gt;.</code></li>
				<li>A color picker menu option added with a <code>&lt;ul class="oe_kanban_colorpicker" /&gt;</code> element. The <code>data-field</code> attribute sets the field used to store the picked color. This capability will be implemented in the next section, so it won't work right now.</li>
				<li>A menu item equivalent to a button click, added with an <code>&lt;a&gt;</code> element, featuring the same <code>name</code> and <code>type</code> attributes used in regular buttons. This particular one uses <code>name="button_done" type="object"</code>.</li>
			</ul>
			<p>Some menu items, such as <code>t-if</code> QWeb directive. This and other QWeb directives are explained in more detail later in this chapter in the <em class="italic">Exploring the QWeb template language</em> section.</p>
			<p>The <code>widget</code> global variable represents a <code>KanbanRecord()</code> JavaScript object, which is responsible for the rendering of the current kanban card. Two particularly useful properties are <code>widget.editable</code> and <code>widget.deletable</code>, which allow us to check whether the corresponding actions are available.</p>
			<p>Menu items can be added with additional <code>&lt;a&gt;</code> elements in a similar way to the <strong class="bold">Set as Done</strong> option.</p>
			<p>Menu items can<a id="_idIndexMarker943"/> be shown or hidden using a JavaScript expression that can use record field values. For example, the <code>state</code> field is not set to <code>done</code>.</p>
			<p>The color picker menu option uses a special widget that uses a <code>color</code> model field to store the picked color. While the color selector is available, we did not add the feature to set the card yet. Let's do this in the next section.</p>
			<h2 id="_idParaDest-334"><a id="_idTextAnchor339"/>Adding a kanban card color indicator</h2>
			<p>Kanban cards can be <a id="_idIndexMarker944"/>set with a user-selected color. This colors a bar on the left side of the card and can be useful to easily locate items.</p>
			<p>The color to apply is selected using a color picker option on the card's menu. This is added with a <code>&lt;ul class="oe_kanban_colorpicker" data-field="color"/&gt;</code> element, as shown in the previous section. The <code>data-field</code> attribute sets the field to use, which in this case is <code>color</code>.</p>
			<p>To add a kanban color card indicator, complete the following steps:</p>
			<ol>
				<li value="1">Add the color field in the <code>library.checkout</code> model by editing the <code>models/library_checkout.py</code> file as follows:<pre># class Checkout(models.Model):
# ...
<strong class="bold">    color = fields.Integer()</strong></pre><p>This is a regular integer field. The color picker widget maps the selectable color to numbers.</p></li>
				<li>Now, the color field can be used to set a dynamic CSS style on the kanban cards though QWeb. First, add it to the fields to load by adding the following code:<pre>&lt;kanban&gt;
  &lt;!-- Field list to ensure is loaded ... --&gt;
<strong class="bold">  &lt;field name="color" /&gt;</strong>
  &lt;field name="state" /&gt;</pre></li>
				<li>Finally, edit the kanban card top <code>&lt;div&gt;</code> element to add the dynamic color style, as shown in the <a id="_idIndexMarker945"/>following code:<pre>    &lt;t t-name="kanban-box"&gt;
      &lt;div <strong class="bold">t-attf-class="</strong>oe_kanban_global_click
<strong class="bold">         {{!selection_mode ? 'oe_kanban_color_' +</strong>
<strong class="bold">           kanban_getcolor(record.color.raw_value) : </strong>
<strong class="bold">        ''}}"&gt;</strong></pre></li>
			</ol>
			<p>The preceding code uses <code>t-attf-class</code> to dynamically calculate a CSS class to apply. A JavaScript expression is declared in a <code>{{ }}</code> block to be evaluated and return a style to use, which depends on the <code>color</code> field value. This completes the steps to add a kanban color card indicator. </p>
			<p>A few more widgets are available for kanban cards. The next sections show how to use them, where we will add them to the card footer section.</p>
			<h2 id="_idParaDest-335"><a id="_idTextAnchor340"/>Adding priority and activity widgets</h2>
			<p>The priority widget<a id="_idIndexMarker946"/> is displayed as a list of stars that can be clicked to select a priority level. This widget is a <code>&lt;field&gt;</code> element with <code>widget="priority"</code>. The priority field is a <code>Selection</code> field, declaring the several priority levels available.</p>
			<p>The <code>library.checkout</code> model needs to be modified to add a priority field. To do this, complete the following steps:</p>
			<ol>
				<li value="1">Edit the <code>models/library_checkout.py</code> file as follows:<pre># class Checkout(models.Model):
# ...
<code>&lt;field name="activity_ids"&gt;</code>) with <code>widget="kanban_activity"</code>.</p></li>
				<li>Now, the corresponding <code>&lt;field&gt;</code> elements need to be added to the kanban template on the left side. So, insert the priority widget:<pre>&lt;div class="oe_kanban_footer_left"&gt; 
  &lt;!-- Left side footer... --&gt; 
<strong class="bold">  &lt;field name="priority" widget="priority"/&gt; </strong>
<strong class="bold">  &lt;field name="activity_ids" </strong>
<strong class="bold">    widget="kanban_activity"/&gt;</strong>
&lt;/div&gt;</pre></li>
			</ol>
			<p>The kanban card now has the priority and activity widgets added to the left side of the footer. Next, we will add a few more widgets to the right footer.</p>
			<h2 id="_idParaDest-336"><a id="_idTextAnchor341"/>Adding kanban state and user avatar widgets</h2>
			<p>The kanban state widget<a id="_idIndexMarker948"/> presents a traffic light color for the item. It is a <code>&lt;field&gt;</code> element using <code>widget="kanban_state_selection"</code>.</p>
			<p>For related user records, a specific widget is available for this: <code>widget="many2one_avatar_user"</code>.</p>
			<p>Examples of<a id="_idIndexMarker949"/> both of these will be added to the kanban card right footer, as shown in the following code:</p>
			<pre>&lt;div class="oe_kanban_footer_right"&gt;
  &lt;!-- Right side footer... --&gt;
<strong class="bold">  &lt;field name="kanban_state"</strong>
<strong class="bold">         widget="kanban_state_selection" /&gt;</strong>
<strong class="bold">  &lt;field name="user_id"</strong>
<strong class="bold">         widget="many2one_avatar_user" /&gt;</strong>
&lt;/div&gt;</pre>
			<p>The kanban state is added using a <code>&lt;field&gt;</code> element with the <code>kanban_state_selection</code> widget. </p>
			<p>The user <a id="_idIndexMarker950"/>avatar image is added with the <code>user_id</code> field, using the <code>widget="many2one_avatar_user"</code> widget.</p>
			<p>One more important topic is using actions on kanban cards, which we will discuss in the following section.</p>
			<h2 id="_idParaDest-337"><a id="_idTextAnchor342"/>Using actions in kanban view elements</h2>
			<p>In QWeb<a id="_idIndexMarker951"/> templates, the <code>&lt;a&gt;</code> tag for links can have a <code>type</code> attribute. This <a id="_idIndexMarker952"/>sets the type of action the link will perform so that links can act just like buttons in regular forms. So, in addition to the <code>&lt;button&gt;</code> elements, the <code>&lt;a&gt;</code> tags can also be used to run Odoo actions.</p>
			<p>As is the case in form views, the action type can be set to <code>action</code> or <code>object</code> and should be accompanied by a <code>name</code> attribute that identifies the specific action to execute. Additionally, the following action types are also available:</p>
			<ul>
				<li><code>open</code>: This opens the corresponding form view.</li>
				<li><code>edit</code>: This opens the corresponding form view directly in edit mode.</li>
				<li><code>delete</code>: This deletes the record and removes the item from the kanban view.</li>
			</ul>
			<p>This completes our walkthrough of designing kanban views. Kanban views use the QWeb template language, and a few examples were used here. The next section takes a deep dive into QWeb.</p>
			<h1 id="_idParaDest-338"><a id="_idTextAnchor343"/>Exploring the QWeb template language</h1>
			<p>The QWeb parser looks for <a id="_idIndexMarker953"/>special directives in the templates and replaces them with dynamically generated HTML. These directives are XML element attributes and can be used in any valid tag or element – for example, <code>&lt;div&gt;</code>, <code>&lt;span&gt;</code>, or <code>&lt;field&gt;</code>.</p>
			<p>Sometimes, a QWeb directive needs to be used, but we don't want to place it in any of the XML elements in the template. For these cases, the <code>&lt;t&gt;</code> special element can be used. It can have QWeb directives such as <code>t-if</code> or <code>t-foreach</code>, but it is silent, and it won't have any effect on the final XML/HTML produced.</p>
			<p>The QWeb directives frequently use evaluated expressions to produce different effects that depend on record values. The language used to evaluate these expressions depends on the environment where the QWeb is being executed. There are two different QWeb implementations: <strong class="bold">client-side</strong> <strong class="bold">JavaScript</strong> and <strong class="bold">server-side</strong> <strong class="bold">Python</strong>. Reports and website pages use the server-side Python implementation of QWeb.</p>
			<p>Kanban views use the client-side JavaScript implementation. This means that the QWeb expression used in kanban views should be written using the JavaScript syntax, not Python.</p>
			<p>When displaying a kanban view, the internal steps are roughly as follows:</p>
			<ol>
				<li value="1">Get the XML for the templates to render.</li>
				<li>Call the server <code>read()</code> method to get the data for the fields used in the templates.</li>
				<li>Locate the <code>kanban-box</code> template and parse it using QWeb to output the final HTML fragments.</li>
				<li>Inject the HTML in the browser display (the <strong class="bold">Document Object Model</strong> (<strong class="bold">DOM</strong>)).</li>
			</ol>
			<p>This is not meant to be technically exact. It's just a mind map that can be useful to understand how things work in kanban views.</p>
			<p>Next, we'll learn about QWeb expression evaluation and explore the available QWeb directives, using examples that will enhance the checkout kanban card.</p>
			<h2 id="_idParaDest-339"><a id="_idTextAnchor344"/>Understanding the QWeb JavaScript evaluation context</h2>
			<p>Many of the QWeb directives <a id="_idIndexMarker954"/>use expressions that are evaluated to produce some result. When used on the client side (as is the case for Kanban views), these expressions are written in JavaScript. They're evaluated in a context that has a few useful variables available.</p>
			<p>A <code>record</code> object is available, representing the current record, with the fields requested from the server. The field values can be accessed using either the <code>raw_value</code> or <code>value</code> attributes:</p>
			<ul>
				<li><code>raw_value</code>: This is the value returned by the <code>read()</code> server method, so it's more suitable for use in condition expressions.</li>
				<li><code>value</code>: This is formatted according to the user settings and is meant to be used for display in the user interface. This is typically useful for date, datetime, float, monetary, and relational fields.</li>
			</ul>
			<p>The QWeb evaluation context can also reference the JavaScript web client instance. To make use of that, a good understanding of the web client architecture is needed. In this chapter, we won't be able to go into detail regarding this. However, for reference purposes, the following identifiers are available in QWeb expression evaluation:</p>
			<ul>
				<li><code>widget</code>: This is a reference to the current <code>KanbanRecord()</code> widget object and is responsible for the rendering of the current record into a kanban card. It exposes some helper functions we can use.</li>
				<li><code>record</code>: This is a shortcut for <code>widget.record</code> and provides access to the fields available, using dot notation.</li>
				<li><code>read_only_mode</code>: This indicates whether the current view is in read mode (and not in edit mode). It's a shortcut for <code>widget.view.options.read_only_mode</code>.</li>
				<li><code>instance</code>: This is a reference to the full web client instance.</li>
			</ul>
			<p>Since QWeb templates are written in XML files, there are limitations on the usage of some characters not accepted by the XML format (such as the lower than sign (<code>&lt;</code>)). When these characters are needed – for example, to describe JavaScript expressions – escaped alternatives need to be used.</p>
			<p>These are the alternative symbols that are available for inequality operations:</p>
			<ul>
				<li><code>&amp;lt;</code> is for less than (<code>&lt;</code>).</li>
				<li><code>&amp;lt;=</code> is for less than or equal to (<code>&lt;=</code>).</li>
				<li><code>&amp;gt;</code> is for greater than (<code>&gt;</code>).</li>
				<li><code>&amp;gt;=</code> is for greater than or equal to (<code>&gt;=</code>).</li>
			</ul>
			<p>The preceding<a id="_idIndexMarker955"/> comparison symbols are not specific to Odoo and are part of the XML format standards.</p>
			<p>The previous symbols can be used in QWeb evaluated expressions, and they are often used to calculate text to render for the <code>t-out</code> directive, which we will describe in the following section.</p>
			<h2 id="_idParaDest-340"><a id="_idTextAnchor345"/>Using t-out to render values</h2>
			<p>The <code>&lt;field&gt;</code> element is <a id="_idIndexMarker956"/>available to render field values, with the <a id="_idIndexMarker957"/>advantage of Odoo taking care of properly formatting the output for us. But this has the limitation of only displaying the field content.</p>
			<p>However, the <code>t-out</code> directive can render the result of a code expression as an HTML-escaped value:</p>
			<pre>&lt;t t-out="'Requested on ${record.request_date.value}'" /&gt;</pre>
			<p>The preceding code renders the result of a JavaScript expression. The <code>record</code> represents the record retrieved from the Odoo server and provides access to the fields. The <code>value</code> property returns properly formatted content, as returned by a <code>&lt;field&gt;</code> element. The <code>raw_value</code> property returns the unformatted native value.</p>
			<p class="callout-heading">Changes in Odoo 15</p>
			<p class="callout">The <code>t-out</code> directive was introduced in <code>t-esc</code> directive, used until <code>t-raw</code> directive was also discontinued. This was previously used to render the raw value without escaping any HTML, and using it carries security risks. </p>
			<h2 id="_idParaDest-341"><a id="_idTextAnchor346"/>Using t-set to assign values to variables</h2>
			<p>For more <a id="_idIndexMarker958"/>complex logic, the result of an expression<a id="_idIndexMarker959"/> can be stored into a variable to use later in the template. This is to be done using the <code>t-set</code> directive for the variable name to be set, followed by the <code>t-value</code> directive with the expression to calculate the value to be assigned.</p>
			<p>As an example, the following code renders the title in red if the request has no lines yet. It uses a <code>red_or_black</code> variable for the CSS class to use, shown as follows:</p>
			<pre><strong class="bold">&lt;t t-set="red_or_black"</strong>
<strong class="bold">   t-value="record.num_books == 0 ? '' : </strong>
<strong class="bold">    'oe_kanban_text_red'"</strong>
<strong class="bold">/&gt;</strong>
&lt;strong <strong class="bold">t-att-class="red_or_black"</strong>&gt;
  &lt;field name="name" /&gt;
&lt;/strong&gt;</pre>
			<p>The previous example has a code expression using the <code>num_books</code> field, so we need to ensure it is loaded by adding a <code>&lt;field name="num_books" /&gt;</code> element inside the <code>&lt;kanban&gt;</code> top element.</p>
			<p>Variables can also be assigned HTML content, as in the following example:</p>
			<pre>&lt;t t-set="calendar_sign"&gt;
  &lt;i class="fa fa-calendar" title="Calendar" /&gt;
&lt;/t&gt;
&lt;t t-out="calendar_sign" /&gt;</pre>
			<p>The previous code assigns the HTML inside to the <code>calendar_sign</code> variable and then renders it using the <code>t-out</code> directive.</p>
			<h2 id="_idParaDest-342"><a id="_idTextAnchor347"/>Using t-attf- for string substitution of dynamic attributes</h2>
			<p>Our kanban card is <a id="_idIndexMarker960"/>using the <code>t-attf-</code> QWeb <a id="_idIndexMarker961"/>directive to dynamically set a class in the top <code>&lt;div&gt;</code> element so that the card color depends on the <code>color</code> field value. For this, the <code>t-attf-</code> QWeb directive was used.</p>
			<p>The <code>t-attf-</code> directive dynamically generates tag attributes using string substitution. This allows for parts of larger strings to be generated dynamically, such as URLs or CSS class names.</p>
			<p>The directive looks for expression blocks that will be evaluated and replaced by the results. These are delimited either by <code>{{</code> and <code>}}</code> or by <code>#{</code> and <code>}</code>. The content of the blocks can be any valid JavaScript expression and can use any of the variables available for QWeb expressions, such as <code>record</code> and <code>widget</code>.</p>
			<p>In this case, the <code>kanban_color()</code> JavaScript function was used. This is specifically provided to map color index numbers into the CSS class color names.</p>
			<p>As an elaborate example, this directive will be used to dynamically change the color of the request date to be in red letters if the priority is high. For this, the <code>&lt;field name="request_date"/&gt;</code> element in the kanban card should be replaced with the following:</p>
			<pre>&lt;div <strong class="bold">t-attf-</strong>class="oe_kanban_text_{{
  record.priority.raw_value &amp;lt; '2'
  ? 'black' : 'red' }}"&gt;
  &lt;field name="request_date"/&gt;
&lt;/div&gt;</pre>
			<p>This results in either <code>class="oe_kanban_text_red"</code> or <code>class="oe_kanban_text_black"</code>, depending on the priority value. This is evaluated dynamically – that means that when the user clicks on the priority widget to change it, the date color will immediately change.</p>
			<h2 id="_idParaDest-343"><a id="_idTextAnchor348"/>Using t-att- for expressions calculated by dynamic attributes</h2>
			<p>The <code>t-att-</code> QWeb directive<a id="_idIndexMarker962"/> can dynamically generate an attribute value from an expression evaluation.</p>
			<p>For example, the formatting effect from the previous section that used the <code>t-attf-</code> attribute could alternatively be implemented using <code>t-att-</code>. The following code shows this alternative implementation:</p>
			<pre>&lt;div <strong class="bold">t-att-</strong>class="record.priority.raw_value &amp;lt; '2'
  ? 'oe_kanban_text_black' : 'oe_kanban_text_red'"&gt;
  &lt;field name="request_date"/&gt;
&lt;/div&gt;</pre>
			<p>When the expression evaluates to a false-equivalent value, the attribute is not rendered at all. This is important for special HTML attributes such as the <code>checked</code> input field.</p>
			<h2 id="_idParaDest-344"><a id="_idTextAnchor349"/>Using t-foreach for loops</h2>
			<p>Iterating through loops is <a id="_idIndexMarker963"/>useful to repeat a particular HTML block. For this, the <code>t-foreach</code> directive is used with an expression returning an iterable value. It needs to be accompanied by a <code>t-as</code> directive, which sets the variable name for the iteration value.</p>
			<p>This could be used to present the book titles requested in the checkout. This requires a loop on the <code>lines_ids</code> field.</p>
			<p>Note that the accessible values for the <code>line_ids</code> elements are database IDs and not record objects. This can be confirmed by adding the following code in the <code>&lt;!-- Other content area  --&gt;</code> area:</p>
			<pre>&lt;div&gt;
  &lt;t <strong class="bold">t-foreach="record.line_ids.raw_value" t-as="line"</strong>&gt;
    &lt;t t-out="line" /&gt;;
  &lt;/t&gt;
&lt;/div&gt;</pre>
			<p>The <code>t-foreach</code> directive accepts a JavaScript expression evaluating to a collection to iterate. <code>record.&lt;field&gt;.value</code> returns a representation of a string for the field value, and <code>record.&lt;field&gt;.raw_value</code> returns the database-stored values. For a to-many field, this is a list of IDS:</p>
			<ul>
				<li>The <code>t-as</code> directive sets the variable name to be used to refer to each iteration value.</li>
				<li>The <code>t-out</code> directive evaluates the provided expression – in this case, just the <code>line</code> variable name – and renders safely escaped HTML.</li>
			</ul>
			<p>Presenting the record IDs is not very interesting. However, we do have a JavaScript function available to retrieve an image for an ID: <code>kanban_image()</code>.</p>
			<p>To use this, first, the<a id="_idIndexMarker964"/> checkout lines need to support an image. For this, the <code>models/library_checkout_line.py</code> file should be edited to add a field for the book cover image:</p>
			<pre>    book_cover = fields.Binary(related="book_id.image")</pre>
			<p>Now, this field can be used in the kanban card:</p>
			<pre>&lt;div&gt;
  &lt;t <strong class="bold">t-foreach="record.line_ids.raw_value" t-as="line"</strong>&gt;
    &lt;t t-out="line" /&gt;;
    &lt;img t-att-src="kanban_image(
      'library.checkout.line', 'book_cover', line)" 
      class="oe_avatar" height="60" alt="Cover" /&gt; 
  &lt;/t&gt;
&lt;/div&gt;</pre>
			<p>The previous code renders an image for the book title in each checkout line.</p>
			<p>If there are many lines, this might be too much content for the kanban card. Since the <code>t-foreach</code> object is a JavaScript expression, it can use additional syntax to limit the number of the allowed cover thumbnails. JavaScript arrays have a <code>slice()</code> method to extract a subset of elements.</p>
			<p>This can be used to limit the number to the first five elements by using the following variation of the <code>for</code> loop:</p>
			<pre>&lt;t t-foreach="record.line_ids.raw_value.slice(0, 5)" t-as="line&gt;</pre>
			<p>The <code>for</code> loops have a few helper variables available. These variables are automatically generated and are prefixed by the variable name defined in <code>t-as</code>.</p>
			<p>If <code>t-as="rec"</code> is used, where <code>rec</code> is set as the variable name, the helper variables would be as follows:</p>
			<ul>
				<li><code>rec_index</code>: This is the iteration index, starting from zero.</li>
				<li><code>rec_size</code>: This is the number of elements of the collection.</li>
				<li><code>rec_first</code>: This is true on the first element of the iteration.</li>
				<li><code>rec_last</code>: This is true on the last element of the iteration.</li>
				<li><code>rec_even</code>: This is true on even indexes.</li>
				<li><code>rec_odd</code>: This is true on odd indexes.</li>
				<li><code>rec_parity</code>: This is either <code>odd</code> or <code>even</code>, depending on the current index.</li>
				<li><code>rec_all</code>: This represents the object being iterated over.</li>
				<li><code>rec_value</code>: This holds the value when iterating through a <code>{key:value}</code> dictionary (<code>rec</code> holds the key name).</li>
			</ul>
			<p>For example, when<a id="_idIndexMarker965"/> presenting a list of comma-separated values, we would like to avoid a trailing comma. Avoiding rendering it on the last iteration is easy with the help of the <code>_last</code> loop variable. Here is an example of this:</p>
			<pre>&lt;t t-foreach="record.line_ids.raw_value" t-as="rec"&gt;
  &lt;t t-out="rec" /&gt;
  <strong class="bold">&lt;t t-if="!rec_last"&gt;;&lt;/t&gt;</strong>
&lt;/t&gt;</pre>
			<p>The <code>rec_last</code> variable is <code>true</code> on the last record. Negating it with <code>!rec_last</code> enables printing the comma on all iterations except the last one.</p>
			<h2 id="_idParaDest-345"><a id="_idTextAnchor350"/>Using t-if to apply conditions</h2>
			<p>The <code>t-if</code> directive<a id="_idIndexMarker966"/> expects an expression to be evaluated in JavaScript when rendering kanban views on the client side. The tag and its content will be rendered only if the condition evaluates to <code>true</code>.</p>
			<p>In our example, it was used in the checkout kanban view to have menu options available depending on some conditions.</p>
			<p>To take another example, we can display the checkout number of books borrowed, but only if the view has any lines. This can be confirmed by adding the following code in the <code>&lt;!-- Other content area  --&gt;</code> area:</p>
			<pre>&lt;div&gt; t-if="record.num_books.raw_value &amp;gt; 0"&gt; 
  &lt;field name="num_books"/&gt; books 
&lt;/div&gt;&gt;</pre>
			<p>Here, we used a <code>t-if="&lt;expression&gt;"&gt;</code> attribute to render an element and its content only when the expression used evaluated to <code>true</code>. Notice that the condition expression uses the <code>&amp;gt;</code> symbol instead of <code>&gt;</code> to represent the greater-than operation.</p>
			<p>The <code>else if</code> and <code>else</code> conditions are also supported with the <code>t-elif</code> and <code>t-else</code> directives. Here is an example of their use:</p>
			<pre>&lt;div t-if="record.num_books.raw_value == 0"&gt;
  No books!
&lt;/div&gt;
&lt;div t-elif="record.num_books.raw_value == 1"&gt;
  One book
&lt;/div&gt;
&lt;div t-else=""&gt;
  &lt;field name="num_books"/&gt; books
&lt;/div&gt;</pre>
			<p>These conditions are useful to render particular elements on particular cases.</p>
			<p>Another useful feature is the ability to decompose templates into smaller reusable snippets that can be included using <code>t-call</code>. The following section explains how this works.</p>
			<h2 id="_idParaDest-346"><a id="_idTextAnchor351"/>Using t-call to call and reuse templates</h2>
			<p>Instead of repeating the same HTML blocks over and over again, building blocks can be used to compose more complex user interface views. QWeb templates can be used as reusable HTML snippets that are inserted into other templates.</p>
			<p>Reusable <a id="_idIndexMarker967"/>templates are defined inside the <code>&lt;templates&gt;</code> tag and identified by a top element with <code>t-name</code> other than <code>kanban-box</code>. These other templates can then be included using the <code>t-call</code> directive. This is true for the <a id="_idIndexMarker968"/>templates declared in the same kanban view, somewhere else in the same addon module, or even in a different addon.</p>
			<p>As an example, the book cover list could be isolated in a reusable snippet. For this, another template can be added in the <code>&lt;templates&gt;</code> element after the <code>&lt;t t-name="kanban-box"&gt;</code> node, as shown in the following example:</p>
			<pre>&lt;t <strong class="bold">t-name="book_covers"</strong>&gt;
  &lt;div&gt;
    &lt;t t-foreach="record.line_ids.raw_value" t-as="line"&gt;
      &lt;t t-out="line" /&gt;;
      &lt;img t-att-src="kanban_image(
        'library.checkout.line', 'book_cover', line)"
        class="oe_avatar" height="60" alt="Cover" /&gt;
    &lt;/t&gt;
  &lt;/div&gt;
&lt;/t&gt;</pre>
			<p>Then, the <code>t-call</code> directive can be used to call this template in the <code>kanban-box</code> main template:</p>
			<pre>&lt;t t-call="book_covers" /&gt;</pre>
			<p>To call templates defined in other addon modules, the <code>module.name</code> full identifier must be used, in a similar way to what happens with other views. For instance, this snippet can be referred to in another module using the <code>library_checkout.book_covers</code> full identifier.</p>
			<p>The called template runs in the same context as the caller, so any variable names available in the caller are also available when processing the called template.</p>
			<p>A more elegant <a id="_idIndexMarker969"/>alternative is to pass arguments to the called template. This is<a id="_idIndexMarker970"/> done by setting variables inside the <code>t-call</code> tag. These will be evaluated and made available in the sub-template context only, and they won't exist in the caller context.</p>
			<p>As an example, the <code>books_cover</code> template could have an argument to set the maximum number of covers to display instead of being hardcoded in the sub-template. First, the <code>book_covers</code> template should be edited to replace the fixed limit with a variable, such as <code>limit</code>:</p>
			<pre>&lt;t t-name="book_covers"&gt;
  &lt;div&gt;
    &lt;t t-foreach="record.line_ids.raw_value.<strong class="bold">slice(0, </strong>
<strong class="bold">      limit)</strong>"
       t-as="line"&gt;
      &lt;t t-out="line" /&gt;;
      &lt;img t-att-src="kanban_image(
        'library.checkout.line', 'book_cover', line)"
        class="oe_avatar" height="60" alt="Cover" /&gt;
    &lt;/t&gt;
  &lt;/div&gt;
&lt;/t&gt;</pre>
			<p>Now, <code>t-call</code> must set this variable using a nested <code>t-set</code> directive, as shown in the following code:</p>
			<pre>&lt;t t-call="book_covers"&gt; 
  &lt;t t-set="limit" t-value="3" /&gt; 
&lt;/t&gt;</pre>
			<p>The entire <a id="_idIndexMarker971"/>content inside the <code>t-call</code> element is also available to the<a id="_idIndexMarker972"/> sub-template through the <code>0</code> magic variable. Instead of argument variables, an HTML code fragment could be added inside the <code>t-call</code> element, and then it could be used in the called template with <code>&lt;t t-out="0" /&gt;</code>. This is especially useful for building layouts and combining/nesting QWeb templates in a modular way.</p>
			<h2 id="_idParaDest-347"><a id="_idTextAnchor352"/>Using dictionaries and lists to dynamically set attributes</h2>
			<p>We've gone <a id="_idIndexMarker973"/>through the most important QWeb <a id="_idIndexMarker974"/>directives, but there are a few more to be aware of. Now, we'll give a short explanation of them.</p>
			<p>Here, the <code>t-att-NAME</code> and <code>t-attf-NAME</code> style dynamic tag attributes were introduced. Additionally,  the fixed <code>t-att</code> directive can be used. It accepts either a key-value dictionary mapping or a pair (that is, a two-element list).</p>
			<p>For example, consider the following mapping:</p>
			<pre>&lt;p t-att="{'class': 'oe_bold', 'name': 'Hello'}" /&gt;</pre>
			<p>The preceding code produces this result:</p>
			<pre>&lt;p class="oe_bold" name="Hello" /&gt;</pre>
			<p><code>t-att</code> can also work with a list or with pairs of values. For example, consider the following:</p>
			<pre>&lt;p t-att="['class', 'oe_bold']" /&gt;</pre>
			<p>The preceding code produces this result:</p>
			<pre>&lt;p class="oe_bold" /&gt;</pre>
			<p>These special ways to assign attributes to elements can be useful in cases where there is some server-side processing, and a resulting dictionary or list can be used on a single <code>t-att</code> element to be applied on a template element.</p>
			<p>This completes a reasonable overview of the QWeb template language with a special focus on kanban view applications, although the QWeb language is also used on the server side – for example, it can be used for reports and website pages.</p>
			<p>Not surprisingly, QWeb templates provide an extension mechanism. We will explore this in the next section.</p>
			<h1 id="_idParaDest-348"><a id="_idTextAnchor353"/>Extending kanban views</h1>
			<p>The templates used in <a id="_idIndexMarker975"/>kanban views and reports can be extended in the same way other view types are extended: that is, declare the element to match, possibly using an XPath expression, and use the position attribute to set what the extensions should do (for example, add the new elements after of before the matched element). These techniques are explained in detail in <a href="B16119_04_Final_PD_ePub.xhtml#_idTextAnchor119"><em class="italic">Chapter 4</em></a>, <em class="italic">Extending Modules</em>.</p>
			<p>In practice, kanban views and QWeb templates are more complex than the regular form view, and matching the elements to extend can be tricky.</p>
			<p>Using <code>&lt;field&gt;</code> elements as selectors can be difficult. It is common for the same field name to be included more than once in a kanban view: at the beginning, in the field list to load, and then again inside the kanban box template. Since the selector will match the first field element found, the modification won't be applied inside the template, as intended.</p>
			<p>For example, the <code>//t[@t-name='kanban-box']//field[@name='name']</code> XPath expression locates any child elements matching <code>&lt;t t-name="kanban-box"&gt;</code>, and then it finds any further child elements matching <code>&lt;field name="name"&gt;</code>.</p>
			<p>Another challenge is the frequent use of HTML elements with no clear identifier, such as <code>&lt;div&gt;</code> or <code>&lt;span&gt;</code>. In these cases, XPath expressions with non-trivial matching conditions are needed. For example, the <code>//div/t/img</code> XPath expression matches a <code>&lt;div&gt;&lt;t&gt;&lt;img&gt;</code> nested sequence of elements.</p>
			<p>The following is an example that extends the <code>Contacts</code> kanban view:</p>
			<pre>&lt;record id="res_partner_kanban_inherit" model="ir.ui.view"&gt; 
  &lt;field name="name"&gt;Contact Kanban modification&lt;/field&gt; 
  &lt;field name="model"&gt;res.partner&lt;/field&gt; 
  &lt;field name="inherit_id" 
    ref="base.res_partner_kanban_view" /&gt; 
  &lt;field name="arch" type="xml"&gt; 
    &lt;xpath
     expr="//t[@t-name=
       'kanban-box']//field[@name='display_name']" 
     position="before"&gt; 
     &lt;span&gt;Name:&lt;/span&gt; 
    &lt;/xpath&gt; 
  &lt;/field&gt; 
&lt;/record&gt;</pre>
			<p>In the previous example, XPath looks for a <code>&lt;field name="display_name"&gt;</code> element inside a <code>&lt;t t-name="kanban-box"&gt;</code> element. This rules out the same field element outside of the <code>&lt;templates&gt;</code> section.</p>
			<p>For complex XPath <a id="_idIndexMarker976"/>expressions, some command-line tools can be helpful to explore the correct syntax to use.</p>
			<p>The <code>xmllint</code> command-line utility – from the <code>libxml2-utils</code> <code>--xpath</code> option to perform queries on XML files. Here is an example of using it:</p>
			<pre>$ xmllint --xpath "//templates//field[@name='name']" library_checkout/views/checkout_view.xml</pre>
			<p>Another option is the <code>xpath</code> command, from the <code>libxml-xpath-perl</code> Debian/Ubuntu package. Here is an example of using it:</p>
			<pre>$ xpath -e "//templates//field[@name='name']" library_checkout/views/checkout_view.xml</pre>
			<p>These tools can be useful to quickly try and test XPath expressions on an XML file.</p>
			<p>Until now, you have seen how to create and extend kanban views. However, these can make use of additional JavaScript and CSS assets for effects. The next section explains how to add these components.</p>
			<h1 id="_idParaDest-349"><a id="_idTextAnchor354"/>Adding CSS and JavaScript assets</h1>
			<p>Kanban views are mostly HTML and make significant use of CSS classes. In this chapter, some standard CSS classes were introduced in the code examples, but modules can also provide their own <a id="_idIndexMarker977"/>CSS.</p>
			<p>The generally used convention is to have the asset files inside the <code>/static/src</code> subdirectory.</p>
			<p>Module web assets are declared in a <code>manifest</code> file in the <code>assets</code> key. This file is set with a dictionary that maps the assets bundle to be extended and the list of assets to add to it.</p>
			<p>This provides the tool to add <a id="_idIndexMarker978"/>web assets to an Odoo module, such as CSS and JavaScript assets. These web asset files provide a structured way to better provide user interface elements for a richer user experience.</p>
			<p>They can then be used in the module's QWeb templates, as discussed throughout the previous sections in this chapter.</p>
			<p>Here is an example for the <code>library_checkout</code> addon module. Edit the <code>__manifest__.py</code> file to add the following:</p>
			<pre>    "assets": {
        "web.assets_backend": {
            "library_checkout/static/src/css/checkout.css",
            "library_checkout/static/src/js/checkout.js",
        }
    }</pre>
			<p>The previous code adds a CSS and JavaScript file to the <code>web.assets_backend</code> assets bundle.</p>
			<p>The main asset bundles available are as follows:</p>
			<ul>
				<li><code>web.assets_common</code>: This contains the assets common to the web client, website, and also the point of sale.</li>
				<li><code>web.assets_backend</code>: This contains the assets specific to the backend web client.</li>
				<li><code>web.assets_frontend</code>: This <a id="_idIndexMarker979"/>contains the assets to be made available for the public<a id="_idIndexMarker980"/> website.</li>
			</ul>
			<p>The <code>assets</code> manifest key was introduced in Odoo 15. For previous Odoo versions, assets were declared using XML template inheritance. We will explain this next.</p>
			<h2 id="_idParaDest-350"><a id="_idTextAnchor355"/>Adding assets before Odoo 15</h2>
			<p>In previous <a id="_idIndexMarker981"/>Odoo versions, assets were added using an XML file that extends the asset bundle. The XML file doing this was usually placed inside the <code>views/</code> module subdirectory.</p>
			<p>The following example adds a CSS and JavaScript file to the <code>library_checkout</code> module. Add the <code>views/assets.xml</code> file with the following code:</p>
			<pre>&lt;odoo&gt; 
  &lt;template id="assets_backend" 
    <strong class="bold">inherit_id="web.assets_backend"</strong>
    name="Library Checkout Kanban Assets" &gt;
    &lt;xpath expr="." position="inside"&gt;
      &lt;link rel="stylesheet"
       href="/library_checkout/static/src/css/checkout.css"
      /&gt;
      &lt;script type="text/javascript"
       src="img/checkout.js"&gt;
      &lt;/script&gt;
    &lt;/xpath&gt;
  &lt;/template&gt;
&lt;/odoo&gt;</pre>
			<p>As usual, this code <a id="_idIndexMarker982"/>should also be added to the <code>data</code> key in the <code>__manifest__.py</code> descriptor file.</p>
			<h1 id="_idParaDest-351"><a id="_idTextAnchor356"/>Summary</h1>
			<p>This chapter covered kanban views and demonstrated how they can act as a powerful user interface tool. By now, you should understand kanban boards, and you are equipped with the techniques needed to design kanban views.</p>
			<p>In this chapter, you also explored the QWeb template language that powers kanban views. With the help of the examples in this chapter, you should now know how to use its features.</p>
			<p>As is expected for Odoo, kanban views and QWeb templates can also be extended by other modules in a similar way to other view types. Having read this chapter, you know additional techniques to use this functionality on Kanban views.</p>
			<p>Finally, we also discussed the use of CSS and JavaScript assets in advanced kanban views. We also looked at how these assets must be provided by the modules and must be added to the backend assets. You now know how to implement this. </p>
			<p>The next chapter will continue exploring QWeb, but this time, we'll focus on the server side and see how to design printable reports.</p>
			<h1 id="_idParaDest-352"><a id="_idTextAnchor357"/>Further reading</h1>
			<p>The following reference materials complement the topics discussed in this chapter:</p>
			<ul>
				<li>The official Odoo documentation on QWeb: https://www.odoo.com/documentation/15.0/developer/reference/frontend/qweb.html</li>
				<li>The <strong class="bold">Bootstrap</strong> CSS documentation: https://getbootstrap.com/docs/4.1/getting-started/introduction/</li>
				<li>The <strong class="bold">Font Awesome</strong> icon index: https://fontawesome.com/v4.7.0/icons/</li>
			</ul>
		</div>
	</div></body></html>