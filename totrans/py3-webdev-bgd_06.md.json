["```py\nfrom entity import Entity\nfrom relation import Relation\nclass User(Entity): pass\nclass Topic(Entity): pass\nclass Page(Entity): pass\nclass Tag(Entity): pass\nclass Word(Entity): pass\nclass Image(Entity): pass\nclass UserPage(Relation): pass\nclass TopicPage(Relation): pass\nclass TopicTag(Relation): pass\nclass ImagePage(Relation): pass\nclass TopicWord(Relation): pass\ndef threadinit(db):\n\tUser.threadinit(db)\n\tTopic.threadinit(db)\n\tPage.threadinit(db)\n\tTag.threadinit(db)\n\tWord.threadinit(db)\n\tImage.threadinit(db)\n\tUserPage.threadinit(db)\n\tTopicPage.threadinit(db)\n\tTopicTag.threadinit(db)\n\tImagePage.threadinit(db)\n\tTopicWord.threadinit(db) **def inittable():**\n\tUser.inittable(userid=\"unique not null\")\n\tTopic.inittable(title=\"unique not null\") **Page.inittable(content=\"\",**\n\t\t\t\t\t\tmodified=\"not null default CURRENT_TIMESTAMP\")\n\tTag.inittable(tag=\"unique not null\")\n\tWord.inittable(word=\"unique not null\")\n\tImage.inittable(type=\"\",data=\"blob\",title=\"\",\n\t\t\t\t\t\tmodified=\"not null default CURRENT_TIMESTAMP\",\n\t\t\t\t\t\tdescription=\"\")\n\tUserPage.inittable(User,Page)\n\tTopicPage.inittable(Topic,Page)\n\tTopicTag.inittable(Topic,Tag)\n\tTopicWord.inittable(Topic,Word) \n```", "```py\n<html>\n\t<head>\n\t\t\t<title>Wiki</title>\n\t\t\t<script\n\t\t\t\t\tsrc=\n\"http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js\"\n\t\t\t\t\ttype=\"text/javascript\">\n\t\t\t</script>\n\t\t\t<script\n\t\t\t\t\tsrc=\n\"http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.3/jquery-ui.min.js\"\n\t\t\t\t\ttype=\"text/javascript\">\n\t\t\t</script>\n\t\t\t<link rel=\"stylesheet\"\n\t\t\t\t\thref=\"http://ajax.googleapis.com/ajax/libs/\njqueryui/1.8.3/themes/smoothness/jquery-ui.css\"\n\t\t\t\t\ttype=\"text/css\" media=\"all\" />\n\t\t\t<link rel=\"stylesheet\" href=\"http:///wiki.css\"\n\t\t\t\t\ttype=\"text/css\" media=\"all\" />\n\t</head>\n\t<body> <div id=\"navigation\">\n\t\t\t\t\t<div class=\"navitem\">\n\t\t\t\t\t\t<a href=\"http://./>Wiki Home</a>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"navitem\">\n\t\t\t\t\t\t<span class=\"label\">Search topic</span>\n\t\t\t\t\t\t<form id=\"topicsearch\">\n\t\t\t\t\t\t\t\t<input type=\"text\" >\n\t\t\t\t\t\t\t\t<button type=\"submit\" >Search</button>\n\t\t\t\t\t\t</form>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"navitem\">\n\t\t\t\t\t\t<span class=\"label\">Search word</span>\n\t\t\t\t\t\t<form id=\"wordsearch\">\n\t\t\t\t\t\t\t\t<input type=\"text\" >\n\t\t\t\t\t\t\t\t<button type=\"submit\" >Search</button>\n\t\t\t\t\t\t</form>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"navitem\">\n\t\t\t\t\t\t<span class=\"label\">Search tag</span>\n\t\t\t\t\t\t<form id=\"tagsearch\">\n\t\t\t\t\t\t\t\t<input type=\"text\" >\n\t\t\t\t\t\t\t\t<button type=\"submit\" >Search</button>\n\t\t\t\t\t\t</form>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"navitem\">\n\t\t\t\t\t\t<p id=\"tagcloud\">Tag cloud</p>\n\t\t\t\t\t</div>\n\t\t\t</div> <div id=\"content\">%s</div>\n\t\t\t<script src=\"img/wikiweb.js\" type=\"text/javascript\"></script>\n\t</body>\n</html>\n\n```", "```py\n@cherrypy.expose\ndef index(self): item = '<li><a href=\"http://show?topic=%s\">%s</a></li>'\n\t\ttopiclist = \"\\n\".join(\n\t\t\t\t[item%(t,t)for t in wiki.gettopiclist()])\n\t\tcontent = '<div id=\"wikihome\"><ul>%s</ul></div>'%(\n\t\t\t\ttopiclist,)\n\t\treturn basepage % content\n\n```", "```py\n@cherrypy.expose\ndef show(self,topic):\n\t\ttopic = topic.capitalize() currentcontent,tags = wiki.gettopic(topic)\n\t\tcurrentcontent = \"\".join(wiki.render(currentcontent))\n\t\ttags = ['<li><a href=\"http://searchtags?tags=%s\">%s</a></li>'%(\n\t\t\t\t\t\t\t\t\t\tt,t) for t in tags]\n\t\tcontent = '''\n\t\t<div>\n\t\t\t\t<h1>%s</h1><a href=\"edit?topic=%s\">Edit</a>\n\t\t</div>\n\t\t<div id=\"wikitopic\">%s</div>\n\t\t<div id=\"wikitags\"><ul>%s</ul></div>\n\t\t<div id=\"revisions\">revisions</div>\n\t\t''' % ( topic, topic, currentcontent,\"\\n\".join(tags))\n\t\treturn basepage % content\n\n```", "```py\n@cherrypy.expose\ndef edit(self,topic,\n\t\t\t\t\tcontent=None,tags=None,originaltopic=None):\n\tuser = self.logon.checkauth(\n\t\t\tlogonurl=self.logon.path, returntopage=True) if content is None :\n\t\t\tcurrentcontent,tags = wiki.gettopic(topic)\n\t\t\thtml = '''\n\t\t\t<div id=\"editarea\">\n\t\t\t\t\t<form id=\"edittopic\" action=\"edit\"\n\t\t\t\t\t\t\tmethod=\"GET\">\n\t\t\t\t\t\t\t<label for=\"topic\"></label>\n\t\t\t\t\t\t\t<input name=\"originaltopic\"\n\t\t\t\t\t\t\t\t\ttype=\"hidden\" value=\"%s\">\n\t\t\t\t\t\t\t<input name=\"topic\" type=\"text\"\n\t\t\t\t\t\t\t\t\tvalue=\"%s\">\n\t\t\t\t\t\t\t<div id=\"buttonbar\">\n\t\t\t\t\t\t\t\t\t<button type=\"button\" \n\t\t\t\t\t\t\t\t\t\t\tid=\"insertlink\">\n\t\t\t\t\t\t\t\t\t\t\tExternal link\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t<button type=\"button\" \n\t\t\t\t\t\t\t\t\t\t\tid=\"inserttopic\">\n\t\t\t\t\t\t\t\t\t\t\tWiki page\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t<button type=\"button\" \n\t\t\t\t\t\t\t\t\t\t\tid=\"insertimage\">\n\t\t\t\t\t\t\t\t\t\t\tImage\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<label for=\"content\"></label>\n\t\t\t\t\t\t\t<textarea name=\"content\"\n\t\t\t\t\t\t\t\t\tcols=\"72\" rows=\"24\" >\n\t\t\t\t\t\t\t\t\t%s\n\t\t\t\t\t\t\t</textarea>\n\t\t\t\t\t\t\t<label for=\"tags\"></label>\n\t\t\t\t\t\t\t<input name=\"tags\" type=\"text\" \n\t\t\t\t\t\t\t\t\tvalue=\"%s\">\n\t\t\t\t\t\t\t<button type=\"submit\">Save</button>\n\t\t\t\t\t\t\t<button type=\"button\">Cancel</button>\n\t\t\t\t\t\t\t<button type=\"button\">Preview</button>\n\t\t\t\t\t</form>\n\t\t\t</div>\n\t\t\t<div id=\"previewarea\">preview</div>\n\t\t\t<div id=\"imagedialog\">%s</div>\n\t\t\t<script>\n\t\t\t\t\t$(\"#imagedialog\").dialog(\n\t\t\t\t\t\t\t\t{autoOpen:false,\n\t\t\t\t\t\t\t\twidth:600,\n\t\t\t\t\t\t\t\theight:600});\n\t\t\t</script>\n\t\t\t'''%(topic, topic, currentcontent,\n\t\t\t\t\t\t\t\t\", \".join(tags),\n\t\t\t\t\t\t\t\t\"\".join(self.images()))\n\t\t\treturn basepage % html\n\t\telse :\n\t\t\twiki.updatetopic(originaltopic,topic,content,tags)\n\t\t\traise cherrypy.HTTPRedirect('show?topic='+topic)\n\n```", "```py\n@cherrypy.expose\ndef images(self,title=None,description=None,file=None):\n\t\tif not file is None:\n\t\t\t\tdata = file.file.read()\n\t\t\t\twikidb.Image(title=title,description=description,\n\t\t\t\t\t\tdata=data,type=str(file.content_type))\n\t\tyield '''\n\t\t<div> <form>\n\t\t\t\t\t\t<label for=\"title\">select a title</label>\n\t\t\t\t\t\t<input name=\"title\" type=\"text\">\n\t\t\t\t\t\t<button type=\"submit\">Search</button>\n\t\t\t\t</form>\n\t\t\t\t<form method=\"post\" action=\"./images\"\n\t\t\t\t\t\tenctype=\"multipart/form-data\">\n\t\t\t\t\t\t<label for=\"file\">New image</label> <input type=\"file\" name=\"file\">\n\t\t\t\t\t\t<label for=\"title\">Title</label>\n\t\t\t\t\t\t<input type=\"text\" name=\"title\">\n\t\t\t\t\t\t<label for=\"description\">Description</label>\n\t\t\t\t\t\t<textarea name=\"description\"\n\t\t\t\t\t\t\t\tcols=\"48\" rows=\"3\"></textarea>\n\t\t\t\t\t\t<button type=\"submit\">Upload</button>\n\t\t\t\t</form>\n\t\t</div>\n\t\t'''\n\t\tyield '<div id=\"imagelist\">\\n'\n\t\tfor img in self.getimages():\n\t\t\t\tyield img\n\t\t\tyield '</div>'\n\n```", "```py\n<script>$(\"#imagedialog\").dialog({autoOpen:false});</script>\n\n```", "```py\n$(\"#insertimage\").click(function(){\n\t$(\"#imagedialog\").dialog(\"open\");\n});\n\n```", "```py\n$(\".selectable-image\").live('click',function(){\n\t$(\"#imagedialog\").dialog(\"close\");\n\tvar insert = \"<\" + $(this).attr(\"id\").substring(3) + \",\" + \n$(this).attr(\"alt\") + \">\"; var Area = $(\"#edittopic textarea\");\n\tvar area = Area[0];\n\tvar oldposition = Area.getCursorPosition();\nvar pre = area.value.substring(0, oldposition);\n\tvar post = area.value.substring(oldposition);\n\tarea.value = pre + insert + post;\n\tArea.focus().setCursorPosition(oldposition + insert.length);\n});\n\n```", "```py\n<span class=\"weight1\"><a href=\"http://searchtags?tags=Intro\">Intro</a></span>\n<span class=\"weight1\"><a href=\"http://searchtags?tags=Main\">Main</a></span>\n<span class=\"weight4\"><a href=\"http://searchtags?tags=Python\">Python</a></\nspan>\n<span class=\"weight2\"><a href=\"http://searchtags?tags=Tutorial\">Tutorial</a></\nspan>\n\n```", "```py\n.weight0 { font-size:60%; }\n.weight1 { font-size:70%; }\n.weight2 { font-size:80%; }\n.weight3 { font-size:90%; }\n.weight4 { font-size:100%; }\n\n```", "```py\n@cherrypy.expose\ndef tagcloud(self,_=None):\n\t\tfor tag,weight in wiki.tagcloud():\n\t\t\t\tyield '''\n\t\t\t\t<span class=\"weight%s\">\n\t\t\t\t\t\t<a href=\"http://searchtags?tags=%s\">%s</a>\n\t\t\t\t</span>'''%(weight,tag,tag)\n\n```", "```py\ndef tagcloud():\n\ttags = sorted([wikidb.Tag(id=t) for t in wikidb.Tag.list()],\n\t\t\t\t\t\t\tkey=attrgetter('tag'))\n\ttotaltopics=0\n\ttagrank = []\n\tfor t in tags:\n\t\ttopics = wikidb.TopicTag.list(t)\n\t\tif len(topics):\n\t\t\t\ttotaltopics += len(topics)\n\t\t\t\ttagrank.append((t.tag,len(topics)))\n\tmaxtopics = max(topics for tag,topics in tagrank)\n\tfor tag,topics in tagrank:\n\t\tyield tag, int(5.0*topics/(maxtopics+1)) # map to 0 - 4\n\n```", "```py\n@cherrypy.expose\ndef getwords(self,term,_=None): term = term.lower()\n\t\treturn json.dumps(\n\t\t\t\t[t for t in wikidb.Word.getcolumnvalues('word')\n\t\t\t\t\t\tif t.startswith(term)])\n\n```", "```py\n@cherrypy.expose\ndef searchwords(self,words):\n\t\tyield '<ul>\\n'\n\t\tfor topic in sorted(wiki.searchwords(words)):\n\t\t\t\tyield '<li><a href=\"http://show?topic=%s\">%s</a></li>'%(\n\t\t\t\t\t\ttopic,topic)\n\t\tyield '</ul>\\n'\n\n```", "```py\ndef searchwords(words):\n\ttopics = None\n\tfor word in words.split(','): word = word.strip('.,:;!? ').lower() # a list with a final \ncomma will yield an empty last term\n\t\t\tif word.isalnum():\n\t\t\t\t\tw = list(wikidb.Word.list(word=word))\n\t\t\t\t\tif len(w):\n\t\t\t\t\t\t\tww = wikidb.Word(id=w[0]) wtopic = set( w.a_id for w in wikidb.\nTopicWord.list(ww) )\n\t\t\t\t\t\t\tif topics is None :\n\t\t\t\t\t\t\t\t\ttopics = wtopic\n\t\t\t\t\t\t\telse:\n\t\t\t\t\t\t\t\t\ttopics &= wtopic\n\t\t\t\t\t\t\tif len(topics) == 0 :\n\t\t\t\t\t\t\t\t\tbreak\nif not topics is None:\n\t\tfor t in topics:\n\t\t\t\tyield wikidb.Topic(id=t).title\n\n```", "```py\nThis topic is tried with a mix of legal and illegal markup.\nA <b>list</b> is fine:\n<ul>\n<li>One</li>\n<li>Two</li>\n<li>Three</li>\n</ul>\nA link using an html tag referring to a <a href=\"http://www.example.\ncom\" target=\"blank\">nasty popup</a>.\nA legal link uses braces {http://www.example.com, \"A link\"}\n\n```", "```py\ndef updatetopic(originaltopic,topic,content,tags):\n\tt=list(wikidb.Topic.list(title=originaltopic))\n\tif len(t) == 0 :\n\t\t\tt=wikidb.Topic(title=topic)\n\telse:\n\t\t\tt=wikidb.Topic(id=t[0])\n\t\t\tt.update(title=topic)\n\tcontent=scrub(content)\n\tp=wikidb.Page(content=content)\n\twikidb.TopicPage(t.id,p.id)\n\t# update word index\n\tnewwords = set(splitwords(content))\n\twordlist = wikidb.TopicWord.list(t)\n\ttopicwords = { wikidb.Word(id=w.b_id).word:w\n\t\t\t\t\t\t\t\tfor w in wordlist }\n\tupdateitemrelation(t,topicwords,newwords,\n\t\t\twikidb.Word,'word',wikidb.TopicWord)\n\t# update tags\n\tnewtags = set(t.capitalize()\n\t\t\t\t\t\t\t\tfor t in [t.strip()\n\t\t\t\t\t\t\t\t\t\tfor t in tags.split(',')] if \nt.isalnum())\n\ttaglist = wikidb.TopicTag.list(t)\n\ttopictags = { wikidb.Tag(id=t.b_id).tag:t\n\t\t\t\t\t\t\t\tfor t in taglist }\n\tupdateitemrelation(t,topictags,newtags,\n\t\t\twikidb.Tag,'tag',wikidb.TopicTag)\n\n```", "```py\ndef updateitemrelation(p,itemmap,newitems,Entity,attr,Relation):\n\tolditems = set()\n\tfor item in itemmap:\n\t\t\tif not item in newitems:\n\t\t\t\t\titemmap[item].delete()\n\t\t\telse:\n\t\t\t\t\tolditems.add(item) for item in newitems - olditems:\n\t\t\tif not item in itemmap:\n\t\t\t\t\tilist = list(Entity.list(**{attr:item}))\n\t\t\t\t\tif (len(ilist)):\n\t\t\t\t\t\t\ti = Entity(id=ilist[0])\n\t\t\t\t\telse:\n\t\t\t\t\t\t\ti = Entity(**{attr:item})\n\t\t\t\t\tRelation.add(p,i)\n\n```", "```py\ndef scrub(content): parser = Scrubber(('ul','ol','li','b','i','u','em','code','pre','h1',\n'h2','h3','h4'))\n\tparser.feed(content)\n\treturn \"\".join(parser.result)\n\n```", "```py\nclass Scrubber(HTMLParser):\n\tdef __init__(self,allowed_tags=[]):\n\t\t\tsuper().__init__()\n\t\t\tself.result = []\n\t\t\tself.allowed_tags = set(allowed_tags)\n\tdef handle_starttag(self, tag, attrs):\n\t\t\tif tag in self.allowed_tags:\n\t\t\t\t\tself.result.append('<%s %s>'%(tag,\n\t\t\t\t\t\t\t\t\" \".join('%s=\"%s\"'%a for a in attrs)))\n\tdef handle_endtag(self, tag):\n\t\t\tif tag in self.allowed_tags:\n\t\t\t\t\tself.result.append('</'+tag+'>')\n\tdef handle_data(self,data):\n\t\t\tself.result.append(data)\n\n```", "```py\ntopicref = re.compile(r'\\[\\s*([^,\\]]+?)(\\s*,\\s*([^\\]]+))?\\s*\\]')\nlinkref = re.compile(r'\\{\\s*([^,\\}]+?)(\\s*,\\s*([^\\}]+))?\\s*\\}')\nimgref = re.compile(r'\\<\\s*(\\d+?)(\\s*,\\s*([^\\>]*))?\\s*\\>')\n\n```", "```py\ndef topicrefreplace(matchobj):\n\tref=matchobj.group(1)\n\ttxt=matchobj.group(3) if (not matchobj.group(3)\n\t\t\t\t\t\t\t\tis None) else matchobj.group(1)\n\tnonexist = \"\"\n\tif(len(list(wikidb.Topic.list(title=ref)))==0):\n\t\t\tnonexist = \" nonexisting\"\n\treturn '<a href=\"http://show?topic=%s\" class=\"topicref%s\">%s</a>'%(\n\t\t\t\t\t\t\tref,nonexist,txt)\ndef linkrefreplace(matchobj):\n\tref=matchobj.group(1)\n\ttxt=matchobj.group(3) if (not matchobj.group(3)\n\t\t\t\t\t\t\tis None) else matchobj.group(1)\n\tref=urlunparse(urlparse(ref,'http'))\n\treturn '<a href=\"http://%s class=\"externalref\">%s</a>'%(ref,txt)\ndef imgrefreplace(matchobj):\n\tref=matchobj.group(1)\n\ttxt=matchobj.group(3) if (not matchobj.group(3)\n\t\t\t\t\t\t\tis None) else matchobj.group(1)\n\treturn '''<img src=\"img/showimage?id=%s\" alt=\"%s\"\n\t\t\t\t\t\tclass=\"wikiimage\">'''%(ref,txt)\ndef render(content):\n\tyield '<p>\\n'\n\tfor line in content.splitlines(True):\n\t\t\tline = re.sub(imgref ,imgrefreplace ,line)\n\t\t\tline = re.sub(topicref,topicrefreplace,line)\n\t\t\tline = re.sub(linkref ,linkrefreplace ,line) if len(line.strip())==0 : line = '</p>\\n<p>'\n\t\t\tyield line\n\tyield '</p>\\n'\n\n```"]