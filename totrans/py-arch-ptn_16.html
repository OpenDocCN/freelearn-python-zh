<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer516">&#13;&#13;
    <h1 class="chapterNumber">12</h1>&#13;&#13;
    <h1 id="_idParaDest-237" class="chapterTitle">Logging</h1>&#13;&#13;
    <p class="normal">One of the basic elements of monitoring and observability is logs. Logs allow us to detect actions that are happening in a running system. That information can be used to analyze the behavior of the system, especially any errors or bugs that may arise, giving us useful insight into what is actually going on.</p>&#13;&#13;
    <p class="normal">Using logs<a id="_idIndexMarker829"/> correctly is deceptively difficult, though. It's easy to collect too much or too little information, or to log the wrong information. In this chapter, we will see some of the key elements of what to collect, and the general strategy to follow to ensure that logs are used to their best effect.</p>&#13;&#13;
    <p class="normal">In this chapter, we'll cover the following topics:</p>&#13;&#13;
    <ul>&#13;&#13;
      <li class="bullet">Log basics</li>&#13;&#13;
      <li class="bullet">Producing logs in Python</li>&#13;&#13;
      <li class="bullet">Detecting problems through logs</li>&#13;&#13;
      <li class="bullet">Log strategies</li>&#13;&#13;
      <li class="bullet">Adding logs while developing</li>&#13;&#13;
      <li class="bullet">Log limitations</li>&#13;&#13;
    </ul>&#13;&#13;
    <p class="normal">Let's start with the basic principles of logging.</p>&#13;&#13;
    <h1 id="_idParaDest-238" class="title">Log basics</h1>&#13;&#13;
    <p class="normal">Logs are<a id="_idIndexMarker830"/> basically messages produced by the system as it runs. These messages are produced by specific pieces of code as they are executed, allowing us to track actions happening in the code.</p>&#13;&#13;
    <p class="normal">Logs can be completely generic, like "<em class="italic">Function X is called</em>" or can include some context of the specifics of the execution, like "<em class="italic">Function X is called with parameter Y.</em>"</p>&#13;&#13;
    <p class="normal">Normally, logs<a id="_idIndexMarker831"/> are generated as plaintext messages. While there are other options, pure plaintext is very easy to deal with, can be read easily, is flexible in its format, and can be searched with pure text tools like <code class="Code-In-Text--PACKT-">grep</code>. These tools are normally very fast and most developers and sysadmins know how to use them.</p>&#13;&#13;
    <p class="normal">As well as the main message text, each log contains some metadata about what system produced the log, what time the log was created, and so on. If the log is in text format, this is normally attached to the start of the line.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">A standard and consistent log format helps you with searching, filtering, and sorting the messages. Ensure that you use consistent formats across your different systems.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">Another important metadata value is the severity of the log. This allows us to categorize the different logs by their relative importance. The standard severity levels, in order of less to more important, are <code class="Code-In-Text--PACKT-">DEBUG</code>, <code class="Code-In-Text--PACKT-">INFO</code>, <code class="Code-In-Text--PACKT-">WARNING</code>, and <code class="Code-In-Text--PACKT-">ERROR</code>. </p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">The <code class="Code-In-Text--PACKT-">CRITICAL</code> level is less used, but it's useful to show catastrophic errors.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">It's important to categorize the<a id="_idIndexMarker832"/> logs with their proper severity and filter out unimportant messages to focus on the more important ones. Each logging facility can be configured to only produce logs at one severity level or more.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">It's possible to add custom log levels instead of the predefined ones. This is generally a bad idea and should be avoided in most cases, as the log levels are well understood by all tools and engineers. We will describe later in this chapter how to define a strategy per level to make the best of each level.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">In a system serving requests, either as request-response or asynchronously, most of the logs will be generated as part of dealing with a request, which will produce several logs indicating what the request is doing. Because more than one request will normally be undergoing processing at once, the logs will be generated intermixed. For example, consider the following logs:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con">Sept 16 20:42:04.130 10.1.0.34 INFO web: REQUEST GET /login&#13;&#13;
Sept 16 20:42:04.170 10.1.0.37 INFO api: REQUEST GET /api/login&#13;&#13;
Sept 16 20:42:04.250 10.1.0.37 INFO api: REQUEST TIME 80 ms&#13;&#13;
Sept 16 20:42:04.270 10.1.0.37 INFO api: REQUEST STATUS 200&#13;&#13;
Sept 16 20:42:04.360 10.1.0.34 INFO web: REQUEST TIME 230 ms&#13;&#13;
Sept 16 20:42:04.370 10.1.0.34 INFO web: REQUEST STATUS 200&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The preceding<a id="_idIndexMarker833"/> logs show two different services, as indicated by the different IP addresses (<code class="Code-In-Text--PACKT-">10.1.0.34</code> and <code class="Code-In-Text--PACKT-">10.1.0.37</code>) and the two different service types (<code class="Code-In-Text--PACKT-">web</code> and <code class="Code-In-Text--PACKT-">api</code>). Though this can be enough to separate the requests, it's a good idea to create a single request ID to be able to group the requests in the following way:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con">Sept 16 20:42:04.130 10.1.0.34 INFO web: [4246953f8] REQUEST GET /login&#13;&#13;
Sept 16 20:42:04.170 10.1.0.37 INFO api: [fea9f04f3] REQUEST GET /api/login&#13;&#13;
Sept 16 20:42:04.250 10.1.0.37 INFO api: [fea9f04f3] REQUEST TIME 80 ms&#13;&#13;
Sept 16 20:42:04.270 10.1.0.37 INFO api: [fea9f04f3] REQUEST STATUS 200&#13;&#13;
Sept 16 20:42:04.360 10.1.0.34 INFO web: [4246953f8] REQUEST TIME 230 ms&#13;&#13;
Sept 16 20:42:04.370 10.1.0.34 INFO web: [4246953f8] REQUEST STATUS 200&#13;&#13;
</code></pre>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">In microservices environments, requests will flow from one service to the other, so it's a good idea to create a request ID that's shared across services so the full cross-service flow can be understood. To do that, the request ID needs to be created by the first service and then transmitted to the next, typically as a header in an HTTP request.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">As we saw in<em class="italic"> </em><em class="chapterRef">Chapter 5</em>,<em class="italic"> The Twelve-Factor App Methodology</em>, in the Twelve-Factor App methodology, logs should be treated as an event stream. This means that the application itself should not be concerned with the storage and treatment of logs. Instead, the logs should be directed to <code class="Code-In-Text--PACKT-">stdout</code>. From there, while developing the application, the developer can extract the information while it's running.</p>&#13;&#13;
    <p class="normal">In production environments, <code class="Code-In-Text--PACKT-">stdout</code> should be captured so that other tools can use it and then routed, annexing any different sources into a single stream, and then stored or indexed for later consulting. These tools should be configured in the production environment, and not in the app itself. </p>&#13;&#13;
    <p class="normal">Possible tools for this rerouting include<a id="_idIndexMarker834"/> alternatives like Fluentd (<a href="https://github.com/fluent/fluentd"><span class="url">https://github.com/fluent/fluentd</span></a>) or even the old favorite combination of a direct to <code class="Code-In-Text--PACKT-">logger</code> Linux command to create system logs and then sending those logs to a configured <code class="Code-In-Text--PACKT-">rsyslog</code> (<a href="https://www.rsyslog.com/"><span class="url">https://www.rsyslog.com/</span></a>) server <a id="_idIndexMarker835"/>that can forward and aggregate them.</p>&#13;&#13;
    <p class="normal">No matter how we <a id="_idIndexMarker836"/>collect logs, a typical system will produce a lot of them, and they need to be stored somewhere. While each individual log is small, aggregating thousands of them uses a significant amount of space. Any log system should be configured to have a policy on how much data it should accept to avoid growing indefinitely. In general, a retention policy based on time (such as keeping logs from the last 15 days) is the best approach, as it will be easy to understand. Finding the balance between how far back in the past you need to be able look and the amount of space the system uses is important.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">Be sure to check the retention policy when enabling any new log service, be it local or cloud-based, to make sure it's compatible with your defined retention period. You won't be able to analyze anything that happened before the time window. Double-check that the rate of log creation is as expected and that space consumption is not making the effective time window in which you can collect logs smaller. You don't want to find out that you unexpectedly went over quota while you were tracking a bug.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">Generating log entries is easy, as we will see in the next section, <em class="italic">Producing logs in Python.</em></p>&#13;&#13;
    <h1 id="_idParaDest-239" class="title">Producing logs in Python</h1>&#13;&#13;
    <p class="normal">Python includes a <a id="_idIndexMarker837"/>standard module to produce logs. This module is easy <a id="_idIndexMarker838"/>to use, with a very flexible configuration, but it can be confusing if you don't understand the way it operates.</p>&#13;&#13;
    <p class="normal">A basic program to create logs looks like this. This is available as <code class="Code-In-Text--PACKT-">basic_logging.py</code> on GitHub at <a href="https://github.com/PacktPublishing/Python-Architecture-Patterns/tree/main/chapter_12_logging"><span class="url">https://github.com/PacktPublishing/Python-Architecture-Patterns/tree/main/chapter_12_logging</span></a>:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> logging&#13;&#13;
<span class="hljs-comment"># Generate two logs with different severity levels</span>&#13;&#13;
logging.warning(<span class="hljs-string">'This is a warning message'</span>)&#13;&#13;
logging.info(<span class="hljs-string">'This is an info message'</span>)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The <code class="Code-In-Text--PACKT-">.warning</code> and <code class="Code-In-Text--PACKT-">.info</code> methods create logs with the corresponding severity message. The message is a text string. </p>&#13;&#13;
    <p class="normal">When executed, it shows the following:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python3 basic_logging.py</span>&#13;&#13;
WARNING:root:This is a warning message&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The logs are, by default, routed to <code class="Code-In-Text--PACKT-">stdout</code>, which is what we want, but it is configured not to display <code class="Code-In-Text--PACKT-">INFO</code> logs. The format of the logs is also the default, which doesn't include a timestamp.</p>&#13;&#13;
    <p class="normal">To add all this information, we need <a id="_idIndexMarker839"/>to understand the three basic elements used for<a id="_idIndexMarker840"/> logging in Python:</p>&#13;&#13;
    <ul>&#13;&#13;
      <li class="bullet">A <em class="italic">formatter</em>, which <a id="_idIndexMarker841"/>describes how the full log is going to be presented, attaching metadata like the timestamp or the severity.</li>&#13;&#13;
      <li class="bullet">A <em class="italic">handler</em>, which<a id="_idIndexMarker842"/> decides how the logs are propagated. It sets the format of the logs through the formatter, as defined above.</li>&#13;&#13;
      <li class="bullet">A <em class="italic">logger</em>, which <a id="_idIndexMarker843"/>produces the logs. It has one or more handlers that describe how the logs are propagated.</li>&#13;&#13;
    </ul>&#13;&#13;
    <p class="normal">With this information, we can configure the logs to specify all the details we want:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> sys&#13;&#13;
<span class="hljs-keyword">import</span> logging&#13;&#13;
<span class="hljs-comment"># Define the format</span>&#13;&#13;
FORMAT = <span class="hljs-string">'%(asctime)s.%(msecs)dZ:APP:%(name)s:%(levelname)s:%(message)s'</span>&#13;&#13;
formatter = logging.Formatter(FORMAT, datefmt=<span class="hljs-string">"%Y-%m-%dT%H:%M:%S"</span>)&#13;&#13;
<span class="hljs-comment"># Create a handler that sends the logs to stdout</span>&#13;&#13;
handler = logging.StreamHandler(stream=sys.stdout)&#13;&#13;
handler.setFormatter(formatter)&#13;&#13;
<span class="hljs-comment"># Create a logger with name 'mylogger', adding the handler and setting</span>&#13;&#13;
<span class="hljs-comment"># the level to INFO</span>&#13;&#13;
logger = logging.getLogger(<span class="hljs-string">'mylogger'</span>)&#13;&#13;
logger.addHandler(handler)&#13;&#13;
logger.setLevel(logging.INFO)&#13;&#13;
<span class="hljs-comment"># Generate three logs</span>&#13;&#13;
logger.warning(<span class="hljs-string">'This is a warning message'</span>)&#13;&#13;
logger.info(<span class="hljs-string">'This is an info message'</span>)&#13;&#13;
logger.debug(<span class="hljs-string">'This is a debug message, not to be displayed'</span>)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">We define the three elements in the same order that we saw before. First the <code class="Code-In-Text--PACKT-">formatter</code>, then the <code class="Code-In-Text--PACKT-">handler</code>, which sets the <code class="Code-In-Text--PACKT-">formatter</code>, and finally the <code class="Code-In-Text--PACKT-">logger</code>, which adds the <code class="Code-In-Text--PACKT-">handler</code>.</p>&#13;&#13;
    <p class="normal">The <code class="Code-In-Text--PACKT-">formatter</code> has the following format:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code">FORMAT = <span class="hljs-string">'%(asctime)s.%(msecs)dZ:APP:%(name)s:%(levelname)s:%(message)s'</span>&#13;&#13;
formatter = logging.Formatter(FORMAT, datefmt=<span class="hljs-string">"%Y-%m-%dT%H:%M:%S"</span>)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal"><code class="Code-In-Text--PACKT-">FORMAT</code> is composed in<a id="_idIndexMarker844"/> Python <code class="Code-In-Text--PACKT-">%</code> format, which is an old way to describe strings. Most<a id="_idIndexMarker845"/> elements are described as <code class="Code-In-Text--PACKT-">%(name)s</code>, where the final <code class="Code-In-Text--PACKT-">s</code> character means string format. Here's a description of each element:</p>&#13;&#13;
    <ul>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">asctime</code> sets the timestamp in a human-readable format. We describe it in the <code class="Code-In-Text--PACKT-">datefmt</code> argument to follow the ISO 8601 format. We also add the milliseconds next and a <code class="Code-In-Text--PACKT-">Z</code> to get the timestamp in full ISO 8601 form. <code class="Code-In-Text--PACKT-">%(msecs)d</code> with a <code class="Code-In-Text--PACKT-">d</code> at the end means that we print the value as an integer. This is to limit the value to milliseconds and not show any extra resolution, which is available as a fractional value.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">name</code> is the name of the logger, as we will describe later. We add also <code class="Code-In-Text--PACKT-">APP</code> to differentiate between different applications.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">levelname</code> is the severity of the log, such as <code class="Code-In-Text--PACKT-">INFO</code>, <code class="Code-In-Text--PACKT-">WARNING</code>, or <code class="Code-In-Text--PACKT-">ERROR</code>.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">message</code>, finally, is the log message.</li>&#13;&#13;
    </ul>&#13;&#13;
    <p class="normal">Once we have defined the <code class="Code-In-Text--PACKT-">formatter</code>, we can move to the <code class="Code-In-Text--PACKT-">handler</code>:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code">handler = logging.StreamHandler(stream=sys.stdout)&#13;&#13;
handler.setFormatter(formatter)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The handler is a <code class="Code-In-Text--PACKT-">StreamHandler</code>, and we set the destination of the stream to be <code class="Code-In-Text--PACKT-">sys.stdout</code>, which is the Python-defined variable that points to <code class="Code-In-Text--PACKT-">stdout</code>.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">There are more handlers available, like <code class="Code-In-Text--PACKT-">FileHandler</code> to send the logs to a file, <code class="Code-In-Text--PACKT-">SysLogHandler</code> to send logs to a <code class="Code-In-Text--PACKT-">syslog</code> destination, and even more advanced cases like <code class="Code-In-Text--PACKT-">TimeRotatingFileHandler</code>, which rotates the logs based on time, meaning it stores the last defined time, and archives older versions. You can see more information of all available handlers<a id="_idIndexMarker846"/> in the documentation at <a href="https://docs.python.org/3/howto/logging.html#useful-handlers"><span class="url">https://docs.python.org/3/howto/logging.html#useful-handlers</span></a>.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">Once the <code class="Code-In-Text--PACKT-">handler</code> is defined, we can create the <code class="Code-In-Text--PACKT-">logger</code>:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code">logger = logging.getLogger(<span class="hljs-string">'mylogger'</span>)&#13;&#13;
logger.addHandler(handler)&#13;&#13;
logger.setLevel(logging.INFO)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The first thing to do is to <a id="_idIndexMarker847"/>create a name for the logger, which here we define as <code class="Code-In-Text--PACKT-">mylogger</code>. This allows us to divide the logs of the application into subsections. We append the<a id="_idIndexMarker848"/> handler using <code class="Code-In-Text--PACKT-">.addHandler</code>.</p>&#13;&#13;
    <p class="normal">Finally, we define the level to log as <code class="Code-In-Text--PACKT-">INFO</code> using the <code class="Code-In-Text--PACKT-">.setLevel</code> method. This will display all logs of the level <code class="Code-In-Text--PACKT-">INFO</code> and higher, while those lower won't be.</p>&#13;&#13;
    <p class="normal">If we run the file, we see the whole configuration coming together:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python3 configured_logging.py</span>&#13;&#13;
2021-09-18T23:15:24.563Z:APP:mylogger:WARNING:This is a warning message&#13;&#13;
2021-09-18T23:15:24.563Z:APP:mylogger:INFO:This is an info message&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">We can see that:</p>&#13;&#13;
    <ul>&#13;&#13;
      <li class="bullet">The time is defined in ISO 8601 format as <code class="Code-In-Text--PACKT-">2021-09-18T23:15:24.563Z</code>. This is a combination of the <code class="Code-In-Text--PACKT-">asctime</code> and <code class="Code-In-Text--PACKT-">msec</code> parameters.</li>&#13;&#13;
      <li class="bullet">The <code class="Code-In-Text--PACKT-">APP</code> and <code class="Code-In-Text--PACKT-">mylogger</code> parameters allow us to filter by application and submodule.</li>&#13;&#13;
      <li class="bullet">The severity is displayed. Note that there's a <code class="Code-In-Text--PACKT-">DEBUG</code> message that isn't displayed, as the minimum level configured is <code class="Code-In-Text--PACKT-">INFO</code>.</li>&#13;&#13;
    </ul>&#13;&#13;
    <p class="normal">The <code class="Code-In-Text--PACKT-">logging</code> module in Python is capable of high levels of configuration. Check the official documentation for more information at <a href="https://docs.python.org/3/library/logging.html"><span class="url">https://docs.python.org/3/library/logging.html</span></a>.</p>&#13;&#13;
    <h1 id="_idParaDest-240" class="title">Detecting problems through logs</h1>&#13;&#13;
    <p class="normal">For any problem in a <a id="_idIndexMarker849"/>running system, there are two kind of errors that can occur: expected and unexpected. In this section, we will see the differences between them in terms of logs and how we handle them.</p>&#13;&#13;
    <h2 id="_idParaDest-241" class="title">Detecting expected errors</h2>&#13;&#13;
    <p class="normal">Expected errors are<a id="_idIndexMarker850"/> errors that are detected explicitly by creating an <code class="Code-In-Text--PACKT-">ERROR</code> log in the code. For example, the following code produces an <code class="Code-In-Text--PACKT-">ERROR</code> log when the accessed URL returns a status code different from <code class="Code-In-Text--PACKT-">200 OK</code>:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> logging&#13;&#13;
<span class="hljs-keyword">import</span> requests&#13;&#13;
URL = <span class="hljs-string">'https://httpbin.org/status/500'</span>&#13;&#13;
response = requests.get(URL)&#13;&#13;
status_code = response.status_code&#13;&#13;
<span class="hljs-keyword">if</span> status_code != <span class="hljs-number">200</span>:&#13;&#13;
    logging.error(<span class="hljs-string">f'Error accessing </span><span class="hljs-subst">{URL}</span><span class="hljs-string"> status code </span><span class="hljs-subst">{status_code}</span><span class="hljs-string">'</span>)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">This code, when executed, triggers an <code class="Code-In-Text--PACKT-">ERROR</code> log:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python3 expected_error.py</span>&#13;&#13;
ERROR:root:Error accessing https://httpbin.org/status/500 status code 500&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">This is a common pattern to access an external URL and validate that it has been accessed correctly. The block where the log is generated could perform some remediation or a retry, among other things.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">Here, we use the <a href="https://httpbin.org"><span class="url">https://httpbin.org</span></a> service, a simple HTTP request and response service that can be used to test code. In particular, the <code class="Code-In-Text--PACKT-">https://httpbin.org/status/&lt;code&gt;</code> endpoint returns the specified status code, making it easy to generate errors.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">This is an example of an expected error. We planned in advance for something that we didn't want to happen, but understood that there's a possibility of it happening. By planning in advance, the code is ready to process the error and capture it adequately.</p>&#13;&#13;
    <p class="normal">In this case, we can describe the situation clearly enough, and provide context to understand what is happening. The problem is obvious, even if the solution may not be.</p>&#13;&#13;
    <p class="normal">These kinds of errors are relatively easy to deal with since they describe foreseen problems. </p>&#13;&#13;
    <p class="normal">For example, the <a id="_idIndexMarker851"/>site may be unavailable, there could be an authentication problem, or perhaps the base URL is misconfigured.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">Keep in mind that in some cases, it's possible for the code to deal with a certain situation without failing, but for it still to be considered an error. For example, maybe you want to detect if an old authentication system is still in use by someone. This method of adding <code class="Code-In-Text--PACKT-">ERROR</code> or <code class="Code-In-Text--PACKT-">WARNING</code> logs when deprecated actions are detected can enable you to take actions to remedy the situation.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">Other examples of this type of error include connections to databases and data being stored in a deprecated format. </p>&#13;&#13;
    <h2 id="_idParaDest-242" class="title">Capturing unexpected errors</h2>&#13;&#13;
    <p class="normal">But expected errors are <a id="_idIndexMarker852"/>not the only ones that can occur. Unfortunately, any running system will surprise you with all kinds of unexpected behavior that will break the code in creative ways. Unexpected errors in Python are normally produced by an exception being raised at some point in the code when that exception won't be captured.</p>&#13;&#13;
    <p class="normal">For example, imagine that when making a small change to some code, we introduce a typo:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> logging&#13;&#13;
<span class="hljs-keyword">import</span> requests&#13;&#13;
URL = <span class="hljs-string">'https://httpbin.org/status/500'</span>&#13;&#13;
logging.info(<span class="hljs-string">f'GET </span><span class="hljs-subst">{URL}</span><span class="hljs-string">'</span>)&#13;&#13;
response = requests.ge(URL)&#13;&#13;
status_code = response.status_code&#13;&#13;
<span class="hljs-keyword">if</span> status_code != <span class="hljs-number">200</span>:&#13;&#13;
    logging.error(<span class="hljs-string">f'Error accessing </span><span class="hljs-subst">{URL}</span><span class="hljs-string"> status code </span><span class="hljs-subst">{status_code}</span><span class="hljs-string">'</span>)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Note that in line 8, we introduced a typo:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code">response = requests.ge(URL)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The correct <code class="Code-In-Text--PACKT-">.get</code> call has been replaced by <code class="Code-In-Text--PACKT-">.ge</code>. When we run it, it produces the following error:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python3 unexpected_error.py</span>&#13;&#13;
Traceback (most recent call last):&#13;&#13;
  File "./unexpected_error.py", line 8, in &lt;module&gt;&#13;&#13;
    response = requests.ge(URL)&#13;&#13;
AttributeError: module 'requests' has no attribute 'ge'&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">By default in Python, it will show the error and stack trace in the <code class="Code-In-Text--PACKT-">stdout</code>. When the code is executed as part of a web server, this is sometimes enough to send these messages as <code class="Code-In-Text--PACKT-">ERROR</code> logs, depending on how the configuration is set up.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">Any web server will capture and route these messages properly toward the logs and generate a proper 500 status code, indicating that there has been an unexpected error. The server will still be available for the next request.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">If you need to<a id="_idIndexMarker853"/> create a script that needs to be running endlessly and is protected against any unexpected errors, be sure to use a <code class="Code-In-Text--PACKT-">try..except</code> block as it's generic, so any possible exception will be captured and handled.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">Any Python exception that's properly captured with a specific <code class="Code-In-Text--PACKT-">except</code> block can be considered an expected error. Some of them may require <code class="Code-In-Text--PACKT-">ERROR</code> messages to be generated, but others may be captured and handled without requiring such information.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">For example, let's adjust the code to make a request every few seconds. The code is available in GitHub at <a href="https://github.com/PacktPublishing/Python-Architecture-Patterns/tree/main/chapter_12_logging"><span class="url">https://github.com/PacktPublishing/Python-Architecture-Patterns/tree/main/chapter_12_logging</span></a>:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> logging&#13;&#13;
<span class="hljs-keyword">import</span> requests&#13;&#13;
<span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep&#13;&#13;
logger = logging.getLogger()&#13;&#13;
logger.setLevel(logging.INFO)&#13;&#13;
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:&#13;&#13;
    &#13;&#13;
    <span class="hljs-keyword">try</span>:&#13;&#13;
        sleep(<span class="hljs-number">3</span>)&#13;&#13;
        logging.info(<span class="hljs-string">'--- New request ---'</span>)&#13;&#13;
    &#13;&#13;
        URL = <span class="hljs-string">'https://httpbin.org/status/500'</span>&#13;&#13;
        logging.info(<span class="hljs-string">f'GET </span><span class="hljs-subst">{URL}</span><span class="hljs-string">'</span>)&#13;&#13;
        response = requests.ge(URL)&#13;&#13;
        scode = response.status_code&#13;&#13;
        <span class="hljs-keyword">if</span> scode != <span class="hljs-number">200</span>:&#13;&#13;
            logger.error(<span class="hljs-string">f'Error accessing </span><span class="hljs-subst">{URL}</span><span class="hljs-string"> status code </span><span class="hljs-subst">{scode}</span><span class="hljs-string">'</span>)&#13;&#13;
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:&#13;&#13;
        logger.exception(<span class="hljs-string">f'ERROR </span><span class="hljs-subst">{err}</span><span class="hljs-string">'</span>)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The key element is the following endless loop:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:&#13;&#13;
    <span class="hljs-keyword">try</span>:&#13;&#13;
        code&#13;&#13;
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:&#13;&#13;
        logger.exception(<span class="hljs-string">f'ERROR </span><span class="hljs-subst">{err}</span><span class="hljs-string">'</span>)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The <code class="Code-In-Text--PACKT-">try..except</code> block <a id="_idIndexMarker854"/>is inside the loop, so even if there's an error, the loop will be uninterrupted. If there's any error, <code class="Code-In-Text--PACKT-">except Exception</code> will capture it, no matter what the exception is.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">This is sometimes referred to as <em class="italic">Pokemon exception handling</em>, as in "Gotta catch 'em all." This should be restricted to a kind of "last-resort safety net." In general, not being precise with the exceptions to be captured is a bad idea, as you can hide errors by handling them incorrectly. Errors should never pass silently.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">To be sure that not only is the error logged, but also the full stack trace, we log it using <code class="Code-In-Text--PACKT-">.exception</code> instead of <code class="Code-In-Text--PACKT-">.error</code>. This extends the information over a single text message while logging it with <code class="Code-In-Text--PACKT-">ERROR</code> severity.</p>&#13;&#13;
    <p class="normal">When we run the command, we get these logs. Be sure to stop it by pressing <em class="italic">Ctrl</em> + <em class="italic">C</em>:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python3 protected_errors.py</span>&#13;&#13;
INFO:root:--- New request ---&#13;&#13;
INFO:root:GET https://httpbin.org/status/500&#13;&#13;
ERROR:root:ERROR module 'requests' has no attribute 'ge'&#13;&#13;
Traceback (most recent call last):&#13;&#13;
  File "./protected_errors.py", line 18, in &lt;module&gt;&#13;&#13;
    response = requests.ge(URL)&#13;&#13;
AttributeError: module 'requests' has no attribute 'ge'&#13;&#13;
INFO:root:--- New request ---&#13;&#13;
INFO:root:GET https://httpbin.org/status/500&#13;&#13;
ERROR:root:ERROR module 'requests' has no attribute 'ge'&#13;&#13;
Traceback (most recent call last):&#13;&#13;
  File "./protected_errors.py", line 18, in &lt;module&gt;&#13;&#13;
    response = requests.ge(URL)&#13;&#13;
AttributeError: module 'requests' has no attribute 'ge'&#13;&#13;
^C&#13;&#13;
...&#13;&#13;
KeyboardInterrupt&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">As you can see, the logs include <code class="Code-In-Text--PACKT-">Traceback</code>, which allows us to detect a specific problem by adding information about where the exception was produced.</p>&#13;&#13;
    <p class="normal">Any unexpected error <a id="_idIndexMarker855"/>should be logged as <code class="Code-In-Text--PACKT-">ERROR</code>. Ideally, they should also be analyzed and the code changed to bugfix them or at least transform them into expected errors. Sometimes this is not feasible due to other pressing issues or a low occurrence of the problem, but some strategy should be implemented to make sure there's consistency in the handling of bugs.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">A great tool to handle unexpected <a id="_idIndexMarker856"/>errors is Sentry (<a href="https://sentry.io/"><span class="url">https://sentry.io/</span></a>). This tool creates a trigger for each error on a lot of common platforms, including Python Django, Ruby on Rails, Node, JavaScript, C#, iOS, and Android. It aggregates the errors detected and allows us to work with them more strategically, which is sometimes difficult when just having access to the logs.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">Sometimes, unexpected errors will present themselves with enough information about what the problem is, which could be related to an external problem like a network issue or a database problem. The solution may be located outside the realm of the service itself.</p>&#13;&#13;
    <h1 id="_idParaDest-243" class="title">Log strategies</h1>&#13;&#13;
    <p class="normal">A common problem <a id="_idIndexMarker857"/>when dealing with logs is deciding on the appropriate severity for each of the individual services. Is this message a <code class="Code-In-Text--PACKT-">WARNING</code> or an <code class="Code-In-Text--PACKT-">ERROR</code>? Should this statement be added as an <code class="Code-In-Text--PACKT-">INFO</code> message or not?</p>&#13;&#13;
    <p class="normal">Most of the log severity descriptions have definitions, such as <em class="italic">the program shows a potentially harmful situation</em> or <em class="italic">the application highlights the progress of the request</em>. These are vague definitions and difficult to act on in a real-life situation. Instead of using these vague definitions, try to define each level in relationship with any follow-up action that should be taken if the issue is encoutered. This helps to clarify to the developers what to do when a given error log is found. For example: "<em class="italic">Do I want to be informed each and every time this situation happens?</em>"</p>&#13;&#13;
    <p class="normal">The following table shows some examples of the different severity levels and what action could be taken:</p>&#13;&#13;
    <table id="table001-6" class="No-Table-Style _idGenTablePara-1">&#13;&#13;
      <colgroup>&#13;&#13;
        <col/>&#13;&#13;
        <col/>&#13;&#13;
        <col/>&#13;&#13;
      </colgroup>&#13;&#13;
      <tbody>&#13;&#13;
        <tr class="No-Table-Style">&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Heading--PACKT-"><span class="language-python">Log level</span></p>&#13;&#13;
          </td>&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Heading--PACKT-"><span class="language-python">Action to take</span></p>&#13;&#13;
          </td>&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Heading--PACKT-"><span class="language-python">Comments</span></p>&#13;&#13;
          </td>&#13;&#13;
        </tr>&#13;&#13;
        <tr class="No-Table-Style">&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="normal"><code class="Code-In-Text--PACKT-">DEBUG</code></p>&#13;&#13;
          </td>&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Content--PACKT-"><span class="language-python">None.</span></p>&#13;&#13;
          </td>&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Content--PACKT-"><span class="language-python">Not tracked. Only useful while developing.</span></p>&#13;&#13;
          </td>&#13;&#13;
        </tr>&#13;&#13;
        <tr class="No-Table-Style">&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="normal"><code class="Code-In-Text--PACKT-">INFO</code></p>&#13;&#13;
          </td>&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Content--PACKT-"><span class="language-python">None.</span></p>&#13;&#13;
          </td>&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">INFO</code> logs show generic information about the flow of the actions in the app to help track systems.</p>&#13;&#13;
          </td>&#13;&#13;
        </tr>&#13;&#13;
        <tr class="No-Table-Style">&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="normal"><code class="Code-In-Text--PACKT-">WARNING</code></p>&#13;&#13;
          </td>&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Content--PACKT-"><span class="language-python">Track the number of logs. Alert on raising levels.</span></p>&#13;&#13;
          </td>&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">WARNING</code> logs track errors that are automatically fixed, like retries to connect to an external service, or fixable format errors in a database. A sudden increase may require investigation.</p>&#13;&#13;
          </td>&#13;&#13;
        </tr>&#13;&#13;
        <tr class="No-Table-Style">&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="normal"><code class="Code-In-Text--PACKT-">ERROR</code></p>&#13;&#13;
          </td>&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Content--PACKT-"><span class="language-python">Track the number of logs. Alert on raising levels. Review all errors.</span></p>&#13;&#13;
          </td>&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">ERROR</code> logs track errors that can't be recovered. A sudden increase may require immediate action. All of them should be periodically reviewed to fix common occurrences and mitigate them, perhaps moving them to <code class="Code-In-Text--PACKT-">WARNING</code> level.</p>&#13;&#13;
          </td>&#13;&#13;
        </tr>&#13;&#13;
        <tr class="No-Table-Style">&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="normal"><code class="Code-In-Text--PACKT-">CRITICAL</code></p>&#13;&#13;
          </td>&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Content--PACKT-"><span class="language-python">Immediate response.</span></p>&#13;&#13;
          </td>&#13;&#13;
          <td class="No-Table-Style">&#13;&#13;
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">CRITICAL</code> logs indicate a catastrophic failure in the application. A single one indicates the system is not working at all and can't recover.</p>&#13;&#13;
          </td>&#13;&#13;
        </tr>&#13;&#13;
      </tbody>&#13;&#13;
    </table>&#13;&#13;
    <p class="normal">This sets clear expectations on how to respond. Note this is an example, and you may need to make tweaks and adjustments to adapt this to the needs of your specific organization.</p>&#13;&#13;
    <p class="normal">The hierarchy of<a id="_idIndexMarker858"/> different severities is very clear, and in our example, there's an acceptance that there'll be a certain number of <code class="Code-In-Text--PACKT-">ERROR</code> logs generated. For the development team's sanity, not everything needs to be fixed immediately, but a certain order and prioritization should be enforced.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">In production situations, <code class="Code-In-Text--PACKT-">ERROR</code> logs will typically be categorized from "we're doomed" to "meh." Development teams should actively either fix "meh" logs or stop the issue from being logged to remove noise from the monitoring tools. That may include lowering the level of logs if they aren't worth checking. You want as few <code class="Code-In-Text--PACKT-">ERROR</code> logs as possible, so all of them can be meaningful. </p>&#13;&#13;
      <p class="Tip--PACKT-">Remember that <code class="Code-In-Text--PACKT-">ERROR</code> logs will include unexpected errors that typically require a fix to either resolve the issue completely, or explicitly capture it and reduce its severity if it is not important. </p>&#13;&#13;
      <p class="Tip--PACKT-">This follow-up is definitely a challenge as applications grow, as the number of <code class="Code-In-Text--PACKT-">ERROR</code> logs will increase significantly. It requires time to be spent on proactive maintenance. If this is not taken seriously and it is too often dropped for other tasks, it will compromise the reliability of the application in the medium term.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal"><code class="Code-In-Text--PACKT-">WARNING</code> logs are indications that something may not be working as smoothly as expected, but things are under control, unless there's a sudden increase in the number of logs of this kind. <code class="Code-In-Text--PACKT-">INFO</code> logs are just there to give context in the event of a problem, but can be ignored otherwise.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">A common mistake is to generate <code class="Code-In-Text--PACKT-">ERROR</code> logs in actions where there are incorrect input parameters, such as in web requests when a <code class="Code-In-Text--PACKT-">400 BAD REQUEST</code> status code is returned. Some developers will argue that a customer sending a malformed request is an error. But there's nothing that the developer team should do if the request is properly detected and returned. It's business as usual, and the only action may be to return a meaningful message to the requester so they can fix their request. </p>&#13;&#13;
      <p class="Information-Box--PACKT-">If this behavior persists in certain critical requests, like repeatedly sending a bad password, a <code class="Code-In-Text--PACKT-">WARNING</code> log can be created. There's no point in creating an <code class="Code-In-Text--PACKT-">ERROR</code> log when the application is behaving as expected. </p>&#13;&#13;
      <p class="Information-Box--PACKT-">In web applications, as a rule of thumb, <code class="Code-In-Text--PACKT-">ERROR</code> logs should only be created when the status code is one of the 50X variants (like 500, 502, and 503). Remember that the 40X errors mean that the sender has a problem, while 50X means that the application has the problem, and it's your team's responsibility to fix it.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">With common and<a id="_idIndexMarker859"/> shared definitions of log levels across the team, all engineers will have a shared understanding of error severity that will help shape meaningful actions toward improving the code.</p>&#13;&#13;
    <p class="normal">Allow time for tweaking and adjusting any definition. It's also likely that you'll have to deal with logs created before the definition, which can require work. One of the biggest challenges in legacy systems is creating a proper logging system to categorize problems, as they'll likely be very noisy, making it difficult to distinguish the real problems from annoyances and even non-problems.</p>&#13;&#13;
    <h1 id="_idParaDest-244" class="title">Adding logs while developing</h1>&#13;&#13;
    <p class="normal">Any test runner will capture logs and display it as part of the trace while running tests.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-"><code class="Code-In-Text--PACKT-">pytest</code>, which we introduced in <em class="chapterRef">Chapter 10</em>,<em class="italic"> Testing and TDD</em>, will display logs as part of the result of a failing test.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">This is a good opportunity<a id="_idIndexMarker860"/> to check that the expected logs are being generated while the feature is still in development phase, especially if it's done in a TDD process where the failing tests and errors are produced routinely as part of the process, as we saw in <em class="chapterRef">Chapter 10</em>,<em class="italic"> Testing and TDD</em>. Any test that checks an error should also add a corresponding log and, while developing the feature, check that they are being produced.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">You can explicitly add to the test a check to validate that the log is being generated by using a tool <a id="_idIndexMarker861"/>like <code class="Code-In-Text--PACKT-">pytest-catchlog</code> (<a href="https://pypi.org/project/pytest-catchlog/"><span class="url">https://pypi.org/project/pytest-catchlog/</span></a>).</p>&#13;&#13;
      <p class="Tip--PACKT-">Typically, though, we just take a bit of care and incorporate the practice of checking while using TDD practices as part of the initial check that the test is failing. However, be sure that the developers understand why it's useful to have logs while developing to make the habit stick.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">While developing, <code class="Code-In-Text--PACKT-">DEBUG</code> logs can be used to add extra information about the code flow that would be excessive for production. In development, this extra information can help fill in the gaps between <code class="Code-In-Text--PACKT-">INFO</code> logs and help developers to solidify the habit of adding logs. A <code class="Code-In-Text--PACKT-">DEBUG</code> log may be promoted to <code class="Code-In-Text--PACKT-">INFO</code> if, during tests, it's found to be useful in tracking problems in production.</p>&#13;&#13;
    <p class="normal">Additionally, for special <a id="_idIndexMarker862"/>occasions, <code class="Code-In-Text--PACKT-">DEBUG</code> logs can be enabled in production in controlled cases to track certain problems that are difficult to understand. Note that this has big implications on the number of generated logs, which can lead to storage problems. Be very cautious here.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">Be sensible about the messages displayed in <code class="Code-In-Text--PACKT-">INFO</code> and higher severity logs. In terms of information that's displayed, avoid sensitive data such as passwords, secret keys, credit card numbers, and personal information.</p>&#13;&#13;
      <p class="Information-Box--PACKT-">Keep an eye in production for any size limitations and how quickly logs are generated. Systems may experience a log explosion in situations when new features are generated, if the number of requests grows, or if the number of workers in the system is increased. These three situations can be produced when systems undergo growth.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">It's always a good idea to double-check that the logs are being properly captured and available in different environments. All the configuration to ensure that the logs are properly captured may take a bit of time, so it's better to do this beforehand. This involves capturing unexpected errors and other logs in production and checking that all the plumbing is done correctly. The alternative is to discover that it's not working correctly only after stumbling into a real problem.</p>&#13;&#13;
    <h1 id="_idParaDest-245" class="title">Log limitations</h1>&#13;&#13;
    <p class="normal">Logs are very useful to <a id="_idIndexMarker863"/>understand what's happening in a running system, but they have certain limitations that are important to understand:</p>&#13;&#13;
    <ul>&#13;&#13;
      <li class="bullet"><em class="italic">Logs are only as good as their messages</em>. A good, descriptive message is critical in making logs useful. Reviewing the log messages with a critical eye, and correcting them when needed, is important to save precious time on production problems.</li>&#13;&#13;
      <li class="bullet"><em class="italic">Have an appropriate number of logs</em>. Too many logs can confuse a flow, and too few may not include enough information to allow us to understand the problem. Large numbers of logs also create problems with storage. </li>&#13;&#13;
      <li class="bullet"><em class="italic">Logs should work as an indication of the context of the problem, but likely won't pinpoint it. </em>Trying to generate specific logs that fully explain a bug will be an impossible task. Instead, focus on showing the general flow and surrounding context of the action, so it can be replicated locally and debugged. For example, for a request, make sure to log both the request and its parameters so the situation can be replicated.</li>&#13;&#13;
      <li class="bullet"><em class="italic">Logs allow us to follow the execution of a single instance. </em>When grouped together using a request ID or similar, logs can be grouped by execution, allowing us to <a id="_idIndexMarker864"/>follow the flow of a request or task. However, logs don't directly display aggregated information. Logs answer the question, "<em class="italic">what happened in this task?</em>", but not "<em class="italic">what is going on in the system?</em>" For that kind of info, it's better to use metrics.&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">There are tools available to create metrics based on logs. We will talk more about metrics in <em class="chapterRef">Chapter 13</em>,<em class="italic"> Metrics</em>.</p>&#13;&#13;
    </div>&#13;&#13;
</li>&#13;&#13;
    </ul>&#13;&#13;
    <ul>&#13;&#13;
      <li class="bullet"><em class="italic">Logs only work retrospectively</em>. When a problem in a task is detected, logs can only show information that was prepared in advance. That's why it's important to analyze critically and refine the information, removing logs that are not useful and adding others with relevant contextual information to help replicate the problem.</li>&#13;&#13;
    </ul>&#13;&#13;
    <p class="normal">Logs are a fantastic tool, but they need to be maintained to ensure that they can be used to detect bugs and problems and allow us to take action as efficiently as possible.</p>&#13;&#13;
    <h1 id="_idParaDest-246" class="title">Summary</h1>&#13;&#13;
    <p class="normal">In this chapter, we started by presenting the basic elements of logs. We defined how logs contain messages plus some metadata like a timestamp, and considered the different severity levels. We also described the need to define request IDs to group logs related to the same task. We also discussed how, in the Twelve-Factor App methodology, logs should be sent to <code class="Code-In-Text--PACKT-">stdout</code> to detach log generation from the process of handling and routing them to the proper destination to allow the collection of all logs in the system.</p>&#13;&#13;
    <p class="normal">We then showed how to produce logs in Python using the standard <code class="Code-In-Text--PACKT-">logging</code> module, describing the three key elements of the <code class="Code-In-Text--PACKT-">logger</code>, the <code class="Code-In-Text--PACKT-">handler</code>, and the <code class="Code-In-Text--PACKT-">formatter</code>. Next, we showed the two different errors that can be produced in a system: <em class="italic">expected</em>, understood as errors that were foreseen as possible and are handled; and <em class="italic">unexpected</em>, meaning those that were not foreseen and occurred out of our control. We then went through the different strategies and cases for these.</p>&#13;&#13;
    <p class="normal">We described the different severities and how to generate a strategy for what actions should be taken when a log of a certain severity is detected, instead of categorizing the logs in terms of "how critical they are", which ends up generating vague guidelines and not being very useful.</p>&#13;&#13;
    <p class="normal">We discussed several habits to improve the usefulness logs by including them in development in a TDD workflow. This allows developers to consider the information presented in logs while writing tests and producing errors, which presents the perfect opportunity to ensure that the logs generated work correctly.</p>&#13;&#13;
    <p class="normal">Finally, we discussed the limitations of logs and how we can deal with them. </p>&#13;&#13;
    <p class="normal">In the next chapter, we will look at how to work with aggregated information to find out the general state of the system through the usage of metrics.</p>&#13;&#13;
  </div>&#13;&#13;
</div></body></html>