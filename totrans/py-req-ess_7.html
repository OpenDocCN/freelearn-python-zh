<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Implementing a Web Application with Python Using Flask"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Implementing a Web Application with Python Using Flask</h1></div></div></div><p>To ensure prosperity in the process of learning about the Requests module, there seems to be nothing more important than an application of all the skills and knowledge that you attained until now. So, here we pave the way to apply the expertise you have gained till date, by creating a web application with the Flask framework. This will give you an in-depth knowledge of developing a practical web application and writing test cases for it. We do incline ourselves towards following the best practices and a hands-on approach in this process. Let us dive in to learn the stuff.</p><div class="section" title="What is Flask?"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec55"/>What is Flask?</h1></div></div></div><p>Flask is a <a class="indexterm" id="id253"/>small yet powerful framework for creating web applications with Python. It can be called a <span class="strong"><strong>micro framework</strong></span>. It is so small that if you could build a good rapport <a class="indexterm" id="id254"/>with it, you can understand all of its source code. It is powerful because of its goodies called <span class="strong"><strong>extensions</strong></span> and its ability to provide all the basic services as a whole<a class="indexterm" id="id255"/>. The extensions can be added according to the application's requirement. The man behind Flask framework is Armin Ronacher, who released it on April 1, 2010.</p><p>Flask goodies are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Flask comes <a class="indexterm" id="id256"/>up with an inbuilt development server, which assists you in the development process and in the testing of programs.</li><li class="listitem" style="list-style-type: disc">Error logging is made simple in Flask, with its interactive web-based debugger. When executing your code, if any bug has emerged in the way, an error stack trace will be shown on the web page, which makes it easy to deal with. This can be achieved by setting the flag of <code class="literal">app.debug</code> to <code class="literal">True</code>.</li><li class="listitem" style="list-style-type: disc">With its lightweight nature, Flask is a perfect framework to build RESTful web services. The route decorator which helps to bind a function to a URL can take the HTTP methods as arguments that pave a way to build API's in an ideal manner. In addition, working with JSON data is simple with Flask.</li><li class="listitem" style="list-style-type: disc">The template support for Flask is served by a flexible template engine called <span class="strong"><strong>Jinja2</strong></span>. This <a class="indexterm" id="id257"/>makes the process of rendering the templates a smoother task.</li><li class="listitem" style="list-style-type: disc">The Session object is another goodie which saves the user's session. It stores the requests of the user so that the application can remember the different requests from the user.</li><li class="listitem" style="list-style-type: disc">Flask uses the <span class="strong"><strong>Web Server Gateway Interface</strong></span> (<span class="strong"><strong>WSGI</strong></span>) protocol while dealing with<a class="indexterm" id="id258"/> requests from clients and it is 100 % WSGI compliant.</li></ul></div></div></div>
<div class="section" title="Getting started with Flask"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec56"/>Getting started with Flask</h1></div></div></div><p>We can kick-start our application development with a simple example, which gives you an idea of how we program in Python with a flask framework. In order to write this <a class="indexterm" id="id259"/>program, we need to perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a WSGI application instance, as every application in Flask needs one to handle requests from the client.</li><li class="listitem">Define a <code class="literal">route</code> method which associates a URL and the function which handles it.</li><li class="listitem">Activate the application's server.</li></ol></div><p>Here is an example which follows the preceding steps to make a simple application:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>from flask import Flask</strong></span>
<span class="strong"><strong>app = Flask(__name__)</strong></span>

<span class="strong"><strong>@app.route("/")</strong></span>
<span class="strong"><strong>def home():</strong></span>
<span class="strong"><strong>    return "Hello Guest!"</strong></span>

<span class="strong"><strong>if __name__ == "__main__":</strong></span>
<span class="strong"><strong>    app.run()</strong></span>
</pre></div><p>In the preceding lines of code, we have created a WSGI application instance using the Flask's <code class="literal">Flask</code> class, and then we defined a route which maps the path "<code class="literal">/</code>" and the view function <code class="literal">home</code> to <a class="indexterm" id="id260"/>process the request using a Flask's decorator function <code class="literal">Flask.route()</code>. Next, we used the <code class="literal">app.run()</code> which tells the server to run the code. And at that end, it will result in a web page showing up <code class="literal">"Hello Guest!",</code> when the code is executed.</p></div>
<div class="section" title="Installing Flask"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec57"/>Installing Flask</h1></div></div></div><p>Before initiating the programming process, you will need to install the required dependencies. Let's initiate the<a class="indexterm" id="id261"/> installation process by creating a virtual environment using <span class="strong"><strong>virtual environment wrapper</strong></span>. It's one of the best practices to use a virtual environment while <a class="indexterm" id="id262"/>creating an application. The virtual environment wrapper is a tool which puts all the dependencies of the project in one place.</p><p>This practice<a class="indexterm" id="id263"/> will mitigate a lot of complications while dealing with different projects in your system. In our tutorial the installation and application development goes forward using Python version 2.7.</p><p>The following are the steps for setting up the environment:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the virtual environment wrapper using <code class="literal">pip</code>. You may have to use <code class="literal">sudo</code> for administrative privileges:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ pip install virtualenvwrapper</strong></span>
</pre></div></li><li class="listitem">All the installation packages related to virtual environments are placed in one folder for the sake of convenience. <span class="strong"><strong>Virtualenvwrapper</strong></span> identifies the directory using an<a class="indexterm" id="id264"/> environmental variable <code class="literal">WORKON_HOME</code>. So, set the environmental variable to <code class="literal">~/Envs</code> or anything of your choice.<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ export WORKON_HOME=~/Envs</strong></span>
</pre></div></li><li class="listitem">Create the <code class="literal">WORKON_HOME</code> directory using the following command if it doesn't exist on your local machine:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ mkdir -p $WORKON_HOME</strong></span>
</pre></div></li><li class="listitem">In order to use the utilities provided by the <code class="literal">virtualenvwrapper,</code> we need to activate the shell script <code class="literal">virtualenvwrapper.sh</code> as shown in the following lines. On Ubuntu machines, we can find this script in the <code class="literal">/usr/local/bin</code> location:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ source /usr/local/bin/virtualenvwrapper.sh</strong></span>
</pre></div></li><li class="listitem">For the sake of convenience, add the commands in steps 2 and 4 to your shell startup file to initialize and activate the <code class="literal">virtualenvwrapper</code> utilities at your terminal's startup.</li><li class="listitem">Now, use the <code class="literal">mkvirtualenv</code> command to create a new virtual environment for your project <a class="indexterm" id="id265"/>with the name <code class="literal">survey</code>. Once the <code class="literal">survey</code> environment is activated it gets displayed with the environment name in the closed braces before the shell prompt.<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ mkvirtualenv survey</strong></span>
<span class="strong"><strong>New python executable in survey/bin/python</strong></span>
<span class="strong"><strong>Installing setuptools, pip...done.</strong></span>
<span class="strong"><strong>(survey) $</strong></span>
</pre></div></li></ol></div><div class="section" title="Installing required packages with pip"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec55"/>Installing required packages with pip</h2></div></div></div><p>We are going to <a class="indexterm" id="id266"/>use <span class="strong"><strong>Flask-SQLAlchemy</strong></span> in this project which is a Flask extension module that acts as an <span class="strong"><strong>Object Relational Mapper</strong></span> (<span class="strong"><strong>ORM</strong></span>) to<a class="indexterm" id="id267"/> interact with the database. We will also be using modules like <code class="literal">requests</code>, <code class="literal">httpretty</code>, <code class="literal">beautifulsoup</code> in the development of our <code class="literal">survey</code> application which we will be building in this tutorial.</p><p>Now<a class="indexterm" id="id268"/> install the following packages with your virtual environment activated:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>(survey)~ $ pip install flask flask-sqlalchemy requests httpretty beautifulsoup4</strong></span>
</pre></div></div></div>
<div class="section" title="Survey &#x2013; a simple voting application using Flask"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec58"/>Survey – a simple voting application using Flask</h1></div></div></div><p>To create the <code class="literal">survey</code> application, we are going to follow an approach which will give you an easy<a class="indexterm" id="id269"/> understanding of the ins and outs of the application and also will make this process of developing a joyride.</p><p>Our development procedure drives you through the process of getting you introduced to all the functions that the project deals with. And then, we will implement each and every function <a class="indexterm" id="id270"/>step-by-step. During the development process we will be following the <span class="strong"><strong>Model-View-Controller</strong></span> (<span class="strong"><strong>MVC</strong></span>) design pattern, which is popular for developing web applications.</p><p>The main aim of the <code class="literal">survey</code> application is to record the number of responses — <code class="literal">'yes'</code>, <code class="literal">'no'</code> and <code class="literal">'maybe'</code> - for the created survey questions.</p><div class="section" title="Basic file structures"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec56"/>Basic file structures</h2></div></div></div><p>For developing a Flask application, we are following a specific structure to organize the contents of our <a class="indexterm" id="id271"/>application. Here is the file structure of the application that we are going to develop:</p><div class="mediaobject"><img alt="Basic file structures" src="graphics/B03661_07_01.jpg"/></div><p>Here is a description of all the files and folders present in our application's file structure:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Name of the File/Folder</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">__init__.py</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Initializes our project and adds it to the <code class="literal">PYTHONPATH</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">server.py</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Invokes the application development server to startup.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">survey/__init__.py</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Initializes our application and brings various components into one place.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">survey/app.db</code>
</p>
</td><td style="text-align: left" valign="top">
<p>A <code class="literal">sqlite3</code> file to store your data</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">survey/models.py</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Defines the models of our application.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">survey/templates</code>
</p>
</td><td style="text-align: left" valign="top">
<p>A place to put all the <code class="literal">Jinja2</code> templates.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">survey/tests.py</code>
</p>
</td><td style="text-align: left" valign="top">
<p>A file in which various test cases related to the app are written.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">survey/views.py</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Defines the <a class="indexterm" id="id272"/>routes of your application.</p>
</td></tr></tbody></table></div><p>In our Survey application, <code class="literal">survey_project</code> is the project root. Now, let us create all the files and folders with respect to the above file structure and place the following contents in the <code class="literal">survey_project/__init__.py</code> file.</p><div class="informalexample"><pre class="programlisting">import os
import sys
current_dir = os.path.abspath(os.path.dirname(os.path.dirname(__file__)))
parent_dir = os.path.abspath(os.path.join(current_dir, os.pardir))
sys.path.insert(0, parent_dir)</pre></div></div><div class="section" title="Building the application"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec57"/>Building the application</h2></div></div></div><p>Now, we will introduce you to all the functions of the <code class="literal">survey</code> application. The following is the detailed set <a class="indexterm" id="id273"/>of tasks our application is bound to:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Create survey questions</li><li class="listitem" style="list-style-type: disc">View list of all questions</li><li class="listitem" style="list-style-type: disc">View a specific question</li><li class="listitem" style="list-style-type: disc">Modify a question</li><li class="listitem" style="list-style-type: disc">Delete a question</li><li class="listitem" style="list-style-type: disc">Up-vote a question</li></ul></div><p>Every question stores information related to a specific survey. The fields that a <code class="literal">Question</code> model (a single definitive source of information about the data) contains are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">id</code>: A primary key to identify each question uniquely</li><li class="listitem" style="list-style-type: disc"><code class="literal">question_text</code>: Describes the survey</li><li class="listitem" style="list-style-type: disc"><code class="literal">number_of_yes_votes</code>: Stores the number of <code class="literal">'yes'</code> votes polled</li><li class="listitem" style="list-style-type: disc"><code class="literal">number_of_no_votes</code>: Stores the number of <code class="literal">'no'</code> votes polled</li><li class="listitem" style="list-style-type: disc"><code class="literal">number_of_maybe_votes</code>: Stores the number of <code class="literal">'maybe'</code> votes polled</li></ul></div><p>Now, let us start designing the resource holders, what we call URLs, for the previously mentioned tasks. These URLs need specific HTTP methods to communicate with the server.</p><p>The following <a class="indexterm" id="id274"/>table throws a spotlight on how we are going to design the URLs:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Task</p>
</th><th style="text-align: left" valign="bottom">
<p>HTTP method</p>
</th><th style="text-align: left" valign="bottom">
<p>URL</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>List of all questions</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">http://[hostname:port]/</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Create a survey question</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">POST</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">http://[hostname:port]/questions</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>View a specific question</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">http://[hostname:port]/questions/[question_id]</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Modify a question</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">PUT</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">http://[hostname:port]/questions/[question_id]</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Delete a question</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">DELETE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">http://[hostname:port]/questions/[question_id]</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Up-vote a question</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">POST</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">http://[hostname:port]/questions/[question_id]/vote</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Up-vote a <a class="indexterm" id="id275"/>question form</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">http://[hostname:port]/questions/[question_id]/vote</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>New question form</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">GET</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">http://[hostname:port]/questions/new</code>
</p>
</td></tr></tbody></table></div></div><div class="section" title="Writing models with Flask-SQLAlchemy"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec58"/>Writing models with Flask-SQLAlchemy</h2></div></div></div><p>SQLAlchemy is <a class="indexterm" id="id276"/>a Python<a class="indexterm" id="id277"/> Object Relational Mapper (ORM) and a query toolkit to<a class="indexterm" id="id278"/> interact with various databases. It provides a set of utilities which includes a base class to represent the models and a set of helper classes and functions to represent a database.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>A model<a class="indexterm" id="id279"/> is a logical representation of a table in a relational database which contains information about data.</p></div></div><p>Flask-SQLAlchemy is an extension to the Flask framework which adds support to SQLAlchemy.</p></div><div class="section" title="Defining a model"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec59"/>Defining a model</h2></div></div></div><p>While defining<a class="indexterm" id="id280"/> a model with Flask-SQLAlchemy, we <a class="indexterm" id="id281"/>need to keep the following three steps in mind:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a database instance.</li><li class="listitem">Define a model using the database instance created before.</li><li class="listitem">Call a method in the database instance to create the tables in the database.</li></ol></div></div><div class="section" title="Creating a database instance"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec60"/>Creating a database instance</h2></div></div></div><p>In our <a class="indexterm" id="id282"/>application, we do need to create a database<a class="indexterm" id="id283"/> instance to store the data. For that, we need to configure the <code class="literal">'SQLALCHEMY_DATABASE_URI'</code> attribute in the WSGI application instance as shown in the following code. This code should be saved in the <code class="literal">survey/__init__.py</code> file.</p><p>
<span class="strong"><strong>__init__.py</strong></span>
</p><div class="informalexample"><pre class="programlisting">import os

from flask import Flask
from flask.ext.sqlalchemy import SQLAlchemy

BASE_DIR = os.path.abspath(os.path.dirname(__file__))

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = \
    'sqlite:///' + os.path.join(BASE_DIR, 'app.db')
db = SQLAlchemy(app)</pre></div><p>In the preceding lines of code, we created a WSGI application instance using the Flask's <code class="literal">Flask</code> class and configured the <code class="literal">'SQLALCHEMY_DATABASE_URI'</code> variable. Next, we created a database instance called <code class="literal">db</code> which is used to define models and to perform various queries.</p><div class="section" title="Creating survey models"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec11"/>Creating survey models</h3></div></div></div><p>In order to<a class="indexterm" id="id284"/> store the data related to the <code class="literal">survey</code> application in the database, we should define a model called <code class="literal">Question</code>. This code lives in <code class="literal">survey/models.py</code> file.</p><p>
<span class="strong"><strong>models.py</strong></span>
</p><div class="informalexample"><pre class="programlisting">class Question(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    question_text = db.Column(db.String(200))
    number_of_yes_votes = db.Column(db.Integer, default=0)
    number_of_no_votes = db.Column(db.Integer, default=0)
    number_of_maybe_votes = db.Column(db.Integer, default=0)</pre></div><p>In the preceding code, we defined the <code class="literal">Question</code> model which extends from <code class="literal">db.Model</code>. It contains five fields to store the data related to a specific survey:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">id</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">question_text</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">number_of_yes_votes</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">number_of_no_votes</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">number_of_maybe_votes</code></li></ul></div><p>Now let us go ahead and add a constructor method, which enables us to set the instance variables for the <code class="literal">Question</code> object that we created in the previous lines of code:</p><div class="informalexample"><pre class="programlisting">class Question(db.Model):
    ...
    ...

    def __init__(self,
                 question_text,
                 number_of_yes_votes=0,
                 number_of_no_votes=0,
                 number_of_maybe_votes=0):

        self.question_text = question_text

        self.number_of_yes_votes = number_of_yes_votes
        self.number_of_maybe_votes = number_of_maybe_votes
        self.number_of_no_votes = number_of_no_votes</pre></div><p>The <a class="indexterm" id="id285"/>preceding <code class="literal">__init__()</code> method takes the <code class="literal">Question</code> object and its values as parameters. Then, it will set the instance variables of the object that we passed.</p><p>Now, we will create a method called <code class="literal">vote()</code> which increments the counter variables for the <code class="literal">'yes'</code>, <code class="literal">'no'</code> and <code class="literal">'maybe'</code> votes.</p><div class="informalexample"><pre class="programlisting">class Question(db.Model):
    ...
    ...

    def vote(self, vote_type):
        if vote_type == 'yes':
            self.number_of_yes_votes += 1
        elif vote_type == 'no':
            self.number_of_no_votes += 1
        elif vote_type == 'maybe':
            self.number_of_maybe_votes += 1
        else:
            raise Exception("Invalid vote type")</pre></div><p>In the preceding lines of code, we defined a <code class="literal">vote()</code> method, which takes the <code class="literal">Question</code> object as its first argument and the <code class="literal">vote_type</code> as its second argument. Based on the <code class="literal">vote_type</code> (<code class="literal">'yes'</code>, <code class="literal">'no'</code>, or <code class="literal">'maybe'</code>), the corresponding <code class="literal">number_of_&lt;vote_type&gt;_votes</code> of the <code class="literal">Question</code> object that we passed gets incremented.</p></div><div class="section" title="Creating tables in the database"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec12"/>Creating tables in the database</h3></div></div></div><p>Now that we <a class="indexterm" id="id286"/>are done with defining the models related to our application using the database instance object called <code class="literal">db</code>, we need to create corresponding tables in the databases. For that, we need to call the method <code class="literal">create_all()</code>, which is present in the database instance — <code class="literal">db</code>.</p><p>In our application, we generally call this function before invoking the server defined in <code class="literal">runserver.py</code> file.</p></div><div class="section" title="Querying database models"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec13"/>Querying database models</h3></div></div></div><p>Now, we have <a class="indexterm" id="id287"/>the database models ready. Let us query the data from the database using the SQLAlchemy's ORM. We'll perform the basic create, retrieve, update, and delete (CRUD) operations on our database instance — <code class="literal">db</code>.</p><p>Before making queries, let us move to our project root directory and fire up the Python console to execute the following commands:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>&gt;&gt;&gt; from survey import app, db</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; from survey.models import Question</strong></span>
</pre></div><p>Now, let us create a <code class="literal">Question</code> object in the database. Creating an object using SQLAlchemy's ORM involves three essential steps as shown in the following code:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>&gt;&gt;&gt; question = Question("Are you an American?")</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; db.session.add(question)</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; db.session.commit()</strong></span>
</pre></div><p>We can see that:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The first step creates a Python object for the model.</li><li class="listitem" style="list-style-type: disc">The next step adds the created Python object to the db's session.</li><li class="listitem" style="list-style-type: disc">The last step involves committing the object to the database.</li></ul></div><p>Retrieving the objects from the database is very simple using the ORM. The following query retrieves all the objects from the database:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>&gt;&gt;&gt; Question.query.all()</strong></span>
<span class="strong"><strong>[&lt;Question 1 - u'Are you an American?'&gt;]</strong></span>
</pre></div><p>We can also retrieve a model object from the database using its primary key. If we look at the <code class="literal">Question</code> model, we have a primary key with the column name <code class="literal">id</code>. Now, let us go ahead and access it.</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>&gt;&gt;&gt; Question.query.get(1)</strong></span>
<span class="strong"><strong>&lt;Question 1 - u'Are you an American?'&gt;</strong></span>
</pre></div><p>It is time to vote a survey. Fetch the object with <code class="literal">id</code> value <code class="literal">1</code> and use its <code class="literal">vote()</code> method to increase the number of votes of that choice.</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>&gt;&gt;&gt; question = Question.query.get(1)</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; question.number_of_yes_votes</strong></span>
<span class="strong"><strong>0</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; question.vote('yes')</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; db.session.add(question)</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; db.session.commit()</strong></span>
</pre></div><p>Let us <a class="indexterm" id="id288"/>learn how to delete a record from the database using the <code class="literal">db.session.delete()</code> method as shown in the following code:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>&gt;&gt;&gt; question = Question.query.get(1)</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; db.session.delete(question)</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; db.session.commit()</strong></span>
</pre></div><p>If you try to access the same object, it will result in the <code class="literal">None</code> value.</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>&gt;&gt;&gt; print Question.query.get(1)</strong></span>
<span class="strong"><strong>None</strong></span>
</pre></div></div></div></div>
<div class="section" title="Views"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec59"/>Views</h1></div></div></div><p>A view is a Python function, which receives a web request and sends back a web response. The<a class="indexterm" id="id289"/> response of a view can be a simple string, web page, the content of a file, or anything. Whenever a Flask application gets a request from the client, it will look for a <code class="literal">view</code> function to service it. The view contains the business logic which is necessary to process a request.</p><p>In the previous sections, we have created the necessary database models. Now, in this section, we will write the <code class="literal">view</code> functions. Let us create view for every resource we mentioned in the previous table, which throws spot light on how we are going to design the URLs. All the views should be created in the file <code class="literal">survey/views.py</code>.</p><div class="section" title="List of all questions"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec61"/>List of all questions</h2></div></div></div><p>This view<a class="indexterm" id="id290"/> shows all the surveys that we have created in the database. The Flask application will invoke this view whenever the client requests the root of the application. Add the following code to the <code class="literal">survey/views.py</code> file:</p><div class="informalexample"><pre class="programlisting">from flask import render_template
from survey import app
from survey.models import Question

@app.route('/', methods=['GET'])
def home():
    questions = Question.query.all()
    context = {'questions': questions, 'number_of_questions': len(questions)}
    return render_template('index.html',**context)</pre></div><p>The <code class="literal">@app.route()</code> decorator maps the path <code class="literal">'/'</code> and the view function <code class="literal">home()</code>. The <code class="literal">home</code> view retrieves<a class="indexterm" id="id291"/> all the questions from the database using the SQLAlchemy ORM and renders a template named <code class="literal">'index.html'</code> using the <code class="literal">render_template</code> method. The <code class="literal">render_template</code> method takes the template name and a sequence of arguments to return a web page.</p></div><div class="section" title="New survey"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec62"/>New survey</h2></div></div></div><p>This view<a class="indexterm" id="id292"/> returns an HTML web form to create a new survey question. This view is called when a user visits the path <code class="literal">/questions/new</code>. Add the following code to the <code class="literal">survey/views.py</code> file:</p><div class="informalexample"><pre class="programlisting">. . .
. . .
@app.route('/questions/new', methods=['GET'])
def new_questions():
    return render_template('new.html')</pre></div></div><div class="section" title="Creating a new survey"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec63"/>Creating a new survey</h2></div></div></div><p>This view <a class="indexterm" id="id293"/>creates a new survey in the database and shows the list of available questions as a response. This is invoked by the Flask application, when a user submits a request to a URL containing <code class="literal">/questions</code>, using the <code class="literal">POST</code> method. The data to create a new question can be accessed within a view using the <code class="literal">request.form</code> dictionary.</p><div class="informalexample"><pre class="programlisting">@app.route('/questions', methods=['POST'])
def create_questions():
    if request.form["question_text"].strip() != "":
        new_question = Question(question_text=request.form["question_text"])
        db.session.add(new_question)
        db.session.commit()
        message = "Succefully added a new poll!"
    else:
        message = "Poll question should not be an empty string!"

    context = {'questions': Question.query.all(),'message': message}
    return render_template('index.html',**context)</pre></div></div><div class="section" title="Displaying a survey"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec64"/>Displaying a survey</h2></div></div></div><p>This view<a class="indexterm" id="id294"/> shows the requested survey using the <code class="literal">question_id</code> argument passed in the URL. This view gets triggered when a user requests the path <code class="literal">'/questions/&lt;question_id&gt;'</code> with the HTTP <code class="literal">'GET'</code> verb:</p><div class="informalexample"><pre class="programlisting">@app.route('/questions/&lt;int:question_id&gt;', methods=['GET'])
def show_questions(question_id):
    context = {'question': Question.query.get(question_id)}
    return render_template('show.html', **context)</pre></div></div><div class="section" title="Updating a survey"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec65"/>Updating a survey</h2></div></div></div><p>This view is <a class="indexterm" id="id295"/>used whenever a user wants to modify an existing question. This is invoked when a user submits the data to modify the <code class="literal">Question</code>. We can connect with this resource using HTTP's <code class="literal">'PUT'</code> method at <code class="literal">'/questions/&lt;question_id&gt;'</code>:</p><div class="informalexample"><pre class="programlisting">@app.route('/questions/&lt;int:question_id&gt;', methods=['PUT'])
def update_questions(question_id):
    question = Question.query.get(question_id)
    if request.form["question_text"].strip() != "":
        question.question_text = request.form["question_text"]
        db.session.add(question)
        db.session.commit()
        message = "Successfully updated a poll!"
    else:

        message = "Question cannot be empty!"

    context = {'question': question,
               'message': message}

    return render_template('show.html', **context)</pre></div></div><div class="section" title="Deleting a survey"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec66"/>Deleting a survey</h2></div></div></div><p>This view is <a class="indexterm" id="id296"/>used to delete a specific survey from the database. The specific survey is identified based on the <code class="literal">question_id</code> value passed in the URL. The users can access this web page at <code class="literal">'/questions/&lt;question_id&gt;'</code> using the <code class="literal">'DELETE'</code> HTTP verb. Once the question gets deleted from the database, the user will be prompted with <a class="indexterm" id="id297"/>a message and a list of available questions.</p><div class="informalexample"><pre class="programlisting">@app.route('/questions/&lt;int:question_id&gt;', methods=['DELETE'])
def delete_questions(question_id):
    question = Question.query.get(question_id)
    db.session.delete(question)
    db.session.commit()
    context = {'questions': Question.query.all(),
               'message': 'Successfully deleted'}
    return render_template('index.html', **context)</pre></div></div><div class="section" title="New vote form to caste a vote in a survey"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec67"/>New vote form to caste a vote in a survey</h2></div></div></div><p>This view <a class="indexterm" id="id298"/>returns a web page containing a HTML form to vote a particular choice in a survey. It can be accessed at <code class="literal">'/questions/&lt;question_id&gt;/vote'</code>.</p><div class="informalexample"><pre class="programlisting">@app.route('/questions/&lt;int:question_id&gt;/vote', methods=['GET'])
def new_vote_questions(question_id):
    question = Question.query.get(question_id)
    context = {'question': question}
    return render_template('vote.html', **context)</pre></div></div><div class="section" title="Casting a vote to a particular choice in a survey"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec68"/>Casting a vote to a particular choice in a survey</h2></div></div></div><p>This view is <a class="indexterm" id="id299"/>used to cast a new vote to a particular choice in a survey. The user has to submit the specific choice to the resource <code class="literal">'/questions/&lt;question_id&gt;/vote'</code> using the <code class="literal">'POST'</code> method. After the successful casting of a vote, the user is redirected to the survey details page.</p><div class="informalexample"><pre class="programlisting">@app.route('/questions/&lt;int:question_id&gt;/vote', methods=['POST'])
def create_vote_questions(question_id):
    question = Question.query.get(question_id)

    if request.form["vote"] in ["yes", "no", "maybe"]:
        question.vote(request.form["vote"])

    db.session.add(question)
    db.session.commit()
    return redirect("/questions/%d" % question.id)</pre></div></div></div>
<div class="section" title="Templates"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec60"/>Templates</h1></div></div></div><p>A template is a <a class="indexterm" id="id300"/>simple text document which contains block tags or variables. <span class="strong"><strong>Flask micro-framework</strong></span> makes use of the <code class="literal">Jinja2</code> template engine for rendering<a class="indexterm" id="id301"/> the HTML pages.</p><p>In our application, we use five different templates which includes a <code class="literal">base</code> template—<code class="literal">base.html</code>. This <code class="literal">base</code> template is a layout consisting of the common elements of all the templates. The four other templates (<code class="literal">index.html</code>, <code class="literal">show.html</code>, <code class="literal">vote.html</code> and <code class="literal">new.html</code>) make use of a <a class="indexterm" id="id302"/>concept called <span class="strong"><strong>template inheritance</strong></span> provided by the <code class="literal">Jinja2</code> template engine. It is used to enable those common features to get showed up without a redundant code in every template.</p><div class="section" title="The base template"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec69"/>The base template</h2></div></div></div><p>This template is<a class="indexterm" id="id303"/> a skeleton for all the other templates. It contains a<a class="indexterm" id="id304"/> common navigation menu section and a placeholder to hold the primary content block of every page in this application. The <code class="literal">survey/templates/base.html</code> template will contain the following code:</p><div class="informalexample"><pre class="programlisting">&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Welcome to Survey Application&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    {% if message %}
        &lt;p style="text-align: center;"&gt;{{ message }}&lt;/p&gt;
    {% endif %}
    &lt;div&gt;
      &lt;a href="/"&gt;Home&lt;/a&gt; |
      &lt;a href="/questions"&gt;All Questions&lt;/a&gt; |
      &lt;a href="/questions/new"&gt;Create a new Question&lt;/a&gt;
    &lt;/div&gt;
    &lt;hr&gt;
    {% block content %}{% endblock %}
  &lt;/body&gt;
&lt;/html&gt;</pre></div></div><div class="section" title="The list of questions template"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec70"/>The list of questions template</h2></div></div></div><p>As we need to<a class="indexterm" id="id305"/> show the list of questions in a web page, we iterate over the <code class="literal">questions</code> variable using a <code class="literal">for</code> loop tag and display all the vote counts of a specific survey. Add the following to the <code class="literal">survey/templates/index.html</code> file:</p><div class="informalexample"><pre class="programlisting">{% extends "base.html" %}

{% block content %}
    &lt;p&gt;Number of Questions - &lt;span id="number_of_questions"&gt;{{ number_of_questions }}&lt;/span&gt;&lt;/p&gt;
    {% for question in questions %}
    &lt;div&gt;
        &lt;p&gt;
            &lt;p&gt;&lt;a href="/questions/{{ question.id }}"&gt;{{ question.question_text }}&lt;/a&gt;&lt;/p&gt;
            &lt;ul&gt;
                &lt;li&gt;Yes - {{ question.number_of_yes_votes }} &lt;/li&gt;
                &lt;li&gt;No - {{ question.number_of_no_votes }} &lt;/li&gt;
                &lt;li&gt;Maybe - {{ question.number_of_maybe_votes }}
&lt;/li&gt;
            &lt;/ul&gt;
        &lt;/p&gt;
    &lt;/div&gt;
    {% endfor %}
    &lt;hr /&gt;
{% endblock %}</pre></div></div><div class="section" title="Creating a new survey template"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec71"/>Creating a new survey template</h2></div></div></div><p>To show an <a class="indexterm" id="id306"/>HTML form containing a new survey question, we defined a template called <code class="literal">survey/templates/new.html</code>:</p><p>
<span class="strong"><strong>new.html</strong></span>
</p><div class="informalexample"><pre class="programlisting">{% extends "base.html" %}

{% block content %}
    &lt;h1&gt;Create a new Survey&lt;/h1&gt;
    &lt;form method="POST" action="/questions"&gt;
        &lt;p&gt;Question: &lt;input type="text" name="question_text"&gt;&lt;/p&gt;
        &lt;p&gt;&lt;input type="submit" value="Create a new Survey"&gt;&lt;/p&gt;
    &lt;/form&gt;
{% endblock %}</pre></div></div><div class="section" title="Showing the details of a survey template"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec72"/>Showing the details of a survey template</h2></div></div></div><p>To display<a class="indexterm" id="id307"/> all the details of a survey, create a template in the following way. This template also includes a link to the <code class="literal">cast your vote</code> page. Add the following code to the <code class="literal">survey/templates/show.html</code> file:</p><div class="informalexample"><pre class="programlisting">{% extends "base.html" %}

{% block content %}
    &lt;div&gt;
        &lt;p&gt;
        {% if question %}
            &lt;p&gt;{{ question.question_text }}&lt;/p&gt;
            &lt;ul&gt;
                &lt;li&gt;Yes - {{ question.number_of_yes_votes }}&lt;/li&gt;
                &lt;li&gt;No - {{ question.number_of_no_votes }}
&lt;/li&gt;
                &lt;li&gt;Maybe - {{ question.number_of_maybe_votes}}&lt;/li&gt;
            &lt;/ul&gt;
            &lt;p&gt;&lt;a href="/questions/{{ question.id }}/vote"&gt;Cast your vote now&lt;/a&gt;&lt;/p&gt;
        {% else %}
            Not match found!
        {% endif %}
        &lt;/p&gt;
    &lt;/div&gt;
    &lt;hr /&gt;
{% endblock %}</pre></div></div><div class="section" title="Casting a vote template"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec73"/>Casting a vote template</h2></div></div></div><p>To cast a <a class="indexterm" id="id308"/>vote, we need to display a web page containing a HTML form with a survey and its choices. Add the following code to the <code class="literal">survey/templates/vote.html</code> file:</p><div class="informalexample"><pre class="programlisting">{% extends "base.html" %}

{% block content %}
    &lt;div&gt;
        &lt;p&gt;
        {% if question %}
            &lt;p&gt;{{ question.question_text }}&lt;/p&gt;

            &lt;form action="/questions/{{ question.id }}/vote" method="POST"&gt;
                &lt;input type="radio" name="vote" value="yes"&gt;Yes&lt;br&gt;
                &lt;input type="radio" name="vote" value="no"&gt;No&lt;br&gt;
                &lt;input type="radio" name="vote" value="maybe"&gt;Maybe&lt;br&gt;

                &lt;input type="submit" value="Submit" /&gt;&lt;br&gt;
            &lt;/form&gt;
            &lt;p&gt;&lt;a href="/questions/{{ question.id }}"&gt;Back to Question&lt;/a&gt;&lt;/p&gt;
        {% else %}
            Not match found!
        {% endif %}
        &lt;/p&gt;
    &lt;/div&gt;
    &lt;hr /&gt;
{% endblock %}</pre></div></div></div>
<div class="section" title="Running the survey application"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec61"/>Running the survey application</h1></div></div></div><p>Hurray! We succeeded in creating an application which will allow the users to create a survey, retrieve a survey, update a survey, delete a survey, and cast the vote of a choice for a survey. Perform<a class="indexterm" id="id309"/> the following steps for running the server:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Before running the server, let us go ahead and fill the contents of <code class="literal">server.py</code> with the following code:<div class="informalexample"><pre class="programlisting">import sys

from survey import app, db
from survey import views

def main():
    db.create_all()
    app.run(debug=True)
    return 0

if __name__ == '__main__':
    sys.exit(main())</pre></div></li><li class="listitem">Now, let us run the application using the <code class="literal">runserver.py</code> script as shown in the following lines:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ python runserver.py</strong></span>
<span class="strong"><strong>* Running on http://127.0.0.1:5000/</strong></span>
<span class="strong"><strong>* Restarting with reloader</strong></span>
</pre></div></li><li class="listitem">Now, the server is up and running. To access the application on a web browser, visit the URL—<code class="literal">http://127.0.0.1:5000/</code>.</li></ol></div><p>We are done!</p></div>
<div class="section" title="Writing unit tests to survey applications"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec62"/>Writing unit tests to survey applications</h1></div></div></div><p>Creating an application without test cases is half done. Even though you take a lot of care while developing the application, there might be a chance of encountering errors at some point. Writing<a class="indexterm" id="id310"/> test cases will always leave us at a safe <a class="indexterm" id="id311"/>point.</p><p>In this section, we are going to write unit test cases for some tasks in our survey application. Add the following test case code to <code class="literal">survey/tests.py</code> file:</p><div class="informalexample"><pre class="programlisting">import unittest
import requests

from bs4 import BeautifulSoup
from survey import db
from survey.models import Question

class TestSurveyApp(unittest.TestCase):

    def setUp(self):
        db.drop_all()
        db.create_all()

    def test_defaults(self):
        question = Question('Are you from India?')
        db.session.add(question)
        db.session.commit()

        self.assertEqual(question.number_of_yes_votes, 0)
        self.assertEqual(question.number_of_no_votes, 0)
        self.assertEqual(question.number_of_maybe_votes, 0)

    def test_votes(self):
        question = Question('Are you from India?')
        question.vote('yes')
        db.session.add(question)
        db.session.commit()

        self.assertEqual(question.number_of_yes_votes, 1)
        self.assertEqual(question.number_of_no_votes, 0)
        self.assertEqual(question.number_of_maybe_votes, 0)

    def test_title(self):
        title = "Welcome to Survey Application"
        response = requests.get("http://127.0.0.1:5000/")
        soup = BeautifulSoup(response.text)
        self.assertEqual(soup.title.get_text(), title)</pre></div><p>We can see the following from the preceding block of code:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<a class="indexterm" id="id312"/> initial lines of code import all the <a class="indexterm" id="id313"/>necessary modules into the memory.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">setUp()</code> method in the <code class="literal">TestSurveyApp</code> drops all the existing tables and creates them for every test case.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">test_defaults</code> test case will test the defaults of the <code class="literal">Question</code> object that was created. If the defaults do not match the expected inputs, the test case fails.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">test_votes()</code> will up-vote a specific choice for a survey and test whether the voted choice gets incremented and other choices remain the same.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">test_title()</code> will test whether the title of a response matches with the expected title. It uses the <code class="literal">BeautifulSoup</code> library to access the title from the response contents.</li></ul></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec63"/>Summary</h1></div></div></div><p>In this chapter, we learnt about the Flask micro-framework and looked at the different features of Flask. We also set up a virtual environment using virtualenvwrapper, and created a web application using Flask, Flask-SQLAlchemy, and Jinja2. Finally, we wrote unit tests for the developed application.</p></div></body></html>