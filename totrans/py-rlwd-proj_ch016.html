<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="pandoc" name="generator"/>
<title>ch016.xhtml</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->
<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body epub:type="bodymatter">
<section class="level1" data-number="16" id="chapter-12-project-3.8-integrated-data-acquisition-web-service">
<h1 data-number="16"><span class="titlemark"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 12</span></span><br/>
<span id="x1-27600012"/><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.8: Integrated Data Acquisition Web Service</span></h1>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">In many enterprise applications, data is provided to several consumers. </span><span class="koboSpan" id="kobo.3.2" xmlns="http://www.w3.org/1999/xhtml">One way to do this is to define an API that provides data (and the metadata) for subsequent use. </span><span class="koboSpan" id="kobo.3.3" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we guide you through the transformation of Project 2.5 schema information into a larger OpenAPI specification. </span><span class="koboSpan" id="kobo.3.4" xmlns="http://www.w3.org/1999/xhtml">We will also build a small Flask application that provides the core acquire-cleanse-convert process as a web service.</span></p>
<p><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">We’ll cover a number of skills in the chapter:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml">Creating an OpenAPI specification for a service to acquire and download data</span></p></li>
<li><p><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml">Writing a web service application to implement the OpenAPI specification</span></p></li>
<li><p><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml">Using a processing pool to delegate long-running background tasks</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml">This is a bit of a deviation from a straight path of acquiring and cleaning data. </span><span class="koboSpan" id="kobo.8.2" xmlns="http://www.w3.org/1999/xhtml">In some enterprises, this deviation is needed to publish useful data to a wider audience.</span></p>
<p><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml">We’ll begin with a description of the behavior of this RESTful API server. </span><span id="x1-276001r296"/></p>
<section class="level2" data-number="16.1" id="description-18">
<h2 data-number="16.1"><span class="titlemark"><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml">12.1 </span></span> <span id="x1-2770001"/><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></h2>
<p><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="ch012.xhtml#x1-1950008"><em><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml"> 8</span></em></a><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch012.xhtml#x1-1950008"><em><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml">Project 2.5: Schema and Metadata</span></em></a><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">, we used </span><strong><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml">to generate a schema for the analysis data model. </span><span class="koboSpan" id="kobo.19.2" xmlns="http://www.w3.org/1999/xhtml">This schema provides a formal, language-independent definition of the available data. </span><span class="koboSpan" id="kobo.19.3" xmlns="http://www.w3.org/1999/xhtml">This can then be shared widely to </span><span id="dx1-277001"/><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">describe the data and resolve questions or ambiguities about the data, the processing provenance, the meaning of coded values, internal relationships, and other topics.</span></p>
<p><span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml">This specification for the schema can be extended to create a complete specification for a RESTful API that provides the data that meets the schema. </span><span class="koboSpan" id="kobo.21.2" xmlns="http://www.w3.org/1999/xhtml">The purpose of this API is to allow multiple users — via the </span><code><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml"> module — to query the API for the analytical data as well as the results of the analysis. </span><span class="koboSpan" id="kobo.23.2" xmlns="http://www.w3.org/1999/xhtml">This can help users to avoid working with out-of-date data. </span><span class="koboSpan" id="kobo.23.3" xmlns="http://www.w3.org/1999/xhtml">An organization creates large JupyterLab servers to facilitate doing analysis processing on machines far larger than an ordinary laptop.</span></p>
<p><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml">Further, an API provides a handy wrapper around the entire acquire-and-clean process. </span><span class="koboSpan" id="kobo.24.2" xmlns="http://www.w3.org/1999/xhtml">When a user requests data for the first time, the processing steps can be started and the results cached. </span><span class="koboSpan" id="kobo.24.3" xmlns="http://www.w3.org/1999/xhtml">Each subsequent request can download available data from a filesystem cache, providing rapid access. </span><span class="koboSpan" id="kobo.24.4" xmlns="http://www.w3.org/1999/xhtml">In the case of a failure, the logs can be provided as an alternative to the final data.</span></p>
<p><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml">We won’t dive deeply into REST design concepts. </span><span class="koboSpan" id="kobo.25.2" xmlns="http://www.w3.org/1999/xhtml">For more information on RESTful design, see </span><a class="url" href="https://hub.packtpub.com/creating-restful-api/"><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml">https://hub.packtpub.com/creating-restful-api/</span></a><span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">Generally, a RESTful API defines a number of paths to resources. </span><span class="koboSpan" id="kobo.28.2" xmlns="http://www.w3.org/1999/xhtml">A given path can be accessed by a number of methods, some of which will get the resource. </span><span class="koboSpan" id="kobo.28.3" xmlns="http://www.w3.org/1999/xhtml">Other methods may post, patch, put, or delete the resource. </span><span class="koboSpan" id="kobo.28.4" xmlns="http://www.w3.org/1999/xhtml">The defined HTTP methods offer handy mapping to the common </span><strong><span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml">Create-Retrieve-Update-Delete </span></strong><span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml">CRUD</span></strong><span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml">) conceptual operations.</span></p>
<p><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">Here are the common cases:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml">A path without a final identifier, for example, </span><code><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml">/series/</span></code><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.36.2" xmlns="http://www.w3.org/1999/xhtml">There are two common cases here:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml">GET</span></code><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml"> method will retrieve the list of available resources of the given type.</span></p></li>
<li><p><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml">POST</span></code><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml"> method can be used to create a new instance of this type. </span><span class="koboSpan" id="kobo.42.2" xmlns="http://www.w3.org/1999/xhtml">This is the conceptual “Create” operation.</span></p></li>
</ul></li>
<li><p><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml">A path with an identifier. </span><span class="koboSpan" id="kobo.43.2" xmlns="http://www.w3.org/1999/xhtml">For example, </span><code><span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml">/series/Series_4</span></code><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.45.2" xmlns="http://www.w3.org/1999/xhtml">This is a specific resource. </span><span class="koboSpan" id="kobo.45.3" xmlns="http://www.w3.org/1999/xhtml">There are several methods that might be implemented:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml">GET</span></code><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml"> method will retrieve the resource. </span><span class="koboSpan" id="kobo.48.2" xmlns="http://www.w3.org/1999/xhtml">This is the “Retrieve” conceptual operation.</span></p></li>
<li><p><span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml">PUT</span></code><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml">PATCH</span></code><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml"> methods can be used to replace or update the resource. </span><span class="koboSpan" id="kobo.53.2" xmlns="http://www.w3.org/1999/xhtml">These are two forms of the conceptual “Update” operation.</span></p></li>
<li><p><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml">DELETE</span></code><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml"> method can be used to remove the resource. </span><span class="koboSpan" id="kobo.56.2" xmlns="http://www.w3.org/1999/xhtml">This is the “Delete” conceptual operation.</span></p></li>
</ul></li>
</ul>
<p><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml">It becomes imperative to </span><span id="dx1-277002"/><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml">consider a RESTful web service as a collection of resources. </span><span class="koboSpan" id="kobo.58.2" xmlns="http://www.w3.org/1999/xhtml">Talking about resources can make it difficult to talk about a RESTful request that initiates processing. </span><span class="koboSpan" id="kobo.58.3" xmlns="http://www.w3.org/1999/xhtml">It raises the question of what resource describes an activity such as processing samples. </span><span class="koboSpan" id="kobo.58.4" xmlns="http://www.w3.org/1999/xhtml">We’ll start by considering the data series as the most important resource provided by this service. </span><span id="x1-277003r298"/></p>
<section class="level3" data-number="16.1.1" id="the-data-series-resources">
<h3 data-number="16.1.1"><span class="titlemark"><span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml">12.1.1 </span></span> <span id="x1-2780001"/><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml">The data series resources</span></h3>
<p><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml">The primary resource for this API is the data series. </span><span class="koboSpan" id="kobo.61.2" xmlns="http://www.w3.org/1999/xhtml">As shown in the previous section, </span><a href="#x1-2810001"><em><span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml">OpenAPI 3 specification</span></em></a><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml">, a path with </span><code><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml">/2023.02/series/&lt;id&gt;</span></code><span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml"> can be used to extract the data for a named series. </span><span class="koboSpan" id="kobo.65.2" xmlns="http://www.w3.org/1999/xhtml">The 2023.02 prefix allows the API to evolve to a newer version while leaving older paths in place for compatibility purposes.</span></p>
<p><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml">The use of </span><strong><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml">semantic versioning </span></strong><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml">semver</span></strong><span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml">) is common, and many APIs have something like “v1” in the path. </span><span class="koboSpan" id="kobo.70.2" xmlns="http://www.w3.org/1999/xhtml">Yet another alternative is to include the version information in the </span><code><span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml">Accept</span></code><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml"> header. </span><span class="koboSpan" id="kobo.72.2" xmlns="http://www.w3.org/1999/xhtml">This means the URIs never change, but the schema for the response can change based on the version information provided in the header.</span></p>
<p><span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml">The various “series” routes provide direct access to the data resources. </span><span class="koboSpan" id="kobo.73.2" xmlns="http://www.w3.org/1999/xhtml">This seems appropriate since this is the primary purpose of the service.</span></p>
<p><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml">There is an additional class of resources that might be of interest: the background processing used to create the data. </span><span class="koboSpan" id="kobo.74.2" xmlns="http://www.w3.org/1999/xhtml">As noted above, projects like </span><a href="ch015.xhtml#x1-26400011"><em><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml"> 11</span></em></a><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch015.xhtml#x1-26400011"><em><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.7: Interim Data Persistence</span></em></a><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml">, are the essential foundation for processing </span><span id="dx1-278001"/><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">done by this RESTful API. </span><span class="koboSpan" id="kobo.80.2" xmlns="http://www.w3.org/1999/xhtml">The acquire and clean applications can be run in the background to create data for download.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-192">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml">A focus on resources is essential for making useful RESTful APIs.</span></p>
<p><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml">Even when describing processing or state changes, the focus must be on the resource that undergoes the state change.</span></p>
<p><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml">The methods available in HTTP (</span><code><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml">GET</span></code><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml">POST</span></code><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml">PUT</span></code><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml">PATCH</span></code><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml">DELETE</span></code><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml">, for example) are effectively the verbs of the API’s language. </span><span class="koboSpan" id="kobo.93.2" xmlns="http://www.w3.org/1999/xhtml">The resources are nouns.</span></p>
</div>
</div>
<p><span id="x1-278002r301"/></p>
</section>
<section class="level3" data-number="16.1.2" id="creating-data-for-download">
<h3 data-number="16.1.2"><span class="titlemark"><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml">12.1.2 </span></span> <span id="x1-2790002"/><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml">Creating data for download</span></h3>
<p><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml">The primary purpose of the RESTful API is to store and download clean data for analysis work. </span><span class="koboSpan" id="kobo.96.2" xmlns="http://www.w3.org/1999/xhtml">This can be a relatively straightforward application that offers data files from a well-known directory. </span><span class="koboSpan" id="kobo.96.3" xmlns="http://www.w3.org/1999/xhtml">The work </span><span id="dx1-279001"/><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml">involves matching RESTful requests against available files, and returning appropriate status codes when requests are made for files that don’t exist.</span></p>
<p><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">A secondary purpose is to automate the creation of the data for download. </span><span class="koboSpan" id="kobo.98.2" xmlns="http://www.w3.org/1999/xhtml">The RESTful API can be a wrapper around the complete acquire, clean, and persist pipeline. </span><span class="koboSpan" id="kobo.98.3" xmlns="http://www.w3.org/1999/xhtml">To do this, the API will have two distinct kinds of requests:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml">Requests to download existing, cached data. </span><span class="koboSpan" id="kobo.99.2" xmlns="http://www.w3.org/1999/xhtml">The resource type is clear here.</span></p></li>
<li><p><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml">Requests to start the creation of new data; this will lead to cached data available for download. </span><span class="koboSpan" id="kobo.100.2" xmlns="http://www.w3.org/1999/xhtml">The resource type for processing isn’t as clear.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml">An operation or action does have some static resources that can be used with a RESTful API. </span><span class="koboSpan" id="kobo.101.2" xmlns="http://www.w3.org/1999/xhtml">Here are two common resource types for activities:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml">A ”current status” resource that reflects the work being done right now</span></p></li>
<li><p><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml">A ”processing history” resource that reflects work completed: this is often the log file for the acquisition processing</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml">The control of processing by a RESTful API can work by creating and examining processing status or history as a distinct resource type:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml">A path with a POST request will start an asynchronous, background process. </span><span class="koboSpan" id="kobo.105.2" xmlns="http://www.w3.org/1999/xhtml">This will also create a new processing history resource. </span><span class="koboSpan" id="kobo.105.3" xmlns="http://www.w3.org/1999/xhtml">The response body provides a transaction identifier referring to this new processing history.</span></p></li>
<li><p><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml">A path with a transaction identifier and a GET request will return the background processing details; this should include the current or final status as well as the log.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml">For sophisticated frontend processing, a web </span><span id="dx1-279002"/><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml">socket can be created to receive ongoing status reports from the background process. </span><span class="koboSpan" id="kobo.108.2" xmlns="http://www.w3.org/1999/xhtml">For a less sophisticated frontend, polling every few seconds can be done to see whether the processing has finished and the data is available for download.</span></p>
<p><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml">With both processing history resources and data resources, the following two sets of paths are necessary:</span></p>
<ul>
<li><p><code><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml">/series/&lt;id&gt;</span></code><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml"> paths that refer to specific series, already available in the cache. </span><span class="koboSpan" id="kobo.111.2" xmlns="http://www.w3.org/1999/xhtml">These resources are accessed exclusively with the GET method to download data.</span></p></li>
<li><p><code><span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml">/creation/&lt;id&gt;</span></code><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml"> paths that refer to background processing jobs to create a new series of data. </span><span class="koboSpan" id="kobo.113.2" xmlns="http://www.w3.org/1999/xhtml">These resources will use the POST method to start a background job, and the GET method to check the status of a job.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml">This set of paths (and the associated methods) allows a user to control processing and check the results of processing. </span><span class="koboSpan" id="kobo.114.2" xmlns="http://www.w3.org/1999/xhtml">The user can ask for available datasets and download a specific dataset for analysis. </span><span id="x1-279003r300"/></p>
</section>
</section>
<section class="level2" data-number="16.2" id="overall-approach-1">
<h2 data-number="16.2"><span class="titlemark"><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml">12.2 </span></span> <span id="x1-2800002"/><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml">Overall approach</span></h2>
<p><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml">We’ll take some </span><span id="dx1-280001"/><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml">guidance from the C4 model ( </span><a class="url" href="https://c4model.com"><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml">https://c4model.com</span></a><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml">) when looking at our approach.</span></p>
<ul>
<li><p><strong><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml">Context </span></strong><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml">For this project, the context diagram has several use cases: listing available data, downloading available data, starting a process to acquire data, and checking the status of a process acquiring data.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml">Containers </span></strong><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">Ideally, this runs on a single container that hosts the web service as well as the processing. </span><span class="koboSpan" id="kobo.124.2" xmlns="http://www.w3.org/1999/xhtml">In some cases, multiple containers will be required because the processing demands are so huge.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml">Components </span></strong><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml">There are two significantly different collections of software components: the web service, and the application programs that run in the background to acquire and clean the data.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml">Code </span></strong><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml">The acquiring and cleaning applications have already been described as separate projects. </span><span class="koboSpan" id="kobo.128.2" xmlns="http://www.w3.org/1999/xhtml">We’ll focus on the web service.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml">We’ll decompose the web service application into several components. </span><span class="koboSpan" id="kobo.129.2" xmlns="http://www.w3.org/1999/xhtml">The following diagram shows the relationship between the RESTful API service and the applications that are run to acquire and clean data.</span></p>
<p><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml">The component diagram is shown in </span><a href="#12.1"><em><span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml">Figure 12.1</span></em></a><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 12.1: Application components " src="../media/file52.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="12.1"><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml">Figure 12.1: </span></span><span class="content"><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml">Application components </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml">This diagram shows three separate processes:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml">RESTful API </span></strong><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml">process that handles HTTP </span><span id="dx1-280004"/><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml">requests from clients.</span></p></li>
<li><p><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml">Worker Pool </span></strong><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml">collection of </span><span id="dx1-280005"/><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml">processes that are managed by the </span><code><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml">concurrent.futures</span></code><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.146.2" xmlns="http://www.w3.org/1999/xhtml">Each worker will be running a single function, shown as </span><code><span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml">acquire_series</span></code><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">, that’s defined in the same module as the </span><strong><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml">RESTful API </span></strong><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml">service.</span></p></li>
<li><p><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml">Background </span></strong><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml">process that is executed by a </span><span id="dx1-280006"/><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml">worker in the worker pool. </span><span class="koboSpan" id="kobo.154.2" xmlns="http://www.w3.org/1999/xhtml">This uses the </span><code><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml">subprocess</span></code><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml"> module to run an existing CLI application.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml">When the API service starts, it uses </span><code><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml">concurrent.futures</span></code><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml"> to create a pool of workers. </span><span class="koboSpan" id="kobo.159.2" xmlns="http://www.w3.org/1999/xhtml">A request to acquire and clean data will use the </span><code><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml">submit()</span></code><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml"> method of the pool to create a </span><strong><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml">future</span></strong><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.163.2" xmlns="http://www.w3.org/1999/xhtml">This future is a reference to a subprocess that will — eventually — return the final status of the acquire and clean job. </span><span class="koboSpan" id="kobo.163.3" xmlns="http://www.w3.org/1999/xhtml">The subprocess that implements the future will evaluate the </span><code><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml">acquire_series()</span></code><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml"> function defined in the same module as the RESTful API application to do the work.</span></p>
<p><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml">When the </span><code><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml">acquire_series()</span></code><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml"> function finishes the processing, it will have created a file that can be downloaded. </span><span class="koboSpan" id="kobo.168.2" xmlns="http://www.w3.org/1999/xhtml">Via the future object, it will also provide some status information to the RESTful API service to indicate the processing is done.</span></p>
<p><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml">One suggested implementation for the </span><code><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml">acquire_series()</span></code><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml"> function is to use </span><code><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml">subprocess.run()</span></code><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml"> to execute the acquire and clean applications to gather and cleanse source data. </span><span class="koboSpan" id="kobo.173.2" xmlns="http://www.w3.org/1999/xhtml">There are some other choices available. </span><span class="koboSpan" id="kobo.173.3" xmlns="http://www.w3.org/1999/xhtml">The most important alternative is to import these two other modules, and execute them directly, rather than creating a subprocess. </span><span class="koboSpan" id="kobo.173.4" xmlns="http://www.w3.org/1999/xhtml">This direct execution has the advantage of </span><span id="dx1-280007"/><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml">being slightly faster than spawning a subprocess. </span><span class="koboSpan" id="kobo.174.2" xmlns="http://www.w3.org/1999/xhtml">It has the disadvantage of making it more complicated to create a separate log file each time the </span><strong><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml">and </span><strong><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml">clean </span></strong><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml">application is executed.</span></p>
<p><span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml">We’ll take a look at the OpenAPI specification for the RESTful API first. </span><span class="koboSpan" id="kobo.179.2" xmlns="http://www.w3.org/1999/xhtml">This helps to characterize the overall UX. </span><span id="x1-280008r302"/></p>
<section class="level3" data-number="16.2.1" id="openapi-3-specification">
<h3 data-number="16.2.1"><span class="titlemark"><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml">12.2.1 </span></span> <span id="x1-2810001"/><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml">OpenAPI 3 specification</span></h3>
<p><span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml">A RESTful API requires a clear description of the requests and responses. </span><span class="koboSpan" id="kobo.182.2" xmlns="http://www.w3.org/1999/xhtml">The OpenAPI specification is a formal definition of RESTful web services. </span><span class="koboSpan" id="kobo.182.3" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://www.openapis.org"><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml">https://www.openapis.org</span></a><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.184.2" xmlns="http://www.w3.org/1999/xhtml">This document has a </span><span id="dx1-281001"/><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml">version identifier and some information about the service as a whole. </span><span class="koboSpan" id="kobo.185.2" xmlns="http://www.w3.org/1999/xhtml">For this project, the most important part is the </span><strong><span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml">paths </span></strong><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml">section, which lists the various resource types and the paths used to locate those resources. </span><span class="koboSpan" id="kobo.187.2" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml">components </span></strong><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml">section provides the needed schema definitions.</span></p>
<p><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml">An OpenAPI document often has an outline like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-193">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml">{
        "openapi": "3.0.3",
        "info": {
                "title": "The name of this service",
                "description": "Some details.",
                "version": "2023.02"
        }
        "paths": {
                "..."
        </span><span class="koboSpan" id="kobo.191.2" xmlns="http://www.w3.org/1999/xhtml">}
        "components": {
                "parameters": {"..."},
                "schemas": {"..."}
        }
}</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml">The details of the paths and components have been elided from this overview. </span><span class="koboSpan" id="kobo.192.2" xmlns="http://www.w3.org/1999/xhtml">(We’ve used </span><code><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml">"..."</span></code><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml"> in place of the details.) The idea is to show the general structure of an OpenAPI specification. </span><span class="koboSpan" id="kobo.194.2" xmlns="http://www.w3.org/1999/xhtml">While JSON is the underlying format commonly used for </span><span id="dx1-281017"/><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml">these specifications, it can be hard to read. </span><span class="koboSpan" id="kobo.195.2" xmlns="http://www.w3.org/1999/xhtml">For this reason, it’s common to use YAML notation for OpenAPI specifications.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-194">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml">Think of the OpenAPI specification as a binding contract.</span></p>
<p><span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml">The acceptance test suite should be Gherkin scenarios with a very direct mapping to the OpenAPI specification.</span></p>
<p><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml">For more on the idea of OpenAPI to Gherkin, see </span><a class="url" href="https://medium.com/capital-one-tech/spec-to-gherkin-to-code-902e346bb9aa"><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml">https://medium.com/capital-one-tech/spec-to-gherkin-to-code-902e346bb9aa</span></a><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml">The OpenAPI paths define the resources made available by a RESTful API. </span><span class="koboSpan" id="kobo.201.2" xmlns="http://www.w3.org/1999/xhtml">In this case, the resources are cleaned files, ready for analysis.</span></p>
<p><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml">We’ll often see entries in the </span><strong><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml">paths </span></strong><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml">section that look like the following YAML snippet:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-195">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml">  "/2023.02/series":
    get:
      responses:
        "200":
          description: All of the available data series.
          </span><span class="koboSpan" id="kobo.205.2" xmlns="http://www.w3.org/1999/xhtml">content:
            application/json:
              schema:
                $ref: "#/components/schemas/series_list"</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml">This shows a path that starts with an API version number (in this example, calendar versioning, “calver”, is used) and a resource-type, </span><code><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml">series</span></code><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.208.2" xmlns="http://www.w3.org/1999/xhtml">Any given path can be accessed by a variety of methods; in this example, only the </span><strong><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml">get</span></strong><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml"> method is defined.</span></p>
<p><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">One kind of response is defined for requests to this path and method combination. </span><span class="koboSpan" id="kobo.211.2" xmlns="http://www.w3.org/1999/xhtml">The response will have a status code of 200, meaning normal, successful completion. </span><span class="koboSpan" id="kobo.211.3" xmlns="http://www.w3.org/1999/xhtml">The description is there to explain </span><span id="dx1-281027"/><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml">what this resource will be. </span><span class="koboSpan" id="kobo.212.2" xmlns="http://www.w3.org/1999/xhtml">A response can define a variety of content types; in this example, only </span><code><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml">application/json</span></code><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml"> is defined. </span><span class="koboSpan" id="kobo.214.2" xmlns="http://www.w3.org/1999/xhtml">The schema for this is provided elsewhere in the OpenAPI specification, in the </span><code><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml">components/schemas</span></code><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml"> section of the document.</span></p>
<p><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml">The use of a </span><code><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml">$ref</span></code><span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml"> tag within the specification permits common definitions, such as schemas and parameters, to be collected under the </span><code><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml">components</span></code><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml"> section, permitting reuse. </span><span class="koboSpan" id="kobo.221.2" xmlns="http://www.w3.org/1999/xhtml">This follows the </span><strong><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml">DRY </span></strong><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml">Don’t Repeat Yourself</span></strong><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml">) principle of software design.</span></p>
<p><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml">It can be difficult to get the syntax correct in an OpenAPI specification. </span><span class="koboSpan" id="kobo.226.2" xmlns="http://www.w3.org/1999/xhtml">It’s helpful to have an editor that validates the specification. </span><span class="koboSpan" id="kobo.226.3" xmlns="http://www.w3.org/1999/xhtml">For example, </span><a class="url" href="https://editor.swagger.io"><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml">https://editor.swagger.io</span></a><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml"> provides an editor that helps confirm the specification is internally consistent. </span><span class="koboSpan" id="kobo.228.2" xmlns="http://www.w3.org/1999/xhtml">For readers using tools such as JetBrains’ PyCharm, there’s a plug-in editor: </span><a class="url" href="https://plugins.jetbrains.com/plugin/14837-openapi-swagger-editor"><span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml">https://plugins.jetbrains.com/plugin/14837-openapi-swagger-editor</span></a><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml">When a path has an identifier in it, then this is shown with the path name of the form </span><code><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml">"/2023.02/series/&lt;series_id&gt;"</span></code><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.233.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml">&lt;series_id&gt;</span></code><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml"> is defined in the </span><code><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml">parameters</span></code><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml"> section of this request. </span><span class="koboSpan" id="kobo.237.2" xmlns="http://www.w3.org/1999/xhtml">Since parameters are sometimes reused, it’s helpful to have a reference to a component with the common definition.</span></p>
<p><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml">The whole request might start like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-196">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml">  "/2023.02/series/&lt;series_id&gt;":
    get:
      description:
        Get series data as text ND JSON.
      </span><span class="koboSpan" id="kobo.239.2" xmlns="http://www.w3.org/1999/xhtml">parameters:
        - $ref:
            "#/components/parameters/series_id"
      responses:
        ...</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml">The details of the </span><strong><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml">responses </span></strong><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml">section have been </span><span id="dx1-281037"/><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml">omitted from this example. </span><span class="koboSpan" id="kobo.243.2" xmlns="http://www.w3.org/1999/xhtml">The parameter definition — in the </span><code><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml">components</span></code><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml"> section — might look like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-197">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml">    series_id:
      name: series_id
      in: path
      required: true
      description: Series name.
      </span><span class="koboSpan" id="kobo.246.2" xmlns="http://www.w3.org/1999/xhtml">schema:
        type: string</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml">This provides a wealth of details about the </span><code><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml">series_id</span></code><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml"> parameter, including the description and a formal schema definition. </span><span class="koboSpan" id="kobo.249.2" xmlns="http://www.w3.org/1999/xhtml">For simple APIs, the name of the parameter and the reference label under </span><code><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml">components</span></code><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml"> are often the same. </span><span class="koboSpan" id="kobo.251.2" xmlns="http://www.w3.org/1999/xhtml">In more complex cases, a parameter name might be reused, but have distinct semantics in distinct contexts. </span><span class="koboSpan" id="kobo.251.3" xmlns="http://www.w3.org/1999/xhtml">A generic word such as </span><code><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml">id</span></code><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml"> might be used in several different paths, leading to the reference label being something more descriptive than </span><code><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml">id</span></code><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml">The content for ND JSON is considered an extension to standard MIME types. </span><span class="koboSpan" id="kobo.256.2" xmlns="http://www.w3.org/1999/xhtml">Therefore the content definition for a response that includes data might look like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-198">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml">  content:
    application/x-ndjson:
      schema:
        $ref: "#/components/schemas/samples"</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml">The schema is a challenge because it </span><span id="dx1-281049"/><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml">pushes the boundaries of what JSON Schema can describe. </span><span class="koboSpan" id="kobo.259.2" xmlns="http://www.w3.org/1999/xhtml">It looks as follows:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-199">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml">    samples:
      description: &gt;
        Acquired data for a series in ND JSON format.
        </span><span class="koboSpan" id="kobo.260.2" xmlns="http://www.w3.org/1999/xhtml">See http://ndjson.org and https://jsonlines.org.
      </span><span class="koboSpan" id="kobo.260.3" xmlns="http://www.w3.org/1999/xhtml">type: string
      format: "(\\{.*?\\}\\n)+"</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml">The format information describes the physical organization of ND JSON data, but doesn’t provide any details on the structure of the schema for each individual row. </span><span class="koboSpan" id="kobo.261.2" xmlns="http://www.w3.org/1999/xhtml">The additional schema details can either be added to the description, or a separate label, distinct from other JSON schema labels, can be used, for example, ”ndjson-schema:”. </span><span id="x1-281056r305"/></p>
</section>
<section class="level3" data-number="16.2.2" id="restful-api-to-be-queried-from-a-notebook">
<h3 data-number="16.2.2"><span class="titlemark"><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml">12.2.2 </span></span> <span id="x1-2820002"/><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml">RESTful API to be queried from a notebook</span></h3>
<p><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml">The RESTful API service must be a wrapper around application programming that can perform the required processing. </span><span class="koboSpan" id="kobo.264.2" xmlns="http://www.w3.org/1999/xhtml">The idea is to </span><span id="dx1-282001"/><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml">put as little processing as possible into the RESTful API. </span><span class="koboSpan" id="kobo.265.2" xmlns="http://www.w3.org/1999/xhtml">It serves as a very thin — almost transparent — interface to the “real work” of the application. </span><span class="koboSpan" id="kobo.265.3" xmlns="http://www.w3.org/1999/xhtml">For this reason, projects such as </span><a href="ch015.xhtml#x1-26400011"><em><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml"> 11</span></em></a><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch015.xhtml#x1-26400011"><em><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.7: Interim Data Persistence</span></em></a><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml"> are the essential foundation of this RESTful API.</span></p>
<p><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml">As noted in </span><a href="#12.1"><em><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml">Figure 12.1</span></em></a><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml">, the </span><strong><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml">Background </span></strong><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml">processing is completely outside the RESTful API. </span><span class="koboSpan" id="kobo.275.2" xmlns="http://www.w3.org/1999/xhtml">This separation of concerns is absolutely essential. </span><span class="koboSpan" id="kobo.275.3" xmlns="http://www.w3.org/1999/xhtml">The general processing of samples can be performed with a CLI or through the RESTful API and create identical results.</span></p>
<p><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml">If additional processing — for example, additional cleaning — is done by the RESTful service, then there are results that can’t be reproduced from the CLI. </span><span class="koboSpan" id="kobo.276.2" xmlns="http://www.w3.org/1999/xhtml">This means the acceptance test suites have distinct results. </span><span class="koboSpan" id="kobo.276.3" xmlns="http://www.w3.org/1999/xhtml">This will lead to problems when a change is made to the underlying </span><strong><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml">or </span><strong><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml">clean </span></strong><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml">application and the “extra” processing that was jammed into the RESTful service now appears to be broken.</span></p>
<p><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml">A common source of problems </span><span id="dx1-282002"/><span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml">in enterprise software is the failure to honor the </span><strong><span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml">I</span></strong><strong><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml">nterface</span></strong> <strong><span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml">Segregation </span></strong><span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml">design principle. </span><span class="koboSpan" id="kobo.286.2" xmlns="http://www.w3.org/1999/xhtml">A complex application may be supported by several collaborating organizations. </span><span class="koboSpan" id="kobo.286.3" xmlns="http://www.w3.org/1999/xhtml">When one organization is slow to respond to requests for changes, another organization may step in and make a bad design decision, implementing processing in the API interface that should have been part of a background module with a proper CLI interface. </span><span class="koboSpan" id="kobo.286.4" xmlns="http://www.w3.org/1999/xhtml">The urge to be responsive to customers can often overshadow the importance of the separation of concerns.</span></p>
<p><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml">For this project, the server can be </span><span id="dx1-282003"/><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml">built as a single process, avoiding the need for the distributed cache. </span><span class="koboSpan" id="kobo.288.2" xmlns="http://www.w3.org/1999/xhtml">Further, because the data series and the processing logs are all simple files, a database is not required; the local filesystem is perfectly suited to this service.</span></p>
<p><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml">To create a more scalable solution, a library such as </span><strong><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml">celery </span></strong><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml">can be used to create a more robust distributed worker pool. </span><span class="koboSpan" id="kobo.291.2" xmlns="http://www.w3.org/1999/xhtml">This isn’t needed for a small server, however.</span></p>
<p><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll review how processing can be started by a RESTful API. </span><span id="x1-282004r306"/></p>
</section>
<section class="level3" data-number="16.2.3" id="a-post-request-starts-processing">
<h3 data-number="16.2.3"><span class="titlemark"><span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml">12.2.3 </span></span> <span id="x1-2830003"/><span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml">A POST request starts processing</span></h3>
<p><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml">The general approach to creating a new resource is to make a </span><code><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml">POST</span></code><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml"> request to a path. </span><span class="koboSpan" id="kobo.297.2" xmlns="http://www.w3.org/1999/xhtml">This will either return a 400 error status or it will issue a redirect (301) to a new path to retrieve the status of the </span><span id="dx1-283001"/><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml">background processing. </span><span class="koboSpan" id="kobo.298.2" xmlns="http://www.w3.org/1999/xhtml">This pattern is called the </span><strong><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml">Post-Redirect-Get </span></strong><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml">design pattern. </span><span class="koboSpan" id="kobo.300.2" xmlns="http://www.w3.org/1999/xhtml">It permits a user interacting with a browser to use the </span><strong><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">back </span></strong><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml">button to perform the </span><code><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml">GET</span></code><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml"> method again; it prevents the </span><strong><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml">back </span></strong><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml">button from submitting a duplicate request.</span></p>
<p><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml">For a client application making a request via </span><code><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml"> the redirect is essentially invisible. </span><span class="koboSpan" id="kobo.309.2" xmlns="http://www.w3.org/1999/xhtml">The request history will reveal the redirection. </span><span class="koboSpan" id="kobo.309.3" xmlns="http://www.w3.org/1999/xhtml">Also, the full URL recorded in the response will reflect the redirection.</span></p>
<p><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml">The general processing for this route, then, is as follows:</span></p>
<ol>
<li><div id="x1-283003x1">
<p><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml">Validate all of the parameters to make sure they describe the series and the source of the data. </span><span class="koboSpan" id="kobo.311.2" xmlns="http://www.w3.org/1999/xhtml">If there is anything amiss, a JSON response with the details of the problem must be returned, with a status code of 400 to indicate the request is invalid and must be changed.</span></p>
</div></li>
<li><div id="x1-283005x2">
<p><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml">Use the worker pool </span><code><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml">submit()</span></code><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml"> method to create a </span><code><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.316.2" xmlns="http://www.w3.org/1999/xhtml">This object can be saved in a local cache by the RESTful API. </span><span class="koboSpan" id="kobo.316.3" xmlns="http://www.w3.org/1999/xhtml">This cache of </span><code><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml"> objects can be queried to see the background processing currently being performed. </span><span class="koboSpan" id="kobo.318.2" xmlns="http://www.w3.org/1999/xhtml">The future’s result is usually something indicative of success or failure; for example, the return code from the subprocess – usually a zero indicates success.</span></p>
</div></li>
<li><div id="x1-283007x3">
<p><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml">Use the </span><code><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml">redirect()</span></code><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml"> function in the Bottle framework to return the status code to direct a client to another URL for the status of the just-created </span><code><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.323.2" xmlns="http://www.w3.org/1999/xhtml">Separately, a GET request will prepare a JSON document with the status of the job creating the data.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml">When using a framework like Bottle, this function is marked with a </span><code><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml">@post("/2023.02/creation")</span></code><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml"> decorator. </span><span class="koboSpan" id="kobo.326.2" xmlns="http://www.w3.org/1999/xhtml">This names the POST method </span><span id="dx1-283008"/><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml">and the path that will be handled by the function.</span></p>
<p><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml">The log files from processing can be the longer-term repository of processing history. </span><span class="koboSpan" id="kobo.328.2" xmlns="http://www.w3.org/1999/xhtml">The GET request for status will return a log and possibly the state of an active </span><code><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.330.2" xmlns="http://www.w3.org/1999/xhtml">We’ll look at this request next. </span><span id="x1-283009r307"/></p>
</section>
<section class="level3" data-number="16.2.4" id="the-get-request-for-processing-status">
<h3 data-number="16.2.4"><span class="titlemark"><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml">12.2.4 </span></span> <span id="x1-2840004"/><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml">The GET request for processing status</span></h3>
<p><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml">The initial POST request to start processing will redirect to a GET request that reveals the status of the processing. </span><span class="koboSpan" id="kobo.333.2" xmlns="http://www.w3.org/1999/xhtml">The initial </span><span id="dx1-284001"/><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml">response may have almost no other details beyond the fact that the processing job has started.</span></p>
<p><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml">This status path should return one of two things:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml">A 404 status if the process ID is unknown. </span><span class="koboSpan" id="kobo.336.2" xmlns="http://www.w3.org/1999/xhtml">This would mean no previous request had been made with this identifier and no current request has this identifier, either.</span></p></li>
<li><p><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml">A 200 status with JSON content that includes some combination of two things: the state of a future object and the log file.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml">Most users will only care about the state of the </span><code><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.340.2" xmlns="http://www.w3.org/1999/xhtml">In the case of developers, however, who are adding features to data acquire or data cleaning applications, then the log might be important support for observability.</span></p>
<p><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml">When using a framework like Bottle, this function is marked with a </span><code><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml">@get("/2023.02/creation/&lt;job_id&gt;")</span></code><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml"> decorator. </span><span class="koboSpan" id="kobo.343.2" xmlns="http://www.w3.org/1999/xhtml">This provides the method </span><span id="dx1-284002"/><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml">and the path that will be handled by the function. </span><span class="koboSpan" id="kobo.344.2" xmlns="http://www.w3.org/1999/xhtml">The use of </span><code><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml">&lt;job_id&gt;</span></code><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml"> parses this section of the path and provides the value as a separate parameter to the function that implements this route.</span></p>
<p><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml">Once the processing is complete, a subsequent request can provide the data. </span><span class="koboSpan" id="kobo.347.2" xmlns="http://www.w3.org/1999/xhtml">We’ll look at this next. </span><span id="x1-284003r308"/></p>
</section>
<section class="level3" data-number="16.2.5" id="the-get-request-for-the-results">
<h3 data-number="16.2.5"><span class="titlemark"><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml">12.2.5 </span></span> <span id="x1-2850005"/><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml">The GET request for the results</span></h3>
<p><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml">This path should return one of two things:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml">A 404 status if the series identifier is unknown.</span></p></li>
<li><p><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">A 200 status with the ND JSON content. </span><span class="koboSpan" id="kobo.352.2" xmlns="http://www.w3.org/1999/xhtml">This has a MIME type of </span><code><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">application/x-ndjson</span></code><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml"> to indicate it’s an extension to the standard collection of MIME types.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml">When using a framework like Bottle, this function is marked with a </span><code><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml">@get("/2023.02/series/&lt;series_id&gt;")</span></code><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml"> decorator. </span><span class="koboSpan" id="kobo.357.2" xmlns="http://www.w3.org/1999/xhtml">The use of </span><code><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml">&lt;series_id&gt;</span></code><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml"> parses this section of the path and provides the value as a separate parameter to the function that implements this route.</span></p>
<p><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml">A more sophisticated implementation can </span><span id="dx1-285001"/><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml">check for an </span><code><span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml">Accept</span></code><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml"> header in the request. </span><span class="koboSpan" id="kobo.363.2" xmlns="http://www.w3.org/1999/xhtml">This header will state the preferred MIME type, and might have </span><code><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml">text/csv</span></code><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml"> instead of </span><code><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml">application/x-ndjson</span></code><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.367.2" xmlns="http://www.w3.org/1999/xhtml">The use of this header permits a client to make requests for data in a format the application finds most useful. </span><span id="x1-285002r309"/></p>
</section>
<section class="level3" data-number="16.2.6" id="security-considerations">
<h3 data-number="16.2.6"><span class="titlemark"><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml">12.2.6 </span></span> <span id="x1-2860006"/><span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml">Security considerations</span></h3>
<p><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml">A RESTful API requires some care to be sure the requests fit with the overall enterprise information access policies. </span><span class="koboSpan" id="kobo.370.2" xmlns="http://www.w3.org/1999/xhtml">In some cases, this </span><span id="dx1-286001"/><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml">might mean individual access controls to be sure each person can access permitted data. </span><span class="koboSpan" id="kobo.371.2" xmlns="http://www.w3.org/1999/xhtml">There are numerous </span><strong><span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml">Single Sign-On </span></strong><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml">SSO</span></strong><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml">) products that can handle the identity of individuals.</span></p>
<p><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml">Another common approach is to have an API work with assigned API keys. </span><span class="koboSpan" id="kobo.376.2" xmlns="http://www.w3.org/1999/xhtml">The team supporting the API can provide unique API key values to known users or teams. </span><span class="koboSpan" id="kobo.376.3" xmlns="http://www.w3.org/1999/xhtml">Within most enterprises, there’s little need for automating the assignment of API keys for internal-facing APIs. </span><span class="koboSpan" id="kobo.376.4" xmlns="http://www.w3.org/1999/xhtml">The set of valid API keys may be reduced or expanded to reflect organizational merges and splits.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-200">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml">API key values are sent from the client to the server to authenticate the user making a request. </span><span class="koboSpan" id="kobo.377.2" xmlns="http://www.w3.org/1999/xhtml">They are never sent from the server to a client. </span><span class="koboSpan" id="kobo.377.3" xmlns="http://www.w3.org/1999/xhtml">The API keys can be kept in a simple text file; the file’s permissions should restrict it to read-only access by the account handling the service as a whole. </span><span class="koboSpan" id="kobo.377.4" xmlns="http://www.w3.org/1999/xhtml">This requires administrators to take steps to manage the file of API keys to avoid damaging it or revealing it to unauthorized users.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml">When working with API keys, there are a </span><span id="dx1-286002"/><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml">number of ways the client can provide the key with each API request. </span><span class="koboSpan" id="kobo.379.2" xmlns="http://www.w3.org/1999/xhtml">One of the more popular techniques is to use these complementary security features:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml">The HTTPS protocol, where all of the communication between client and server application is encrypted.</span></p></li>
<li><p><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">The HTTP </span><strong><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml">Authorization </span></strong><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml">header with </span><strong><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml">Basic </span></strong><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml">authorization. </span><span class="koboSpan" id="kobo.385.2" xmlns="http://www.w3.org/1999/xhtml">This header will have a username and the API key as the password.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml">The use of the </span><strong><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml">Authorization </span></strong><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml">header is often very simple for a client tool. </span><span class="koboSpan" id="kobo.388.2" xmlns="http://www.w3.org/1999/xhtml">Many libraries — for example, the </span><strong><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml">requests </span></strong><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml">library — offer an object class that contains the username and API key. </span><span class="koboSpan" id="kobo.390.2" xmlns="http://www.w3.org/1999/xhtml">Using the </span><code><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml">auth=</span></code><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml"> parameter on a request function will build the appropriate header.</span></p>
<p><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml">The </span><span id="dx1-286003"/><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml">use of HTTPS includes </span><strong><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">Transport Layer Security </span></strong><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml">TLS</span></strong><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml">) to keep the content of the </span><strong><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml">Authorization </span></strong><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml">header secret. </span><span class="koboSpan" id="kobo.400.2" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml">requests </span></strong><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml">package handles this politely.</span></p>
<p><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml">On the server side, each of these must be handled by our RESTful API application. </span><span class="koboSpan" id="kobo.403.2" xmlns="http://www.w3.org/1999/xhtml">Using HTTPS is best done by running the </span><strong><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml">Bottle </span></strong><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml">application inside another server. </span><span class="koboSpan" id="kobo.405.2" xmlns="http://www.w3.org/1999/xhtml">We could, for example, create an NGINX and uWSGI configuration that would run our RESTful app inside a containing server. </span><span class="koboSpan" id="kobo.405.3" xmlns="http://www.w3.org/1999/xhtml">Another choice is to use a Python-based server such as Paste or GUnicorn to contain the </span><strong><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml">Bottle </span></strong><span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml">application. </span><span class="koboSpan" id="kobo.407.2" xmlns="http://www.w3.org/1999/xhtml">It’s essential to have a container server to handle the details of HTTPS negotiation.</span></p>
<p><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml">Processing the </span><strong><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml">Authorization </span></strong><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml">header is something best done within the RESTful API. </span><span class="koboSpan" id="kobo.410.2" xmlns="http://www.w3.org/1999/xhtml">Some routes (i.e., the </span><code><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml">openapi.yaml</span></code><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml">) should not include any security considerations. </span><span class="koboSpan" id="kobo.412.2" xmlns="http://www.w3.org/1999/xhtml">Other routes — specifically those that cause state changes — may be limited to a subset of all users.</span></p>
<p><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml">This suggests the list of users includes </span><span id="dx1-286004"/><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml">some permissions as well as their API key. </span><span class="koboSpan" id="kobo.414.2" xmlns="http://www.w3.org/1999/xhtml">Each route needs to confirm the </span><strong><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml">Authorization </span></strong><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml">header has a known user and the correct key. </span><span class="koboSpan" id="kobo.416.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml">request.auth</span></code><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml"> property of the </span><code><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">request</span></code><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml"> object is a two-tuple with the username and API key value. </span><span class="koboSpan" id="kobo.420.2" xmlns="http://www.w3.org/1999/xhtml">This can be used to decide whether the request is generally acceptable, and also to decide whether a state-changing </span><strong><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml">Post </span></strong><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml">operation is permitted for the given user. </span><span class="koboSpan" id="kobo.422.2" xmlns="http://www.w3.org/1999/xhtml">This kind of processing is often implemented as a decorator.</span></p>
<p><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml">We won’t dig deeply into the design of this decorator. </span><span class="koboSpan" id="kobo.423.2" xmlns="http://www.w3.org/1999/xhtml">For this project, with so few resources, a repeated </span><code><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml">if</span></code><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml"> statement inside each function is acceptable. </span><span id="x1-286005r303"/></p>
</section>
</section>
<section class="level2" data-number="16.3" id="deliverables-18">
<h2 data-number="16.3"><span class="titlemark"><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml">12.3 </span></span> <span id="x1-2870003"/><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></h2>
<p><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml">This project has </span><span id="dx1-287001"/><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml">the following deliverables:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml">Documentation in the </span><code><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml">docs</span></code><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml"> folder</span></p></li>
<li><p><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests in the </span><code><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml">tests/features</span></code><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml">tests/steps</span></code><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml"> folders</span></p></li>
<li><p><span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for the application modules in the </span><code><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml">tests</span></code><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml"> folder</span></p></li>
<li><p><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml">An application for the RESTful API processing</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start by looking at the acceptance test cases, first. </span><span class="koboSpan" id="kobo.442.2" xmlns="http://www.w3.org/1999/xhtml">They’ll be rather complex because we need to start the RESTful API service before we can access it with a client request. </span><span id="x1-287002r310"/></p>
<section class="level3" data-number="16.3.1" id="acceptance-test-cases">
<h3 data-number="16.3.1"><span class="titlemark"><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml">12.3.1 </span></span> <span id="x1-2880001"/><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance test cases</span></h3>
<p><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">Back in </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml"> 4</span></em></a><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml">Data Acquisition Features: Web APIs and Scraping</span></em></a><span class="koboSpan" id="kobo.450.1" xmlns="http://www.w3.org/1999/xhtml">, specifically </span><a href="ch009.xhtml#x1-1360005"><em><span class="koboSpan" id="kobo.451.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests using a SQLite database</span></em></a><span class="koboSpan" id="kobo.452.1" xmlns="http://www.w3.org/1999/xhtml">, we looked at ways to describe a scenario that involved a database service.</span></p>
<p><span class="koboSpan" id="kobo.453.1" xmlns="http://www.w3.org/1999/xhtml">For this project, we’ll need to </span><span id="dx1-288001"/><span class="koboSpan" id="kobo.454.1" xmlns="http://www.w3.org/1999/xhtml">write scenarios that will lead to step definitions that start the RESTful API service.</span></p>
<p><span class="koboSpan" id="kobo.455.1" xmlns="http://www.w3.org/1999/xhtml">There’s an important question about setting the state of the RESTful API server. </span><span class="koboSpan" id="kobo.455.2" xmlns="http://www.w3.org/1999/xhtml">One approach to setting a state is by making a sequence of requests as part of the scenario. </span><span class="koboSpan" id="kobo.455.3" xmlns="http://www.w3.org/1999/xhtml">This is often appropriate for this application.</span></p>
<p><span class="koboSpan" id="kobo.456.1" xmlns="http://www.w3.org/1999/xhtml">If the server’s state is reflected in the file system, then seeding proper files can be a way to control the state of the API server. </span><span class="koboSpan" id="kobo.456.2" xmlns="http://www.w3.org/1999/xhtml">Rather than run an acquire and clean process, a test scenario can inject the appropriate status and log files into a working directory.</span></p>
<p><span class="koboSpan" id="kobo.457.1" xmlns="http://www.w3.org/1999/xhtml">Some developers have a feeling that a database (or a distributed cache) is required for RESTful APIs. </span><span class="koboSpan" id="kobo.457.2" xmlns="http://www.w3.org/1999/xhtml">In practice, it’s often the case that a shared file system is sufficient.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-201">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.458.1" xmlns="http://www.w3.org/1999/xhtml">Using files is not uncommon in practice. </span><span class="koboSpan" id="kobo.458.2" xmlns="http://www.w3.org/1999/xhtml">A database to share state is not </span><strong><span class="koboSpan" id="kobo.459.1" xmlns="http://www.w3.org/1999/xhtml">always </span></strong><span class="koboSpan" id="kobo.460.1" xmlns="http://www.w3.org/1999/xhtml">required for RESTful APIs.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.461.1" xmlns="http://www.w3.org/1999/xhtml">Using the file system for the state makes acceptance testing work out nicely. </span><span class="koboSpan" id="kobo.461.2" xmlns="http://www.w3.org/1999/xhtml">The proper files can be created to initialize the service in the state described by the given steps in the test scenario.</span></p>
<p><span class="koboSpan" id="kobo.462.1" xmlns="http://www.w3.org/1999/xhtml">A complicated scenario could look like the following:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-202">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.463.1" xmlns="http://www.w3.org/1999/xhtml">@fixture.REST_server
Scenario: Service starts and finishes acquiring data.

  </span><span class="koboSpan" id="kobo.463.2" xmlns="http://www.w3.org/1999/xhtml">Given initial request is made with path "/api/2023.02/creation" and
      method "post" and
      body with {"series": "2", "source": "Anscombe_quartet_data.csv"}
  And initial response has status "200", content-type "application/json"
  And initial response has job-id
  When polling every 2 seconds with path "/api/2023.02/creation/job-id" and
      method "get" finally has response body with status "Done"
  Then response content-type is "application/json"
  And response body has log with more than 0 lines
  And response body has series "Series_2"
  And response body has status "done"</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.464.1" xmlns="http://www.w3.org/1999/xhtml">For more background on creating a fixture, see </span><a href="ch008.xhtml#x1-910003"><em><span class="koboSpan" id="kobo.465.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests</span></em></a><span class="koboSpan" id="kobo.466.1" xmlns="http://www.w3.org/1999/xhtml"> in </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.467.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.468.1" xmlns="http://www.w3.org/1999/xhtml"> 4</span></em></a><span class="koboSpan" id="kobo.469.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.470.1" xmlns="http://www.w3.org/1999/xhtml">Data Acquisition Features: Web APIs and Scraping</span></em></a><span class="koboSpan" id="kobo.471.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.471.2" xmlns="http://www.w3.org/1999/xhtml">This scenario references a fixture named </span><code><span class="koboSpan" id="kobo.472.1" xmlns="http://www.w3.org/1999/xhtml">REST_server</span></code><span class="koboSpan" id="kobo.473.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.473.2" xmlns="http://www.w3.org/1999/xhtml">This means the </span><code><span class="koboSpan" id="kobo.474.1" xmlns="http://www.w3.org/1999/xhtml">environment.py</span></code><span class="koboSpan" id="kobo.475.1" xmlns="http://www.w3.org/1999/xhtml"> must define this fixture, and provide a </span><code><span class="koboSpan" id="kobo.476.1" xmlns="http://www.w3.org/1999/xhtml">before_tag()</span></code><span class="koboSpan" id="kobo.477.1" xmlns="http://www.w3.org/1999/xhtml"> function that will make sure the fixture is used.</span></p>
<p><span class="koboSpan" id="kobo.478.1" xmlns="http://www.w3.org/1999/xhtml">The given steps specify an initial query and response. </span><span class="koboSpan" id="kobo.478.2" xmlns="http://www.w3.org/1999/xhtml">This should set the required state in the API server. </span><span class="koboSpan" id="kobo.478.3" xmlns="http://www.w3.org/1999/xhtml">This request for processing will initiate the acquire and clean processing. </span><span class="koboSpan" id="kobo.478.4" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.479.1" xmlns="http://www.w3.org/1999/xhtml">When</span></code><span class="koboSpan" id="kobo.480.1" xmlns="http://www.w3.org/1999/xhtml"> step specifies a sequence of </span><span id="dx1-288016"/><span class="koboSpan" id="kobo.481.1" xmlns="http://www.w3.org/1999/xhtml">actions that include polling periodically until the requested processing finishes.</span></p>
<p><span class="koboSpan" id="kobo.482.1" xmlns="http://www.w3.org/1999/xhtml">Note the path provided in the </span><code><span class="koboSpan" id="kobo.483.1" xmlns="http://www.w3.org/1999/xhtml">When</span></code><span class="koboSpan" id="kobo.484.1" xmlns="http://www.w3.org/1999/xhtml"> statement. </span><span class="koboSpan" id="kobo.484.2" xmlns="http://www.w3.org/1999/xhtml">The text </span><code><span class="koboSpan" id="kobo.485.1" xmlns="http://www.w3.org/1999/xhtml">job-id</span></code><span class="koboSpan" id="kobo.486.1" xmlns="http://www.w3.org/1999/xhtml"> is in the scenario’s path. </span><span class="koboSpan" id="kobo.486.2" xmlns="http://www.w3.org/1999/xhtml">The step definition function must replace this template string with the actual job identifier. </span><span class="koboSpan" id="kobo.486.3" xmlns="http://www.w3.org/1999/xhtml">This identifier will be in response to the initial request in the given step. </span><span class="koboSpan" id="kobo.486.4" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.487.1" xmlns="http://www.w3.org/1999/xhtml">Given</span></code><span class="koboSpan" id="kobo.488.1" xmlns="http://www.w3.org/1999/xhtml"> step’s definition function must save the value in the context for use in later steps.</span></p>
<p><span class="koboSpan" id="kobo.489.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.490.1" xmlns="http://www.w3.org/1999/xhtml">Then</span></code><span class="koboSpan" id="kobo.491.1" xmlns="http://www.w3.org/1999/xhtml"> step confirms that series data was returned. </span><span class="koboSpan" id="kobo.491.2" xmlns="http://www.w3.org/1999/xhtml">This example does not show a very complete check of the result. </span><span class="koboSpan" id="kobo.491.3" xmlns="http://www.w3.org/1999/xhtml">You are encouraged to expand on this kind of acceptance test scenario to be more complete in checking the actual results match the expected results.</span></p>
<p><span class="koboSpan" id="kobo.492.1" xmlns="http://www.w3.org/1999/xhtml">For some applications, the retrieval of a tiny test case dataset may be a feature that helps test the application. </span><span class="koboSpan" id="kobo.492.2" xmlns="http://www.w3.org/1999/xhtml">The ordinary datasets the users want may be quite large, but a special, exceptionally small dataset may also be made available to confirm all the parts are working in concert.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-203">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.493.1" xmlns="http://www.w3.org/1999/xhtml">A self-test resource is often essential for health checks, diagnostics, and general site reliability.</span></p>
<p><span class="koboSpan" id="kobo.494.1" xmlns="http://www.w3.org/1999/xhtml">Network load balancers often need to probe a server to be sure it’s capable of handling requests. </span><span class="koboSpan" id="kobo.494.2" xmlns="http://www.w3.org/1999/xhtml">A self-test URI can be helpful for this purpose.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.495.1" xmlns="http://www.w3.org/1999/xhtml">A very subtle issue arises when trying to stop this service. </span><span class="koboSpan" id="kobo.495.2" xmlns="http://www.w3.org/1999/xhtml">It contains a worker pool, and the parent process needs to use the Linux </span><code><span class="koboSpan" id="kobo.496.1" xmlns="http://www.w3.org/1999/xhtml">wait()</span></code><span class="koboSpan" id="kobo.497.1" xmlns="http://www.w3.org/1999/xhtml"> to properly terminate the children.</span></p>
<p><span class="koboSpan" id="kobo.498.1" xmlns="http://www.w3.org/1999/xhtml">One reliable way to do this is to use </span><code><span class="koboSpan" id="kobo.499.1" xmlns="http://www.w3.org/1999/xhtml">server.send_signal(signal.SIGINT)</span></code><span class="koboSpan" id="kobo.500.1" xmlns="http://www.w3.org/1999/xhtml"> in the function that starts the service to create the </span><span id="dx1-288017"/><span class="koboSpan" id="kobo.501.1" xmlns="http://www.w3.org/1999/xhtml">fixture for a scenario. </span><span class="koboSpan" id="kobo.501.2" xmlns="http://www.w3.org/1999/xhtml">This means the fixture function will have the following outline:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-204">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.502.1" xmlns="http://www.w3.org/1999/xhtml">@fixture
def rest_server(context: Context) -&gt; Iterator[Any]:
        # Create log file, base URI (code omitted)

        server = subprocess.Popen([sys.executable, "src/service.py"],
    shell=False, stdout=context.log_file, stderr=subprocess.STDOUT)
    time.sleep(0.5)  # 500 ms delay to allow the service to open a socket

    yield server  # Scenario can now proceed.

    </span><span class="koboSpan" id="kobo.502.2" xmlns="http://www.w3.org/1999/xhtml"># 100 ms delay to let server’s workers become idle.
    </span><span class="koboSpan" id="kobo.502.3" xmlns="http://www.w3.org/1999/xhtml">time.sleep(0.10)
    server.send_signal(signal.SIGINT)
    # 100 ms delay to let API’s subprocesses all terminate.
    </span><span class="koboSpan" id="kobo.502.4" xmlns="http://www.w3.org/1999/xhtml">time.sleep(0.10)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.503.1" xmlns="http://www.w3.org/1999/xhtml">The various </span><code><span class="koboSpan" id="kobo.504.1" xmlns="http://www.w3.org/1999/xhtml">sleep()</span></code><span class="koboSpan" id="kobo.505.1" xmlns="http://www.w3.org/1999/xhtml"> timings are generous over-estimations of the time required for the server subprocess to complete the various startup and shut-down tasks. </span><span class="koboSpan" id="kobo.505.2" xmlns="http://www.w3.org/1999/xhtml">In some cases, the OS scheduler will handle this gracefully. </span><span class="koboSpan" id="kobo.505.3" xmlns="http://www.w3.org/1999/xhtml">In other cases, however, disconnected child processes can be left in the list of running processes. </span><span class="koboSpan" id="kobo.505.4" xmlns="http://www.w3.org/1999/xhtml">These “zombie processes” need to be terminated manually, something we’d like to avoid.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-205">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.506.1" xmlns="http://www.w3.org/1999/xhtml">On most Linux-derived OSs, the </span><code><span class="koboSpan" id="kobo.507.1" xmlns="http://www.w3.org/1999/xhtml">ps</span></code><code><span class="koboSpan" id="kobo.508.1" xmlns="http://www.w3.org/1999/xhtml"> -ef</span></code><span class="koboSpan" id="kobo.509.1" xmlns="http://www.w3.org/1999/xhtml"> command will show all processes. </span><span class="koboSpan" id="kobo.509.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.510.1" xmlns="http://www.w3.org/1999/xhtml">ps</span></code><code><span class="koboSpan" id="kobo.511.1" xmlns="http://www.w3.org/1999/xhtml"> -ef</span></code><code><span class="koboSpan" id="kobo.512.1" xmlns="http://www.w3.org/1999/xhtml"> |</span></code><code><span class="koboSpan" id="kobo.513.1" xmlns="http://www.w3.org/1999/xhtml"> grep</span></code><code><span class="koboSpan" id="kobo.514.1" xmlns="http://www.w3.org/1999/xhtml"> python</span></code><span class="koboSpan" id="kobo.515.1" xmlns="http://www.w3.org/1999/xhtml"> pipeline will show all Python processes.</span></p>
<p><span class="koboSpan" id="kobo.516.1" xmlns="http://www.w3.org/1999/xhtml">From this list, any zombie worker pool processes should be apparent.</span></p>
</div>
</div>
<p><code><span class="koboSpan" id="kobo.517.1" xmlns="http://www.w3.org/1999/xhtml">signal.SIGINT</span></code><span class="koboSpan" id="kobo.518.1" xmlns="http://www.w3.org/1999/xhtml"> is the control-C interrupt signal. </span><span class="koboSpan" id="kobo.518.2" xmlns="http://www.w3.org/1999/xhtml">The Python process makes this an exception that will not be handled. </span><span class="koboSpan" id="kobo.518.3" xmlns="http://www.w3.org/1999/xhtml">When this </span><span id="dx1-288033"/><span class="koboSpan" id="kobo.519.1" xmlns="http://www.w3.org/1999/xhtml">exception exits from the </span><code><span class="koboSpan" id="kobo.520.1" xmlns="http://www.w3.org/1999/xhtml">with</span></code><span class="koboSpan" id="kobo.521.1" xmlns="http://www.w3.org/1999/xhtml"> statement that created the process pool, a complete clean-up will be finished and no zombie processes will be left running.</span></p>
<p><span class="koboSpan" id="kobo.522.1" xmlns="http://www.w3.org/1999/xhtml">Now that we’ve looked at the acceptance test that defines proper behavior, we can look at the RESTful API server application. </span><span id="x1-288034r312"/></p>
</section>
<section class="level3" data-number="16.3.2" id="restful-api-app">
<h3 data-number="16.3.2"><span class="titlemark"><span class="koboSpan" id="kobo.523.1" xmlns="http://www.w3.org/1999/xhtml">12.3.2 </span></span> <span id="x1-2890002"/><span class="koboSpan" id="kobo.524.1" xmlns="http://www.w3.org/1999/xhtml">RESTful API app</span></h3>
<p><span class="koboSpan" id="kobo.525.1" xmlns="http://www.w3.org/1999/xhtml">The RESTful API application can be built with any of the available frameworks. </span><span class="koboSpan" id="kobo.525.2" xmlns="http://www.w3.org/1999/xhtml">Since a previous chapter (</span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.526.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.527.1" xmlns="http://www.w3.org/1999/xhtml"> 4</span></em></a><span class="koboSpan" id="kobo.528.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.529.1" xmlns="http://www.w3.org/1999/xhtml">Data Acquisition Features: Web APIs and</span></em> <em><span class="koboSpan" id="kobo.530.1" xmlns="http://www.w3.org/1999/xhtml">Scraping</span></em></a><span class="koboSpan" id="kobo.531.1" xmlns="http://www.w3.org/1999/xhtml">) used the Bottle framework, you can continue with this small framework. </span><span class="koboSpan" id="kobo.531.2" xmlns="http://www.w3.org/1999/xhtml">Because Bottle is </span><span id="dx1-289001"/><span class="koboSpan" id="kobo.532.1" xmlns="http://www.w3.org/1999/xhtml">very much like Flask, when additional features are needed, the upgrade to Flask isn’t horribly complicated.</span></p>
<p><span class="koboSpan" id="kobo.533.1" xmlns="http://www.w3.org/1999/xhtml">One of the advantages of using Flask for this application is an integrated client for writing unit test cases. </span><span class="koboSpan" id="kobo.533.2" xmlns="http://www.w3.org/1999/xhtml">The Bottle project can do everything that’s required, but it lacks a test client. </span><span class="koboSpan" id="kobo.533.3" xmlns="http://www.w3.org/1999/xhtml">When looking at unit testing, we’ll also look at unit test tools for the Bottle framework.</span></p>
<p><span class="koboSpan" id="kobo.534.1" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="#x1-2810001"><em><span class="koboSpan" id="kobo.535.1" xmlns="http://www.w3.org/1999/xhtml">OpenAPI 3 specification</span></em></a><span class="koboSpan" id="kobo.536.1" xmlns="http://www.w3.org/1999/xhtml"> we looked at the OpenAPI specification for a specific path. </span><span class="koboSpan" id="kobo.536.2" xmlns="http://www.w3.org/1999/xhtml">Here’s how that specification can be implemented:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-206">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.537.1" xmlns="http://www.w3.org/1999/xhtml">from bottle import response, get

@get(’/api/2023.02/series’)
def series_list():
    series_metadata = [
        {"name": series.stem, "elements": series_size(series)}
        for series in DATA_PATH.glob("*.ndj")
    ]
    response.status = 200
    response.body = json.dumps(series_metadata, indent=2)
    response.content_type = "application/json"
    return response</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.538.1" xmlns="http://www.w3.org/1999/xhtml">This function builds a sequence of metadata dictionaries. </span><span class="koboSpan" id="kobo.538.2" xmlns="http://www.w3.org/1999/xhtml">Each item has a series name, which is used in a separate request to get the data. </span><span class="koboSpan" id="kobo.538.3" xmlns="http://www.w3.org/1999/xhtml">The size is computed by a small function to read the series and find the number of samples.</span></p>
<p><span class="koboSpan" id="kobo.539.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.540.1" xmlns="http://www.w3.org/1999/xhtml">response</span></code><span class="koboSpan" id="kobo.541.1" xmlns="http://www.w3.org/1999/xhtml"> object is not always manipulated as shown in this example. </span><span class="koboSpan" id="kobo.541.2" xmlns="http://www.w3.org/1999/xhtml">This is an extreme case, where the value to be returned is not a Python dictionary. </span><span class="koboSpan" id="kobo.541.3" xmlns="http://www.w3.org/1999/xhtml">If the return value is a dictionary, the Bottle framework </span><span id="dx1-289014"/><span class="koboSpan" id="kobo.542.1" xmlns="http://www.w3.org/1999/xhtml">will convert it to JSON, and the content type will be set to </span><code><span class="koboSpan" id="kobo.543.1" xmlns="http://www.w3.org/1999/xhtml">application/json</span></code><span class="koboSpan" id="kobo.544.1" xmlns="http://www.w3.org/1999/xhtml"> automatically. </span><span class="koboSpan" id="kobo.544.2" xmlns="http://www.w3.org/1999/xhtml">In this case, the result is a list of dictionaries; the Bottle framework will not automatically serialize the object in JSON notation.</span></p>
<p><span class="koboSpan" id="kobo.545.1" xmlns="http://www.w3.org/1999/xhtml">An important part of the design is a cache to retain </span><code><span class="koboSpan" id="kobo.546.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.547.1" xmlns="http://www.w3.org/1999/xhtml"> objects until the processing completes, and the data is available. </span><span class="koboSpan" id="kobo.547.2" xmlns="http://www.w3.org/1999/xhtml">One way to handle this is with a dataclass that keeps the parameters of the request, the </span><code><span class="koboSpan" id="kobo.548.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.549.1" xmlns="http://www.w3.org/1999/xhtml"> object that will produce the results, and the assigned job identifier.</span></p>
<p><span class="koboSpan" id="kobo.550.1" xmlns="http://www.w3.org/1999/xhtml">This structure for each </span><code><span class="koboSpan" id="kobo.551.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.552.1" xmlns="http://www.w3.org/1999/xhtml"> object might look like the following example:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-207">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.553.1" xmlns="http://www.w3.org/1999/xhtml">from conccurrent import futures
from dataclasses import dataclass, field
from pathlib import Path
import secrets

@dataclass
class AcquireJob:
    series: str
    source_path: Path
    output_path: Path
    future: futures.Future = field(init=False)
    job_id: str = field(default_factory=lambda:
    \secrets.token_urlsafe(nbytes=12))</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.554.1" xmlns="http://www.w3.org/1999/xhtml">This keeps the parameters for the request as well as the processing details. </span><span class="koboSpan" id="kobo.554.2" xmlns="http://www.w3.org/1999/xhtml">The values for </span><code><span class="koboSpan" id="kobo.555.1" xmlns="http://www.w3.org/1999/xhtml">series</span></code><span class="koboSpan" id="kobo.556.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.557.1" xmlns="http://www.w3.org/1999/xhtml">source_path</span></code><span class="koboSpan" id="kobo.558.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.559.1" xmlns="http://www.w3.org/1999/xhtml">output_path</span></code><span class="koboSpan" id="kobo.560.1" xmlns="http://www.w3.org/1999/xhtml"> are built from the parameters provided when making an initial request. </span><span class="koboSpan" id="kobo.560.2" xmlns="http://www.w3.org/1999/xhtml">The paths are built from supplied names and include the base path for the working directory the server is using. </span><span class="koboSpan" id="kobo.560.3" xmlns="http://www.w3.org/1999/xhtml">In this example, the user’s input is limited to the series name and the data source. </span><span class="koboSpan" id="kobo.560.4" xmlns="http://www.w3.org/1999/xhtml">These come from a small domain of valid values, making it relatively easy to validate these values.</span></p>
<p><span class="koboSpan" id="kobo.561.1" xmlns="http://www.w3.org/1999/xhtml">The RESTful API can then create the </span><span id="dx1-289028"/><span class="koboSpan" id="kobo.562.1" xmlns="http://www.w3.org/1999/xhtml">output path within the appropriate directory of cleaned data.</span></p>
<p><span class="koboSpan" id="kobo.563.1" xmlns="http://www.w3.org/1999/xhtml">The value for the </span><code><span class="koboSpan" id="kobo.564.1" xmlns="http://www.w3.org/1999/xhtml">job_id</span></code><span class="koboSpan" id="kobo.565.1" xmlns="http://www.w3.org/1999/xhtml"> attribute is computed automatically when an instance of the </span><code><span class="koboSpan" id="kobo.566.1" xmlns="http://www.w3.org/1999/xhtml">AcquireJob</span></code><span class="koboSpan" id="kobo.567.1" xmlns="http://www.w3.org/1999/xhtml"> class is created.</span></p>
<p><span class="koboSpan" id="kobo.568.1" xmlns="http://www.w3.org/1999/xhtml">The value for the </span><code><span class="koboSpan" id="kobo.569.1" xmlns="http://www.w3.org/1999/xhtml">future</span></code><span class="koboSpan" id="kobo.570.1" xmlns="http://www.w3.org/1999/xhtml"> attribute is set when the </span><code><span class="koboSpan" id="kobo.571.1" xmlns="http://www.w3.org/1999/xhtml">submit()</span></code><span class="koboSpan" id="kobo.572.1" xmlns="http://www.w3.org/1999/xhtml"> method is used to submit a processing request to process a pool of waiting workers.</span></p>
<p><span class="koboSpan" id="kobo.573.1" xmlns="http://www.w3.org/1999/xhtml">The worker pool needs to be created before any work can be done by the RESTful API. </span><span class="koboSpan" id="kobo.573.2" xmlns="http://www.w3.org/1999/xhtml">The startup can look like the following:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.574.1" xmlns="http://www.w3.org/1999/xhtml">from conccurrent import futures
import urllib.parse

WORKERS: futures.ProcessPoolExecutor

# Definitions of all of the routes

if __name__ == "__main__":
	# Defaults...
	</span><span class="koboSpan" id="kobo.574.2" xmlns="http://www.w3.org/1999/xhtml">acquire_uri = "http://localhost:8080"
	# Parse a configuration, here; possibly overriding defaults
    uri = urllib.parse.urlparse(acquire_uri)
	with futures.ProcessPoolExecutor() as WORKERS:
        run(host=uri.hostname, port=uri.port)</span></pre>
<p><span class="koboSpan" id="kobo.575.1" xmlns="http://www.w3.org/1999/xhtml">Each route is handled by a separate function. </span><span class="koboSpan" id="kobo.575.2" xmlns="http://www.w3.org/1999/xhtml">Because of this, the Bottle (as well as the Flask) framework expects the worker pool to be a global object shared by all of the route-handling functions. </span><span class="koboSpan" id="kobo.575.3" xmlns="http://www.w3.org/1999/xhtml">In the event of a multi-threaded server, a lock must be used before a write access to the </span><code><span class="koboSpan" id="kobo.576.1" xmlns="http://www.w3.org/1999/xhtml">WORKERS</span></code><span class="koboSpan" id="kobo.577.1" xmlns="http://www.w3.org/1999/xhtml"> global.</span></p>
<p><span class="koboSpan" id="kobo.578.1" xmlns="http://www.w3.org/1999/xhtml">Similarly, the cache of </span><code><span class="koboSpan" id="kobo.579.1" xmlns="http://www.w3.org/1999/xhtml">AcquireJob</span></code><span class="koboSpan" id="kobo.580.1" xmlns="http://www.w3.org/1999/xhtml"> instances is also expected to be a global object. </span><span class="koboSpan" id="kobo.580.2" xmlns="http://www.w3.org/1999/xhtml">This is updated only by the route-handling function to handle initiating a processing request. </span><span class="koboSpan" id="kobo.580.3" xmlns="http://www.w3.org/1999/xhtml">This cache will be queried by a route that shows the status of a processing request. </span><span class="koboSpan" id="kobo.580.4" xmlns="http://www.w3.org/1999/xhtml">In the event of a multi-threaded server, a lock must be used before adding a new item to the global cache of working jobs.</span></p>
<p><span class="koboSpan" id="kobo.581.1" xmlns="http://www.w3.org/1999/xhtml">In some cases, where the load is particularly heavy, thread-local storage may be needed for any processing done by the </span><span id="dx1-289043"/><span class="koboSpan" id="kobo.582.1" xmlns="http://www.w3.org/1999/xhtml">various functions in the RESTful API implementation. </span><span class="koboSpan" id="kobo.582.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.583.1" xmlns="http://www.w3.org/1999/xhtml">request</span></code><span class="koboSpan" id="kobo.584.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.585.1" xmlns="http://www.w3.org/1999/xhtml">response</span></code><span class="koboSpan" id="kobo.586.1" xmlns="http://www.w3.org/1999/xhtml"> objects, in particular, are already in thread-local storage. </span><span class="koboSpan" id="kobo.586.2" xmlns="http://www.w3.org/1999/xhtml">Ideally, there is very little processing done by these functions, minimizing the number of objects that need to be created and kept in an instance of </span><code><span class="koboSpan" id="kobo.587.1" xmlns="http://www.w3.org/1999/xhtml">threading.local</span></code><span class="koboSpan" id="kobo.588.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.589.1" xmlns="http://www.w3.org/1999/xhtml">There are a few special considerations for the unit tests for this project. </span><span class="koboSpan" id="kobo.589.2" xmlns="http://www.w3.org/1999/xhtml">We’ll look at those in the next section. </span><span id="x1-289044r313"/></p>
</section>
<section class="level3" data-number="16.3.3" id="unit-test-cases-2">
<h3 data-number="16.3.3"><span class="titlemark"><span class="koboSpan" id="kobo.590.1" xmlns="http://www.w3.org/1999/xhtml">12.3.3 </span></span> <span id="x1-2900003"/><span class="koboSpan" id="kobo.591.1" xmlns="http://www.w3.org/1999/xhtml">Unit test cases</span></h3>
<p><span class="koboSpan" id="kobo.592.1" xmlns="http://www.w3.org/1999/xhtml">Some frameworks — like </span><strong><span class="koboSpan" id="kobo.593.1" xmlns="http://www.w3.org/1999/xhtml">Flask </span></strong><span class="koboSpan" id="kobo.594.1" xmlns="http://www.w3.org/1999/xhtml">— offer a test client </span><span id="dx1-290001"/><span class="koboSpan" id="kobo.595.1" xmlns="http://www.w3.org/1999/xhtml">that can be used to exercise an application without the overheads of </span><span id="dx1-290002"/><span class="koboSpan" id="kobo.596.1" xmlns="http://www.w3.org/1999/xhtml">starting a server and a worker pool.</span></p>
<p><span class="koboSpan" id="kobo.597.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.598.1" xmlns="http://www.w3.org/1999/xhtml">Bottle </span></strong><span class="koboSpan" id="kobo.599.1" xmlns="http://www.w3.org/1999/xhtml">framework doesn’t offer a test client. </span><span class="koboSpan" id="kobo.599.2" xmlns="http://www.w3.org/1999/xhtml">An associated project, </span><strong><span class="koboSpan" id="kobo.600.1" xmlns="http://www.w3.org/1999/xhtml">boddle</span></strong><span class="koboSpan" id="kobo.601.1" xmlns="http://www.w3.org/1999/xhtml">, offers a way to build a mock </span><code><span class="koboSpan" id="kobo.602.1" xmlns="http://www.w3.org/1999/xhtml">request</span></code><span class="koboSpan" id="kobo.603.1" xmlns="http://www.w3.org/1999/xhtml"> object to support unit testing. </span><span class="koboSpan" id="kobo.603.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://github.com/keredson/boddle"><span class="koboSpan" id="kobo.604.1" xmlns="http://www.w3.org/1999/xhtml">https://github.com/keredson/boddle</span></a><span class="koboSpan" id="kobo.605.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.606.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.607.1" xmlns="http://www.w3.org/1999/xhtml">WebTest </span></strong><span class="koboSpan" id="kobo.608.1" xmlns="http://www.w3.org/1999/xhtml">project is an alternative </span><span id="dx1-290003"/><span class="koboSpan" id="kobo.609.1" xmlns="http://www.w3.org/1999/xhtml">for writing unit tests. </span><span class="koboSpan" id="kobo.609.2" xmlns="http://www.w3.org/1999/xhtml">A </span><strong><span class="koboSpan" id="kobo.610.1" xmlns="http://www.w3.org/1999/xhtml">WebTest </span></strong><span class="koboSpan" id="kobo.611.1" xmlns="http://www.w3.org/1999/xhtml">fixture contains the Bottle application and provides requests and responses </span><span id="dx1-290004"/><span class="koboSpan" id="kobo.612.1" xmlns="http://www.w3.org/1999/xhtml">through the internal WSGI interface. </span><span class="koboSpan" id="kobo.612.2" xmlns="http://www.w3.org/1999/xhtml">This avoids the need to start a complete server. </span><span class="koboSpan" id="kobo.612.3" xmlns="http://www.w3.org/1999/xhtml">It also permits some monkey-patching of the Bottle application to mock components. </span><span class="koboSpan" id="kobo.612.4" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://docs.pylonsproject.org/projects/webtest/en/latest/"><span class="koboSpan" id="kobo.613.1" xmlns="http://www.w3.org/1999/xhtml">https://docs.pylonsproject.org/projects/webtest/en/latest/</span></a><span class="koboSpan" id="kobo.614.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.615.1" xmlns="http://www.w3.org/1999/xhtml">It seems best to use the very sophisticated </span><code><span class="koboSpan" id="kobo.616.1" xmlns="http://www.w3.org/1999/xhtml">WebTest</span></code><span class="koboSpan" id="kobo.617.1" xmlns="http://www.w3.org/1999/xhtml"> client that’s part of the </span><strong><span class="koboSpan" id="kobo.618.1" xmlns="http://www.w3.org/1999/xhtml">Pylons </span></strong><span class="koboSpan" id="kobo.619.1" xmlns="http://www.w3.org/1999/xhtml">framework. </span><span class="koboSpan" id="kobo.619.2" xmlns="http://www.w3.org/1999/xhtml">This client can execute the unit tests.</span></p>
<p><span class="koboSpan" id="kobo.620.1" xmlns="http://www.w3.org/1999/xhtml">It’s sometimes helpful to note that functions with decorators are composite objects. </span><span class="koboSpan" id="kobo.620.2" xmlns="http://www.w3.org/1999/xhtml">This means the “unit” test isn’t testing the decoration and the function in isolation from each other. </span><span class="koboSpan" id="kobo.620.3" xmlns="http://www.w3.org/1999/xhtml">This lack of separate testing can sometimes lead to difficulty in debugging the root cause of a test case failure. </span><span class="koboSpan" id="kobo.620.4" xmlns="http://www.w3.org/1999/xhtml">A problem may be in the function, it may be the </span><code><span class="koboSpan" id="kobo.621.1" xmlns="http://www.w3.org/1999/xhtml">@route</span></code><span class="koboSpan" id="kobo.622.1" xmlns="http://www.w3.org/1999/xhtml"> decorator, or it may be any authorization decorator that’s also part of the composite function being tested.</span></p>
<p><span class="koboSpan" id="kobo.623.1" xmlns="http://www.w3.org/1999/xhtml">It seems easier to test the composite </span><span id="dx1-290005"/><span class="koboSpan" id="kobo.624.1" xmlns="http://www.w3.org/1999/xhtml">route functions, using appropriate log messages for debugging. </span><span class="koboSpan" id="kobo.624.2" xmlns="http://www.w3.org/1999/xhtml">While this doesn’t follow the strict idea of testing each component in isolation, it does work well for testing each route with appropriate mocks. </span><span class="koboSpan" id="kobo.624.3" xmlns="http://www.w3.org/1999/xhtml">For example, we can mock the worker pool, avoiding the overhead of starting a subprocess when testing.</span></p>
<p><span class="koboSpan" id="kobo.625.1" xmlns="http://www.w3.org/1999/xhtml">Here’s an example of a test function using </span><strong><span class="koboSpan" id="kobo.626.1" xmlns="http://www.w3.org/1999/xhtml">WebTest </span></strong><span class="koboSpan" id="kobo.627.1" xmlns="http://www.w3.org/1999/xhtml">to exercise a </span><strong><span class="koboSpan" id="kobo.628.1" xmlns="http://www.w3.org/1999/xhtml">Bottle</span></strong><span class="koboSpan" id="kobo.629.1" xmlns="http://www.w3.org/1999/xhtml"> route:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-208">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.630.1" xmlns="http://www.w3.org/1999/xhtml">from unittest.mock import sentinel, Mock, call
from pytest import fixture, MonkeyPatch
from webtest import TestApp
import service

def test_test(monkeypatch: MonkeyPatch) -&gt; None:
    monkeypatch.setitem(service.ACCESS, "unit-test", "unit-test")
    app = TestApp(service.app)
    app.authorization = (
        "Basic", ("unit-test", "unit-test")
    )
    response = app.get("/api/2023.02/test")
    assert response.status_code == 200
    assert response.json[’status’] == "OK"</span></pre>
</div>
</div>
<p><code><span class="koboSpan" id="kobo.631.1" xmlns="http://www.w3.org/1999/xhtml">service.app</span></code><span class="koboSpan" id="kobo.632.1" xmlns="http://www.w3.org/1999/xhtml"> is the global </span><code><span class="koboSpan" id="kobo.633.1" xmlns="http://www.w3.org/1999/xhtml">app</span></code><span class="koboSpan" id="kobo.634.1" xmlns="http://www.w3.org/1999/xhtml"> object in the RESTful API application. </span><span class="koboSpan" id="kobo.634.2" xmlns="http://www.w3.org/1999/xhtml">This is an instance of the </span><code><span class="koboSpan" id="kobo.635.1" xmlns="http://www.w3.org/1999/xhtml">Bottle</span></code><span class="koboSpan" id="kobo.636.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><code><span class="koboSpan" id="kobo.637.1" xmlns="http://www.w3.org/1999/xhtml">service.ACCESS</span></code><span class="koboSpan" id="kobo.638.1" xmlns="http://www.w3.org/1999/xhtml"> is the global list of usernames and their expected API keys. </span><span class="koboSpan" id="kobo.638.2" xmlns="http://www.w3.org/1999/xhtml">This is monkey-patched by the test to force in a specific test username and test API Key. </span><span class="koboSpan" id="kobo.638.3" xmlns="http://www.w3.org/1999/xhtml">This initial setup is something that might be used by a </span><span id="dx1-290020"/><span class="koboSpan" id="kobo.639.1" xmlns="http://www.w3.org/1999/xhtml">number of tests and should be defined as a reusable fixture.</span></p>
<p><span class="koboSpan" id="kobo.640.1" xmlns="http://www.w3.org/1999/xhtml">When the </span><code><span class="koboSpan" id="kobo.641.1" xmlns="http://www.w3.org/1999/xhtml">app.get()</span></code><span class="koboSpan" id="kobo.642.1" xmlns="http://www.w3.org/1999/xhtml"> request is made, the test harness will execute the </span><code><span class="koboSpan" id="kobo.643.1" xmlns="http://www.w3.org/1999/xhtml">route</span></code><span class="koboSpan" id="kobo.644.1" xmlns="http://www.w3.org/1999/xhtml"> function and collect the response for examination by the </span><code><span class="koboSpan" id="kobo.645.1" xmlns="http://www.w3.org/1999/xhtml">test</span></code><span class="koboSpan" id="kobo.646.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.646.2" xmlns="http://www.w3.org/1999/xhtml">This makes a direct function call, avoiding the overhead of a network request.</span></p>
<p><span class="koboSpan" id="kobo.647.1" xmlns="http://www.w3.org/1999/xhtml">One of the reasons for choosing to use </span><strong><span class="koboSpan" id="kobo.648.1" xmlns="http://www.w3.org/1999/xhtml">Flask </span></strong><span class="koboSpan" id="kobo.649.1" xmlns="http://www.w3.org/1999/xhtml">instead of </span><strong><span class="koboSpan" id="kobo.650.1" xmlns="http://www.w3.org/1999/xhtml">Bottle </span></strong><span class="koboSpan" id="kobo.651.1" xmlns="http://www.w3.org/1999/xhtml">is the availability of a test client that can simplify some of this test setup. </span><span id="x1-290021r311"/></p>
</section>
</section>
<section class="level2" data-number="16.4" id="summary-11">
<h2 data-number="16.4"><span class="titlemark"><span class="koboSpan" id="kobo.652.1" xmlns="http://www.w3.org/1999/xhtml">12.4 </span></span> <span id="x1-2910004"/><span class="koboSpan" id="kobo.653.1" xmlns="http://www.w3.org/1999/xhtml">Summary</span></h2>
<p><span class="koboSpan" id="kobo.654.1" xmlns="http://www.w3.org/1999/xhtml">This chapter integrated a number of application programs under the cover of a single RESTful API. </span><span class="koboSpan" id="kobo.654.2" xmlns="http://www.w3.org/1999/xhtml">To build a proper API, there were several important groups of skills:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.655.1" xmlns="http://www.w3.org/1999/xhtml">Creating an OpenAPI specification.</span></p></li>
<li><p><span class="koboSpan" id="kobo.656.1" xmlns="http://www.w3.org/1999/xhtml">Writing a web service application to implement the OpenAPI specification.</span></p></li>
<li><p><span class="koboSpan" id="kobo.657.1" xmlns="http://www.w3.org/1999/xhtml">Using a processing pool to delegate long-running background tasks. </span><span class="koboSpan" id="kobo.657.2" xmlns="http://www.w3.org/1999/xhtml">In this example, we used </span><code><span class="koboSpan" id="kobo.658.1" xmlns="http://www.w3.org/1999/xhtml">concurrent.futures</span></code><span class="koboSpan" id="kobo.659.1" xmlns="http://www.w3.org/1999/xhtml"> to create a future promise of results, and then compute those results.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.660.1" xmlns="http://www.w3.org/1999/xhtml">The number of processes involved can be quite daunting. </span><span class="koboSpan" id="kobo.660.2" xmlns="http://www.w3.org/1999/xhtml">In addition to the web service, there is a processing pool, with a number of sub-processes to do the work of acquiring and cleaning data.</span></p>
<p><span class="koboSpan" id="kobo.661.1" xmlns="http://www.w3.org/1999/xhtml">In many cases, additional tools are built to monitor the API to be sure it’s running properly. </span><span class="koboSpan" id="kobo.661.2" xmlns="http://www.w3.org/1999/xhtml">Further, it’s also common to allocate dedicated servers to this work, and configure </span><code><span class="koboSpan" id="kobo.662.1" xmlns="http://www.w3.org/1999/xhtml">supervisord</span></code><span class="koboSpan" id="kobo.663.1" xmlns="http://www.w3.org/1999/xhtml"> to start the overall service and ensure the service continues to run properly. </span><span id="x1-291001r315"/></p>
</section>
<section class="level2" data-number="16.5" id="extras-10">
<h2 data-number="16.5"><span class="titlemark"><span class="koboSpan" id="kobo.664.1" xmlns="http://www.w3.org/1999/xhtml">12.5 </span></span> <span id="x1-2920005"/><span class="koboSpan" id="kobo.665.1" xmlns="http://www.w3.org/1999/xhtml">Extras</span></h2>
<p><span class="koboSpan" id="kobo.666.1" xmlns="http://www.w3.org/1999/xhtml">Here are some ideas for you to add to these projects. </span><span id="x1-292001r314"/></p>
<section class="level3" data-number="16.5.1" id="add-filtering-criteria-to-the-post-request">
<h3 data-number="16.5.1"><span class="titlemark"><span class="koboSpan" id="kobo.667.1" xmlns="http://www.w3.org/1999/xhtml">12.5.1 </span></span> <span id="x1-2930001"/><span class="koboSpan" id="kobo.668.1" xmlns="http://www.w3.org/1999/xhtml">Add filtering criteria to the POST request</span></h3>
<p><span class="koboSpan" id="kobo.669.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.670.1" xmlns="http://www.w3.org/1999/xhtml">POST </span></strong><span class="koboSpan" id="kobo.671.1" xmlns="http://www.w3.org/1999/xhtml">request that initiates acquire processing is quite complicated. </span><span class="koboSpan" id="kobo.671.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a href="#x1-2830003"><em><span class="koboSpan" id="kobo.672.1" xmlns="http://www.w3.org/1999/xhtml">A</span></em> <em><span class="koboSpan" id="kobo.673.1" xmlns="http://www.w3.org/1999/xhtml">POST request starts processing</span></em></a><span class="koboSpan" id="kobo.674.1" xmlns="http://www.w3.org/1999/xhtml"> to see the processing it does.</span></p>
<p><span class="koboSpan" id="kobo.675.1" xmlns="http://www.w3.org/1999/xhtml">We might name the function for this route </span><code><span class="koboSpan" id="kobo.676.1" xmlns="http://www.w3.org/1999/xhtml">creation_job_post()</span></code><span class="koboSpan" id="kobo.677.1" xmlns="http://www.w3.org/1999/xhtml"> to make it clear that this creates jobs to acquire data in response to an HTTP POST request.</span></p>
<p><span class="koboSpan" id="kobo.678.1" xmlns="http://www.w3.org/1999/xhtml">The list of tasks in this function includes the following:</span></p>
<ol>
<li><div id="x1-293002x1">
<p><span class="koboSpan" id="kobo.679.1" xmlns="http://www.w3.org/1999/xhtml">Check the user’s permissions.</span></p>
</div></li>
<li><div id="x1-293004x2">
<p><span class="koboSpan" id="kobo.680.1" xmlns="http://www.w3.org/1999/xhtml">Validate the parameters.</span></p>
</div></li>
<li><div id="x1-293006x3">
<p><span class="koboSpan" id="kobo.681.1" xmlns="http://www.w3.org/1999/xhtml">Build an </span><code><span class="koboSpan" id="kobo.682.1" xmlns="http://www.w3.org/1999/xhtml">AcquireJob</span></code><span class="koboSpan" id="kobo.683.1" xmlns="http://www.w3.org/1999/xhtml"> instance with the parameters.</span></p>
</div></li>
<li><div id="x1-293008x4">
<p><span class="koboSpan" id="kobo.684.1" xmlns="http://www.w3.org/1999/xhtml">Update the </span><code><span class="koboSpan" id="kobo.685.1" xmlns="http://www.w3.org/1999/xhtml">AcquireJob</span></code><span class="koboSpan" id="kobo.686.1" xmlns="http://www.w3.org/1999/xhtml"> instance with the </span><code><span class="koboSpan" id="kobo.687.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.688.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.688.2" xmlns="http://www.w3.org/1999/xhtml">The future will evaluate the </span><code><span class="koboSpan" id="kobo.689.1" xmlns="http://www.w3.org/1999/xhtml">acquire_series()</span></code><span class="koboSpan" id="kobo.690.1" xmlns="http://www.w3.org/1999/xhtml"> function that does the work of acquiring and cleaning the data.</span></p>
</div></li>
<li><div id="x1-293010x5">
<p><span class="koboSpan" id="kobo.691.1" xmlns="http://www.w3.org/1999/xhtml">Return a JSON object with details of the submitted job, as well as headers and a status code to redirect to a request to get the job’s status.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.692.1" xmlns="http://www.w3.org/1999/xhtml">Some RESTful APIs will have even more complicated parameters. </span><span class="koboSpan" id="kobo.692.2" xmlns="http://www.w3.org/1999/xhtml">For example, users may want to filter the data to create a subset before downloading. </span><span class="koboSpan" id="kobo.692.3" xmlns="http://www.w3.org/1999/xhtml">This improves the UX by providing only the required data. </span><span class="koboSpan" id="kobo.692.4" xmlns="http://www.w3.org/1999/xhtml">It also allows analysts to share subsets of data without having to share the filtering code within the analyst community.</span></p>
<p><span class="koboSpan" id="kobo.693.1" xmlns="http://www.w3.org/1999/xhtml">It can also improve the UX by performing filtering on larger, powerful servers. </span><span class="koboSpan" id="kobo.693.2" xmlns="http://www.w3.org/1999/xhtml">It can prevent having to download and filter data on a local laptop.</span></p>
<p><span class="koboSpan" id="kobo.694.1" xmlns="http://www.w3.org/1999/xhtml">This is emphatically </span><strong><span class="koboSpan" id="kobo.695.1" xmlns="http://www.w3.org/1999/xhtml">not </span></strong><span class="koboSpan" id="kobo.696.1" xmlns="http://www.w3.org/1999/xhtml">a feature of the RESTful API. </span><span class="koboSpan" id="kobo.696.2" xmlns="http://www.w3.org/1999/xhtml">This must </span><strong><span class="koboSpan" id="kobo.697.1" xmlns="http://www.w3.org/1999/xhtml">first </span></strong><span class="koboSpan" id="kobo.698.1" xmlns="http://www.w3.org/1999/xhtml">be built as a feature of an application that reads and filters the clean data. </span><span class="koboSpan" id="kobo.698.2" xmlns="http://www.w3.org/1999/xhtml">This new application will create a new dataset, ready for download. </span><span class="koboSpan" id="kobo.698.3" xmlns="http://www.w3.org/1999/xhtml">The data set name might be a UUID, and an associated metadata file would contain the filter parameters.</span></p>
<p><span class="koboSpan" id="kobo.699.1" xmlns="http://www.w3.org/1999/xhtml">The implementation requires the </span><code><span class="koboSpan" id="kobo.700.1" xmlns="http://www.w3.org/1999/xhtml">creation_job_post()</span></code><span class="koboSpan" id="kobo.701.1" xmlns="http://www.w3.org/1999/xhtml"> function to now also validate the filter criteria. </span><span class="koboSpan" id="kobo.701.2" xmlns="http://www.w3.org/1999/xhtml">It must include the filter criteria in the </span><code><span class="koboSpan" id="kobo.702.1" xmlns="http://www.w3.org/1999/xhtml">AcquireJob</span></code><span class="koboSpan" id="kobo.703.1" xmlns="http://www.w3.org/1999/xhtml"> instance that is built, and provide the filter criteria to the underlying </span><code><span class="koboSpan" id="kobo.704.1" xmlns="http://www.w3.org/1999/xhtml">acquire_series()</span></code><span class="koboSpan" id="kobo.705.1" xmlns="http://www.w3.org/1999/xhtml"> function.</span></p>
<p><span class="koboSpan" id="kobo.706.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.707.1" xmlns="http://www.w3.org/1999/xhtml">acquire_series()</span></code><span class="koboSpan" id="kobo.708.1" xmlns="http://www.w3.org/1999/xhtml"> function will have the most dramatic changes. </span><span class="koboSpan" id="kobo.708.2" xmlns="http://www.w3.org/1999/xhtml">It will run the acquire, clean, and filter applications as subprocesses. </span><span class="koboSpan" id="kobo.708.3" xmlns="http://www.w3.org/1999/xhtml">You may want to consider an integrated application that runs the other applications, simplifying the RESTful API.</span></p>
<p><span class="koboSpan" id="kobo.709.1" xmlns="http://www.w3.org/1999/xhtml">This will, of course, lead to considerably more complicated acceptance test cases to be sure the data acquisition works with — and without — these additional filter criteria. </span><span id="x1-293011r317"/></p>
<section class="level4 subsectionHead" data-number="16.5.1.1" id="split-the-openapi-specification-into-two-parts-to-use-ref-for-the-output-schema">
<h4 class="subsectionHead" data-number="16.5.1.1"><span class="titlemark"><span class="koboSpan" id="kobo.710.1" xmlns="http://www.w3.org/1999/xhtml">12.5.2 </span></span> <span id="x1-2940002"/><span class="koboSpan" id="kobo.711.1" xmlns="http://www.w3.org/1999/xhtml">Split the OpenAPI specification into two parts to use </span><span class="tcrm-1095"><span class="koboSpan" id="kobo.712.1" xmlns="http://www.w3.org/1999/xhtml">$</span></span><span class="koboSpan" id="kobo.713.1" xmlns="http://www.w3.org/1999/xhtml">REF for the output schema</span></h4>
<p><span class="koboSpan" id="kobo.714.1" xmlns="http://www.w3.org/1999/xhtml">The OpenAPI specification includes a number of schema. </span><span class="koboSpan" id="kobo.714.2" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="#x1-2810001"><em><span class="koboSpan" id="kobo.715.1" xmlns="http://www.w3.org/1999/xhtml">OpenAPI 3</span></em> <em><span class="koboSpan" id="kobo.716.1" xmlns="http://www.w3.org/1999/xhtml">specification</span></em></a><span class="koboSpan" id="kobo.717.1" xmlns="http://www.w3.org/1999/xhtml">, we showed a few key features of this specification.</span></p>
<p><span class="koboSpan" id="kobo.718.1" xmlns="http://www.w3.org/1999/xhtml">It’s not too difficult for an analyst to download the entire specification, and then locate the </span><code><span class="koboSpan" id="kobo.719.1" xmlns="http://www.w3.org/1999/xhtml">components.schemas.seriesList</span></code><span class="koboSpan" id="kobo.720.1" xmlns="http://www.w3.org/1999/xhtml"> schema. </span><span class="koboSpan" id="kobo.720.2" xmlns="http://www.w3.org/1999/xhtml">This navigation through a JSON document doesn’t involve too many challenges.</span></p>
<p><span class="koboSpan" id="kobo.721.1" xmlns="http://www.w3.org/1999/xhtml">While this is not burdensome, some users might object. </span><span class="koboSpan" id="kobo.721.2" xmlns="http://www.w3.org/1999/xhtml">An analyst focused on a business problem should not be asked to also sort out the structure of the OpenAPI specification. </span><span class="koboSpan" id="kobo.721.3" xmlns="http://www.w3.org/1999/xhtml">An alternative is to decompose the specification into pieces and serve the pieces separately.</span></p>
<p><span class="koboSpan" id="kobo.722.1" xmlns="http://www.w3.org/1999/xhtml">Specifically, the places where </span><code><span class="koboSpan" id="kobo.723.1" xmlns="http://www.w3.org/1999/xhtml">"$ref"</span></code><span class="koboSpan" id="kobo.724.1" xmlns="http://www.w3.org/1999/xhtml"> references appear generally use a path of the form </span><code><span class="koboSpan" id="kobo.725.1" xmlns="http://www.w3.org/1999/xhtml">#/components/schemas/...</span></code><span class="koboSpan" id="kobo.726.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.726.2" xmlns="http://www.w3.org/1999/xhtml">The path is a local URL, omitting the hostname information. </span><span class="koboSpan" id="kobo.726.3" xmlns="http://www.w3.org/1999/xhtml">This can be replaced with a full URL that refers to schema details on the RESTful API server.</span></p>
<p><span class="koboSpan" id="kobo.727.1" xmlns="http://www.w3.org/1999/xhtml">We might use </span><code><span class="koboSpan" id="kobo.728.1" xmlns="http://www.w3.org/1999/xhtml">http://localhost:8080/api/schemas/...</span></code><span class="koboSpan" id="kobo.729.1" xmlns="http://www.w3.org/1999/xhtml"> to refer to the various schema files stored as separate JSON documents. </span><span class="koboSpan" id="kobo.729.2" xmlns="http://www.w3.org/1999/xhtml">Each individual schema definition would have a distinct URI, permitting ready access to only the relevant schema, and ignoring other aspects of the OpenAPI specification.</span></p>
<p><span class="koboSpan" id="kobo.730.1" xmlns="http://www.w3.org/1999/xhtml">This decomposes the OpenAPI specification into the overall specification for the service and separate specifications for a schema that describes downloadable datasets. </span><span class="koboSpan" id="kobo.730.2" xmlns="http://www.w3.org/1999/xhtml">It also requires adding a path to the RESTful API service to properly download the schema in addition to downloading the overall OpenAPI specification.</span></p>
<p><span class="koboSpan" id="kobo.731.1" xmlns="http://www.w3.org/1999/xhtml">This leads to a few extra acceptance test cases to extract the schema as well as the overall OpenAPI specification. </span><span id="x1-294001r318"/></p>
</section>
</section>
<section class="level3" data-number="16.5.2" id="use-celery-instead-of-concurrent.futures">
<h3 data-number="16.5.2"><span class="titlemark"><span class="koboSpan" id="kobo.732.1" xmlns="http://www.w3.org/1999/xhtml">12.5.3 </span></span> <span id="x1-2950003"/><span class="koboSpan" id="kobo.733.1" xmlns="http://www.w3.org/1999/xhtml">Use Celery instead of concurrent.futures</span></h3>
<p><span class="koboSpan" id="kobo.734.1" xmlns="http://www.w3.org/1999/xhtml">The suggestion in </span><a href="#x1-2800002"><em><span class="koboSpan" id="kobo.735.1" xmlns="http://www.w3.org/1999/xhtml">Overall approach</span></em></a><span class="koboSpan" id="kobo.736.1" xmlns="http://www.w3.org/1999/xhtml"> is to use the </span><code><span class="koboSpan" id="kobo.737.1" xmlns="http://www.w3.org/1999/xhtml">concurrent.futures</span></code><span class="koboSpan" id="kobo.738.1" xmlns="http://www.w3.org/1999/xhtml"> module to handle the long-running data acquisition and cleaning processes. </span><span class="koboSpan" id="kobo.738.2" xmlns="http://www.w3.org/1999/xhtml">The API requests that initiate processing create a </span><code><span class="koboSpan" id="kobo.739.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.740.1" xmlns="http://www.w3.org/1999/xhtml"> object that reflects the state of a separate subprocess doing the actual work. </span><span class="koboSpan" id="kobo.740.2" xmlns="http://www.w3.org/1999/xhtml">The RESTful API is free to respond to additional requests while the work is being completed.</span></p>
<p><span class="koboSpan" id="kobo.741.1" xmlns="http://www.w3.org/1999/xhtml">Another popular package for implementing this kind of background processing is </span><code><span class="koboSpan" id="kobo.742.1" xmlns="http://www.w3.org/1999/xhtml">celery</span></code><span class="koboSpan" id="kobo.743.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.743.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://docs.celeryq.dev/en/stable/getting-started/introduction.html"><span class="koboSpan" id="kobo.744.1" xmlns="http://www.w3.org/1999/xhtml">https://docs.celeryq.dev/en/stable/getting-started/introduction.html</span></a><span class="koboSpan" id="kobo.745.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.746.1" xmlns="http://www.w3.org/1999/xhtml">This is a bit more complicated than using the </span><code><span class="koboSpan" id="kobo.747.1" xmlns="http://www.w3.org/1999/xhtml">concurrent.futures</span></code><span class="koboSpan" id="kobo.748.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.748.2" xmlns="http://www.w3.org/1999/xhtml">It also scales elegantly to allow a large number of separate computers to comprise the pool of available workers. </span><span class="koboSpan" id="kobo.748.3" xmlns="http://www.w3.org/1999/xhtml">This can permit very large processing loads to be controlled by a relatively small RESTful API application.</span></p>
<p><span class="koboSpan" id="kobo.749.1" xmlns="http://www.w3.org/1999/xhtml">Using Celery requires creating tasks, using the </span><code><span class="koboSpan" id="kobo.750.1" xmlns="http://www.w3.org/1999/xhtml">@task</span></code><span class="koboSpan" id="kobo.751.1" xmlns="http://www.w3.org/1999/xhtml"> decorator. </span><span class="koboSpan" id="kobo.751.2" xmlns="http://www.w3.org/1999/xhtml">It also requires starting the worker pool separately. </span><span class="koboSpan" id="kobo.751.3" xmlns="http://www.w3.org/1999/xhtml">This means the overall RESTful API now has two steps to get started:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.752.1" xmlns="http://www.w3.org/1999/xhtml">The celery worker pool must be running.</span></p></li>
<li><p><span class="koboSpan" id="kobo.753.1" xmlns="http://www.w3.org/1999/xhtml">The RESTful API can then start. </span><span class="koboSpan" id="kobo.753.2" xmlns="http://www.w3.org/1999/xhtml">Once it’s running, it can delegate work to workers in the pool.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.754.1" xmlns="http://www.w3.org/1999/xhtml">For very large workloads, where the worker pool is spread across multiple computers, use of Celery’s sophisticated management tools are required to be sure the pools are starting and stopping appropriately.</span></p>
<p><span class="koboSpan" id="kobo.755.1" xmlns="http://www.w3.org/1999/xhtml">The core work of submitting work to the worker pool changes from </span><code><span class="koboSpan" id="kobo.756.1" xmlns="http://www.w3.org/1999/xhtml">pool.submit()</span></code><span class="koboSpan" id="kobo.757.1" xmlns="http://www.w3.org/1999/xhtml"> to </span><code><span class="koboSpan" id="kobo.758.1" xmlns="http://www.w3.org/1999/xhtml">celery_app.delay()</span></code><span class="koboSpan" id="kobo.759.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.759.2" xmlns="http://www.w3.org/1999/xhtml">This is a small programming change that permits using a more sophisticated and scalable worker pool.</span></p>
<p><span class="koboSpan" id="kobo.760.1" xmlns="http://www.w3.org/1999/xhtml">There aren’t any acceptance test changes for this. </span><span class="koboSpan" id="kobo.760.2" xmlns="http://www.w3.org/1999/xhtml">The features are identical.</span></p>
<p><span class="koboSpan" id="kobo.761.1" xmlns="http://www.w3.org/1999/xhtml">The fixture definition required to start the RESTful API will be more complicated: it will have to start the </span><strong><span class="koboSpan" id="kobo.762.1" xmlns="http://www.w3.org/1999/xhtml">Celery </span></strong><span class="koboSpan" id="kobo.763.1" xmlns="http://www.w3.org/1999/xhtml">pool of workers before starting the RESTful API. </span><span class="koboSpan" id="kobo.763.2" xmlns="http://www.w3.org/1999/xhtml">It will also need to shut down both services. </span><span id="x1-295001r319"/></p>
</section>
<section class="level3" data-number="16.5.3" id="call-external-processing-directly-instead-of-running-a-subprocess">
<h3 data-number="16.5.3"><span class="titlemark"><span class="koboSpan" id="kobo.764.1" xmlns="http://www.w3.org/1999/xhtml">12.5.4 </span></span> <span id="x1-2960004"/><span class="koboSpan" id="kobo.765.1" xmlns="http://www.w3.org/1999/xhtml">Call external processing directly instead of running a subprocess</span></h3>
<p><span class="koboSpan" id="kobo.766.1" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="#x1-2800002"><em><span class="koboSpan" id="kobo.767.1" xmlns="http://www.w3.org/1999/xhtml">Overall approach</span></em></a><span class="koboSpan" id="kobo.768.1" xmlns="http://www.w3.org/1999/xhtml">, we suggested the work should be done by an </span><code><span class="koboSpan" id="kobo.769.1" xmlns="http://www.w3.org/1999/xhtml">acquire_series()</span></code><span class="koboSpan" id="kobo.770.1" xmlns="http://www.w3.org/1999/xhtml"> function. </span><span class="koboSpan" id="kobo.770.2" xmlns="http://www.w3.org/1999/xhtml">This function would be evaluated by the </span><code><span class="koboSpan" id="kobo.771.1" xmlns="http://www.w3.org/1999/xhtml">POOL.submit()</span></code><span class="koboSpan" id="kobo.772.1" xmlns="http://www.w3.org/1999/xhtml"> function. </span><span id="dx1-296001"/><span class="koboSpan" id="kobo.773.1" xmlns="http://www.w3.org/1999/xhtml">This would delegate the work to a worker, and return a </span><code><span class="koboSpan" id="kobo.774.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.775.1" xmlns="http://www.w3.org/1999/xhtml"> object to track the state of completion.</span></p>
<p><span class="koboSpan" id="kobo.776.1" xmlns="http://www.w3.org/1999/xhtml">In that section, we suggested the </span><code><span class="koboSpan" id="kobo.777.1" xmlns="http://www.w3.org/1999/xhtml">acquire_series()</span></code><span class="koboSpan" id="kobo.778.1" xmlns="http://www.w3.org/1999/xhtml"> function could use </span><code><span class="koboSpan" id="kobo.779.1" xmlns="http://www.w3.org/1999/xhtml">subprocess.run()</span></code><span class="koboSpan" id="kobo.780.1" xmlns="http://www.w3.org/1999/xhtml"> to execute the various components of the processing pipeline. </span><span class="koboSpan" id="kobo.780.2" xmlns="http://www.w3.org/1999/xhtml">It could run the </span><code><span class="koboSpan" id="kobo.781.1" xmlns="http://www.w3.org/1999/xhtml">src/acquire.py</span></code><span class="koboSpan" id="kobo.782.1" xmlns="http://www.w3.org/1999/xhtml"> application, and then run the </span><code><span class="koboSpan" id="kobo.783.1" xmlns="http://www.w3.org/1999/xhtml">src/clean.py</span></code><span class="koboSpan" id="kobo.784.1" xmlns="http://www.w3.org/1999/xhtml"> application, using the </span><code><span class="koboSpan" id="kobo.785.1" xmlns="http://www.w3.org/1999/xhtml">subprocess</span></code><span class="koboSpan" id="kobo.786.1" xmlns="http://www.w3.org/1999/xhtml"> module.</span></p>
<p><span class="koboSpan" id="kobo.787.1" xmlns="http://www.w3.org/1999/xhtml">This isn’t the only way it could work. </span><span class="koboSpan" id="kobo.787.2" xmlns="http://www.w3.org/1999/xhtml">The alternative is to import these application modules, and evaluate their </span><code><span class="koboSpan" id="kobo.788.1" xmlns="http://www.w3.org/1999/xhtml">main()</span></code><span class="koboSpan" id="kobo.789.1" xmlns="http://www.w3.org/1999/xhtml"> functions directly.</span></p>
<p><span class="koboSpan" id="kobo.790.1" xmlns="http://www.w3.org/1999/xhtml">This means replacing the </span><code><span class="koboSpan" id="kobo.791.1" xmlns="http://www.w3.org/1999/xhtml">subprocess.run()</span></code><span class="koboSpan" id="kobo.792.1" xmlns="http://www.w3.org/1999/xhtml"> function with the </span><code><span class="koboSpan" id="kobo.793.1" xmlns="http://www.w3.org/1999/xhtml">acquire.main()</span></code><span class="koboSpan" id="kobo.794.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.795.1" xmlns="http://www.w3.org/1999/xhtml">clean.main()</span></code><span class="koboSpan" id="kobo.796.1" xmlns="http://www.w3.org/1999/xhtml"> functions. </span><span class="koboSpan" id="kobo.796.2" xmlns="http://www.w3.org/1999/xhtml">This avoids a tiny overhead in Linux. </span><span class="koboSpan" id="kobo.796.3" xmlns="http://www.w3.org/1999/xhtml">It can be a conceptual simplification to see how the </span><code><span class="koboSpan" id="kobo.797.1" xmlns="http://www.w3.org/1999/xhtml">acquire_series()</span></code><span class="koboSpan" id="kobo.798.1" xmlns="http://www.w3.org/1999/xhtml"> function creates the data using other Python modules.</span></p>
<p><span class="koboSpan" id="kobo.799.1" xmlns="http://www.w3.org/1999/xhtml">This involves no changes to the acceptance test cases. </span><span class="koboSpan" id="kobo.799.2" xmlns="http://www.w3.org/1999/xhtml">It does involve some changes to the unit test cases. </span><span class="koboSpan" id="kobo.799.3" xmlns="http://www.w3.org/1999/xhtml">When using </span><code><span class="koboSpan" id="kobo.800.1" xmlns="http://www.w3.org/1999/xhtml">subprocess.run()</span></code><span class="koboSpan" id="kobo.801.1" xmlns="http://www.w3.org/1999/xhtml">, the unit test must monkey-patch the </span><code><span class="koboSpan" id="kobo.802.1" xmlns="http://www.w3.org/1999/xhtml">subprocess</span></code><span class="koboSpan" id="kobo.803.1" xmlns="http://www.w3.org/1999/xhtml"> module with a mock that captures the argument values and returns a useful result. </span><span class="koboSpan" id="kobo.803.2" xmlns="http://www.w3.org/1999/xhtml">When replacing this processing with the </span><code><span class="koboSpan" id="kobo.804.1" xmlns="http://www.w3.org/1999/xhtml">acquire.main()</span></code><span class="koboSpan" id="kobo.805.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.806.1" xmlns="http://www.w3.org/1999/xhtml">clean.main()</span></code><span class="koboSpan" id="kobo.807.1" xmlns="http://www.w3.org/1999/xhtml"> functions, these two modules must be monkey patched with mocks that capture the argument values and return useful results. </span><span id="x1-296002r299"/></p>
</section>
</section>
</section>
</body>
</html>
