<html><head></head><body>
        

                            
                    <h1 class="header-title" id="calibre_pb_0">Deploying Serverless APIs</h1>
                
            
            
                
<p class="calibre2">So far, we have come a long way in our journey of learning about serverless applications and building serverless engineering. We have learned what the serverless paradigm actually is, how the AWS Lambda function works, understanding the internals of AWS Lambda, along with a detailed understanding of how several triggers work. We have also done several mini projects around experimenting with triggers and deploying them as end-to-end serverless pipelines.</p>
<p class="calibre2">In this chapter, you will be learning how to build efficient and scalable serverless APIs, using the AWS Lambda and AWS API Gateway services. We will start with understanding how the API Gateway works, instead of diving directly to building the serverless API. After that, we will understand how API Gateway and AWS Lambda integrate with each other. And finally, we will be creating and deploying a fully functional serverless API, as part of your learning from this chapter.</p>
<p class="calibre2">This chapter covers the following topics:</p>
<ul class="calibre9">
<li class="calibre10">API methods and resources</li>
<li class="calibre10">Setting up integration</li>
<li class="calibre10">Deploying the Lambda function for API execution</li>
<li class="calibre10">Handling authentication and user controls</li>
</ul>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">API methods and resources</h1>
                
            
            
                
<p class="calibre2">In this section, we will be learning about the API service of AWS, which is the API Gateway, and understanding the components and settings available in the console for the user who is creating APIs. We will go through all of the components and understand the API Gateway better. The steps to create the serverless APIs are as follows:</p>
<ol class="calibre13">
<li value="1" class="calibre10">We will start by opening the API Gateway console, which looks like this:</li>
</ol>
<div><img src="img/00096.jpeg" class="calibre94"/></div>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">In the API Gateway console, click on the Get Started button to start creating an API. It will take you to an API creation wizard with a popup saying Create Example API:</li>
</ol>
<div><img src="img/00097.jpeg" class="calibre94"/></div>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">Once you click on the OK button, you will be redirected to a page where the Example API is shown, from which you can get an idea of what an API response looks like:</li>
</ol>
<div><img src="img/00098.jpeg" class="calibre95"/></div>
<p class="calibre34">The API we are building in this example is for a pet store and for maintaining the pets inside the store. By going through the API, you will see what the bits and pieces of an API looks like. The API looks like this:</p>
<div><img src="img/00099.jpeg" class="calibre96"/></div>
<ol start="4" class="calibre13">
<li value="4" class="calibre10">Once you click on the Import button at the end, you will be redirected to the PetStore (b7exp0d681) API page that we have just created. The API page with all the components looks like this: </li>
</ol>
<div><img src="img/00100.jpeg" class="calibre97"/></div>
<ol start="5" class="calibre13">
<li value="5" class="calibre10">The resources in this API are the GET and POST resources, where you can add pets and view the pets, which are available as a list. The list of resources from the API we have created is as follows:</li>
</ol>
<div><img src="img/00101.jpeg" class="calibre98"/></div>
<ol start="6" class="calibre13">
<li value="6" class="calibre10">By clicking on the first GET resource, we can see a detailed execution flow from the client to the endpoint and back to the client. The execution flow of the resource looks like this:</li>
</ol>
<div><img src="img/00102.jpeg" class="calibre94"/></div>
<ol start="7" class="calibre13">
<li value="7" class="calibre10">Now, if we click on the POST resource, we will find a similar model execution flow for the POST resource. It looks very similar to that of the GET resource, however, here the API endpoint is mentioned as a URL, as we are trying to retrieve the result from it. The execution model looks as follows:</li>
</ol>
<p class="cdpaligncenter5"><img src="img/00103.jpeg" class="calibre99"/></p>
<p class="calibre34">In the API Gateway, there is something called Stages, which can be used as versioning models for an API. Some common names for Stages in practice are <strong class="calibre4">test</strong>, <strong class="calibre4">development</strong>, and <strong class="calibre4">production</strong>. The Stages menu looks like this:</p>
<div><img src="img/00104.jpeg" class="calibre48"/></div>
<ol start="7" class="calibre13">
<li value="7" class="calibre10">When you click on the Create option, it will open a creation wizard for the stage. This looks as follows:</li>
</ol>
<div><img src="img/00105.jpeg" class="calibre94"/></div>
<ol start="8" class="calibre13">
<li value="8" class="calibre10">You can select any name for the Stage name value, and add the Stage description value according to the name you have assigned and the purpose you have in mind for this stage. Before that, you need to deploy the API that you have created. This can be selected in the Actions drop-down menu as the Deploy API button, as follows:</li>
</ol>
<p class="cdpaligncenter5"><img src="img/00106.jpeg" class="calibre100"/></p>
<ol start="9" class="calibre13">
<li value="9" class="calibre10">In the next menu, you can choose the Stage name and other details, before finally clicking on the Deploy button, which will deploy your API with that particular stage. This can be seen as follows:</li>
</ol>
<div><img src="img/00107.jpeg" class="calibre101"/></div>
<p class="calibre34">The deployed stage would look as follows:</p>
<div><img src="img/00108.jpeg" class="calibre48"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Setting up integration</h1>
                
            
            
                
<p class="calibre2">As we now understand how the AWS API Gateway service works at a basic level, we will move on to use that knowledge for building an end-to-end project which involves deploying a completely serverless API.</p>
<p class="calibre2">In this section, we will be building and deploying a completely serverless API function from scratch, along with learning the internals and other implementation details of the AWS Lambda—AWS API Gateway integrations. We will be building the serverless API step-by-step. So, follow along with the steps in this order. The procedure is as follows:</p>
<ol class="calibre13">
<li value="1" class="calibre10">Firstly, we will start by creating a new API. This can be done via the Lambda console which looks like this:</li>
</ol>
<div><img src="img/00109.jpeg" class="calibre102"/></div>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">Once you have clicked on the +Create API button, you will be redirected to the API creation wizard, where you will be asked to enter the name and description of the API you are intending to build. For now, I have entered the name as <kbd class="calibre12">TestLambdaAPI</kbd>. However, you are free to add whatever name and description you would like to enter. The API creation console looks like this:</li>
</ol>
<div><img src="img/00110.jpeg" class="calibre94"/></div>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">Once you click on the Create API button, you will be redirected to the page of the API you have created. The API page would look similar to this:</li>
</ol>
<div><img src="img/00111.jpeg" class="calibre103"/></div>
<ol start="4" class="calibre13">
<li value="4" class="calibre10">Now that we have successfully created an API, we will now go ahead and create resources in the API. You can do that by clicking on the Create Resource option in the Actions drop-down menu:</li>
</ol>
<div><img src="img/00112.jpeg" class="calibre104"/></div>
<ol start="5" class="calibre13">
<li value="5" class="calibre10">This would open up a resource creation wizard where you can add the name and resource path of the API resource which we are intending to build. After creating the resource, click on the Create Resource button for your settings for the API resource to be created accordingly. For the sake of this tutorial, I have named it <kbd class="calibre12">LambdaAPI</kbd>. However, you can give it any name you want. The API creation wizard looks like this:</li>
</ol>
<div><img src="img/00113.jpeg" class="calibre48"/></div>
<p class="calibre34">The resource that you have just created is now live in the API console; you can see it under the Resources section:</p>
<div><img src="img/00114.jpeg" class="calibre105"/></div>
<ol start="6" class="calibre13">
<li value="6" class="calibre10">You can create versions of a resource or even just a resource under a resource. Let's go ahead and create one. For this, you need to click on the resource that you have already created. Then, click on the Create Resource option in the drop-down menu in the Actions menu:</li>
</ol>
<div><img src="img/00115.jpeg" class="calibre106"/></div>
<ol start="7" class="calibre13">
<li value="7" class="calibre10">This would open up a similar resource creation wizard under the resource which we have already created. You can name that resource as <kbd class="calibre12">version1</kbd> or just as <kbd class="calibre12">v1</kbd> which is a regular software practice. I have named it <kbd class="calibre12">v1</kbd>. However, you can name it whatever you want to:</li>
</ol>
<div><img src="img/00116.jpeg" class="calibre48"/></div>
<p class="calibre34">Now, we have a resource named <kbd class="calibre12">v1</kbd> under the already existing resource, <kbd class="calibre12">/lambdaapi</kbd>. We can see this under our Resources section. So, now the resources hierarchy of our API looks like this:</p>
<div><img src="img/00117.jpeg" class="calibre107"/></div>
<ol start="8" class="calibre13">
<li value="8" class="calibre10">We will be creating a serverless API for getting and querying the list of pets in a pet store. So, the following steps will be aligned accordingly. The API should return the name of the pets. So, we will have a new resource for pets for that purpose. We will be creating a resource for this under the <kbd class="calibre12">/v1</kbd> resource: </li>
</ol>
<div><img src="img/00118.jpeg" class="calibre94"/></div>
<ol start="9" class="calibre13">
<li value="9" class="calibre10">The resulting hierarchical structure for our API looks like this, after adding the <kbd class="calibre12">/pets</kbd> resource under the <kbd class="calibre12">/v1</kbd> resource:</li>
</ol>
<div><img src="img/00119.jpeg" class="calibre108"/></div>
<ol start="10" class="calibre13">
<li value="10" class="calibre10">Now, we will add a custom resource which enables us to query the API. By custom, we mean that any string can be added to the resource when sending a request to this API, and the API would send back a request after checking and querying for that string via a Lambda code. The custom resources can be differentiated from the normal ones, as they can be created with curly braces. The following screenshot will help you understand how to create them:</li>
</ol>
<div><img src="img/00120.jpeg" class="calibre94"/></div>
<ol start="11" class="calibre13">
<li value="11" class="calibre10">After clicking on the Create Resource button, the new custom child resource for <kbd class="calibre12">/pets</kbd> will be created. The hierarchy of the resources is now as follows:</li>
</ol>
<div><img src="img/00121.jpeg" class="calibre109"/></div>
<ol start="12" class="calibre13">
<li value="12" class="calibre10">The overall structure of the API looks like this, as specified in the top-right part of the following screenshot:</li>
</ol>
<div><img src="img/00122.jpeg" class="calibre110"/></div>
<ol start="13" class="calibre13">
<li value="13" class="calibre10">Now, we will add methods to this custom resource. As we will only be querying the list of pets, we will only add the GET method. This can be done by clicking on the {type} resource and clicking on Create Method in the drop-down Actions menu in the top panel:</li>
</ol>
<div><img src="img/00123.jpeg" class="calibre111"/></div>
<ol start="14" class="calibre13">
<li value="14" class="calibre10">This would create a small drop-down style menu under the {type} resource where you can select a method from the available methods:</li>
</ol>
<div><img src="img/00124.jpeg" class="calibre112"/></div>
<ol start="15" class="calibre13">
<li value="15" class="calibre10">We need to select the GET option from the available options. This would look as follows:</li>
</ol>
<div><img src="img/00125.jpeg" class="calibre113"/></div>
<ol start="16" class="calibre13">
<li value="16" class="calibre10">After selecting the GET option and clicking on the small tick button beside it, we will have created the GET method under our {type} resource. The hierarchy now looks like this:</li>
</ol>
<div><img src="img/00126.jpeg" class="calibre114"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Deploying the Lambda function for API execution</h1>
                
            
            
                
<p class="calibre2">In this section, we will have a look at the steps to deploy the Lambda function:</p>
<ol class="calibre13">
<li value="1" class="calibre10">The details of the GET method can also be seen on the right-hand side of the API console, when you click on that method. The details look as follows:</li>
</ol>
<div><img src="img/00127.jpeg" class="calibre94"/></div>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">In the GET method console, click on the Lambda Function option. Select any one region depending on your preference. I have chosen us-east-1 as the region as shown in the following screenshot:</li>
</ol>
<div><img src="img/00128.jpeg" class="calibre48"/></div>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">As expected, it says we do not have a Lambda function in that region. So, we need to go ahead and create one. Click on the Create a Lambda Function link. This will take you to the Lambda creation console which we are already comfortable with:</li>
</ol>
<div><img src="img/00129.jpeg" class="calibre48"/></div>
<ol start="4" class="calibre13">
<li value="4" class="calibre10">From here, choose the keyword : hello-world-python blueprint from the list of blueprints:</li>
</ol>
<div><img src="img/00130.jpeg" class="calibre94"/></div>
<ol start="5" class="calibre13">
<li value="5" class="calibre10">In the next console, choose the basic information for the Lambda function as we have done in the previous chapters:</li>
</ol>
<div><img src="img/00131.jpeg" class="calibre115"/></div>
<ol start="6" class="calibre13">
<li value="6" class="calibre10">After adding the relevant details, click on the orange Create function button. That will take you to the page of the Lambda function you have just created. The code can be edited from there onwards:</li>
</ol>
<div><img src="img/00132.jpeg" class="calibre116"/></div>
<ol start="7" class="calibre13">
<li value="7" class="calibre10">In the function's code, use this code instead of the one which is provided along with the blueprint:</li>
</ol>
<div><img src="img/00133.jpeg" class="calibre117"/></div>
<ol start="8" class="calibre13">
<li value="8" class="calibre10">We are now done with tweaking the function code. Now, you can go ahead and save the function:</li>
</ol>
<div><img src="img/00134.jpeg" class="calibre94"/></div>
<ol start="9" class="calibre13">
<li value="9" class="calibre10">Now, head back to the API Gateway console to the GET method page. Here, under the Lambda functions in the us-east-1 region, I start getting the Lambda function which I have just created (serverless-api) as an option:</li>
</ol>
<div><img src="img/00135.jpeg" class="calibre118"/></div>
<ol start="10" class="calibre13">
<li value="10" class="calibre10">On clicking Save, you will see a popup asking you to confirm that you are giving API Gateway permission to invoke your Lambda function, you can acknowledge it by clicking on OK:</li>
</ol>
<div><img src="img/00136.jpeg" class="calibre119"/></div>
<ol start="11" class="calibre13">
<li value="11" class="calibre10">After clicking on OK, you will be redirected to the data flow page of the GET method, that looks like this:</li>
</ol>
<div><img src="img/00137.jpeg" class="calibre120"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Handling authentication and user controls</h1>
                
            
            
                
<p class="calibre2">After deploying, next we will discuss how to handle the authentication and user controls. The steps are as follows:</p>
<ol class="calibre13">
<li value="1" class="calibre10">Now that we have successfully created the skeleton of our serverless API, we will now work on the nitty-gritty details which are needed to make it a fully functional API. We will start with applying the mapping templates. This can be done in the Integration Request menu. Clicking on the Integration Request link will take you to a console which looks like this:</li>
</ol>
<div><img src="img/00138.jpeg" class="calibre121"/></div>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">If you scroll down a bit in the same console, you will notice the Body Mapping Templates section at the end:</li>
</ol>
<div><img src="img/00139.jpeg" class="calibre122"/></div>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">Clicking on the Body Mapping Templates will unfurl the options available in that particular section:</li>
</ol>
<div><img src="img/00140.jpeg" class="calibre123"/></div>
<ol start="4" class="calibre13">
<li value="4" class="calibre10">Select the second option which says When there are no templates defined (recommended). And then, click on the Add mapping template option and add <kbd class="calibre12">application/json</kbd>, and click on the small grey tick symbol beside it:</li>
</ol>
<div><img src="img/00141.jpeg" class="calibre124"/></div>
<ol start="5" class="calibre13">
<li value="5" class="calibre10">After clicking the small grey tick symbol beside it, the Body Mapping Templates section space will look like this:</li>
</ol>
<div><img src="img/00142.jpeg" class="calibre125"/></div>
<ol start="6" class="calibre13">
<li value="6" class="calibre10">Now, in the template textbox, add the following code and click the Save button underneath the text box:</li>
</ol>
<div><img src="img/00143.jpeg" class="calibre126"/></div>
<ol start="7" class="calibre13">
<li value="7" class="calibre10">So, after all these steps, the resulting Body Mapping Templates section will look like this:</li>
</ol>
<div><img src="img/00144.jpeg" class="calibre127"/></div>
<ol start="8" class="calibre13">
<li value="8" class="calibre10">Now, going back to the Method Execution page, we can see the TEST option on the left with a lightning bolt symbol beneath it:</li>
</ol>
<div><img src="img/00145.jpeg" class="calibre128"/></div>
<ol start="9" class="calibre13">
<li value="9" class="calibre10">Clicking on the TEST button on the left-side in the Client section and above the thunderbolt option will take you to a page where you can test the API that you've just created:</li>
</ol>
<div><img src="img/00146.jpeg" class="calibre129"/></div>
<ol start="10" class="calibre13">
<li value="10" class="calibre10">Now, let's type <kbd class="calibre12">Exotic</kbd> in the textbox below {type} and click on the Test button at the bottom. If everything goes right, we should see the list of all the exotic pets we have entered in the function code of our Lambda function:</li>
</ol>
<div><img src="img/00147.jpeg" class="calibre130"/></div>
<ol start="11" class="calibre13">
<li value="11" class="calibre10">And rightly so, we did get the list of all of the exotic pets in the catalog. So, this brings this chapter to an end, where you have learned how to build a fully fledged serverless API from scratch, including how to deploy it.</li>
</ol>
<ol start="12" class="calibre13">
<li value="12" class="calibre10">In addition, if you want to add additional security settings, such as Authorizations and API Key Required, you can do it in the Method Request menu:</li>
</ol>
<div><img src="img/00148.jpeg" class="calibre131"/></div>


            

            
        
    

        

                            
                    <h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            
                
<p class="calibre2">In this chapter, we have learned how to build a completely serverless API from scratch. We have also learned how to add more resources and methods for the API, as well as how to deploy it successfully to multiple stages of development and how to add additional security settings such as authorization and API keys for authentication purposes.</p>
<p class="calibre2">We then learned how to associate a Lambda function with our API Gateway's API service for handling the computational tasks of our API.</p>
<p class="calibre2">In the next chapter, we will be learning about logging and monitoring serverless applications. In that chapter, we will learn about the logging and monitoring services of AWS such as CloudWatch Metrics, CloudWatch Logs, and CloudWatch Dashboards in detail, and try to set them up for our serverless applications. We will also learn how to create a logging and monitoring pipeline from AWS Lambda to these monitoring tools using some AWS services.</p>


            

            
        
    </body></html>