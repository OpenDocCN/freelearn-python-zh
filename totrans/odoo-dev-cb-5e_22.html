<html><head></head><body>
		<div id="_idContainer211">
			<h1 id="_idParaDest-934" class="chapter-number"><a id="_idTextAnchor1154"/>22</h1>
			<h1 id="_idParaDest-935"><a id="_idTextAnchor1155"/>Point of Sale</h1>
			<p>Point of Sale is a fully integrated application that allows you to sell products (online or offline) with any device. It also automatically registers product moves in your stock, gives you real-time statistics, and consolidations across all shops. In this chapter, we will see how to modify the Point of <span class="No-Break">Sale application.</span></p>
			<p>In this chapter, we will cover the <span class="No-Break">following topics:</span></p>
			<ul>
				<li>Adding custom <span class="No-Break">JavaScript/SCSS files</span></li>
				<li>Adding an action button to <span class="No-Break">the keyboard</span></li>
				<li>Making <span class="No-Break">RPC calls</span></li>
				<li>Modifying the Point of Sale <span class="No-Break">screen UI</span></li>
				<li>Modifying existing <span class="No-Break">business logic</span></li>
				<li><span class="No-Break">Modifying customer</span></li>
			</ul>
			<p class="callout-heading">Note</p>
			<p class="callout">The Point of Sale application is mostly written in JavaScript. This chapter is written assuming that <a id="_idIndexMarker1584"/>you have a basic knowledge of JavaScript. This chapter also uses the OWL framework, so if you are unaware of these JavaScript terms, check out <a href="B20997_16.xhtml#_idTextAnchor929"><span class="No-Break"><em class="italic">Chapter 16</em></span></a>, <em class="italic">The Odoo Web </em><span class="No-Break"><em class="italic">Library (OWL)</em></span><span class="No-Break">.</span></p>
			<p>Throughout this chapter, we will be using an add-on module called <strong class="source-inline">point_of_sale_customization</strong>. This <strong class="source-inline">point_of_sale_customization </strong>module will have a dependency on <strong class="source-inline">point_of_sale</strong>, as we are going to do customization in the Point of Sale application. To get started with this point quickly, we have prepared an initial <strong class="source-inline">point_of_sale_customization </strong>module, and you can grab it from the <strong class="source-inline">Chapter22/00_initial_module/point_of_sale_customization</strong> directory in the GitHub repository of <span class="No-Break">this book.</span></p>
			<h1 id="_idParaDest-936"><a id="_idTextAnchor1156"/>Technical requirements</h1>
			<p>All the code used in this chapter can be downloaded from the following GitHub <span class="No-Break">repository: </span><a href="https://github.com/PacktPublishing/Odoo-17-Development-Cookbook-Fifth-Edition/tree/main/Chapter22"><span class="No-Break">https://github.com/PacktPublishing/Odoo-17-Development-Cookbook-Fifth-Edition/tree/main/Chapter22</span></a><span class="No-Break">.</span><a id="_idTextAnchor1157"/></p>
			<h1 id="_idParaDest-937"><a id="_idTextAnchor1158"/>Adding custom JavaScript/SCSS files</h1>
			<p>The Point of Sale app uses different asset bundles to manage JavaScript and style sheet files. In this <a id="_idIndexMarker1585"/>recipe, we will learn how to add <strong class="bold">SCSS</strong> and <strong class="bold">JavaScript </strong>files to the Point of Sale <span class="No-Break">asset bundle<a id="_idTextAnchor1159"/>.</span></p>
			<h2 id="_idParaDest-938"><a id="_idTextAnchor1160"/>Getting ready</h2>
			<p>First, we will load an SCSS style sheet and a JavaScript file into the Point of <span class="No-Break">Sale application<a id="_idTextAnchor1161"/>.</span></p>
			<h2 id="_idParaDest-939"><a id="_idTextAnchor1162"/>How to do it…</h2>
			<p>To load assets into the Point of Sale application, follow <span class="No-Break">these steps:</span></p>
			<ol>
				<li>Add a new SCSS file at <strong class="source-inline">point_of_sale_customization/static/src/scss/point_of_sale_customization.scss</strong> and insert the <span class="No-Break">following code:</span><pre class="source-code">
.pos .pos-content {
    .price-tag {
        background: #00abcd;
        width: 100%;
        right: 0;
        left: 0;
        top:0;
    }
}</pre></li>				<li>Add a JavaScript file at <strong class="source-inline">point_of_sale_customization/static/src/js/point_of_sale_customization.js</strong> and add <span class="No-Break">the following:</span><pre class="source-code">
/** @odoo-module */
console.log("Point Of Sale Javascript Loaded");</pre></li>				<li>Register <a id="_idIndexMarker1586"/>these JavaScript and SCSS files in the <span class="No-Break"><strong class="source-inline">point_of_sale assets</strong></span><span class="No-Break">:</span><pre class="source-code">
'assets': {
      'point_of_sale._assets_pos': [
'point_of_sale_customization/static/src/scss/point_of_sale_customization.scss',
'point_of_sale_customization/static/src/js/point_of_sale_customization.js'
    ],
},</pre></li>				<li>Install the <span class="No-Break"><strong class="source-inline">point_of_sale_customization</strong></span><span class="No-Break"> module.</span></li>
			</ol>
			<div>
				<div id="_idContainer203" class="IMG---Figure">
					<img src="image/B20997_22_01.jpg" alt="Figure 22.1 – Installing the POS Customization module"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 22.1 – Installing the POS Customization module</p>
			<p>To see your changes in action, start the new session from the <strong class="bold">Point of Sale | </strong><span class="No-Break"><strong class="bold">Dashboard</strong></span><span class="No-Break"> menu<a id="_idTextAnchor1163"/>.</span></p>
			<h2 id="_idParaDest-940"><a id="_idTextAnchor1164"/>How it works…</h2>
			<p>So far, we have <a id="_idIndexMarker1587"/>loaded one JavaScript file and one SCSS file into the Point of <span class="No-Break">Sale application.</span></p>
			<p>In <em class="italic">step 1</em>, we changed the background color of the pricing label of the product card. After installing the <strong class="source-inline">point_of_sale_customization</strong> module, you will be able to see changes to the <span class="No-Break">pricing labels:</span></p>
			<div>
				<div id="_idContainer204" class="IMG---Figure">
					<img src="image/B20997_22_02.jpg" alt="Figure 22.2 – The updated price labels"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 22.2 – The updated price labels</p>
			<p>In <em class="italic">step 2</em>, we added the JavaScript file. In it, we added the log to the console. In order to see the message, you will need to open your browser’s developer tools. In the <strong class="bold">Console</strong> tab, you will see the following log. This shows that your JavaScript file has loaded successfully. Right now, we have only added the log to the JavaScript file, but in upcoming recipes, we will add more <span class="No-Break">to it:</span></p>
			<div>
				<div id="_idContainer205" class="IMG---Figure">
					<img src="image/B20997_22_03.jpg" alt="Figure 22.3 – JavaScript loaded (the log in the console)"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 22.3 – JavaScript loaded (the log in the console)</p>
			<p>In <em class="italic">step 3</em>, we added <a id="_idIndexMarker1588"/>the JavaScript file and the SCSS file, <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
'assets': {
    'point_of_sale._assets_pos': [
         'js,scss path'
    ],
<a id="_idTextAnchor1165"/>}</pre>			<h2 id="_idParaDest-941"><a id="_idTextAnchor1166"/>There’s more…</h2>
			<p>Odoo also has an add-on module for Point of Sale solutions for restaurants. Note that this Point of Sale restaurant module is just an extension of the Point of Sale application. If you want to do customization in the restaurant module, you will need to add your JavaScript and SCSS files to the same <strong class="source-inline">point_of_sale._assets_pos</strong> <span class="No-Break">asset bundle<a id="_idTextAnchor1167"/>.</span></p>
			<h1 id="_idParaDest-942"><a id="_idTextAnchor1168"/>Adding an action button to the keyboard</h1>
			<p>As we discussed <a id="_idIndexMarker1589"/>in the previous point, the Point of Sale application is designed in such a way that it works offline. Thanks to this, the code structure of the Point of Sale application is different from the remaining Odoo applications. The code base of the Point of Sale app is largely written with JavaScript and provides different utilities for customization. At this point, we will use one such utility and create an action button at the top of the <span class="No-Break">keyboard pane<a id="_idTextAnchor1169"/>l.</span></p>
			<h2 id="_idParaDest-943"><a id="_idTextAnchor1170"/>Getting ready</h2>
			<p>Here, we will use the <strong class="source-inline">point_of_sale_customization</strong> module created in the <em class="italic">Adding custom JavaScript/SCSS files</em> recipe. We will add a button at the top of the keyboard panel. This button will be a shortcut to apply a discount to the <span class="No-Break">order line<a id="_idTextAnchor1171"/>s.</span></p>
			<h2 id="_idParaDest-944"><a id="_idTextAnchor1172"/>How to do it…</h2>
			<p>Follow these <a id="_idIndexMarker1590"/>steps to add a 5% discount action button to the keyboard panel for the Point of <span class="No-Break">Sale application:</span></p>
			<ol>
				<li>Add the following code to the <strong class="source-inline">/static/src/js/point_of_sale_customization.js</strong> file, which will define the <span class="No-Break">action button:</span><pre class="source-code">
/** @odoo-module */
import { Component } from "@odoo/owl";
import { ProductScreen } from "@point_of_sale/app/screens/product_screen/product_screen";
import { usePos } from "@point_of_sale/app/store/pos_hook";
export class PosDiscountButton extends Component {
    static template = "PosDiscountButton";
    setup() {
        this.pos = usePos();
    }
    async onClick() {
        const order = this.pos.get_order();
        if (order.selected_orderline) {
            order.selected_orderline.set_discount(5);
        }
    }
}
ProductScreen.addControlButton({
    component: PosDiscountButton,
    condition: function () {
        return true;
    }
});</pre></li>				<li>Add <a id="_idIndexMarker1591"/>the QWeb template for the button to the <strong class="source-inline">/</strong><span class="No-Break"><strong class="source-inline">static/src/xml/point_of_sale_customization.xml</strong></span><span class="No-Break"> file:</span><pre class="source-code">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;templates id="template" xml:space="preserve"&gt;
   &lt;t t-name="PosDiscountButton"&gt;
       &lt;span class="control-button btn btn-light rounded-0 fw-bolder"
             t-on-click="() =&gt; this.onClick()"&gt;
           &lt;i class="fa fa-gift"&gt;&lt;/i&gt;
           &lt;span&gt;5%&lt;/span&gt;
           &lt;span&gt;Discount&lt;/span&gt;
       &lt;/span&gt;
   &lt;/t&gt;
&lt;/templates&gt;</pre></li>				<li>Add a new SCSS file at <strong class="source-inline">point_of_sale_customization/static/src/scss/point_of_sale_customization.scss</strong> and insert the <span class="No-Break">following code:</span><pre class="source-code">
.pos .pos-content {
    .price-tag {
        background: #00abcd;
        width: 100%;
        right: 0;
        left: 0;
        top:0;
    }
}</pre></li>				<li>Register <a id="_idIndexMarker1592"/>the QWeb template in the manifest file <span class="No-Break">as follows:</span><pre class="source-code">
'assets': {
       'point_of_sale._assets_pos': [
           'point_of_sale_customization/static/src/scss/point_of_sale_customization.scss',
           'point_of_sale_customization/static/src/xml/point_of_sale_customization.xml',
           'point_of_sale_customization/static/src/js/point_of_sale_customization.js'
       ],
   },</pre></li>				<li>Update <a id="_idIndexMarker1593"/>the <strong class="source-inline">point_of_sale_customization</strong> module to apply the changes. After that, you will be able to see a <strong class="bold">5%Discount </strong>button above <span class="No-Break">the calculator:</span></li>
			</ol>
			<div>
				<div id="_idContainer206" class="IMG---Figure">
					<img src="image/B20997_22_04.jpg" alt="Figure 22.4 – The discount button"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 22.4 – The discount button</p>
			<p>After clicking this, the discount will be applied to the selected <span class="No-Break">order <a id="_idTextAnchor1173"/>line.</span></p>
			<h2 id="_idParaDest-945"><a id="_idTextAnchor1174"/>How it works..</h2>
			<p>In Odoo v17, code based on the Odoo Point of Sale application is completely rewritten using the OWL framework. You can learn more about the OWL framework in <a href="B20997_16.xhtml#_idTextAnchor929"><span class="No-Break"><em class="italic">Chapter 16</em></span></a>, <em class="italic">The Odoo Web </em><span class="No-Break"><em class="italic">Library (OWL)</em></span><span class="No-Break">.</span></p>
			<p>To create the <a id="_idIndexMarker1594"/>action button in the Point of Sale application, you will need to <em class="italic">extend</em> <strong class="source-inline">Component</strong>. Now, <strong class="source-inline">Component</strong> is defined in <strong class="source-inline">@odoo/owl namespace</strong>, so to use it in your code, you will need to <span class="No-Break">import it.</span></p>
			<p>In <em class="italic">step 1</em>, we imported <strong class="source-inline">Component</strong> from <strong class="source-inline">@odoo/owl</strong>. Then, we created <strong class="source-inline">PosDiscountButton</strong> by extending <strong class="source-inline">Component</strong>. In <em class="italic">step 1</em>, we also imported <strong class="source-inline">ProductScreen</strong> from <strong class="source-inline">@point_of_sale/app/screens/product_screen/product_screen </strong>and<strong class="source-inline"> usePos </strong><span class="No-Break"><strong class="source-inline">from @point_of_sale/app/store/pos_hook</strong></span><span class="No-Break">.</span></p>
			<p>Now, <strong class="source-inline">ProductScreen</strong> is used to add a button to the Point of Sale screen via the <span class="No-Break"><strong class="source-inline">addControlButton</strong></span><span class="No-Break"> method.</span></p>
			<p><strong class="source-inline">Component</strong> has some built-in utilities that give access to useful information such as order details and the Point of Sale configuration. You can access it via the <strong class="source-inline">this.pos = </strong><span class="No-Break"><strong class="source-inline">usePos()</strong></span><span class="No-Break"> variable.</span></p>
			<p>In our example, we have accessed the current order information via the <strong class="source-inline">this.pos.get_order()</strong> method. Then, we used the <strong class="source-inline">set_discount()</strong> method to set a <span class="No-Break">5% discount.</span></p>
			<p>In <em class="italic">step 2</em> and <em class="italic">step 3</em>, we added the OWL template, which will be rendered over the Point of Sale keyboard. If you wish to learn more about this, please refer to <a href="B20997_16.xhtml#_idTextAnchor929"><span class="No-Break"><em class="italic">Chapter 16</em></span></a>, <em class="italic">The Odoo Web </em><span class="No-Break"><em class="italic">Library <a id="_idTextAnchor1175"/>(OWL)</em></span><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-946"><a id="_idTextAnchor1176"/>There’s more…</h2>
			<p>The <strong class="source-inline">addControlButton()</strong> method supports one more parameter, which is <strong class="source-inline">condition</strong>. This parameter <a id="_idIndexMarker1595"/>is used to hide/show the button based on some condition. The value of this parameter is a function that returns a Boolean. Based on the returned value, the Point of Sale system will hide or show <span class="No-Break">the button.</span></p>
			<p>Take a <a id="_idIndexMarker1596"/>look at the following example for <span class="No-Break">more information:</span></p>
			<pre class="source-code">
ProductScreen.addControlButton({
   component: PosDiscountButton,
   condition: function () {
       return true;
   },
});</pre>			<h1 id="_idParaDest-947"><a id="_idTextAnchor1177"/>Making RPC calls</h1>
			<p>Though the Point of Sale application works offline, it is still possible to make RPC calls to the server. The RPC call can <a id="_idIndexMarker1597"/>be used for any operation; you can use it for CRUD operations, or to perform an action on <span class="No-Break">the server.</span></p>
			<p>Now, we will make an RPC call to fetch information about a customer’s last <span class="No-Break">fiv<a id="_idTextAnchor1178"/>e orders.</span></p>
			<h2 id="_idParaDest-948"><a id="_idTextAnchor1179"/>Getting ready</h2>
			<p>Now, we will use the <strong class="source-inline">point_of_sale_customization</strong> module created for the <strong class="bold">Adding an action</strong> button in the keyboard recipe. We will define the action button. When the user clicks on the action button, we will make an RPC call to fetch the order information and display it on <span class="No-Break">t<a id="_idTextAnchor1180"/>he popup.</span></p>
			<h2 id="_idParaDest-949"><a id="_idTextAnchor1181"/>How to do it...</h2>
			<p>Follow these steps to display the last five orders for the <span class="No-Break">selected customer:</span></p>
			<ol>
				<li>Add the following code to the <strong class="source-inline">/static/src/js/point_of_sale_customization.js</strong> file; this will add a new action button to fetch and display the information about the last five orders when a user clicks on <span class="No-Break">the button:</span><pre class="source-code">
/** @odoo-module */
import { Component } from "@odoo/owl";
import { ErrorPopup } from "@point_of_sale/app/errors/popups/error_popup";
import { ProductScreen } from "@point_of_sale/app/screens/product_screen/product_screen";
import { SelectionPopup } from "@point_of_sale/app/utils/input_popups/selection_popup";
import { usePos } from "@point_of_sale/app/store/pos_hook";
import { useService } from "@web/core/utils/hooks";
import { sprintf } from "@web/core/utils/strings";
export class PosLastOrderButton extends Component {
   static template = "PosLastOrderButton";
   setup() {
       this.pos = usePos();
       this.popup = useService("popup");
   }
}
ProductScreen.addControlButton({
   component: PosLastOrderButton,
   condition: function () {
       return true;
   },
});</pre></li>				<li>Add the <strong class="source-inline">onClick</strong> function <a id="_idIndexMarker1598"/>to the <strong class="source-inline">PosLastOrders</strong> component to manage <span class="No-Break">button clicks:</span><pre class="source-code">
export class PosLastOrderButton extends Component {
    static template = "PosLastOrderButton";
    setup() {
        this.pos = usePos();
        this.popup = useService("popup");
    }
    async onClick() {
        var self = this;
        const order = this.pos.get_order();
        const client = order.get_partner();
        if (client) {
            var domain = [['partner_id', '=', client.id]];
            const orders = await this.pos.orm.call(
                "pos.order",
                "search_read",
                [],
                {
                    domain: domain,
                    fields: ['name', 'amount_total'],
                    limit:5
                }
            );
            if (orders.length &gt; 0) {
                var order_list = orders.map((o) =&gt; {
                    return { 'label': sprintf("%s -TOTAL: %s", o.name, o.amount_total) };
                });
                await this.popup.add(SelectionPopup, {
                    title: 'Last 5 orders',
                    list: order_list
                });
            } else {
                await this.popup.add(ErrorPopup, {
                    body: "No previous orders found"
                });
            }
        } else {
            await this.popup.add(ErrorPopup, {
                body: "No previous orders found"
            });
        }
    }
}</pre></li>				<li>Add the QWeb template for the button to the <strong class="source-inline">/</strong><span class="No-Break"><strong class="source-inline">static/src/xml/point_of_sale_customization.xml</strong></span><span class="No-Break"> file:</span><pre class="source-code">
&lt;t t-name="PosLastOrderButton"&gt;
       &lt;span class="control-button btn btn-light rounded-0 fw-bolder"
             t-on-click="() =&gt; this.onClick()"&gt;
           &lt;i class="fa fa-shopping-cart"&gt;&lt;/i&gt;Making RPC calls
           &lt;span&gt;&lt;/span&gt;
           &lt;span&gt;Last Orders&lt;/span&gt;
       &lt;/span&gt;
   &lt;/t&gt;</pre></li>				<li>Update <a id="_idIndexMarker1599"/>the <strong class="source-inline">point_of_sale_customization</strong> module to apply the changes. After that, you will be able to see the <strong class="bold">Last orders</strong> button above the keyboard panel. When this button is clicked, a popup will be displayed with the <span class="No-Break">order information:</span></li>
			</ol>
			<div>
				<div id="_idContainer207" class="IMG---Figure">
					<img src="image/B20997_22_05.jpg" alt="Figure 22.5 – The last five orders of a customer"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 22.5 – The last five orders of a customer</p>
			<p>If no previous orders are found, a warning will be displayed instead of an <span class="No-Break">o<a id="_idTextAnchor1182"/>rder list.</span></p>
			<h2 id="_idParaDest-950"><a id="_idTextAnchor1183"/>How it works…</h2>
			<p>In <em class="italic">step 1</em>, we created the action button. If you want to learn more about the action button, refer to the <em class="italic">Adding an action button to the keyboard</em> recipe in <span class="No-Break">this chapter.</span></p>
			<p>Before going <a id="_idIndexMarker1600"/>into the technical details, let’s understand what we wanted to accomplish with this action button. Once clicked, we want to display information for the last five orders for the selected customer. There will be a few cases where the customer is not selected, or customers have no previous orders. In such cases, we want to show a popup with an appropriate message. The RPC utility is available with the <strong class="source-inline">this.pos.orm.call</strong> attribute of <span class="No-Break">the component.</span></p>
			<p>In <em class="italic">step 2</em>, we added the click-handler function. On clicking the action button, the click-handler function will be called. This function will make the RPC call the server to fetch the <span class="No-Break">order information.</span></p>
			<p>We used the <strong class="source-inline">this.pos.orm.call()</strong> method to make <span class="No-Break">RPC calls.</span></p>
			<p>Then, we used the <strong class="source-inline">search_read</strong> method to fetch data through RPC. We passed the customer domain to filter the orders. We also passed <strong class="source-inline">limit</strong> keyword arguments to fetch only five orders. <strong class="source-inline">this.pos.orm.call()</strong> is an asynchronous method and returns a <strong class="source-inline">Promise</strong> object, so to handle the result, you can use the <span class="No-Break"><strong class="source-inline">await</strong></span><span class="No-Break"> keyword.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">The RPC call does not work in offline mode. If you have a good internet connection and you do not use offline mode frequently, you can <span class="No-Break">use RPCs.</span></p>
			<p class="callout">Although the Odoo Point of Sale application works offline, a few operations, such as creating or updating a customer, require an internet connection, as those features use RPC to <span class="No-Break">call internally.</span></p>
			<p>We displayed <a id="_idIndexMarker1601"/>the previous order information in the popup. We used <strong class="source-inline">SelectionPopup</strong>, which is used to display a selectable list; we used it to show the last five orders. We also used <strong class="source-inline">ErrorPopup</strong> to display a warning message when a customer is not selected or no previous orders <span class="No-Break">were found.</span></p>
			<p>In <em class="italic">step 3</em>, we added the QWeb template for the action button. The Point of Sale application will render this template to display the <span class="No-Break">ac<a id="_idTextAnchor1184"/>tion button.</span></p>
			<h2 id="_idParaDest-951"><a id="_idTextAnchor1185"/>There’s more…</h2>
			<p>There are plenty of other pop-up utilities. For example, <strong class="source-inline">NumberPopup</strong> is used to take a number input from the user. Refer to the files in the <strong class="source-inline">@point_of_sale/app/utils/input_popups/number_popup</strong> directory to see all these utilities. The <strong class="source-inline">NumberPopup</strong> module is probably a custom component or utility function to handle number input popups within a POS application. Depending on the context, this module could be responsible for displaying a pop-up dialog to input numerical data in a user-friendly way, such as for entering quantities or prices in a retail system. Use the following code to open a <span class="No-Break">number popup:</span></p>
			<pre class="source-code">
import { NumberPopup } from "@point_of_sale/app/utils/input_popups/number_popup";
this.popup.add(NumberPopup, { title: ("Set the new q<a id="_idTextAnchor1186"/>uantity")});</pre>			<h1 id="_idParaDest-952"><a id="_idTextAnchor1187"/>Modifying the Point of Sale screen UI</h1>
			<p>The UI of the Point of Sale application is written with the OWL QWeb template. In this recipe, we will <a id="_idIndexMarker1602"/>learn how you can modify UI elements in the Point of <span class="No-Break">Sale<a id="_idTextAnchor1188"/> application.</span></p>
			<h2 id="_idParaDest-953"><a id="_idTextAnchor1189"/>Getting ready</h2>
			<p>In this recipe, we will use the <strong class="source-inline">point_of_sale_customization</strong> module created in the <em class="italic">Making RPC calls</em> recipe. We will modify the UI of the product card and display the profit margin<a id="_idTextAnchor1190"/> <span class="No-Break">per product.</span></p>
			<h2 id="_idParaDest-954"><a id="_idTextAnchor1191"/>How to do it…</h2>
			<p>Follow these steps to display the profit margin on the <span class="No-Break">product card:</span></p>
			<ol>
				<li>Add the following code to the <strong class="source-inline">/models/pos_session.py</strong> file to fetch the extra field for the product’s <span class="No-Break">actual price:</span><pre class="source-code">
from odoo import models
class PosSession(models.Model):
    _inherit = 'pos.session'
    def _loader_params_product_product(self):
        result = super()._loader_params_product_product()
  result['search_params']['fields'].append('standard_price')
        return result</pre></li>				<li>Add the following code to <strong class="source-inline">/static/src/xml/point_of_sale_customization.xml</strong> in order to display a profit margin <span class="No-Break">product card:</span><pre class="source-code">
&lt;t t-name="ProductsWidget"
t-inherit="point_of_sale.ProductsWidget"
       t-inherit-mode="extension"&gt;
       &lt;xpath expr="//ProductCard" position="attributes"&gt;
           &lt;attribute name="standard_price"&gt;
               pos.env.utils.formatCurrency(product.get_display_price() - product.standard_price)
           &lt;/attribute&gt;
       &lt;/xpath&gt;
   &lt;/t&gt;
   &lt;t t-name="ProductCard" t-inherit="point_of_sale.ProductCard"
       t-inherit-mode="extension"&gt;
       &lt;xpath expr="//span[hasclass('price-tag')]" position="after"&gt;
           &lt;span t-if="props.standard_price"
                 class="sale_margin py-1 fw-bolder"&gt;
               &lt;t t-esc="props.standard_price"/&gt;
           &lt;/span&gt;
       &lt;/xpath&gt;
   &lt;/t&gt;</pre></li>				<li> Add the <a id="_idIndexMarker1603"/>following style sheet to style the <span class="No-Break">margin text:</span><pre class="source-code">
    .sale_margin {
    line-height: 21px;
    background: #CDDC39;
    padding: 0px 5px;
}</pre></li>				<li>Update the <strong class="source-inline">point_of_sale_customization</strong> module to apply the changes. After that, you will be able to see the profit margin on the <span class="No-Break">product card:</span></li>
			</ol>
			<div>
				<div id="_idContainer208" class="IMG---Figure">
					<img src="image/B20997_22_06.jpg" alt="Figure 22.6 – The profit margins for products"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 22.6 – The profit margins for products</p>
			<p>If the product <a id="_idIndexMarker1604"/>cost is not set on a product, then the product card will not display a profit margin, so make sure you set the<a id="_idTextAnchor1192"/> <span class="No-Break">product cost.</span></p>
			<h2 id="_idParaDest-955"><a id="_idTextAnchor1193"/>How it works...</h2>
			<p>In this recipe, we want to use the <strong class="source-inline">standard_price</strong> field as the purchase cost of the product. This field is not loaded by default in Point of <span class="No-Break">Sale applications.</span></p>
			<p>In <em class="italic">step 1</em>, we added the <strong class="source-inline">standard_price</strong> field for the <strong class="source-inline">product.product</strong> model. After this, the product data will have one more field – <span class="No-Break"><strong class="source-inline">standard_price</strong></span><span class="No-Break">.</span></p>
			<p>In <em class="italic">step 2</em>, we extended the default product card template. You will need to use the <strong class="source-inline">t- inherit</strong> attribute to <a id="_idIndexMarker1605"/>extend the existing <span class="No-Break"><strong class="bold">QWeb</strong></span><span class="No-Break"> template.</span></p>
			<p>Then, you need <a id="_idIndexMarker1606"/>to use XPath to select the element on which you want to perform the operation. If you want to learn more about XPaths, refer to the <em class="italic">Changing existing views – view inheritance</em> recipe in <a href="B20997_09.xhtml#_idTextAnchor446"><span class="No-Break"><em class="italic">Chapter 9</em></span></a>, <span class="No-Break"><em class="italic">Backend Views</em></span><span class="No-Break">.</span></p>
			<p>To fetch the product sale price, we used the <strong class="source-inline">product</strong> properties sent from the parent OWL component. Then, we calculated the margin by using the product price and product cost. If you want to learn more about this, please refer to <a href="B20997_16.xhtml#_idTextAnchor929"><span class="No-Break"><em class="italic">Chapter 16</em></span></a>, <em class="italic">The Odoo Web </em><span class="No-Break"><em class="italic">Library (OWL)</em></span><span class="No-Break">.</span></p>
			<p>In <em class="italic">step 3</em>, we added the style sheet to modify the position of the margin element. This will add a background color to the margin element and place it under<a id="_idTextAnchor1194"/> the <span class="No-Break">price pill.</span></p>
			<h1 id="_idParaDest-956"><a id="_idTextAnchor1195"/>Modifying existing business logic</h1>
			<p>In the previous <a id="_idIndexMarker1607"/>recipes, we saw how to fetch data through an RPC and how to modify the UI of the Point of Sale application. In this recipe, we will see how you can modify or extend the existin<a id="_idTextAnchor1196"/>g <span class="No-Break">business logic.</span></p>
			<h2 id="_idParaDest-957"><a id="_idTextAnchor1197"/>Getting ready</h2>
			<p>In this recipe, we will use the <strong class="source-inline">point_of_sale_customization</strong> module created in the <em class="italic">Modifying the Point of Sale screen UI</em> recipe, which is where we fetched the purchase price of a product and displayed the product margin. Now, in this recipe, we will show a warning to the user if they sell the product below th<a id="_idTextAnchor1198"/>e <span class="No-Break">product margin.</span></p>
			<h2 id="_idParaDest-958"><a id="_idTextAnchor1199"/>How to do it…</h2>
			<p>Most of the business logic of the Point of Sale application is written in JavaScript, so we just need to make changes to it to achieve the goal of this recipe. Add the following code to <strong class="source-inline">/static/src/js/point_of_sale_customization.js</strong> to show a warning when the user sells a product below the <span class="No-Break">purchase price:</span></p>
			<pre class="source-code">
/** @odoo-module */
import { ErrorPopup } from "@point_of_sale/app/errors/popups/error_popup";
import { ProductScreen } from "@point_of_sale/app/screens/product_screen/product_screen";
import { patch } from "@web/core/utils/patch";
patch(ProductScreen.prototype, {
   _setValue(val) {
       super._setValue(val);
       const orderline = this.currentOrder.get_selected_orderline();
       if (orderline &amp;&amp; orderline.product.standard_price) {
           var price_unit = orderline.get_unit_price() * (1.0 - (orderline.get_discount() / 100.0));
           if (orderline.product.standard_price &gt; price_unit) {
               this.popup.add(ErrorPopup, {
                   title: 'Warning',
                   body: 'Product price set below cost of product.'
               });
           }
       }
   }
});</pre>			<p>Update the <strong class="source-inline">point_of_sale_customization</strong> module to apply the changes. After the update, add the discount on the order line in such a way that the product price becomes less <a id="_idIndexMarker1608"/>than the purchase price. A popup will appear with the <span class="No-Break">following warning:</span></p>
			<div>
				<div id="_idContainer209" class="IMG---Figure">
					<img src="image/B20997_22_07.jpg" alt="Figure 22.7– A warning on a big discount"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 22.7– A warning on a big discount</p>
			<p>Note that when you set the product price below the actual cost, a warning will be displayed, and it will continue to pop up every time you take an action, such as when you change the quantity for t<a id="_idTextAnchor1200"/>he <span class="No-Break">product order.</span></p>
			<h2 id="_idParaDest-959"><a id="_idTextAnchor1201"/>How it works...</h2>
			<p>The Point of Sale component register provides an <strong class="source-inline">extend</strong> method to make changes to an existing function. Internally, it monkey-patches the actual <span class="No-Break">component definition.</span></p>
			<p>In our example, we modified the <strong class="source-inline">_setValue()</strong> method. The <strong class="source-inline">_setValue()</strong> method of <strong class="source-inline">ProductScreen</strong> is called whenever the user makes a change to the order line. We wanted to show a warning if the user sets the product price below the product cost. So, we defined a new <strong class="source-inline">_setValue()</strong> method and called the <strong class="source-inline">super</strong> method; this will make sure that whatever actions the user performs are applied. After the call to the <strong class="source-inline">super</strong> method, we wrote our logic, which checks whether the product sale price is higher than the actual cost of the product. If not, we then show a warning to <span class="No-Break">the user.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">Using <strong class="source-inline">super</strong> can break things if it’s not used carefully. If the method is inherited from several files, you must call the <strong class="source-inline">super</strong> method; otherwise, it will skip the logic in the subsequent inheritance. This sometimes leads to a broken internal <span class="No-Break">data state.</span></p>
			<p>We placed our <a id="_idIndexMarker1609"/>business logic after the default implementation (<strong class="source-inline">super</strong>) is called. If you want to write business logic before the default implementation, you can do so by moving the <strong class="source-inline">super </strong>call to the en<a id="_idTextAnchor1202"/>d of <span class="No-Break">the function.</span></p>
			<h1 id="_idParaDest-960"><a id="_idTextAnchor1203"/>Modifying customer receipts</h1>
			<p>When you customize a Point of Sale application, a common request you get from customers <a id="_idIndexMarker1610"/>is to modify customer receipts. In this recipe, you will learn how to modify<a id="_idTextAnchor1204"/> <span class="No-Break">customer receipts.</span></p>
			<h2 id="_idParaDest-961"><a id="_idTextAnchor1205"/>Getting ready</h2>
			<p>In this recipe, we will use the <strong class="source-inline">point_of_sale_customization</strong> module created in the <em class="italic">Modifying existing business logic</em> recipe. We will add one line to the Point of Sale receipt to show how much money the customer <a id="_idTextAnchor1206"/>saved in <span class="No-Break">the order.</span></p>
			<h2 id="_idParaDest-962"><a id="_idTextAnchor1207"/>How to do it…</h2>
			<p>Follow these steps to modify a customer receipt in the Point of <span class="No-Break">Sale application:</span></p>
			<ol>
				<li>Add the following code to the <strong class="source-inline">/static/src/js/point_of_sale_customization.js</strong> file. This will add extra data to the <span class="No-Break">receipt environment:</span><pre class="source-code">
/** @odoo-module */
import { Order } from "@point_of_sale/app/store/models";
import { patch } from "@web/core/utils/patch";
patch(Order.prototype, {
   saved_amount(){
       const order = this;
       return order.orderlines.reduce((rem, line) =&gt; {
           var diffrence = (line.product.lst_price * line.quantity) - line.get_base_price();
           return rem + diffrence;
       }, 0);
   },
   export_for_printing() {
       const json = super.export_for_printing(...arguments);
       var savedAmount = this.saved_amount();
       if (savedAmount &gt; 0) {
           json.saved_amount = this.env.utils.formatCurrency(savedAmount);
       }
       return json;
   }
})</pre></li>				<li>Add the following code to <strong class="source-inline">/static/src/xml/point_of_sale_customization.xml</strong>. This will extend the <a id="_idIndexMarker1611"/>default receipt template and add <span class="No-Break">our customization:</span><pre class="source-code">
&lt;t t-name="OrderReceipt"
      t-inherit="point_of_sale.OrderReceipt"
      t-inherit-mode="extension"&gt;
       &lt;xpath expr="//div[hasclass('pos-receipt')]//div[hasclass('before-footer')]" position="before"&gt;
           &lt;div style="text-align:center;" t-if="props.data.saved_amount"&gt;
               &lt;br/&gt;
               &lt;div &gt;
                   You saved
                   &lt;t t-esc="props.data.saved_amount"/&gt;
                   on this order.
               &lt;/div&gt;
           &lt;/div&gt;
       &lt;/xpath&gt;
   &lt;/t&gt;</pre></li>			</ol>
			<p>Update the <strong class="source-inline">point_of_sale_customization</strong> module to apply the changes. After that, add a product with the discount and check the receipt; you will see one extra line in <span class="No-Break">the receipt:</span></p>
			<div>
				<div id="_idContainer210" class="IMG---Figure">
					<img src="image/B20997_22_08.jpg" alt="Figure 22.8 – The updated receipt"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 22.8 – The updated receipt</p>
			<p>The receipt <a id="_idIndexMarker1612"/>will not display the <strong class="bold">Amount saved</strong> screen if it <a id="_idTextAnchor1208"/>is zero <span class="No-Break">or negative.</span></p>
			<h2 id="_idParaDest-963"><a id="_idTextAnchor1209"/>How it works...</h2>
			<p>There is nothing new in this recipe. We just updated the receipt by using the <span class="No-Break">previous recipes.</span></p>
			<p>In <em class="italic">step 1</em>, we overrode the <strong class="source-inline">export_for_printing()</strong> function to send more data to the receipt environment. Whatever you are sending from the <strong class="source-inline">export_for_printing()</strong> method will be available in the QWeb template of the receipt. We compared the product’s base price with the product price in the receipt to calculate how <a id="_idIndexMarker1613"/>much money the customer saved. We sent this data to the receipt environment via the <span class="No-Break"><strong class="source-inline">saved_amount</strong></span><span class="No-Break"> key.</span></p>
			<p>In <em class="italic">step 2</em>, we modified the default QWeb template of the receipt. The template name of the actual receipt is <strong class="source-inline">OrderReceipt</strong>, so we used it as a value in the <strong class="source-inline">t-inherit</strong> attribute. In <em class="italic">step 1</em>, we’d already sent the information needed to modify the receipt. In the QWeb template, we get the saved amount in the <strong class="source-inline">props.data.saved_amount</strong> key, so we just add one more <strong class="source-inline">&lt;div&gt;</strong> element before the footer. This will print the saved amount in the receipt. If you want to learn more about overriding, refer to the <em class="italic">Modifying the Point of Sale screen </em><span class="No-Break"><em class="italic">UI</em></span><span class="No-Break"> recipe.</span></p>
		</div>
	</body></html>