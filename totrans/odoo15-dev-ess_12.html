<html><head></head><body><div><div><h1 id="_idParaDest-353"><em class="italic"><a id="_idTextAnchor358"/></em><a href="B16119_12_Final_PD_ePub.xhtml#_idTextAnchor358"><em class="italic">Chapter 12</em></a>: Creating Printable PDF Reports with Server-Side QWeb</h1>
			<p>While a regular view can provide valuable information to users, there will be cases where a printed output is needed. Maybe it is a PDF document to be sent to a customer, or a paper document that is needed to support a physical process. To address these cases, Odoo apps support printed business reports. These are generated using QWeb and then exported to PDF documents, which can then be printed, emailed, or simply stored.</p>
			<p>Being QWeb-based means that the same skills that can be used for Kanban views and web pages can be reused to design reports. Beyond QWeb, specific mechanisms are used, such as report actions, paper formats, and the variables that are available for QWeb report rendering.</p>
			<p>In this chapter, examples will be used to illustrate how to structure and add content to a report. The usual report structure has a <strong class="bold">header</strong>, <strong class="bold">details</strong>, and <strong class="bold">footer sections</strong>. The content that can be added includes <strong class="bold">field data</strong>, including specific widgets such as images. Also common in reports is the need to present totals. All of these will be explained in detail in this chapter. </p>
			<p>The following topics will be covered in this chapter:</p>
			<ul>
				<li>Installing wkhtmltopdf</li>
				<li>Creating business reports</li>
				<li>Designing report content</li>
				<li>Creating custom reports</li>
			</ul>
			<p>By the end of this chapter, you will be familiar with all the steps needed to create Odoo reports, from report action to specific techniques that can be used on QWeb templates.</p>
			<h1 id="_idParaDest-354"><a id="_idTextAnchor359"/>Technical requirements</h1>
			<p>This chapter expands the existing <code>library_app</code> add-on module, based on the code first created in <a href="B16119_03_Final_PD_ePub.xhtml#_idTextAnchor072"><em class="italic">Chapter 3</em></a>, <em class="italic">Your First Odoo Application</em>. This chapter's code can be found in this book's GitHub repository at <a href="https://github.com/PacktPublishing/Odoo-15-Development-Essentials">https://github.com/PacktPublishing/Odoo-15-Development-Essentials</a> in the <code>ch12/</code> subdirectory.</p>
			<h1 id="_idParaDest-355"><a id="_idTextAnchor360"/>Installing wkhtmltopdf</h1>
			<p>Odoo reports are just HTML pages<a id="_idIndexMarker983"/> that are then converted into PDF files. For this conversion, the <code>wkhtmltopdf</code> command-line tool is used. Its name stands for <strong class="bold">Webkit HTML to PDF</strong>.</p>
			<p>For reports to be generated correctly, the recommended version of the <code>wkhtmltopdf</code> utility needs to be installed. Some versions of the <code>wkhtmltopdf</code> library are known to have issues, such as not printing page headers and footers, so we need to be picky about the version we use.</p>
			<p>Since Odoo 10, version 0.12.5 is the officially recommended one. The most up-to-date Odoo information about <code>wkhtmltopdf</code> can be found at <a href="https://github.com/odoo/odoo/wiki/Wkhtmltopdf">https://github.com/odoo/odoo/wiki/Wkhtmltopdf</a>.</p>
			<p>The packaged version provided by Debian or Ubuntu may not be appropriate. So, the recommendation is to directly download and install the correct package. The download links can be found at <a href="https://github.com/wkhtmltopdf/wkhtmltopdf/releases/tag/0.12.5">https://github.com/wkhtmltopdf/wkhtmltopdf/releases/tag/0.12.5</a>.</p>
			<p>To install the<a id="_idIndexMarker984"/> correct version of <code>wkhtmltopdf</code>, follow these steps: </p>
			<ol>
				<li> First, make sure that there isn't an incorrect version already installed on the system by inputting the following command:<pre><strong class="bold">$ wkhtmltopdf --version</strong></pre></li>
				<li>If the preceding command reports a version other than the recommended one, it should be uninstalled. To do so, on a Debian/Ubuntu system, input the following command:<pre><strong class="bold">$ sudo apt-get remove --purge wkhtmltopdf</strong></pre></li>
				<li>Next, you need to download the appropriate package for your system and install it. Check the release page for the correct download link. At the time of the Odoo 15 release, Ubuntu 20.04 LTS <em class="italic">Focal Fossa</em> is the latest long-term support version. For a 64-bit architecture, install the <code>wkhtmltox_0.12.5-1.focal_amd64.deb</code> package. The download command to use in this case is as follows:<pre><strong class="bold">$ wget "https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.5/wkhtmltox_0.12.5-1.focal_amd64.deb" -O /tmp/wkhtml.deb</strong></pre></li>
				<li>Next, install the downloaded package with the following command:<pre><strong class="bold">$ sudo dpkg -i /tmp/wkhtml.deb</strong></pre><p>This may display<a id="_idIndexMarker985"/> an error because of missing dependencies. In that case, the following command can be used to fix this:</p><pre><strong class="bold">$ sudo apt-get -f install</strong></pre></li>
				<li>Finally, verify that the <code>wkhtmltopdf</code> library is correctly installed with the intended version number with the following command:<pre><strong class="bold">$ wkhtmltopdf --version</strong>
<strong class="bold">wkhtmltopdf 0.12.5 (with patched qt)</strong></pre></li>
			</ol>
			<p>With this, you have successfully installed the correct version of <code>wkhtmltopdf</code> and now the Odoo server log won't display the <strong class="bold">You need Wkhtmltopdf to print a pdf version of the report</strong> information message during the startup sequence. </p>
			<p>Now that you know how to download and install a suitable version of the <code>wkhtmltopdf</code> tool, let's look at how to create business reports. </p>
			<h1 id="_idParaDest-356"><a id="_idTextAnchor361"/>Creating business reports</h1>
			<p>It would be helpful for the Library app to print out a report containing the book catalog. This report should list the book<a id="_idIndexMarker986"/> titles, along with details such as <strong class="bold">publisher</strong>, <strong class="bold">publishing date</strong>, and <strong class="bold">authors</strong>.</p>
			<p>We will implement this throughout this chapter, and in the process showcase the several techniques involved in implementing Odoo reports. The report will be added to the existing <code>library_app</code> module. </p>
			<p>The convention is to have report files in a <code>/reports</code> subdirectory, so a <code>reports/library_book_report.xml</code> data file will be added. As usual, when adding data files, remember to also declare them in the <code>data</code> key of the <code>__manifest__.py</code> file.</p>
			<p>To be able to run a report, the first thing we must add is the report action.</p>
			<h2 id="_idParaDest-357"><a id="_idTextAnchor362"/>Adding the report action</h2>
			<p>The <code>ir.actions.report</code> XML model, and it can be inspected by using the <strong class="bold">Settings</strong> | <strong class="bold">Technical</strong> | <strong class="bold">Actions</strong> | <strong class="bold">Reports</strong> menu option.</p>
			<p class="callout-heading">Changes in Odoo 14</p>
			<p class="callout">Odoo 14 deprecated the <code>&lt;report&gt;</code> shortcut tag for report actions. A <code>&lt;record model=""ir.actions.report"&gt;</code> element should be used instead.</p>
			<p>To add the report action<a id="_idIndexMarker989"/> and trigger the execution of the report, edit the <code>reports/library_book_report.xml</code> file, as follows:</p>
			<pre>&lt;odoo&gt;
  &lt;record id="action_library_book_report"
          model="ir.actions.report"&gt;
    &lt;field name="name"&gt;Book Catalog&lt;/field&gt;
    &lt;field name="model"&gt;library.book&lt;/field&gt;
    &lt;field name="report_type"&gt;qweb-pdf&lt;/field&gt;
    &lt;field name="report_name"&gt;
      library_app.book_catalog&lt;/field&gt;
    &lt;field name="binding_model_id" 
      ref="model_library_book" /&gt;
    &lt;field name="binding_type"&gt;report&lt;/field&gt;
  &lt;/record&gt;
&lt;/odoo&gt;</pre>
			<p>This report action<a id="_idIndexMarker990"/> makes this report available at the top<a id="_idIndexMarker991"/> of the <strong class="bold">Library Books</strong> view, on the <strong class="bold">Print</strong> button, next to the <strong class="bold">Action</strong> button:</p>
			<div><div><img src="img/Figure_12.1_B16119.jpg" alt="" width="1041" height="287"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.1 – The Print context button</p>
			<p>This marks the first step of having a report available to users.</p>
			<p>The essential fields that were used in the previous code are as follows:</p>
			<ul>
				<li><code>name</code> is the report action's title.</li>
				<li><code>model</code> is the technical name of the report's base model.</li>
				<li><code>report_type</code> is the type of document to generate. The options are <code>qweb-pdf</code>, <code>qweb-html,</code> or <code>qweb-text</code>.</li>
				<li><code>report_name</code> is the XML ID of the QWeb template to be used to generate the report's content. Unlike other identifier references, it must be a complete reference that includes the module name; that is, <code>&lt;module_name&gt;.&lt;identifier_name&gt;</code>.<p class="callout-heading">Tip</p><p class="callout">While working on report development, setting <code>report_type</code> to <code>qweb-html</code> allows you to inspect the HTML result that's generated by the QWeb template, and it also makes it easier to troubleshoot issues. When you've done this, it can be changed back to <code>qweb-pdf</code>.</p></li>
			</ul>
			<p>The following fields<a id="_idIndexMarker992"/> are not required to add the report action, but are needed<a id="_idIndexMarker993"/> for the report to be presented in the <strong class="bold">Print</strong> menu, next to the <strong class="bold">Action</strong> menu:</p>
			<ul>
				<li><code>binding_model_id</code> is a many-to-one field for identifying the model where the report print option should be available.</li>
				<li><code>binding_type</code> should be set to <code>report</code>.</li>
			</ul>
			<p>The other optional fields are as follows:</p>
			<ul>
				<li><code>print_report_name</code> is a Python expression that's used to provide the report's title and filename. The <code>object</code> variable is available and represents the current record.</li>
				<li><code>attachment</code> is a Python expression where you have to generate the attachment filename. The <code>object</code> variable is available and represents the current record. When set, the generated report is stored as an attachment.</li>
				<li><code>attachment_use</code>, when set to <code>True</code>, means that new report generations reopen the stored original report instead of regenerating it.</li>
				<li><code>paperformat_id</code> is a many-to-one field for the paper format to use. Paper formats include the page size and the portrait or landscape orientation.</li>
				<li><code>groups_id</code> is a many-to-many field with the security groups that can use the report.</li>
				<li><code>multi</code>, when set to <code>True</code>, means that the report<a id="_idIndexMarker994"/> is not available in the form<a id="_idIndexMarker995"/> view.</li>
			</ul>
			<p>These actions won't work right now since the referenced QWeb template is missing. We'll deal with this in the following sections.</p>
			<h2 id="_idParaDest-358"><a id="_idTextAnchor363"/>Using a QWeb report template for per-record documents</h2>
			<p>Odoo reports are generated using QWeb templates. QWeb generates HTML that can then be converted<a id="_idIndexMarker996"/> into a PDF document. QWeb directives<a id="_idIndexMarker997"/> and flow controls can be used as usual, but specific containers should be used to ensure proper page formatting.</p>
			<p>The following example provides a minimum viable template for a QWeb report. Add the following code to the <code>reports/library_book_report.xml</code> file, just after the report action element that we added in the previous section:</p>
			<pre>&lt;template id="book_catalog"&gt; 
<strong class="bold">  &lt;t t-call="web.html_container"&gt;</strong>
<strong class="bold">    &lt;t t-call="web.external_layout"&gt;</strong>
<strong class="bold">      &lt;t t-foreach="docs" t-as="o"&gt; </strong>
<strong class="bold">        &lt;div class="page"&gt;</strong>
          &lt;!-- Report content --&gt; 
<strong class="bold">        &lt;/div&gt;</strong>
<strong class="bold">      &lt;/t&gt;</strong>
<strong class="bold">    </strong><strong class="bold">&lt;/t&gt;</strong>
<strong class="bold">  &lt;/t&gt;</strong>
&lt;/template&gt;</pre>
			<p>The most important elements here are the <code>t-call</code> directives that are using standard report structures. The <code>web.html_container</code> template does the basic setup to support an HTML document. The <code>web.external_layout</code> template handles the report header and footer using the corresponding company setup. The <code>web.internal_layout</code> template can be used as an alternative, featuring only a basic header; it's better suited for internal use reports.</p>
			<p class="callout-heading">Changed Since Odoo 11</p>
			<p class="callout">In Odoo 11, the report layouts moved from the <code>report</code> module to the <code>web</code> module. Previous Odoo versions used <code>report.external_layout</code> or <code>report.internal_layout</code> references. Starting with Odoo 11, these need to be changed to <code>web.&lt;...&gt;</code> references.</p>
			<p>The <code>docs</code> variable represents the base record set to generate the report. The report will typically use a <code>t-foreach</code> QWeb directive to iterate through each record. The previous report template generates a report header and footer for each record.</p>
			<p>Notice that, since reports<a id="_idIndexMarker998"/> are just QWeb templates, inheritance<a id="_idIndexMarker999"/> can be applied, just like in the other views. QWeb templates that are used in reports can be extended using regular template inheritance – that is, using <em class="italic">XPath</em> expressions – as we will discuss next. </p>
			<h2 id="_idParaDest-359"><a id="_idTextAnchor364"/>Using a QWeb report template for record listings</h2>
			<p>In the case of the book catalog, there<a id="_idIndexMarker1000"/> is a single report document, with a header<a id="_idIndexMarker1001"/> and a footer, containing a line or section for each record.</p>
			<p>So, the report template needs to be adjusted for this, as shown in the following code:</p>
			<pre>&lt;template id="book_catalog"&gt; 
  &lt;t t-call="web.html_container"&gt;
    &lt;t t-call="web.external_layout"&gt;
<strong class="bold">      &lt;div class="page"&gt;</strong>
        &lt;!-- Report header content --&gt; 
<strong class="bold">        &lt;t t-foreach="docs" t-as="o"&gt; </strong>
          &lt;!-- Report row content --&gt; 
<strong class="bold">        &lt;/t&gt;</strong>
        &lt;!-- Report footer content --&gt; 
<strong class="bold">      &lt;/div&gt; &lt;!-- page --&gt;</strong>
    &lt;/t&gt;
  &lt;/t&gt;
&lt;/template&gt;</pre>
			<p>In the previous code, the <code>&lt;div class="page"&gt;</code> element was moved before <code>&lt;t t-foreach="docs"&gt;</code> so that a single report header and footer are printed, and the individual records will print<a id="_idIndexMarker1002"/> additional content inside the same<a id="_idIndexMarker1003"/> document. </p>
			<p>Now that we have the basic report template, we can customize the report layout, which we will do next.</p>
			<h2 id="_idParaDest-360"><a id="_idTextAnchor365"/>Choosing a report layout</h2>
			<p>The report layout can be customized<a id="_idIndexMarker1004"/> by users. This will be applied to the report, so long as it uses <code>external_layout</code>.</p>
			<p>The options for this are available from the <strong class="bold">Settings</strong> | <strong class="bold">General Settings</strong> menu, in the <strong class="bold">Companies</strong> | <strong class="bold">Document</strong> <strong class="bold">Layout</strong> section, as shown in the following screenshot:</p>
			<div><div><img src="img/Figure_12.2_B16119.jpg" alt="" width="1005" height="596"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.2 – Document layout configuration options</p>
			<p>Here, the <strong class="bold">Configure Document Layout</strong> button opens a report template configurator, provides a few layout options, and allows you to make selections regarding the company logo, colors, or text font.</p>
			<p>The selected layout can be set on the settings <strong class="bold">Layout</strong> field, and <strong class="bold">Edit Layout</strong> opens the corresponding view<a id="_idIndexMarker1005"/> form, allowing you to directly customize the layout's QWeb XML definition.</p>
			<p>Now that you know how to set up the general report layout, let's look at how to work with page formats. </p>
			<h2 id="_idParaDest-361"><a id="_idTextAnchor366"/>Setting a paper format</h2>
			<p>Odoo proposes a few page formats<a id="_idIndexMarker1006"/> out of the box, including European <em class="italic">A4</em> and <em class="italic">US Letter</em>. Additional page formats can be added, including those for specific page orientations.</p>
			<p>Paper formats are stored in the <code>report.paperformat</code> model. The existing formats can be inspected using the <strong class="bold">Settings</strong> | <strong class="bold">Technical</strong> | <strong class="bold">Reporting</strong> | <strong class="bold">Paper Format</strong> menu option.</p>
			<p>For the book catalog report, a <strong class="bold">landscape orientation</strong> will be used, and a new page format will be added for this.</p>
			<p>To add the <code>reports/library_book_report.xml</code> file:</p>
			<pre>&lt;record id="paperformat_euro_landscape" model="report.paperformat"&gt;
  &lt;field name="name"&gt;A4 Landscape&lt;/field&gt;
  &lt;field name="format"&gt;A4&lt;/field&gt;
<strong class="bold">  &lt;field name="orientation"&gt;Landscape&lt;/field&gt;</strong>
  &lt;field name="margin_top"&gt;40&lt;/field&gt;
  &lt;field name="margin_bottom"&gt;32&lt;/field&gt;
  &lt;field name="margin_left"&gt;7&lt;/field&gt;
  &lt;field name="margin_right"&gt;7&lt;/field&gt;
  &lt;field name="header_line" eval="False" /&gt;
  &lt;field name="header_spacing"&gt;35&lt;/field&gt;
  &lt;field name="dpi"&gt;90&lt;/field&gt;
&lt;/record&gt; </pre>
			<p>This is a copy of the European A4 format, defined by the <code>base</code> module, in the <code>data/report_paperformat_data.xml</code> file, with the orientation changed from portrait to landscape.</p>
			<p>This paper format can now be used for reports. The default paper format is defined in the company setup, but reports can set specific paper formats to be used. This can be done using the <code>paperfomat_id</code> field in the report action.</p>
			<p>The report action can be edited to add this field:</p>
			<pre>  &lt;record id="action_library_book_report"
          model="ir.actions.report"&gt;
    &lt;field name="name"&gt;Book Catalog&lt;/field&gt;
    &lt;field name="model"&gt;library.book&lt;/field&gt;
    &lt;field name="report_type"&gt;qweb-pdf&lt;/field&gt;
    &lt;field name="report_name"&gt;
      library_app.book_catalog&lt;/field&gt;
<strong class="bold">    &lt;field name="paperformat_id" </strong>
<strong class="bold">      ref="paperformat_euro_landscape" /&gt;</strong>
  &lt;/record&gt;</pre>
			<p>With the basic skeleton<a id="_idIndexMarker1008"/> for the report in place, it is time to start designing the report content.</p>
			<h1 id="_idParaDest-362"><a id="_idTextAnchor367"/>Designing report content</h1>
			<p>The report content<a id="_idIndexMarker1009"/> is written in HTML and makes use of Bootstrap 4 to help design the report's layout. Bootstrap is widely used in web development. </p>
			<p class="callout-heading">Tip</p>
			<p class="callout">A complete<a id="_idIndexMarker1010"/> reference can be found at <a href="http://getbootstrap.com">http://getbootstrap.com</a>.</p>
			<p>Unlike Kanban views, the report QWeb templates are rendered on the server side and use the Python QWeb implementation. So, there are some differences to be aware of, compared to the JavaScript QWeb implementation. QWeb expressions are evaluated using Python syntax, not JavaScript.</p>
			<h2 id="_idParaDest-363"><a id="_idTextAnchor368"/>Understanding the report rendering context</h2>
			<p>The server-side context<a id="_idIndexMarker1011"/> where expressions are evaluated is also different from the client-side context that's used for Kanban views. On a report template, the following variables are available:</p>
			<ul>
				<li><code>docs</code> is an iterable collection with the records to render the report for.</li>
				<li><code>doc_ids</code> is a list of the IDs of the records to render the report for.</li>
				<li><code>doc_model</code> identifies the model of the records; for example, <code>library.book</code>.</li>
				<li><code>user</code> is the record for the user running the report.</li>
				<li><code>res_company</code> is the record for the current user's company.</li>
				<li><code>website</code> is the record for the current website, if any. This could be <code>None</code>.</li>
				<li><code>web_base_url</code> is the base address of the Odoo server.</li>
				<li><code>time</code> is a reference to Python's <code>time</code> library.</li>
				<li><code>context_timestamp</code> is a function that takes a datetime object in UTC and converts it into the user's time zone.</li>
				<li>These values and Python libraries can be used in code expressions inside the template. For example, to print out the current user, we could use the following command:<pre>&lt;span t-out="user.name" /&gt;</pre></li>
			</ul>
			<p>The <code>docs</code> value is particularly important<a id="_idIndexMarker1012"/> since it contains the data to be used for the report.</p>
			<p>Now that you know how to access the data for the report, the next step is to add the report content.</p>
			<h2 id="_idParaDest-364"><a id="_idTextAnchor369"/>Adding the report content</h2>
			<p>With the basic QWeb template, including<a id="_idIndexMarker1013"/> its header, details, and footer, in place, you can now add content to it.</p>
			<p>Here is the XML you must use to render the report header. It should be placed inside the <code>&lt;div class="page"&gt;</code> node and before the <code>&lt;t t-foreach=...&gt;</code> element:</p>
			<pre>&lt;div class="page"&gt;
  &lt;!-- Report header content --&gt;
<strong class="bold">  &lt;div class="container"&gt;</strong>
<strong class="bold">    &lt;div class="row bg-primary"&gt;</strong>
<strong class="bold">      &lt;div class="col-3"&gt;Title&lt;/div&gt;</strong>
<strong class="bold">      &lt;div class="col-2"&gt;Publisher&lt;/div&gt;</strong>
<strong class="bold">      &lt;div class="col-2"&gt;Date&lt;/div&gt;</strong>
<strong class="bold">      &lt;div class="col-3"&gt;Publisher Address&lt;/div&gt;</strong>
<strong class="bold">      &lt;div class="col-2"&gt;Authors&lt;/div&gt;</strong>
<strong class="bold">    </strong><strong class="bold">&lt;/div&gt;</strong>
    &lt;t t-foreach="docs" t-as="o"&gt;
      &lt;div class="row"&gt;
        &lt;!-- Report row content --&gt;
      &lt;/div&gt;
    &lt;/t&gt;
    &lt;!-- Report footer content --&gt;
<strong class="bold">  &lt;/div&gt; &lt;!-- container --&gt;</strong>
&lt;/div&gt; &lt;!-- page --&gt;</pre>
			<p>This content layout<a id="_idIndexMarker1014"/> uses the Bootstrap 4 grid system, which was added with the <code>&lt;div class="container"&gt;</code> element. Bootstrap has a grid layout with 12 available columns. More details on Bootstrap can be found at <a href="https://getbootstrap.com/docs/4.1/layout/grid">https://getbootstrap.com/docs/4.1/layout/grid</a>.</p>
			<p class="callout-heading">Changes in Odoo 12</p>
			<p class="callout">Odoo used Bootstrap 3 until Odoo 11 and started using Bootstrap 4 from Odoo 12. Bootstrap 4 is not backward compatible with Bootstrap 3. For tips on the changes from Bootstrap 3 to Bootstrap 4, see the Odoo wiki page on this topic: <a href="https://github.com/odoo/odoo/wiki/Tips-and-tricks:-BS3-to-BS4">https://github.com/odoo/odoo/wiki/Tips-and-tricks:-BS3-to-BS4</a>.</p>
			<p>The previous code adds a header row with column titles. After this, there is a <code>t-foreach</code> loop to iterate through each record and render a row for each.</p>
			<p>Next, the focus will be on rendering the row for each record – in this case, one for each book in the catalog.</p>
			<p>Rows are added using a <code>&lt;div class="row"&gt;</code> element. A row contains cells, and each cell can span several columns so that the row takes up 12 columns. Each cell is added using a <code>&lt;div class="col-N"&gt;</code> element, where <code>N</code> is the number of columns it spans. For example, <code>&lt;div class="col-3"&gt;Title&lt;/div&gt;</code> is a cell spanning three columns.</p>
			<p>The QWeb template rendering is done on the server side, and record set objects are used. So, <code>o.name</code> gets the value of the <code>name</code> field from the <code>o</code> record. And it is easy to follow relational fields to access their data. For example, <code>o.publisher_id.email</code> gets the <code>email</code> field from the partner record referenced by the <code>publisher_id</code> field. Notice that this is not possible in client-side rendered QWeb views, such as web client Kanban views.</p>
			<p>To add the content<a id="_idIndexMarker1016"/> for each record row, add the following XML inside the <code>&lt;div class="row"&gt;</code> element:</p>
			<pre>&lt;!-- Report Row Content --&gt;
&lt;div class="row"&gt;
  &lt;div class="col-3"&gt;
    &lt;h4&gt;&lt;span t-field="o.name" /&gt;&lt;/h4&gt;
  &lt;/div&gt;
  &lt;div class="col-2"&gt;
    &lt;span t-field="o.publisher_id" /&gt;
  &lt;/div&gt;
  &lt;div class="col-2"&gt;
    &lt;span t-field="o.date_published"
          t-options="{'widget': 'date'}" /&gt;
  &lt;/div&gt;
  &lt;div class="col-3"&gt;
    &lt;div t-field="o.publisher_id"
         t-options='{
           "widget": "contact",
           "fields": ["address", "email", "phone", 
             "website"], "no_marker": true}' /&gt;
  &lt;/div&gt;
  &lt;div class="col-2"&gt;
    &lt;!-- Render Authors --&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre>
			<p>In the previous code, the <code>t-field</code> attributes are being used to render field data.</p>
			<p>The <code>t-options</code> attribute<a id="_idIndexMarker1017"/> can also be used to provide additional options for the field rendering, such as the widget to use.</p>
			<p>Let's have a closer look at the field widgets and their options.</p>
			<h2 id="_idParaDest-365"><a id="_idTextAnchor370"/>Using field widgets</h2>
			<p>In the template, field values<a id="_idIndexMarker1018"/> are rendered using the <code>t-field</code> attribute. This can be complemented<a id="_idIndexMarker1019"/> with the <code>t-options</code> attribute so that you can use a specific widget to render the field content.</p>
			<p><code>t-options</code> is set with a dictionary-like data structure. The widget key can be used to represent the field data.</p>
			<p>In the previous example code, <code>"widget": "contact"</code> is used to present an address. It was used to render the publishing company's address, <code>o.publisher_id</code>. The <code>no_marker="true"</code> option<a id="_idIndexMarker1020"/> was used to disable some pictograms and the <code>contact</code> widget, which are displayed by default.</p>
			<p class="callout-heading">Changes in Odoo 11</p>
			<p class="callout">The <code>t-options</code> attribute was introduced in Odoo 11, replacing the <code>t-field-options</code> attribute that was used in previous Odoo versions.</p>
			<p>For example, assuming that <code>doc</code> represents a particular record, rendering a date field value looks like this:</p>
			<pre>&lt;span t-field="doc.date_published" t-options="{'widget': 'date'}" /&gt;</pre>
			<p>The reference documentation<a id="_idIndexMarker1021"/> for the supported widgets and options can be found at <a href="https://www.odoo.com/documentation/15.0/developer/reference/frontend/javascript_reference.html#field-widgets">https://www.odoo.com/documentation/15.0/developer/reference/frontend/javascript_reference.html#field-widgets</a>.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">Documentation is not always up to date, and additional details may be found regarding the corresponding source code. The place to look is <a href="https://github.com/odoo/odoo/blob/15.0/odoo/addons/base/models/ir_qweb_fields.py">https://github.com/odoo/odoo/blob/15.0/odoo/addons/base/models/ir_qweb_fields.py</a>. Look for classes that inherit from <code>ir.qweb.field</code>. The <code>get_available_options()</code> methods give insight into the supported options.</p>
			<p>With that, we've added the QWeb XML code to render the row for each book. However, the <code>authors</code> column is missing. The next section will add the author names, along with their images, illustrating how to add<a id="_idIndexMarker1022"/> image content to a report.</p>
			<h2 id="_idParaDest-366"><a id="_idTextAnchor371"/>Rendering images</h2>
			<p>The last column of the report features<a id="_idIndexMarker1023"/> should present the list of authors, along with their avatars. The avatar image can be presented using the <code>t-field</code> attribute and the <code>image</code> widget.</p>
			<p>In the last column, add the following code:</p>
			<pre>&lt;!-- Render authors --&gt;
&lt;ul class="list-unstyled"&gt;
  &lt;t t-foreach="o.author_ids" t-as="author"&gt;
    &lt;span t-field="author.image_128"
      t-options="{'widget': 'image', 
        'style': 'max-width: 32px'}" /&gt;
    &lt;span t-field="author.name" /&gt;
  &lt;/t&gt;
&lt;/ul&gt;</pre>
			<p>In the previous code, there is a loop on the values to the <code>author_ids</code> many-to-many field. For each author, you must render the image in the <code>image_128</code> partner field using the <code>image</code> widget.</p>
			<p>With that, you have added the<a id="_idIndexMarker1024"/> header and details rows. The next few sections will work on the report footer, which is presented at the end of the report, and in the process introduce report totals.</p>
			<h2 id="_idParaDest-367"><a id="_idTextAnchor372"/>Calculating totals</h2>
			<p>A common need in reports is to provide <strong class="bold">totals</strong>. In some cases, the model has fields computing these, and the report<a id="_idIndexMarker1025"/> just needs to use them. In other cases, the totals might have to be computed by the report.</p>
			<p>As an example, the Book Catalog report will present the total number of books and authors in a final row.</p>
			<p>For this, a last row should be added after the closing tag of the <code>&lt;t t-foreach="docs"&gt;</code> element, to present the report totals.</p>
			<p>To do so, add the footer content with the following XML:</p>
			<pre>&lt;!-- Report footer content --&gt;
&lt;div class="row"&gt;
  &lt;div class="col-3"&gt;
    &lt;t t-out="len(docs)" /&gt; Books
  &lt;/div&gt;
  &lt;div class="col-7" /&gt;
  &lt;div class="col-2"&gt;
    &lt;t t-out="len(docs.mapped('author_ids'))" /&gt; Authors
  &lt;div&gt;
&lt;/div&gt;</pre>
			<p>The <code>len()</code> Python function is used to count the number of elements in a collection. Similarly, totals can also be computed using <code>sum()</code> over a list of values. For example, the following list comprehension computes a total amount:</p>
			<pre>&lt;t t-out="sum([x.amount for x in docs])" /&gt;</pre>
			<p>This list comprehension is a loop on the <code>docs</code> variable and returns a list of values stating the <code>amount</code> value of each record.</p>
			<p>Your last low with the report's total is created. However, there are cases where grand totals are not enough, and running<a id="_idIndexMarker1026"/> totals are needed. The next section will show you how to accumulate the values for these running totals.</p>
			<h2 id="_idParaDest-368"><a id="_idTextAnchor373"/>Calculating running totals</h2>
			<p>In some cases, the report<a id="_idIndexMarker1027"/> needs to perform computations throughout its iterations – for example, to keep a <strong class="bold">running total</strong>, with the total sum up to the current record. This kind of logic can be implemented in QWeb using a variable to accumulate values on each record iteration.</p>
			<p>To illustrate this, you can compute the accumulated number of authors. Start by initializing the variable, just before the <code>t-foreach</code> loop on the <code>docs</code> record set, using the following code:</p>
			<pre>&lt;!-- Running total: initialize variable --&gt;
&lt;t t-set="missing_count" t-value="0" /&gt;</pre>
			<p>Then, inside the loop, add the record's number of authors to the variable. Do this right after presenting the list of authors, and also print out the current total on every line:</p>
			<pre>&lt;!-- Running total: increment and present --&gt;
&lt;t t-set="missing_count"
   t-value=" missing_count + int(not o.publisher_id)" /&gt;
&lt;p&gt;(accum. &lt;t t-out="missing_count"/&gt;)&lt;/p&gt;</pre>
			<p>The previous code can be added to any of the report cells – for example, in the <em class="italic">Publisher</em> column cell.</p>
			<p>With that, you have added<a id="_idIndexMarker1028"/> all the report content, including report totals. Another feature that you can use on reports is <strong class="bold">multilingual support</strong>. This is supported in Odoo and the next section explains how to use it.</p>
			<h2 id="_idParaDest-369"><a id="_idTextAnchor374"/>Enabling language translation in reports</h2>
			<p>The Odoo user interface<a id="_idIndexMarker1029"/> uses the language selected by the current user. In some cases, a report might need to change this to a particular language. For example, a document<a id="_idIndexMarker1030"/> might be better printed using the customer language, rather than the user's selected language.</p>
			<p>In QWeb, the <code>t-call</code> directive, which is used to render a template, can be followed by the <code>t-lang</code> attribute, with an expression evaluation of the language to use. It should evaluate to a language code, such as <code>es</code> or <code>en_US</code>, and is usually an expression with the field where the language to use can be found.</p>
			<p>To showcase this, the <em class="italic">Library</em> app will include a version of the <em class="italic">Book Catalog</em> report using the library's base language, not the user's language. The library language will be the one that's set on the company partner record.</p>
			<p>For this, the existing <code>book_catalog</code> template can be reused. It should be called from another template, and that call can set the language to use for the rendering process.</p>
			<p>In the <code>reports/library_book_report.xml</code> file, add the following two record elements:</p>
			<pre>&lt;record id="action_library_book_report_native"
        model="ir.actions.report"&gt;
  &lt;field name="name"&gt;Native Language Book Catalog&lt;/field&gt;
  &lt;field name="model"&gt;library.book&lt;/field&gt;
  &lt;field name="report_type"&gt;qweb-pdf&lt;/field&gt;
  &lt;field name="report_name"&gt;
    library_app.book_catalog_native&lt;/field&gt;
  &lt;field name="binding_model_id" 
    ref="model_library_book" /&gt;
  &lt;field name="binding_type"&gt;report&lt;/field&gt;
  &lt;field name="paperformat_id" 
    ref="paperformat_euro_landscape" /&gt;
&lt;/record&gt;
&lt;template id="book_catalog_native"&gt;
  &lt;t t-call="library_app.book_catalog"
     <strong class="bold">t-lang="res_company.parter_id.lang"</strong> /&gt;
&lt;/template&gt;</pre>
			<p>The first record adds the <em class="italic">Native Language Book Catalog</em> report action, which uses the <code>library_app.book_catalog_native</code> template to render the report.</p>
			<p>The second record adds the report template. It is a single QWeb element that uses <code>t-call</code> to render the <code>book_catalog</code> template and <code>t-lang</code> to set the language to be used.</p>
			<p>The expression that's used to find the language<a id="_idIndexMarker1031"/> value is <code>res_company.parter_id.lang</code>. The <code>res_company</code> variable is one of the many that's available<a id="_idIndexMarker1032"/> in any report and is the active company. Companies have a related partner record, <code>partner_id</code>, and partners have a field to store the language in, called <code>lang</code>.</p>
			<p>The reports being worked<a id="_idIndexMarker1033"/> on are based on a record set, such as <code>Books</code>. But there are cases where the data to be used needs specific computation. The next section describes<a id="_idIndexMarker1034"/> options to handle these cases. </p>
			<p>After completing this step, the final book catalog report example should look as follows:</p>
			<div><div><img src="img/Figure_12.3_B16119.jpg" alt="" width="1111" height="791"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.3 – The final book catalog report</p>
			<p>The essential elements for building<a id="_idIndexMarker1035"/> printable reports in Odoo were covered throughout this section. Going further, advanced reports can use specific logic to build<a id="_idIndexMarker1036"/> the data to be used in the report. The next section discusses how to do this. </p>
			<h1 id="_idParaDest-370"><a id="_idTextAnchor375"/>Creating custom reports</h1>
			<p>By default, a report is rendered<a id="_idIndexMarker1037"/> for the selected records and is available in the rendering context through the <code>docs</code> variable. In some cases, it is useful to prepare arbitrary data structures to be used in the report. This is possible using <strong class="bold">custom reports</strong>.</p>
			<p>A custom report can add whatever data that's needed to the report rendering context. This is done using an abstract model with a specific name, following the naming convention of <code>report.&lt;module&gt;.&lt;report-name&gt;</code>.</p>
			<p>This model<a id="_idIndexMarker1038"/> should implement a <code>_get_report_values()</code> method, which returns a dictionary with the variables to add to the rendering context.</p>
			<p>As an example, a <em class="italic">Books by Publisher</em> custom report will be added to the <em class="italic">Library</em> app. It will show the books that have been published by each publisher. The following screenshot shows an example of the report's output:</p>
			<div><div><img src="img/Figure_12.4_B16119.jpg" alt="" width="994" height="406"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.4 – Example of the Books by Publisher custom report</p>
			<p>The report will be available in the <em class="italic">Contacts</em> list. One or more partners can be selected, and the report will present the titles published by each, if any. It can also be run from the publisher's form, as shown in the following screenshot:</p>
			<div><div><img src="img/Figure_12.5_B16119.jpg" alt="" width="1171" height="676"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.5 – Print menu option for the Books by Publisher report</p>
			<p>This report implementation can be split into two steps. The first is the business logic for preparing the data to be used<a id="_idIndexMarker1039"/> by the report, while the second is the QWeb template for the report layout.</p>
			<p>The next section explains how to prepare the report data.</p>
			<h2 id="_idParaDest-371"><a id="_idTextAnchor376"/>Preparing custom report data </h2>
			<p>A custom report<a id="_idIndexMarker1040"/> can use data that's been prepared by specific business logic, instead of simply using the record set that's been selected by the user.</p>
			<p>This can be done using an abstract model while following a specific name convention, that implements a <code>_get_report_values()</code> method, to return a dictionary with the variables to be used by the report template.</p>
			<p>To implement this as a custom report, add the <code>reports/library_publisher_report.py</code> file with the following code:</p>
			<pre>from odoo import api, models
class PublisherReport(models.AbstractModel):
    _name = "report.library_app.publisher_report"
    @api.model
    def _get_report_values(self, docids, data=None):
        domain = [("publisher_id", "in", docids)]
        books = self.env["library.book"].search(domain)
        publishers = books.mapped("publisher_id")
        publisher_books = [
            (pub,
             books.filtered(lambda book: 
               book.publisher_id == pub))
            for pub in publishers
        ]
        docargs = {
            "publisher_books": publisher_books,
        }
        return docargs</pre>
			<p>For this file to be loaded<a id="_idIndexMarker1041"/> by the module, it is also necessary to do the following:</p>
			<ul>
				<li>Add the <code>reports/__init__.py</code> file with a <code>from . import library_publisher_report</code> line.</li>
				<li>Add a <code>from . import reports</code> line to the top of the <code>__init__.py</code> file.</li>
			</ul>
			<p>The model is an <code>AbstractModel</code>, meaning that it has no database representation and holds no data. The data to be used for rendering will be computed by specific business logic.</p>
			<p>The report template identifier name will be <code>publisher_report</code>, so the model name should be <code>report.library_app.publisher_report</code>.</p>
			<p>The model has an <code>@api.model</code> decorated method named <code>_get_report_values</code>. The <code>docids</code> argument is a list of the numeric IDs selected to print the report. The base model to run the report is <code>res.partner</code>, so these will be partner IDs.</p>
			<p>The method uses specific business logic to find the books from the selected publishers and groups them by publisher. The result is in the <code>publisher_books</code> variable, which is a list of pairs, along with the publisher records and a record set of book records; that is, <code>[(res.partner(1), library.book(1, 2, 3)]</code>.</p>
			<p><code>_get_report_values</code> returns a dictionary with a <code>publisher_books</code> key that returns this data structure. This key will be available as a variable in the report template and can be iterated in a loop.</p>
			<p>Now that the custom report data<a id="_idIndexMarker1042"/> has been prepared, the next step is to add the QWeb report template.</p>
			<h2 id="_idParaDest-372"><a id="_idTextAnchor377"/>Adding the report template </h2>
			<p>The next step is to create<a id="_idIndexMarker1043"/> the QWeb template that's used to render the report. This template is similar to what is done for regular reports. An XML file is needed, along with the report action and the report QWeb template. The only difference is that, instead of the <code>docs</code> context variable, this template will have context variables available as whatever key/values are returned by the <code>_get_report_values</code> method.</p>
			<p>To implement the report action and template, add the <code>reports/library_publisher_report.xml</code> file with the following code:</p>
			<pre>&lt;odoo&gt;
  &lt;record id="action_publisher_report" model=
    "ir.actions.report"&gt;
    <strong class="bold">&lt;field name="name"&gt;Books by Publisher&lt;/field&gt;</strong>
    <strong class="bold">&lt;field name="model"&gt;res.partner&lt;/field&gt;</strong>
    &lt;field name="report_type"&gt;qweb-pdf&lt;/field&gt;
    <strong class="bold">&lt;field name="report_name"&gt;</strong>
<strong class="bold">      library_app.publisher_report&lt;/field&gt;</strong>
    <strong class="bold">&lt;field name="binding_model_id" </strong>
<strong class="bold">      ref="base.model_res_partner" /&gt;</strong>
    &lt;field name="binding_type"&gt;report&lt;/field&gt;
  &lt;/record&gt;
  <strong class="bold">&lt;template id="publisher_report"&gt;</strong>
    &lt;t t-call="web.html_container"&gt;
      &lt;t t-call="web.external_layout"&gt;
        &lt;div class="page"&gt;
          &lt;div class="container"&gt;
            &lt;h1&gt;Books by Publisher&lt;/h1&gt;
            &lt;t t-out="res_company" /&gt;
            <strong class="bold">&lt;t t-foreach="publisher_books" t-as="group"&gt;</strong>
                <strong class="bold">&lt;h2 t-field="group[0].name" /&gt;</strong>
                &lt;ul&gt;
                  <strong class="bold">&lt;t t-foreach="group[1]" t-as="book"&gt;</strong>
                    &lt;li&gt;
                      &lt;b&gt;&lt;span t-field="book.name" /&gt;&lt;/b&gt;
                      &lt;span t-field="book.author_ids" /&gt;
                    &lt;/li&gt;
                  &lt;/t&gt;
                &lt;/ul&gt;
            &lt;/t&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/t&gt;
    &lt;/t&gt;
  &lt;/template&gt;
&lt;/odoo&gt;</pre>
			<p>The previous XML includes two records – one for adding the <em class="italic">Books by Publisher</em> report action and another for adding the <code>publisher_report</code> report template.</p>
			<p>When running this report, the report engine will try finding a <code>report.library_app.</code> <code>publisher_report</code> model. If it exists, as is the case here, the <code>_get_report_values()</code> method is used to add variables to the rendering context.</p>
			<p>The QWeb template can then use the <code>publisher_books</code> variable to access the added data. It is a list containing a <code>group[0]</code>, is the publisher record that's used<a id="_idIndexMarker1045"/> on the group header, while the second tuple element, <code>group[1]</code>, is the record set containing the published books, presented using a second for loop.</p>
			<p>Remember to also reference this XML file in the <code>__manifest__.py</code> module. Having done this, once the <code>library_app</code> module has been upgraded and the Odoo web browser page has been reloaded, you will have the <em class="italic">Books by Publisher</em> report available in the <code>Print</code> context menu, when records are selected in the <em class="italic">Contacts</em> list. </p>
			<p>Summary</p>
			<p>In this chapter, you learned about the essential techniques to create and add custom Odoo reports. Installing the recommended version of the <code>wkhtmltopdf</code> utility is important to ensure the reports are rendered correctly. You learned that reports are run through report actions, which provide the basic information needed to render them. These may include the paper format to be used and you now know how to do so.</p>
			<p>The next thing you learned about is report design, which can be implemented with QWeb templates. Knowledge of QWeb, HTML, and Bootstrap is needed for this, as you have been made aware of. In some cases, reports need specific business logic to prepare the data to use. For this, you learned how to create custom report models, along with the techniques to use them. </p>
			<p>Printable reports can be important parts of a business application, as they are often needed as a simple way to send information to external parties or to support physical processes in the warehouse or shop floor. This chapter provided you with the tools and techniques to implement this kind of requirement. Now, you can ensure that your business application doesn't fall short of your user's needs. </p>
			<p>In the next chapter, we will continue to use QWeb, this time to build website pages. Web controllers will also be explained, which allow richer features to be used on Odoo web pages.</p>
			<h1 id="_idParaDest-373"><a id="_idTextAnchor378"/>Further reading</h1>
			<p>This additional reference material complements the topics described in this chapter.</p>
			<p>Relevant Odoo official documentation:</p>
			<ul>
				<li>QWeb Reports: <a href="https://www.odoo.com/documentation/15.0/developer/reference/backend/reports.html%20">https://www.odoo.com/documentation/15.0/developer/reference/backend/reports.html</a></li>
				<li>QWeb Templates: <a href="https://www.odoo.com/documentation/15.0/developer/reference/frontend/qweb.html%20">https://www.odoo.com/documentation/15.0/developer/reference/frontend/qweb.html</a></li>
				<li>Bootstrap 4 official documentation: <a href="https://getbootstrap.com/docs/4.1%20">https://getbootstrap.com/docs/4.1</a></li>
			</ul>
			<p>Other relevant resources:</p>
			<ul>
				<li>The Odoo Community Association hosts a project dedicated to the enhanced report feature at https://github.com/OCA/reporting-engine.</li>
				<li>Bootstrap additional learning resources from Packt Publishing can be found at <a href="https://www.packtpub.com/tech/bootstrap">https://www.packtpub.com/tech/bootstrap</a>.</li>
			</ul>
		</div>
	</div></body></html>