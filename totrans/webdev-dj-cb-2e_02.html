<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Database Structure"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Database Structure</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using model mixins</li><li class="listitem" style="list-style-type: disc">Creating a model mixin with URL-related methods</li><li class="listitem" style="list-style-type: disc">Creating a model mixin to handle creation and modification dates</li><li class="listitem" style="list-style-type: disc">Creating a model mixin to take care of meta tags</li><li class="listitem" style="list-style-type: disc">Creating a model mixin to handle generic relations</li><li class="listitem" style="list-style-type: disc">Handling multilingual fields</li><li class="listitem" style="list-style-type: disc">Using migrations</li><li class="listitem" style="list-style-type: disc">Switching from South migrations to Django migrations</li><li class="listitem" style="list-style-type: disc">Changing a foreign key to the many-to-many field</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec26"/>Introduction</h1></div></div></div><p>When you start a new app, the first thing to do is create the models that represent your database structure. We are assuming that you have previously created Django apps or at least, you have read and understood the official Django tutorial. In this chapter, we will see a few interesting techniques that make your database structure consistent throughout different apps in your project. Then, we will see how to create custom model fields in order to handle internationalization of your data in the database. At the end of the chapter, we will see how to use migrations to change your database structure in the process of development.</p></div></div>
<div class="section" title="Using model mixins"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec27"/>Using model mixins</h1></div></div></div><p>In object-oriented<a class="indexterm" id="id75"/> languages, such as Python, a mixin class can be viewed as an interface with implemented features. When a model extends a mixin, it implements the interface and includes all its fields, properties, and methods. Mixins in Django models can be used when you want to reuse the generic functionalities in different models multiple times.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec75"/>Getting ready</h2></div></div></div><p>First, you will <a class="indexterm" id="id76"/>need to create reusable mixins. Some typical examples of mixins are given later in this chapter. A good place to keep your model mixins is in the <code class="literal">utils</code> module.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip08"/>Tip</h3><p>If you create a reusable app that you will share with others, keep the model mixins in the reusable app, for example, in the <code class="literal">base.py</code> file.</p></div></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec76"/>How to do it…</h2></div></div></div><p>Open the <code class="literal">models.py</code> file of any Django app, where you want to use the mixins and type the following code:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># demo_app/models.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.utils.encoding import python_2_unicode_compatible
from utils.models import UrlMixin
from utils.models import CreationModificationMixin
from utils.models import MetaTagsMixin

@python_2_unicode_compatible
class Idea(UrlMixin, CreationModificationMixin, MetaTagsMixin):
  title = models.CharField(_("Title"), max_length=200)
  content = models.TextField(_("Content"))

  class Meta:
    verbose_name = _("Idea")
    verbose_name_plural = _("Ideas")

  def __str__(self):
    return self.title</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec77"/>How it works…</h2></div></div></div><p>Django model inheritance supports three types of inheritance: abstract base classes, multi-table inheritance, and proxy models. Model mixins are abstract model classes with specified fields, properties, and methods. When you create a model such as <code class="literal">Idea</code>, as shown in the preceding example, it inherits all the features from <code class="literal">UrlMixin</code>, <code class="literal">CreationModificationMixin</code>, and <code class="literal">MetaTagsMixin</code>. All the fields of the abstract classes are<a class="indexterm" id="id77"/> saved in the same database table as the fields of the extending model. In the following recipes, you will learn how to define your model mixins.</p><p>Note that we are using the <code class="literal">@python_2_unicode_compatible</code> decorator for our <code class="literal">Idea</code> model. As you might remember from the <span class="emphasis"><em>Making your code compatible with both Python 2.7 and Python 3</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with Django 1.8">Chapter 1</a>, <span class="emphasis"><em>Getting Started with Django 1.8</em></span>, it's purpose is to make the <code class="literal">__str__()</code> method compatible with Unicode for both the following Python versions: 2.7 and 3.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec78"/>There's more…</h2></div></div></div><p>To learn more about the different types of model inheritance, refer to the official Django documentation available at <a class="ulink" href="https://docs.djangoproject.com/en/1.8/topics/db/models/#model-inheritance">https://docs.djangoproject.com/en/1.8/topics/db/models/#model-inheritance</a>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec79"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Making your code compatible with both Python 2.7 and Python 3</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with Django 1.8">Chapter 1</a>, <span class="emphasis"><em>Getting Started with Django 1.8</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin with URL-related methods recipe</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to handle creation and modification dates</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to take care of meta tags</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating a model mixin with URL-related methods"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec28"/>Creating a model mixin with URL-related methods</h1></div></div></div><p>For every model that has its own page, it is good practice to define the <code class="literal">get_absolute_url()</code> method. This method can be used in templates and also in the Django<a class="indexterm" id="id78"/> admin site to preview the saved <a class="indexterm" id="id79"/>object. However, <code class="literal">get_absolute_url()</code> is ambiguous as it returns the URL path instead of the full URL. In this recipe, we will see how to create a model mixin that allows you to define either the URL path or the full URL by default, generate the other out of the box, and take care of the <code class="literal">get_absolute_url()</code> method that is being set.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec80"/>Getting ready</h2></div></div></div><p>If you haven't done it yet, create the <code class="literal">utils</code> package to save your mixins. Then, create the <code class="literal">models.py</code> file in the <code class="literal">utils</code> package (alternatively, if you create a reusable app, put the mixins in the <code class="literal">base.py</code> file in your app).</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec81"/>How to do it…</h2></div></div></div><p>Execute<a class="indexterm" id="id80"/> the following steps one by <a class="indexterm" id="id81"/>one:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add the following content to the <code class="literal">models.py</code> file of your <code class="literal">utils</code> package:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># utils/models.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
import urlparse
from django.db import models
from django.contrib.sites.models import Site
from django.conf import settings

class UrlMixin(models.Model):
    """
    A replacement for get_absolute_url()
    Models extending this mixin should have 
    either get_url or get_url_path implemented.
    """
    class Meta:
        abstract = True

    def get_url(self):
        if hasattr(self.get_url_path, "dont_recurse"):
            raise NotImplementedError
        try:
            path = self.get_url_path()
        except NotImplementedError:
            raise
        website_url = getattr(
            settings, "DEFAULT_WEBSITE_URL",
 "http://127.0.0.1:8000"
        )
        return website_url + path
    get_url.dont_recurse = True

    def get_url_path(self):
        if hasattr(self.get_url, "dont_recurse"):
            raise NotImplementedError
        try:
            url = self.get_url()
        except NotImplementedError:
            raise
        bits = urlparse.urlparse(url)
        return urlparse.urlunparse(("", "") + bits[2:])
    get_url_path.dont_recurse = True

    def get_absolute_url(self):
        return self.get_url_path()</pre></div></li><li class="listitem">To<a class="indexterm" id="id82"/> use the mixin in <a class="indexterm" id="id83"/>your app, import it from the <code class="literal">utils</code> package, inherit the mixin in your model class, and define the <code class="literal">get_url_path()</code> method as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># demo_app/models.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.core.urlresolvers import reverse
from django.utils.encoding import \
    python_2_unicode_compatible

from utils.models import UrlMixin

@python_2_unicode_compatible
class Idea(UrlMixin):
    title = models.CharField(_("Title"), max_length=200)

    # …

    get_url_path(self):
        return reverse("idea_details", kwargs={
            "idea_id": str(self.pk),
        })</pre></div></li><li class="listitem">If you check this code in the staging or production environment or run a local server with a different IP or port than the defaults, set <code class="literal">DEFAULT_WEBSITE_URL</code> in your local settings (without the trailing slash), as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># settings.py</strong></span>
# …
DEFAULT_WEBSITE_URL = "http://www.example.com"</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec82"/>How it works…</h2></div></div></div><p>The <code class="literal">UrlMixin</code> class is an abstract model that has three methods: <code class="literal">get_url()</code>, <code class="literal">get_url_path()</code>, and <code class="literal">get_absolute_url()</code>. The <code class="literal">get_url()</code> or <code class="literal">get_url_path()</code> methods are expected to be overwritten in the extended model class, for example, <code class="literal">Idea</code>. You can define <code class="literal">get_url()</code>, which is the full URL of the object, and then <code class="literal">get_url_path()</code> will strip it to the path. You can also define <code class="literal">get_url_path()</code>, which is the absolute path of the object, and then <code class="literal">get_url()</code> will prepend the website URL to the beginning of the path. The <code class="literal">get_absolute_url()</code> method will mimic the <code class="literal">get_url_path()</code> method.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip09"/>Tip</h3><p>The rule of thumb is to always overwrite the <code class="literal">get_url_path()</code> method.</p></div></div><p>In the templates, use <code class="literal">&lt;a href="{{ idea.get_url_path }}"&gt;{{ idea.title }}&lt;/a&gt;</code> when you need a link of an<a class="indexterm" id="id84"/> object in the same website. Use <code class="literal">&lt;a href="{{ idea.get_url }}"&gt;{{ idea.title }}&lt;/a&gt;</code> for the links in e-mails, RSS feeds, or APIs.</p><p>The default <code class="literal">get_absolute_url()</code> method will be used in the Django model administration for the <span class="emphasis"><em>View on site</em></span> functionality and might also be used by some third-party Django apps.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec83"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using model mixins</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to handle creation and modification dates</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to take care of meta tags</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to handle generic relations</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating a model mixin to handle creation and modification dates"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec29"/>Creating a model mixin to handle creation and modification dates</h1></div></div></div><p>It is a common behavior to have timestamps in your models for the creation and modification<a class="indexterm" id="id85"/> of your model instances. In this recipe, we will see how to create a simple model mixin that saves the creation and modification dates and times for your model. Using such a mixin will ensure that all the models use the same field names for the timestamps and have the same behavior.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec84"/>Getting ready</h2></div></div></div><p>If you haven't done this yet, create the <code class="literal">utils</code> package to save your mixins. Then, create the <code class="literal">models.py</code> file in the <code class="literal">utils</code> package.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec85"/>How to do it…</h2></div></div></div><p>Open the <code class="literal">models.py</code> file<a class="indexterm" id="id86"/> of your <code class="literal">utils</code> package and insert the following content there:</p><div class="informalexample"><pre class="programlisting"># utils/models.py
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.utils.timezone import now as timezone_now

class CreationModificationDateMixin(models.Model):
  """
  Abstract base class with a creation and modification
  date and time
  """

  created = models.DateTimeField(
    _("creation date and time"),
    editable=False,
  )

  modified = models.DateTimeField(
    _("modification date and time"),
    null=True,
    editable=False,
  )

  def save(self, *args, **kwargs):
    if not self.pk:
      self.created = timezone_now()
    else:
      # To ensure that we have a creation data always,
      # we add this one
    if not self.created:
      self.created = timezone_now()

      self.modified = timezone_now()

      super(CreationModificationDateMixin, self).\
      save(*args, **kwargs)
    save.alters_data = True

  class Meta:
    abstract = True</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec86"/>How it works…</h2></div></div></div><p>The <code class="literal">CreationModificationDateMixin</code> class is an abstract model, which means that extending<a class="indexterm" id="id87"/> model classes will create all the fields in the same database table, that is, there will be no one-to-one relationships that make the table difficult to handle. This mixin has two date-time fields and the <code class="literal">save()</code> method that will be called when saving the extended model. The <code class="literal">save()</code> method checks whether the model has no primary key, which is the case of a new not-yet-saved instance. In this case, it sets the creation date to the current date and time. If the primary key exists, the modification date is set to the current date and time.</p><p>Alternatively, instead of the <code class="literal">save()</code> method, you can use the <code class="literal">auto_now_add</code> and <code class="literal">auto_now</code> attributes for the created and modified fields, which will add creation and modification timestamps automatically.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec87"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using model mixins</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to take care of meta tags</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to handle generic relations</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating a model mixin to take care of meta tags"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec30"/>Creating a model mixin to take care of meta tags</h1></div></div></div><p>If you want to<a class="indexterm" id="id88"/> optimize your site for search engines, you <a class="indexterm" id="id89"/>need to not only set the semantic markup for each page but also the appropriate meta tags. For maximum flexibility, you need to have a way to define specific meta tags for each object, which has its own page on your website. In this recipe, we will see how to create a model mixin for the fields and methods related to the meta tags.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec88"/>Getting ready</h2></div></div></div><p>As seen in the previous recipes, make sure that you have the <code class="literal">utils</code> package for your mixins. Open the <code class="literal">models.py</code> file from this package in your favorite editor.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec89"/>How to do it…</h2></div></div></div><p>Put<a class="indexterm" id="id90"/> the <a class="indexterm" id="id91"/>following content in the <code class="literal">models.py</code> file:</p><div class="informalexample"><pre class="programlisting"># utils/models.py
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.template.defaultfilters import escape
from django.utils.safestring import mark_safe

class MetaTagsMixin(models.Model):
  """
  Abstract base class for meta tags in the &lt;head&gt; section
  """
  meta_keywords = models.CharField(
    _("Keywords"),
    max_length=255,
    blank=True,
    help_text=_("Separate keywords by comma."),
  )
  meta_description = models.CharField(
    _("Description"),
    max_length=255,
    blank=True,
  )
  meta_author = models.CharField(
    _("Author"),
    max_length=255,
    blank=True,
  )
  meta_copyright = models.CharField(
    _("Copyright"),
    max_length=255,
    blank=True,
  )

  class Meta:
    abstract = True

    def get_meta_keywords(self):
      tag = ""
      if self.meta_keywords:
        tag = '&lt;meta name="keywords" content="%s" /&gt;\n' %\
          escape(self.meta_keywords)
      return mark_safe(tag)

    def get_meta_description(self):
      tag = ""
      if self.meta_description:
        tag = '&lt;meta name="description" content="%s" /&gt;\n' %\
          escape(self.meta_description)
      return mark_safe(tag)

    def get_meta_author(self):
      tag = ""
      if self.meta_author:
        tag = '&lt;meta name="author" content="%s" /&gt;\n' %\
          escape(self.meta_author)
      return mark_safe(tag)

    def get_meta_copyright(self):
      tag = ""
      if self.meta_copyright:
        tag = '&lt;meta name="copyright" content="%s" /&gt;\n' %\
          escape(self.meta_copyright)
      return mark_safe(tag)

    def get_meta_tags(self):
      return mark_safe("".join((
        self.get_meta_keywords(),
        self.get_meta_description(),
        self.get_meta_author(),
        self.get_meta_copyright(),
      )))</pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec90"/>How it works…</h2></div></div></div><p>This<a class="indexterm" id="id92"/> mixin adds four fields to the model that extends<a class="indexterm" id="id93"/> from it: <code class="literal">meta_keywords</code>, <code class="literal">meta_description</code>, <code class="literal">meta_author</code>, and <code class="literal">meta_copyright</code>. The methods to render the meta tags in HTML are also added.</p><p>If you use this mixin in a model such as <code class="literal">Idea</code>, which is shown in the first recipe of this chapter, then you can put the following in the <code class="literal">HEAD</code> section of your detail page template to render all the meta tags:</p><div class="informalexample"><pre class="programlisting">{{ idea.get_meta_tags }}</pre></div><p>You can also render a specific meta tag using the following line:</p><div class="informalexample"><pre class="programlisting">{{ idea.get_meta_description }}</pre></div><p>As you <a class="indexterm" id="id94"/>may have noticed from the code snippet, the<a class="indexterm" id="id95"/> rendered meta tags are marked as safe, that is, they are not escaped and we don't need to use the safe template filter. Only the values that come from the database are escaped in order to guarantee that the final HTML is well-formed.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec91"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using model mixins</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to handle creation and modification dates</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to handle generic relations</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Creating a model mixin to handle generic relations"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec31"/>Creating a model mixin to handle generic relations</h1></div></div></div><p>Besides <a class="indexterm" id="id96"/>normal database relationships <a class="indexterm" id="id97"/>such as a foreign-key relationship or many-to-many relationship, Django has a mechanism to relate a model to an instance of any other model. This concept is called generic relations. For each generic relation, there is a content type of the related model that is saved as well as the ID of the instance of this model.</p><p>In this recipe, we will see how to generalize the creation of generic relations in the model mixins.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec92"/>Getting ready</h2></div></div></div><p>For this recipe to work, you need to have the <code class="literal">contenttypes</code> app installed. It should be in the <code class="literal">INSTALLED_APPS</code> directory by default, as shown in the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># settings.py</strong></span>
INSTALLED_APPS = (
    # …
    "django.contrib.contenttypes",
)</pre></div><p>Again, make sure that you have the <code class="literal">utils</code> package for your model mixins already created.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec93"/>How to do it…</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open<a class="indexterm" id="id98"/> the <code class="literal">models.py</code> file in the<a class="indexterm" id="id99"/> <code class="literal">utils</code> package in a text editor and insert the following content there:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># utils/models.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.contrib.contenttypes.models import ContentType
from django.contrib.contenttypes import generic
from django.core.exceptions import FieldError


def object_relation_mixin_factory(
  prefix=None,
  prefix_verbose=None,
  add_related_name=False,
  limit_content_type_choices_to={},
  limit_object_choices_to={},
  is_required=False,
):
  """
    returns a mixin class for generic foreign keys using
    "Content type - object Id" with dynamic field names.
    This function is just a class generator

    Parameters:
    prefix : a prefix, which is added in front of the fields
    prefix_verbose :    a verbose name of the prefix, used to
                        generate a title for the field column
                        of the content object in the Admin.
    add_related_name :  a boolean value indicating, that a
                        related name for the generated content
                        type foreign key should be added. This
                        value should be true, if you use more
                        than one ObjectRelationMixin in your model.

    The model fields are created like this:

    &lt;&lt;prefix&gt;&gt;_content_type :   Field name for the "content type"
    &lt;&lt;prefix&gt;&gt;_object_id :      Field name for the "object Id"
    &lt;&lt;prefix&gt;&gt;_content_object : Field name for the "content object"

    """
    p = ""
    if prefix:
      p = "%s_" % prefix

    content_type_field = "%scontent_type" % p
    object_id_field = "%sobject_id" % p
    content_object_field = "%scontent_object" % p


    class TheClass(models.Model):
      class Meta:
        abstract = True

    if add_related_name:
      if not prefix:
        raise FieldError("if add_related_name is set to True,"
          "a prefix must be given")
        related_name = prefix
    else:
      related_name = None


    optional = not is_required

    ct_verbose_name = (
      _("%s's type (model)") % prefix_verbose
      if prefix_verbose
      else _("Related object's type (model)")
    )

    content_type = models.ForeignKey(
      ContentType,
      verbose_name=ct_verbose_name,
      related_name=related_name,
      blank=optional,
      null=optional,
      help_text=_("Please select the type (model) for the relation, you want to build."),
      limit_choices_to=limit_content_type_choices_to,
    )

    fk_verbose_name = (prefix_verbose or _("Related object"))

    object_id = models.CharField(
      fk_verbose_name,
      blank=optional,
      null=False,
      help_text=_("Please enter the ID of the related object."),
      max_length=255,
      default="",  # for south migrations
    )
    object_id.limit_choices_to = limit_object_choices_to
    # can be retrieved by 
    # MyModel._meta.get_field("object_id").limit_choices_to

    content_object = generic.GenericForeignKey(
      ct_field=content_type_field,
      fk_field=object_id_field,
    )

    TheClass.add_to_class(content_type_field, content_type)
    TheClass.add_to_class(object_id_field, object_id)
    TheClass.add_to_class(content_object_field, content_object)

    return TheClass</pre></div></li><li class="listitem">The<a class="indexterm" id="id100"/> following is an example <a class="indexterm" id="id101"/>of how to use two generic relationships in your app (put this code in <code class="literal">demo_app/models.py</code>), as shown in the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># demo_app/models.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import nicode_literals
from django.db import models
from utils.models import object_relation_mixin_factory
from django.utils.encoding import python_2_unicode_compatible

FavoriteObjectMixin = object_relation_mixin_factory(
    is_required=True,
)

OwnerMixin = object_relation_mixin_factory(
    prefix="owner",
    prefix_verbose=_("Owner"),
    add_related_name=True,
    limit_content_type_choices_to={
        'model__in': ('user', 'institution')
    },
    is_required=True,
)

@python_2_unicode_compatible
class Like(FavoriteObjectMixin, OwnerMixin):
    class Meta:
        verbose_name = _("Like")
        verbose_name_plural = _("Likes")

    def __str__(self):
        return _("%(owner)s likes %(obj)s") % {
            "owner": self.owner_content_object,
            "obj": self.content_object,
        }</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec94"/>How it works…</h2></div></div></div><p>As you<a class="indexterm" id="id102"/> can see, this snippet is more complex<a class="indexterm" id="id103"/> than the previous ones. The <code class="literal">object_relation_mixin_factory</code> object is not a mixin itself; it is a function that generates a model mixin, that is, an abstract model class to extend from. The dynamically created mixin adds the <code class="literal">content_type</code> and <code class="literal">object_id</code> fields and the <code class="literal">content_object</code> generic foreign key that points to the related instance.</p><p>Why couldn't we just define a simple model mixin with these three attributes? A dynamically generated abstract class allows us to have prefixes for each field name; therefore, we can have more than one generic relation in the same model. For example, the <code class="literal">Like</code> model, which was shown previously, will have the <code class="literal">content_type</code>, <code class="literal">object_id</code>, and <code class="literal">content_object</code> fields for the favorite object and <code class="literal">owner_content_type</code>, <code class="literal">owner_object_id</code>, and <code class="literal">owner_content_object</code> for the one (user or institution) who liked the object.</p><p>The <code class="literal">object_relation_mixin_factory()</code> function adds a possibility to limit the content type choices by the <code class="literal">limit_content_type_choices_to</code> parameter. The preceding example<a class="indexterm" id="id104"/> limits the choices for <code class="literal">owner_content_type</code> only to the content types of the <code class="literal">User</code> and <code class="literal">Institution</code> models. Also, there <a class="indexterm" id="id105"/>is the <code class="literal">limit_object_choices_to</code> parameter that can be used by custom form validation to limit the generic relations only to specific objects, for example, the objects with published status.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec95"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin with URL-related methods</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to handle creation and modification dates</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to take care of meta tags</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Implementing the Like widget</em></span> recipe in <a class="link" href="ch04.html" title="Chapter 4. Templates and JavaScript">Chapter 4</a>, <span class="emphasis"><em>Templates and JavaScript</em></span></li></ul></div></div></div>
<div class="section" title="Handling multilingual fields"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec32"/>Handling multilingual fields</h1></div></div></div><p>Django uses the internationalization mechanism to translate verbose strings in the code and templates. However, it's up to the developer to decide how to implement the multilingual<a class="indexterm" id="id106"/> content in the models. There are several third-party modules that handle translatable model fields; however, I prefer the simple solution that will be introduced to you in this recipe.</p><p>The advantages of the approach that you will learn about are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">It is straightforward to define multilingual fields in the database</li><li class="listitem" style="list-style-type: disc">It is simple to use the multilingual fields in database queries</li><li class="listitem" style="list-style-type: disc">You can use contributed administration to edit models with the multilingual fields without additional modifications</li><li class="listitem" style="list-style-type: disc">If you need it, you can easily show all the translations of an object in the same template</li><li class="listitem" style="list-style-type: disc">You can use database migrations to add or remove languages</li></ul></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec96"/>Getting ready</h2></div></div></div><p>Do you have the <code class="literal">utils</code> package created? You will now need a new <code class="literal">fields.py</code> file for the custom model fields there.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec97"/>How to do it…</h2></div></div></div><p>Execute the following steps to define the multilingual character field and multilingual text field:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open<a class="indexterm" id="id107"/> the <code class="literal">fields.py</code> file and create the multilingual character field as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># utils/fields.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.conf import settings
from django.db import models
from django.utils.translation import get_language
from django.utils.translation import string_concat

class MultilingualCharField(models.CharField):

  def __init__(self, verbose_name=None, **kwargs):

    self._blank = kwargs.get("blank", False)
    self._editable = kwargs.get("editable", True)

    super(MultilingualCharField, self).\
      __init__(verbose_name, **kwargs)

  def contribute_to_class(self, cls, name,
    virtual_only=False):
    # generate language specific fields dynamically
    if not cls._meta.abstract:
      for lang_code, lang_name in settings.LANGUAGES:
        if lang_code == settings.LANGUAGE_CODE:
          _blank = self._blank
        else:
          _blank = True

        localized_field = models.CharField(
          string_concat(self.verbose_name, 
            " (%s)" % lang_code),
              name=self.name,
                primary_key=self.primary_key,
                max_length=self.max_length,
                unique=self.unique,
                blank=_blank,
                null=False,
                # we ignore the null argument!
                db_index=self.db_index,
                rel=self.rel,
                default=self.default or "",
                editable=self._editable,
                serialize=self.serialize,
                choices=self.choices,
                help_text=self.help_text,
                db_column=None,
                db_tablespace=self.db_tablespace
        )
        localized_field.contribute_to_class(
          cls,
          "%s_%s" % (name, lang_code),
        )

        def translated_value(self):
          language = get_language()
          val = self.__dict__["%s_%s" % (name, language)]
          if not val:
            val = self.__dict__["%s_%s" % \
              (name, settings.LANGUAGE_CODE)]
              return val

      setattr(cls, name, property(translated_value))</pre></div></li><li class="listitem">In the <a class="indexterm" id="id108"/>same file, add an analogous multilingual text field. The differing parts are highlighted in the following code:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>class MultilingualTextField(models.TextField):</strong></span>

  def __init__(self, verbose_name=None, **kwargs):

    self._blank = kwargs.get("blank", False)
    self._editable = kwargs.get("editable", True)

    super(<span class="strong"><strong>MultilingualTextField</strong></span>, self).\
      __init__(verbose_name, **kwargs)

    def contribute_to_class(self, cls, name, virtual_only=False):
      # generate language specific fields dynamically
      if not cls._meta.abstract:
        for lang_code, lang_name in settings.LANGUAGES:
          if lang_code == settings.LANGUAGE_CODE:
            _blank = self._blank
          else:
            _blank = True

            localized_field = <span class="strong"><strong>models.TextField</strong></span>(
              string_concat(self.verbose_name, 
                " (%s)" % lang_code),
              name=self.name,
              primary_key=self.primary_key,
              max_length=self.max_length,
              unique=self.unique,
              blank=_blank,
              null=False,
              # we ignore the null argument!
              db_index=self.db_index,
              rel=self.rel,
              default=self.default or "",
              editable=self._editable,
              serialize=self.serialize,
              choices=self.choices,
              help_text=self.help_text,
              db_column=None,
              db_tablespace=self.db_tablespace
            )
            localized_field.contribute_to_class(
              cls,
                "%s_%s" % (name, lang_code),
            )

        def translated_value(self):
          language = get_language()
          val = self.__dict__["%s_%s" % (name, language)]
          if not val:
            val = self.__dict__["%s_%s" % \
              (name, settings.LANGUAGE_CODE)]
            return val

        setattr(cls, name, property(translated_value))</pre></div></li></ol></div><p>Now, we'll <a class="indexterm" id="id109"/>consider an example of how to use the multilingual fields in your app, as shown in the following:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, set multiple languages in your settings:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># myproject/settings.py</strong></span>
# -*- coding: UTF-8 -*-
# …
LANGUAGE_CODE = "en"

LANGUAGES = (
    ("en", "English"),
    ("de", "Deutsch"),
    ("fr", "Français"),
    ("lt", "Lietuvi kalba"),
)</pre></div></li><li class="listitem">Then, create<a class="indexterm" id="id110"/> the multilingual fields for your model, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># demo_app/models.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.utils.encoding import \
    python_2_unicode_compatible

from utils.fields import MultilingualCharField
from utils.fields import MultilingualTextField

@python_2_unicode_compatible
class Idea(models.Model):
<span class="strong"><strong>    title = MultilingualCharField(</strong></span>
<span class="strong"><strong>        _("Title"),</strong></span>
<span class="strong"><strong>        max_length=200,</strong></span>
<span class="strong"><strong>    )</strong></span>
<span class="strong"><strong>    description = MultilingualTextField(</strong></span>
<span class="strong"><strong>        _("Description"),</strong></span>
<span class="strong"><strong>        blank=True,</strong></span>
<span class="strong"><strong>    )</strong></span>

    class Meta:
        verbose_name = _("Idea")
        verbose_name_plural = _("Ideas")

    def __str__(self):
        return self.title</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec98"/>How it works…</h2></div></div></div><p>The example of <code class="literal">Idea</code> will create a model that is similar to the following:</p><div class="informalexample"><pre class="programlisting">class Idea(models.Model):
  title_en = models.CharField(
    _("Title (en)"),
    max_length=200,
  )
  title_de = models.CharField(
    _("Title (de)"),
    max_length=200,
    blank=True,
  )
  title_fr = models.CharField(
    _("Title (fr)"),
    max_length=200,
    blank=True,
  )
  title_lt = models.CharField(
    _("Title (lt)"),
    max_length=200,
    blank=True,
  )
  description_en = models.TextField(
    _("Description (en)"),
    blank=True,
  )
  description_de = models.TextField(
    _("Description (de)"),
    blank=True,
  )
  description_fr = models.TextField(
    _("Description (fr)"),
    blank=True,
  )
  description_lt = models.TextField(
    _("Description (lt)"),
    blank=True,
  )</pre></div><p>In addition<a class="indexterm" id="id111"/> to this, there will be two properties: <code class="literal">title</code> and <code class="literal">description</code> that will return the title and description in the currently active language.</p><p>The <code class="literal">MultilingualCharField</code> and <code class="literal">MultilingualTextField</code> fields will juggle the model fields dynamically, depending on your <code class="literal">LANGUAGES</code> setting. They will overwrite the <code class="literal">contribute_to_class()</code> method that is used when the Django framework creates the model classes. The multilingual fields dynamically add character or text fields for each language of the project. Also, the properties are created in order to return the translated value of the currently active language or the main language by default.</p><p>For example, you can have the following in the template:</p><div class="informalexample"><pre class="programlisting">&lt;h1&gt;{{ idea.title }}&lt;/h1&gt;
&lt;div&gt;{{ idea.description|urlize|linebreaks }}&lt;/div&gt;</pre></div><p>This will <a class="indexterm" id="id112"/>show the text in English, German, French, or Lithuanian, depending on the currently selected language. However, it will fall back to English if the translation doesn't exist.</p><p>Here is another example. If you want to have your <code class="literal">QuerySet</code> ordered by the translated titles in the view, you can define it as follows:</p><div class="informalexample"><pre class="programlisting">qs = Idea.objects.order_by("title_%s" % request.LANGUAGE_CODE)</pre></div></div></div>
<div class="section" title="Using migrations"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec33"/>Using migrations</h1></div></div></div><p>It is not true that once you have created your database structure, it won't change in the future. As development happens iteratively, you can get updates on the business requirements in the development process and you will need to perform database schema changes<a class="indexterm" id="id113"/> along the way. With the Django migrations, you don't need to change the database tables and fields manually, as most of it is done automatically using the command-line interface.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec99"/>Getting ready</h2></div></div></div><p>Activate your virtual environment in the command-line tool.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec100"/>How to do it…</h2></div></div></div><p>To create the database migrations, take a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">When you create models in your new <code class="literal">demo_app</code> app, you need to create an initial migration that will create the database tables for your app. This can be done using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py makemigrations demo_app</strong></span>
</pre></div></li><li class="listitem">The first time that you want to create all the tables for your project, run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py migrate</strong></span>
</pre></div><p>It executes the usual database synchronization for all apps that have no database migrations, and in addition to this, it migrates all apps that have the migrations set. Also, run this command when you want to execute the new migrations for all your apps.</p></li><li class="listitem">If you want to execute the migrations for a specific app, run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py migrate demo_app</strong></span>
</pre></div></li><li class="listitem">If you make some changes in the database schema, you have to create a migration for that schema. For example, if we add a new subtitle field to the <code class="literal">Idea</code> model, we can create the migration using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py makemigrations --name \</strong></span>
<span class="strong"><strong>subtitle_added demo_app</strong></span>
</pre></div></li><li class="listitem">To create a <a class="indexterm" id="id114"/>data migration that modifies the data in the database table, we can use the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py makemigrations --empty \ --name populate_subtitle demo_app</strong></span>
</pre></div><p>This creates a skeleton data migration, which you need to modify and add data manipulation to it before applying.</p></li><li class="listitem">To list all the available applied and unapplied migrations, run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py migrate --list</strong></span>
</pre></div><p>The applied migrations will be listed with a <code class="literal">[X]</code> prefix.</p></li><li class="listitem">To list all the available migrations for a specific app, run the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py migrate --list demo_app</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec101"/>How it works…</h2></div></div></div><p>Django migrations are instruction files for the database migration mechanism. The instruction files inform us which database tables to create or remove; which fields to add or remove; and which data to insert, update, or delete.</p><p>There are two types <a class="indexterm" id="id115"/>of migrations in Django. One is schema<a class="indexterm" id="id116"/> migration and the other is data migration. Schema migration<a class="indexterm" id="id117"/> should be created when you add new models, or add <a class="indexterm" id="id118"/>or remove fields. Data migration should be used when you want to fill the database with some values or massively delete values from the database. Data migrations should be created using a command in the command-line tool and then programmed in the migration file. Migrations for each app are saved in their <code class="literal">migrations</code> directories. The first migration will be usually called <code class="literal">0001_initial.py</code>, and the other migrations in our example app will be called <code class="literal">0002_subtitle_added.py</code> and <code class="literal">0003_populate_subtitle.py</code>. Each migration gets a number prefix that is automatically incremented. For each migration that is executed, there is an entry that is saved in the <code class="literal">django_migrations</code> database table.</p><p>It is possible to migrate back and forth by specifying the number of the migration to which we want to migrate to, as shown in the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py migrate demo_app 0002</strong></span>
</pre></div><p>If you want to<a class="indexterm" id="id119"/> undo all the migrations for a specific app, you can do so using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py migrate demo_app zero</strong></span>
</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>Do not commit your migrations to version control until you have tested the forward and backward migration process and you are sure that they will work well in other development and public website environments.</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec102"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Handling project dependencies with pip and Including external dependencies in your project</em></span> recipes in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with Django 1.8">Chapter 1</a>, <span class="emphasis"><em>Getting Started with Django 1.8</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Changing a foreign key to the many-to-many field</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Switching from South migrations to Django migrations"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec34"/>Switching from South migrations to Django migrations</h1></div></div></div><p>If you, like<a class="indexterm" id="id120"/> me, have been using Django<a class="indexterm" id="id121"/> since before database migrations existed in the core functionality, that is, before Django 1.7; you have, more than likely, used third-party South migrations before. In this recipe, you will learn how to switch your project from South migrations to Django migrations.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec103"/>Getting ready</h2></div></div></div><p>Make sure that all apps and their South migrations are up to date.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec104"/>How to do it…</h2></div></div></div><p>Execute the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Migrate all your apps to the latest South migrations, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py migrate</strong></span>
</pre></div></li><li class="listitem">Remove <code class="literal">south</code> from <code class="literal">INSTALLED_APPS</code> in the settings.</li><li class="listitem">For each app with South migrations, delete the migration files and only leave the <code class="literal">migrations</code> directories.</li><li class="listitem">Create new migration files with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(my_project)$ python manage.py makemigrations</strong></span>
</pre></div></li><li class="listitem">Fake the initial Django migrations as the database schema has already been set correctly:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(my_project)$ python manage.py migrate --fake-initial</strong></span>
</pre></div></li><li class="listitem">If you have any circular foreign keys in the apps (that is, two models in different apps pointing to each other with a foreign key or many-to-many relation), separately apply the fake initial migrations to these apps:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(my_project)$ python manage.py migrate --fake-initial demo_app</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec105"/>How it works…</h2></div></div></div><p>There is <a class="indexterm" id="id122"/>no conflict in the database <a class="indexterm" id="id123"/>when switching to the new way of dealing with the database schema changes as the South migration history is saved in the <code class="literal">south_migrationhistory</code> database table; whereas, the Django migration history is saved in the <code class="literal">django_migrations</code> database table. The only problem are the migration files that have different syntax and, therefore, the South migrations need to be completely replaced with the Django migrations.</p><p>Therefore, at first, we delete the South migration files. Then, the <code class="literal">makemigrations</code> command recognizes the empty <code class="literal">migrations</code> directories and creates new initial Django migrations for each app. Once these migrations are faked, the further Django migrations can be created and applied.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec106"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using migrations</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Changing a foreign key to the many-to-many field</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Changing a foreign key to the many-to-many field"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec35"/>Changing a foreign key to the many-to-many field</h1></div></div></div><p>This recipe is <a class="indexterm" id="id124"/>a practical example of how to <a class="indexterm" id="id125"/>change a many-to-one relation to many-to-many relation, while preserving the already existing data. We will use both schema and data migrations for this situation.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec107"/>Getting ready</h2></div></div></div><p>Let's consider that you have the <code class="literal">Idea</code> model with a foreign key pointing to the <code class="literal">Category</code> model, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># demo_app/models.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.utils.encoding import python_2_unicode_compatible

@python_2_unicode_compatible
class Category(models.Model):
    title = models.CharField(_("Title"), max_length=200)

    def __str__(self):
        return self.title

@python_2_unicode_compatible
class Idea(models.Model):
    title = model.CharField(_("Title"), max_length=200)
<span class="strong"><strong>    category = models.ForeignKey(Category,</strong></span>
<span class="strong"><strong>        verbose_name=_("Category"), null=True, blank=True)</strong></span>

    def __str__(self):
        return self.title</pre></div><p>The<a class="indexterm" id="id126"/> initial migration should be created <a class="indexterm" id="id127"/>and executed using the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py makemigrations demo_app</strong></span>
<span class="strong"><strong>(myproject_env)$ python manage.py migrate demo_app</strong></span>
</pre></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec108"/>How to do it…</h2></div></div></div><p>The following steps will teach you how to switch from a foreign key relation to many-to-many relation, while preserving the already existing data:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add a new many-to-many field called <code class="literal">categories</code>, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># demo_app/models.py</strong></span>
@python_2_unicode_compatible
class Idea(models.Model):
    title = model.CharField(_("Title"), max_length=200)
    category = models.ForeignKey(Category,
        verbose_name=_("Category"),
        null=True,
        blank=True,
    )
<span class="strong"><strong>    categories = models.ManyToManyField(Category, </strong></span>
<span class="strong"><strong>        verbose_name=_("Categories"),</strong></span>
<span class="strong"><strong>        blank=True, </strong></span>
<span class="strong"><strong>        related_name="ideas",</strong></span>
<span class="strong"><strong>    )</strong></span>
</pre></div></li><li class="listitem">Create <a class="indexterm" id="id128"/>and run a schema <a class="indexterm" id="id129"/>migration in order to add the new field to the database, as shown in the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py makemigrations demo_app \</strong></span>
<span class="strong"><strong>--name categories_added</strong></span>
<span class="strong"><strong>(myproject_env)$ python manage.py migrate demo_app</strong></span>
</pre></div></li><li class="listitem">Create a data migration to copy categories from the foreign key to the many-to-many field, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py makemigrations --empty \</strong></span>
<span class="strong"><strong>--name copy_categories demo_app</strong></span>
</pre></div></li><li class="listitem">Open the newly created migration file (<code class="literal">demo_app/migrations/0003_copy_categories.py</code>) and define the forward migration instructions, as shown in the following:<div class="informalexample"><pre class="programlisting"># demo_app/migrations/0003_copy_categories.py
# -*- coding: utf-8 -*-
from __future__ import unicode_literals
from django.db import models, migrations

def copy_categories(apps, schema_editor):
    Idea = apps.get_model("demo_app", "Idea")
    for idea in Idea.objects.all():
        if idea.category:
            idea.categories.add(idea.category)

class Migration(migrations.Migration):

    dependencies = [
        ('demo_app', '0002_categories_added'),
    ]

    operations = [
        migrations.RunPython(copy_categories),
    ]</pre></div></li><li class="listitem">Run the following data migration:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py migrate demo_app</strong></span>
</pre></div></li><li class="listitem">Delete<a class="indexterm" id="id130"/> the foreign key<a class="indexterm" id="id131"/> field <code class="literal">category</code> in the <code class="literal">models.py</code> file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># demo_app/models.py</strong></span>
@python_2_unicode_compatible
class Idea(models.Model):
    title = model.CharField(_("Title"), max_length=200)
    categories = models.ManyToManyField(Category,
        verbose_name=_("Categories"),
        blank=True,
        related_name="ideas",
    )</pre></div></li><li class="listitem">Create and run a schema migration in order to delete the categories field from the database table, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py schemamigration \</strong></span>
<span class="strong"><strong>--name delete_category demo_app</strong></span>
<span class="strong"><strong>(myproject_env)$ python manage.py migrate demo_app</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec109"/>How it works…</h2></div></div></div><p>At first, we add a new many-to-many field to the <code class="literal">Idea</code> model. Then, we copy the existing relations from a foreign key relation to the many-to-many relation. Lastly, we remove the foreign key relation.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec110"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using migrations</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Switching from South migrations to Django migrations</em></span> recipe</li></ul></div></div></div></body></html>