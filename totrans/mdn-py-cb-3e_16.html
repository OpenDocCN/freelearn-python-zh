<html><head></head><body>
<section data-number="0.19" id="chapter-16-dependencies-and-virtual-environments">
<h2 class="likechapterhead" data-number="0.19"><span><span class="kobospan" id="kobo.1.1">16</span></span><br class="tipbox1"/> <span id="x1-86400016"/><span class="kobospan" id="kobo.2.1">Dependencies and Virtual Environments</span></h2>
<p class="normal"><span class="kobospan" id="kobo.3.1">Python runs in an environment defined by the OS. </span><span class="kobospan" id="kobo.3.2">There are some slight differences between Windows, macOS, and most Linux environments. </span><span class="kobospan" id="kobo.3.3">We’ll set aside micro-controller environments, since the ability to tailor those environments is quite a bit more involved. </span><span class="kobospan" id="kobo.3.4">We’ll try to minimize the OS differences to focus on the common aspects that are universally available.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.4.1">There are several common aspects within run-time environments. </span><span class="kobospan" id="kobo.4.2">We can divide these into two groups:</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.5.1">Persistent</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.6.1">Aspects of the environment</span><span id="dx1-864001"/><span class="kobospan" id="kobo.7.1"> that change slowly.</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.8.1">The Python run-time in use. </span><span class="kobospan" id="kobo.8.2">This includes a binary application and often includes a number of external libraries.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.9.1">The standard libraries available. </span><span class="kobospan" id="kobo.9.2">These are accessed via the importer, and are generally available via the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.10.1">import</span></span></span></span><span class="kobospan" id="kobo.11.1"> statement. </span><span class="kobospan" id="kobo.11.2">They are generally found by their path, relative to the Python binary.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.12.1">The other libraries installed as </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.13.1">site packages</span></span><span class="kobospan" id="kobo.14.1">. </span><span class="kobospan" id="kobo.14.2">These are also accessed by the importer. </span><span class="kobospan" id="kobo.14.3">These libraries are also found by their path, relative to the Python binary.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.15.1">Libraries found by other mechanisms</span><span id="dx1-864002"/><span class="kobospan" id="kobo.16.1"> available in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.17.1">sites</span></span></span></span><span class="kobospan" id="kobo.18.1"> package. </span><span class="kobospan" id="kobo.18.2">Most notably, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.19.1">PYTHONPATH</span></span></span></span><span class="kobospan" id="kobo.20.1"> environment variable.</span></p></li>
</ul>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.21.1">Transient</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.22.1">Aspects of the environment</span><span id="dx1-864003"/><span class="kobospan" id="kobo.23.1"> can change each time the Python run-time is started.</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.24.1">The environment variables defined by the shell in use. </span><span class="kobospan" id="kobo.24.2">These are available through the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.25.1">os</span></span></span></span><span class="kobospan" id="kobo.26.1"> module.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.27.1">The current working directory and user information, defined by the OS. </span><span class="kobospan" id="kobo.27.2">This is available through the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.28.1">os</span></span></span></span><span class="kobospan" id="kobo.29.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.30.1">os.path</span></span></span></span><span class="kobospan" id="kobo.31.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.32.1">pathlib</span></span></span></span><span class="kobospan" id="kobo.33.1"> modules.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.34.1">The command line used to start Python. </span><span class="kobospan" id="kobo.34.2">This is available through several attributes of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.35.1">sys</span></span></span></span><span class="kobospan" id="kobo.36.1"> module, including </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.37.1">sys.argv</span></span></span></span><span class="kobospan" id="kobo.38.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.39.1">sys.stdout</span></span></span></span><span class="kobospan" id="kobo.40.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.41.1">sys.stdin</span></span></span></span><span class="kobospan" id="kobo.42.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.43.1">sys.stderr</span></span></span></span><span class="kobospan" id="kobo.44.1">.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.45.1">The persistent environment is managed via OS-level commands, outside of our application programs. </span><span class="kobospan" id="kobo.45.2">Changes to the persistent aspects of the environment are generally examined once when Python starts. </span><span class="kobospan" id="kobo.45.3">This means an application we write can’t easily install a package and then use that package.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.46.1">The persistent environment has two viewpoints:</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.47.1">The Actual Environment</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.48.1">: A single site is handled</span><span id="dx1-864004"/><span class="kobospan" id="kobo.49.1"> by the system administrator and requires elevated privileges. </span><span class="kobospan" id="kobo.49.2">For example, the Python run-time is often in a path owned by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.50.1">root</span></span></span></span><span class="kobospan" id="kobo.51.1"> user and made visible through a common, system-wide value of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.52.1">PATH</span></span></span></span><span class="kobospan" id="kobo.53.1"> environment variable.</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.54.1">Virtual Environments</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.55.1">: Any number of virtual environments</span><span id="dx1-864005"/><span class="kobospan" id="kobo.56.1"> are localized by individual users and require no special privileges. </span><span class="kobospan" id="kobo.56.2">Multiple Python run-times and their associated site packages can be owned by a single user.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.57.1">Once upon a time — in the long-past olden days, when computer capabilities were tiny — a single actual environment was all that could be managed. </span><span class="kobospan" id="kobo.57.2">Adding and changing the collection of installed packages required cooperation among Python users. </span><span class="kobospan" id="kobo.57.3">An administrator with elevated privileges implemented any changes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.58.1">Now that computers are vastly more capable, each individual user can easily have multiple virtual environments. </span><span class="kobospan" id="kobo.58.2">Indeed, we often build and test modules with numerous virtual environments reflecting different releases of the Python run-time. </span><span class="kobospan" id="kobo.58.3">Each individual is able to manage their own virtual environments.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.59.1">When working cooperatively, it becomes important to share the details of virtual environments so that multiple users can recreate a common virtual environment. </span><span class="kobospan" id="kobo.59.2">The effort of sharing a single actual environment is shifted to each user having to prepare and manage their own virtual environment.</span></p>
<div class="tipbox" id="tcolobox-32">
<div class="note">
<p class="normal1"><span class="kobospan" id="kobo.60.1">Environment management seems to parallel Ginsberg’s Theorem and the Laws of Thermodynamics:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.61.1">The overall environment management workload is neither created nor destroyed.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.62.1">Any change to an environment requires work.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.63.1">Nothing is free from change (unless it’s utterly isolated from all external considerations).</span></p></li>
</ul>
</div>
</div>
<p class="normal1"><span class="kobospan" id="kobo.64.1">While most Linux distributions come with Python pre-installed, there’s no compelling reason to use this version of Python for any purpose. </span><span class="kobospan" id="kobo.64.2">It’s generally much easier to install a personal version of Python and manage virtual environments with that personal version. </span><span class="kobospan" id="kobo.64.3">Having an individual Python installation permits ready updates to new releases without waiting for a Linux distribution to catch up with the state of the art.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.65.1">There are two broad classes of tools involved in managing environments:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.66.1">OS-specific tools required to install</span><span id="dx1-864006"/><span class="kobospan" id="kobo.67.1"> the Python binary. </span><span class="kobospan" id="kobo.67.2">This varies by OS and can be challenging to new developers. </span><span class="kobospan" id="kobo.67.3">We’ll avoid the complications involved in these tools and refer</span><span id="dx1-864007"/><span class="kobospan" id="kobo.68.1"> readers to the </span><a class="url" href="https://www.python.org/downloads/"><span class="url1"><span class="kobospan" id="kobo.69.1">https://www.python.org/downloads/</span></span></a><span class="kobospan" id="kobo.70.1"> page.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.71.1">Python-based tools, like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.72.1">PIP</span></span><span class="kobospan" id="kobo.73.1">, used to install Python</span><span id="dx1-864008"/><span class="kobospan" id="kobo.74.1"> libraries. </span><span class="kobospan" id="kobo.74.2">Since these</span><span id="dx1-864009"/><span class="kobospan" id="kobo.75.1"> tools depend on Python, the commands are universal for all OSs. </span><span class="kobospan" id="kobo.75.2">This chapter will focus on these tools.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.76.1">In this chapter, we’ll look at the following recipes for managing virtual environments:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><a href="ch020_split_000.xhtml#x1-8650001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.77.1">Creating environments using the built-in venv</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch020_split_000.xhtml#x1-8730002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.78.1">Installing packages with a requirements.txt file</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch020_split_000.xhtml#x1-8790003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.79.1">Creating a pyproject.toml file</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch020_split_000.xhtml#x1-8850004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.80.1">Using pip-tools to manage the requirements.txt file</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch020_split_001.xhtml#x1-8910005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.81.1">Using Anaconda and the conda tool</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch020_split_001.xhtml#x1-8970006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.82.1">Using the poetry tool</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch020_split_001.xhtml#x1-9030007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.83.1">Coping with changes in dependencies</span></span></a></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.84.1">We’ll start with creating virtual environments using the built-in tools. </span><span id="x1-864010r1838"/></p>
<section data-number="0.19.1" id="creating-environments-using-the-built-in-venv">
<h1 class="unnumbered" data-number="0.19.1"><span><span class="kobospan" id="kobo.85.1">16.1 </span></span> <span id="x1-8650001"/><span class="kobospan" id="kobo.86.1">Creating environments using the built-in venv</span></h1>
<p class="normal"><span class="kobospan" id="kobo.87.1">Once Python is installed, creating</span><span id="dx1-865001"/><span class="kobospan" id="kobo.88.1"> virtual environments</span><span id="dx1-865002"/><span class="kobospan" id="kobo.89.1"> unique to each project can be done with the internal </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.90.1">venv</span></span></span></span><span class="kobospan" id="kobo.91.1"> module.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.92.1">There are two principle use cases for a virtual</span><span id="dx1-865003"/><span class="kobospan" id="kobo.93.1"> environment:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.94.1">Manage the Python version. </span><span class="kobospan" id="kobo.94.2">We might have distinct virtual environments for Python 3.12 and Python 3.13. </span><span class="kobospan" id="kobo.94.3">In some cases, we may need to manage multiple minor releases of Python 3.13.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.95.1">Manage the mix of site-specific packages required by our project. </span><span class="kobospan" id="kobo.95.2">Rather than trying to update the single actual environment, we can create new virtual environments as new releases of packages become available.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.96.1">These two use cases overlap a great deal. </span><span class="kobospan" id="kobo.96.2">Each release of Python will have distinct versions of the standard library packages and may have distinct versions of external site-specific packages.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.97.1">The most important part of using a virtual</span><span id="dx1-865004"/><span class="kobospan" id="kobo.98.1"> environment is making</span><span id="dx1-865005"/><span class="kobospan" id="kobo.99.1"> sure that it has been activated. </span><span class="kobospan" id="kobo.99.2">A number of scenarios will change the internal state of the browser, deactivating the virtual environment. </span><span class="kobospan" id="kobo.99.3">Closing a terminal window and rebooting the computer are two of the most common ways to deactivate an environment.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.100.1">Changing terminal windows or opening a new terminal window may start a shell environment in which the virtual environment is not active. </span><span class="kobospan" id="kobo.100.2">This is easily remedied by activating the environment before starting to use it. </span><span id="x1-865006r1836"/></p>
<section data-number="0.19.1.1" id="getting-ready-120">
<h2 class="likechapterhead" data-number="0.19.1.1"><span><span class="kobospan" id="kobo.101.1">16.1.1 </span></span> <span id="x1-8660001"/><span class="kobospan" id="kobo.102.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.103.1">It’s important to note that Python must be installed. </span><span class="kobospan" id="kobo.103.2">Python may not be present, and whatever Python version is part of the OS should not be used for development or experimentation. </span><span class="kobospan" id="kobo.103.3">For macOS and Windows, it’s common to install a pre-built binary. </span><span class="kobospan" id="kobo.103.4">This may involve downloading a disk image and running an installer or downloading an installer application and running it.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.104.1">For Linux, it’s common to build Python from source for the given distribution. </span><span class="kobospan" id="kobo.104.2">An alternative is to use</span><span id="dx1-866001"/><span class="kobospan" id="kobo.105.1"> an administrative</span><span id="dx1-866002"/><span class="kobospan" id="kobo.106.1"> tool like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.107.1">rpm</span></span><span class="kobospan" id="kobo.108.1">, </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.109.1">pkg</span></span><span class="kobospan" id="kobo.110.1">, </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.111.1">yum</span></span><span class="kobospan" id="kobo.112.1">, or </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.113.1">aptitude</span></span><span class="kobospan" id="kobo.114.1"> to install a pre-built Python</span><span id="dx1-866003"/><span class="kobospan" id="kobo.115.1"> for the</span><span id="dx1-866004"/><span class="kobospan" id="kobo.116.1"> specific distribution.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.117.1">Most Python releases will include the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.118.1">pip</span></span></span></span><span class="kobospan" id="kobo.119.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.120.1">venv</span></span></span></span><span class="kobospan" id="kobo.121.1"> packages. </span><span class="kobospan" id="kobo.121.2">Microcontroller Python and WASM-based Python are often difficult to update using desktop tools; they’re outside the scope of this book. </span><span id="x1-866005r1842"/></p>
</section>
<section data-number="0.19.1.2" id="how-to-do-it...-121">
<h2 class="likechapterhead" data-number="0.19.1.2"><span><span class="kobospan" id="kobo.122.1">16.1.2 </span></span> <span id="x1-8670002"/><span class="kobospan" id="kobo.123.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.124.1">First, we’ll look at creating a virtual environment that can be used to install packages and resolve imports. </span><span class="kobospan" id="kobo.124.2">Once the environment has been created, we’ll look at activating and deactivating it. </span><span class="kobospan" id="kobo.124.3">The environment must be active in order to properly install and use packages.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.125.1">It’s important to avoid putting a virtual environment under configuration control. </span><span class="kobospan" id="kobo.125.2">Instead, the configuration details required to recreate the environment are put under configuration control.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.126.1">When using</span><span id="dx1-867001"/><span class="kobospan" id="kobo.127.1"> tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.128.1">Git</span></span><span class="kobospan" id="kobo.129.1">, a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.130.1">.gitignore</span></span></span></span><span class="kobospan" id="kobo.131.1"> file can</span><span id="dx1-867002"/><span class="kobospan" id="kobo.132.1"> be used to ignore</span><span id="dx1-867003"/><span class="kobospan" id="kobo.133.1"> any virtual environment details of a project. </span><span class="kobospan" id="kobo.133.2">An alternative approach is to separate virtual environment definitions from specific project directories.</span></p>
<section data-number="0.19.1.2.1" id="create-a-virtual-environment">
<h3 class="likesubsubsectionhead" data-number="0.19.1.2.1"><span id="x1-8680002"/><span class="kobospan" id="kobo.134.1">Create a virtual environment</span></h3>
<ol class="calibre2">
<li class="calibre7"><div id="x1-868002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.135.1">First, create the project</span><span id="dx1-868003"/><span class="kobospan" id="kobo.136.1"> directory. </span><span class="kobospan" id="kobo.136.2">For very small projects, no additional files are needed. </span><span class="kobospan" id="kobo.136.3">For most projects, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.137.1">src</span></span></span></span><span class="kobospan" id="kobo.138.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.139.1">tests</span></span></span></span><span class="kobospan" id="kobo.140.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.141.1">docs</span></span></span></span><span class="kobospan" id="kobo.142.1"> directories are often helpful for organizing the project code, the test code, and the documentation.</span></p>
</div></li>
<li class="calibre7"><div id="x1-868005x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.143.1">Choose between a ”concealed” or a visible file. </span><span class="kobospan" id="kobo.143.2">In Linux and macOS, files with names that start with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.144.1">.</span></span></span></span><span class="kobospan" id="kobo.145.1"> are generally not shown by most commands. </span><span class="kobospan" id="kobo.145.2">Since the virtual environment is not a directory we’ll ever work with, it’s often simplest to use the name </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.146.1">.venv</span></span></span></span><span class="kobospan" id="kobo.147.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.148.1">In some cases, we want the directory to be visible. </span><span class="kobospan" id="kobo.148.2">Then, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.149.1">venv</span></span></span></span><span class="kobospan" id="kobo.150.1"> name would be the best choice.</span></p>
</div></li>
<li class="calibre7"><div id="x1-868007x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.151.1">The following command will create a virtual environment:</span></p>
<pre class="programlisting" id="listing-117"><code class="calibre13"><span class="kobospan" id="kobo.152.1">% python -m venv .venv</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.153.1">The virtual environment will be in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.154.1">.venv</span></span></span></span><span class="kobospan" id="kobo.155.1"> directory within the project directory.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.156.1">After this is done, the virtual environment must be activated. </span><span class="kobospan" id="kobo.156.2">Any time a new terminal window is opened, the environment in that window needs to be activated.</span></p>
</section>
<section data-number="0.19.1.2.2" id="activate-and-deactivate-an-environment">
<h3 class="likesubsubsectionhead" data-number="0.19.1.2.2"><span id="x1-8690002"/><span class="kobospan" id="kobo.157.1">Activate and deactivate an environment</span></h3>
<p class="normal"><span class="kobospan" id="kobo.158.1">Activating a virtual environment</span><span id="dx1-869001"/><span class="kobospan" id="kobo.159.1"> requires an OS-specific command. </span><span class="kobospan" id="kobo.159.2">The Python </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.160.1">Standard Library </span></span><span class="kobospan" id="kobo.161.1">documentation provides all of the variant commands. </span><span class="kobospan" id="kobo.161.2">We’ll show the two most common variants:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.162.1">For Linux and macOS, using </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.163.1">bash </span></span><span class="kobospan" id="kobo.164.1">or </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.165.1">zsh</span></span><span class="kobospan" id="kobo.166.1">, enter the following</span><span id="dx1-869002"/><span class="kobospan" id="kobo.167.1"> command to activate</span><span id="dx1-869003"/><span class="kobospan" id="kobo.168.1"> a virtual environment:</span></p>
<pre class="programlisting" id="listing-118"><code class="calibre13"><span class="kobospan" id="kobo.169.1">% source .venv/bin/activate</span></code></pre></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.170.1">For Windows, enter the following command</span><span id="dx1-869005"/><span class="kobospan" id="kobo.171.1"> to activate a virtual environment:</span></p>
<pre class="programlisting" id="listing-119"><code class="calibre13"><span class="kobospan" id="kobo.172.1">&gt; .venv\Scripts\activate</span></code></pre></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.173.1">Once the virtual environment</span><span id="dx1-869007"/><span class="kobospan" id="kobo.174.1"> has been activated, a number of environment variables will change. </span><span class="kobospan" id="kobo.174.2">Most notably, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.175.1">PATH</span></span></span></span><span class="kobospan" id="kobo.176.1"> environment variable will include the virtual environment’s </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.177.1">bin</span></span></span></span><span class="kobospan" id="kobo.178.1"> directory. </span><span class="kobospan" id="kobo.178.2">This will, for example, make the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.179.1">deactivate</span></span></span></span><span class="kobospan" id="kobo.180.1"> command available. </span><span class="kobospan" id="kobo.180.2">Additionally, the prompt will change to include the virtual environment’s name. </span><span class="kobospan" id="kobo.180.3">It might look like the following:</span></p>
<pre class="programlisting" id="listing-120"><code class="calibre13"><span class="kobospan" id="kobo.181.1">C:\Users\Administrator&gt;.venv\Scripts\activate 
 
(.venv) C:\Users\Administrator&gt;</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.182.1">On the first line, the default prompt shows the directory. </span><span class="kobospan" id="kobo.182.2">On the second line, the prompt has </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.183.1">(.venv)</span></span></span></span><span class="kobospan" id="kobo.184.1"> as a prefix to show that the virtual environment is now active.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.185.1">Once the virtual environment has been activated, all further use of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.186.1">pip</span></span></span></span><span class="kobospan" id="kobo.187.1"> command to install packages will be directed to the active environment. </span><span class="kobospan" id="kobo.187.2">Any Python application that’s run will search the active environment to install packages.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.188.1">To deactivate an environment, use the following command:</span></p>
<pre class="programlisting" id="listing-121"><code class="calibre13"><span class="kobospan" id="kobo.189.1">% deactivate</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.190.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.191.1">activate</span></span></span></span><span class="kobospan" id="kobo.192.1"> command created this new command as part of the virtual environment, so it’s universally available for all OSs. </span><span id="x1-869011r1843"/></p>
</section>
</section>
<section data-number="0.19.1.3" id="how-it-works...-121">
<h2 class="likechapterhead" data-number="0.19.1.3"><span><span class="kobospan" id="kobo.193.1">16.1.3 </span></span> <span id="x1-8700003"/><span class="kobospan" id="kobo.194.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.195.1">For most OSs, there are a few key environment</span><span id="dx1-870001"/><span class="kobospan" id="kobo.196.1"> variables that define</span><span id="dx1-870002"/><span class="kobospan" id="kobo.197.1"> a virtual environment. </span><span class="kobospan" id="kobo.197.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.198.1">PATH</span></span></span></span><span class="kobospan" id="kobo.199.1"> environment variable generally provides locations for finding the Python executable. </span><span class="kobospan" id="kobo.199.2">In a Windows environment, this will also make the launcher, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.200.1">py</span></span></span></span><span class="kobospan" id="kobo.201.1"> command, available.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.202.1">The locations of the remaining Python elements are all relative to the executable. </span><span class="kobospan" id="kobo.202.2">In particular, the standard library is an adjacent path, and this library has the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.203.1">sites</span></span></span></span><span class="kobospan" id="kobo.204.1"> package that handles all of the other details of locating installed packages.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.205.1">The details of the virtual environment are defined by three directories and a configuration file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.206.1">The configuration file, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.207.1">pyvenv.cfg</span></span></span></span><span class="kobospan" id="kobo.208.1">, provides a few important settings. </span><span class="kobospan" id="kobo.208.2">The three directories are </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.209.1">bin</span></span></span></span><span class="kobospan" id="kobo.210.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.211.1">include</span></span></span></span><span class="kobospan" id="kobo.212.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.213.1">lib</span></span></span></span><span class="kobospan" id="kobo.214.1">. </span><span class="kobospan" id="kobo.214.2">(For Windows, these names are </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.215.1">Scripts</span></span></span></span><span class="kobospan" id="kobo.216.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.217.1">Include</span></span></span></span><span class="kobospan" id="kobo.218.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.219.1">Lib</span></span></span></span><span class="kobospan" id="kobo.220.1">). </span><span class="kobospan" id="kobo.220.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.221.1">bin</span></span></span></span><span class="kobospan" id="kobo.222.1"> directory has script files that perform activation of the virtual environment. </span><span class="kobospan" id="kobo.222.2">Setting the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.223.1">PATH</span></span></span></span><span class="kobospan" id="kobo.224.1"> environment variable makes these scripts available. </span><span class="kobospan" id="kobo.224.2">This includes the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.225.1">deactivate</span></span></span></span><span class="kobospan" id="kobo.226.1"> command. </span><span class="kobospan" id="kobo.226.2">Additionally, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.227.1">bin</span></span></span></span><span class="kobospan" id="kobo.228.1"> directory contains a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.229.1">pip</span></span></span></span><span class="kobospan" id="kobo.230.1"> executable command and a link to the proper </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.231.1">python</span></span></span></span><span class="kobospan" id="kobo.232.1"> binary. </span><span id="x1-870003r1846"/></p>
</section>
<section data-number="0.19.1.4" id="theres-more...-112">
<h2 class="likechapterhead" data-number="0.19.1.4"><span><span class="kobospan" id="kobo.233.1">16.1.4 </span></span> <span id="x1-8710004"/><span class="kobospan" id="kobo.234.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.235.1">There are a number of options in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.236.1">venv</span></span></span></span><span class="kobospan" id="kobo.237.1"> command. </span><span class="kobospan" id="kobo.237.2">Of these, two seem to be particularly useful:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.238.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.239.1">--without-pip</span></span></span></span><span class="kobospan" id="kobo.240.1"> option skips the installation of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.241.1">venv</span></span></span></span><span class="kobospan" id="kobo.242.1">-specific copy of PIP. </span><span class="kobospan" id="kobo.242.2">It seems better to use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.243.1">python</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.244.1"> -m</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.245.1"> pip</span></span></span></span><span class="kobospan" id="kobo.246.1"> than to rely on the virtual environment installation.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.247.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.248.1">--prompt</span></span></span></span><span class="kobospan" id="kobo.249.1"> option can set a nicer environment name than </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.250.1">.venv</span></span></span></span><span class="kobospan" id="kobo.251.1">.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.252.1">We’ll often use a command like the following to activate an environment:</span></p>
<pre class="programlisting" id="listing-122"><code class="calibre13"><span class="kobospan" id="kobo.253.1">% python -m venv --prompt ch17 --without-pip .venv</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.254.1">This will ensure the prompt becomes </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.255.1">(ch17)</span></span></span></span><span class="kobospan" id="kobo.256.1"> instead of the vague and potentially confusing </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.257.1">(.venv)</span></span></span></span><span class="kobospan" id="kobo.258.1">. </span><span id="x1-871002r1847"/></p>
</section>
<section data-number="0.19.1.5" id="see-also-119">
<h2 class="likechapterhead" data-number="0.19.1.5"><span><span class="kobospan" id="kobo.259.1">16.1.5 </span></span> <span id="x1-8720005"/><span class="kobospan" id="kobo.260.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.261.1">Once a virtual environment is created, we can add external libraries. </span><span class="kobospan" id="kobo.261.2">See </span><a href="ch020_split_000.xhtml#x1-8730002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.262.1">Installing packages with a requirements.txt file</span></span></a><span class="kobospan" id="kobo.263.1"> for advice on managing dependencies.</span></p></li>
</ul>
<p class="normal1"><span id="x1-872001r1841"/></p>
</section>
</section>
<section data-number="0.19.2" id="installing-packages-with-a-requirements.txt-file">
<h1 class="unnumbered" data-number="0.19.2"><span><span class="kobospan" id="kobo.264.1">16.2 </span></span> <span id="x1-8730002"/><span class="kobospan" id="kobo.265.1">Installing packages with a requirements.txt file</span></h1>
<p class="normal"><span class="kobospan" id="kobo.266.1">One of the significant strengths</span><span id="dx1-873001"/><span class="kobospan" id="kobo.267.1"> of Python is the vast ecosystem</span><span id="dx1-873002"/><span class="kobospan" id="kobo.268.1"> of packages available in libraries like</span><span id="dx1-873003"/><span class="kobospan" id="kobo.269.1"> the Python Package Index (PyPI) at </span><a class="url" href="https://pypi.org"><span class="url1"><span class="kobospan" id="kobo.270.1">https://pypi.org</span></span></a><span class="kobospan" id="kobo.271.1">. </span><span class="kobospan" id="kobo.271.2">It’s easy to use the PIP tool to add libraries to an environment.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.272.1">In some cases, this is — perhaps — too easy. </span><span class="kobospan" id="kobo.272.2">All of the dependencies, starting with the libraries on which the Python run-time is built, are in a constant state of flux. </span><span class="kobospan" id="kobo.272.3">Each has a distinct tempo for updates. </span><span class="kobospan" id="kobo.272.4">In some cases, there is limited cooperation among the vast number of people involved.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.273.1">To manage the constant change, it’s important for people developing applications to track dependencies carefully. </span><span class="kobospan" id="kobo.273.2">We suggest decomposing dependencies into three levels of specificity:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.274.1">Generic, name-only dependencies: For example, an application might need Beautiful Soup.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.275.1">Filtered: As the Beautiful Soup project evolves, there may be versions with known bugs, or that are missing essential features. </span><span class="kobospan" id="kobo.275.2">We might want to narrow the dependency to omit or exclude a specific version, or require a version that is </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.276.1">&gt;=</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.277.1"> 4.0</span></span></span></span><span class="kobospan" id="kobo.278.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.279.1">Pinned (or Locked): When it is time to build (and test) a specific virtual environment, it is essential to have a detailed list of the exact version numbers used for testing.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.280.1">When we’re first exploring data or a problem domain or candidate solutions, we may download a great many packages into a development environment. </span><span class="kobospan" id="kobo.280.2">As a project matures, the virtual environment contents will shift. </span><span class="kobospan" id="kobo.280.3">In some cases, we’ll learn we don’t need a package; the unused packages will be ignored and should be removed. </span><span class="kobospan" id="kobo.280.4">In other cases, the mix of packages will expand as new options are explored. </span><span class="kobospan" id="kobo.280.5">Throughout this, the pinned version numbers may change to track acceptable versions of packages on which our project depends. </span><span id="x1-873004r1848"/></p>
<section data-number="0.19.2.1" id="getting-ready-121">
<h2 class="likechapterhead" data-number="0.19.2.1"><span><span class="kobospan" id="kobo.281.1">16.2.1 </span></span> <span id="x1-8740001"/><span class="kobospan" id="kobo.282.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.283.1">It works out well to record generic</span><span id="dx1-874001"/><span class="kobospan" id="kobo.284.1"> dependencies in places</span><span id="dx1-874002"/><span class="kobospan" id="kobo.285.1"> like a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.286.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.287.1"> file. </span><span class="kobospan" id="kobo.287.2">(We’ll look at this in the </span><a href="ch020_split_000.xhtml#x1-8790003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.288.1">Creating a pyproject.toml file</span></span></a><span class="kobospan" id="kobo.289.1"> recipe.)</span></p>
<p class="normal1"><span class="kobospan" id="kobo.290.1">The specific, pinned dependencies can be separated into a collection of requirements files. </span><span class="kobospan" id="kobo.290.2">There are a number of dependency use cases, leading to a collection of closely related files.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.291.1">The format for a requirements file is defined as part of the PIP documentation. </span><span class="kobospan" id="kobo.291.2">See the</span><span id="dx1-874003"/> <a href="https://pip.pypa.io/en/stable/reference/requirements-file-format/" class="url"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.292.1">Requirements File Format</span></span></a><span class="kobospan" id="kobo.293.1"> page of </span><a class="url" href="https://packaging.python.org"><span class="url1"><span class="kobospan" id="kobo.294.1">https://packaging.python.org</span></span></a><span class="kobospan" id="kobo.295.1">. </span><span id="x1-874004r1850"/></p>
</section>
<section data-number="0.19.2.2" id="how-to-do-it...-122">
<h2 class="likechapterhead" data-number="0.19.2.2"><span><span class="kobospan" id="kobo.296.1">16.2.2 </span></span> <span id="x1-8750002"/><span class="kobospan" id="kobo.297.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-875002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.298.1">Gather the general requirements. </span><span class="kobospan" id="kobo.298.2">It’s best to look at the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.299.1">import</span></span></span></span><span class="kobospan" id="kobo.300.1"> statements to discern what packages are direct dependencies. </span><span class="kobospan" id="kobo.300.2">We might find that a project uses </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.301.1">pydantic</span></span></span></span><span class="kobospan" id="kobo.302.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.303.1">beautifulsoup4</span></span></span></span><span class="kobospan" id="kobo.304.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.305.1">jupyterlab</span></span></span></span><span class="kobospan" id="kobo.306.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.307.1">matplotlot</span></span></span></span><span class="kobospan" id="kobo.308.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.309.1">pytest</span></span></span></span><span class="kobospan" id="kobo.310.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.311.1">memray</span></span></span></span><span class="kobospan" id="kobo.312.1">.</span></p>
</div></li>
<li class="calibre7"><div id="x1-875004x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.313.1">Open a file named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.314.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.315.1"> in the top-level directory of the project.</span></p>
</div></li>
<li class="calibre7"><div id="x1-875006x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.316.1">Each line of the file will have a requirements specifier with four pieces of information:</span></p>
<ul class="calibre17">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.317.1">The package name. </span><span class="kobospan" id="kobo.317.2">Note that </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.318.1">typo-squatting </span></span><span class="kobospan" id="kobo.319.1">is a prevalent problem with open source; be sure to find the correct, current repository for a package, not a similar-looking name.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.320.1">Any extras needed. </span><span class="kobospan" id="kobo.320.2">If present, these are enclosed in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.321.1">[</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.322.1"> ]</span></span></span></span><span class="kobospan" id="kobo.323.1">. </span><span class="kobospan" id="kobo.323.2">For example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.324.1">rich</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.325.1"> [jupyter]</span></span></span></span><span class="kobospan" id="kobo.326.1"> might be used when using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.327.1">rich</span></span></span></span><span class="kobospan" id="kobo.328.1"> package for text styling with Jupyter Lab.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.329.1">A version specifier. </span><span class="kobospan" id="kobo.329.2">This has a comparison (</span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.330.1">==</span></span></span></span><span class="kobospan" id="kobo.331.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.332.1">&gt;=</span></span></span></span><span class="kobospan" id="kobo.333.1">, etc.), and a version as a dotted sequence of numbers. </span><span class="kobospan" id="kobo.333.2">For example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.334.1">pillow&gt;=10.2.0</span></span></span></span><span class="kobospan" id="kobo.335.1"> selects any version of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.336.1">pillow</span></span></span></span><span class="kobospan" id="kobo.337.1"> package at or after version 10.2.0, avoiding a known vulnerability with version 10.1.0.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.338.1">If necessary, any further environment constraints separated by a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.339.1">;</span></span></span></span><span class="kobospan" id="kobo.340.1">. </span><span class="kobospan" id="kobo.340.2">For example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.341.1">sys_platform</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.342.1"> ==</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.343.1"> ’win32’</span></span></span></span><span class="kobospan" id="kobo.344.1"> might be used to provide a platform-specific requirement.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.345.1">While complex conditions</span><span id="dx1-875007"/><span class="kobospan" id="kobo.346.1"> can be created, they’re not often</span><span id="dx1-875008"/><span class="kobospan" id="kobo.347.1"> needed. </span><span class="kobospan" id="kobo.347.2">It’s best to avoid writing version information unless a specific bug fix, missing feature, or compatibility problem surfaces.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.348.1">The full set of rules for this file is in the </span><a href="https://peps.python.org/pep-0508/" class="url"><span class="kobospan" id="kobo.349.1">PEP 508</span></a><span class="kobospan" id="kobo.350.1"> document.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.351.1">Version specifiers are defined in the Python Packaging Guide. </span><span class="kobospan" id="kobo.351.2">See the </span><a href="https://packaging.python.org/en/latest/specifications/version-specifiers" class="url"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.352.1">Version specifiers</span></span></a><span class="kobospan" id="kobo.353.1"> page of </span><a class="url" href="https://packaging.python.org"><span class="url1"><span class="kobospan" id="kobo.354.1">https://packaging.python.org</span></span></a><span class="kobospan" id="kobo.355.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.356.1">For example, here is the list of dependencies:</span></p>
<pre class="programlisting" id="listing-123"><code class="calibre13"><span class="kobospan" id="kobo.357.1">pydantic 
 
beautifulsoup4 
 
types-beautifulsoup4 
 
jupyterlab 
 
matplotlib 
 
pytest 
 
memray</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-875017x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.358.1">Activate the project’s virtual environment (if it’s not already activated):</span></p>
<pre class="programlisting" id="listing-124"><code class="calibre13"><span class="kobospan" id="kobo.359.1">% source .venv/bin/activate</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-875020x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.360.1">Run the following command to install the latest versions of the named packages:</span></p>
<pre class="programlisting" id="listing-125"><code class="calibre13"><span class="kobospan" id="kobo.361.1">(ch17) % python -m pip install -r requirements.txt</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.362.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.363.1">PIP </span></span><span class="kobospan" id="kobo.364.1">application will find matching versions of the various packages and install them. </span><span class="kobospan" id="kobo.364.2">Because some of these packages have complex layers of dependencies, the installation can be rather time-consuming the first time it’s attempted.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.365.1">This list of seven packages expands to about 111 packages in total that must be installed.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.366.1">For many projects, this is all that’s required to build a useful environment definition. </span><span class="kobospan" id="kobo.366.2">In many cases, this base definition needs to have more specific version information provided. </span><span class="kobospan" id="kobo.366.3">This is a separate recipe; see </span><a href="ch020_split_000.xhtml#x1-8850004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.367.1">Using pip-tools to manage the</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.368.1">requirements.txt file</span></span></a><span class="kobospan" id="kobo.369.1">. </span><span id="x1-875022r1851"/></p>
</section>
<section data-number="0.19.2.3" id="how-it-works...-122">
<h2 class="likechapterhead" data-number="0.19.2.3"><span><span class="kobospan" id="kobo.370.1">16.2.3 </span></span> <span id="x1-8760003"/><span class="kobospan" id="kobo.371.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.372.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.373.1">PIP </span></span><span class="kobospan" id="kobo.374.1">application uses the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.375.1">-r</span></span></span></span><span class="kobospan" id="kobo.376.1"> option</span><span id="dx1-876001"/><span class="kobospan" id="kobo.377.1"> to parse a file</span><span id="dx1-876002"/><span class="kobospan" id="kobo.378.1"> with required</span><span id="dx1-876003"/><span class="kobospan" id="kobo.379.1"> packages. </span><span class="kobospan" id="kobo.379.2">Within this file, we can have simple lists of packages, and complex rules for locating the proper version of a package. </span><span class="kobospan" id="kobo.379.3">We can even have other </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.380.1">-r</span></span></span></span><span class="kobospan" id="kobo.381.1"> options to incorporate other files of requirements. </span><span class="kobospan" id="kobo.381.2">Using multiple files can help organize very complex projects.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.382.1">When we name a package </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.383.1">PIP</span></span><span class="kobospan" id="kobo.384.1">, it will examine the target’s metadata to locate packages on which it depends. </span><span class="kobospan" id="kobo.384.2">These transitive dependencies must be installed before the target package is installed. </span><span class="kobospan" id="kobo.384.3">This means an internal lattice structure showing all of the dependencies must be built. </span><span class="kobospan" id="kobo.384.4">This can involve downloading multiple copies of a package, as version constraints are resolved into a single, final list of packages to install.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.385.1">While it’s easy to use </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.386.1">PIP </span></span><span class="kobospan" id="kobo.387.1">to manually install a single package, this leads to confusion about what a project needs and what’s currently installed in the virtual environment. </span><span class="kobospan" id="kobo.387.2">Avoiding this requires a disciplined approach of always doing these two things when exploring a new package:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.388.1">Add the package to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.389.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.390.1"> file.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.391.1">Run </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.392.1">python</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.393.1"> -m</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.394.1"> pip</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.395.1"> install</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.396.1"> -r</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.397.1"> requirements.txt</span></span></span></span><span class="kobospan" id="kobo.398.1"> to add packages to the current virtual environment.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.399.1">When removing packages from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.400.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.401.1"> file, we can generally proceed by deleting the virtual environment and creating an entirely new one. </span><span class="kobospan" id="kobo.401.2">This leads to the following sequence of commands being used:</span></p>
<pre class="programlisting" id="listing-126"><code class="calibre13"><span class="kobospan" id="kobo.402.1">% (ch17) deactivate 
 
% python -m venv --clear --prompt ch17 .venv 
 
% source .venv/bin/activate 
 
% (ch17) python -m pip install -r requirements.txt</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.403.1">Because </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.404.1">PIP </span></span><span class="kobospan" id="kobo.405.1">maintains a cache of downloaded files, this environment will be rebuilt relatively quickly. </span><span class="kobospan" id="kobo.405.2">The use</span><span id="dx1-876008"/><span class="kobospan" id="kobo.406.1"> of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.407.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.408.1"> ensures</span><span id="dx1-876009"/><span class="kobospan" id="kobo.409.1"> the environment is built in a repeatable fashion. </span><span id="x1-876010r1852"/></p>
</section>
<section data-number="0.19.2.4" id="theres-more...-113">
<h2 class="likechapterhead" data-number="0.19.2.4"><span><span class="kobospan" id="kobo.410.1">16.2.4 </span></span> <span id="x1-8770004"/><span class="kobospan" id="kobo.411.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.412.1">It’s very common to install components manually and uncover conflicts. </span><span class="kobospan" id="kobo.412.2">For example, a colleague clones a repository and cannot run the unit test suite because the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.413.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.414.1"> file is incomplete.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.415.1">Another case is an audit of development environments. </span><span class="kobospan" id="kobo.415.2">As new people join a team, they may install new releases of a package named in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.416.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.417.1"> file. </span><span class="kobospan" id="kobo.417.2">To be confident everyone has the same version, it helps to freeze the version information for the packages in a virtual environment.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.418.1">For both use cases, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.419.1">python</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.420.1"> -m</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.421.1"> pip</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.422.1"> freeze</span></span></span></span><span class="kobospan" id="kobo.423.1"> command can be used. </span><span class="kobospan" id="kobo.423.2">This will report </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.424.1">all </span></span><span class="kobospan" id="kobo.425.1">of the installed packages and the versions that were used. </span><span class="kobospan" id="kobo.425.2">The output from this is in the same format as a requirements file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.426.1">We can use a command like the following:</span></p>
<pre class="programlisting" id="listing-127"><code class="calibre13"><span class="kobospan" id="kobo.427.1">% source .venv/bin/activate 
 
% (ch17) python -m pip freeze &gt;audit_sfl.txt</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.428.1">These output files can be compared to locate differences and repair environments that are not consistent with expectations.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.429.1">Additionally, the output from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.430.1">pip</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.431.1"> freeze</span></span></span></span><span class="kobospan" id="kobo.432.1"> subcommand can be used to replace a generic </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.433.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.434.1"> file with a file that specifically pins each and every package in use. </span><span class="kobospan" id="kobo.434.2">While this is very easy, it’s not terribly flexible because it provides specific versions. </span><span class="kobospan" id="kobo.434.3">There are better ways to build a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.435.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.436.1"> file using </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.437.1">pip-tools</span></span></span></span><span class="kobospan" id="kobo.438.1">. </span><span class="kobospan" id="kobo.438.2">We’ll look at this in </span><a href="ch020_split_000.xhtml#x1-8850004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.439.1">Using pip-tools to manage the</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.440.1">requirements.txt file</span></span></a><span class="kobospan" id="kobo.441.1">. </span><span id="x1-877003r1853"/></p>
</section>
<section data-number="0.19.2.5" id="see-also-120">
<h2 class="likechapterhead" data-number="0.19.2.5"><span><span class="kobospan" id="kobo.442.1">16.2.5 </span></span> <span id="x1-8780005"/><span class="kobospan" id="kobo.443.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.444.1">See the </span><a href="ch020_split_000.xhtml#x1-8650001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.445.1">Creating environments using the built-in venv</span></span></a><span class="kobospan" id="kobo.446.1"> recipe to see how to create a virtual environment.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.447.1">See the </span><a href="ch020_split_000.xhtml#x1-8850004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.448.1">Using pip-tools to manage the requirements.txt file</span></span></a><span class="kobospan" id="kobo.449.1"> recipe for a way to manage dependencies.</span></p></li>
</ul>
<p class="normal1"><span id="x1-878001r1849"/></p>
</section>
</section>
<section data-number="0.19.3" id="creating-a-pyproject.toml-file">
<h1 class="unnumbered" data-number="0.19.3"><span><span class="kobospan" id="kobo.450.1">16.3 </span></span> <span id="x1-8790003"/><span class="kobospan" id="kobo.451.1">Creating a pyproject.toml file</span></h1>
<p class="normal"><span class="kobospan" id="kobo.452.1">In addition to a virtual environment</span><span id="dx1-879001"/><span class="kobospan" id="kobo.453.1"> and a clear list of dependencies, a project also benefits from an overall summary, in the form of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.454.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.455.1"> file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.456.1">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.457.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.458.1"> file is required by some Python tools and is helpful to have in general. </span><span class="kobospan" id="kobo.458.2">It provides a central summary of the technical details of the project.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.459.1">With the adoption of </span><a href="https://peps.python.org/pep-0621/" class="url"><span class="kobospan" id="kobo.460.1">PEP 621</span></a><span class="kobospan" id="kobo.461.1">, this file has become the expected place for metadata about a project. </span><span class="kobospan" id="kobo.461.2">It replaces the older </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.462.1">setup.py</span></span></span></span><span class="kobospan" id="kobo.463.1"> module.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.464.1">This recipe is based on the </span><a href="https://github.com/pypa/sampleproject" class="url"><span class="kobospan" id="kobo.465.1">Sample Project</span></a><span class="kobospan" id="kobo.466.1"> project in the packaging authority Git repository at </span><a class="url" href="https://github.com/pypa"><span class="url1"><span class="kobospan" id="kobo.467.1">https://github.com/pypa</span></span></a><span class="kobospan" id="kobo.468.1">. </span><span class="kobospan" id="kobo.468.2">The recipe is also based on the </span><a href="https://packaging.python.org/en/latest/tutorials/packaging-projects/" class="url"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.469.1">Packaging Python Projects</span></span></a><span class="kobospan" id="kobo.470.1">, page, one of the Packaging Authority tutorials. </span><span class="kobospan" id="kobo.470.2">See </span><a class="url" href="https://packaging.python.org"><span class="url1"><span class="kobospan" id="kobo.471.1">https://packaging.python.org</span></span></a><span class="kobospan" id="kobo.472.1">. </span><span id="x1-879002r1854"/></p>
<section data-number="0.19.3.1" id="getting-ready-122">
<h2 class="likechapterhead" data-number="0.19.3.1"><span><span class="kobospan" id="kobo.473.1">16.3.1 </span></span> <span id="x1-8800001"/><span class="kobospan" id="kobo.474.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.475.1">We’ll assume the project is not a trivial single-file module but something larger. </span><span class="kobospan" id="kobo.475.2">This means there will be a directory structure somewhat like the following:</span></p>
<div class="center">
<p class="normal1"><span class="kobospan" id="kobo.476.1"><img alt="YLRpdcisyimttoIEyoonronoeeuCApcndcuidssrEDrsfert.uttNMo.xpplsmPSEjp.ayeorE.eyrc.domcstkpujdtayle.gectoe.tmply " src="../media/file83.png" class="calibre9"/></span> <span id="x1-880001r1"/> <span id="x1-880002"/></p>
<span><span class="kobospan" id="kobo.477.1">Figure 16.1: </span></span><span><span class="kobospan" id="kobo.478.1">Project files </span></span>
</div>
<p class="normal1"><span class="kobospan" id="kobo.479.1">We’ve shown a common structure that applies broadly to many projects. </span><span class="kobospan" id="kobo.479.2">The top-level name, </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.480.1">Your Project</span></span><span class="kobospan" id="kobo.481.1">, is a name that works for your collection of projects.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.482.1">The name </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.483.1">your</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.484.1">_package </span></span><span class="kobospan" id="kobo.485.1">inside the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.486.1">src</span></span></span></span><span class="kobospan" id="kobo.487.1"> directory</span><span id="dx1-880003"/><span class="kobospan" id="kobo.488.1"> is the name by which the package will be known when it is imported. </span><span class="kobospan" id="kobo.488.2">This does not have to precisely match the overall project name, but it should have a clear relationship. </span><span class="kobospan" id="kobo.488.3">As an example, the Beautiful Soup project has a PYPI entry with the name </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.489.1">beautifulsoup4</span></span></span></span><span class="kobospan" id="kobo.490.1">, but the imported package is named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.491.1">bs4</span></span></span></span><span class="kobospan" id="kobo.492.1"> in your Python’s local site packages. </span><span class="kobospan" id="kobo.492.2">The connection is clear.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.493.1">We’ve shown the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.494.1">README.md</span></span></span></span><span class="kobospan" id="kobo.495.1"> file with an extension that indicates it’s written in Markdown notation. </span><span class="kobospan" id="kobo.495.2">Common alternatives are </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.496.1">README.rst</span></span></span></span><span class="kobospan" id="kobo.497.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.498.1">README</span></span></span></span><span class="kobospan" id="kobo.499.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.500.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.501.1">LICENSE</span></span></span></span><span class="kobospan" id="kobo.502.1"> file can</span><span id="dx1-880004"/><span class="kobospan" id="kobo.503.1"> be a difficult choice. </span><span class="kobospan" id="kobo.503.2">See</span><span id="dx1-880005"/> <a class="url" href="https://spdx.org/licenses/"><span class="url1"><span class="kobospan" id="kobo.504.1">https://spdx.org/licenses/</span></span></a><span class="kobospan" id="kobo.505.1"> for a comprehensive list of open-source licenses. </span><span class="kobospan" id="kobo.505.2">See </span><a href="https://www.gnu.org/licenses/license-list.en.html" class="url"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.506.1">GNU License List</span></span></a><span class="kobospan" id="kobo.507.1"> at </span><a class="url" href="https://www.gnu.org"><span class="url1"><span class="kobospan" id="kobo.508.1">https://www.gnu.org</span></span></a><span class="kobospan" id="kobo.509.1"> for advice on various open source licenses.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.510.1">The content of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.511.1">docs</span></span></span></span><span class="kobospan" id="kobo.512.1"> directory is often built using tools like Sphinx. </span><span class="kobospan" id="kobo.512.2">We’ll address documentation in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.513.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.514.1"> </span></span><a href="ch021.xhtml#x1-91400017" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.515.1">17</span></span></a><span class="kobospan" id="kobo.516.1">. </span><span id="x1-880006r1856"/></p>
</section>
<section data-number="0.19.3.2" id="how-to-do-it...-123">
<h2 class="likechapterhead" data-number="0.19.3.2"><span><span class="kobospan" id="kobo.517.1">16.3.2 </span></span> <span id="x1-8810002"/><span class="kobospan" id="kobo.518.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-881002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.519.1">Make sure the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.520.1">README.md</span></span></span></span><span class="kobospan" id="kobo.521.1"> has a summary of how to install and use the project. </span><span class="kobospan" id="kobo.521.2">This is subject to change as the project evolves.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.522.1">There are six essential questions: ”who?”, ”what?”, ”why?”, ”when?”, ”where?”, and ”how?” </span><span class="kobospan" id="kobo.522.2">that can help write a short paragraph to describe the project. </span><span class="kobospan" id="kobo.522.3">The C4 model offers additional help on how to describe software. </span><span class="kobospan" id="kobo.522.4">See </span><a href="https://c4model.com" class="url"><span class="kobospan" id="kobo.523.1">C4 Model</span></a><span class="kobospan" id="kobo.524.1">.</span></p>
</div></li>
<li class="calibre7"><div id="x1-881004x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.525.1">Determine which build</span><span id="dx1-881005"/><span class="kobospan" id="kobo.526.1"> system will</span><span id="dx1-881006"/><span class="kobospan" id="kobo.527.1"> be used. </span><span class="kobospan" id="kobo.527.2">Choices include </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.528.1">setuptools</span></span><span class="kobospan" id="kobo.529.1">, </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.530.1">hatch</span></span><span class="kobospan" id="kobo.531.1">, and </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.532.1">poetry</span></span><span class="kobospan" id="kobo.533.1">. </span><span class="kobospan" id="kobo.533.2">Parts of content</span><span id="dx1-881007"/><span class="kobospan" id="kobo.534.1"> of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.535.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.536.1"> file will be unique to the build system.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.537.1">For this recipe, we’ll use </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.538.1">setuptools </span></span><span class="kobospan" id="kobo.539.1">as the build</span><span id="dx1-881008"/><span class="kobospan" id="kobo.540.1"> tool.</span></p>
</div></li>
<li class="calibre7"><div id="x1-881010x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.541.1">There are numerous templates available for a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.542.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.543.1"> file. </span><span class="kobospan" id="kobo.543.2">The </span><a href="https://github.com/pypa/sampleproject/blob/main/pyproject.toml" class="url"><span class="kobospan" id="kobo.544.1">PYPA sample project</span></a><span class="kobospan" id="kobo.545.1"> example is comprehensive, and perhaps a bit daunting. </span><span class="kobospan" id="kobo.545.2">There are two tables in the TOML that are required: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.546.1">[project]</span></span></span></span><span class="kobospan" id="kobo.547.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.548.1">[build-system]</span></span></span></span><span class="kobospan" id="kobo.549.1">. </span><span class="kobospan" id="kobo.549.2">The rest can be ignored when getting started.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.550.1">Here’s a short template for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.551.1">[project]</span></span></span></span><span class="kobospan" id="kobo.552.1"> table:</span></p>
<pre class="programlisting" id="listing-128"><code class="calibre13"><span class="kobospan" id="kobo.553.1">[project] 
 
name = "project_name" 
 
version = "2024.1.0" 
 
description = "A useful description." 
 
requires-python = "&gt;=3.12" 
 
authors = [ 
 
  {email = "your.email@example.com", name = "Your Name"} 
 
] 
 
dependencies = [ 
 
    your dependencies 
 
] 
 
readme = "README.md" 
 
license = {file = "LICENSE"}</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.554.1">The first six items need to have values replaced with facts about your project. </span><span class="kobospan" id="kobo.554.2">The last two items, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.555.1">readme</span></span></span></span><span class="kobospan" id="kobo.556.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.557.1">license</span></span></span></span><span class="kobospan" id="kobo.558.1">, don’t often change because they’re references to files in the project directory.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.559.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.560.1">name</span></span></span></span><span class="kobospan" id="kobo.561.1"> must be a valid identifier for a project. </span><span class="kobospan" id="kobo.561.2">They are defined by </span><a href="https://peps.python.org/pep-0508/" class="url"><span class="kobospan" id="kobo.562.1">PEP-508</span></a><span class="kobospan" id="kobo.563.1">. </span><span class="kobospan" id="kobo.563.2">They are names made of letters, digits, and the special characters </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.564.1">-</span></span></span></span><span class="kobospan" id="kobo.565.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.566.1">_</span></span></span></span><span class="kobospan" id="kobo.567.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.568.1">.</span></span></span></span><span class="kobospan" id="kobo.569.1">. </span><span class="kobospan" id="kobo.569.2">Interestingly, they can’t include spaces or end with a punctuation mark. </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.570.1">ch17-recipe3</span></span></span></span><span class="kobospan" id="kobo.571.1"> is acceptable, but </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.572.1">ch17_</span></span></span></span><span class="kobospan" id="kobo.573.1"> is invalid.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.574.1">The dependencies must be a list of the direct</span><span id="dx1-881024"/><span class="kobospan" id="kobo.575.1"> requirements that must be installed in order for this project to work. </span><span class="kobospan" id="kobo.575.2">These are the same kinds of dependency specifications provided in a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.576.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.577.1"> file. </span><span class="kobospan" id="kobo.577.2">See </span><a href="ch020_split_000.xhtml#x1-8730002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.578.1">Installing packages with a requirements.txt file</span></span></a><span class="kobospan" id="kobo.579.1"> for more information.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.580.1">Here’s a template for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.581.1">[build-system]</span></span></span></span><span class="kobospan" id="kobo.582.1"> table. </span><span class="kobospan" id="kobo.582.2">This uses the small, widely available </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.583.1">setuptools</span></span></span></span><span class="kobospan" id="kobo.584.1"> tool:</span></p>
<pre class="programlisting" id="listing-129"><code class="calibre13"><span class="kobospan" id="kobo.585.1">[build-system] 
 
build-backend = "setuptools.build_meta" 
 
requires = [ 
 
    "setuptools", 
 
]</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-881031x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.586.1">It can help to open this file with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.587.1">tomllib</span></span></span></span><span class="kobospan" id="kobo.588.1"> to confirm it’s formatted properly. </span><span class="kobospan" id="kobo.588.2">This can be done interactively in the Python console as follows:</span></p>
<div class="tipbox" id="tcolobox-33">
<span id="x1-881038x4"/>
<div class="note1">
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.589.1"> 
 
&gt;&gt;&gt; from pathlib import Path 
 
&gt;&gt;&gt; import tomllib 
 
&gt;&gt;&gt; doc = Path("pyproject.toml").read_text() 
 
&gt;&gt;&gt; tomllib.loads(doc)</span></code></pre>
</div>
</div>
<p class="normal1"><span class="kobospan" id="kobo.590.1">If the file is invalid in some way, this will raise a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.591.1">tomllib.TOMLDecodeError</span></span></span></span><span class="kobospan" id="kobo.592.1"> exception. </span><span class="kobospan" id="kobo.592.2">The exception will provide the line and column for the syntax error, or it will say ”at end of document” when a structure isn’t terminated properly.</span></p>
</div></li>
</ol>
<p class="normal1"><span id="x1-881039r1858"/></p>
</section>
<section data-number="0.19.3.3" id="how-it-works...-123">
<h2 class="likechapterhead" data-number="0.19.3.3"><span><span class="kobospan" id="kobo.593.1">16.3.3 </span></span> <span id="x1-8820003"/><span class="kobospan" id="kobo.594.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.595.1">A number of tools make use of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.596.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.597.1"> contents. </span><span class="kobospan" id="kobo.597.2">There is a complicated relationship</span><span id="dx1-882001"/><span class="kobospan" id="kobo.598.1"> between </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.599.1">PIP </span></span><span class="kobospan" id="kobo.600.1">and the build tool named in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.601.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.602.1"> file. </span><span class="kobospan" id="kobo.602.2">For</span><span id="dx1-882002"/><span class="kobospan" id="kobo.603.1"> this recipe, we’re using </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.604.1">setuptools</span></span><span class="kobospan" id="kobo.605.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.606.1">The following diagram summarizes some of the steps involved in downloading and installing a library:</span></p>
<div class="center">
<p class="normal1"><span class="kobospan" id="kobo.607.1"><img alt="ysPPdBwtpPp1234r5r6oitYIouhakyip....ea.ea.uePPwierggP g c g bd cd ir-InleeIieaeusrsnpldltntctiescao TPsshrlatocaoateedtamkdocasqwellpalklluhssugaietegreeeseslr...hohookok " src="../media/file84.png" class="calibre9"/></span> <span id="x1-882003r2"/> <span id="x1-882004"/></p>
<span><span class="kobospan" id="kobo.608.1">Figure 16.2: </span></span><span><span class="kobospan" id="kobo.609.1">How PIP and the build tool collaborate </span></span>
</div>
<p class="normal1"><span class="kobospan" id="kobo.610.1">This summary diagram is neither an exhaustive</span><span id="dx1-882005"/><span class="kobospan" id="kobo.611.1"> nor definitive look at how packages are installed. </span><span class="kobospan" id="kobo.611.2">For more information, see </span><a href="https://peps.python.org/pep-0517" class="url"><span class="kobospan" id="kobo.612.1">PEP-517</span></a><span class="kobospan" id="kobo.613.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.614.1">The processing begins with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.615.1">pip</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.616.1"> install</span></span></span></span><span class="kobospan" id="kobo.617.1"> command, shown with a boundary icon. </span><span class="kobospan" id="kobo.617.2">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.618.1">PIP </span></span><span class="kobospan" id="kobo.619.1">operation proceeds</span><span id="dx1-882006"/><span class="kobospan" id="kobo.620.1"> through the numbered steps:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-882008x1" class="calibre14">
<p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.621.1">PIP </span></span><span class="kobospan" id="kobo.622.1">starts by getting the compressed archive from a package index like PYPI.</span></p>
</div></li>
<li class="calibre7"><div id="x1-882010x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.623.1">The archive is cached on the local computer for future use.</span></p>
</div></li>
<li class="calibre7"><div id="x1-882012x3" class="calibre14">
<p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.624.1">PIP </span></span><span class="kobospan" id="kobo.625.1">uses the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.626.1">get_requires_for_build_wheel</span></span></span></span><span class="kobospan" id="kobo.627.1"> build-tool hook to gather requirements. </span><span class="kobospan" id="kobo.627.2">The build tool gets dependency information from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.628.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.629.1"> file and provides this to </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.630.1">PIP</span></span><span class="kobospan" id="kobo.631.1">. </span><span class="kobospan" id="kobo.631.2">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.632.1">PIP </span></span><span class="kobospan" id="kobo.633.1">tool will download these additional projects. </span><span class="kobospan" id="kobo.633.2">These projects have their own requirements. </span><span class="kobospan" id="kobo.633.3">The graph of requirements is resolved to identify all of the required installations.</span></p>
</div></li>
<li class="calibre7"><div id="x1-882014x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.634.1">In some cases, a new wheel-format file is required. </span><span class="kobospan" id="kobo.634.2">In other cases, the project provides a wheel-formatted file. </span><span class="kobospan" id="kobo.634.3">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.635.1">PIP </span></span><span class="kobospan" id="kobo.636.1">tool can use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.637.1">build_wheel</span></span></span></span><span class="kobospan" id="kobo.638.1"> build-tool hook to combine the downloaded files into an installable form.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.639.1">Some distributions include the source files, and may include data files or scripts that aren’t trivially copied to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.640.1">site-packages</span></span></span></span><span class="kobospan" id="kobo.641.1"> directory.</span></p>
</div></li>
<li class="calibre7"><div id="x1-882016x5" class="calibre14">
<p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.642.1">PIP </span></span><span class="kobospan" id="kobo.643.1">then installs the wheel</span><span id="dx1-882017"/><span class="kobospan" id="kobo.644.1"> in the virtual environment’s appropriate </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.645.1">site-packages</span></span></span></span><span class="kobospan" id="kobo.646.1"> directory.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.647.1">Possible build tools to build a package</span><span id="dx1-882018"/><span class="kobospan" id="kobo.648.1"> include </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.649.1">setuptools</span></span></span></span><span class="kobospan" id="kobo.650.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.651.1">build</span></span></span></span><span class="kobospan" id="kobo.652.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.653.1">hatch</span></span></span></span><span class="kobospan" id="kobo.654.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.655.1">poetry</span></span></span></span><span class="kobospan" id="kobo.656.1">. </span><span class="kobospan" id="kobo.656.2">All of these build tools can be used by </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.657.1">PIP</span></span><span class="kobospan" id="kobo.658.1">. </span><span class="kobospan" id="kobo.658.2">They all make use of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.659.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.660.1">. </span><span id="x1-882019r1859"/></p>
</section>
<section data-number="0.19.3.4" id="theres-more...-114">
<h2 class="likechapterhead" data-number="0.19.3.4"><span><span class="kobospan" id="kobo.661.1">16.3.4 </span></span> <span id="x1-8830004"/><span class="kobospan" id="kobo.662.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.663.1">In addition to the dependencies required for the project to work, additional dependencies are often based on other things we may do with the project. </span><span class="kobospan" id="kobo.663.2">Common additional use cases are running tests, developing new features, and fixing bugs.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.664.1">Tools for these additional use cases are optional dependencies. </span><span class="kobospan" id="kobo.664.2">They are generally listed in a separate table, with sub-tables for each use case. </span><span class="kobospan" id="kobo.664.3">For example, we might add the following table with two sub-tables to list the tools used for testing, and additional tools for more general development:</span></p>
<pre class="programlisting" id="listing-130"><code class="calibre13"><span class="kobospan" id="kobo.665.1">[project.optional-dependencies] 
 
test = [ 
 
    "tox", 
 
    "ruff", 
 
    "mypy", 
 
    "pytest", 
 
    "pytest-cov" 
 
] 
 
dev = [ 
 
    "pip-tools", 
 
    "sphinx" 
 
]</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.666.1">These additional lists permit someone to install the test suite to confirm the downloaded project passes all of its test cases. </span><span class="kobospan" id="kobo.666.2">They also permit someone to download appropriate tools for maintaining the documentation and the detailed lists of dependencies.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.667.1">Note that in these examples, none of the dependencies are named with a specific, pinned version. </span><span class="kobospan" id="kobo.667.2">This is because we’re going to use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.668.1">pip-tools</span></span></span></span><span class="kobospan" id="kobo.669.1"> to build a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.670.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.671.1"> file from the information available in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.672.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.673.1"> file. </span><span class="kobospan" id="kobo.673.2">See </span><a href="ch020_split_000.xhtml#x1-8850004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.674.1">Using pip-tools to manage the requirements.txt</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.675.1">file</span></span></a><span class="kobospan" id="kobo.676.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.677.1">Tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.678.1">flit </span></span><span class="kobospan" id="kobo.679.1">and </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.680.1">twine </span></span><span class="kobospan" id="kobo.681.1">are often used to upload</span><span id="dx1-883013"/><span class="kobospan" id="kobo.682.1"> to a repository</span><span id="dx1-883014"/><span class="kobospan" id="kobo.683.1"> like PYPI. </span><span class="kobospan" id="kobo.683.2">For enterprise developers, there may be an enterprise Python repository. </span><span class="kobospan" id="kobo.683.3">These tools make use of additional tables in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.684.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.685.1"> file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.686.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.687.1">flit </span></span><span class="kobospan" id="kobo.688.1">tool, for example, uses additional </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.689.1">[tool.flit.sdist]</span></span></span></span><span class="kobospan" id="kobo.690.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.691.1">[tool.flit.external-data]</span></span></span></span><span class="kobospan" id="kobo.692.1"> tables to provide information required to perform an upload. </span><span id="x1-883015r1861"/></p>
</section>
<section data-number="0.19.3.5" id="see-also-121">
<h2 class="likechapterhead" data-number="0.19.3.5"><span><span class="kobospan" id="kobo.693.1">16.3.5 </span></span> <span id="x1-8840005"/><span class="kobospan" id="kobo.694.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.695.1">See </span><a class="url" href="https://python-semantic-release.readthedocs.io/en/latest/"><span class="url1"><span class="kobospan" id="kobo.696.1">https://python-semantic-release.readthedocs.io/en/latest/</span></span></a><span class="kobospan" id="kobo.697.1"> for the Python Semantic Release tool</span><span id="dx1-884001"/><span class="kobospan" id="kobo.698.1"> that can modify version names based on Git commit messages.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.699.1">See </span><a href="ch017.xhtml#x1-7230002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.700.1">Using TOML for configuration files</span></span></a><span class="kobospan" id="kobo.701.1"> in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.702.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.703.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.704.1">13</span></span></a><span class="kobospan" id="kobo.705.1"> for more information on TOML files.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.706.1">See </span><a href="ch020_split_000.xhtml#x1-8850004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.707.1">Using pip-tools to manage the requirements.txt file</span></span></a><span class="kobospan" id="kobo.708.1"> for our approach to refining the list of requirements into a line of pinned version numbers.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.709.1">The </span><a href="https://github.com/cjolowicz/cookiecutter-hypermodern-python" class="url"><span class="kobospan" id="kobo.710.1">Hypermodern Python</span></a><span class="kobospan" id="kobo.711.1"> project has a template usable with the Cookie-Cutter tool to build a directory structure. </span><span class="kobospan" id="kobo.711.2">See </span><a class="url" href="https://github.com/cjolowicz"><span class="url1"><span class="kobospan" id="kobo.712.1">https://github.com/cjolowicz</span></span></a><span class="kobospan" id="kobo.713.1">. </span><span class="kobospan" id="kobo.713.2">This template relies on Poetry for managing dependencies and virtual environments.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmti-10x-x"><span class="kobospan" id="kobo.714.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.715.1"> </span></span><a href="ch021.xhtml#x1-91400017" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.716.1">17</span></span></a><span class="kobospan" id="kobo.717.1"> contains the </span><a href="ch021.xhtml#x1-9150001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.718.1">The bare minimum: a README.rst file</span></span></a><span class="kobospan" id="kobo.719.1"> recipe to address the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.720.1">README</span></span></span></span><span class="kobospan" id="kobo.721.1"> file in more depth.</span></p></li>
</ul>
<p class="normal1"><span id="x1-884002r1855"/></p>
</section>
</section>
<section data-number="0.19.4" id="using-pip-tools-to-manage-the-requirements.txt-file">
<h1 class="unnumbered" data-number="0.19.4"><span><span class="kobospan" id="kobo.722.1">16.4 </span></span> <span id="x1-8850004"/><span class="kobospan" id="kobo.723.1">Using pip-tools to manage the requirements.txt file</span></h1>
<p class="normal"><span class="kobospan" id="kobo.724.1">Above, we noted</span><span id="dx1-885001"/><span class="kobospan" id="kobo.725.1"> that a project’s dependencies</span><span id="dx1-885002"/><span class="kobospan" id="kobo.726.1"> have three levels of specificity:</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.727.1">Generic</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.728.1">: Name-only</span><span id="dx1-885003"/><span class="kobospan" id="kobo.729.1"> dependencies</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.730.1">Filtered</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.731.1">: With a very general constraint like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.732.1">&gt;=</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.733.1"> 4.0</span></span></span></span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.734.1">Pinned</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.735.1">: With a specific version like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.736.1">==</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.737.1"> 4.12.2</span></span></span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.738.1">How do we align these levels? </span><span class="kobospan" id="kobo.738.2">One easy way is with the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.739.1">pip-tools </span></span><span class="kobospan" id="kobo.740.1">package. </span><span class="kobospan" id="kobo.740.2">This package includes the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.741.1">pip-compile </span></span><span class="kobospan" id="kobo.742.1">tool, which will digest</span><span id="dx1-885004"/><span class="kobospan" id="kobo.743.1"> requirements, resolve dependencies, and create a derivative </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.744.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.745.1"> file with pinned version numbers.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.746.1">A companion tool, </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.747.1">pip-sync</span></span><span class="kobospan" id="kobo.748.1">, can be used to ensure</span><span id="dx1-885005"/><span class="kobospan" id="kobo.749.1"> that the active virtual environment matches the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.750.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.751.1"> file. </span><span class="kobospan" id="kobo.751.2">This can be considerably faster than dropping and recreating a virtual environment. </span><span id="x1-885006r1862"/></p>
<section data-number="0.19.4.1" id="getting-ready-123">
<h2 class="likechapterhead" data-number="0.19.4.1"><span><span class="kobospan" id="kobo.752.1">16.4.1 </span></span> <span id="x1-8860001"/><span class="kobospan" id="kobo.753.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.754.1">PIP-tools must be downloaded and installed. </span><span class="kobospan" id="kobo.754.2">Generally, this is done with the following terminal command:</span></p>
<pre class="programlisting" id="listing-131"><code class="calibre13"><span class="kobospan" id="kobo.755.1">(ch17) % python -m pip install pip-tools</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.756.1">This assumes the virtual environment is active; in the example, it’s named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.757.1">ch17</span></span></span></span><span class="kobospan" id="kobo.758.1">. </span><span class="kobospan" id="kobo.758.2">Using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.759.1">python</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.760.1"> -m</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.761.1"> pip</span></span></span></span><span class="kobospan" id="kobo.762.1"> command ensures that we will use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.763.1">pip</span></span></span></span><span class="kobospan" id="kobo.764.1"> command that goes with the currently active virtual environment.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.765.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.766.1">pip-compile </span></span><span class="kobospan" id="kobo.767.1">tool will locate requirements in a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.768.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.769.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.770.1">requirements.in</span></span></span></span><span class="kobospan" id="kobo.771.1"> file. </span><span class="kobospan" id="kobo.771.2">From this information, it builds a detailed </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.772.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.773.1"> file that can be used with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.774.1">pip</span></span></span></span><span class="kobospan" id="kobo.775.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.776.1">pip-sync</span></span></span></span><span class="kobospan" id="kobo.777.1"> to create the virtual environment. </span><span id="x1-886002r1864"/></p>
</section>
<section data-number="0.19.4.2" id="how-to-do-it...-124">
<h2 class="likechapterhead" data-number="0.19.4.2"><span><span class="kobospan" id="kobo.778.1">16.4.2 </span></span> <span id="x1-8870002"/><span class="kobospan" id="kobo.779.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-887002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.780.1">Make sure the dependencies</span><span id="dx1-887003"/><span class="kobospan" id="kobo.781.1"> are in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.782.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.783.1"> file. </span><span class="kobospan" id="kobo.783.2">In some</span><span id="dx1-887004"/><span class="kobospan" id="kobo.784.1"> cases, an old </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.785.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.786.1"> file may have been used to get started. </span><span class="kobospan" id="kobo.786.2">It’s a good idea to confirm that the information is in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.787.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.788.1"> file because the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.789.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.790.1"> file will be replaced.</span></p>
</div></li>
<li class="calibre7"><div id="x1-887006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.791.1">The first time you do this, it helps to delete any old </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.792.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.793.1"> file not created by </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.794.1">pip-compile</span></span></span></span><span class="kobospan" id="kobo.795.1">.</span></p>
</div></li>
<li class="calibre7"><div id="x1-887008x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.796.1">To build the core </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.797.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.798.1"> file, run the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.799.1">pip-compile</span></span></span></span><span class="kobospan" id="kobo.800.1"> command:</span></p>
<pre class="programlisting" id="listing-132"><code class="calibre13"><span class="kobospan" id="kobo.801.1">(ch17) % pip-compile</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.802.1">This will locate the dependencies in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.803.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.804.1"> file. </span><span class="kobospan" id="kobo.804.2">It will then locate all of the transitive requirements and build a set of requirements with conflicts resolved.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.805.1">It will both write a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.806.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.807.1"> file and also display this file on the console.</span></p>
</div></li>
<li class="calibre7"><div id="x1-887011x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.808.1">To build a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.809.1">requirements-test.txt</span></span></span></span><span class="kobospan" id="kobo.810.1"> file, run the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.811.1">pip-compile</span></span></span></span><span class="kobospan" id="kobo.812.1"> command with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.813.1">--extra</span></span></span></span><span class="kobospan" id="kobo.814.1"> option:</span></p>
<pre class="programlisting" id="listing-133"><code class="calibre13"><span class="kobospan" id="kobo.815.1">(ch17) % pip-compile --extra test -o requirements-test.txt</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.816.1">This creates a file with the optional dependencies from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.817.1">test</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.818.1"> =</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.819.1"> [...]</span></span></span></span><span class="kobospan" id="kobo.820.1"> section of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.821.1">[project.optional-dependencies]</span></span></span></span><span class="kobospan" id="kobo.822.1"> table.</span></p>
</div></li>
<li class="calibre7"><div id="x1-887014x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.823.1">To build a comprehensive </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.824.1">requirements-dev.txt</span></span></span></span><span class="kobospan" id="kobo.825.1"> file that contains all of the extras, run the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.826.1">pip-compile</span></span></span></span><span class="kobospan" id="kobo.827.1"> command with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.828.1">--all-extras</span></span></span></span><span class="kobospan" id="kobo.829.1"> option:</span></p>
<pre class="programlisting" id="listing-134"><code class="calibre13"><span class="kobospan" id="kobo.830.1">(ch17) % pip-compile --all-extras -o requirements-dev.txt</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.831.1">This creates a file with all of the optional dependencies in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.832.1">[project.optional-dependencies]</span></span></span></span><span class="kobospan" id="kobo.833.1"> table.</span></p>
</div></li>
<li class="calibre7"><div id="x1-887017x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.834.1">When needed, use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.835.1">pip-sync</span></span></span></span><span class="kobospan" id="kobo.836.1"> command to rebuild the current virtual environment to match changes to one of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.837.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.838.1"> files.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.839.1">It’s common practice</span><span id="dx1-887018"/><span class="kobospan" id="kobo.840.1"> to use this with the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.841.1">tox </span></span><span class="kobospan" id="kobo.842.1">tool. </span><span class="kobospan" id="kobo.842.2">In the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.843.1">commands_pre</span></span></span></span><span class="kobospan" id="kobo.844.1"> section of a test environment description, use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.845.1">pip-sync</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.846.1"> requirements.txt</span></span></span></span><span class="kobospan" id="kobo.847.1"> to make sure the test virtual environment is synchronized with the package versions in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.848.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.849.1"> file.</span></p>
</div></li>
</ol>
<p class="normal1"><span id="x1-887019r1865"/></p>
</section>
</section>
</section>


<section data-number="0.19" id="chapter-16-dependencies-and-virtual-environments">
<section data-number="0.19.4" id="using-pip-tools-to-manage-the-requirements.txt-file">
<section data-number="0.19.4.3" id="how-it-works...-124">
<h2 class="likechapterhead" data-number="0.19.4.3"><span><span class="kobospan" id="kobo.850.1">16.4.3 </span></span> <span id="x1-8880003"/><span class="kobospan" id="kobo.851.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.852.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.853.1">pip-compile</span></span></span></span><span class="kobospan" id="kobo.854.1"> tool will look</span><span id="dx1-888001"/><span class="kobospan" id="kobo.855.1"> for information</span><span id="dx1-888002"/><span class="kobospan" id="kobo.856.1"> in three places:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.857.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.858.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.859.1"> file.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.860.1">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.861.1">requirements.in</span></span></span></span><span class="kobospan" id="kobo.862.1"> file, if present. </span><span class="kobospan" id="kobo.862.2">This isn’t needed, since the same information is in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.863.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.864.1"> file.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.865.1">Any previously created </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.866.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.867.1"> file.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.868.1">Using both the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.869.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.870.1"> and any previously created </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.871.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.872.1"> file allows the tool to properly reflect incremental changes. </span><span class="kobospan" id="kobo.872.2">This means it can minimize the work required to analyze projects that haven’t changed much. </span><span class="kobospan" id="kobo.872.3">When starting a new project, it’s sometimes helpful to delete the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.873.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.874.1"> file entirely after making significant changes. </span><span id="x1-888003r1866"/></p>
</section>
<section data-number="0.19.4.4" id="theres-more...-115">
<h2 class="likechapterhead" data-number="0.19.4.4"><span><span class="kobospan" id="kobo.875.1">16.4.4 </span></span> <span id="x1-8890004"/><span class="kobospan" id="kobo.876.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.877.1">When making changes, there are two options that can help rebuild the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.878.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.879.1"> details:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.880.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.881.1">--rebuild</span></span></span></span><span class="kobospan" id="kobo.882.1"> option will clear caches and redo the analysis of dependencies.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.883.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.884.1">--upgrade</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.885.1"> some-package</span></span></span></span><span class="kobospan" id="kobo.886.1"> option will look for upgrades for the named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.887.1">some-package</span></span></span></span><span class="kobospan" id="kobo.888.1"> package only. </span><span class="kobospan" id="kobo.888.2">This prevents analysis of other packages that should be left alone. </span><span class="kobospan" id="kobo.888.3">Multiple </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.889.1">--upgrade</span></span></span></span><span class="kobospan" id="kobo.890.1"> options can be supplied to track multiple changes.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.891.1">These two commands let us manage incremental change, upgrade </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.892.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.893.1">, rebuild the virtual environment, and test with new versions of packages. </span><span class="kobospan" id="kobo.893.2">This ensures the description of the environment matches the actual environment. </span><span class="kobospan" id="kobo.893.3">We can share the project with confidence.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.894.1">There are times when packages have conflicting requirements. </span><span class="kobospan" id="kobo.894.2">Assume our project depends on project </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.895.1">A</span></span></span></span><span class="kobospan" id="kobo.896.1"> and project </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.897.1">T</span></span></span></span><span class="kobospan" id="kobo.898.1">. </span><span class="kobospan" id="kobo.898.2">It turns out project </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.899.1">A</span></span></span></span><span class="kobospan" id="kobo.900.1"> also requires project </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.901.1">T</span></span></span></span><span class="kobospan" id="kobo.902.1">. </span><span class="kobospan" id="kobo.902.2">Problems can arise when our project requires </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.903.1">T</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.904.1"> &gt;=</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.905.1"> 10.11</span></span></span></span><span class="kobospan" id="kobo.906.1"> that’s distinct from the version required by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.907.1">A</span></span></span></span><span class="kobospan" id="kobo.908.1"> project, for example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.909.1">T</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.910.1"> &lt;</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.911.1"> 10.9</span></span></span></span><span class="kobospan" id="kobo.912.1">. </span><span class="kobospan" id="kobo.912.2">This can be challenging to resolve.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.913.1">We can hope our project’s limitation of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.914.1">T</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.915.1"> &gt;=</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.916.1"> 10.11</span></span></span></span><span class="kobospan" id="kobo.917.1"> is too specific; we can weaken the constraint and find a compatible version. </span><span class="kobospan" id="kobo.917.2">In other cases, the requirements stated by project </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.918.1">A</span></span></span></span><span class="kobospan" id="kobo.919.1"> might be too specific, and we need to consider making a change to the other project’s code. </span><span class="kobospan" id="kobo.919.2">Ideally, this is a proper issue and pull request, but it may require forking the project to offer distinct constraints. </span><span class="kobospan" id="kobo.919.3">The worst case requires re-engineering our project to change the nature of the dependencies or — perhaps — stop using project </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.920.1">A</span></span></span></span><span class="kobospan" id="kobo.921.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.922.1">In some cases, there are obscure errors in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.923.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.924.1"> and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.925.1">pip-compile</span></span></span></span><span class="kobospan" id="kobo.926.1"> tool reports an infuriatingly opaque error message:</span></p>
<pre class="programlisting" id="listing-135"><code class="calibre13"><span class="kobospan" id="kobo.927.1">(ch17) % pip-compile 
 
Backend subprocess exited when trying to invoke get_requires_for_build_wheel 
 
Failed to parse /Users/slott/Documents/Writing/Python/Python Cookbook 3e/src/ch17/pyproject.toml</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.928.1">This is a problem with the formatting of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.929.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.930.1"> file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.931.1">One way to uncover the problem is to attempt to do an ”editable” installation of the project in the current working directory. </span><span class="kobospan" id="kobo.931.2">This will use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.932.1">pip</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.933.1"> install</span></span></span></span><span class="kobospan" id="kobo.934.1"> command with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.935.1">-e</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.936.1"> .</span></span></span></span><span class="kobospan" id="kobo.937.1"> option to use the current directory as the project to install.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.938.1">It looks like this:</span></p>
<pre class="programlisting" id="listing-136"><code class="calibre13"><span class="kobospan" id="kobo.939.1">(ch17) % pip install -e .</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.940.1">This will report the specific error found in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.941.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.942.1"> file. </span><span class="kobospan" id="kobo.942.2">We can then repair the error and run </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.943.1">pip-compile</span></span></span></span><span class="kobospan" id="kobo.944.1"> again. </span><span id="x1-889005r1867"/></p>
</section>
<section data-number="0.19.4.5" id="see-also-122">
<h2 class="likechapterhead" data-number="0.19.4.5"><span><span class="kobospan" id="kobo.945.1">16.4.5 </span></span> <span id="x1-8900005"/><span class="kobospan" id="kobo.946.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.947.1">For more background on projects as a whole, see the PYPA </span><a href="https://github.com/pypa/sampleproject" class="url"><span class="kobospan" id="kobo.948.1">Sample Project</span></a><span class="kobospan" id="kobo.949.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.950.1">For information on licenses, see </span><a href="https://spdx.org/licenses/" class="url"><span class="kobospan" id="kobo.951.1">SPDX</span></a><span class="kobospan" id="kobo.952.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.953.1">The </span><a href="ch020_split_000.xhtml#x1-8730002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.954.1">Installing packages with a requirements.txt file</span></span></a><span class="kobospan" id="kobo.955.1"> recipe describes using a file to drive </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.956.1">PIP </span></span><span class="kobospan" id="kobo.957.1">installations.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.958.1">See </span><a href="https://peps.python.org/pep-0517" class="url"><span class="kobospan" id="kobo.959.1">PEP-517</span></a><span class="kobospan" id="kobo.960.1"> for more information on how a build system works.</span></p></li>
</ul>
<p class="normal1"><span id="x1-890001r1863"/></p>
</section>
</section>
<section data-number="0.19.5" id="using-anaconda-and-the-conda-tool">
<h1 class="unnumbered" data-number="0.19.5"><span><span class="kobospan" id="kobo.961.1">16.5 </span></span> <span id="x1-8910005"/><span class="kobospan" id="kobo.962.1">Using Anaconda and the conda tool</span></h1>
<p class="normal"><span class="kobospan" id="kobo.963.1">There are some limitations</span><span id="dx1-891001"/><span class="kobospan" id="kobo.964.1"> on the kinds</span><span id="dx1-891002"/><span class="kobospan" id="kobo.965.1"> of packages the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.966.1">PIP </span></span><span class="kobospan" id="kobo.967.1">tool can</span><span id="dx1-891003"/><span class="kobospan" id="kobo.968.1"> install. </span><span class="kobospan" id="kobo.968.2">The most notable limitation involves projects that involve extension modules written in a compiled language like Rust or C. </span><span class="kobospan" id="kobo.968.3">The variations among platforms — including hardware and OS — can make it difficult to distribute all the required variants of the package’s binary files.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.969.1">In a Linux environment, where compilers like GNU CC are readily available, a package with an extension module can include source code. </span><span class="kobospan" id="kobo.969.2">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.970.1">PIP </span></span><span class="kobospan" id="kobo.971.1">tool can use the compiler to build the necessary binaries.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.972.1">For macOS and Windows, additional tools are required to create binaries. </span><span class="kobospan" id="kobo.972.2">Free compilers are not as readily available as they are in a Linux environment, presenting a potential problem.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.973.1">Conda solves the problems with binaries by making a wide selection of pre-built binaries available in their repository. </span><span class="kobospan" id="kobo.973.2">It also makes sure a compiler is available on the target platform for the cases where a pre-built binary isn’t available.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.974.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.975.1">conda </span></span><span class="kobospan" id="kobo.976.1">tool is a virtual environment manager and package installer. </span><span class="kobospan" id="kobo.976.2">It fulfills the same</span><span id="dx1-891004"/><span class="kobospan" id="kobo.977.1"> use cases as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.978.1">PIP</span></span><span class="kobospan" id="kobo.979.1">, combined with </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.980.1">venv </span></span><span class="kobospan" id="kobo.981.1">and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.982.1">pip-tools</span></span></span></span><span class="kobospan" id="kobo.983.1">. </span><span class="kobospan" id="kobo.983.2">This includes builds of packages that include binaries, often used for high-performance numeric applications. </span><span class="kobospan" id="kobo.983.3">The command-line interface for </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.984.1">conda </span></span><span class="kobospan" id="kobo.985.1">is the same on all platforms, permitting simpler, more consistent documentation.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.986.1">The Anaconda package index is curated by the Anaconda company. </span><span class="kobospan" id="kobo.986.2">Check out their</span><span id="dx1-891005"/><span class="kobospan" id="kobo.987.1"> website, </span><a class="url" href="https://anaconda.com"><span class="url1"><span class="kobospan" id="kobo.988.1">https://anaconda.com</span></span></a><span class="kobospan" id="kobo.989.1">, for prices and fees. </span><span class="kobospan" id="kobo.989.2">The packages provided have been integrated and tested. </span><span class="kobospan" id="kobo.989.3">This testing takes time, and the official Anaconda distribution can lag behind what’s available in PYPI. </span><span class="kobospan" id="kobo.989.4">Further, it’s a subset of what’s available on PYPI because it tends to focus on data analytics and data science.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.990.1">A separate package</span><span id="dx1-891006"/><span class="kobospan" id="kobo.991.1"> index, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.992.1">conda-forge</span></span></span></span><span class="kobospan" id="kobo.993.1"> ( </span><a class="url" href="https://conda-forge.org"><span class="url1"><span class="kobospan" id="kobo.994.1">https://conda-forge.org</span></span></a><span class="kobospan" id="kobo.995.1">) is community based. </span><span class="kobospan" id="kobo.995.2">This channel contains packages that more closely mirror what’s in PYPI. </span><span class="kobospan" id="kobo.995.3">In many cases, we’ll install packages from this channel because we want something new, or we want something outside the curated subset available from Anaconda. </span><span id="x1-891007r1868"/></p>
<section data-number="0.19.5.1" id="getting-ready-124">
<h2 class="likechapterhead" data-number="0.19.5.1"><span><span class="kobospan" id="kobo.996.1">16.5.1 </span></span> <span id="x1-8920001"/><span class="kobospan" id="kobo.997.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.998.1">There are two ways to get</span><span id="dx1-892001"/><span class="kobospan" id="kobo.999.1"> the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1000.1">conda </span></span><span class="kobospan" id="kobo.1001.1">tool:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1002.1">Download and install the full Anaconda distribution. </span><span class="kobospan" id="kobo.1002.2">This is a large download, anywhere from 900 MB for Windows to over 1,000 MB for more Linux distributions.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1003.1">Download and install miniconda and use it to install only the desired packages. </span><span class="kobospan" id="kobo.1003.2">This is a much smaller download, generally about 100 MB.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1004.1">For the full Anaconda</span><span id="dx1-892002"/><span class="kobospan" id="kobo.1005.1"> install, see </span><a class="url" href="https://www.anaconda.com/download"><span class="url1"><span class="kobospan" id="kobo.1006.1">https://www.anaconda.com/download</span></span></a><span class="kobospan" id="kobo.1007.1">. </span><span class="kobospan" id="kobo.1007.2">There are</span><span id="dx1-892003"/><span class="kobospan" id="kobo.1008.1"> two varieties</span><span id="dx1-892004"/><span class="kobospan" id="kobo.1009.1"> of the installer:</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1010.1">Graphical</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.1011.1">: These installers</span><span id="dx1-892005"/><span class="kobospan" id="kobo.1012.1"> use the OS interactive tools to support some configuration.</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1013.1">Command-line</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.1014.1">: These installers are sophisticated</span><span id="dx1-892006"/><span class="kobospan" id="kobo.1015.1"> shell archives that run in a terminal window. </span><span class="kobospan" id="kobo.1015.2">They provide the same options for installation as the graphical installer. </span><span class="kobospan" id="kobo.1015.3">There’s more typing and less pointing and clicking.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1016.1">For a miniconda</span><span id="dx1-892007"/><span class="kobospan" id="kobo.1017.1"> install, see </span><a class="url" href="https://docs.conda.io/projects/miniconda/en/latest/index.html"><span class="url1"><span class="kobospan" id="kobo.1018.1">https://docs.conda.io/projects/miniconda/en/latest/index.html</span></span></a><span class="kobospan" id="kobo.1019.1">. </span><span class="kobospan" id="kobo.1019.2">Each OS has slightly different kinds of installers:</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1020.1">Windows</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.1021.1">: The installer is an executable</span><span id="dx1-892008"/><span class="kobospan" id="kobo.1022.1"> program that uses the Windows installer.</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1023.1">macOS</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.1024.1">: There are PKG images</span><span id="dx1-892009"/><span class="kobospan" id="kobo.1025.1"> that can be downloaded and double-clicked to use a macOS UI. </span><span class="kobospan" id="kobo.1025.2">There are </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1026.1">also </span></span><span class="kobospan" id="kobo.1027.1">command-line images that can be executed from the terminal window.</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1028.1">Linux</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.1029.1">: These are shell-archive files</span><span id="dx1-892010"/><span class="kobospan" id="kobo.1030.1"> that are started from a terminal window.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1031.1">While there are a lot of choices here, we recommend using a command-line installer for Miniconda.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1032.1">See the </span><a href="https://docs.conda.io/projects/miniconda/en/latest/index.html" class="url"><span class="kobospan" id="kobo.1033.1">Miniconda</span></a><span class="kobospan" id="kobo.1034.1"> page for recommended shell commands to use the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1035.1">curl</span></span><span class="kobospan" id="kobo.1036.1"> program to fetch the image and then perform the installation.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1037.1">Once the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1038.1">conda </span></span><span class="kobospan" id="kobo.1039.1">tool has been installed, it can be used to create and populate virtual environments. </span><span class="kobospan" id="kobo.1039.2">Note that the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1040.1">conda </span></span><span class="kobospan" id="kobo.1041.1">tool creates a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1042.1">base</span></span></span></span><span class="kobospan" id="kobo.1043.1"> virtual environment. </span><span class="kobospan" id="kobo.1043.2">When </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1044.1">conda </span></span><span class="kobospan" id="kobo.1045.1">is installed, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1046.1">(base)</span></span></span></span><span class="kobospan" id="kobo.1047.1"> environment should be shown as part of terminal window prompts. </span><span class="kobospan" id="kobo.1047.2">This serves as a visual cue that no other environment has been activated. </span><span class="kobospan" id="kobo.1047.3">It may help to exit and restart all terminal windows to be sure </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1048.1">conda </span></span><span class="kobospan" id="kobo.1049.1">is working. </span><span id="x1-892011r1870"/></p>
</section>
<section data-number="0.19.5.2" id="how-to-do-it...-125">
<h2 class="likechapterhead" data-number="0.19.5.2"><span><span class="kobospan" id="kobo.1050.1">16.5.2 </span></span> <span id="x1-8930002"/><span class="kobospan" id="kobo.1051.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1052.1">It’s essential</span><span id="dx1-893001"/><span class="kobospan" id="kobo.1053.1"> that the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1054.1">conda</span></span></span></span><span class="kobospan" id="kobo.1055.1"> tool</span><span id="dx1-893002"/><span class="kobospan" id="kobo.1056.1"> is installed. </span><span class="kobospan" id="kobo.1056.2">See the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1057.1">Getting ready </span></span><span class="kobospan" id="kobo.1058.1">section of this recipe for advice on installing </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1059.1">conda</span></span></span></span><span class="kobospan" id="kobo.1060.1">.</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-893004x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1061.1">Use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1062.1">conda</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1063.1"> create</span></span></span></span><span class="kobospan" id="kobo.1064.1"> command to create a new virtual environment:</span></p>
<pre class="programlisting" id="listing-137"><code class="calibre13"><span class="kobospan" id="kobo.1065.1">% conda create -n cookbook3 python=3.12</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1066.1">Note the commands are the same on all operating systems.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1067.1">The virtual environment’s files are kept outside the project directory. </span><span class="kobospan" id="kobo.1067.2">For macOS, there will be a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1068.1">~/miniconda3/envs</span></span></span></span><span class="kobospan" id="kobo.1069.1"> directory that has all of the virtual environment files.</span></p>
</div></li>
<li class="calibre7"><div id="x1-893007x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1070.1">Use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1071.1">conda</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1072.1"> activate</span></span></span></span><span class="kobospan" id="kobo.1073.1"> command to activate this new virtual environment:</span></p>
<pre class="programlisting" id="listing-138"><code class="calibre13"><span class="kobospan" id="kobo.1074.1">(base) % conda activate cookbook3</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-893010x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1075.1">Use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1076.1">conda</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1077.1"> install</span></span></span></span><span class="kobospan" id="kobo.1078.1"> command to install a list of packages in the virtual environment. </span><span class="kobospan" id="kobo.1078.2">Conda has its own</span><span id="dx1-893011"/><span class="kobospan" id="kobo.1079.1"> conflict resolver that’s separate</span><span id="dx1-893012"/><span class="kobospan" id="kobo.1080.1"> from the one used by the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1081.1">PIP </span></span><span class="kobospan" id="kobo.1082.1">tool or </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1083.1">pip-compile</span></span><span class="kobospan" id="kobo.1084.1">. </span><span class="kobospan" id="kobo.1084.2">While we can use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1085.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.1086.1"> file, we don’t really need all of those details. </span><span class="kobospan" id="kobo.1086.2">It’s often easier to provide the package name information as shown in this command:</span></p>
<pre class="programlisting" id="listing-139"><code class="calibre13"><span class="kobospan" id="kobo.1087.1">(cookbook3) % conda install pydantic beautifulsoup4 jupyterlab matplotlib pytest memray</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-893015x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1088.1">To create a shareable definition of the current virtual environment, use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1089.1">conda</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1090.1"> env</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1091.1"> export</span></span></span></span><span class="kobospan" id="kobo.1092.1"> command:</span></p>
<pre class="programlisting" id="listing-140"><code class="calibre13"><span class="kobospan" id="kobo.1093.1">(cookbook3) % conda env export &gt;environment.yml</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1094.1">This uses the shell redirect feature to save the exported information into a YAML-formatted file that lists all of the requirements. </span><span class="kobospan" id="kobo.1094.2">This file can be used by </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1095.1">conda</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1096.1"> env</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1097.1"> create</span></span></span></span><span class="kobospan" id="kobo.1098.1"> to recreate this environment.</span></p>
</div></li>
</ol>
<p class="normal1"><span id="x1-893017r1871"/></p>
</section>
<section data-number="0.19.5.3" id="how-it-works...-125">
<h2 class="likechapterhead" data-number="0.19.5.3"><span><span class="kobospan" id="kobo.1099.1">16.5.3 </span></span> <span id="x1-8940003"/><span class="kobospan" id="kobo.1100.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1101.1">The virtual environment</span><span id="dx1-894001"/><span class="kobospan" id="kobo.1102.1"> created by </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1103.1">conda </span></span><span class="kobospan" id="kobo.1104.1">has the proper </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1105.1">PATH</span></span></span></span><span class="kobospan" id="kobo.1106.1"> environment</span><span id="dx1-894002"/><span class="kobospan" id="kobo.1107.1"> variable set to point to a specific Python binary. </span><span class="kobospan" id="kobo.1107.2">The standard library packages and site-specific packages are located in nearby directories.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1108.1">This parallels the virtual environments created by the built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1109.1">venv</span></span></span></span><span class="kobospan" id="kobo.1110.1"> module. </span><span class="kobospan" id="kobo.1110.2">It follows the rules of </span><a href="https://peps.python.org/pep-0405/" class="url"><span class="kobospan" id="kobo.1111.1">PEP-405</span></a><span class="kobospan" id="kobo.1112.1">, which defines the rules for virtual environments.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1113.1">In order to work consistently, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1114.1">conda</span></span></span></span><span class="kobospan" id="kobo.1115.1"> command must be visible. </span><span class="kobospan" id="kobo.1115.2">This means a base </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1116.1">conda</span></span></span></span><span class="kobospan" id="kobo.1117.1"> installation must </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1118.1">also </span></span><span class="kobospan" id="kobo.1119.1">be named in the system </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1120.1">PATH</span></span></span></span><span class="kobospan" id="kobo.1121.1"> environment variable. </span><span class="kobospan" id="kobo.1121.2">This is a crucial step in using </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1122.1">conda</span></span><span class="kobospan" id="kobo.1123.1">. </span><span class="kobospan" id="kobo.1123.2">The Windows installer has the option to either update the system path or to create special command windows in which the necessary path setting has been made. </span><span class="kobospan" id="kobo.1123.3">Similarly, the macOS installer requires an extra step to make the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1124.1">conda</span></span></span></span><span class="kobospan" id="kobo.1125.1"> command available</span><span id="dx1-894003"/><span class="kobospan" id="kobo.1126.1"> to the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1127.1">zsh</span></span><span class="kobospan" id="kobo.1128.1"> shell.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1129.1">The Anaconda repositories may have pre-built binaries, which can be downloaded and used by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1130.1">conda</span></span></span></span><span class="kobospan" id="kobo.1131.1"> tool. </span><span class="kobospan" id="kobo.1131.2">In cases where binaries aren’t available, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1132.1">conda</span></span></span></span><span class="kobospan" id="kobo.1133.1"> tool will download the source and build the binaries as needed. </span><span id="x1-894004r1872"/></p>
</section>
<section data-number="0.19.5.4" id="theres-more...-116">
<h2 class="likechapterhead" data-number="0.19.5.4"><span><span class="kobospan" id="kobo.1134.1">16.5.4 </span></span> <span id="x1-8950004"/><span class="kobospan" id="kobo.1135.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1136.1">One of the most common use cases is upgrading to the latest releases of packages. </span><span class="kobospan" id="kobo.1136.2">This is done with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1137.1">conda</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1138.1"> update</span></span></span></span><span class="kobospan" id="kobo.1139.1"> command:</span></p>
<pre class="programlisting" id="listing-141"><code class="calibre13"><span class="kobospan" id="kobo.1140.1">(cookbook3) % conda update pydantic</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1141.1">This will look for the version of the package available in the various channels being searched. </span><span class="kobospan" id="kobo.1141.2">It will compare the available version with what’s currently installed in the active virtual environment.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1142.1">To collaborate politely with tools like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1143.1">tox</span></span></span></span><span class="kobospan" id="kobo.1144.1"> for testing, it helps to use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1145.1">pip</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1146.1"> freeze</span></span></span></span><span class="kobospan" id="kobo.1147.1"> command to create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1148.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.1149.1"> file. </span><span class="kobospan" id="kobo.1149.2">By default, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1150.1">tox</span></span></span></span><span class="kobospan" id="kobo.1151.1"> uses </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1152.1">pip</span></span></span></span><span class="kobospan" id="kobo.1153.1"> to build virtual environments. </span><span class="kobospan" id="kobo.1153.2">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1154.1">PIP </span></span><span class="kobospan" id="kobo.1155.1">tool will not</span><span id="dx1-895002"/><span class="kobospan" id="kobo.1156.1"> overwrite packages installed by </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1157.1">conda</span></span><span class="kobospan" id="kobo.1158.1">, allowing them to coexist peacefully.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1159.1">Another choice is to use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1160.1">tox-conda</span></span></span></span><span class="kobospan" id="kobo.1161.1"> plug-in to allow the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1162.1">tox</span></span></span></span><span class="kobospan" id="kobo.1163.1"> tool to use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1164.1">conda</span></span></span></span><span class="kobospan" id="kobo.1165.1"> to create and manage virtual environments. </span><span class="kobospan" id="kobo.1165.2">See the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1166.1">tox-conda</span></span></span></span><span class="kobospan" id="kobo.1167.1"> repository at </span><a class="url" href="https://github.com/tox-dev/tox-conda"><span class="url1"><span class="kobospan" id="kobo.1168.1">https://github.com/tox-dev/tox-conda</span></span></a><span class="kobospan" id="kobo.1169.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1170.1">Not all libraries and packages are part of the Anaconda-supported, curated library. </span><span class="kobospan" id="kobo.1170.2">In many cases, we’ll need to step outside Anaconda and use the community </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1171.1">conda-forge</span></span></span></span><span class="kobospan" id="kobo.1172.1"> channel in addition to the Anaconda channel.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1173.1">We’ll often need to use a command like the following to use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1174.1">conda-forge</span></span></span></span><span class="kobospan" id="kobo.1175.1"> channel:</span></p>
<pre class="programlisting" id="listing-142"><code class="calibre13"><span class="kobospan" id="kobo.1176.1">(cookbook3) % conda install --channel=conda-forge tox</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1177.1">We can also use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1178.1">pip</span></span></span></span><span class="kobospan" id="kobo.1179.1"> to add packages to a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1180.1">conda</span></span></span></span><span class="kobospan" id="kobo.1181.1"> environment. </span><span class="kobospan" id="kobo.1181.2">It’s rarely needed, but it does work nicely. </span><span id="x1-895004r1873"/></p>
</section>
<section data-number="0.19.5.5" id="see-also-123">
<h2 class="likechapterhead" data-number="0.19.5.5"><span><span class="kobospan" id="kobo.1182.1">16.5.5 </span></span> <span id="x1-8960005"/><span class="kobospan" id="kobo.1183.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1184.1">See </span><a href="ch020_split_000.xhtml#x1-8650001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1185.1">Creating environments using the built-in venv</span></span></a><span class="kobospan" id="kobo.1186.1"> for more information on virtual environments.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1187.1">See </span><a class="url" href="https://www.anaconda.com/download"><span class="url1"><span class="kobospan" id="kobo.1188.1">https://www.anaconda.com/download</span></span></a><span class="kobospan" id="kobo.1189.1"> for the full Anaconda</span><span id="dx1-896001"/><span class="kobospan" id="kobo.1190.1"> installation.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1191.1">See </span><a class="url" href="https://docs.conda.io/projects/miniconda/en/latest/index.html"><span class="url1"><span class="kobospan" id="kobo.1192.1">https://docs.conda.io/projects/miniconda/en/latest/index.html</span></span></a><span class="kobospan" id="kobo.1193.1"> for the Miniconda installation.</span></p></li>
</ul>
<p class="normal1"><span id="x1-896002r1869"/></p>
</section>
</section>
<section data-number="0.19.6" id="using-the-poetry-tool">
<h1 class="unnumbered" data-number="0.19.6"><span><span class="kobospan" id="kobo.1194.1">16.6 </span></span> <span id="x1-8970006"/><span class="kobospan" id="kobo.1195.1">Using the poetry tool</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1196.1">The combination</span><span id="dx1-897001"/><span class="kobospan" id="kobo.1197.1"> of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1198.1">venv</span></span></span></span><span class="kobospan" id="kobo.1199.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1200.1">pip</span></span></span></span><span class="kobospan" id="kobo.1201.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1202.1">pip-tools</span></span></span></span><span class="kobospan" id="kobo.1203.1"> packages allows us to create virtual environments and populate them with packages from the PYPI package index.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1204.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1205.1">poetry </span></span><span class="kobospan" id="kobo.1206.1">tool is a virtual environment manager and package installer combined into a single tool. </span><span class="kobospan" id="kobo.1206.2">It fulfills the same use cases as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1207.1">PIP</span></span><span class="kobospan" id="kobo.1208.1">, combined with </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1209.1">venv </span></span><span class="kobospan" id="kobo.1210.1">and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1211.1">pip-tools</span></span></span></span><span class="kobospan" id="kobo.1212.1">. </span><span class="kobospan" id="kobo.1212.2">It also fulfills the same use cases as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1213.1">conda</span></span><span class="kobospan" id="kobo.1214.1">. </span><span class="kobospan" id="kobo.1214.2">The CLI is the same on all platforms, permitting simpler, more consistent documentation for developers using </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1215.1">Poetry </span></span><span class="kobospan" id="kobo.1216.1">to manage environments.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1217.1">There are some minor differences in the way Poetry enables a virtual environment. </span><span class="kobospan" id="kobo.1217.2">Rather than tweaking the current shell’s environment variables, it launches a sub-shell. </span><span class="kobospan" id="kobo.1217.3">The sub-shell has the required virtual environment settings. </span><span id="x1-897002r1874"/></p>
<section data-number="0.19.6.1" id="getting-ready-125">
<h2 class="likechapterhead" data-number="0.19.6.1"><span><span class="kobospan" id="kobo.1218.1">16.6.1 </span></span> <span id="x1-8980001"/><span class="kobospan" id="kobo.1219.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1220.1">Note that the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1221.1">Poetry </span></span><span class="kobospan" id="kobo.1222.1">tool must be installed in its own virtual environment, separate from any project managed by Poetry. </span><span class="kobospan" id="kobo.1222.2">This is best done by using the Poetry installer. </span><span class="kobospan" id="kobo.1222.3">This involves OS-specific commands to download and execute the installer. </span><span class="kobospan" id="kobo.1222.4">The installer is written in Python, which makes the task somewhat more consistent across OSs.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1223.1">See </span><a class="url" href="https://python-poetry.org/docs"><span class="url1"><span class="kobospan" id="kobo.1224.1">https://python-poetry.org/docs</span></span></a><span class="kobospan" id="kobo.1225.1"> for</span><span id="dx1-898001"/><span class="kobospan" id="kobo.1226.1"> details.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1227.1">There are two steps:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1228.1">Download</span><span id="dx1-898002"/><span class="kobospan" id="kobo.1229.1"> from </span><a class="url" href="https://install.python-poetry.org"><span class="url1"><span class="kobospan" id="kobo.1230.1">https://install.python-poetry.org</span></span></a><span class="kobospan" id="kobo.1231.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1232.1">Execute the downloaded Python script.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1233.1">The recommended commands vary slightly between operating systems:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1234.1">macOS</span></span><span class="kobospan" id="kobo.1235.1">, </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1236.1">Linux</span></span><span class="kobospan" id="kobo.1237.1">, and </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1238.1">Windows Subsystem for Linux</span></span><span class="kobospan" id="kobo.1239.1">: The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1240.1">curl</span></span></span></span><span class="kobospan" id="kobo.1241.1"> command is generally available</span><span id="dx1-898003"/><span class="kobospan" id="kobo.1242.1"> for doing the download. </span><span class="kobospan" id="kobo.1242.2">This command can be used:</span></p>
<pre class="programlisting" id="listing-143"><code class="calibre13"><span class="kobospan" id="kobo.1243.1">% curl -sSL https://install.python-poetry.org | python3 -</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1244.1">After this, the follow-on step will update the system </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1245.1">PATH</span></span></span></span><span class="kobospan" id="kobo.1246.1"> environment variable. </span><span class="kobospan" id="kobo.1246.2">The output from the installation will provide the location to use. </span><span class="kobospan" id="kobo.1246.3">These two examples are for </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1247.1">macOS</span></span></span></span><span class="kobospan" id="kobo.1248.1">, where the file is in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1249.1">~/.local/bin</span></span></span></span><span class="kobospan" id="kobo.1250.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1251.1">Edit the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1252.1">~/.zshrc</span></span></span></span><span class="kobospan" id="kobo.1253.1"> file to add the following line:</span></p>
<pre class="programlisting" id="listing-144"><code class="calibre13"><span class="kobospan" id="kobo.1254.1">export PATH="~/.local/bin:$PATH"</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1255.1">As an alternative, it is possible to define an alias for the location of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1256.1">poetry</span></span></span></span><span class="kobospan" id="kobo.1257.1"> command. </span><span class="kobospan" id="kobo.1257.2">This is often </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1258.1">~/.local/bin/poetry</span></span></span></span><span class="kobospan" id="kobo.1259.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1260.1">Windows Powershell</span></span><span class="kobospan" id="kobo.1261.1">: The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1262.1">Invoke-WebRequest</span></span></span></span><span class="kobospan" id="kobo.1263.1"> Powershell command</span><span id="dx1-898006"/><span class="kobospan" id="kobo.1264.1"> performs the download. </span><span class="kobospan" id="kobo.1264.2">The Python launcher, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1265.1">py</span></span></span></span><span class="kobospan" id="kobo.1266.1">, runs the appropriate version of Python:</span></p>
<pre class="programlisting" id="listing-145"><code class="calibre13"><span class="kobospan" id="kobo.1267.1">PS C:\&gt; (Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | py -</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1268.1">The script for poetry is placed in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1269.1">AppData\Roaming\Python\Scripts</span></span></span></span><span class="kobospan" id="kobo.1270.1"> sub-directory. </span><span class="kobospan" id="kobo.1270.2">Either add this to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1271.1">PATH</span></span></span></span><span class="kobospan" id="kobo.1272.1"> environment variable or use the path explicitly, for example: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1273.1">AppData\Roaming\Python\Scripts\poetry</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1274.1"> --version</span></span></span></span><span class="kobospan" id="kobo.1275.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1276.1">Changing the current working directory with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1277.1">chdir</span></span></span></span><span class="kobospan" id="kobo.1278.1"> means explicitly referring to your home directory’s </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1279.1">AppData</span></span></span></span><span class="kobospan" id="kobo.1280.1"> sub-directory.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1281.1">Once the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1282.1">poetry </span></span><span class="kobospan" id="kobo.1283.1">tool has been installed, it can be used</span><span id="dx1-898008"/><span class="kobospan" id="kobo.1284.1"> to create and populate virtual environments. </span><span id="x1-898009r1876"/></p>
</section>
<section data-number="0.19.6.2" id="how-to-do-it...-126">
<h2 class="likechapterhead" data-number="0.19.6.2"><span><span class="kobospan" id="kobo.1285.1">16.6.2 </span></span> <span id="x1-8990002"/><span class="kobospan" id="kobo.1286.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-899002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1287.1">Use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1288.1">poetry</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1289.1"> new</span></span></span></span><span class="kobospan" id="kobo.1290.1"> command to create a new project directory. </span><span class="kobospan" id="kobo.1290.2">This will not only create a virtual environment; it will also create a directory structure and create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1291.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.1292.1"> file:</span></p>
<pre class="programlisting" id="listing-146"><code class="calibre13"><span class="kobospan" id="kobo.1293.1">%  poetry new recipe_05</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1294.1">The virtual environment’s files are kept outside the project directory. </span><span class="kobospan" id="kobo.1294.2">For macOS, there will be a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1295.1">~/Library/Caches/pypoetry</span></span></span></span><span class="kobospan" id="kobo.1296.1"> directory that has all of the virtual environment files.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1297.1">Note that poetry tries to cooperate with other virtual environment tools. </span><span class="kobospan" id="kobo.1297.2">This means you can use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1298.1">venv</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1299.1"> activate</span></span></span></span><span class="kobospan" id="kobo.1300.1"> command to set the environment variables.</span></p>
</div></li>
<li class="calibre7"><div id="x1-899005x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1301.1">Rather than activate the environment within a shell’s environment, it’s often easier to start a sub-shell with the appropriate environment settings.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1302.1">Use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1303.1">poetry</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1304.1"> shell</span></span></span></span><span class="kobospan" id="kobo.1305.1"> command</span><span id="dx1-899006"/><span class="kobospan" id="kobo.1306.1"> to start a shell that has the virtual environment activated:</span></p>
<pre class="programlisting" id="listing-147"><code class="calibre13"><span class="kobospan" id="kobo.1307.1">% poetry shell</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1308.1">Use the shell’s </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1309.1">exit</span></span></span></span><span class="kobospan" id="kobo.1310.1"> command to terminate this sub-shell and return to the previous environment.</span></p>
</div></li>
<li class="calibre7"><div id="x1-899009x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1311.1">Use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1312.1">poetry</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1313.1"> add</span></span></span></span><span class="kobospan" id="kobo.1314.1"> command to add packages to the environment. </span><span class="kobospan" id="kobo.1314.2">This will both update the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1315.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.1316.1"> file and install the packages:</span></p>
<pre class="programlisting" id="listing-148"><code class="calibre13"><span class="kobospan" id="kobo.1317.1">% (recipe-05-py3.11) poetry add pydantic beautifulsoup4 jupyterlab matplotlib pytest memray</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1318.1">This also creates a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1319.1">poetry.lock</span></span></span></span><span class="kobospan" id="kobo.1320.1"> file that defines the exact versions of each dependency.</span></p>
</div></li>
</ol>
<p class="normal1"><span id="x1-899011r1877"/></p>
</section>
<section data-number="0.19.6.3" id="how-it-works...-126">
<h2 class="likechapterhead" data-number="0.19.6.3"><span><span class="kobospan" id="kobo.1321.1">16.6.3 </span></span> <span id="x1-9000003"/><span class="kobospan" id="kobo.1322.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1323.1">The virtual environment created by </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1324.1">poetry </span></span><span class="kobospan" id="kobo.1325.1">has the proper </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1326.1">PATH</span></span></span></span><span class="kobospan" id="kobo.1327.1"> environment variable set to point to a specific Python binary. </span><span class="kobospan" id="kobo.1327.2">The standard library packages and site-specific packages are located in nearby directories. </span><span class="kobospan" id="kobo.1327.3">Poetry properly leverages the information in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1328.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.1329.1"> file, reducing the number of additional files required to define the working environment.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1330.1">In order to work consistently, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1331.1">poetry</span></span></span></span><span class="kobospan" id="kobo.1332.1"> command must be visible. </span><span class="kobospan" id="kobo.1332.2">This means either adding the poetry location to the system </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1333.1">PATH</span></span></span></span><span class="kobospan" id="kobo.1334.1"> environment variable or using an alias. </span><span class="kobospan" id="kobo.1334.2">This is a crucial step in using </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1335.1">poetry</span></span><span class="kobospan" id="kobo.1336.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1337.1">The alternative to an alias is what is shown in the recipe, using </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1338.1">~/.local/bin/poetry</span></span></span></span><span class="kobospan" id="kobo.1339.1"> explicitly. </span><span class="kobospan" id="kobo.1339.2">This is less than optimal, but it makes the relationship between the current working virtual environment</span><span id="dx1-900001"/><span class="kobospan" id="kobo.1340.1"> and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1341.1">poetry</span></span></span></span><span class="kobospan" id="kobo.1342.1"> command more clear. </span><span id="x1-900002r1878"/></p>
</section>
<section data-number="0.19.6.4" id="theres-more...-117">
<h2 class="likechapterhead" data-number="0.19.6.4"><span><span class="kobospan" id="kobo.1343.1">16.6.4 </span></span> <span id="x1-9010004"/><span class="kobospan" id="kobo.1344.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1345.1">One of the most common use cases for an environment and tool like Poetry is upgrading to the latest releases of packages. </span><span class="kobospan" id="kobo.1345.2">This is done with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1346.1">poetry</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1347.1"> update</span></span></span></span><span class="kobospan" id="kobo.1348.1"> command. </span><span class="kobospan" id="kobo.1348.2">A specific list of packages can be provided. </span><span class="kobospan" id="kobo.1348.3">With no parameters, all packages are examined.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1349.1">Here’s an example:</span></p>
<pre class="programlisting" id="listing-149"><code class="calibre13"><span class="kobospan" id="kobo.1350.1">% (recipe-05-py3.11) poetry update pydantic</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1351.1">This will look for the version of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1352.1">pydantic</span></span></span></span><span class="kobospan" id="kobo.1353.1"> package available in the various channels being searched and compare that version with what’s currently installed in the active virtual environment. </span><span class="kobospan" id="kobo.1353.2">This will also update the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1354.1">poetry.lock</span></span></span></span><span class="kobospan" id="kobo.1355.1"> file after installing the updates.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1356.1">To collaborate politely with tools like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1357.1">tox</span></span></span></span><span class="kobospan" id="kobo.1358.1"> for testing, some additional options are required in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1359.1">tox.ini</span></span></span></span><span class="kobospan" id="kobo.1360.1"> file. </span><span class="kobospan" id="kobo.1360.2">One easy-to-use approach is to skip the default install procedure that </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1361.1">tox</span></span></span></span><span class="kobospan" id="kobo.1362.1"> uses and use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1363.1">poetry</span></span></span></span><span class="kobospan" id="kobo.1364.1"> commands to run commands in a poetry-managed environment.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1365.1">Here’s a suggestion of how to use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1366.1">poetry</span></span></span></span><span class="kobospan" id="kobo.1367.1"> with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1368.1">tox</span></span></span></span><span class="kobospan" id="kobo.1369.1">:</span></p>
<pre class="programlisting" id="listing-150"><code class="calibre13"><span class="kobospan" id="kobo.1370.1">[tox] 
 
isolated_build = true 
 
 
 
[testenv] 
 
skip_install = true 
 
allowlist_externals = poetry 
 
commands_pre = 
 
    poetry install 
 
commands = 
 
    poetry run pytest tests/ --import-mode importlib</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1371.1">Using </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1372.1">poetry</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1373.1"> run</span></span></span></span><span class="kobospan" id="kobo.1374.1"> means the command will be executed in the virtual environment. </span><span class="kobospan" id="kobo.1374.2">This makes it possible to use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1375.1">tox</span></span></span></span><span class="kobospan" id="kobo.1376.1"> to define multiple environments, and rely on Poetry to assemble the various environments for testing purposes. </span><span id="x1-901012r1879"/></p>
</section>
<section data-number="0.19.6.5" id="see-also-124">
<h2 class="likechapterhead" data-number="0.19.6.5"><span><span class="kobospan" id="kobo.1377.1">16.6.5 </span></span> <span id="x1-9020005"/><span class="kobospan" id="kobo.1378.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1379.1">See </span><a class="url" href="https://python-poetry.org/docs"><span class="url1"><span class="kobospan" id="kobo.1380.1">https://python-poetry.org/docs</span></span></a><span class="kobospan" id="kobo.1381.1"> for details</span><span id="dx1-902001"/><span class="kobospan" id="kobo.1382.1"> on Poetry.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1383.1">See </span><a class="url" href="https://tox.wiki/en/4.15.1/"><span class="url1"><span class="kobospan" id="kobo.1384.1">https://tox.wiki/en/4.15.1/</span></span></a><span class="kobospan" id="kobo.1385.1"> for details</span><span id="dx1-902002"/><span class="kobospan" id="kobo.1386.1"> on Tox.</span></p></li>
</ul>
<p class="normal1"><span id="x1-902003r1875"/></p>
</section>
</section>
<section data-number="0.19.7" id="coping-with-changes-in-dependencies">
<h1 class="unnumbered" data-number="0.19.7"><span><span class="kobospan" id="kobo.1387.1">16.7 </span></span> <span id="x1-9030007"/><span class="kobospan" id="kobo.1388.1">Coping with changes in dependencies</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1389.1">As we noted in the </span><a href="ch020_split_000.xhtml#x1-8730002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1390.1">Installing packages with a requirements.txt file</span></span></a><span class="kobospan" id="kobo.1391.1">, all packages on which an application is built are in a constant state of flux. </span><span class="kobospan" id="kobo.1391.2">Each project has a distinct tempo for updates. </span><span class="kobospan" id="kobo.1391.3">To manage the constant</span><span id="dx1-903001"/><span class="kobospan" id="kobo.1392.1"> change, it’s important for people developing applications to track dependencies carefully.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1393.1">A common complaint about Python is sometimes summarized as dependency hell. </span><span class="kobospan" id="kobo.1393.2">This summarizes the work required to track and test with new dependencies, some of which may be in conflict. </span><span class="kobospan" id="kobo.1393.3">This work to manage change is essential; it’s the minimum required to maintain a viable product. </span><span class="kobospan" id="kobo.1393.4">Instead of adding features, it preserves functionality in a world of constant change.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1394.1">There are two common cases where upgrades turn into more than simply installing and testing with upgraded packages:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1395.1">Changes that break our application in some way</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1396.1">Incompatibilities among packages our application depends on</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1397.1">In the first case, our software fails to work. </span><span class="kobospan" id="kobo.1397.2">In the second case, we can’t even build a virtual environment in which to test. </span><span class="kobospan" id="kobo.1397.3">This second case is often the most frustrating. </span><span id="x1-903002r1880"/></p>
<section data-number="0.19.7.1" id="getting-ready-126">
<h2 class="likechapterhead" data-number="0.19.7.1"><span><span class="kobospan" id="kobo.1398.1">16.7.1 </span></span> <span id="x1-9040001"/><span class="kobospan" id="kobo.1399.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1400.1">We’ll consider a hypothetical</span><span id="dx1-904001"/><span class="kobospan" id="kobo.1401.1"> project, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1402.1">applepie</span></span></span></span><span class="kobospan" id="kobo.1403.1"> application. </span><span class="kobospan" id="kobo.1403.2">This application has several dependencies:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1404.1">A single module from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1405.1">apple</span></span></span></span><span class="kobospan" id="kobo.1406.1"> project’s package, named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1407.1">apple.granny_smith</span></span></span></span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1408.1">Some classes from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1409.1">pie_filling</span></span></span></span><span class="kobospan" id="kobo.1410.1"> project</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1411.1">Several classes from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1412.1">pastry_crust</span></span></span></span><span class="kobospan" id="kobo.1413.1"> project</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1414.1">An </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1415.1">oven</span></span></span></span><span class="kobospan" id="kobo.1416.1"> implementation</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1417.1">The general dependencies are named in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1418.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.1419.1"> file as a list of projects. </span><span class="kobospan" id="kobo.1419.2">We can imagine the detailed </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1420.1">requirements.txt</span></span></span></span><span class="kobospan" id="kobo.1421.1"> (or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1422.1">poetry.lock</span></span></span></span><span class="kobospan" id="kobo.1423.1">) file looks like the following:</span></p>
<pre class="programlisting" id="listing-151"><code class="calibre13"><span class="kobospan" id="kobo.1424.1">apple == 2.7.18 
 
pie_filling = 3.1.4 
 
pastry_crust &gt;= 4.2 
 
oven == 0.9.1a</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1425.1">Using this framework for an application, we’ll look at what changes we need to make when we see changes in the dependencies. </span><span class="kobospan" id="kobo.1425.2">One change will remove needed functionality; the other change will be an incompatibility between releases of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1426.1">pie_filling</span></span></span></span><span class="kobospan" id="kobo.1427.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1428.1">pastry_crust</span></span></span></span><span class="kobospan" id="kobo.1429.1"> projects. </span><span class="kobospan" id="kobo.1429.2">We’ll need to make appropriate changes in our application based on these changes occurring in the larger Python ecosystem. </span><span id="x1-904006r1882"/></p>
</section>
<section data-number="0.19.7.2" id="how-to-do-it...-127">
<h2 class="likechapterhead" data-number="0.19.7.2"><span><span class="kobospan" id="kobo.1430.1">16.7.2 </span></span> <span id="x1-9050002"/><span class="kobospan" id="kobo.1431.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1432.1">We’ll decompose this into two sub-recipes: one for a dependency that leads to a test failure, and the second for dependencies that are incompatible. </span><span class="kobospan" id="kobo.1432.2">We need to adjust our project so it continues to work in the presence of ongoing change.</span></p>
<section data-number="0.19.7.2.1" id="a-change-caused-a-test-failure">
<h3 class="likesubsubsectionhead" data-number="0.19.7.2.1"><span id="x1-9060002"/><span class="kobospan" id="kobo.1433.1">A change caused a test failure</span></h3>
<p class="normal"><span class="kobospan" id="kobo.1434.1">To continue our example, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1435.1">oven</span></span></span></span><span class="kobospan" id="kobo.1436.1"> tool</span><span id="dx1-906001"/><span class="kobospan" id="kobo.1437.1"> has had a significant change to the API. </span><span class="kobospan" id="kobo.1437.2">The new release, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1438.1">oven</span></span></span></span><span class="kobospan" id="kobo.1439.1"> version 1.0, doesn’t have the same interface version 0.9.1a had. </span><span class="kobospan" id="kobo.1439.2">The consequence is a failure in our code:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-906003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1440.1">Clarify what the failure is and what caused it. </span><span class="kobospan" id="kobo.1440.2">Ask ”why?” </span><span class="kobospan" id="kobo.1440.3">enough times to identify the root cause. </span><span class="kobospan" id="kobo.1440.4">There are several aspects of the failure that may need to be explored.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1441.1">Be sure to understand the top layer of the problem: how the failure manifested itself. </span><span class="kobospan" id="kobo.1441.2">Ideally, a unit test failed. </span><span class="kobospan" id="kobo.1441.3">Another good</span><span id="dx1-906004"/><span class="kobospan" id="kobo.1442.1"> avenue for detection is to use a tool like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1443.1">mypy </span></span><span class="kobospan" id="kobo.1444.1">or </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1445.1">ruff </span></span><span class="kobospan" id="kobo.1446.1">to identify a potential</span><span id="dx1-906005"/><span class="kobospan" id="kobo.1447.1"> for failure. </span><span class="kobospan" id="kobo.1447.2">Less helpful is an acceptance or system test that failed even though unit tests all passed. </span><span class="kobospan" id="kobo.1447.3">Perhaps the worst case is failure after deployment, in the hands of a customer.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1448.1">Also, be sure to understand what changed. </span><span class="kobospan" id="kobo.1448.2">It’s common to introduce a number of version upgrades all at once. </span><span class="kobospan" id="kobo.1448.3">It may be necessary to reverse those changes and then upgrade each required package one at a time to identify the source of the failure.</span></p>
</div></li>
<li class="calibre7"><div id="x1-906007x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1449.1">Failures after a release often lead to problem reports in issue-tracking tools. </span><span class="kobospan" id="kobo.1449.2">Update any issue-tracking software with the root cause analysis.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1450.1">Failures during testing should also lead to an internal report of a problem. </span><span class="kobospan" id="kobo.1450.2">The repair may require extensive rework, and it is generally helpful to track the reason for the rework.</span></p>
</div></li>
<li class="calibre7"><div id="x1-906009x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1451.1">Choose among the four kinds</span><span id="dx1-906010"/><span class="kobospan" id="kobo.1452.1"> of fixes that are possible:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-906012x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1453.1">Your code needs to be fixed. </span><span class="kobospan" id="kobo.1453.2">The change to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1454.1">oven</span></span></span></span><span class="kobospan" id="kobo.1455.1"> version 1.0 is a clear improvement.</span></p>
</div></li>
<li class="calibre7"><div id="x1-906014x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1456.1">The change to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1457.1">oven</span></span></span></span><span class="kobospan" id="kobo.1458.1"> introduced a bug, and you need to report the problem to the maintainers of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1459.1">oven</span></span></span></span><span class="kobospan" id="kobo.1460.1"> or fix their code.</span></p>
</div></li>
<li class="calibre7"><div id="x1-906016x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1461.1">Revise the dependencies to pin </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1462.1">oven</span></span></span></span><span class="kobospan" id="kobo.1463.1"> version 0.9.1a in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1464.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.1465.1"> to prevent upgrades.</span></p>
</div></li>
<li class="calibre7"><div id="x1-906018x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1466.1">Looking closely at the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1467.1">oven</span></span></span></span><span class="kobospan" id="kobo.1468.1"> project, it may be clear it is no longer a good fit with this project, and it needs to be replaced.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1469.1">These are not exclusive choices. </span><span class="kobospan" id="kobo.1469.2">In some cases, multiple paths will be followed.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1470.1">There may be a pervasive change to our project required to accommodate the changes to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1471.1">oven</span></span></span></span><span class="kobospan" id="kobo.1472.1"> 1.0. </span><span class="kobospan" id="kobo.1472.2">This may be an opportunity to refactor our code to more carefully isolate this dependency to simplify making changes in the future.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1473.1">When a project seems to have a bug, we have two choices: we can report the issue and hope it’s fixed, or we can clone the repository, make a fix, and submit a pull request to pull our changes into the next release. </span><span class="kobospan" id="kobo.1473.2">The benefit of open source is the reduced cost to begin a project. </span><span class="kobospan" id="kobo.1473.3">Ongoing maintenance, however, is an eternal feature of a landscape that thrives on innovation. </span><span class="kobospan" id="kobo.1473.4">While we benefit from other’s work in open source, we also need to contribute by proposing fixes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1474.1">In some cases, we will pin a specific version while we decide what to do about a dependency. </span><span class="kobospan" id="kobo.1474.2">We may pin an old version while choosing among alternatives and rewriting our project to replace</span><span id="dx1-906019"/><span class="kobospan" id="kobo.1475.1"> the old </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1476.1">oven</span></span></span></span><span class="kobospan" id="kobo.1477.1"> with the new </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1478.1">convection_cooker</span></span></span></span><span class="kobospan" id="kobo.1479.1">.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1480.1">In effect, code that breaks due to an upgrade is a bug fix. </span><span class="kobospan" id="kobo.1480.2">It may be a bug fix for a project we require. </span><span class="kobospan" id="kobo.1480.3">More often, the fix is applied in our project to make use of a change in other projects. </span><span class="kobospan" id="kobo.1480.4">Managing changes to our application is the price we pay for innovation in the broad ecosystem of Python packages.</span></p>
</section>
<section data-number="0.19.7.2.2" id="a-changed-dependency-is-incompatible-with-another-dependency">
<h3 class="likesubsubsectionhead" data-number="0.19.7.2.2"><span id="x1-9070002"/><span class="kobospan" id="kobo.1481.1">A changed dependency is incompatible with another dependency</span></h3>
<p class="normal"><span class="kobospan" id="kobo.1482.1">In this case, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1483.1">pastry_crust</span></span></span></span><span class="kobospan" id="kobo.1484.1"> version 4.3 uses</span><span id="dx1-907001"/> <span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1485.1">sugar</span></span></span></span><span class="kobospan" id="kobo.1486.1"> version 2.0. </span><span class="kobospan" id="kobo.1486.2">Sadly, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1487.1">pie_filling</span></span></span></span><span class="kobospan" id="kobo.1488.1"> version 3.1.4 uses the older </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1489.1">sugar</span></span></span></span><span class="kobospan" id="kobo.1490.1"> version 1.8.</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-907003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1491.1">Identify the root cause of the conflict, to the extent possible. </span><span class="kobospan" id="kobo.1491.2">Trying to discern why the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1492.1">pie_filling</span></span></span></span><span class="kobospan" id="kobo.1493.1"> project team has not upgraded to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1494.1">sugar</span></span></span></span><span class="kobospan" id="kobo.1495.1"> version 2.0 may be very difficult. </span><span class="kobospan" id="kobo.1495.2">A common observation is a lack of activity in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1496.1">pie_filling</span></span></span></span><span class="kobospan" id="kobo.1497.1"> project; but without knowing the principal contributors well, it’s difficult to ask why they aren’t making changes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1498.1">Be perfectly clear in identifying what changed. </span><span class="kobospan" id="kobo.1498.2">It’s common to introduce a number of version upgrades all at once. </span><span class="kobospan" id="kobo.1498.3">It may be necessary to reverse those changes and then upgrade each required package one at a time to identify the source of the failure. </span><span class="kobospan" id="kobo.1498.4">These conflicts are not in a direct dependency, but in an indirect dependency.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1499.1">We value the idea of encapsulation and abstraction right up until we observe conflicting requirements that are encapsulated by a project. </span><span class="kobospan" id="kobo.1499.2">When these conflicts appear, the obscurity of encapsulation becomes a burden.</span></p>
</div></li>
<li class="calibre7"><div id="x1-907005x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1500.1">Document the conflict as an issue in issue-tracking software. </span><span class="kobospan" id="kobo.1500.2">Be sure to provide links to the conflicting projects and their issue trackers. </span><span class="kobospan" id="kobo.1500.3">The resolution may involve extended side-bar conversations with other projects to understand the nature of the conflicting requirements. </span><span class="kobospan" id="kobo.1500.4">It helps to keep notes on these conversations.</span></p>
</div></li>
<li class="calibre7"><div id="x1-907007x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1501.1">Choose among the four kinds of fixes that are possible:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-907009x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1502.1">It’s unlikely any small change to your code will resolve the problem. </span><span class="kobospan" id="kobo.1502.2">The change required is replacing the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1503.1">pie_filling</span></span></span></span><span class="kobospan" id="kobo.1504.1"> requirement with something else and making sweeping changes.</span></p>
</div></li>
<li class="calibre7"><div id="x1-907011x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1505.1">It’s possible that changes to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1506.1">pie_filling</span></span></span></span><span class="kobospan" id="kobo.1507.1"> project may correct the problem. </span><span class="kobospan" id="kobo.1507.2">This may involve a great deal of work on someone else’s project.</span></p>
</div></li>
<li class="calibre7"><div id="x1-907013x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1508.1">Revise the dependencies to pin </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1509.1">pastry_crust</span></span></span></span><span class="kobospan" id="kobo.1510.1"> version 4.2 in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1511.1">pyproject.toml</span></span></span></span><span class="kobospan" id="kobo.1512.1"> to prevent upgrades.</span></p>
</div></li>
<li class="calibre7"><div id="x1-907015x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1513.1">Looking closely at the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1514.1">pie_filling</span></span></span></span><span class="kobospan" id="kobo.1515.1"> project, it may be clear it is no longer a good fit for this project and needs to be replaced. </span><span class="kobospan" id="kobo.1515.2">This is a sweeping change to the project.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1516.1">These choices are not exclusive. </span><span class="kobospan" id="kobo.1516.2">In some</span><span id="dx1-907016"/><span class="kobospan" id="kobo.1517.1"> cases, multiple paths will be followed. </span><span class="kobospan" id="kobo.1517.2">Perhaps the most popular choice is pinning the version that prevents the compatibility problem.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1518.1">The rework to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1519.1">pie_filling</span></span></span></span><span class="kobospan" id="kobo.1520.1"> project can involve two activities: we can report the issue and hope they fix it, or we can clone their repository, make a fix, and submit a pull request to pull our changes into their next release. </span><span class="kobospan" id="kobo.1520.2">This kind of ongoing maintenance of open source software created by others is an eternal feature of a landscape that thrives on innovation.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1521.1">Incompatibilities among the required supporting projects is an architectural problem. </span><span class="kobospan" id="kobo.1521.2">It’s rarely solved quickly. </span><span class="kobospan" id="kobo.1521.3">An important lesson</span><span id="dx1-907017"/><span class="kobospan" id="kobo.1522.1"> learned from this kind of problem is that all architectural decisions need to be revocable: any choice needs to have an alternative, and the software needs to be written so that either alternative can be exercised. </span><span id="x1-907018r1883"/></p>
</section>
</section>
<section data-number="0.19.7.3" id="how-it-works...-127">
<h2 class="likechapterhead" data-number="0.19.7.3"><span><span class="kobospan" id="kobo.1523.1">16.7.3 </span></span> <span id="x1-9080003"/><span class="kobospan" id="kobo.1524.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1525.1">The essential step here is doing root</span><span id="dx1-908001"/><span class="kobospan" id="kobo.1526.1"> cause analysis: asking ”why?” </span><span class="kobospan" id="kobo.1526.2">something fails to pass tests when upgrades are attempted.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1527.1">For example, our </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1528.1">applepie</span></span></span></span><span class="kobospan" id="kobo.1529.1"> project’s dependencies may pin </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1530.1">oven</span></span></span></span><span class="kobospan" id="kobo.1531.1"> version 0.9.1a because version 1.0 introduced a failure. </span><span class="kobospan" id="kobo.1531.2">The pinned version may be appropriate for a few hours until the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1532.1">oven</span></span></span></span><span class="kobospan" id="kobo.1533.1"> project fixes a bug, or it could remain in place for a much longer period of time. </span><span class="kobospan" id="kobo.1533.2">Our project may go through several releases before the problem with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1534.1">oven</span></span></span></span><span class="kobospan" id="kobo.1535.1"> 1.0 is finally fixed by release 1.1.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1536.1">It requires some discipline to review the requirements and make sure any pinned versions still need to be pinned. </span><span id="x1-908002r1886"/></p>
</section>
<section data-number="0.19.7.4" id="theres-more...-118">
<h2 class="likechapterhead" data-number="0.19.7.4"><span><span class="kobospan" id="kobo.1537.1">16.7.4 </span></span> <span id="x1-9090004"/><span class="kobospan" id="kobo.1538.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1539.1">One source of frustration with dependency hell is the lack of time budgeted for finding and fixing dependency problems. </span><span class="kobospan" id="kobo.1539.2">In an enterprise context, this is an acute problem because project sponsors and managers are often narrowly focused on budget and the time required to implement new features. </span><span class="kobospan" id="kobo.1539.3">Time to resolve dependency issues is rarely part of the budget because these problems are so difficult to anticipate.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1540.1">A terrible situation can arise where fixing dependency problems is counted against a team’s velocity metric. </span><span class="kobospan" id="kobo.1540.2">This can happen when there are no ”story points” assigned to upgrading the dependencies and rerunning the test suite. </span><span class="kobospan" id="kobo.1540.3">In this case, the organization has created a perverse incentive to pin versions forever, without following the progress of other projects.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1541.1">It’s imperative to have a periodic task to review each and every requirement. </span><span class="kobospan" id="kobo.1541.2">This task involves seeing what changes have been made and what may have been deprecated since the last review. </span><span class="kobospan" id="kobo.1541.3">This may lead to modifying project version constraints. </span><span class="kobospan" id="kobo.1541.4">For example, we may be able to relax the requirement from a strict </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1542.1">oven==0.9.1a</span></span></span></span><span class="kobospan" id="kobo.1543.1"> to a more lenient </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1544.1">oven!=1.0</span></span></span></span><span class="kobospan" id="kobo.1545.1">.</span></p>
<div class="tipbox" id="tcolobox-34">
<div class="note">
<p class="normal1"><span class="kobospan" id="kobo.1546.1">A periodic task to review all requirements is an essential ingredient in managing change and innovation.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1547.1">Look for updates as well as deprecations.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1548.1">Allocate time to run tests with new versions and report the bugs discovered.</span></p>
</div>
</div>
<p class="normal1"><span id="x1-909001r1887"/></p>
</section>
<section data-number="0.19.7.5" id="see-also-125">
<h2 class="likechapterhead" data-number="0.19.7.5"><span><span class="kobospan" id="kobo.1549.1">16.7.5 </span></span> <span id="x1-9100005"/><span class="kobospan" id="kobo.1550.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1551.1">See </span><a href="ch020_split_000.xhtml#x1-8850004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1552.1">Using pip-tools to manage the requirements.txt file</span></span></a><span class="kobospan" id="kobo.1553.1"> for a very good dependency resolver.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1554.1">See </span><a href="ch020_split_001.xhtml#x1-8910005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1555.1">Using Anaconda and the conda tool</span></span></a><span class="kobospan" id="kobo.1556.1"> for an approach to using the conda repository of curated, compatible software releases.</span></p></li>
</ul>
<p class="normal1"><span id="x1-910001r1881"/></p>
</section>
</section>
<section data-number="0.19.8" id="section-30">
<h1 class="unnumbered" data-number="0.19.8"><span><span class="kobospan" id="kobo.1557.1">16.8 </span></span> <span id="x1-9110008"/></h1>
<p class="normal"><span id="x1-911001r1889"/></p>
</section>
<section data-number="0.19.10" id="join-our-community-discord-space-16">
<h1 class="unnumbered" data-number="0.19.10"><span id="x1-9130009"/><span class="kobospan" id="kobo.1558.1">Join our community Discord space</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1559.1">Join our Python Discord workspace to discuss and find out more about the book: </span><a class="url" href="https://packt.link/dHrHU"><span class="url1"><span class="kobospan" id="kobo.1560.1">https://packt.link/dHrHU</span></span></a></p>
<p class="normal1"><span class="kobospan" id="kobo.1561.1"><img alt="PIC" src="../media/file1.png" class="calibre9"/></span></p>
<p class="normal1"><span id="x1-913001r1840"/></p>
</section>
</section>
</body></html>