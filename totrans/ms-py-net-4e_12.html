<html><head></head><body>
  <div class="Basic-Text-Frame" id="_idContainer226">
    <h1 class="chapterNumber">12</h1>
    <h1 class="chapterTitle" id="_idParaDest-259">Azure Cloud Networking</h1>
    <p class="normal">As we saw in <em class="chapterRef">Chapter 11</em>, <em class="italic">AWS Cloud Networking</em>, cloud-based networking helps us connect our organization’s cloud-based resources. A <strong class="keyWord">virtual</strong> <strong class="keyWord">network</strong> (<strong class="keyWord">VNet</strong>) can be used to segment and secure our<a id="_idIndexMarker913"/> virtual machines. It can also connect our on-premise resources to the cloud. As the first pioneer in this space, AWS is often regarded as the market leader, with the biggest market share. In this chapter, we will look at another important public cloud provider, Microsoft Azure, focusing on their cloud-based network products.</p>
    <p class="normal">Microsoft Azure originally started as a project codenamed “Project Red Dog” in 2008 and was publicly released on February 1, 2010. At the time, it was named “Windows Azure” before being renamed “Microsoft Azure” in 2014. Since AWS released its first product, S3, in 2006, it essentially had a 6-year lead over Microsoft Azure. Attempting to catch up with AWS was no small task, even for a company with Microsoft’s vast amount of resources. At the same time, Microsoft has its unique competitive advantages from years of successful products and relationships with its enterprise customer base.</p>
    <p class="normal">As Azure focuses on leveraging the existing Microsoft product offerings and customer relationships, there are some important implications regarding Azure cloud networking. For example, one of the main drivers for a customer to establish an ExpressRoute connection with Azure, their AWS Direct Connect equivalent, might be a better experience with Office 365. Another example might be that the customer already has a service-level agreement with Microsoft that can be extended to Azure.</p>
    <p class="normal">In this chapter, we will discuss the networking services offered by Azure and how we can use Python to work with them. Since we already introduced some of the cloud networking concepts in the last chapter, we will draw on those lessons, comparing AWS and Azure networking when applicable.</p>
    <p class="normal">In particular, we will discuss:</p>
    <ul>
      <li class="bulletList">The Azure setup and a networking overview.</li>
      <li class="bulletList">Azure <strong class="keyWord">virtual networks</strong> (in the form of VNets). An Azure VNet is similar to an AWS VPC. It provides customers with a private network in the Azure cloud.</li>
      <li class="bulletList">ExpressRoute and VPNs.</li>
      <li class="bulletList">Azure Network Load Balancers.</li>
      <li class="bulletList">Other Azure network services.</li>
    </ul>
    <p class="normal">We already learned many of the important cloud networking concepts in the last chapter. Let’s leverage that knowledge and start by comparing the services offered by Azure and AWS.</p>
    <h1 class="heading-1" id="_idParaDest-260">Azure and AWS network service comparison</h1>
    <p class="normal">When <a id="_idIndexMarker914"/>Azure launched, they were more <a id="_idIndexMarker915"/>focused on <strong class="keyWord">Software-as-a-Service</strong> (<strong class="keyWord">SaaS</strong>) and <strong class="keyWord">Platform-as-a-Service</strong> (<strong class="keyWord">PaaS</strong>), with<a id="_idIndexMarker916"/> less of a focus <a id="_idIndexMarker917"/>on <strong class="keyWord">Infrastructure-as-a-Service</strong> (<strong class="keyWord">IaaS</strong>). For SaaS and PaaS, the networking services at the lower layers are often abstracted away from the user. For example, the SaaS offering of Office 365 is often offered as a remotely hosted endpoint that can be reached over the public internet. The PaaS offering of building web applications using Azure App Service is often done via a fully managed process, via popular frameworks such as .NET or Node.js.</p>
    <p class="normal">The IaaS offering, on the other hand, requires us to build our infrastructure in the Azure cloud. As the undisputed leader in the space, much of the target audience already has experience with AWS. To help with the transition, Azure provides an “AWS to Azure Service Comparison” (<a href="https://docs.microsoft.com/en-us/azure/architecture/aws-professional/services"><span class="url">https://docs.microsoft.com/en-us/azure/architecture/aws-professional/services</span></a>) on their website. This<a id="_idIndexMarker918"/> is a handy page that I often visit when I am confused about the equivalent Azure offering in comparison to AWS, especially when the service name is not directly illustrative of the service it provides. (I mean, can you tell what SageMaker is from looking at the name? I rest my case.)</p>
    <p class="normal">I often use this page for competitive analysis as well. For example, when I need to compare the cost of a dedicated connection with AWS and Azure, I start with this page to verify that the equivalent service of AWS Direct Connect is Azure ExpressRoute, then use the link to get more details about the service.</p>
    <p class="normal">If we scroll <a id="_idIndexMarker919"/>down on the page to the <strong class="screenText">Networking</strong> section, we can see that Azure offers many similar products to AWS, such as VNet, VPN Gateway, and Load Balancer. Some of the services may have different names, such as Route 53 and Azure DNS, but the underlying services are the same.</p>
    <figure class="mediaobject"><img alt="Table  Description automatically generated" src="../Images/B18403_12_01.png"/></figure>
    <p class="packt_figref">Figure 12.1: Azure networking services (source: https://docs.microsoft.com/en-us/azure/architecture/aws-professional/services) </p>
    <p class="normal">There are some feature differences between Azure and AWS networking products. For example, for global traffic load balancing using DNS, AWS uses the same Route 53 product, while Azure breaks it into a separate product called Traffic Manager. When we dig deeper into the products, some differences might make a difference depending on usage. For example, Azure Load Balancer, by default, allows session affinity, a.k.a. a sticky session, whereas the AWS load balancer needs to be configured explicitly.</p>
    <p class="normal">But for the most part, the high-level <a id="_idIndexMarker920"/>network products and services from Azure are similar to what we learned from AWS. This is the good news. The bad news is that just because the features are the same, it does not mean we can have a 1:1 overlay between the two. </p>
    <p class="normal">The building tools are different, and the implementation details can sometimes throw off someone new to the Azure platform. We will point out some of the differences when we discuss the products in the following sections. Let’s begin by talking about the setup process for Azure.</p>
    <h1 class="heading-1" id="_idParaDest-261">Azure setup</h1>
    <p class="normal">Setting<a id="_idIndexMarker921"/> up an Azure account is straightforward. Just like AWS, there are many services and incentives that Azure offers to attract users in the highly competitive public cloud market. Please<a id="_idIndexMarker922"/> check out the <a href="https://azure.microsoft.com/en-us/free/"><span class="url">https://azure.microsoft.com/en-us/free/</span></a> page for the latest offerings. At the time of writing, Azure is offering many popular services free for 12 months and 40+ other services as always free:</p>
    <figure class="mediaobject"><img alt="A screenshot of a computer  Description automatically generated with medium confidence" src="../Images/B18403_12_02.png"/></figure>
    <p class="packt_figref">Figure 12.2: Azure portal (source: https://azure.microsoft.com/en-us/free/)</p>
    <p class="normal">After the<a id="_idIndexMarker923"/> account is created, we can see the services available on the Azure portal at <a href="https://portal.azure.com"><span class="url">https://portal.azure.com</span></a>:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_12_03.png"/></figure>
    <p class="packt_figref">Figure 12.3: Azure services</p>
    <div class="note">
      <p class="normal">The web pages might change by the time you read this chapter. They are generally intuitive navigation changes that are easy to maneuver, even if they look a little different. </p>
    </div>
    <p class="normal">Before <a id="_idIndexMarker924"/>any service can be launched, however, we will need to provide a payment method. This is done by adding a subscription service:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B18403_12_04.png"/></figure>
    <p class="packt_figref">Figure 12.4: Azure subscriptions</p>
    <p class="normal">I would recommend adding a pay-as-you-go plan, which has no upfront costs and no long-term commitment, but we also have the option to purchase various levels of support with the subscription plan.</p>
    <p class="normal">Once the subscription is added, we<a id="_idIndexMarker925"/> can start looking at the various ways to administer and build in the Azure cloud, as detailed in the following section.</p>
    <h1 class="heading-1" id="_idParaDest-262">Azure administration and APIs</h1>
    <p class="normal">The Azure portal<a id="_idIndexMarker926"/> is the <a id="_idIndexMarker927"/>sleekest and most modern portal of the top public cloud providers, including AWS and Google Cloud. We can change the settings of the portal from the settings icon on the top management bar, including the language and region:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_12_05.png"/></figure>
    <p class="packt_figref">Figure 12.5: Azure portal in different languages</p>
    <p class="normal">There are many ways to <a id="_idIndexMarker928"/>manage Azure services: the portal, the Azure CLI, RESTful APIs, and the various client libraries. Besides the point-and-click management interface, the Azure portal also provides a handy shell <a id="_idIndexMarker929"/>called Azure Cloud Shell.</p>
    <p class="normal">It can be launched from the top right-hand corner of the portal:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B18403_12_06.png"/></figure>
    <p class="packt_figref">Figure 12.6: Azure Cloud Shell</p>
    <p class="normal">When it is launched for<a id="_idIndexMarker930"/> the first time, you will be asked to pick between <strong class="screenText">Bash</strong> and <strong class="screenText">PowerShell</strong>. The shell interface can be switched later, but they cannot run simultaneously:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_12_07.png"/></figure>
    <p class="packt_figref">Figure 12.7: Azure Cloud Shell with PowerShell</p>
    <p class="normal">My personal <a id="_idIndexMarker931"/>preference is the <strong class="screenText">Bash</strong> shell, which allows me to use the pre-installed Azure CLI and Python SDK:</p>
    <figure class="mediaobject"><img alt="Text  Description automatically generated" src="../Images/B18403_12_08.png"/></figure>
    <p class="packt_figref">Figure 12.8: Azure AZ tool and Python in Cloud Shell</p>
    <p class="normal"><a id="_idIndexMarker932"/>Cloud Shell is very handy because it is browser-based and thus accessible from virtually anywhere. It is assigned per unique user account and automatically authenticated with each session, so we do not need to worry about generating a separate key for it. But since we will be using the Azure CLI quite often, let’s install a local copy on the management host:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
(venv) $ az --version
azure-cli                         2.40.0
core                              2.40.0
telemetry                          1.0.8
Dependencies:
msal                            1.18.0b1
azure-mgmt-resource             21.1.0b1
</code></pre>
    <p class="normal">Let’s also install the Azure Python SDK on our management host. Starting with version 5.0.0, the Azure Python SDK requires us to install service-specific packages listed at <a href="https://aka.ms/azsdk/python/all"><span class="url">https://aka.ms/azsdk/python/all</span></a>:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ pip install azure-identity 
(venv) $ pip install azure-mgmt-compute
(venv) $ pip install azure-mgmt-storage
(venv) $ pip install azure-mgmt-resource
(venv) $ pip install azure-mgmt-network
</code></pre>
    <p class="normal">The Azure for Python Developers page<a id="_idIndexMarker933"/>, <a href="https://docs.microsoft.com/en-us/azure/python/"><span class="url">https://docs.microsoft.com/en-us/azure/python/</span></a>, is an all-inclusive resource for getting started with Azure using Python. The Azure SDK for<a id="_idIndexMarker934"/> Python page, <a href="https://learn.microsoft.com/en-us/azure/developer/python/sdk/azure-sdk-overview"><span class="url">https://learn.microsoft.com/en-us/azure/developer/python/sdk/azure-sdk-overview</span></a>, provides detailed documentation on using the Python libraries for Azure resource management. </p>
    <p class="normal">We are now ready to take a look at some of the service principles of Azure and launch our Azure services.</p>
    <h2 class="heading-2" id="_idParaDest-263">Azure service principals</h2>
    <p class="normal">Azure uses the concept of service<a id="_idIndexMarker935"/> principal objects for automated tools. The network security best practice of least privilege grants any person or tool just enough access to perform their job and no more. An Azure service principal restricts resources and the level of access based on roles. To get started, we will use the role automatically created for us by the Azure CLI and use the Python SDK to test the authentication. Use the <code class="inlineCode">az</code> <code class="inlineCode">login</code> command to receive a token:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ az login --use-device-code
To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code &lt;your code&gt; to authenticate.
</code></pre>
    <p class="normal">Follow the URL and paste in the code you see on the command line and authenticate with the Azure account we created earlier:</p>
    <figure class="mediaobject"><img alt="Text  Description automatically generated" src="../Images/B18403_12_09.png"/></figure>
    <p class="packt_figref">Figure 12.9: Azure Cross-platform Command Line Interface</p>
    <p class="normal">We can create<a id="_idIndexMarker936"/> the credential file in <code class="inlineCode">json</code> format and move that to the Azure directory. The Azure directory was created when we installed the Azure CLI tool:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ az ad sp create-for-rbac --sdk-auth &gt; credentials.json
(venv) $ cat credentials.json
{
  "clientId": "&lt;skip&gt;",
  "clientSecret": "&lt;skip&gt;",
  "subscriptionId": "&lt;skip&gt;",
  "tenantId": "&lt;skip&gt;",
  "&lt;skip&gt;"
}
(venv) echou@network-dev-2:~$ mv credentials.json ~/.azure/
</code></pre>
    <p class="normal">Let’s secure the credential file and export it as an environment variable:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ chmod 0600 ~/.azure/credentials.json
(venv) $ export AZURE_AUTH_LOCATION=~/.azure/credentials.json
</code></pre>
    <p class="normal">We will also export the various credentials into our environment: </p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">cat</span> ~/.azure/credentials.json
<span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">export</span> AZURE_TENANT_ID=<span class="hljs-con-string">"xxx"</span>
<span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">export</span> AZURE_CLIENT_ID=<span class="hljs-con-string">"xxx"</span>
<span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">export</span> AZURE_CLIENT_SECRET=<span class="hljs-con-string">"xxx"</span>
<span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">export</span> SUBSCRIPTION_ID=<span class="hljs-con-string">"xxx"</span>
</code></pre>
    <p class="normal">We will grant role access to the subscription: </p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ az ad sp create-for-rbac --role 'Owner' --scopes '/subscriptions/&lt;subscription id&gt;'
{
  "appId": "&lt;appId&gt;",
  "displayName": "azure-cli-2022-09-22-17-24-24",
  "password": "&lt;password&gt;",
  "tenant": "&lt;tenant&gt;"
}
(venv) $ az login --service-principal --username "&lt;appId&gt;" --password "&lt;password&gt;" --tenant "&lt;tenant&gt;"
</code></pre>
    <div class="note">
      <p class="normal">For more information on <a id="_idIndexMarker937"/>Azure RBAC, visit <a href="https://learn.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli"><span class="url">https://learn.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli</span></a>.</p>
    </div>
    <p class="normal">If we browse<a id="_idIndexMarker938"/> to the <strong class="screenText">Access control</strong> section in the portal (<strong class="screenText">Home -&gt; Subscriptions -&gt; Pay-As-You-Go -&gt; Access control</strong>), we will be able to see the newly created role:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B18403_12_10.png"/></figure>
    <p class="packt_figref">Figure 12.10: Azure pay-as-you-go IAM</p>
    <div class="packt_tip">
      <p class="normal">There are many example codes for using Python SDK to manage a network using the Azure Python SDK on the GitHub page, <a href="https://github.com/Azure-Samples/azure-samples-python-management/tree/main/samples/network"><span class="url">https://github.com/Azure-Samples/azure-samples-python-management/tree/main/samples/network</span></a>. The <em class="italic">Getting Started Guide</em>, <a href="https://learn.microsoft.com/en-us/samples/azure-samples/azure-samples-python-management/network/"><span class="url">https://learn.microsoft.com/en-us/samples/azure-samples/azure-samples-python-management/network/</span></a>, can also be useful.</p>
    </div>
    <p class="normal">We will use a<a id="_idIndexMarker939"/> simple Python script, <code class="inlineCode">Chapter12_1_auth.py</code>, to import the library for client authentication and network management:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-keyword">import</span> os 
<span class="hljs-keyword">import</span> azure.mgmt.network
<span class="hljs-keyword">from</span> azure.identity <span class="hljs-keyword">import</span> ClientSecretCredential
credential = ClientSecretCredential(
    tenant_id=os.environ.get(<span class="hljs-string">"</span><span class="hljs-string">AZURE_TENANT_ID"</span>),
    client_id=os.environ.get(<span class="hljs-string">"AZURE_CLIENT_ID"</span>),
    client_secret=os.environ.get(<span class="hljs-string">"AZURE_CLIENT_SECRET"</span>)
)
subscription_id = os.environ.get(<span class="hljs-string">"SUBSCRIPTION_ID"</span>)
network_client = azure.mgmt.network.NetworkManagementClient(credential=credential, subscription_id=subscription_id)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Network Management Client API Version: "</span> + network_client.DEFAULT_API_VERSION)
</code></pre>
    <p class="normal">If the file <a id="_idIndexMarker940"/>executes without an error, we have successfully authenticated with the Python SDK client:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ python Chapter12_1_auth.py 
Network Management Client API Version: 2022-01-01 
</code></pre>
    <p class="normal">While reading the Azure documentation, you may have noticed a combination of PowerShell and Python. In the next section, let’s briefly consider the relationship between Python and PowerShell.</p>
    <h2 class="heading-2" id="_idParaDest-264">Python versus PowerShell</h2>
    <p class="normal">There are <a id="_idIndexMarker941"/>many programming languages and frameworks that Microsoft has either developed from the ground up or has implemented major dialects for, including C#, .NET, and PowerShell. It is no surprise that .NET (with C#) and PowerShell are somewhat first-class citizens in Azure. In much of the Azure documentation, you will find direct references to PowerShell examples. There are often opinionated discussions on the web forums on which tool, Python or PowerShell, is better suited to managing Azure resources.</p>
    <div class="note">
      <p class="normal">As of July 2019, we can also run PowerShell Core on the Linux and macOS operating systems in the preview release, <a href="https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-linux?view=powershell-7.3&amp;viewFallbackFrom=powershell-6"><span class="url">https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell-core-on-linux?view=powershell-6</span></a>.</p>
    </div>
    <p class="normal">We will not get into a debate on language superiority. I do not mind using PowerShell when required – I find it easy and intuitive – and I agree that sometimes the Python SDK lags behind PowerShell in implementing the latest Azure features. But since Python is at least part of the reason you picked up this book, we will stick to the Python SDK and the Azure CLI for our examples.</p>
    <p class="normal">Initially, the Azure CLI was offered as PowerShell modules for Windows and the Node.js-based CLI for other platforms. But as the tool has grown in popularity, it is now a wrapper around the Azure Python SDK, as explained in this article on <em class="italic">Python.org</em>: <a href="https://www.python.org/success-stories/building-an-open-source-and-cross-platform-azure-cli-with-python/"><span class="url">https://www.python.org/success-stories/building-an-open-source-and-cross-platform-azure-cli-with-python/</span></a>.</p>
    <p class="normal">In the remaining sections of this chapter, when we are introducing a feature or concept, we will oftentimes turn to the Azure CLI for demonstration purposes. Rest assured that if something is available as an Azure CLI command, it is available in the Python SDK if we need to directly code it in Python.</p>
    <p class="normal">Having covered Azure administration and the associated APIs, let’s move on to discussing Azure global infrastructure.</p>
    <h1 class="heading-1" id="_idParaDest-265">Azure global infrastructure</h1>
    <p class="normal">Similar to AWS, an Azure global infrastructure <a id="_idIndexMarker942"/>consists of regions, <strong class="keyWord">Availability Zones</strong> (<strong class="keyWord">AZs</strong>), and edge<a id="_idIndexMarker943"/> locations. At the time of writing, Azure has 60+ regions and more than 200+ physical data centers, as illustrated on the product page (<a href="https://azure.microsoft.com/en-us/global-infrastructure/"><span class="url">https://azure.microsoft.com/en-us/global-infrastructure/</span></a>):</p>
    <figure class="mediaobject"><img alt="" src="../Images/B18403_12_11.png"/></figure>
    <p class="packt_figref">Figure 12.11: Azure global infrastructure (source: https://azure.microsoft.com/en-us/global-infrastructure/)</p>
    <p class="normal">Like AWS, Azure<a id="_idIndexMarker944"/> products are offered via regions, so we need to check service availability and pricing based on regions. We can also build redundancy into the service by building the service in multiple AZs. However, unlike AWS, not all Azure regions have AZs, and not all Azure products support them. In fact, Azure did not announce the general availability of AZs until 2018, and they are only offered in select regions.</p>
    <p class="normal">This is something to be aware of when picking our region. I recommend picking regions with AZs such as West US 2, Central US, and East US 1.</p>
    <p class="normal">If we build in a region without AZs, we will need to replicate the service across different regions, typically in the same geography. We will discuss Azure geography next.</p>
    <div class="packt_tip">
      <p class="normal">On the Azure global infrastructure page, the regions with Availability Zones are marked with a star in the middle.</p>
    </div>
    <p class="normal">Unlike AWS, Azure regions<a id="_idIndexMarker945"/> are also organized into a higher-order category of geographies. A geography is a discrete market, typically containing one or more regions. Besides lower latency and better network connectivity, replicating the service and data across regions in the same geography is necessary for government compliance. An example of replication across regions would be the regions of Germany. If we needed to launch services for the German market, the government mandates strict data sovereignty within the border, but none of the German regions have Availability Zones. We would need to replicate the data <a id="_idIndexMarker946"/>between different regions in the same geography, that is, Germany North, Germany Northeast, Germany West Central, and so on.</p>
    <p class="normal">As a rule of thumb, I typically prefer regions that have Availability Zones to keep things similar across different cloud providers. Once we have determined the region that best fits our use case, we are ready to build our VNet in Azure.</p>
    <h1 class="heading-1" id="_idParaDest-266">Azure virtual networks</h1>
    <p class="normal">When we wear the network engineer hat in the Azure cloud, <strong class="keyWord">Azure virtual networks </strong>(<strong class="keyWord">VNets</strong>) are where we <a id="_idIndexMarker947"/>spend most of our time. Similar to a traditional network that we would build in our data center, they are the fundamental building blocks for our private networks in Azure. We will use a VNet to allow our VMs to communicate with each other, with the internet, and with our on-premise network through a VPN or ExpressRoute.</p>
    <p class="normal">Let’s begin by building our first VNet using the portal. We will start by browsing the <strong class="screenText">virtual network page</strong> via <strong class="screenText">Create a Resource -&gt; Networking -&gt; Virtual network</strong>:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_12_12.png"/></figure>
    <p class="packt_figref">Figure 12.12: Azure VNet</p>
    <p class="normal">Each VNet is scoped to a single<a id="_idIndexMarker948"/> region and we can create multiple subnets per VNet. As we will see later, multiple VNets in different regions can connect to each other via VNet peering.</p>
    <p class="normal">From the VNet creation page, we will<a id="_idIndexMarker949"/> create our first network with the following credentials:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-attribute">Name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">WEST-US-2_VNet_1</span>
<span class="hljs-attribute">Address space</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.0.0/23</span>
<span class="hljs-attribute">Subscription</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&lt;pick your subscription&gt;</span>
<span class="hljs-attribute">Resource group</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&lt;click on new&gt; -&gt; 'Mastering-Python-Networking'</span>
<span class="hljs-attribute">Location</span><span class="hljs-punctuation">:</span> <span class="hljs-string">West US 2</span>
<span class="hljs-attribute">Subnet name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">WEST-US-2_VNet_1_Subnet_1</span>
<span class="hljs-attribute">Address range</span><span class="hljs-punctuation">:</span> <span class="hljs-string">192.168.1.0/24</span>
<span class="hljs-attribute">DDoS protection</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Basic</span>
<span class="hljs-attribute">Service endpoints</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Disabled</span>
<span class="hljs-attribute">Firewall</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Disabled</span>
</code></pre>
    <p class="normal">Here is a screenshot of the necessary fields. If there are any missing fields that are required, they will be highlighted in red. Click on <strong class="screenText">Create</strong> when finished:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B18403_12_13.png"/></figure>
    <p class="packt_figref">Figure 12.13: Azure VNet creation</p>
    <p class="normal">Once the resource is created, we <a id="_idIndexMarker950"/>can navigate to it via <strong class="screenText">Home -&gt; Resource groups -&gt; Mastering-Python-Networking</strong>:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_12_14.png"/></figure>
    <p class="packt_figref">Figure 12.14: Azure VNet overview</p>
    <p class="normal">Congratulations, we just created our first VNet in<a id="_idIndexMarker951"/> the Azure cloud! Our network needs to communicate with the outside world to be useful. We will look at how we can do that in the next section.</p>
    <h2 class="heading-2" id="_idParaDest-267">Internet access</h2>
    <p class="normal">By default, all <a id="_idIndexMarker952"/>resources within a VNet can carry out outbound communication with the internet; we do not need to add a NAT gateway as we do in AWS. For inbound communication, we will need to assign a public IP directly to the VM or use a load balancer with a public IP. To see this working, we will create VMs within our network.</p>
    <p class="normal">We can create our first VM from <strong class="screenText">Home -&gt; Resource groups -&gt; Mastering-Python-Networking -&gt; New -&gt; Create a virtual machine:</strong></p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_12_15.png"/></figure>
    <p class="packt_figref">Figure 12.15: Azure creating a VM</p>
    <p class="normal">I will pick <strong class="keyWord">Ubuntu Server 22.04 LTS</strong> as the VM and use the name <code class="inlineCode">myMPN-VM1</code> when prompted. I will <a id="_idIndexMarker953"/>pick the <a id="_idIndexMarker954"/>region <code class="inlineCode">West US 2</code>. We can choose password authentication or an SSH public key as the authentication method and allow an SSH inbound connection. Since we are using it for testing, we can pick the smallest instance in the B-Series to minimize our cost: </p>
    <figure class="mediaobject"><img alt="Table  Description automatically generated" src="../Images/B18403_12_16.png"/></figure>
    <p class="packt_figref">Figure 12.16: Azure compute B-Series</p>
    <p class="normal">We can leave the other options as their default settings, pick a small disk size, and check <strong class="screenText">delete with VM</strong>. We <a id="_idIndexMarker955"/>will put the VM into the subnet that we created, as well as assigning a new public IP:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B18403_12_17.png"/></figure>
    <p class="packt_figref">Figure 12.17: Azure network interface</p>
    <p class="normal">After the VM is provisioned, we can <code class="inlineCode">ssh</code> to the machine with the public IP and the user we created. The VM has only one interface that is within our private subnet; it is also mapped to the public IP that Azure automatically assigned. This public-to-private IP translation is done automatically by Azure.</p>
    <pre class="programlisting con"><code class="hljs-con">echou@myMPN-VM1:~$ sudo apt install net-tools
echou@myMPN-VM1:~$ ifconfig eth0
eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.1.4  netmask 255.255.255.0  broadcast 192.168.1.255
        inet6 fe80::20d:3aff:fe06:68a0  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 00:0d:3a:06:68:a0  txqueuelen 1000  (Ethernet)
        RX packets 2344  bytes 2201526 (2.2 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1290  bytes 304355 (304.3 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
echou@myMPN-VM1:~$ ping -c 1 www.google.com
PING www.google.com (142.251.211.228) 56(84) bytes of data.
64 bytes from sea30s13-in-f4.1e100.net (142.251.211.228): icmp_seq=1 ttl=115 time=47.7 ms
--- www.google.com ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 47.668/47.668/47.668/0.000 ms
</code></pre>
    <p class="normal">We can repeat the<a id="_idIndexMarker956"/> same process to create a second VM named <code class="inlineCode">myMPN-VM2</code>. The VM can be configured with <code class="inlineCode">SSH</code> inbound access but no public IP:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B18403_12_18.png"/></figure>
    <p class="packt_figref">Figure 12.18: Azure VM IP addresses</p>
    <p class="normal">After the VM creation, we can <code class="inlineCode">ssh</code> to <code class="inlineCode">myMPN-VM2</code> from <code class="inlineCode">myMPN-VM1</code> with the private IP:</p>
    <pre class="programlisting con"><code class="hljs-con">echou@myMPN-VM1:~$ ssh echou@192.168.1.5
echou@myMPN-VM2:~$ who
echou    pts/0        2022-09-22 16:43 (192.168.1.4)
</code></pre>
    <p class="normal">We can test the internet connection by trying to access the <code class="inlineCode">apt</code> package update repositories:</p>
    <pre class="programlisting con"><code class="hljs-con">echou@myMPN-VM2:~$ sudo apt update
Hit:1 http://azure.archive.ubuntu.com/ubuntu jammy InRelease
Get:2 http://azure.archive.ubuntu.com/ubuntu jammy-updates InRelease [114 kB]
Get:3 http://azure.archive.ubuntu.com/ubuntu jammy-backports InRelease [99.8 kB]
Get:4 http://azure.archive.ubuntu.com/ubuntu jammy-security InRelease [110 kB]
Get:5 http://azure.archive.ubuntu.com/ubuntu jammy/universe amd64 Packages [14.1 MB]
Fetched 23.5 MB in 6s (4159 kB/s)                          
</code></pre>
    <p class="normal">With our VM inside of VNet<a id="_idIndexMarker957"/> able to access the internet, we can create additional network resources for our network.</p>
    <h2 class="heading-2" id="_idParaDest-268">Network resource creation</h2>
    <p class="normal">Let’s look at an <a id="_idIndexMarker958"/>example of using the Python SDK to create network resources. In the following example, <code class="inlineCode">Chapter12_2_network_resources.py</code>, we will use the <code class="inlineCode">subnet.create_or_update</code> API to create a new <code class="inlineCode">192.168.0.128/25</code> subnet in the VNet:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># Reference example: https://github.com/Azure-Samples/azure-samples-python-management/blob/main/samples/network/virtual_network/manage_subnet.py</span>
<span class="hljs-comment"># </span>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> azure.identity <span class="hljs-keyword">import</span> ClientSecretCredential
<span class="hljs-keyword">import</span> azure.mgmt.network
<span class="hljs-keyword">from</span> azure.identity <span class="hljs-keyword">import</span> DefaultAzureCredential
<span class="hljs-keyword">from</span> azure.mgmt.network <span class="hljs-keyword">import</span> NetworkManagementClient
<span class="hljs-keyword">from</span> azure.mgmt.resource <span class="hljs-keyword">import</span> ResourceManagementClient
credential = ClientSecretCredential(
    tenant_id=os.environ.get(<span class="hljs-string">"AZURE_TENANT_ID"</span>),
    client_id=os.environ.get(<span class="hljs-string">"AZURE_CLIENT_ID"</span>),
    client_secret=os.environ.get(<span class="hljs-string">"AZURE_CLIENT_SECRET"</span>)
)
subscription_id = os.environ.get(<span class="hljs-string">"</span><span class="hljs-string">SUBSCRIPTION_ID"</span>)
GROUP_NAME = <span class="hljs-string">"Mastering-Python-Networking"</span>
VIRTUAL_NETWORK_NAME = <span class="hljs-string">"WEST-US-2_VNet_1"</span>
SUBNET = <span class="hljs-string">"WEST-US-2_VNet_1_Subnet_2"</span>
network_client = azure.mgmt.network.NetworkManagementClient(
    credential=credential, subscription_id=subscription_id)
<span class="hljs-comment"># Get subnet</span>
subnet = network_client.subnets.get(
    GROUP_NAME,
    VIRTUAL_NETWORK_NAME,
    SUBNET
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Get subnet:\n{}"</span>.<span class="hljs-built_in">format</span>(subnet))
subnet = network_client.subnets.begin_create_or_update(
    GROUP_NAME,
    VIRTUAL_NETWORK_NAME,
    SUBNET,
    {
        <span class="hljs-string">"address_prefix"</span>: <span class="hljs-string">"192.168.0.128/25"</span>
    }
).result()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Create subnet:\n{}"</span>.<span class="hljs-built_in">format</span>(subnet))
</code></pre>
    <p class="normal">We will receive the<a id="_idIndexMarker959"/> following creation result message when we execute the script:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ python3 Chapter12_2_subnet.py
{'additional_properties': {'type': 'Microsoft.Network/virtualNetworks/subnets'}, 'id': '/subscriptions/&lt;skip&gt;/resourceGroups/Mastering-Python-Networking/providers/Microsoft.Network/virtualNetworks/WEST-US-2_VNet_1/subnets/WEST-US-2_VNet_1_Subnet_2', 'address_prefix': '192.168.0.128/25', 'address_prefixes': None, 'network_security_group': None, 'route_table': None, 'service_endpoints': None, 'service_endpoint_policies': None, 'interface_endpoints': None, 'ip_configurations': None, 'ip_configuration_profiles': None, 'resource_navigation_links': None, 'service_association_links': None, 'delegations': [], 'purpose': None, 'provisioning_state': 'Succeeded', 'name': 'WEST-US-2_VNet_1_Subnet_2', 'etag': 'W/"&lt;skip&gt;"'}
</code></pre>
    <p class="normal">The new subnet can also be seen on the portal:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B18403_12_19.png"/></figure>
    <p class="packt_figref">Figure 12.19: Azure VNet subnets</p>
    <p class="normal">For more examples of using the Python SDK, check out <a href="https://github.com/Azure-Samples/azure-samples-python-management"><span class="url">https://github.com/Azure-Samples/azure-samples-python-management</span></a>.</p>
    <p class="normal">If we create a VM within the new subnet, even across subnet boundaries, the hosts in the same VNet can reach each other with the same implicit router we saw with AWS.</p>
    <p class="normal">There are <a id="_idIndexMarker960"/>additional VNet services available to us when we need to interact with other Azure services. Let’s take a look.</p>
    <h2 class="heading-2" id="_idParaDest-269">VNet service endpoints</h2>
    <p class="normal">VNet service endpoints<a id="_idIndexMarker961"/> can extend the VNet to other Azure services over a direct connection. This allows traffic from the VNet to the Azure service to remain on the Azure network. Service endpoints need to be configured with an identified service within the region of the VNet.</p>
    <p class="normal">They can be configured via the portal with restrictions to the service and subnet:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="../Images/B18403_12_20.png"/></figure>
    <p class="packt_figref">Figure 12.20: Azure service endpoints</p>
    <p class="normal">Strictly speaking, we do<a id="_idIndexMarker962"/> not need to create VNet service endpoints when we need to have the VMs in the VNet communicate with the service. Each VM can access the service through the public IP mapped, and we can use network rules to permit only the necessary IPs. However, using the VNet service endpoints allows us to access the resources using the private IP within Azure without the traffic traversing the public internet.</p>
    <h2 class="heading-2" id="_idParaDest-270">VNet peering</h2>
    <p class="normal">As mentioned at the beginning of <a id="_idIndexMarker963"/>the section, each VNet is limited to a region. For region-to-region VNet connectivity, we can leverage VNet peering. Let’s use the following two functions in <code class="inlineCode">Chapter11_3_vnet.py</code> to create a VNet in the <code class="inlineCode">US-East</code> region:</p>
    <pre class="programlisting code"><code class="hljs-code">&lt;skip&gt;
<span class="hljs-keyword">def</span> <span class="hljs-title">create_vnet</span>(<span class="hljs-params">network_client</span>):
    vnet_params = {
        <span class="hljs-string">'location'</span>: LOCATION,
        <span class="hljs-string">'address_space'</span>: {
            <span class="hljs-string">'</span><span class="hljs-string">address_prefixes'</span>: [<span class="hljs-string">'10.0.0.0/16'</span>]
        }
    }
    creation_result = network_client.virtual_networks.create_or_update(
        GROUP_NAME,
        <span class="hljs-string">'EAST-US_VNet_1'</span>,
        vnet_params
    )
    <span class="hljs-keyword">return</span> creation_result.result()
&lt;skip&gt;
<span class="hljs-keyword">def</span> <span class="hljs-title">create_subnet</span>(<span class="hljs-params">network_client</span>):
    subnet_params = {
        <span class="hljs-string">'address_prefix'</span>: <span class="hljs-string">'10.0.1.0/24'</span>
    }
    creation_result = network_client.subnets.create_or_update(
        GROUP_NAME,
        <span class="hljs-string">'EAST-US_VNet_1'</span>,
        <span class="hljs-string">'</span><span class="hljs-string">EAST-US_VNet_1_Subnet_1'</span>,
        subnet_params
    )
    <span class="hljs-keyword">return</span> creation_result.result()
</code></pre>
    <p class="normal">To allow VNet peering, we need to peer bi-directionally from both VNets. Since we have been using the Python SDK up to this point, for learning purposes, let’s look at an example with the Azure CLI.</p>
    <p class="normal">We will grab the <a id="_idIndexMarker964"/>VNet name and ID from the <code class="inlineCode">az network vnet list</code> command:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ az network vnet list
&lt;skip&gt;
"id": "/subscriptions/&lt;skip&gt;/resourceGroups/Mastering-Python-Networking/providers/Microsoft.Network/virtualNetworks/EAST-US_VNet_1",
    "location": "eastus",
    "name": "EAST-US_VNet_1"
&lt;skip&gt;
"id": "/subscriptions/&lt;skip&gt;/resourceGroups/Mastering-Python-Networking/providers/Microsoft.Network/virtualNetworks/WEST-US-2_VNet_1",
    "location": "westus2",
    "name": "WEST-US-2_VNet_1"
&lt;skip&gt;
</code></pre>
    <p class="normal">Let’s check the existing VNet peering for our <code class="inlineCode">West US 2</code> VNet:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ az network vnet peering list -g "Mastering-Python-Networking" --vnet-name WEST-US-2_VNet_1
[]
</code></pre>
    <p class="normal">We will execute the peering from the <code class="inlineCode">West US</code> to <code class="inlineCode">East US</code> VNet, then repeat in the reverse direction:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ az network vnet peering create -g "Mastering-Python-Networking" -n WestUSToEastUS --vnet-name WEST-US-2_VNet_1 --remote-vnet "/subscriptions/&lt;skip&gt;/resourceGroups/Mastering-Python-Networking/providers/Microsoft.Network/virtualNetworks/EAST-US_VNet_1"
(venv) $ az network vnet peering create -g "Mastering-Python-Networking" -n EastUSToWestUS --vnet-name EAST-US_VNet_1 --remote-vnet "/subscriptions/b7257c5b-97c1-45ea-86a7-872ce8495a2a/resourceGroups/Mastering-Python-Networking/providers/Microsoft.Network/virtualNetworks/WEST-US-2_VNet_1"
</code></pre>
    <p class="normal">Now if we run the<a id="_idIndexMarker965"/> check again, we will be able to see the VNet successfully peered:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ az network vnet peering list -g "Mastering-Python-Networking" --vnet-name "WEST-US-2_VNet_1"
[
  {
    "allowForwardedTraffic": false,
    "allowGatewayTransit": false,
    "allowVirtualNetworkAccess": false,
    "etag": "W/\"&lt;skip&gt;\"",
    "id": "/subscriptions/&lt;skip&gt;/resourceGroups/Mastering-Python-Networking/providers/Microsoft.Network/virtualNetworks/WEST-US-2_VNet_1/virtualNetworkPeerings/WestUSToEastUS",
    "name": "WestUSToEastUS",
    "peeringState": "Connected",
    "provisioningState": "Succeeded",
    "remoteAddressSpace": {
      "addressPrefixes": [
        "10.0.0.0/16"
      ]
    },
&lt;skip&gt;
</code></pre>
    <p class="normal">We can also verify the peering on the Azure portal:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B18403_12_21.png"/></figure>
    <p class="packt_figref">Figure 12.21: Azure VNet peering</p>
    <p class="normal">Now that we have<a id="_idIndexMarker966"/> several hosts, subnets, VNets, and VNet peering in our setup, we should look at how routing is done in Azure. That is what we will do in the next section.</p>
    <h1 class="heading-1" id="_idParaDest-271">VNet routing</h1>
    <p class="normal">As a network<a id="_idIndexMarker967"/> engineer, implicit routes added by the cloud provider have always been a bit uncomfortable for me. In traditional networking, we need to cable up the network, assign IP addresses, configure routing, implement security, and make sure everything works. It can sometimes be complex, but every packet and route is accounted for. For virtual networks in the cloud, the underlay network is already completed by Azure and some network configuration on the overlay network needs to happen automatically for the host to work at launch time, as we saw earlier.</p>
    <p class="normal">Azure VNet routing is a bit different from AWS. In the AWS chapter, we saw the routing table implemented at the VPC network layer. But if we browse to the Azure VNet setting on the portal, we will not find a routing table assigned to the VNet.</p>
    <p class="normal">If we drill deeper into the <strong class="screenText">subnet setting</strong>, we will see a routing table drop-down menu, but the value it is displaying <a id="_idIndexMarker968"/>is <strong class="screenText">None</strong>:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B18403_12_22.png"/></figure>
    <p class="packt_figref">Figure 12.22: Azure subnet routing table</p>
    <p class="normal">How can we have an empty routing table with the hosts in that subnet able to reach the internet? Where can we see the routes configured by Azure VNet? The routing has been implemented at the host and NIC levels. We can see it via <strong class="screenText">All services -&gt; Virtual Machines -&gt; myNPM-VM1 -&gt; Networking (left panel) -&gt; Topology (top panel)</strong>:</p>
    <figure class="mediaobject"><img alt="Graphical user interface  Description automatically generated with medium confidence" src="../Images/B18403_12_23.png"/></figure>
    <p class="packt_figref">Figure 12.23: Azure network topology</p>
    <p class="normal">The network is <a id="_idIndexMarker969"/>being shown on the NIC level with each NIC attached to a VNet subnet on the north side and other resources such as VM, <strong class="keyWord">Network Security Group</strong> (<strong class="keyWord">NSG</strong>), and IP on the south side. The resources are dynamic; at the time of the screen capture, I only had <code class="inlineCode">myMPN-VM1</code> running, therefore it is the only one with a VM and IP <a id="_idIndexMarker970"/>address attached, while the other VMs only have NSGs attached.</p>
    <p class="normal">We will cover NSG in the next section.</p>
    <p class="normal">If we click on the NIC, <strong class="screenText">mympn-vm1655</strong> in our topology, we can see the settings associated with the NIC. Under the <strong class="screenText">Support + troubleshooting</strong> section, we will find the <strong class="screenText">Effective routes</strong> link, where we can see the current routing associated with the NIC:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, table  Description automatically generated" src="../Images/B18403_12_24.png"/></figure>
    <p class="packt_figref">Figure 12.24: Azure VNet effective routes</p>
    <p class="normal">If we want to automate <a id="_idIndexMarker971"/>the process, we can use the Azure CLI to find the NIC name and then show the routing table:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ az vm show --name myMPN-VM1 --resource-group 'Mastering-Python-Networking'
&lt;skip&gt;
"networkProfile": {
    "networkInterfaces": [
      {
        "id": "/subscriptions/&lt;skip&gt;/resourceGroups/Mastering-Python-Networking/providers/Microsoft.Network/networkInterfaces/mympn-vm1655",
        "primary": null,
        "resourceGroup": "Mastering-Python-Networking"
      }
    ]
  }
&lt;skip&gt;
(venv) $ az network nic show-effective-route-table --name mympn-vm1655 --resource-group "Mastering-Python-Networking"
{
  "nextLink": null,
  "value": [
    {
      "addressPrefix": [
        "192.168.0.0/23"
      ],
&lt;skip&gt;
</code></pre>
    <p class="normal">Great! That was one <a id="_idIndexMarker972"/>mystery solved, but what are those next hops in the routing table? We can <a id="_idIndexMarker973"/>reference the VNet traffic routing document: <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview"><span class="url">https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview</span></a>. A few important notes:</p>
    <ul>
      <li class="bulletList">If the source indicates that the route is <strong class="keyWord">Default</strong>, these are system routes that cannot be removed but can be overwritten with custom routes.</li>
      <li class="bulletList">VNet next hops are the routes within the custom VNet. In our case, this is the <code class="inlineCode">192.168.0.0/23</code> network, not just the subnet.</li>
      <li class="bulletList">Traffic routed to the <strong class="keyWord">None</strong> next hop type is dropped, similar to the <strong class="keyWord">Null</strong> interface routes.</li>
      <li class="bulletList">The <strong class="keyWord">VNetGlobalPeering</strong> next <a id="_idIndexMarker974"/>hop type is what was created when we established VNet peering with other VNets.</li>
      <li class="bulletList">The <strong class="keyWord">VirtualNetworkServiceEndpoint</strong> next hop type was created when we enabled service endpoints in our<a id="_idIndexMarker975"/> VNet. The public IP is managed by Azure and changes from time to time.</li>
    </ul>
    <p class="normal">How do we override the default routes? We can create a route table and associate it with subnets. Azure selects the routes with the following priority:</p>
    <ul>
      <li class="bulletList">User-defined route</li>
      <li class="bulletList">BGP route (from a Site-to-Site VPN or ExpressRoute)</li>
      <li class="bulletList">System route</li>
    </ul>
    <p class="normal">We can create a route table in the <strong class="keyWord">Networking</strong> section:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_12_25.png"/></figure>
    <p class="packt_figref">Figure 12.25: Azure VNet route tables</p>
    <p class="normal">We can also<a id="_idIndexMarker976"/> create a route table, create a route within the table, and associate the route table with a subnet via the Azure CLI:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ az network route-table create --name TempRouteTable --resource "Mastering-Python-Networking"
(venv) $ az network route-table route create -g "Mastering-Python-Networking" --route-table-name TempRouteTable -n TempRoute  --next-hop-type VirtualAppliance --address-prefix 172.31.0.0/16 --next-hop-ip-address 10.0.100.4
(venv) $ az network vnet subnet update -g "Mastering-Python-Networking" -n WEST-US-2_Vnet_1_Subnet_1 --vnet-name WEST-US-2_VNet_1 --route-table TempRouteTable
</code></pre>
    <p class="normal">Let’s take a look at the primary security measure in VNet: NSGs.</p>
    <h2 class="heading-2" id="_idParaDest-272">Network security groups</h2>
    <p class="normal">VNet security is primarily <a id="_idIndexMarker977"/>implemented by NSGs. Just like traditional access<a id="_idIndexMarker978"/> lists or firewall rules, we need to think of network security rules in a single direction at a time. For example, if we want to have host <code class="inlineCode">A</code>, in <code class="inlineCode">subnet 1</code> communicate freely with host <code class="inlineCode">B</code> in <code class="inlineCode">subnet 2</code> over port <code class="inlineCode">80</code>, we need to implement the necessary rules for both inbound and outbound directions for both hosts.</p>
    <p class="normal">As we saw from previous examples, an NSG can be associated with the NIC or the subnet, so we also need to think in terms of security layers. Generally speaking, we should implement the more restrictive rules at the host level while the more relaxed rules are applied at the subnet level. This is similar to traditional networking.</p>
    <p class="normal">When we created our VMs, we set a permit rule for SSH TCP port <code class="inlineCode">22</code> inbound. Let’s take a look at the security group that was created for our first VM, <strong class="screenText">myMPN-VM1-nsg</strong>:</p>
    <figure class="mediaobject"><img alt="Table  Description automatically generated" src="../Images/B18403_12_26.png"/></figure>
    <p class="packt_figref">Figure 12.26: Azure VNet NSG</p>
    <p class="normal">There are a few things worth pointing out:</p>
    <ul>
      <li class="bulletList">The priority level of system-implemented rules is high, at 65,000 and above.</li>
      <li class="bulletList">By default, virtual networks can freely communicate with each other in both directions.</li>
      <li class="bulletList">By default, internal hosts are allowed internet access.</li>
    </ul>
    <p class="normal">Let’s implement an<a id="_idIndexMarker979"/> inbound rule on the existing NSG group<a id="_idIndexMarker980"/> from the portal:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_12_27.png"/></figure>
    <p class="packt_figref">Figure 12.27: Azure security rule</p>
    <p class="normal">We can also<a id="_idIndexMarker981"/> create a new security group and rules via the Azure <a id="_idIndexMarker982"/>CLI:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ az network nsg create -g "Mastering-Python-Networking" -n TestNSG
(venv) $ az network nsg rule create -g "Mastering-Python-Networking" --nsg-name TestNSG -n Allow_SSH --priority 150 --direction Inbound --source-address-prefixes Internet --destination-port-ranges 22 --access Allow --protocol Tcp --description "Permit SSH Inbound"
(venv) $ az network nsg rule create -g "Mastering-Python-Networking" --nsg-name TestNSG -n Allow_SSL --priority 160 --direction Inbound --source-address-prefixes Internet --destination-port-ranges 443 --access Allow --protocol Tcp --description "Permit SSL Inbound"
</code></pre>
    <p class="normal">We can see the new rules that were created as well as the default rules:</p>
    <figure class="mediaobject"><img alt="Table  Description automatically generated" src="../Images/B18403_12_28.png"/></figure>
    <p class="packt_figref">Figure 12.28: Azure security rules</p>
    <p class="normal">The <a id="_idIndexMarker983"/>last step<a id="_idIndexMarker984"/> would be to bind this NSG to a subnet:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ az network vnet subnet update -g "Mastering-Python-Networking" -n WEST-US-2_VNet_1_Subnet_1 --vnet-name WEST-US-2_VNet_1 --network-security-group TestNSG
</code></pre>
    <p class="normal">In the next two sections, we will look at the two primary ways to extend Azure virtual networks to our on-premises data center: Azure VPN and Azure ExpressRoute.</p>
    <h1 class="heading-1" id="_idParaDest-273">Azure VPNs</h1>
    <p class="normal">As the network <a id="_idIndexMarker985"/>continues to grow, there might come a time when we need to connect the Azure VNet to our on-premise location. A VPN gateway is a type of VNet gateway that can encrypt the traffic between a VNet and our on-premise network and remote clients. Each VNet can only have one VPN gateway, but multiple connections can be built on the same VPN gateway.</p>
    <p class="normal">More information about Azure VPN gateways<a id="_idIndexMarker986"/> can be found at this link: <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/"><span class="url">https://docs.microsoft.com/en-us/azure/vpn-gateway/</span></a>.</p>
    <p class="normal">VPN gateways are actually VMs themselves, configured with encryption and routing services, but cannot be directly configured by the user. Azure provides a list of SKUs based on the type of tunnel, number of concurrent connections, and total throughput (<a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings#gwsku"><span class="url">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings#gwsku</span></a>):</p>
    <figure class="mediaobject"><img alt="Table  Description automatically generated" src="../Images/B18403_12_29.png"/></figure>
    <p class="packt_figref">Figure 12.29: Azure VPN gateway SKUs (source: https://docs.microsoft.com/en-us/azure/vpn-gateway/point-to-site-about)</p>
    <p class="normal">As we can<a id="_idIndexMarker987"/> see from the preceding table, the Azure VPN is divided into two different categories: <strong class="screenText">Point-to-Site (P2S)</strong> VPN and <strong class="screenText">Site-to-Site (S2S) </strong>VPN. The P2S VPN allows secure connections from an individual client computer, mainly used by telecommuters. The encryption method can be SSTP, IKEv2, or OpenVPN connection. When picking the type of VPN Gateway SKU for P2S, we will want to focus on the second and third columns on the SKU chart for the number of connections.</p>
    <p class="normal">For a client-based VPN, we can use either SSTP or IKEv2 as the tunneling protocol:</p>
    <figure class="mediaobject"><img alt="Diagram  Description automatically generated" src="../Images/B18403_12_30.png"/></figure>
    <p class="packt_figref">Figure 12.30: Azure Site-to-Site VPN gateway (source: https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways)</p>
    <p class="normal">Besides <a id="_idIndexMarker988"/>client-based VPNs, another type of VPN connection is a Site-to-Site or multi-site VPN connection. The encryption method will be IPSec over IKE and a public IP will be required for both Azure and the on-premise network, as illustrated by the following diagram:</p>
    <figure class="mediaobject"><img alt="Diagram  Description automatically generated with medium confidence" src="../Images/B18403_12_31.png"/></figure>
    <p class="packt_figref">Figure 12.31: Azure client VPN gateway (source: https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways)</p>
    <p class="normal">A full <a id="_idIndexMarker989"/>example of creating an <a id="_idIndexMarker990"/>S2S or P2S VPN is more <a id="_idIndexMarker991"/>than what we can cover in this section. Azure provides tutorials for S2S (<a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal"><span class="url">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal</span></a>), as well as P2S VPN (<a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal"><span class="url">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal</span></a>).</p>
    <p class="normal">The steps are pretty straightforward for engineers who have configured VPN services before. The only point that may be a bit confusing and is not called out in the document is the fact that the VPN gateway device should live in a dedicated gateway subnet within the VNet with a <code class="inlineCode">/27</code> IP block assigned:</p>
    <figure class="mediaobject"><img alt="Table  Description automatically generated" src="../Images/B18403_12_32.png"/></figure>
    <p class="packt_figref">Figure 12.32: Azure VPN gateway subnet</p>
    <p class="normal">A growing list of validated <a id="_idIndexMarker992"/>Azure VPN devices can be found at <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices"><span class="url">https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices</span></a>, with links to their respective configuration guides.</p>
    <h1 class="heading-1" id="_idParaDest-274">Azure ExpressRoute</h1>
    <p class="normal">When organizations need to extend an <a id="_idIndexMarker993"/>Azure VNet to on-premises sites, it makes sense to start with a VPN connection. However, as the connection takes on more mission-critical traffic, the organization might want a more stable and reliable connection. Similar to AWS Direct Connect, Azure offers ExpressRoute as a private connection facilitated by a connectivity provider. As we can see from the diagram, our network is connected to Azure’s partner edge network before it is transitioned to Azure’s edge network:</p>
    <figure class="mediaobject"><img alt="Diagram  Description automatically generated" src="../Images/B18403_12_33.png"/></figure>
    <p class="packt_figref">Figure 12.33: Azure ExpressRoute circuits (source: https://docs.microsoft.com/en-us/azure/expressroute/expressroute-introduction)</p>
    <p class="normal">The advantages of <a id="_idIndexMarker994"/>ExpressRoute include:</p>
    <ul>
      <li class="bulletList">More reliable since it does not traverse through the public internet.</li>
      <li class="bulletList">A faster connection with lower latency since a private connection is likely to have fewer hops between on-premise equipment to Azure.</li>
      <li class="bulletList">Better security measures since it is a private connection, especially if a company relies on Microsoft services such as Office 365.</li>
    </ul>
    <p class="normal">The disadvantages of <a id="_idIndexMarker995"/>ExpressRoute can be:</p>
    <ul>
      <li class="bulletList">More difficulty setting up, both in terms of business and technical requirements.</li>
      <li class="bulletList">Higher cost commitment upfront, since the port charge and connection charges are often fixed. Some of the costs can be offset by a reduction in internet costs if it replaces a VPN connection. However, the total cost of ownership is typically higher with ExpressRoute.</li>
    </ul>
    <p class="normal">A more detailed overview of<a id="_idIndexMarker996"/> ExpressRoute can be found at <a href="https://docs.microsoft.com/en-us/azure/expressroute/expressroute-introduction"><span class="url">https://docs.microsoft.com/en-us/azure/expressroute/expressroute-introduction</span></a>. One of the biggest differences from AWS Direct Connect is the fact that ExpressRoute can offer connections across regions in geography. There is also a premium add-on that allows global connectivity to Microsoft services as well as QoS support for Skype for Business.</p>
    <p class="normal">Similar to Direct Connect, ExpressRoute requires the user to connect to Azure with a partner or meet Azure at a certain designated location with ExpressRoute Direct (yes, the term is confusing). This is typically the biggest hurdle for enterprises to get over since they will need to either build their data center at one of the Azure locations, connect with a carrier (MPLS VPN), or work with a broker as a go-between for connection. These options typically require business contracts, longer-term commitments, and committed monthly costs.</p>
    <p class="normal">To start, my recommendation would be similar to in <em class="chapterRef">Chapter 11</em>, <em class="italic">AWS Cloud Networking</em>, which is to use an existing carrier broker for connection to a carrier hotel. From the carrier hotel, either directly connect to Azure or use an <a id="_idIndexMarker997"/>intermediary such as Equinix FABRIC (<a href="https://www.equinix.com/interconnection-services/equinix-fabric"><span class="url">https://www.equinix.com/interconnection-services/equinix-fabric</span></a> ).</p>
    <p class="normal">In the next section, we will look at how we can distribute incoming traffic efficiently when our service grows beyond just a single server.</p>
    <h1 class="heading-1" id="_idParaDest-275">Azure network load balancers</h1>
    <p class="normal">Azure offers load balancers <a id="_idIndexMarker998"/>in both the basic and standard SKU. When we discuss the load balancer in this section, we are referring to the Layer 4 TCP and UDP load distribution service instead of the<a id="_idIndexMarker999"/> Application Gateway Load Balancer (<a href="https://azure.microsoft.com/en-us/services/application-gateway/"><span class="url">https://azure.microsoft.com/en-us/services/application-gateway/</span></a>), which is a layer-7 load-balancing solution.</p>
    <p class="normal">The typical deployment model is usually a one- or two-layer load distribution for an inbound connection from the internet:</p>
    <figure class="mediaobject"><img alt="Diagram  Description automatically generated" src="../Images/B18403_12_34.png"/></figure>
    <p class="packt_figref">Figure 12.34: Azure Load Balancer (source: https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-overview)</p>
    <p class="normal">The<a id="_idIndexMarker1000"/> load balancer hashes the incoming connection on a 5-tuple hash (source and destination IP, source and destination port, and protocol) and distributes the flow to one or more destinations. The Standard Load Balancer SKU is a superset of the basic SKU, therefore new designs should adopt the Standard Load Balancer.</p>
    <p class="normal">As with AWS, Azure is <a id="_idIndexMarker1001"/>constantly innovating with new network services. We have covered the foundational services in this chapter; let’s take a look at some of the other notable services.</p>
    <h1 class="heading-1" id="_idParaDest-276">Other Azure network services</h1>
    <p class="normal">Some of the other Azure network services that we should be aware of are:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">DNS services</strong>: Azure <a id="_idIndexMarker1002"/>has a suite of DNS services (<a href="https://docs.microsoft.com/en-us/azure/dns/dns-overview"><span class="url">https://docs.microsoft.com/en-us/azure/dns/dns-overview</span></a>), both <a id="_idIndexMarker1003"/>public and private. It can be used for geographical load balancing for network services.</li>
      <li class="bulletList"><strong class="keyWord">Container networking</strong>: Azure<a id="_idIndexMarker1004"/> has been making a push toward containers in recent years. More information about Azure <a id="_idIndexMarker1005"/>network capabilities for containers can be found at <a href="https://docs.microsoft.com/en-us/azure/virtual-network/container-networking-overview"><span class="url">https://docs.microsoft.com/en-us/azure/virtual-network/container-networking-overview</span></a>.</li>
      <li class="bulletList"><strong class="keyWord">VNet TAP</strong>: Azure VNet TAP<a id="_idIndexMarker1006"/> allows you to continuously <a id="_idIndexMarker1007"/>stream your VM network traffic to a network packet collector or analytical tool (<a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-tap-overview"><span class="url">https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-tap-overview</span></a>).</li>
      <li class="bulletList"><strong class="keyWord">Distributed Denial of Service Protection</strong>: Azure <a id="_idIndexMarker1008"/>DDoS protection provides defense against<a id="_idIndexMarker1009"/> DDoS attacks (<a href="https://docs.microsoft.com/en-us/azure/virtual-network/ddos-protection-overview"><span class="url">https://docs.microsoft.com/en-us/azure/virtual-network/ddos-protection-overview</span></a>).</li>
    </ul>
    <p class="normal">Azure network services are a big part of the Azure cloud family and continue to grow at a fast rate. We have only covered a portion of the services in this chapter, but hopefully, it has given you a good foundation from which to begin to explore other services.</p>
    <h1 class="heading-1" id="_idParaDest-277">Summary</h1>
    <p class="normal">In this chapter, we took a look at the various Azure cloud network services. We discussed the Azure global network and various aspects of virtual networks. We used both the Azure CLI and the Python SDK to create, update, and manage those network services. When we need to extend Azure services to an on-premise data center, we can use either VPN or ExpressRoute for connectivity. We also briefly looked at various Azure network products and services.</p>
    <p class="normal">In the next chapter, we will revisit the data analysis pipeline with an all-in-one stack: the Elastic Stack.</p>
    <h1 class="heading-1">Join our book community</h1>
    <p class="normal">To join our community for this book – where you can share feedback, ask questions to the author, and learn about new releases – follow the QR code below:</p>
    <p class="normal"><a href="https://packt.link/networkautomationcommunity"><span class="url">https://packt.link/networkautomationcommunity</span></a></p>
    <p class="normal"><img alt="" src="../Images/QR_Code2903617220506617062.png"/></p>
  </div>
</body></html>