<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Some Fun Project Ideas</h1></div></div></div><p>In the previous projects, we have explored most of the important features of Tkinter. Developing new projects is now about extending what we have learned so far. In this project, we will build several partly-functional applications that you can take forward.</p><div><div><div><div><h1 class="title"><a id="ch07lvl1sec67"/>Mission Briefing</h1></div></div></div><p>In this project, we will develop "bare bone structures" for several applications from different domains. The applications<a id="id565" class="indexterm"/> we will build here include:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Screen saver</li><li class="listitem" style="list-style-type: disc">Snake game</li><li class="listitem" style="list-style-type: disc">Weather Reporter</li><li class="listitem" style="list-style-type: disc">Phonebook application</li><li class="listitem" style="list-style-type: disc">Graphing with Tkinter</li></ul></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec138"/>Why Is It Awesome?</h2></div></div></div><p>You will find this project useful as we will delve further in to learning about the power of Tkinter <strong>Canvas</strong> widget, and develop some basic animations for our screen saver program.</p><p>When developing the <a id="id566" class="indexterm"/>Snake game, we will learn to develop a multithreaded Python application efficiently using the <strong>Queue implementation</strong>
<a id="id567" class="indexterm"/>. As you will see, this is a handy tool to have when working on multithreaded applications.</p><p>The Weather Reporter application will introduce you to the basics of network programming. You will learn how to mine into the seemingly infinite resource that is available to us over the Internet.</p><p>The phonebook application will show you how to work with databases. This is vital for developing any large-scale application where persistence is required.</p><p>Finally, we look at basic graphing abilities of Tkinter. We also look at ways of embedding matplotlib graphs in Tkinter.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec139"/>Your Hotshot Objectives</h2></div></div></div><p>The key objectives outlined for<a id="id568" class="indexterm"/> this project include developing and understanding the followings:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Basic animations with Tkinter canvas</li><li class="listitem" style="list-style-type: disc">Queue implementation for a multithreaded Tkinter application</li><li class="listitem" style="list-style-type: disc">Network programming and tapping into resources over the Internet</li><li class="listitem" style="list-style-type: disc">Working with data interchange formats like JSON and XML</li><li class="listitem" style="list-style-type: disc">Database programming and basic CRUD operations on a database</li><li class="listitem" style="list-style-type: disc">Graphing with Tkinter</li></ul></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec68"/>Building a screen saver</h1></div></div></div><p>We will start by building<a id="id569" class="indexterm"/> a screen saver for our desktop. The screen saver will consist of several random-colored and random-sized balls bouncing all over the screen at random velocity, as shown in the following screenshot:</p><div><img src="img/7941OT_07_01.jpg" alt="Building a screen saver"/></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec140"/>Engage Thrusters</h2></div></div></div><p>Carry out the following steps to create the screen saver:</p><div><ol class="orderedlist arabic"><li class="listitem">Let's create a class to generate balls with random attributes. <a id="id570" class="indexterm"/>Accordingly, we define a new class named <code class="literal">RandomBall</code> to achieve this (refer to the <code class="literal">7.01 screensaver.py</code> Python file, available in the code bundle):<div><pre class="programlisting">from random import randint
class RandomBall:
    def __init__(self, canvas, scrnwidth, scrnheight):
        self.canvas = canvas
        self.xpos = randint(10, int(scrnwidth))
        self.ypos = randint(10, int(scrnheight))
        self.xvelocity = randint(6,12)
        self.yvelocity = randint(6,12)
        self.scrnwidth = scrnwidth
        self.scrnheight = scrnheight
        self.radius = randint(40,70)
        r = lambda: randint(0,255)
        self.color = '#%02x%02x%02x' % (r(),r(),r())</pre></div><p>The description <a id="id571" class="indexterm"/>of the code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">__init__</code> method takes three arguments, an instance of the Canvas widget, the screen width and the screen height. It then initializes the initial <em>x</em> and <em>y</em> positions for a ball as random numbers, starting from <code class="literal">0</code> up to the maximum screen coordinates.</li><li class="listitem" style="list-style-type: disc">It also initializes the velocity of the ball in <em>x</em> and <em>y</em> directions, the radius and color of the ball changes in a random fashion.</li><li class="listitem" style="list-style-type: disc">Because the hexadecimal color coding system uses two hexadecimal digits for each of red, green and blue colors, there are 16^2 (256) possibilities for each color. We therefore create a lambda function that generates a random number from 0-255, and use this function to generate three random numbers. We convert this decimal number to its two-digit equivalent hexadecimal notation using the format %02x to generate a random color for the balls.</li></ul></div></li><li class="listitem">The second method creates the actual ball using the canvas <code class="literal">create_oval</code> method (refer to the <code class="literal">7.01 screensaver.py</code> Python file available in the code bundle):<div><pre class="programlisting">
<code class="literal">def create_ball(self):</code>
<code class="literal">    x1 = self.xpos-self.radius</code>
<code class="literal">    y1 = self.ypos-self.radius</code>
<code class="literal">    x2 = self.xpos+self.radius</code>
<code class="literal">    y2 = self.ypos+self.radius</code>
<code class="literal">    self.itm = </code><strong>canvas.create_oval</strong>
<code class="literal">(x1, y1, x2, y2,</code>
<code class="literal">    fill=self.color, outline=self.color)</code>
</pre></div></li><li class="listitem">Let's now code the method to handle ball movement on the screen.<p>The <a id="id572" class="indexterm"/>method also checks if the ball has reached the end of the screen on any of the sides. If the ball has actually reached the end of the screen, it simply changes the direction by appending a negative sign to the velocity of the ball.</p><p>The method<a id="id573" class="indexterm"/> finally moves the ball using the <code class="literal">canvas.move</code> method (refer to <code class="literal">7.01 screensaver.py</code>):</p><div><pre class="programlisting">
<code class="literal">def move_ball(self):</code>
<code class="literal">    self.xpos += self.xvelocity</code>
<code class="literal">    self.ypos += self.yvelocity</code>
<code class="literal">    #Check if the Direction of ball movement is to be changed</code>
<code class="literal">    if self.ypos&gt;= self.scrnheight - self.radius:</code>
<code class="literal">        self.yvelocity = - self.yvelocity # change direction</code>
<code class="literal">    if self.ypos&lt;= self.radius :</code>
<code class="literal">        self.yvelocity = abs(self.yvelocity)</code>
<code class="literal">    if self.xpos&gt;= self.scrnwidth- self.radius or self.xpos&lt;= self.radius:</code>
<code class="literal">        self.xvelocity = -self.xvelocity # change direction</code>
<code class="literal">    self.</code><strong>canvas.move(self.itm</strong>
<code class="literal">, self.xvelocity, self.yvelocity)</code>
</pre></div><p>That is all to our <code class="literal">RandomBall</code> class. We can use this class to create as many ball objects as we want to display in our screen saver.</p></li><li class="listitem">Now, that we have coded methods to generate balls and to move them, let's create our screen saver. We now create a class named <code class="literal">ScreenSaver</code> that will show the actual screen saver:<div><pre class="programlisting">class ScreenSaver:
balls = []

def __init__(self, num_balls):
    self.root = Tk()
    w, h = self.root.winfo_screenwidth(),<code class="literal">    </code>self.root.winfo_screenheight()
    self.root.overrideredirect(1)
    self.root.geometry("%dx%d+0+0" % (w, h))
    self.root.attributes('-alpha', 0.3)
    self.root.bind('&lt;Any-KeyPress&gt;', quit)
    self.root.bind('&lt;Any-Button&gt;', quit)
    self.root.bind('&lt;Motion&gt;', quit)
    self.canvas = Canvas(self.root, width=w, height=h)
    self.canvas.pack()
    for i in range(num_balls):
        ball = RandomBall(self.canvas, scrnwidth=w, scrnheight=h)
        ball.create_ball()
        self.balls.append(ball)
    self.run_screen_saver()
    self.root.mainloop()</pre></div><p>The description <a id="id574" class="indexterm"/>of the code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">__init__</code> method of the <code class="literal">ScreenSaver</code> class<a id="id575" class="indexterm"/> takes the number of balls (<code class="literal">num_balls</code>) as its argument.</li><li class="listitem" style="list-style-type: disc">We then create a root window and calculate the height and width of the screen using the <code class="literal">winfo </code>method.</li><li class="listitem" style="list-style-type: disc">We use <code class="literal">root.overrideredirect(1)</code> to remove the enclosing frame from the parent window.</li><li class="listitem" style="list-style-type: disc">We then specify the geometry of the parent window to fill the entire screen.</li><li class="listitem" style="list-style-type: disc">We make the parent window transparent using <code class="literal">root.attributes('-alpha', 0.3)</code>. We add a transparency of <code class="literal">0.3</code> to make the window translucent.</li><li class="listitem" style="list-style-type: disc">We then bind the root to call our <code class="literal">quit</code> command on the event of clicking the mouse button, pressing any keyboard button, or mouse motion. This is to ensure that our program behaves like a screen saver, exiting on any interactions from the user's end.</li><li class="listitem" style="list-style-type: disc">We then create a canvas to cover the entire screen with <code class="literal">Canvas(self.root, width=w, height=h)</code>.</li><li class="listitem" style="list-style-type: disc">We create several random ball objects outs of the <code class="literal">RandomBall</code> class, passing along the Canvas widget instance, the width, and the height of the screen as its arguments.</li><li class="listitem" style="list-style-type: disc">We finally make a call to run the screen saver with the <code class="literal">run_screen_saver()</code> method<a id="id576" class="indexterm"/> within the <code class="literal">ScreenSaver</code> class, which is discussed in the following.</li></ul></div></li><li class="listitem">In this step,<a id="id577" class="indexterm"/> we will run the <code class="literal">ScreenSaver</code> class:<div><pre class="programlisting">
<code class="literal">def run_screensaver():</code>
<code class="literal">    for ball in balls:</code>
<code class="literal">        ball.move_ball()</code>
<code class="literal">    canvas</code><strong>.after(20, runScreenSaver)</strong>
</pre></div><p>The description of the code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">run_screensaver()</code> method<a id="id578" class="indexterm"/> simply moves each ball by calling itself at a regular interval of 20 milliseconds</li><li class="listitem" style="list-style-type: disc">We also define the <code class="literal">quit</code> method in our <code class="literal">ScreenSaver</code> class to quit from the main loop and exit the program:<div><pre class="programlisting">
<code class="literal">    def quit(event):</code>
<code class="literal">        root.destroy()</code>
</pre></div></li><li class="listitem" style="list-style-type: disc">To run the screen saver, we instantiate an object from our <code class="literal">ScreenSaver</code> class, passing the number of balls as its argument:<div><pre class="programlisting">
<code class="literal">if __name__ == "__main__":</code>
<code class="literal">    ScreenSaver(18)  ##18 is the number of balls</code>
</pre></div></li></ul></div></li></ol></div><div><div><h3 class="title"><a id="note51"/>Note</h3><p>We have used two Toplevel <a id="id579" class="indexterm"/>window methods <code class="literal">root.overrideredirect</code> and <code class="literal">root.attributes</code>, in the previous code.</p><p>For a complete list of methods that can be applied to the Toplevel window, refer to the <em>The Toplevel window methods </em>section in <a class="link" href="apb.html" title="Appendix B. Quick Reference Sheets">Appendix B</a>, <em>Quick Reference Sheets</em>.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec141"/>Objective Complete – Mini Debriefing</h2></div></div></div><p>Our screen saver is ready!</p><p>In fact, if you are working on a Windows platform, and when you learn to create an executable program from Python programs (discussed in <a class="link" href="apa.html" title="Appendix A. Miscellaneous Tips">Appendix A</a>, <em>Miscellaneous Tips</em>), you can create an executable file with <code class="literal">.exe</code> extension for this screen saver. So then, you can change its extension from <code class="literal">.exe</code> to <code class="literal">.scr</code> and right-click, and select <strong>Install</strong> to add it to your list of screensavers!</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec69"/>Building a Snake game</h1></div></div></div><p>Let's now build a<a id="id580" class="indexterm"/> simple Snake game. As usual, we will be making use of the Canvas widget to provide the platform for our Snake program.</p><p>We will use <code class="literal">canvas.create_line</code> to draw our snake, and <code class="literal">canvas.create_rectangle</code> to draw the snake-food.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec142"/>Prepare for Lift Off </h2></div></div></div><p>One of the primary<a id="id581" class="indexterm"/> objectives for this project is to introduce the Queue implementation in Python as we used it in conjunction with the <strong>threading</strong> module<a id="id582" class="indexterm"/>.</p><p>So far, we have built single-threaded applications. However, threading can be difficult to handle when there is more than one thread in an application, and these threads need to share attributes or resources among them. In this case, you cannot predict the thread execution order at all. OS does it very randomly and swiftly each time.</p><p>To handle this complexity, threading module provides some synchronization tools, such as locks, join, semaphores, events, and condition variables. However, it is—in most cases—safer and simpler to use queues. Simply put, a <strong>queue</strong>
<a id="id583" class="indexterm"/> is a compound memory structure that is thread-safe; queues effectively channel access to a resource to multiple threads in a sequential order, and are a recommended design pattern that uses threads for most of the scenarios that require concurrency.</p><p>The <strong>Queue</strong> module <a id="id584" class="indexterm"/>provides a way to implement different kinds of queuing, such as <a id="id585" class="indexterm"/>
<strong>FIFO</strong> (default implementation), <strong>LIFO</strong>
<a id="id586" class="indexterm"/> queue, and <strong>Priority</strong> queue<a id="id587" class="indexterm"/>, and this module comes with a built-in implementation of all locking semantics required for running multithreaded programs.</p><div><div><h3 class="title"><a id="note52"/>Note</h3><p>More information about the Queue module can be found in the following link:</p><p>
<a class="ulink" href="http://docs.Python.org/2/library/queue.html">http://docs.Python.org/2/library/queue.html</a>
</p></div></div><p>Here's a quick roundup of the basic usage of the Queue module:</p><div><pre class="programlisting">myqueue = Queue() #create empty queue
myqueue.put(data)# put items into queue
task = myqueue.get () #get the next item in the queue
myqueue.task_done() # called when a queued task has completed
myqueue.join() # called when all tasks in queue get completed</pre></div><p>Let's see a simple <a id="id588" class="indexterm"/>demonstration of using queue to implement a multithreaded <a id="id589" class="indexterm"/>application (refer to <code class="literal">7.02 threading with queue.py</code> available in the code bundle):</p><div><pre class="programlisting">import Queue
import threading
class Worker(threading.Thread):
    def __init__(self, queue):
        threading.Thread.__init__(self)
        self.queue = queue

    def run(self):
        while True:
            task = self.queue.get()
            self.taskHandler(task)
    
    def taskHandler(self, job):
        print'doing task %s'%job
        self.queue.task_done()
    def main(tasks):
        queue = Queue.Queue()
        for task in tasks:
            queue.put(task)
    # create some threads and assign them queue
        for i in range(6):
            mythread = Worker(queue)
            mythread.setDaemon(True)
            mythread.start()
        queue.join()
        print'all tasks completed'
    
    if __name__ == "__main__":
            tasks = 'A B C D E F'.split()
            main(tasks)</pre></div><p>The description of the code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We first create a <code class="literal">Worker</code> class, which inherits from the <code class="literal">threading</code> module of Python. The <code class="literal">__init__</code> method takes in a queue as its argument.</li><li class="listitem" style="list-style-type: disc">We then override the <code class="literal">run</code> method of the <code class="literal">threading</code> module to get each item from the queue using <code class="literal">queue.get()</code>, which is then passed on to the <code class="literal">taskHandler</code> method, which actually executes the task specified in the current queue item. In our example, it does nothing useful but printing the name of the task.</li><li class="listitem" style="list-style-type: disc">After the work is done on a particular thread by our <code class="literal">taskHandler</code> method, it sends a signal to the queue telling that the task has been completed using the <code class="literal">queue.task_done()</code> method.</li><li class="listitem" style="list-style-type: disc">Outside our <code class="literal">Worker</code> class, we create an empty queue in our <code class="literal">main()</code> method. This queue is populated with a list of tasks using <code class="literal">queue.put(task)</code>.</li><li class="listitem" style="list-style-type: disc">We then <a id="id590" class="indexterm"/>create six different threads and pass this populated queue as its argument. Now that the tasks are handled by the queue, all threads automatically ensure that the tasks are completed in a sequence in which they are encountered by the threads, without causing any deadlocks or two different threads trying to work on the same queued task.</li><li class="listitem" style="list-style-type: disc">At the time of creating each thread, we also create a pool of daemon threads using the <code class="literal">mythread.setDaemon(True)</code> method. Doing this passes control to our main program once all threads have completed execution. If you comment out the line, the program would still run, but would fail to exit after all threads have completed executing the tasks in the queue. Without the daemon threads, you'd have to keep track of all the threads and tell them to exit before your program could completely quit.</li><li class="listitem" style="list-style-type: disc">Finally, the <code class="literal">queue.join()</code> method ensures that the program flow waits there until the queue is empty.</li></ul></div><p>Now that we know how to use queues to handle multithreaded applications effectively, let's build our Snake game. In its final form, the game would be like the one shown in the following screenshot (refer to the <code class="literal">7.03 game of snake.py</code> Python file available in the code bundle):</p><div><img src="img/7941OT_07_02.jpg" alt="Prepare for Lift Off"/></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec143"/>Engage Thrusters</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem"><a id="id591" class="indexterm"/>Let's start coding our game, by first creating a basic <code class="literal">GUI</code> class.<div><pre class="programlisting">class GUI(Tk):
    def __init__(self, queue):
        Tk.__init__(self)
        self.queue = queue
        self.is_game_over = False
        self.canvas = Canvas(self, width=495, height=305, bg='#FF75A0')
        self.canvas.pack()
        self.snake = self.canvas.create_line((0, 0), (0,0), fill='#FFCC4C', width=10)
        self.food = self.canvas.create_rectangle(0, 0, 0, 0, fill='#FFCC4C', outline='#FFCC4C')
        self.points_earned = self.canvas.create_text(455, 15, fill='white', text='Score: 0')
        self.queue_handler()</pre></div><p>The description of the code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">This code should be mostly familiar to you by now, because we have created similar <code class="literal">GUI</code> classes several times in the past.</li><li class="listitem" style="list-style-type: disc">However, rather than passing the root instance as an argument to its <code class="literal">__init__</code> method, our GUI class now inherits from the Tk class. The line <code class="literal">Tk.__init__(self)</code>ensures that the root window is available to all methods of this class. This way we can avoid writing <code class="literal">root</code> attribute on every line by referencing <code class="literal">self.root</code> simply as <code class="literal">self</code>.</li><li class="listitem" style="list-style-type: disc">We then initialize the canvas, line (snake), rectangle (food) and text (to display score).</li><li class="listitem" style="list-style-type: disc">We then call the function <code class="literal">queueHandler().</code> This yet to be defined <a id="id592" class="indexterm"/>method would be similar to <code class="literal">main</code> method defined in the previous queue example. This would be the central method which will process all tasks in the queue. We will come back to define this method once we have added some tasks to the queue.</li></ul></div></li><li class="listitem">Now, we will create the <code class="literal">Food</code> class, as shown in the following code snippet:<div><pre class="programlisting">class Food():
    def __init__(self, queue):
        self.queue = queue
        self.generate_food()

    def generate_food(self):
           x = random.randrange(5, 480, 10)
            y = random.randrange(5, 295, 10)
        self.position = x, y
        self.exppos = x - 5, y - 5, x + 5, y + 5
        self.queue.put({'food': self.exppos})</pre></div><p>The description of the code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Because we want to process all data centrally from within a queue, we pass the queue as an argument to the <code class="literal">__init__</code> method of the <code class="literal">Food</code> class. We choose to run this from the main program thread to demonstrate how a code which is being executed in the main thread can communicate with attributes and methods from other threads.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">__init__</code> method calls another method called <code class="literal">generate_food()</code>, which is responsible for generating the snake-food at random positions on the canvas.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">generate_food</code> method<a id="id593" class="indexterm"/> generates a random <em>(x, y)</em> position on the canvas. However, because the place where the coordinates coincide is just a small point on the canvas, it would be barely visible. We therefore generate an expanded coordinate (<code class="literal">self.exppos</code>) ranging from five values less than the <em>(x,y)</em> coordinate up to five values higher than the same coordinate. Using this range, we can create a small rectangle on the canvas which would be easily visible and would represent our food.</li></ul></div><div><div><h3 class="title"><a id="note53"/>Note</h3><p>However, we do not create the rectangle here. Instead, we pass the coordinates for the food (rectangle) into our queue using <code class="literal">queue.put</code>. Because this queue is to be made available to all our classes, we will have a centralized worker named <code class="literal">queue_handler()</code>, which will process this queue to generate the rectangle from our GUI class later. This is the central idea behind a <a id="id594" class="indexterm"/>Queue implementation.</p></div></div></li><li class="listitem">Let's now create the <code class="literal">Snake</code> class. We have already passed a task to generate our food to the central queue. However, no thread was involved in the task. We could also generate our Snake class without using threads. However, because we are talking about ways to implement multithreaded applications, let's implement our Snake class to work from a separate thread (refer to <code class="literal">7.03 game of snake.py</code>):<div><pre class="programlisting">class Snake(threading.Thread):
    def __init__(self, gui, queue):
        threading.Thread.__init__(self)
        self.gui = gui
        self.queue = queue
        self.daemon = True
        self.points_earned = 0
        self.snake_points = [(495, 55), (485, 55), (475, 55), (465, 55), (455, 55)]
        self.food = Food(queue)
        self.direction = 'Left'
        self.start()

def run(self):
    while not self.gui.is_game_over:
        self.queue.put({'move':self.snake_points})
        time.sleep(0.1)
        self.move()</pre></div><p>The description of the code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">First, we create a class named <code class="literal">Snake</code> to run from a separate thread. This class takes the GUI and queue as its input arguments.</li><li class="listitem" style="list-style-type: disc">We initialize the points earned by the player from zero and set the initial location of the snake using the attribute <code class="literal">self.snake_points</code>.</li><li class="listitem" style="list-style-type: disc">Finally, we start the thread and create an infinite loop to call the <code class="literal">move()</code> method at small intervals. During every run of the loop, the method populates the queue with a dictionary having the key as <code class="literal">'move'</code> and the value equal to the updated position of the snake through the <code class="literal">self.snake_points</code> attribute.</li></ul></div></li><li class="listitem">In this step, we will be making the snake move. <p>The thread initialized above calls the <code class="literal">Snake</code> class <code class="literal">move()</code> method to move the <a id="id595" class="indexterm"/>snake around on the canvas. However, before we can move the snake, we need to know the direction in which the snake should move. This obviously depends on the particular key pressed by the user (Left/Right/Top/Down key).</p><p>Accordingly, we need to bind these four events to the Canvas widget. We will do the actual binding later. However, we can now create a method named called <code class="literal">key_pressed</code>, which takes the <code class="literal">key_press</code> event itself as its argument and sets the direction value according to the key that is pressed.</p><div><pre class="programlisting">def key_pressed(self, e):
	self.direction = e.keysym</pre></div><p>Now that we have the directions, let's code the <code class="literal">move</code> method:</p><div><pre class="programlisting">def move(self):
    new_snake_point = self.calculate_new_coordinates()
    if self.food.position == new_snake_point:
        self.points_earned += 1
        self.queue.put({'points_earned':self.points_earned })
        self.food.generate_food()
    else:
        self.snake_points.pop(0)
        self.check_game_over(new_snake_point)
        self.snake_points.append(new_snake_point)

def calculate_new_coordinates(self):
    last_x, last_y = self.snake_points[-1]
    if self.direction == 'Up':
        new_snake_point = last_x, (last_y - 10)
    elif self.direction == 'Down':
        new_snake_point = last_x, (last_y + 10)
    elif self.direction == 'Left':
        new_snake_point = (last_x - 10), last_y
    elif self.direction == 'Right':
        new_snake_point = (last_x + 10), last_y
    return new_snake_point

def check_game_over(self, snake_point):
    x,y = snake_point[0], snake_point[1]
    if not -5 &lt; x &lt; 505 or not -5 &lt; y &lt; 315 or snake_point in self.snake_points:
            self.queue.put({'game_over':True})</pre></div><p>The description<a id="id596" class="indexterm"/> for the code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">First, the <code class="literal">move</code> method obtains the latest coordinates for the snake depending on the keyboard event. It uses a separate method called <code class="literal">calculate_new_coordinates</code> to get the latest coordinates.</li><li class="listitem" style="list-style-type: disc">It then checks if the location of the new coordinates coincide with the location of the food. If they match, it increases the score of the player by one and calls the <code class="literal">Food</code> class <code class="literal">generate_food</code> method to generate a new food at a new location.</li><li class="listitem" style="list-style-type: disc">If the current point does not coincide with the food coordinates, it deletes the last item from the snake coordinates using <code class="literal">self.snake_points.pop(0)</code>.</li><li class="listitem" style="list-style-type: disc">Then, it calls another method named <code class="literal">check_game_over</code> to check if the snake collides against the wall or against itself. If the snake does collide, it appends a new dictionary item in the queue with the value <code class="literal">'game_over':True</code>.</li><li class="listitem" style="list-style-type: disc">Finally, if the game is not over, it appends the new position of the snake to the list <code class="literal">self.snake_points</code>. This is automatically added to the queue, because we have defined <code class="literal">self.queue.put({'move':self.snake_points})</code> in the <code class="literal">Snake</code> class's <code class="literal">run()</code> method to update every 0.1 seconds as long as the game is not over.</li></ul></div></li><li class="listitem">Now, let's create the Queue handler.<p>We now have a <code class="literal">Food</code> class feeding the centralized queue from the main program thread. We also have the <code class="literal">Snake</code> class adding data to the queue from one thread and a <code class="literal">GUI</code> class running the <code class="literal">queue_handler</code> method from another thread. So, the queue is the central point of interaction between these three threads.</p><p>Now, it is time to handle these data to update the content on the canvas. <a id="id597" class="indexterm"/>We accordingly define the <code class="literal">queue_handler()</code> method in our <code class="literal">GUI</code> class to work on items in the queue.</p><div><pre class="programlisting">def queue_handler(self):
    try:
        while True:
            task = self.queue.get(block=False)
            if task.has_key('game_over'):
                self.game_over()
            elif task.has_key('move'):
                points = [x for point in task['move'] for x in point]
                self.canvas.coords(self.snake, *points)
            elif task.has_key('food'):
                self.canvas.coords(self.food, *task['food'])
            elif task.has_key('points_earned'):
             self.canvas.itemconfigure(self.points_earned, text='Score:{}'.format(task['points_earned']))
           self.queue.task_done()
    except Queue.Empty:
        if not self.is_game_over:
            self.canvas.after(100, self.queue_handler)</pre></div><p>The description for the code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">queue_handler</code> method<a id="id598" class="indexterm"/> gets into an infinite loop looking for tasks in the queue using <code class="literal">task = self.queue.get(block=False)</code>. If the queue becomes empty, the loop is restarted using <code class="literal">canvas.after</code>.</li><li class="listitem" style="list-style-type: disc">Once a task is fetched from the queue, the method checks its key.</li><li class="listitem" style="list-style-type: disc">If the key is <code class="literal">'game_over'</code>, it calls another method named <code class="literal">game_over()</code> that we defined next.</li><li class="listitem" style="list-style-type: disc">If the key of task is <code class="literal">'move'</code>, it uses <code class="literal">canvas.coords</code> to move the line to its new position.</li><li class="listitem" style="list-style-type: disc">If the key is <code class="literal">'points_earned'</code>, it updates the score on the canvas.</li><li class="listitem" style="list-style-type: disc">When execution of a task completes, it signals the thread with the <code class="literal">task_done()</code> method.</li></ul></div><div><div><h3 class="title"><a id="note54"/>Note</h3><p>
<code class="literal">queue.get</code> can <a id="id599" class="indexterm"/>take both <code class="literal">block=True</code> (default) and <code class="literal">block=False</code> as its argument.</p><p>When the block is set to <code class="literal">False</code>, it removes and returns an item from the queue, if available. If the queue is empty, it raises <code class="literal">Queue.Empty</code>. When the block is set to <code class="literal">True</code>, <code class="literal">queue.get</code> fetches an item from the queue by suspending the calling thread, if required, until an item is available.</p></div></div></li><li class="listitem">In this step, we will code the method to handle the <code class="literal">game_over</code> feature for the game.<p>The <code class="literal">queue_handler</code> method<a id="id600" class="indexterm"/> calls the <code class="literal">game_over</code> method in case of a matching queue key:</p><div><pre class="programlisting">def game_over(self):
    self.is_game_over = True
    self.canvas.create_text(200, 150, fill='white', text='Game Over') 
    quitbtn = Button(self, text='Quit', command =self.destroy)
<strong>    self.canvas.create_window(200, 180, anchor='nw', window=quitbtn)</strong>
</pre></div><p>The description for the code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We first set the <code class="literal">game_over</code> attribute to <code class="literal">True</code>. This helps us exit out of the infinite loop of <code class="literal">queue_handler</code>. Then, we add a text on the canvas displaying the content <strong>Game Over</strong>.</li><li class="listitem" style="list-style-type: disc">We also add a <strong>Quit</strong> button inside the canvas, which has a command callback attached to quit the root window.<div><div><h3 class="title"><a id="tip26"/>Tip</h3><p>Take a note of how to attach other widgets inside the canvas widget.</p></div></div></li></ul></div></li><li class="listitem">Let's Run the <a id="id601" class="indexterm"/>game. The game is now ready. To run the game, we create a function outside all other classes named <code class="literal">main()</code>:<div><pre class="programlisting">def main():
    queue = Queue.Queue()
    gui     = GUI(queue)
    snake = Snake(gui, queue)
    gui.bind('&lt;Key-Left&gt;', snake.key_pressed)
    gui.bind('&lt;Key-Right&gt;', snake.key_pressed)
    gui.bind('&lt;Key-Up&gt;', snake.key_pressed)
    gui.bind('&lt;Key-Down&gt;', snake.key_pressed)
    gui.mainloop()

if __name__ == '__main__':
    main()</pre></div><p>We create an empty queue, and pass it as an argument to all three of our classes so that they can feed tasks into the queue. We also bind the four directional keys to the <code class="literal">key_pressed</code> method, which is defined earlier within our <code class="literal">Snake</code> class.</p></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec144"/>Objective Complete – Mini Debriefing</h2></div></div></div><p>Our game is now functional. Go try your hands at controlling the snake, while keeping its stomach filled.</p><p>To summarize, we created three classes such as <code class="literal">Food</code>, <code class="literal">Snake</code>, and <code class="literal">GUI</code>. These three classes feed information about the task related to their class to a centralized queue which is passed as an argument to all the classes.</p><p>Then, we create a centralized method named <code class="literal">queue_handler</code>, which handle tasks from the queue by polling tasks one at a time and completing it in a non-blocking manner.</p><p>The game could have been implemented without threads and queues, but it would have been slower, longer, and more complex. By using queues to manage data from multiple threads effectively, we have been able to contain the program to less than 150 lines of code.</p><p>Hopefully, you should now be able to implement queues for managing other programs that you design at your work.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec70"/>Creating a Weather Reporter</h1></div></div></div><p>Let's now build a simple <a id="id602" class="indexterm"/>Weather Reporter application. The goal of this project is to introduce you to the basics of network programming, as used in conjunction with Tkinter.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec145"/>Prepare for Lift Off </h2></div></div></div><p>Python has great support for network programming. At the lowest level, Python provides a socket module <a id="id603" class="indexterm"/>that lets you connect and interact with the network using a simple-to-use object-oriented interface.</p><p>For those unaware of network programming, sockets are the fundamental concept behind any kind of network communications done by your computer. This is the lowest level at which a programmer can access the network. Underneath the socket layer lie raw UDP and TCP connections, which are handled by your computer's operating system with no direct access points for the programmers. For instance, when you type <a class="ulink" href="http://www.packtpub.com">www.packtpub.com</a> in your browser, the operating system on your computer opens a socket and connects to <a class="ulink" href="http://packtpub.com">packtpub.com</a> to fetch the web page and show it to you. Same happens with any application that needs to connect to the network.</p><p>Let's take a brief look at some of the APIs available in the socket module:</p><div><pre class="programlisting">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) # create a #socket
socket.gethostbyname( host ) # resolving host IP from host name
s.connect((ip , port)) #Connect to remote server
s.sendall(message)
s.recv(message_size)</pre></div><p>If you look at the <code class="literal">7.04 socket demo.py</code> Python file in the code bundle of this project, you'll find that it sends a very obscure looking GET request to fetch the contents from the URL in the following line of code:</p><p>
<code class="literal">message = "GET / HTTP/1.1\r\n\r\n"</code>
</p><p>The data received from the server is also sent in packets, and it is our task to collect all the data and assemble them at our end. All these make direct socket programming a tedious approach. We do not want to be writing code for all that to fetch data from the network.</p><p>We will therefore use a higher-level module named <code class="literal">urllib</code>, which is built on top of sockets module but<a id="id604" class="indexterm"/> is easier to use. The <code class="literal">urllib</code> module forms a part of Python standard library. With this protocol, fetching contents of a web page turns into a four-line code (see the code in <code class="literal">7.05 urllib demo.py</code>):</p><div><pre class="programlisting">import urllib
data =  urllib.urlopen('http://www.packtpub.com')
print data.read()
data.close()</pre></div><p>This prints the entire<a id="id605" class="indexterm"/> HTML source code or whatever is the response from the web page <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. This is, in essence, the core of mining the Web for data and information.</p><p>Now that we know how to get data from a URL, let's apply it to build a small Weather Reporter application.</p><p>This application should take the location as an input from the user, and fetch relevant weather-related data.</p><div><img src="img/7941OT_07_03.jpg" alt="Prepare for Lift Off"/></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec146"/>Engage Thrusters</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">First,<a id="id606" class="indexterm"/> we will create t<a id="id607" class="indexterm"/>he GUI of the application. This should now be easy for you. We create a class <code class="literal">WeatherReporter</code>, and call it from outside the class within the main loop. See the code of <code class="literal">7.06 weather reporter.py</code>:<div><pre class="programlisting">def main():
    root=Tk()
    WeatherReporter(root)
    root.mainloop()

if __name__ == '__main__':
    main()</pre></div><p>The GUI component<a id="id608" class="indexterm"/> of the <code class="literal">WeatherReporter</code> class consists of two methods: <code class="literal">top_frame()</code> and <code class="literal">display_frame()</code>. The <code class="literal">top_frame()</code> method creates an entry widget and a button that says <a id="id609" class="indexterm"/>
<strong>Show Weather Info</strong>.</p><p>The <code class="literal">display_frame()</code> method<a id="id610" class="indexterm"/> creates a canvas where the actual weather data would be displayed:</p><div><pre class="programlisting">class WeatherReporter:
    def __init__(self, root):
        self.root = root
        self.top_frame()
        self.display_frame()

    def <strong>top_frame</strong>(self):
        topfrm = Frame(self.root)
        topfrm.grid(row=1, sticky='w')
        Label(topfrm, text='Enter Location').grid(row=1, column=2, sticky='w')
        self.enteredlocation = StringVar()
        Entry(topfrm, textvariable=self.enteredlocation).grid(row=1, column=2, sticky='w')
        ttk.Button(topfrm, text='Show Weather Info', command=self.show_weather_button_clicked).grid(row=1, column=3, sticky='w')

    def <strong>display_frame</strong>(self):
        displayfrm = Frame(self.root)
        displayfrm.grid(row=2, sticky='ew', columnspan=5)
        self.canvas = <strong>Canvas</strong>(displayfrm, height='410',width='300', background='black', borderwidth=5)
        self.canvas.create_rectangle(5, 5, 305, 415,fill='#F6AF06')
        self.canvas.grid(row=2, sticky='w', columnspan=5)</pre></div></li><li class="listitem">In the second step, we are going to fetch the weather data from a website.<p>There are two ways to fetch data from a website. The first method involves getting an HTML response from a website, and then parsing the received HTML response for data that is relevant to us. This type of data extraction is called <strong>site scraping</strong>
<a id="id611" class="indexterm"/>.</p><p>Site scraping is a rather crude method which is employed only when a given website does not provide a structured way to retrieve data. On the other hand, some websites are willing to share data <a id="id612" class="indexterm"/>through a set of APIs, provided you query it for data using the specified URL structure. This is clearly more elegant than site scraping, because<a id="id613" class="indexterm"/> data is interchanged in a reliable and "mutually agreed" format.</p><p>For our Weather Reporter application, we want to query some weather channel for a given location, and in turn retrieve and display the data in our canvas. Fortunately, there are several weather APIs which lets us do that.</p><div><div><h3 class="title"><a id="note256"/>Note</h3><p>In our example, we will use the weather data provided by a the
following website:
</p><p>
<a class="ulink" href="http://openweathermap.org/">http://openweathermap.org/</a></p></div></div><p>The OpenWeatherMap service provides free weather data and forecast APIs. This site collates weather data from more than 40,000 weather stations across the globe, and the data can be assessed by city name and geographic coordinates or their internal city ID.</p><p>The website provides weather data in two data formats:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">JSON (JavaScript Object Notation)</li><li class="listitem" style="list-style-type: disc">XML</li></ul></div><div><div><h3 class="title"><a id="note56"/>Note</h3><p>XML and JSON are two popular interchangeable data serialization formats widely used for data-interchanging among different applications, which may be running on different platforms and using different programming languages, thus providing the benefit of interoperability.</p><p>JSON<a id="id614" class="indexterm"/> is simpler than XML, because its grammar is simpler and it maps more directly onto the data structures used in modern programming languages. JSON is better suited for data exchanging, but XML is good for document exchanging.</p></div></div><p>The API documentation for the website tells us that a query, such as <code class="literal">api.openweathermap.org/data/2.5/weather?q=London,uk</code> returns us weather data for London in a JSON format as follows:</p><div><pre class="programlisting">{"coord":{"lon":-0.12574,"lat":51.50853},"sys":{"country":"GB","sunrise":1377147503,"sunset":1377198481},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"base":"gdps stations","main":{"temp":294.2,"pressure":1020,"humidity":88,"temp_min":292.04,"temp_max":296.48},"wind":{"speed":1,"deg":0},"rain":{"1h":0.25},"clouds":{"all":40},"dt":1377178327,"id":2643743,"name":"London","cod":200}</pre></div><p>The syntax of JSON is simple. Any JSON data is a name/value pair where each data is separated from the others by<a id="id615" class="indexterm"/> commas. JSON uses curly braces <code class="literal">{}</code> to hold objects and square brackets <code class="literal">[ ]</code> to hold arrays. We accordingly define a method to get the weather data in JSON format<a id="id616" class="indexterm"/> in our application (refer to <code class="literal">7.06 weather reporter.py</code> available in the code bundle of this project):</p><div><pre class="programlisting">def get_weather_data(self):
    try:
        apiurl = 'http://api.openweathermap.org/data
        /2.5/weather?q=%s'%self.enteredlocation.get()
        data =  urllib.urlopen(apiurl)
        jdata= data.read()
        returnjdata
    except IOError as e:
        tkMessageBox.showerror('Unable to connect', 'Unable toconnect %s'%e) </pre></div><p>This method uses <code class="literal">urllib</code> to retrieve responses from the website. It returns the response in JSON format.</p></li><li class="listitem">Now, we'll start processing the JSON data. The weather data returned using API is encoded in JSON format. We need to convert this data into Python data type. Python provides a built-in <code class="literal">json</code> module that eases the process of "encoding-decoding" JSON data. We therefore import the <code class="literal">json</code> module into our current namespace.<p>Then, we'll use this module to convert the retrieved JSON data into Python dictionary format (refer to <code class="literal">7.06 weather reporter.py</code>):</p><div><pre class="programlisting">def json_to_dict(self, jdata):
    mydecoder = json.JSONDecoder()
    decodedjdata = mydecoder.decode(jdata)
    flatteneddict = {}
    for key, value in decodedjdata.items():
        if key == 'weather':
            forke,va in value[0].items():
                flatteneddict[str(ke)] = str(va).upper() 
                continue
        try:
            fork,v in value.items():
            flatteneddict[str(k)] = str(v).upper()
        except:
            flatteneddict[str(key)] = str(value).upper()
        returnflatteneddict</pre></div></li><li class="listitem">Finally, we'll display the retrieved weather data. Now that we have a dictionary of all weather-related information provided by the API, let's add a command callback to the button:<div><pre class="programlisting">def show_weather_button_clicked(self):
    if not self.enteredlocation.get():
        return
    self.canvas.delete(ALL)
    self.canvas.create_rectangle( 5, 5,305,415,fill='#F6AF06')
    data = self.get_weather_data()
    data =self.json_to_dict(data)
    self.<strong>display_final</strong>(data)</pre></div><p>The <code class="literal">display_final</code> method <a id="id617" class="indexterm"/>simply takes each item from the dictionary and displays it on the canvas using <code class="literal">create_text</code>. <a id="id618" class="indexterm"/>We do not include the code for <code class="literal">display_final</code> because it merely displays the data on the canvas, and this idea should be self-explanatory by now. The API also<a id="id619" class="indexterm"/> provides an icon-related data. The icons are stored in a folder named <code class="literal">weatherimages</code> (refer to the folder with the same name provided in the code bundle) and an appropriate icon is displayed using <code class="literal">canvas.create_image</code>.</p></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec147"/>Objective Complete – Mini Debriefing</h2></div></div></div><p>Our Weather Reporter application is now functional. In essence, the application uses the <code class="literal">urllib</code> module to query the weather API provided by our data provider. The data is fetched in JSON format. The JSON data is then decoded into a Python-readable format (dictionary).</p><p>The converted data is then displayed on the canvas using <code class="literal">create_text</code> and <code class="literal">create_image</code> methods.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec148"/>Classified Intel</h2></div></div></div><p>When you access a server from your Python program, it is very important to send requests after small time gaps.</p><p>A typical Python program is capable of running several million instructions per second. However, the server that sends you the data at the other end is never equipped to work at that speed.</p><p>If you knowingly <a id="id620" class="indexterm"/>or unknowingly send large number of requests to a server within a short time-span, you may hamper it from servicing its routine requests from normal web users. This constitutes what is called the <strong>denial of service</strong> (<strong>DOS</strong>)<a id="id621" class="indexterm"/> attack on the server. You may be banned or, in worse case, sued for disrupting a server, if your program does not make a limited number of well-behaved requests.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec71"/>Creating a phonebook application</h1></div></div></div><p>Let's now build a simple phonebook application that allows the user to store names and phone numbers. The user should be able to create new records, read existing records, update existing records, and delete records from the database using this application. Together, these activities constitute what is known as <strong>CRUD</strong> (Create, Read, Update and Delete)<a id="id622" class="indexterm"/> operations on a database.</p><p>The main learning objective for this project relates to being able to use a relational database with Tkinter to store and <a id="id623" class="indexterm"/>manipulate records.</p><p>We have already seen some basic examples of object persistence with serialization. Relational databases extend this persistence using rules of relational algebra to store data into tables.</p><p>Python provides database<a id="id624" class="indexterm"/> interfaces for a wide range of database engines. In addition, Python provides a generic interface standard that can be used to access database engines, but it is not natively available as a Python module.</p><p>Some of the commonly-used database engines include MySQL, SQLite, PostgreSQL, Oracle, Ingres, SAP DB, Informix, Sybase, Firebird, IBM DB2, Microsoft SQL Server, Microsoft Access, and so on.</p><p>We will use SQLite to store data for our phonebook application.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec149"/>Prepare for Lift Off</h2></div></div></div><p>SQLite is a server-less, zero-configuration, self-contained SQL database engine suitable for developing embedded applications. The source code for SQLite is in the public domain, which makes it <a id="id625" class="indexterm"/>freely available for use in all sorts of commercial and non-commercial projects.</p><p>Unlike many other SQL databases, SQLite does not require running a separate server process. Instead, SQLite stores all the data directly onto flat files which get stored on a computer disk. These files are easily portable across different platforms, making it a very popular choice for smaller and simpler database implementation requirements.</p><p>Python 2.7 comes <a id="id626" class="indexterm"/>with a built-in standard library for sqlite3 support. However, we need to download the sqlite3 command-line tool that lets us create, modify, and access the database using a command-line tool. The command-line shell for Windows, Linux, and Mac OS X can be downloaded from <a class="ulink" href="http://sqlite.org/download.html">http://sqlite.org/download.html</a>.</p><p>Following the instruction on the website, install the SQLite command shell into any location of your choice.</p><p>Let us now implement our phonebook application. The application will look like the screenshot shown in the following. The application will demonstrate some of the common operations involved in database programming, as follows:</p><div><img src="img/7941OT_07_04.jpg" alt="Prepare for Lift Off"/></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec150"/>Engage Thrusters</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem"><a id="id627" class="indexterm"/>In order to <a id="id628" class="indexterm"/>create the database, we open the command-line tool of our operating system. On Windows, we generally invoke the command line by typing <code class="literal">cmd</code> in the run console.<p>Within the command line, we first navigate to the directory where we need to create the new database file. In order to create the database, we simply use this command:</p><div><pre class="programlisting">
<strong>sqlite3 phonebook.db</strong>
</pre></div><p>This creates a database file named <code class="literal">phonebook.db</code> in the folder from which we execute the command. It also displays a message similar to the one shown below:</p><div><pre class="programlisting">
<strong>SQLite version 3.7.17 2013-05-20 00:56:22</strong>
<strong>Enter ".help" for instructions</strong>
<strong>Enter SQL statements terminated with a ";"</strong>
<strong>sqlite&gt;</strong>
</pre></div><p>We have now <a id="id629" class="indexterm"/>created a database named <code class="literal">phonebook.db</code>. However, the database file is currently empty. It does not contain any tables or any data. So, we get no results if we run the command:</p><div><pre class="programlisting">
<strong>sqlite&gt; .tables</strong>
</pre></div><p>Let's for now exit the command-line tool by typing:</p><div><pre class="programlisting">
<strong>sqlite&gt; .exit</strong>
</pre></div></li><li class="listitem">We want to store contacts in our database, and that is why we need to create the c<code class="literal">ontacts</code> table. Intuitively, our database table should store a person's name and phone number. In addition, it is a good practice to keep a unique identification number for each person or each entry in the table. This is because multiple people might have the same name or same contact number.<p>To create a table within our <code class="literal">phonebook.db</code> database, we again open the command-line tool and navigate to the directory where we had created the database. We again get into the sqlite3 terminal by typing:</p><div><pre class="programlisting">
<strong>sqlite3 phonebook.db</strong>
</pre></div><p>This time a new database is<a id="id630" class="indexterm"/> not created. Rather, the command now opens the existing <code class="literal">phonebook.db</code> database, because it is already present on the disk.</p><p>Next, we create a table named <code class="literal">contacts</code>, and add three columns to the table from the command line:</p><div><pre class="programlisting">
<strong>sqlite&gt; CREATE TABLE contacts</strong>
<strong>(</strong>
<strong>contactid INTEGER PRIMARY KEY AUTOINCREMENT,</strong>
<strong>name STRINGNOT NULL,</strong>
<strong>contactnumber INTEGER NOT NULL</strong>
<strong>);</strong>
</pre></div><p>You can verify if the <code class="literal">contacts</code> table was created by typing the following command:</p><div><pre class="programlisting">
<strong>sqlite&gt;.table</strong>
</pre></div><p>This prints the name of all the tables present in the currently open database. You will get the following output:</p><div><pre class="programlisting">
<strong>sqlite&gt;.table
contacts</strong>
</pre></div></li><li class="listitem">Let's first begin by creating a basic GUI that would let us add, view, delete, and modify the records. We create a class named <code class="literal">PhoneBook</code> and create all GUI widgets from within its <code class="literal">__init__</code> method (refer to <code class="literal">7.07 phonebook.py</code>):<div><pre class="programlisting">class PhoneBook:
def __init__(self, master):
    # all widgets created here</pre></div><p>We do not rewrite the code here, because we have created similar widgets in all our previous projects.</p></li><li class="listitem">Let's start<a id="id631" class="indexterm"/> creating the records in the database file we created. A new record is to be created every time a user enters a new name and a phone number in the entry widgets provided, and clicks on the <strong>Add Record</strong> button.<div><pre class="programlisting">def create_record(self):
    name = self.namefield.get()
    num = self.numfield.get()
    if name == "":
        self.msg["text"] = "Please Enter name"
        return
    if num == "":
        self.msg["text"] = "Please Enter Number"
        return
    conn = sqlite3.connect('phonebook.db')
    c = conn.cursor()
    c.execute("INSERT INTO contacts VALUES(NULL,?, ?)", (name,num))
    conn.commit()
    c.close()
    self.namefield.delete(0, END)
    self.numfield.delete(0, END)
    self.msg["text"] = "Phone Record of %s Added" %name</pre></div><p>The description of the <a id="id632" class="indexterm"/>code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">create_record</code> method<a id="id633" class="indexterm"/>, as defined above, is attached as a command callback to the <strong>Add Record</strong> button.</li><li class="listitem" style="list-style-type: disc">When the <code class="literal">create_record</code> method is called, it retrieves the name and number values entered in the <strong>Name</strong> and <strong>Contact Number</strong> entry field.</li><li class="listitem" style="list-style-type: disc">If the name or number field is empty, it prints an error message and exits.</li><li class="listitem" style="list-style-type: disc">If name and number fields are valid, the method establishes connection to the <code class="literal">phonebook.db</code> database we had created earlier.</li><li class="listitem" style="list-style-type: disc">The next line, <code class="literal">c = conn.cursor()</code>, creates a cursor object. The cursor is a control structure that is required as per SQL standards, and it enables us to traverse over the records in a database.</li><li class="listitem" style="list-style-type: disc">The next<a id="id634" class="indexterm"/> line, <code class="literal">c.execute(query)</code> is the line that actually inserts the name and phone number into database. Note that it includes three insertion values: the first is the NULL value corresponding to autoincrement contact ID which is added through that we had created in our <code class="literal">contacts</code> table.</li><li class="listitem" style="list-style-type: disc">The line <code class="literal">conn.commit()</code> actually commits these changes to the database and line <code class="literal">c.close()</code> closes the connection to the database.</li></ul></div></li><li class="listitem">After the above steps are carried out, we will view the records stored in the database. This method is responsible for fetching all the records from the database and displaying them in the tree widget.<div><pre class="programlisting">def view_records(self):
    <strong>x = self.tree.get_children()</strong>
    for item in x: 
        self.tree.delete(item)
    conn = sqlite3.connect('phonebook.db')
    c = conn.cursor()
    list = <strong>c.execute("SELECT * FROM contacts ORDER BY namedesc")</strong>
    for row in list:
        <strong>self.tree.insert("",0,text=row[1],values=row[2])</strong>
    c.close()</pre></div><p>The description of the code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">view_records</code> method<a id="id635" class="indexterm"/> first deletes all existing items being displayed in the tree widget</li><li class="listitem" style="list-style-type: disc">It then establishes a database connection and queries the database to fetch all the data sorted by name in descending order</li><li class="listitem" style="list-style-type: disc">Finally, it iterates over the fetched record to update the tree widget with the content</li></ul></div></li><li class="listitem">Now, on the phonebook<a id="id636" class="indexterm"/> application we'll delete some records. The <code class="literal">delete_record</code> method is simply responsible for deleting a row from the database based on a given name criterion:<div><pre class="programlisting">def delete_record(self):
    self.msg["text"] = ""
    conn = sqlite3.connect('phonebook.db')
      c = conn.cursor()
    name = self.tree.item(self.tree.selection())['text']
<strong>    query = "DELETE FROM contacts WHERE name = '%s';" %name</strong>
<strong>    c.execute(query)</strong>
    conn.commit()
    c.close()
    self.msg["text"] = "Phone Record for %s Deleted" %name</pre></div><div><div><h3 class="title"><a id="tip27"/>Tip</h3><p>Although we have created this deletion query based on name, this method runs the risk of deleting multiple entries if two or more person have the same name. A better approach would be to delete the entries based on the primary key or contact id, which is unique for every entry in the table.</p></div></div></li><li class="listitem">The final operation<a id="id637" class="indexterm"/> in the phonebook application is modifying the records. When a user selects a particular record and clicks on the <strong>Modify Selected</strong> button<a id="id638" class="indexterm"/>, it opens a new Toplevel window like the one shown here:<div><img src="img/7941OT_07_05.jpg" alt="Engage Thrusters"/></div><p>This window is created using the <code class="literal">open_modify_window</code> method, as defined in the <code class="literal">7.07 phonebook.py</code> Python file. We will not reproduce the code for this method, because you should be comfortable making such windows by now.</p><p>When a user specifies a new<a id="id639" class="indexterm"/> number and clicks the <strong>Update Record</strong> button<a id="id640" class="indexterm"/>, <a id="id641" class="indexterm"/>it calls the <code class="literal">update_record</code> method, which is defined in the following:</p><div><pre class="programlisting">
<code class="literal">d</code>ef update_record(self, newphone,oldphone, name):
    conn = sqlite3.connect('phonebook.db')
    c = conn.cursor()
    c.execute("UPDATE contacts SET contactnumber=? WHEREcontactnumber=? AND name=?", (newphone, oldphone, name)) 
    conn.commit()
    c.close()
    self.tl.destroy()
    self.msg["text"] = "Phone Number of %s modified" %name</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec151"/>Objective Complete – Mini Debriefing</h2></div></div></div><p>We have completed coding a basic phonebook application.</p><p>More importantly, we have seen how to work with databases. Our phonebook application has demonstrated how to execute basic create, read, update, and delete (CRUD) operations on a database.</p><p>We have seen how to create database, add tables to the database, and query the database to add, modify, delete, and view items in the database.</p><p>Furthermore, due to similarity of basic database operations, you can now consider working with other database systems, such as MySQL, PostgreSQL, Oracle, Ingres, SAP DB, Informix, Sybase, Firebird, IBM DB2, Microsoft SQL Server, and Microsoft Access.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec72"/>Graphing with Tkinter</h1></div></div></div><p>Let us wrap up this project by looking <a id="id642" class="indexterm"/>at the graphing abilities of the Tkinter canvas widget.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec152"/>Engage Thrusters</h2></div></div></div><p>In this recipe we will <a id="id643" class="indexterm"/>see how we can plot:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Pie chart</li><li class="listitem" style="list-style-type: disc">Scatter chart</li><li class="listitem" style="list-style-type: disc">Bar graph</li><li class="listitem" style="list-style-type: disc">Embedding matplotlib graphs</li></ul></div><p>Let's look at the pie chart first:</p><div><img src="img/7941OT_07_06.jpg" alt="Engage Thrusters"/></div><div><ol class="orderedlist arabic"><li class="listitem">You can easily create <a id="id644" class="indexterm"/>pie charts in Tkinter using the Canvas widget's <code class="literal">create_arc</code> method<a id="id645" class="indexterm"/>. A sample Pie Chart code is provided in <code class="literal">7.08 pie chart.py</code>:<div><pre class="programlisting">import Tkinter
root = Tkinter.Tk()
def prop(n): 
    return 360.0 * n / 1000

Tkinter.Label(root, text='Pie Chart').pack()
c = Tkinter.Canvas(width=154, height=154)
c.pack()
c.<strong>create_arc</strong>((2,2,152,152), fill="#FAF402", outline="#FAF402", start=prop(0), extent = prop(200))
c.create_arc((2,2,152,152), fill="#00AC36", outline="#00AC36", start=prop(200), <strong>extent = prop(400)</strong>)
c.create_arc((2,2,152,152), fill="#7A0871", outline="#7A0871", start=prop(600), extent = prop(50))
c.create_arc((2,2,152,152), fill="#E00022", outline="#E00022", start=prop(650), extent = prop(200))
c.create_arc((2,2,152,152), fill="#294994", outline="#294994",  start=prop(850), extent = prop(150))
root.mainloop()</pre></div><p>The description of <a id="id646" class="indexterm"/>the code is as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Each portion of the pie chart is drawn by changing the two following <code class="literal">create_arc</code> options:<p>
<code class="literal">start</code>: This option specifies the start angle. Default is <code class="literal">0.0</code>.</p><p>
<code class="literal">extent</code>: This option specifies the size of <code class="literal">arc</code> relative to the start angle. Default is <code class="literal">90.0</code>.</p></li></ul></div></li><li class="listitem">Next, we'll plot a sample scatter chart:<div><img src="img/7941OT_07_07.jpg" alt="Engage Thrusters"/></div><p>Similarly, we can use <code class="literal">create_line</code> to draw the <em>x</em> and <em>y</em> axes and <code class="literal">create_oval</code> to draw the scatter plots, as shown in the preceding screenshot here. A sample scatter plot code is provided in the <code class="literal">7.09 scatter plot.py</code> Python file:</p><div><pre class="programlisting">import Tkinter
import random
root = Tkinter.Tk()
c = Tkinter.Canvas(root, width=350, height=280, bg='white')
c.grid()
#create x-axis
<strong>c.create_line(50, 250, 300, 250, width=3)</strong>
for i in range(12):
    x = 50 + (i * 20)
<strong>c.create_text(x, 255, anchor='n', text='%d'% (20*i))</strong>
# create y-axis
c.create_line(50, 250, 50, 20, width=3)
for i in range(12):
    y = 250 - (i * 20)
c.create_text(45, y, anchor='e', text='%d'% (20*i))
#create scatter plots from random x-y values
for i in range(35):
    x,y = random.randint(100,210), random.randint(50,250)
<strong>    c.create_oval(x-3, y-3, x+3, y+3, width=1, fill='red')</strong>
root.mainloop()</pre></div></li><li class="listitem">Now, let's plot a sample bar <a id="id647" class="indexterm"/>graph:<div><img src="img/7941OT_07_08.jpg" alt="Engage Thrusters"/></div><p>A bar graph can be <a id="id648" class="indexterm"/>easily generated using the Canvas widget's <code class="literal">create_rectangle</code> method<a id="id649" class="indexterm"/>. A sample bar graph code is provided in <code class="literal">7.10 bar graph.py</code>:</p><div><pre class="programlisting">import Tkinter
import random
root = Tkinter.Tk()
cwidth = 250
cheight = 220
barWidth = 20
canv = Tkinter.Canvas(root, width=cwidth, height=cheight, bg= 'white')
canv.pack()

plotdata= [random.randint(0,200) for r in xrange(12)]

for x, y in enumerate(plotdata):
    x1 = x  + x * barWidth
    y1 = cheight - y 
    x2 = x  + x * barWidth + barWidth    
    y2 = cheight
    canv.create_rectangle(x1, y1, x2, y2, fill="blue")
    canv.create_text(x1+3, y1, text=str(y), anchor='sw')

root.mainloop()</pre></div></li><li class="listitem">Finally, we're going to look at how to embed matplotlib graphs in Tkinter Toplevel window.<p>Using Tkinter Canvas to draw graphs may work fine for trivial cases. However, Tkinter may not be the best library<a id="id650" class="indexterm"/> when it comes to drawing more sophisticated and interactive graphs.</p><p>In fact, matplotlib is used in conjunction with the <a id="id651" class="indexterm"/>
<strong>NumPy</strong> module is the preferred choice when it comes to producing professional-quality graphs with Python.</p><div><img src="img/7941OT_07_09.jpg" alt="Engage Thrusters"/></div><p>Although a detailed <a id="id652" class="indexterm"/>discussion on matplotlib is beyond the scope of this book, we will take a brief look at embedding <a id="id653" class="indexterm"/>matplotlib-generated graphs on a Tkinter canvas.</p><div><div><h3 class="title"><a id="tip28"/>Tip</h3><p>If you are interested in exploring advanced graphing with Python, you can install matplotlib and NumPy (a dependency for matplotlib) with the help of the installation instructions available at <a class="ulink" href="http://matplotlib.org/users/installing.html">http://matplotlib.org/users/installing.html</a>
</p></div></div><div><pre class="programlisting">import Tkinter as Tk
from numpy import arange, sin, pi
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg, NavigationToolbar2TkAgg
from matplotlib.figure import Figure
root = Tk.Tk()
#creating the graph
f = Figure(figsize=(5,4), dpi=100)
a = f.add_subplot(111)
t = arange(-1.0,1.0,0.001)
s = t*sin(1/t)
a.plot(t,s)
# embedding matplotlib figure 'f' on a tk.DrawingArea
canvas = FigureCanvasTkAgg(f, master=root)
canvas.get_tk_widget().pack(side=Tk.TOP, fill=Tk.BOTH, expand=1)
#creating toolbar
toolbar = NavigationToolbar2TkAgg( canvas, root )
toolbar.update()
root.mainloop()</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec153"/>Objective Complete – Mini Debriefing</h2></div></div></div><p>This completes our brief discussion on the graphing abilities of Tkinter.</p><p>In this iteration, we saw how to use Tkinter Canvas to draw basic graphs such as pie chart, scatter plots, and bar graphs.</p><p>We also saw how to embed more sophisticated matplotlib graphs, on the Tkinter drawing area.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec73"/>Mission Accomplished</h1></div></div></div><p>This brings us to the end of this project. In this project, we took a deeper look into some of the many things that can be done with Tkinter Canvas widget.</p><p>We also learned how to use the Queue implementation to program a multithreaded application.</p><p>The Weather Reporter application introduced us to the basics of network programming and how to tap into the Internet for our data needs.</p><p>The phonebook application showed us how to work with databases.</p><p>Finally, we looked at basic graphing abilities of Tkinter, and we also looked at ways of embedding matplotlib graphs in Tkinter.</p></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec74"/>A Hotshot Challenge</h1></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Screen saver challenge</strong>: We have used the <code class="literal">create_oval</code> method of the Canvas widget to create multiple balls in our screen saver program. Try to experiment by replacing the oval with other canvas-supported shapes, such as lines, rectangles, and arcs.<p>In fact, because you can use the <code class="literal">create_image</code> method on Canvas, how about creating an aquarium brimming with different varieties of fishes, snails, aquatic animals, and plants? You can even add sky divers bubbling their way through the marine life!</p></li><li class="listitem" style="list-style-type: disc"><strong>Snake game challenge</strong>: Implement<a id="id654" class="indexterm"/> different levels of the Snake game by introducing mazes on the canvas.</li><li class="listitem" style="list-style-type: disc"><strong>Network programming challenge</strong>: Implement any other program that leverages the data available on the Internet to provide some value to the end user.</li><li class="listitem" style="list-style-type: disc"><strong>Database challenge</strong>: Revisit your media player program and implement a database to store playlists and automatically populate the media player when it is run.</li><li class="listitem" style="list-style-type: disc"><strong>Graphing challenge</strong>: Explore <a id="id655" class="indexterm"/>advanced graphing capabilities of matplotlib.</li></ul></div></div></body></html>