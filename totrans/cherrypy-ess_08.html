<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Ajax</h1></div></div></div><p>In the previous chapter, we built the photoblog web interface through the use of HTML, DOM, and JavaScript. We have shown how a web page could be modified dynamically from the browser itself. However, we have not detailed the nature of this dynamism, neither have we explained how to retrieve data from a web application server without refreshing the entire web page itself. The one who can do this for us is Ajax. So, the goal of this chapter is to introduce the concept of Ajax.<a id="id233" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec01"/>Rise of the Rich-Client Applications</h1></div></div></div><p>Until the year 2005, the most common pattern found in web applications was one HTTP request per page. In other words, navigation through a website was done through links that triggered the retrieval through an HTTP request of the linked resource. This pattern is still widely used but competes now with the pattern where we have several HTTP requests per page. The distinction might look anecdotal, but by allowing the browser to issue several HTTP requests to fetch more data from one web page at one given URI, it offers a different yet powerful path to the web developer desirous of creating a more interactive application.</p><p>For example, let's imagine a web application that shows a list of results by paging them instead of displaying them all at once. In traditional web applications, each time the end user went forward or backward, a new HTTP request would be sent to the server for the entire page to be reconstructed. In that case, the URL displayed in the browser address bar would also change, based on the current page viewed. On the other hand, imagine that instead of fetching the entire web page, only the new set of data to be displayed was fetched. We would still have one request made each time the customer moves from his or her current position, but it would be done without the replacement of the entire web page. The end user would have a lesser feeling of being governed by web pages, which could improve the overall experience of navigating through the set of data as well as reducing the bandwidth consumption.</p><p>This simplistic example is in fact a seed for all kind of enhancements for modern web applications that have led to the rise of rich-client applications.</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec02"/>Ajax</h1></div></div></div><p>In the year 2005, Jesse James Garrett (<a class="ulink" href="http://www.adaptivepath.com/publications/essays/archives/000385.php">http://www.adaptivepath.com/publications/essays/archives/000385.php</a>) coined the term Ajax to designate a set of technology that he was about to present to one of his clients. It has since then left its original author's hands and is today the referenced term for what we introduced in the previous section about making web applications look more dynamic and interactive.<a id="id234" class="indexterm"/>
</p><p>
<span class="strong"><strong>Ajax</strong></span> stands for<span class="strong"><strong> Asynchronous JavaScript and XML</strong></span>, and covers a set of technologies applied to a web environment. Let's review each part of the acronym:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<span class="strong"><strong>Asynchronous:</strong></span> In a client-server environment, there are two grand principles; either your operation is running synchronously to the rest of the program or not. If it is, then the program pauses until the operation terminates, and if it is not, then the operation returns immediately and lets the program continue. Once the operation is finished, it informs its main program through a callback function.</p><p>In the context of a web application, the whole purpose of Ajax is to bring more interactivity to the end user, which is why it broadly relies on asynchronous operations. Now, nothing prevents a developer from running specific operations synchronously to the rest of the application. This, however, can lead to the freezing of the entire browser, if the operation is not almost instantaneous.
</p></li><li class="listitem"><p>
<span class="strong"><strong>JavaScript:</strong></span> In a traditional approach where each action from the end user leads to a new HTTP request, this request is generated by the browser itself, which also consumes the HTTP response. With Ajax, the HTTP request is handled by a JavaScript call to an underlying HTTP API that we will review later on. Therefore, the web developer is in charge of creating a valid request, being able to handle its response, and eventually updating the end-user view of the web page.</p></li><li class="listitem"><p>
<span class="strong"><strong>XML:</strong></span> The main purpose of Ajax is to perform actions on the Document Object Model to either insert new content or remove parts of a web page from the end-user view. Ajax is based on the exchange of XML documents through HTTP. Those documents contain all the information and data necessary to perform the requested operation. Therefore, other formats of information can be used and XML is not compulsory. The most widespread format is JSON, which we will introduce later on.</p></li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec01"/>Ajax—Advantages and Drawbacks</h2></div></div></div><p>At first sight, the concepts carried by Ajax seem really promising and they certainly are. Nonetheless, the technologies required can lead to unexpected issues. First of all, let's review some of the advantages of Ajax:<a id="id235" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Server and bandwidth usage reduction: In a traditional web application, where each page is requested in its entirety from the server, there is a resource waste from both the server and the network. This is because the server may have to recompute the page and more data is carried on the wire. In both cases, however, the sensible use of caching would decrease that effect.</p><p>When using Ajax principles, only the needed data is fetched from the server. In that case, the server and intermediates could cache it. In any case, Ajax can reduce the load occurring on servers, as part of the processing is moved to the client itself.
</p></li><li class="listitem"><p>General improvement of the end-user experience: Since the web page view is updated locally on the client side following the user's actions, he or she may feel that the web application is more interactive and more responsive.</p></li><li class="listitem"><p>Separation of concerns enforced: Since the web developer is in charge of the construction of the HTTP request to be sent, he or she can decide to actually call different web services based on the current context of the application.</p><p>For instance, in a traditional web application an HTML form would be posted to the web server, which would return an HTML page. Ajax lets the developer decide which service will handle the user input. Therefore, the developer can call an Atom Publishing Protocol service that would return an Atom document that the developer would then handle manually. Ajax web applications can distribute their tasks among different specific services.
</p></li></ul></div><p>Now let's review the drawbacks associated with Ajax:<a id="id236" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>One of the biggest issues for web applications, based on the principles of Ajax, is that they by-pass the browser machinery and, therefore, the standard behavior of the backward and forward buttons is not assured anymore. In a more general way, Ajax breaks an end-user habit that has become the standard way of navigating the Web. For instance, the page-to-page pattern is a clear sign that the end-user action has triggered an operation resulting in a modification of the current state of the web page, whereas a web application that will modify only a part of the viewed page can confuse some users.</p></li><li class="listitem"><p>Ajax sometimes prevents users from bookmarking the pages.</p></li><li class="listitem"><p>Some have raised concerns about the possible security holes brought by Ajax and JavaScript. However, those claims are usually made against applications that had a weak point, not because of JavaScript but because of the way they have designed a functionality. In any case, you should always weigh the potential security risks for your own requirements when using Ajax. For instance, never trust client-side form validation only; make sure you validate any incoming data on the server side and keep client-side validation to minimize round-trip HTTP exchanges.<a id="id237" class="indexterm"/>
</p></li></ul></div><p>Generally, the pitfall regarding the use of Ajax in a web application is its overuse. Although this is a fairly subjective topic, the abuse of Ajax is frowned upon when it does not improve the end-user experience as compared to a more traditional approach. Our photoblog application will use Ajax fairly heavily.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec02"/>Behind the Scene: XMLHttpRequest</h2></div></div></div><p>As we have seen, Ajax is based on the idea of sending HTTP requests using JavaScript; more specifically Ajax relies on the<code class="literal"> XMLHttpRequest</code> object and its API to perform those operations. This object was first designed and implemented by Microsoft engineers as an ActiveX control available to Outlook Express and Internet Explorer, but it was not heavily used before the rise of Ajax and rich web applications. XMLHttpRequest is now part of every modern browser and is so widely used that the W3C has notably set up a working group to specify the boundaries of this object to provide the minimum interoperability requirements across implementations.<a id="id238" class="indexterm"/>
</p><p>Let's review the XMLHttpRequest interface specified by W3C, as it provides the most common attributes and functions implemented by browser vendors:<a id="id239" class="indexterm"/>
</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col width="1.55539435010329" style="text-align: left" class="C1"/><col width="3.92117024129936" style="text-align: left" class="C2"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Attributes</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">readyState</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Read-only attribute carrying the current status of the object:</p>
<p>
<code class="literal">0:</code> Uninitialized</p>
<p>
<code class="literal">1:</code> Open</p>
<p>
<code class="literal">2:</code> Sent</p>
<p>
<code class="literal">3:</code> Receiving</p>
<p>
<code class="literal">4:</code> Loaded</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">onreadystatechange</code>
</p>
</td><td style="text-align: left" valign="top">
<p>An EventListener is called when the<code class="literal"> readyState</code> attribute changes.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">responseText</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Contains the received bytes so far from the server as a string</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">responseXML</code>
</p>
</td><td style="text-align: left" valign="top">
<p>If the<code class="literal"> content-type</code> of the response was one associated with XML (<code class="literal">text/xml, application/xml</code>, or<code class="literal"> +xml)</code>, this contains an instance of the received document.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">status</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The HTTP response code</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">statusText</code>
</p>
</td><td style="text-align: left" valign="top">
<p>The HTTP response text</p>
</td></tr></tbody></table></div><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; "><colgroup><col width="2.18334722222222" style="text-align: left" class="C1"/><col width="3.27455381944444" style="text-align: left" class="C2"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Methods</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">abort()</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Cancels the underlying network connection with the server.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getAllReponseHeaders()</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Returns a string of all HTTP response headers separated by a new line.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">getResponseHeader(header)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Returns the value of the header if present in the response. An empty string otherwise.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">setRequestHeader(header, value)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Sets an HTTP header for the underlying request.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">open(method, uri, async, user, password)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Initializes the object:</p>
<p>
<code class="literal">method:</code> the HTTP method to be used for the request</p>
<p>
<code class="literal">uri:</code> the URI on which the request is applied</p>
<p>
<code class="literal">async:</code> a Boolean indicating whether this request must be synchronous with the rest of the program or not</p>
<p>
<code class="literal">username</code> and<code class="literal"> password:</code> provide the credentials to access the resource</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">send(data)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Realizes the HTTP connection and sets the request body with data if provided.</p>
</td></tr></tbody></table></div><p>The API is fairly straightforward and simple. Let's go through various examples using the MochiKit Async module.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec01"/>Performing a GET Request</h3></div></div></div><p>The<code class="literal"> GET</code> request is as shown:<a id="id240" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">var xmlHttpReq = getXMLHttpRequest();
xmlHttpReq.open("GET", "/", true);
var d = sendXMLHttpRequest(xmlHttpReq);
d.addCallback(function (data)
{
alert("Success!");
});
d.addErrback(function (data)
{
alert("An error occurred");
};
</pre></div><p>Now, we will see what we have actually done:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>1. As each browser has its own API for the developer who wishes to instantiate an XMLHttpRequest, Mochikit provides the<code class="literal"> getXMLHttpRequest()</code> function that will return the correct object by checking which browser the end user is using.<a id="id241" class="indexterm"/>
</p></li><li class="listitem"><p>2. We then initialize the object with required values. In this case, we want to perform a<code class="literal"> GET</code> request against the "/" URI of the current host in an asynchronous fashion.<a id="id242" class="indexterm"/>
</p></li><li class="listitem"><p>3. Then we inform the server that it must close the connection as soon as it finishes with our request and has sent us its response.</p></li><li class="listitem"><p>4. Then we use the Mochikit<code class="literal"> sendXMLHttpRequest()</code> function that returns a deferred object. This object offers the developer a clean API to handle the different states that an<code class="literal"> XMLHttpRequest</code> object can take during the processing.</p></li><li class="listitem"><p>a. We add a callback that will be applied if the response status code indicates a success (typically in the 2xx and 3xx ranges of HTTP).</p></li><li class="listitem"><p>b. We also associate an error callback that will be applied when the response indicates an error (typically in the 4xx and 5xx ranges of HTTP).</p></li><li class="listitem"><p>5. The<code class="literal"> data</code> parameter that each callback must take is the entity body included in the response, which can then be processed by the callback.</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec02"/>Performing a Content-Negotiated GET Request</h3></div></div></div><p>This<code class="literal"> GET</code> request is as shown:<a id="id243" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">var xmlHttpReq = getXMLHttpRequest();
xmlHttpReq.open("GET", "/", true);
xmlHttpReq.setRequestHeader('Accept', 'application/atom+xml');
xmlHttpReq.setRequestHeader('Accept-Language', 'fr');
var d = sendXMLHttpRequest(xmlHttpReq);
d.addCallback(function (data)
{
alert("Success!");
});
d.addErrback(function (data)
{
alert("An error occured");
});
</pre></div><p>In this request, we inform the server that we are willing to accept content that is represented using the Atom format and which uses the French language. A server that is unable to handle this request could respond with<code class="literal"> 406 Not Acceptable</code>, and therefore the error callback would be applied.<a id="id244" class="indexterm"/>
</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec03"/>Performing a POST Request</h3></div></div></div><p>The<code class="literal"> POST</code> request is as shown:<a id="id245" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">var qs = queryString(data);
var xmlHttpReq = getXMLHttpRequest();
xmlHttpReq.open("POST", "/album", true);
xmlHttpReq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
var d = sendXMLHttpRequest(xmlHttpReq, qs);
d.addCallback(function (data)
{
// do something
});
d.addErrback(function (data)
{
// do something else
});
</pre></div><p>Now, we will see what we have actually done:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>1. We post some data in the form of an encoded query string. The<code class="literal"> queryString(data)</code> function takes an associative array of key values and returns an encoded string of the form:<code class="literal"> key1=value1?key2=value2</code>.</p></li><li class="listitem"><p>2. We initialize the<code class="literal"> XMLHttpRequest</code> object.</p></li><li class="listitem"><p>3. We specify the content-type of our request entity body:<code class="literal"> application/x-www-form-urlencoded</code>
</p></li><li class="listitem"><p>4. Then we request a deferred object from<code class="literal"> sendXMLHttpRequest</code>, but as you can see we also pass the data we wish to send.</p></li></ol></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="ch08lvl4sec01"/>Let's POST an XML Document</h4></div></div></div><p>This is how we will do it:<a id="id246" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">var entry = '&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;entry&gt;
&lt;title&gt;This is my family album&lt;/title&gt;
&lt;id&gt;urn:uuid:25cd2014-2ab3-11db-902d-000ae4ea7d46&lt;/id&gt;
&lt;updated&gt;2006-08-13T11:18:01Z&lt;/updated&gt;
&lt;content type="text"&gt;Some content&lt;/content&gt;
&lt;/entry&gt;';
var xmlHttpReq = getXMLHttpRequest();
xmlHttpReq.open("POST", "/album", true);
xmlHttpReq.setRequestHeader('Content-Type', 'application/atom+xml');
var d = sendXMLHttpRequest(xmlHttpReq, entry);
d.addCallback(function (data)
{
// do something
});
d.addErrback(function (data)
{
// do something else
});
<a id="id247" class="indexterm"/>
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec04"/>Performing PUT, HEAD, or DELETE Requests</h3></div></div></div><p>Unlike HTML forms, XMLHttpRequest is not limited in terms of supported HTTP methods that it recognizes. In fact, XMLHttpRequest does not pay attention to the method that you use and does not interpret it. The method you use is sent as it is to the server. This is extremely important in web services based on REST or the Atom Publishing Protocol, as we have seen in the previous chapters.<a id="id248" class="indexterm"/>
</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec05"/>Cookies</h3></div></div></div><p>Cookies are sent along with the request, automatically by the user agent hosting XMLHttpRequest; therefore, there is no specific action for the developer to take.<a id="id249" class="indexterm"/>
</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec06"/>Authentication using Digest or Basic Schemes</h3></div></div></div><p>The<code class="literal"> open()</code> method of XMLHttpRequest can take<code class="literal"> username</code> and<code class="literal"> password</code> parameters to be sent along with the request. The authentication schemes supported by XMLHttpRequest are defined in RFC 2617, namely<span class="emphasis"><em> basic</em></span> and<span class="emphasis"><em> digest</em></span>. These two schemes are as follows:<a id="id250" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Basic scheme: The basic scheme is simply the transfer of the username and password encoded using the base64 algorithm. The issue with this is that, if a third-party fetches the encoded value, nothing can be done to prevent it from being decoded. This is why the basic is often referred as sending the password in clear text, because the applied encoding can be decoded very easily. It is therefore not a secure authentication scheme unless it is used on a secured protocol such as HTTPS.</p></li><li class="listitem"><p>Digest scheme: The digest scheme, on the other hand, does not send the password as it is across the wire. Instead, both the parties apply the same algorithm using the password and other seeds to compute a digest value of those. The server also sends the seed value on the first request to<span class="emphasis"><em> tag</em></span> that request. The client sends back the computation of the digest algorithm to the server, which compares it with its own computation. If the two match, the request is allowed. This scheme is safer than the basic one, as the password is actually never sent onto the wire in a form that can be decrypted in a reasonable amount of time.<a id="id251" class="indexterm"/>
</p></li></ul></div><p>By default, when using those schemes, a browser would open a pop-up window asking for a username and a password. In the context of request issued by a JavaScript call to XMLHttpRequest, it is possible to avoid that pop up by providing the user credentials directly to the<code class="literal"> open()</code> method. Obviously, it is out of question to hardcode them into the JavaScript code. Instead, it is fairly easy to integrate an HTML form into the web application and to dynamically pass the input values to the JavaScript call, as the following example demonstrates:<a id="id252" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;html&gt;
&lt;head&gt;
&lt;script type="application/javascript" src="MochiKit/MochiKit.js"&gt;
&lt;/script&gt;
&lt;script type="application/javascript" src="MochiKit/New.js"&gt;
&lt;/script&gt;
&lt;script type="application/javascript"&gt;
doLogin = function()
{
// create the XMLHttpRequest object
var xmlHttpReq = getXMLHttpRequest();
// initialize the object
// the "/hello/" + username URI is protected by a password
// the magic happens here as we pass dynamically the values
// of the username and password entered by the user
xmlHttpReq.open("GET", "/hello/" + $("username").value, true,
$("username").value, $("password").value);
// start the request
var d = sendXMLHttpRequest(xmlHttpReq);
// let's remove any previous displayed message from the DOM
replaceChildNodes($("message"));
// insert a welcome message if the authentication succeeded
d.addCallback(function (data)
{
appendChildNodes($("message"), SPAN({},
data.responseText));
});
// insert a message if the authentication failed
d.addErrback(function (data)
{
appendChildNodes($("message"), SPAN({}, "You're not
welcome here."));
});
};
&lt;/script&gt;
&lt;style type="text/css"&gt;
Body
{
text-align: center;
font-family: sans-serif;
}
#loginBox
{
“XMLHttpRequestauthenticating, digest scheme used"position:relative;
margin: 0px auto;
text-align:left;
width: 250px;
color: #2F2F2F;
padding-top: 25px;
}
Fieldset
{
background-color: #E9F3FF;
}
input, label
{
display: block;
float: left;
margin-bottom: 2px;
}
Label
{
text-align: left;
width: 70px;
padding-right: 10px;
}
Input
{
border: 1px #000 solid;
}
#loginButton
{
cursor: pointer;
font-weight: bold;
text-decoration: none;
color: #2F2F2F;
}
#loginButton:hover
{
text-decoration: underline;
}
“XMLHttpRequestauthenticating, digest scheme used"&lt;/style&gt;
&lt;/head&gt;
“XMLHttpRequestauthenticating, basic scheme used"&lt;body&gt;
&lt;div id="loginBox"&gt;
&lt;form name="login" id="login"&gt;
&lt;fieldset&gt;
&lt;label&gt;Username:&lt;/label&gt;
&lt;input type="text" name="username" id="username" /&gt;
&lt;br /&gt;&lt;br /&gt;
&lt;label&gt;Password:&lt;/label&gt;
&lt;input type="password" name="password" id="password" /&gt;
&lt;br /&gt;&lt;br /&gt;
&lt;span onclick="doLogin();" id="loginButton"&gt;Connect&lt;/span&gt;
&lt;/fieldset&gt;
&lt;/form&gt;
&lt;/div&gt;
&lt;div id="message" /&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div><p>The CherryPy script that would serve the previous page could look like:</p><div class="informalexample"><pre class="programlisting">import os.path
import cherrypy
class Root:
@cherrypy.expose
def index(self):
return file('ajaxdigest.html').read()
class Hello:
@cherrypy.expose
def default(self, username):
return "Hello %s" % username
if __name__ == '__main__':
r = Root()
r.hello = Hello()
current_dir = os.path.abspath(os.path.dirname(__file__))
def get_credentials():
return {'test': 'test'}
conf = {'/hello': {'tools.digest_auth.on': True,
'tools.digest_auth.realm': 'localhost',
'tools.digest_auth.users': get_credentials},
'/MochiKit': {'tools.staticdir.on': True, 'tools.staticdir.dir':
os.path.join(current_dir, 'MochiKit')}}
cherrypy.quickstart(r, config=conf)
</pre></div><p>When you access <a class="ulink" href="http://localhost:8080/">http://localhost:8080/</a>, you should get the following page:</p><div class="mediaobject"><img src="images/1848_08_01.jpg" alt="Authentication using Digest or Basic Schemes"/></div><p>If you enter the username<code class="literal"> test</code> and password<code class="literal"> test</code>, you will get the following view on your screen:<a id="id256" class="indexterm"/>
<a id="id257" class="indexterm"/>
</p><div class="mediaobject"><img src="images/1848_08_02.jpg" alt="Authentication using Digest or Basic Schemes"/></div><p>On the other hand, if you provide wrong values, you would get a screen like this:</p><div class="mediaobject"><img src="images/1848_08_03.jpg" alt="Authentication using Digest or Basic Schemes"/></div><p>Unfortunately, the browser receives the message from the server about the authentication failure with<code class="literal"> 401 HTTP error code</code> and handles it itself. As of today, there is no cross-browser way to avoid that issue so that the pop up does not appear. If you hit the<span class="strong"><strong> Cancel</strong></span> button of the pop up, the browser then goes back to your JavaScript code and the error callback is applied.<a id="id258" class="indexterm"/>
</p><p>Moreover, since you cannot access the underlying session through the<code class="literal"> XMLHttpRequest</code> object as it is handled by the browser, you cannot force a logout by suppressing the session credentials. The user has to close down the browser to disconnect from the application.<a id="id259" class="indexterm"/>
</p><p>Consequently, although XMLHttpRequest allows you to provide a fancier way to enable basic and digest authentication in your web application, there are still some pitfalls that need to be acknowledged.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec03"/>JSON</h1></div></div></div><p>As we have already seen in this chapter, in spite of carrying XML in its name, Ajax does not prevent other formats being carried. For instance, one extremely common format that you will see is<span class="strong"><strong> JSON</strong></span> (<span class="strong"><strong>JavaScript Object Notation</strong></span>).<a id="id260" class="indexterm"/>
</p><p>In a nutshell, JSON is a way to carry serialized JavaScript objects so that a JavaScript application can evaluate them and transform them into JavaScript objects that the application can manipulate.</p><p>For instance, when the user requests the server for an<code class="literal"> album</code> object formatted with the JSON format, the server would return the following content:</p><div class="informalexample"><pre class="programlisting">{'description': 'This is a simple demo album for you to test',
'author': 'Sylvain'}
</pre></div><p>We then use the<code class="literal"> evalJSONRequest()</code> function from Mochikit, as follows:</p><div class="informalexample"><pre class="programlisting">var data = evalJSONRequest(incoming);
</pre></div><p>Now the data is a JavaScript associative array and the description field can be accessed via:</p><div class="informalexample"><pre class="programlisting">data['description'];
</pre></div><p>JSON is widely deployed because it is simple, easy to use, and efficient to construct or evaluate. It does support all the common basic types such as numbers, Booleans, arrays, strings, or the null object. More complex objects are translated into associative arrays, where object attribute names serve as keys to access their associated value.</p><p>The photoblog application will mainly use the JSON format in its operations.</p><p>When your CherryPy application relies heavily on JSON, it may be interesting to write a tool to automatically perform the JSON serialization and deserialization.</p><div class="informalexample"><pre class="programlisting">import cherrypy
import simplejson
def dejsonify(encoding='utf-8'):
if cherrypy.request.method in ['POST', 'PUT']:
if 'content-type' in cherrypy.request.headers:
if cherrypy.request.headers['content-type'] ==
'application/json':
body_as_dict = simplejson.loads(
cherrypy.request.body.read())
for key in body_as_dict:
cherrypy.request.params[key.encode(encoding)] =
body_as_dict[key]
def jsonify():
if isinstance(cherrypy.response.body, dict):
cherrypy.response.headers['Content-Type'] = 'application/json'
cherrypy.response.body = simplejson.dumps(
cherrypy.response.body)
cherrypy.tools.dejsonifier = cherrypy.Tool('before_handler',
dejsonify)
cherrypy.tools.jsonifier = cherrypy.Tool('before_finalize', jsonify)
class Root:
def index(self):
return {'message': 'Hello'}
index.exposed = True
def process(self, name):
# do something here
return "Processed %s" % name
process.exposed = True
if __name__ == '__main__':
conf = {'/': {'tools.dejsonifier.on': True,
'tools.jsonifier.on': True}}
cherrypy.quickstart(Root(), config=conf)
</pre></div><p>We create two tools using the simple JSON module to perform the conversion. The first one deserializes the request body from JSON only on POST and PUT requests that have the<code class="literal"> application/json</code> content-type set. The tool loads the request body and transforms it into a dictionary, which is thereafter injected in the<code class="literal"> params</code> attribute of the<code class="literal"> cherrypy.request</code> object allowing CherryPy page handlers to expect keys of the JSON dictionary as regular parameters, as you can see in the process page handler. Note that we must encode those keys into Python strings from Unicode because CherryPy page handlers expect strings.</p><p>The second tool takes the dictionary returned by a page handler and serializes it into JSON.</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec04"/>Applying Ajax to our Application</h1></div></div></div><p>Our photoblog application will use Ajax fairly extensively, and to explain this we will review how to handle the albums of the photoblog.<a id="id263" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec03"/>Defining the Required Namespaces</h2></div></div></div><p>Our first step will be to define the JavaScript namespaces that will allow us to reuse common function names in different contexts while avoiding name collision. Using the term namespace is slightly unexpected because JavaScript does not have that notion per se, but it is possible to emulate this feature in a number of ways. In the case of this application, we will be using JavaScript inheritance that is simple enough to implement our requirement.<a id="id264" class="indexterm"/>
</p><p>The two namespaces that the photoblog application will use are:<code class="literal"> ui</code> and<code class="literal"> services</code>.</p><p>The<code class="literal"> ui</code> namespace will cover the different interactions with the end user, while the<code class="literal"> services</code> namespace will take care of exchanging data with the server. The<code class="literal"> ui</code> namespace classes and functions will therefore call the<code class="literal"> services</code> ones to perform operations requested by the end user.</p><p>To implement these two namespaces, we will simply define two empty JavaScript functions as follows:</p><div class="informalexample"><pre class="programlisting">function service()
{
};
function ui()
{
};
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec04"/>Implementing Namespaces</h2></div></div></div><p>We now have our functions and we can add attributes to them. Here we have the album class declaration that will handle all aspects of the album entity from a client-side point of view:<a id="id265" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">function albums()
{
this.visibility = false;
this.current = null;
this.position = 0;
this.step = 3;
};
ui.prototype.albums = new albums();
var ui = new ui();
</pre></div><p>Here, we first create a regular JavaScript function that is used as the constructor of an<code class="literal"> album</code> class. We also declare a few attributes attached to that object via the JavaScript keyword<code class="literal"> this</code>.</p><p>Then we add an<code class="literal"> albums</code> instance as an attribute of the<code class="literal"> ui</code> function object prototype and we finally create the unique instance of the<code class="literal"> ui</code> class that we will use throughout the life of the application within the session of the user.</p><p>From now on we can use the<code class="literal"> albums</code> instance to call its<code class="literal"> edit</code> method:</p><div class="informalexample"><pre class="programlisting">ui.albums.edit(...)
</pre></div><p>We then define similarly the<code class="literal"> album</code> class within the<code class="literal"> services</code> namespace.</p><div class="informalexample"><pre class="programlisting">function album()
{
};
service.prototype.albums = new album();
var services = new service();
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec05"/>Adding Methods to the Classes<a id="id266" class="indexterm"/>
</h2></div></div></div><p>The first method that we will add to our classes will be the one that toggles the visibility state of our albums container. This container will display information about existing albums and will fade in or fade out when the user clicks on the associated link. Let's see how to add methods:<a id="id267" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">albums.prototype.toggle = function(event)
{
toggle($('content-pane'), 'blind');
if(this.visibility == false)
{
this.visibility = true;
this.forward(e);
}
Else
{
this.visibility = false;
replaceChildNodes(albumsPane);
}
toggle($('albums-pane'), 'blind');
};
</pre></div><p>This method first toggles the visibility of the content panel that contains the current photograph. Then if the toggle means to open the<code class="literal"> albums</code> panel, we set its visibility to<code class="literal"> true</code> and we call the<code class="literal"> forward</code> method. Otherwise, we set the visibility to<code class="literal"> false</code> and we delete any elements attached to that container so that they don't waste memory. Finally, we request Mochikit to change the visibility state of the<code class="literal"> albums</code> panel. We then connect that method to the<code class="literal"> onclick</code> signal of the associated link as follows:</p><div class="informalexample"><pre class="programlisting">connect($('albums'), 'onclick', ui.albums, 'toggle');
</pre></div><p>The<code class="literal"> forward</code> method is defined as follows:</p><div class="informalexample"><pre class="programlisting">albums.prototype.forward = function(event)
{
var start = this.position;
var end = start + this.step;
services.albums.fetch_range(start, end, this);
this.position = end;
};
</pre></div><p>The method first defines the range of albums we will need to fetch from the server. Then we call the<code class="literal"> fetch_range()</code> method of the<code class="literal"> services.albums</code> object, and we finally set the new starting position for the next call to that method.</p><p>Let's now review the<code class="literal"> services.albums</code> object itself:</p><div class="informalexample"><pre class="programlisting">album.prototype.fetch_range = function(start, end, src)
{
var xmlHttpReq = getXMLHttpRequest();
xmlHttpReq.open("GET", albumsBaseUri.concat(start, "-", end), true);
xmlHttpReq.setRequestHeader('Accept', 'application/json');
var d = sendXMLHttpRequest(xmlHttpReq);
d.addCallback(function (data)
{
var data = evalJSONRequest(data);
src.populate(data);
});
};
<a id="id268" class="indexterm"/>
</pre></div><p>You may notice that this method takes an extra parameter named<code class="literal"> src</code>, which is the calling object so that our callbacks can apply methods on that object when receiving a response from the server.</p><p>The requested URI<code class="literal"> albumsBaseUri.concat(start, "-", end). albumsBaseUri</code>, is a global string variable containing the base URI for performing requests against collections of albums.</p><p>We specify that we would prefer the server to send us back a JSON content, as this is what we will be using to populate the retrieved albums.</p><p>The request issued would look like this:</p><div class="informalexample"><pre class="programlisting">http://localhost:8080/services/rest/albums/0-3
GET /services/rest/albums/0-3 HTTP/1.1
Host: localhost:8080
Accept: application/json
Connection: close
</pre></div><p>And its response would be:</p><div class="informalexample"><pre class="programlisting">HTTP/1.x 200 OK
Connection: close
Date: Tue, 19 Sep 2006 20:29:07 GMT
Content-Length: 763
Content-Type: application/json
Allow: GET, HEAD
Server: CherryPy/3.0.0beta
</pre></div><p>The returned content would be then evaluated by the MochiKit function<code class="literal"> evalJSONRequest()</code> to return an instance of JavaScript objects; in this case an array of associative arrays. Once we have received and evaluated the content, we call the<code class="literal"> populate()</code> method of the<code class="literal"> ui.album</code> class to display the retrieved albums. This method is defined as follows:</p><div class="informalexample"><pre class="programlisting">albums.prototype.populate = function(albums)
{
// get the albums container
var albumsPane = $('albums-pane');
// we remove any already displayed albums form the DOM tree
replaceChildNodes($('albums-pane'));
// define a set of links that we will use to move through the
// set of albums
var previous = SPAN({'id': 'previous-albums', 'class':
'infos-action'}, 'Previous');
connect(previous, 'onclick', this, 'rewind');
var next = SPAN({'id': 'next-albums', 'class': 'infos-action'},
'Next');
connect(next, 'onclick', this, 'forward');
// we also add a link that when triggered will display the
// form to create a new Album
var create = SPAN({'class': 'infos-action'}, 'Create');
connect(create, 'onclick',this, 'blank');
// in case no albums were retrieved we simply display a default
// message
if(albums.length == 0)
{
appendChildNodes(albumsPane, SPAN({'id': 'info-msg', 'class':
'info-msg'}, 'No more album to view.'));
appendChildNodes(albumsPane, previous);
return;
}
// now we traverse the array of retrieved albums to construct
// a tree structure of each that we will then insert into the
// main DOM tree
for(var album in albums)
{
album = albums[album];
var albumInfoBlock = DIV({'class': 'albums-infos-pane', 'id':
'album-' + album['id']},
LABEL({'class': 'infos-label'}, 'Title:'),
SPAN({'class': 'infos-content'}, album['title']), BR(),
LABEL({'class': 'infos-label'}, 'Created on:'),
SPAN({'class': 'infos-content'}, album['created']), BR(),
LABEL({'class': 'infos-label'}, 'Updated on:'),
SPAN({'class': 'infos-content'}, album['modified']), BR(),
LABEL({'class': 'infos-label'}, 'Description:'),
SPAN({'class': 'infos-content'}, album['description']), BR());
// we provide a link Edit and Delete to each album displayed
var editAlbumElement = SPAN({'class': 'infos-action'}, 'Edit');
connect(editAlbumElement, 'onclick', this, 'fetch_for_edit');
var deleteAlbumElement = SPAN({'class': 'infos-action'},
'Delete');
connect(deleteAlbumElement, 'onclick', this, 'ditch');
appendChildNodes(albumInfoBlock, editAlbumElement);
appendChildNodes(albumInfoBlock, deleteAlbumElement);
// we finally connect the onclick signal of the block
// carrying the album information. When a user clicks
// it will toggle the albums panel visibility and
// display the selected album.
connect(albumInfoBlock, 'onclick', this, 'select');
appendChildNodes(albumsPane, albumInfoBlock);
}
// we eventually insert all those new elements into the
// main DOM tree to be displayed.
appendChildNodes(albumsPane, previous);
appendChildNodes(albumsPane, next);
appendChildNodes(albumsPane, create);
};
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec06"/>Method to Create a New Album</h2></div></div></div><p>Now that we can display albums, we will review how to create a new album. To do so, we first need a form to gather the user input. Let's explain the<code class="literal"> ui.albums.blank()</code> method that is in charge of displaying the form by dynamically inserting it into the DOM tree.<a id="id269" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">albums.prototype.blank = function(e)
{
// those two elements will be links to either submit the form
// or canceling the process by closing the form
var submitLink = SPAN({'id': 'form-submit', 'class': 'form-link'},
'Submit');
var cancelLink = SPAN({'id': 'form-cancel', 'class': 'form-link'},
'Cancel');
// we will insert error messages when specific fields are
// not filled
var successMessage = SPAN({'id': 'form-success', 'class':
'form-success'}, 'Album created');
var errorMessage = SPAN({'id': 'form-error', 'class':
'form-error'}, 'An unexpected error occured');
var titleErrMsg = SPAN({'id': 'form-title-error', 'class':
'form-error'}, 'You must provide a title');
var authorErrMsg = SPAN({'id': 'form-author-error', 'class':
'form-error'}, 'You must specify the author name');
var descErrMsg = SPAN({'id': 'form-desc-error', 'class':
'form-error'}, 'You must provide a description');
// the main form
var albumForm = DIV({'id': 'pageoverlay'},
DIV({'id': 'outerbox'},
DIV({'id': 'formoverlay'},
SPAN({'class': 'form-caption'}, 'Create a new album'),
BR(),BR(),
FORM({'id': 'create-album', 'name':"albumForm"}, titleErrMsg,
LABEL({'class': 'form-label'}, 'Title:'),
INPUT({'class': 'form-input', 'name': 'title', 'id':
'album-title', 'value': ''}),
BR(),
LABEL({'class': 'form-label'}, 'Segment:'),
INPUT({'class': 'form-input', 'name': 'segment', 'id':
'album-segment', 'value': ''}), BR(), authorErrMsg,
LABEL({'class': 'form-label'}, 'Author:'),
INPUT({'class': 'form-input', 'name': 'author', 'id':
'album-author', 'value': ''}), BR(), descErrMsg,
LABEL({'class': 'form-label'}, 'Description:'),
TEXTAREA({'class': 'form-textarea', 'name': 'description',
'id': 'album-desc', 'rows': '2', 'value': ''}), BR(),
LABEL({'class': 'form-label'}, 'Content:'),
TEXTAREA({'class': 'form-textarea', 'name': 'content', 'id':
'album-content', 'rows': '7', 'value': ''}), BR()),
successMessage, errorMessage,
DIV({'id': 'form-links'},
submitLink,
cancelLink))));
hideElement(titleErrMsg);
hideElement(authorErrMsg);
hideElement(descErrMsg);
hideElement(errorMessage);
hideElement(successMessage);
connect(submitLink, 'onclick', this, 'create');
connect(cancelLink, 'onclick', closeOverlayBox);
appendChildNodes($('photoblog'), albumForm);
};
<a id="id270" class="indexterm"/>
</pre></div><p>The creation of the form block requires further explanation. In order to provide a fancier panel carrying the form, we use the technique deployed in scripts such as<span class="emphasis"><em> Lightbox</em></span> or<span class="emphasis"><em> Thickbox</em></span>. Both rely on the overlay capabilities of CSS applied to the DOM to display elements on top of others. Overlays allow displaying elements not in a sequential fashion but as a pile. This feature associated with a sensible use of HTML blocks as<code class="literal"> DIVs</code> and appropriate colors can provide an attractive way to display the content, as the following screenshot demonstrates:</p><div class="mediaobject"><img src="images/1848_08_04.jpg" alt="Method to Create a New Album"/></div><p><a id="id271" class="indexterm"/>
If you do not fill the required fields and submit the form, you will end up with a screen as displayed in the following screenshot:</p><div class="mediaobject"><img src="images/1848_08_05.jpg" alt="Method to Create a New Album"/></div><p>If you fill the required fields and submit the form, you would get a screen as shown:</p><div class="mediaobject"><img src="images/1848_08_06.jpg" alt="Method to Create a New Album"/></div><p>In order to avoid the situation where the user tries to re-submit the form, we remove the<span class="strong"><strong> Submit</strong></span> link and the user can now safely close this screen.</p><p>The HTTP exchange will look like this:<a id="id272" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">POST /services/rest/album/ HTTP/1.1
Host: localhost:8080
Accept: application/json
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
Content-Type: application/x-www-form-urlencoded
Content-Length: 167
Pragma: no-cache
blog_id=1&amp;title=My%20holiday%20on%20Mars&amp;author=Sylvain&amp;description= My%20holiday%20on%20Mars.&amp;content=Mars%20is%20nice%20but%20a%20little%20quiet.
HTTP/1.x 201 Created
Connection: close
Content-Length: 289
Server: CherryPy/3.0.0beta
Location: http://localhost:8080/album/19
Allow: DELETE, GET, HEAD, POST, PUT
Date: Wed, 20 Sep 2006 19:59:59 GMT
</pre></div><p>Note that the response gives us the URI to directly access the newly created album.</p><p>The method to handle the previous HTTP exchange is<code class="literal"> services.album.create()</code>, as follows:</p><div class="informalexample"><pre class="programlisting">album.prototype.create = function(data, src)
{
var qs = queryString(data);
var xmlHttpReq = getXMLHttpRequest();
xmlHttpReq.open("POST", albumBaseUri, true);
xmlHttpReq.setRequestHeader('Content-Type',
'application/x-www-form-urlencoded');
xmlHttpReq.setRequestHeader('Accept', 'application/json');
var d = sendXMLHttpRequest(xmlHttpReq, qs);
d.addCallback(function (data)
{
src.showSuccessMessage();
});
d.addErrback(function (data)
{
src.showErrorMessage();
});
};
</pre></div><p>The<code class="literal"> data</code> parameter is a JavaScript associative array of the form fields. The<code class="literal"> src</code> parameter is the<code class="literal"> ui.albums</code> instance, which is extended with the following methods:</p><div class="informalexample"><pre class="programlisting">albums.prototype.create = function(event)
{
if(this.validate())
{
// blogId is a global variable containing the current photoblog
// identifier
var data = {'blog_id': blogId, 'title': $('album-title').value,
'author': album-author').value,
'description': $('album-desc').value,
'content': $('album-content').value};
services.albums.create(data, this);
}
};
albums.prototype.validate = function()
{
var ready = true;
hideElement($('form-title-error'));
hideElement($('form-author-error'));
hideElement($('form-desc-error'));
if($('album-title').value == '')
{
appear($('form-title-error'));
ready = false;
}
if($('album-author').value == '')
{
appear($('form-author-error'));
ready = false;
}
if($('album-desc').value == '')
{
appear($('form-desc-error'));
ready = false;
}
return ready;
};
albums.prototype.showSuccessMessage = function()
{
hideElement($('form-title-error'));
hideElement($('form-author-error'));
hideElement($('form-desc-error'));
appear($('form-success'));
fade($('form-submit'));
};
albums.prototype.showErrorMessage = function()
{
hideElement($('form-title-error'));
hideElement($('form-author-error'));
hideElement($('form-desc-error'));
appear($('form-error'));
};
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec07"/>Method to Update an Existing Album</h2></div></div></div><p>This follows the same principles as we have seen in the previous section, except that we provide an<code class="literal"> album</code> object to fill the form automatically with its values.<a id="id275" class="indexterm"/>
</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec08"/>Method to Delete an Existing Album</h2></div></div></div><p>Finally, we need a method to delete an album:<a id="id276" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">// method part of the ui namespace
albums.prototype.ditch = function(event)
{
// stop the propagation of the click event so that
// the select method is not applied
event.stop();
// shows a modal dialogbox asking the confirmation of the deletion
var doit = confirm("Are you sure you want to delete this album?");
if(doit)
{
// we retrieve the id of the album to delete from
// the block carrying the album &lt;div id="album-19"&gt;...&lt;/div&gt;
var currentAlbumId = (e.src().parentNode.id).substr(6);
services.albums.remove(currentAlbumId);
switchOff(e.src().parentNode);
}
};
// method part of the services namespace
album.prototype.remove = function(id)
{
if(id != null)
{
var xmlHttpReq = getXMLHttpRequest();
xmlHttpReq.open("DELETE", albumBaseUri + id, true);
var d = sendXMLHttpRequest(xmlHttpReq);
}
};
</pre></div><p>The HTTP exchange would look like this:</p><div class="informalexample"><pre class="programlisting">DELETE /services/rest/album/19 HTTP/1.1
Host: localhost:8080
Connection: close
Content-Length: 0
HTTP/1.x 200 OK
Connection: close
Date: Wed, 20 Sep 2006 20:39:49 GMT
Content-Length: 0
Allow: DELETE, GET, HEAD, POST, PUT
Server: CherryPy/3.0.0beta
</pre></div><p>We have explained the basic methods to manipulate albums of the photoblog application. The same principles will be applied for the other entities of the application: film and photo.</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec05"/>Summary<a id="id277" class="indexterm"/>
</h1></div></div></div><p>This chapter has introduced you to Ajax and more generally to the basics of client-side programming using JavaScript. The possibilities are almost endless and the near future should see extremely interesting and powerful web applications that will slowly take the place of their rich-client counterparts.</p></div></div></div>
</body></html>