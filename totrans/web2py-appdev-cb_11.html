<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="ch11"/>Chapter 11. Other Tips and Tricks</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Using PDB and the embedded web2py debugger</p></li><li class="listitem"><p>Debugging with Eclipse and PyDev</p></li><li class="listitem"><p>Updating web2py using a shell script</p></li><li class="listitem"><p>Creating a simple page statistics plugin</p></li><li class="listitem"><p>Rounding corners without images or JavaScript</p></li><li class="listitem"><p>Setting a<code class="literal"> cache.disk</code> quota</p></li><li class="listitem"><p>Checking if web2py is running using<code class="literal"> cron</code>
</p></li><li class="listitem"><p>Building a Mercurial plugin</p></li><li class="listitem"><p>Building a pingback plugin</p></li><li class="listitem"><p>Changing views for mobile browsers</p></li><li class="listitem"><p>Background processing with a database queue</p></li><li class="listitem"><p>How to effectively use template blocks</p></li><li class="listitem"><p>Making standalone applications with web2py and wxPython</p></li></ul></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec01"/>Introduction</h1></div></div></div><p>This chapter contains recipes that did not fit in any other chapter, and yet were considered important by typical web2py users. An example is how to use web2py with Eclipse. The latter is a very popular Java IDE that works well with Python, but presents some quirks when used with web2py, and here, we show you how to overcome those quirks with proper configuration. Other examples are how to develop applications that are mobile-friendly, and how to develop standalone applications that use a<span class="strong"><strong> wxPython GUI</strong></span>.</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec02"/>Using PDB and the embedded web2py debugger</h1></div></div></div><p>web2py has interactive (web browser) debug capabilities built into the<span class="strong"><strong> admin</strong></span> application, similar to shell, but issuing commands directly to<span class="strong"><strong> PDB</strong></span>, which is the<span class="strong"><strong> Python Debugger</strong></span>.<a id="id330" class="indexterm"/>
</p><p>Although this is not a fully-featured visual debugger, it is useful to programmatically set up breakpoints, then step in and do variable and stack inspection, arbitrary code execution in the program context, instruction jump, and other operations.</p><p>The use of this debugger is optional, and it is intended for advanced users (it should be used with care, or you can block the web2py server). It is not imported, by default, and normal operation of web2py is not modified.</p><p>The implementation can be enhanced and extended to do other kinds of COMET-like communication (pushing data from server to client using AJAX), with general purpose long-running processes.<a id="id331" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec01"/>How to do it...</h2></div></div></div><p>PDB is the Python Debugger, included in the standard library.<a id="id332" class="indexterm"/>
</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>You can start the debugger by writing the following:</p><div class="informalexample"><pre class="programlisting">import pdb; pdb.set_trace()
</pre></div><p>For example, let's debug the welcome default index controller:
</p><div class="informalexample"><pre class="programlisting">
def index():
	import pdb; pdb.set_trace()
	message = T('Hello World')
	return dict(message=message)
</pre></div></li><li class="listitem"><p>Then, when you open the index page:<code class="literal"> http://127.0.0.1:8000/welcome/default/index</code>, the (PDB) prompt will appear in the console where you started web2py:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>
$ python web2py.py -a a
web2py Web Framework
Created by Massimo Di Pierro, Copyright 2007-2011
Version 1.99.0 (2011-09-15 19:47:18)
Database drivers available: SQLite3, pymysql, PostgreSQL
Starting hardcron...
please visit:
	http://127.0.0.1:8000
use "kill -SIGTERM 16614" to shutdown the web2py server
&gt; /home/reingart/web2py/applications/welcome/controllers/default.
py(20)index()
-&gt; message = T('Hello World')
(Pdb)</strong></span>
</pre></div></li><li class="listitem"><p>The debugger points out that we are stopped inside<code class="literal"> welcome/controllers/default.py</code> at<span class="emphasis"><em> line 20</em></span>. At this point, any<code class="literal"> Pdb</code> command can be issued. The most useful ones are as follows:<a id="id333" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<code class="literal">help:</code> This command prints the list of available commands<a id="id334" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">where:</code> This command prints the current stack trace<a id="id335" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">list [first[, last]]:</code> This command lists the source code (between the first and the last lines)<a id="id336" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">p expression:</code> This command evaluates the expression and prints the result<a id="id337" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">! statement:</code> This command executes a Python statement<a id="id338" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">step: step in:</code> This command executes the current line, entering functions<a id="id339" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">next: step next:</code> This command executes the current line, not entering functions<a id="id340" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">return: step return:</code> This command continues execution until the function exits<a id="id341" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">continue:</code> This command continues execution, and only stops at breakpoints<a id="id342" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">jump lineno:</code> This command changes the next line to be executed<a id="id343" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">break filename:lineno:</code> This command sets a breakpoint<a id="id344" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">quit:</code> This command quits from the debugger (aborts the current program)<a id="id345" class="indexterm"/>
</p><p>The commands can be issued just by typing the first letter; for example, look at the following example session:
</p></li></ul></div><pre class="programlisting"><span class="strong"><strong>(Pdb) n
&gt; /home/reingart/web2py/applications/welcome/controllers/default.py(21)index()
-&gt; return dict(message=message)
(Pdb) p message
&lt;lazyT 'Hello World'&gt;
(Pdb) !message="hello web2py recipe!"
(Pdb) w
&gt; /home/reingart/web2py/applications/welcome/controllers/default.py(21)index()
-&gt; return dict(message=message)
(Pdb) c</strong></span>
</pre></li><li class="listitem"><p>The commands were<code class="literal"> n</code> for next (execute the line),<code class="literal"> p</code> for a message to print the message variable,<code class="literal"> !message=</code> to change its value to<code class="literal"> hello web2py recipe!, w</code> to see the current stack trace, and<code class="literal"> continue</code> to exit the debugger.</p><p>The problem is that this technique cannot be used if you don't have direct access to a console (for example, if web2py is running inside apache, pdb will not work).
</p><p>If a console is not available, the embedded web2py debugger can be used. The only difference is that instead of calling pdb, there is gluon.debug with a customized PDB version that runs using a web2py interactive shell through the browser.
</p></li><li class="listitem"><p>In the previous example, replace<code class="literal"> pdb.set_trace()</code> with<code class="literal"> gluon.debug.stop_trace</code>, and add<code class="literal"> gluon.debug.stop_trace()</code> prior to the<code class="literal"> return</code> function to give back the control to web2py:</p><div class="informalexample"><pre class="programlisting">
def index():
	gluon.debug.set_trace()
	message = T('Hello World')
	gluon.debug.stop_trace()
	return dict(message=message)
</pre></div></li><li class="listitem"><p>Then, when you open the index page,<code class="literal"> http://127.0.0.1:8000/welcome/default/index</code>, the browser will block until you enter into the debug page (included in the administrative interface):<code class="literal"> http://127.0.0.1:8000/admin/debug</code>.</p></li><li class="listitem"><p>At the debug page, you can issue any PDB command listed before, and interact with your program as though you where in a local console.</p><p>The following image show the last session, but inside the web2py debugger this time:
</p></li></ol></div><div class="mediaobject"><img src="images/5467OS_11_44.jpg" alt="How to do it..."/></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec02"/>How it works...</h2></div></div></div><p>The web2py debugger defines a<code class="literal"> Pipe</code> class deriving from<code class="literal"> Queue.Queue</code> for inter-thread communication, used as a standard input and output of PDB to interact with the user.<a id="id346" class="indexterm"/>
</p><p>The online shell-like interface uses an<code class="literal"> ajax</code> callback to receive user commands, send them to the debugger, and print the results, as if the user were using PDB directly in a console.</p><p>When<code class="literal"> gluon.debug.set_trace()</code> is called (that is, in a controller of the debugged application), the custom web2py PDB instance is run, then the input and output is redirected and queued until the other threads open the queue and communicate with it (usually, the admin debug application is called from a separate browser window).</p><p>Meanwhile, into the debugging process, PDB does all the work, and web2py only redirects the input and the output messages.</p><p>When<code class="literal"> gluon.debug.stop_trace()</code> is called, the thread sends<code class="literal"> void</code> data (<code class="literal">None</code> value) to signal the monitor thread that debugging has finished.</p><p>As said in the introduction, this functionality is intended for intermediate and advanced users, as if<code class="literal"> stop_trace</code> is not called, or the debug controller is not refreshed, then the internal communication queue can block the web2py server (time-outs should be implemented to avoid deadlocks).</p><p>Pages being debugged will be blocked until the debug ends, the same as with using<code class="literal"> pdb</code> through the console. The debug controller will be blocked until the first breakpoint (<code class="literal">set_trace</code>) is reached.</p><p>For more details, see<code class="literal"> gluon/debug.py</code> and<code class="literal"> applications/admin/controllers/debug.py</code> inside the web2py source files.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec03"/>There's more...</h2></div></div></div><p>PDB is a fully featured debugger, supporting conditional breakpoints and advanced commands. The complete documentation can be found at the following URL:<a id="id347" class="indexterm"/>
</p><p>
<a class="ulink" href="http://docs.python.org/library/pdb.html">http://docs.python.org/library/pdb.html</a>
</p><p>PDB derives from the BDB module (Python Debugger framework), that can be used to extend this technique to add more features, implementing a lightweight remote debugger (it is a base debugger that doesn't need console interaction, so other user interfaces could be used).<a id="id348" class="indexterm"/>
</p><p>Also, the<code class="literal"> Pipe</code> class is an example of interacting with long running processes that can be useful in COMET-like scenarios, to push data from the server to the browser, without keeping a connection open (using standard web servers and AJAX).</p><p>Combining both techniques, a new debugger (QDB) was developed, enabling remote debugging of web2py applications (even in production environments). In the following paragraphs, an example use case will be shown. For more information see the following:</p><p>
<a class="ulink" href="http://code.google.com/p/rad2py/wiki/QdbRemotePythonDebugger">http://code.google.com/p/rad2py/wiki/QdbRemotePythonDebugger</a>
</p><p>To use qdb, you have to download<code class="literal"> qdb.py</code> (see the previous link), and put it on the<code class="literal"> gluon.contrib</code> directory (it will be included in further releases of web2py).</p><p>Then, in your controller, import it and call<code class="literal"> set_trace</code> to start debugging, as shown in the following example:</p><div class="informalexample"><pre class="programlisting">
def index():
	response.flash = T('Welcome to web2py')
	import gluon.contrib.qdb as qdb
	qdb.set_trace()
	return dict(message='Hello World')
</pre></div><p>When you open your controller and<code class="literal"> set_trace</code> is reached, qdb will listen for a remote connection to attach to and start the debugger interaction. You can start the debug session by executing the qdb module (python<code class="literal"> qdb.py)</code> as follows:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>C:\rad2py\ide2py&gt;python qdb.py
qdb debugger fronted: waiting for connection to ('localhost', 6000)
&gt; C:\web2py\applications\welcome\controllers/default.py(19)
-&gt; 	return dict(message=T('Hello World'))
(Cmd) p response.flash
Welcome to web2py!
&gt; C:\web2py\applications\welcome\controllers/default.py(19)
-&gt; 	return dict(message=T('Hello World'))
(Cmd) c</strong></span>
</pre></div><p>You can interact with the same commands as PDB ones, that is, step, print a value, continue, and so on.</p><p>Note that web2py (backend debugger) and qdb frontend debugger are different processes, so you can debug even a daemon webserver,such as Apache. Also, in the<code class="literal"> qdb.py</code> source, you can change the address/port and password to connect to remote servers over the Internet.</p><p>web2py will include qdb and a web user interface debugger in the 2.0 release (for the development environment).</p><p>For a full-featured IDE for web2py (for either development or production environments), including a visual debugger based in this recipe, see the following:</p><p>
<a class="ulink" href="http://code.google.com/p/rad2py">http://code.google.com/p/rad2py</a>
</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec03"/>Debugging with Eclipse and PyDev</h1></div></div></div><p>
<span class="strong"><strong>Eclipse</strong></span> is an open source, extensible development platform and application framework, designed for building, deploying, and managing software across its entire software lifecycle. It is very popular in the Java world.<span class="strong"><strong> PyDev</strong></span> is a Python extension for Eclipse, which allows the use of Eclipse as an IDE for Python, and therefore, for web2py. Here, we show you how to set up web2py to work well with these tools.<a id="id349" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec04"/>Getting ready</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Download the latest Eclipse IDE (<a class="ulink" href="http://www.eclipse.org/downloads/">http://www.eclipse.org/downloads/</a>), and extract it to a folder of your choice.<a id="id350" class="indexterm"/>
</p></li><li class="listitem"><p>Start Eclipse by running<code class="literal"> eclipse.exe</code> in the folder. Notice that there is no installation for Eclipse, but you must have the Java runtime (http://java.com/en) installed.<a id="id351" class="indexterm"/>
</p></li><li class="listitem"><p>Install PyDev by clicking on [Help<span class="strong"><strong> | Install New Software]</strong></span>, and entering the following URL, then clicking the<span class="strong"><strong> Add</strong></span> button:<a id="id352" class="indexterm"/>
</p><p><a class="ulink" href="http://pydev.org/updates">http://pydev.org/updates
</a>
</p></li><li class="listitem"><p>Select all of the options and hit<span class="strong"><strong> [next]</strong></span>.</p></li><li class="listitem"><p>It should prompt you to accept a license agreement. Continue through the wizard, and click<span class="strong"><strong> [No]</strong></span> when it asks you if you want to restart.</p></li><li class="listitem"><p>Install the correct mercurial version for your operating system:<a id="id353" class="indexterm"/>
</p><p><a class="ulink" href="http://mercurial.selenic.com%20">http://mercurial.selenic.com
</a>
</p></li><li class="listitem"><p>Go back to<span class="strong"><strong> Help | Install New Software</strong></span>, and enter the following URL:</p><p><a class="ulink" href="http://cbes.javaforge.com/update">http://cbes.javaforge.com/update
</a>
</p></li><li class="listitem"><p>Continue through the wizard, and click on<span class="strong"><strong> Yes</strong></span> when it asks you to restart this time.</p></li><li class="listitem"><p>Create a new project in Eclipse by going to<span class="strong"><strong> File | New | Project | Mercurial | Clone Mercurial Repository using Mercurial</strong></span>, and enter the following URL:</p><p><a class="ulink" href="http://code.google.com/p/web2py%20">http://code.google.com/p/web2py
</a>
</p></li><li class="listitem"><p>Enter<code class="literal"> web2py</code> in the<span class="strong"><strong> Clone Directory Name</strong></span> field.</p></li><li class="listitem"><p>Set the interpreter by going to<span class="strong"><strong> Window | Preferences | PyDev | Interpreter</strong></span>, and choosing the path to your Python binary:</p></li></ol></div><div class="mediaobject"><img src="images/5467OS_11_45.jpg" alt="Getting ready"/></div><p>That's it! You can start debugging by finding<code class="literal"> web2py.py</code> in the project tree, by right-clicking and selecting<span class="strong"><strong> Debug As | Python Run</strong></span>. You can also pass arguments to<code class="literal"> web2py.py</code> by choosing<span class="strong"><strong> Debug Configuration</strong></span> from the same menu.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec05"/>There's more...</h2></div></div></div><p>Instead of installing web2py from the mercurial repository, you can make PyDev point to an existing web2py installation (it must be a source installation and not a web2py binary). In this case, simply go to<span class="strong"><strong> File | New | PyDev</strong></span>, and specify the directory of your web2py installation:</p><div class="mediaobject"><img src="images/5467OS_11_46.jpg" alt="There's more..."/></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec04"/>Updating web2py using a shell script</h1></div></div></div><p>The web2py admin interface provides an<span class="strong"><strong> upgrade</strong></span> button, which downloads the latest web2py, and unzips it over the old one (it does not overwrite applications except welcome, admin, and examples). This is ok, but it presents some potential problems:<a id="id354" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The admin may be disabled</p></li><li class="listitem"><p>You may want to update many installations at once, and would rather do it programmatically</p></li><li class="listitem"><p>You may want to archive the previous version, in case you need reverting</p></li></ul></div><p>The script we provide in this recipe is only useful for solving these problems in Linux and on a Mac.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec06"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Move under the<code class="literal"> web2py</code> folder:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>cd /path/to/web2py</strong></span>
</pre></div></li><li class="listitem"><p>Make sure that you are the same user who owns the web2py folder, or you at least have the<code class="literal"> write</code> permission. Save the following script in a file (for example:<code class="literal"> update_web2py.sh)</code>, and make it executable:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>chmod +x update_web2py.sh</strong></span>
</pre></div></li><li class="listitem"><p>Then, run it:<a id="id355" class="indexterm"/>
</p></li></ol></div><div class="informalexample"><pre class="programlisting"><span class="strong"><strong># update-web2py.sh
# 2009-12-16
#
# install in web2py/.. or web2py/ or web2py/scripts as update-
# web2py.sh
# make executable: chmod +x web2py.sh
#
# save a snapshot of current web2py/ as web2py/../web2py-version.
# zip
# download the current stable version of web2py
# unzip downloaded version over web2py/

TARGET=web2py
if [ ! -d $TARGET ]; then
	# in case we're in web2py/
	if [ -f ../$TARGET/VERSION ]; then
		cd ..
	# in case we're in web2py/scripts
	elif [ -f ../../$TARGET/VERSION ]; then
		cd ../..
	fi
fi
read a VERSION c &lt; $TARGET/VERSION
SAVE=$TARGET-$VERSION
URL=http://www.web2py.com/examples/static/web2py_src.zip

ZIP=`basename $URL`
SAVED=""

#### Save a zip archive of the current version,
#### but don't overwrite a previous save of the same version.
###
if [ -f $SAVE.zip ]; then
	echo "Remove or rename $SAVE.zip first" &gt;&amp;2
	exit 1
fi
if [ -d $TARGET ]; then
	echo -n "&gt;&gt;Save old version: " &gt;&amp;2
	cat $TARGET/VERSION &gt;&amp;2
	zip -q -r $SAVE.zip $TARGET
	SAVED=$SAVE.zip
fi
###
#### Download the new version.
###
echo "&gt;&gt;Download latest web2py release:" &gt;&amp;2
curl -O $URL
###
#### Unzip into web2py/
###
unzip -q -o $ZIP
rm $ZIP
echo -n "&gt;&gt;New version: " &gt;&amp;2
cat $TARGET/VERSION &gt;&amp;2
if [ "$SAVED" != "" ]; then
	echo "&gt;&gt;Old version saved as $SAVED"
fi</strong></span>
<a id="id356" class="indexterm"/>
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec07"/>There's more...</h2></div></div></div><p>Yes, there is more. When upgrading web2py, the welcome application is upgraded, and it might contain a new appadmin, a new layout, and new JavaScript libraries. You may want to upgrade your applications as well. You can do this manually, and you have to be careful, because depending on how your applications work, this may break them. For an application called<code class="literal"> app</code>, you can upgrade appadmin with the following:</p><div class="informalexample"><pre class="programlisting">cp applications/welcome/controllers/appadmin.py applications/app/\
controllers
cp applications/welcome/views/appadmin.py applications/app/views
</pre></div><p>You can upgrade generic views with the following:<a id="id357" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>cp applications/welcome/views/generic.* applications/app/views</strong></span>
</pre></div><p>You can upgrade web2py_ajax with the following:<a id="id358" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>cp applications/welcome/views/web2py_ajax.html applications/app/views
cp applications/welcome/static/js/web2py_ajax.js applications/app/
static/\js</strong></span>
</pre></div><p>And finally, you can upgrade all static files with the following:<a id="id359" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>cp -r applications/welcome/static/* applications/app/static/</strong></span>
</pre></div><p>You may have to be more selective. Back up first and be careful.</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec05"/>Creating a simple page statistics plugin</h1></div></div></div><p>In this recipe, we will show you how to create a plugin to display page statistics in a hierarchical format.<a id="id360" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec08"/>How to do it...</h2></div></div></div><p>First of all, create a file called<code class="literal"> models/plugin_stats.py</code>, which contains the following code:</p><div class="informalexample"><pre class="programlisting">
#!/usr/bin/env python
# -*- coding: utf-8 -*-

def _(db, 							# reference to DAL obj. page_key, # string to id page
	page_subkey='', 			# string to is subpages
	initial_hits=0, 			# hits initial value
	tablename="plugin_stats"	# table where to store data
	):	
	from gluon.storage import Storage
	table = db.define_table(tablename,
	Field('page_key'),
		Field('page_subkey'),
		Field('hits', 'integer'))
	record = table(page_key=page_key,page_subkey=page_subkey)
	
	if record:
		new_hits = record.hits + 1
		record.update_record(hits=new_hits)
		hits = new_hits
		
	else:
		table.insert(page_key=page_key,
			page_subkey=page_subkey,
			hits=initial_hits)
		hits = initial_hits
		
	hs = table.hits.sum()
	total = db(table.page_key==page_key).select(hs).first()(hs)
	widget = SPAN('Hits:',hits,'/',total)
	return Storage(dict(hits=hits,total=total,widget=widget))
	
plugin_stats = _(db,
	page_key=request.env.path_info,
	page_subkey=request.query_string)
</pre></div><p>If you want to get the results displayed to the visitor, add the following to<code class="literal"> views/layout.html:</code>
</p><div class="informalexample"><pre class="programlisting">{{=plugin_stats.widget}}
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec09"/>How it works...</h2></div></div></div><p>The<code class="literal"> plugin</code> file is a model file, and is executed at every request. It calls the following query, which defines a table to store hits, and each record is identified by a<code class="literal"> page_key (request.env.path_info)</code> and a<code class="literal"> page_subkey (request.query_string)</code>.<a id="id361" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
plugin_stats = _(db,
	page_key=request.env.path_info,
	page_subkey=request.query_string)
</pre></div><p>If a record with this key and subkey does not exist, it is created. If it exists, it is retrieved, and the field<code class="literal"> hits</code> is incremented by one. The function<code class="literal"> _</code> has a weird name, but there is nothing special about it. You can choose a different name; we just do not wish to pollute the namespace, as the function is needed only once. The function returns a<code class="literal"> Storage</code> object assigned to<code class="literal"> plugin_stats</code>, which contains the following:<a id="id362" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<code class="literal">hits:</code> This is the number of hits corresponding to the current<code class="literal"> page_key</code> and<code class="literal"> page_subkey</code>
<a id="id363" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">total:</code> This is the sum of the hits for the same<code class="literal"> page_key</code> as the current page but different subkeys<a id="id364" class="indexterm"/>
</p></li><li class="listitem"><p>
<code class="literal">widget:</code> This is a span displaying the hits, and<code class="literal"> total</code>, which can be embedded in views<a id="id365" class="indexterm"/>
</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec10"/>There's more...</h2></div></div></div><p>Notice that you can decide to change the following lines into something else, and use different variables to group pages for counting purposes:</p><div class="informalexample"><pre class="programlisting">page_key=request.env.path_info
page_subkey=request.query_string
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec06"/>Rounding corners without images or JavaScript</h1></div></div></div><p>Modern browsers support CSS directives for rounding corners. They include the following:<a id="id366" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>WebKit (Safari, Chrome)<a id="id367" class="indexterm"/>
</p></li><li class="listitem"><p>Gecko (Firefox)<a id="id368" class="indexterm"/>
</p></li><li class="listitem"><p>Opera (with a major hack)<a id="id369" class="indexterm"/>
</p></li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec11"/>Getting ready</h2></div></div></div><p>We assume that you have a view containing the following HTML code, and you want to round the corner of the<code class="literal"> box</code> class:</p><div class="informalexample"><pre class="programlisting">
&lt;div class="box"&gt;
	test
&lt;/div&gt;
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec12"/>How to do it...</h2></div></div></div><p>In order to see the effect, we also need to change the background color. In the<code class="literal"> style</code> file, for example, add the following code for the default layout in<code class="literal"> static/styles/base.css:</code>
<a id="id370" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
.box {
	-moz-border-radius: 5px; 	/* for Firefox */
	-webkit-border-radius: 5px; /* for Safari and Chrome */
	background-color: yellow;
}
</pre></div><p>The first line<code class="literal"> -moz-border-radius: 5px</code>; is interpreted only by Firefox, and ignored by other browsers. The second line is interpreted only by Safari and Chrome.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec13"/>There's more...</h2></div></div></div><p>What about Opera? Opera does not have a CSS directive for rounded corners, but you can modify the previous CSS as follows, and have web2py generate a dynamic image to use as the background with the requested color and rounded corners:<a id="id371" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
.box {
	-moz-border-radius: 5px; 	/* for Firefox */
	-webkit-border-radius: 5px; /* for Safari and Chrome */
	background-color: yellow;
	background-image: url("../images/border_radius?r=4&amp;fg=249,249,249&amp;
bg=235,232,230"); /*
	for opera */
}
</pre></div><p>To this purpose, create a<code class="literal"> controllers/images.py</code> file, and add the following code to it:<a id="id372" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
def border_radius():
	import re
	radius = int(request.vars.r or 5)
	color = request.vars.fg or 'rbg(249,249,249)'
	if re.match('\d{3},\d{3},\d{3}',color):
		color = 'rgb(%s)' % color
		bg = request.vars.bg or 'rgb(235,232,230)'
	if re.match('\d{3},\d{3},\d{3}',bg):
		bg = 'rgb(%s)'%bg
	import gluon.contenttype
	response.headers['Content-Type']= 'image/svg+xml;charset=utf-8'
	return '''&lt;?xml version="1.0" ?&gt;&lt;svg
		&gt;&lt;rect fill="%s" x="0" y="0"
		width="100%%" height="100%%" /&gt;&lt;rect ill="%s" x="0" y="0"
		width="100%%" height="100%%" rx="%spx"
		/&gt;&lt;/svg&gt;'''%(bg,color,radius)
</pre></div><p>This code will generate an SVG image, dynamically.</p><p>Reference:<a class="ulink" href="http://home.e-tjenesten.org/~ato/2009/08/border-radius-opera"> http://home.e-tjenesten.org/~ato/2009/08/border-radius-opera</a>.</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec07"/>Setting a cache.disk quota</h1></div></div></div><p>This recipe is about web2py using RAM memory for<span class="strong"><strong> disk caching</strong></span> on Linux (with<code class="literal"> tmpfs)</code>.</p><p>
<code class="literal">cache.disk</code> is a popular caching mechanism that allows multiple web2py installations that share a file system to share cache. It is not as efficient as<code class="literal"> memcache</code>, as writing on a shared file system can be a bottleneck; nevertheless this is an option for some users. If you are using<code class="literal"> cache.disk</code>, you may want to limit the amount of data that gets written to cache by setting a<span class="strong"><strong> quota</strong></span>. This can be achieved by creating a temporary memory-mapped file system with the added benefit of improving performances.<a id="id373" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec14"/>How to do it...</h2></div></div></div><p>The main idea is to use<code class="literal"> cache.disk</code> with<code class="literal"> tmpfs</code>.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>First of all, you need to log in as<code class="literal"> root</code> and execute the following command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mount -t tmpfs tmpfs $folder_path -o rw,size=$size</strong></span>
</pre></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Here:
</p><p><code class="literal">$folder_path</code> is a path to the folder where you mount your slice of RAM
</p><p><code class="literal">$size</code> is the amount of memory you want to dedicate (<code class="literal">M</code> - megabytes)
</p><p>For example:
</p></li></ul></div><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>mkdir /var/tmp/myquery
mount -t tmpfs tmpfs /var/tmp/myquery -o rw,size=200M</strong></span>
</pre></div></li><li class="listitem"><p>You have just allocated 200 MB of your RAM. Now we have to map it in a web2py application. Just write the following in your models:</p><div class="informalexample"><pre class="programlisting">
from gluon.cache import CacheOnDisk
cache.disk = CacheOnDisk(request,
	folder='/the/memory/mapped/folder')
</pre></div><p>So, in our case:
</p><div class="informalexample"><pre class="programlisting">cache.disk = CacheOnDisk(request, folder='/var/tmp/myquery')
</pre></div></li><li class="listitem"><p>Now, when you use:</p><div class="informalexample"><pre class="programlisting">db(...).select(cache=(cache.disk,3600)....)
</pre></div><p>Or the following:
</p><div class="informalexample"><pre class="programlisting">
@cache(request.env.path_info, time_expire=5, cache_model=cache.
disk)
def cache_controller_on_disk():
	import time
	t = time.ctime()
	return dict(time=t, link=A('click to reload',
		_href=request.url))
</pre></div><p>You have have ram space quota for every query/controller/etc cached, and each one can have a different size setting.
</p></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec08"/>Checking if web2py is running using cron</h1></div></div></div><p>If you are on a UNIX machine, you may want to monitor whether web2py is running. A production quality solution to this problem is using<span class="strong"><strong> Monit:</strong></span>
<a class="ulink" href="http://mmonit.com/monit/documentation/">http://mmonit.com/monit/documentation/</a>.
<a id="id374" class="indexterm"/>
</p><p>It can monitor your processes, log problems, and also restart them for you automatically. Here we present a do-it-yourself simpler solution, in the minimalist web2py spirit.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec15"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>We will create the file,<code class="literal"> /root/bin/web2pytest.sh</code>, to check if web2py runs, and start web2py if it is not running.</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>#! /bin/bash
# written by Ivo Maintz
export myusername=mdipierro
export port=8000
export web2py_path=/home/mdipierro/web2py
if ! ` netcat -z localhost $port `
	then pgrep -flu $myusername web2py | cut -d -f1 | xargs kill &gt;
/\
dev/null 2&gt;&amp;1
	chown $myusername: /var/log/web2py.log
	su $myusername -c 'cd $web2py_path &amp;&amp; ./web2py.py -p $port -a
\
password 2&gt;&amp;1 &gt;&gt; /var/log/web2py.log'
	sleep 3
	if ` netcat -z localhost $port `
		then echo "web2py was restarted"
		else echo "web2py could not be started!"
	fi
fi</strong></span>
</pre></div></li><li class="listitem"><p>Now edit the<code class="literal"> crontab</code> using the<code class="literal"> shell</code> command:</p><div class="informalexample"><pre class="programlisting">crontab -e
</pre></div></li><li class="listitem"><p>Add a<code class="literal"> crontab</code> line that instructs the<code class="literal"> crontab</code> deamon to run our script every three minutes:<a id="id375" class="indexterm"/>
</p></li></ol></div><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>*/3 * * * * /root/bin/web2pytest.sh &gt; /dev/null</strong></span>
</pre></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Notice that you may have to edit the first few lines of the script to set the right username, port, and web2py path that you want to monitor/restart.
</p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec09"/>Building a Mercurial plugin</h1></div></div></div><p>web2py's admin supports<span class="strong"><strong> Mercurial</strong></span> for versioning, but can one pull and push changes through HTTP?<a id="id376" class="indexterm"/>
</p><p>In this recipe, we present a plugin for web2py that consists of a single file. It wraps Mercurial's<code class="literal"> hgwebdir wsgi</code> application, and allows one to interact with the mercurial repository of the web2py application either from a web browser or the<code class="literal"> hg</code> client.</p><p>This is interesting for the following two reasons:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>On one side, if you use mercurial to version control your application, this plugin allows you to share the repository online with other people.</p></li><li class="listitem"><p>On the other side, this is a great example of how to call a third party WSGI application from web2py.</p></li></ol></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec16"/>Getting ready</h2></div></div></div><p>This requires that you run web2py from source, and you have mercurial installed. You can install mercurial using the following command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>easy_install mercurial</strong></span>
</pre></div><p>This plugin will only work on Python distributions that have mercurial installed. You could package mercurial into the web2py application itself, but we do not recommend it. It makes very little sense to use this plugin if you are not a regular mercurial user.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec17"/>How to do it...</h2></div></div></div><p>All you need to do to create the plugin is create a new controller, "plugin_mercurial.py":<a id="id377" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
""" plugin_mercurial.py
	Author: 	Hans Christian v. Stockhausen &lt;hc at vst.io&gt;
	Date: 		2010-12-09
"""

from mercurial import hgweb

def index():
	""" Controller to wrap hgweb
		You can access this endpoint either from a browser in which case
			the hgweb interface is displayed or from the mercurial client.
			
		hg clone http://localhost:8000/app/plugin_mercurial/index app
	"""
	
	# HACK - hgweb expects the wsgi version to be reported in a tuple
	wsgi_version = request.wsgi.environ['wsgi.version']
	request.wsgi.environ['wsgi.version'] = (wsgi_version, 0)
	
	# map this controller's URL to the repository location and #instantiate app
	config = {URL():'applications/'+request.application}
	wsgi_app = hgweb.hgwebdir(config)
	
	# invoke wsgi app and return results via web2py API
	# http://web2py.com/book/default/chapter/04#WSGI
	items = wsgi_app(request.wsgi.environ, request.wsgi.start_response)
	for item in items:
		response.write(item, escape=False)
	return response.body.getvalue()
</pre></div><p>Here is a view of a sample report from the shell:</p><div class="mediaobject"><img src="images/5467OS_11_47.jpg" alt="How to do it..."/></div><p>Here is a view from the<code class="literal"> plugin_above:</code>
<a id="id378" class="indexterm"/>
</p><div class="mediaobject"><img src="images/5467OS_11_48.jpg" alt="How to do it..."/></div><p>You can also push to the repository. To be able to push to the repository, you need to edit/create the file<code class="literal"> application/&lt;app&gt;/.hg/hgrc</code>, and add the following entries for example:<a id="id379" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>[web]
allow_push = *
push_ssl = False</strong></span>
</pre></div><p>Clearly, this is recommended for a trusted environment only. Also, see the<code class="literal"> hgrc</code> documentation at<a class="ulink" href="http://www.selenic.com/mercurial/hgrc.5.html#web"> http://www.selenic.com/mercurial/hgrc.5.html#web</a>.</p><p>The<code class="literal"> hgwebdir</code> WSGI application can expose multiple repositories, although for a web2py application-specific plugin, this is probably not what you want. If you do, however, want just that, try tweaking the<code class="literal"> config</code> variable that is passed to the<code class="literal"> hgwebdir</code> constructor. For example, you could pass the name of the repository to access through<code class="literal"> request.args[0]</code>. URLs are even longer then, so you might want to set up some rules in<code class="literal"> routes.py</code>.</p><div class="informalexample"><pre class="programlisting">
config = {
	'app/plugin_mercurial/index/repo1':'path/to/repo1',
	'app/plugin_mercurial/index/repo2':'path/to/repo2',
	'app/plugin_mercurial/index/repo3':'path/to/repo3'
}
<a id="id380" class="indexterm"/>
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec10"/>Building a pingback plugin</h1></div></div></div><p>Pingbacks allow blog posts and other resources, such as photos, to automatically notify one another of backlinks. This plugin exposes a decorator to pingback-enable controller functions, and a pingback client to inform a<span class="strong"><strong> Wordpress</strong></span> blog, for example, that we link to it.<a id="id381" class="indexterm"/>
</p><p>
<span class="strong"><strong>Pingback</strong></span> is a standard protocol, and version 1.0 is described at the following URL:</p><p>
<a class="ulink" href="http://www.hixie.ch/specs/pingback/pingback">http://www.hixie.ch/specs/pingback/pingback</a>
</p><p>
<code class="literal">plugin_pingback</code> consists of one single module file.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec18"/>How to do it...</h2></div></div></div><p>First of all, create a<code class="literal"> module/plugin_pingback.py</code> file, with the following code:</p><div class="informalexample"><pre class="programlisting">
#!/usr/bin/env python
# coding: utf8
#
# Author: 	Hans Christian v. Stockhausen &lt;hc at vst.io&gt;
# Date: 	2010-12-19
# License: 	MIT
#
# TODO
# - Check entity expansion requirements (e.g. &amp;lt;) as per Pingback # spec page 7
# - make try-except-finally in PingbackClient.ping robust

import httplib
import logging
import urllib2
import xmlrpclib
from gluon.html import URL

__author__ = 'H.C. v. Stockhausen &lt;hc at vst.io&gt;'
__version__ = '0.1.1'

from gluon import *

# we2py specific constants
TABLE_PINGBACKS = 'plugin_pingback_pingbacks'

# Pingback protocol faults
FAULT_GENERIC = 0
FAULT_UNKNOWN_SOURCE = 16
FAULT_NO_BACKLINK = 17
FAULT_UNKNOWN_TARGET = 32
FAULT_INVALID_TARGET = 33
FAULT_ALREADY_REGISTERED = 48
FAULT_ACCESS_DENIED = 49
FAULT_UPSTREAM_ERROR = 50

def define_table_if_not_done(db):
	if not TABLE_PINGBACKS in db.tables:
		db.define_table(TABLE_PINGBACKS,
			Field('source', notnull=True),
			Field('target', notnull=True),
			Field('direction', notnull=True,
				requires=IS_IN_SET(('inbound', 'outbound'))),
			Field('status'), # only relevant for outbound pingbacks
		  Field('datetime', 'datetime', default=current.request.now))
class PingbackServerError(Exception):
	pass
	
class PingbackClientError(Exception):
	pass
	
class PingbackServer(object):
	" Handles incomming pingbacks from other sites. "
	
def __init__(self, db, request, callback=None):
	self.db = db
	self.request = request
	self.callback = callback
	define_table_if_not_done(db)
	
def __call__(self):
	"""
		Invoked instead of the decorated function if the request is a
			pingback request from some external site.
	"""
	
	try:
		self._process_request()
	except PingbackServerError, e:
		resp = str(e.message)
	else:
		resp = 'Pingback registered'
	return xmlrpclib.dumps((resp,))
	
def _process_request(self):
	" Decode xmlrpc pingback request and process it "
	
	(self.source, self.target), method = xmlrpclib.loads(
		self.request.body.read())
		
	if method != 'pingback.ping':
		raise PingbackServerError(FAULT_GENERIC)
		self._check_duplicates()
		self._check_target()
		self._check_source()
		
	if self.callback:
		self.callback(self.source, self.target, self.html)
		self._store_pingback()
		
def _check_duplicates(self):
	" Check db whether the pingback request was previously processed "
	db = self.db
	table = db[TABLE_PINGBACKS]
	query = (table.source==self.source) &amp; (table.target==self.target)
	if db(query).select():
		raise PingbackServerError(FAULT_ALREADY_REGISTERED)
			
def _check_target(self):
	" Check that the target URI exists and supports pingbacks "
	
	try:
		page = urllib2.urlopen(self.target)
	except:
		raise PingbackServerError(FAULT_UNKNOWN_TARGET)
	if not page.info().has_key('X-Pingback'):
		raise PingbackServerError(FAULT_INVALID_TARGET)
		
def _check_source(self):
	" Check that the source URI exists and contains the target link "
	
	try:
		page = urllib2.urlopen(self.source)
		
	except:
		raise PingbackServerError(FAULT_UNKNOWN_SOURCE)
		html = self.html = page.read()
		target = self.target
		
	try:
		import BeautifulSoup2
		soup = BeautifulSoup.BeautifulSoup(html)
		exists = any([a.get('href')==target for a in soup.findAll('a')])
		
	except ImportError:
		import re
		logging.warn('plugin_pingback: Could not import BeautifulSoup,' \
			' using re instead (higher risk of pingback spam).')
		pattern = r'&lt;a.+href=[\'"]?%s[\'"]?.*&gt;' % target
		exists = re.search(pattern, html) != None
		
	if not exists:
		raise PingbackServerError(FAULT_NO_BACKLINK)
		
def _store_pingback(self):
	" Companion method for _check_duplicates to suppress duplicates. "
	
	self.db[TABLE_PINGBACKS].insert(
		source=self.source,
		target=self.target,
		direction='inbound')
		
class PingbackClient(object):
	" Notifies other sites about backlinks. "
	
	def __init__(self, db, source, targets, commit):
		self.db = db
		self.source = source
		self.targets = targets
		self.commit = commit
		define_table_if_not_done(db)
		
	def ping(self):
		status = 'FIXME'
		db = self.db
		session = current.session
		response = current.response
		table = db[TABLE_PINGBACKS]
		targets = self.targets
		
		if isinstance(targets, str):
			targets = [targets]
			
		for target in targets:
			query = (table.source==self.source) &amp; (table.target==target)
			
		if not db(query).select(): # check for duplicates
			id_ = table.insert(
			source=self.source,
			target=target,
			direction='outbound')
			
		if self.commit:
			db.commit()
			
		try:
			server_url = self._get_pingback_server(target)
			
		except PingbackClientError, e:
			status = e.message
			
	else:
		try:
			session.forget()
			session._unlock(response)
			server = xmlrpclib.ServerProxy(server_url)
			status = server.pingback.ping(self.source, target)

		except xmlrpclib.Fault, e:
			status = e
			
		finally:
			db(table.id==id_).update(status=status)
			
def _get_pingback_server(self, target):
	" Try to find the target's pingback xmlrpc server address "
	
	# first try to find the pingback server in the HTTP header
	try:
		host, path = urllib2.splithost(urllib2.splittype(target)[1])
		conn = httplib.HTTPConnection(host)
		conn.request('HEAD', path)
		res = conn.getresponse()
		server = dict(res.getheaders()).get('x-pingback')
		
	except Exception, e:
		raise PingbackClientError(e.message)
		# next try the header with urllib in case of redirects

	if not server:
		page = urllib2.urlopen(target)
		server = page.info().get('X-Pingback')
		
	# next search page body for link element

	if not server:
		import re
		html = page.read()
		# pattern as per Pingback 1.0 specification, page 7
		pattern = r'&lt;link rel="pingback" href=(P&lt;url&gt;[^"])" ?/?&gt;'
		match = re.search(pattern, html)
		
		if match:
			server = match.groupdict()['url']
		
		if not server:
			raise PingbackClientError('No pingback server found.')
		return server
		
def listen(db, callback=None):
	"""
		Decorator for page controller functions that want to support
			pingbacks.
		The optional callback parameter is a function with the following
			signature.
		callback(source_uri, target_uri, source_html)
	"""
	
	request = current.request
	response = current.response
	
def pingback_request_decorator(_):
	return PingbackServer(db, request, callback)
	
def standard_request_decorator(controller):
	def wrapper():
		" Add X-Pingback HTTP Header to decorated function's response "
		
		url_base = '%(wsgi_url_scheme)s://%(http_host)s' % request.env
		url_path = URL(args=['x-pingback'])
		response.headers['X-Pingback'] = url_base + url_path
		return controller()
	return wrapper
	
	if request.args(0) in ('x-pingback', 'x_pingback'):
		return pingback_request_decorator
		
	else:
		return standard_request_decorator
		
def ping(db, source, targets, commit=True):
	" Notify other sites of backlink "
	
	client = PingbackClient(db, source, targets, commit)
	client.ping()
</pre></div><p>And here is how to use it:<a id="id382" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Import the module</p></li><li class="listitem"><p>Decorate actions that should receive pingbacks with<code class="literal"> listen</code>
</p></li><li class="listitem"><p>Modify actions that should send pingbacks with<code class="literal"> ping</code>
</p></li></ul></div><p>Here is a concrete example, where we assume a simple<code class="literal"> blog</code> system:<a id="id383" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
import plugin_pingback as pingback

def on_pingback(source_url, target_url, source_html):
	import logging
	logging.info('Got a pingback')
	# ...
	
@pingback.listen(db,on_pingback)
def viewpost():
	" Show post and comments "
	# ...
	return locals()
	
def addpost():
	" Admin function to add new post "
	pingback.ping(globals(),
	source=new_post_url,
	targets=[linked_to_post_url_A, linked_to_post_url_B]
)
# ...
return locals()
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec19"/>How it works...</h2></div></div></div><p>The<code class="literal"> plugin_pingback.py</code> module provides the core functionality of the<code class="literal"> plugin_pingback</code> plugin.<a id="id384" class="indexterm"/>
</p><p>The class<code class="literal"> PingbackServer</code> handles the incoming pingbacks. The class<code class="literal"> PingbackClient</code> is used to notify external sites of the backlinks. In your code, you should not have to use these classes directly. Instead, use the module functions<code class="literal"> listen</code> and<code class="literal"> ping</code>.<a id="id385" class="indexterm"/>
</p><p>
<code class="literal">listen</code> is a decorator to be used with controller functions you want to pingback-enable. Under the hood, it uses the<code class="literal"> PingbackServer</code>. This decorator accepts the<code class="literal"> db</code> as its first parameter, and optionally a second<code class="literal"> callback</code> parameter. The<code class="literal"> callback</code> signature is the function name (source,<code class="literal"> target</code>, or<code class="literal"> html)</code>, where<code class="literal"> source</code> is the ping- back source URI,<code class="literal"> target</code> is the target URI, and<code class="literal"> html</code> is the source page content.<a id="id386" class="indexterm"/>
</p><p>
<code class="literal">ping</code> is used to notify external sites of backlinks using the<code class="literal"> PingbackClient</code>.<a id="id387" class="indexterm"/>
</p><p>The first parameter is, as for<code class="literal"> listen</code>, the<code class="literal"> db</code> object, the second is the source page URI, the third is either a string or a list of target URIs, and finally there is the<code class="literal"> commit</code> parameter (defaults to<code class="literal"> True)</code>. A<code class="literal"> DB commit</code> is likely to be required at this point, as the controller function containing the ping is probably generating the source page. If the source page is not committed, the pingback system of the target page will not be able to find it, and thus rejects the pingback request.<a id="id388" class="indexterm"/>
</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec11"/>Changing views for mobile browsers</h1></div></div></div><p>If your web application is accessed from a mobile device, such as a phone, then most likely, the visitor is using a small screen and limited bandwidth to access your website. You may want to detect this, and serve a light version of your pages. What<span class="strong"><strong> light</strong></span> means depends on the context, but here we assume that you simply want to change the default layout for these visitors.<a id="id389" class="indexterm"/>
</p><p>web2py provides two APIs that allow you to do this.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>You can detect when a client is using a mobile device:</p><div class="informalexample"><pre class="programlisting">if request.user_agent().is_mobile: ...
</pre></div></li><li class="listitem"><p>You can ask web2py to replace the default view<code class="literal"> *.html</code> with<code class="literal"> *.mobile.html</code>, for any action using the<code class="literal"> @mobilize</code> decorator.</p><div class="informalexample"><pre class="programlisting">
from gluon.contrib.user_agent_parser import mobilize
@mobilize
def index():
	return dict()
</pre></div></li></ul></div><p>In this recipe, we will show you how to do this manually, using third-party libraries:<code class="literal"> mobile.sniffer</code> and<code class="literal"> mywurlf</code>, instead of using the built-in web2py APIs.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec20"/>Getting ready</h2></div></div></div><p>This slice uses the libraries<code class="literal"> mobile.sniffer</code> and<code class="literal"> pywurfl</code> to parse the<code class="literal"> USER_AGENT</code> header from the HTTP request. We will create a single function that returns<code class="literal"> True/False</code>.</p><p>You can install both of them with the following commands:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>easy_install mobile.sniffer
easy_install pywurfl</strong></span>
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec21"/>How to do it...</h2></div></div></div><p>We will create our function so that, for example, if we have this request,<a class="ulink" href="http://example.com/app/controller/function">http://example.com/app/controller/function</a>, the regular view will be in<code class="literal"> views/controller/function.html</code>, while the mobile view will be in<code class="literal"> views/controller/function.mobile.html</code>. And if it does not exist, it will revert to the regular one.<a id="id390" class="indexterm"/>
</p><p>This can be achieved through the following function, which you can place in any model file, for example<code class="literal"> models/plugin_detect_mobile.py</code>.</p><div class="informalexample"><pre class="programlisting">
# coding: utf8
import os

def plugin_detect_mobile(switch_view=True):
	from mobile.sniffer.detect import detect_mobile_browser
	if detect_mobile_browser(request.env.http_user_agent):
		if switch_view:
			view = '%(controller)s/%(function)s.mobile.%(extension)s' %
				request
		if os.path.exists(os.path.join(request.folder, 'views',view)):
			response.view = view
		return True
	return False
plugin_detect_mobile()
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec12"/>Background processing with a database queue</h1></div></div></div><p>Let's consider a very typical application that requires users to register. After a user submits the registration form, the application sends out a confirmation e-mail, asking the user to verify the sign-up process. The problem, however, is that the user does not get an immediate response to the next page, since they have to wait for the application to connect to the SMTP mail server, send the message, save some database results, and then finally, return the next view. Another pathological case could be argued; let's say this same application provides a dashboard that allows the user to download PDF reports, or data in an OpenOffice<code class="literal"> Calc</code> format. For the sake of argument, this process usually takes five to ten minutes to generate the PDF or spreadsheet. Obviously, it does not make sense for a user to wait on the server to process this data, since they would not be able to perform any other actions.<a id="id391" class="indexterm"/>
</p><p>Instead of actually performing these actions that may take a while to run, the application can just register a request in the database to perform the said action. A background process executed by<code class="literal"> cron</code> could read these requests, and then proceed to process them.</p><p>For the user registration, just provide a database table called<code class="literal"> emails_to_send</code>; this will cause a background process that would run every minute, and send all of the e-mails in a single session. The user doing the registration benefits from a speedier sign-up, and our application benefits by needing to only make a single SMTP connection for multiple e-mails.</p><p>For report generation, the user could submit a request for the file in question. They might visit a download page on the application, which shows processing for files that have been requested. Again, a background process could load all report requests, process them into output files, and then save the results to the database. The user would re-visit the download page, and be able to download the processed file. The user could continue performing other tasks, while waiting for the report to finish.<a id="id392" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec22"/>How to do it...</h2></div></div></div><p>For this example, we will use the user report requests. This will be a dentistry website, where clients information is stored. The office clerk would like to know the demographic breakdown of their clients by zip code, to help determine where would be the best place to send out their new advertising campaign. Lets just assume this is a very large dentist's office that has over 100,000 clients. This report could take a while.</p><p>For this, we will need the following tables:</p><div class="informalexample"><pre class="programlisting">
db.define_table('clients',
	Field('name'),
	Field('zipcode'),
	Field('address'))
	
db.define_table('reports',
	Field('report_type'),
	Field('report_file_loc'),
	Field('status'),
	Field('submitted_on', 'datetime', default=request.now),
	Field('completed_on', 'datetime', default=None))
</pre></div><p>When a user navigates to the<code class="literal"> reports</code> page, they are presented with options for possible reports that could be downloaded. The following is an example of a controller function for a report request:</p><div class="informalexample"><pre class="programlisting">
def request_report():
	report_type = request.vars.report_type
	
# make sure its a valid report
if report_type not in ['zipcode_breakdown', 'name_breakdown']:
	raise HTTP(404)
	
# add the request to the database to process
report_id = db.reports.insert(report_type=report_type,
	status='pending')
	
# return something to uniquely identify this report in case
# this request was made from Ajax.
return dict(report_id=report_id)
</pre></div><p>Now for the script that would process all report requests.<a id="id393" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
def process_reports():
	from collections import defaultdict
	reports_to_process = db(db.reports.status == 'pending').select()
	
	# set selected reports to processing so they do not get picked up
	# a second time if the cron process happens to execute again while
	# this one is still executing.
	for report in reports_to_process:
		report.update_record(status='processing')
		
	db.commit()
	
	for report in reports_to_process:
		if report.report_type == 'zipcode_breakdown':
			# get all zipcodes
			zipcodes = db(db.clients.zipcode != None).select()
			
		# if the key does not exist, create it with a value of 0
		zipcode_counts = defaultdict(int)
		
	for zip in zipcodes:
		zipcode_counts[zip] += 1
		
		# black box function left up to the developer to implement
		# just assume it returns the filename of the report it created.
		filename = make_pdf_report(zipcode_counts)
		
		report.update_record(status='done',
			completed_on=datetime.datetime.now(),
			report_file_loc=filename)
		# commit record so it reflects into the database immediately.
	db.commit()
process_reports()
</pre></div><p>Now that we have the code to generate reports, it needs a way to execute. Let's add the call to this function to the<code class="literal"> web2py cron/crontab</code> file.</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>* * * * * root *applications/dentist_app/cron/process_reports.py</strong></span>
</pre></div><p>Now, when the user requests the page, they will either see that the report is processing, or a link to download the generated report.<a id="id394" class="indexterm"/>
</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec23"/>There's more...</h2></div></div></div><p>In this recipe, we used a<code class="literal"> Poor-Man's Queue</code> example of dispatching tasks to the background processes. This method will scale up to a certain amount of users, however, at some point, an external message queue could be used to speed things up even more.</p><p>Since version 1.99.1, web2py includes its own built-in scheduler and scheduling API. It is documented in the latest edition of the official web2py manual, but you can also read more of it at the following link:</p><p>
<a class="ulink" href="http://www.web2py.com/examples/static/epydoc/web2py.gluon.scheduler-module.html">http://www.web2py.com/examples/static/epydoc/web2py.gluon.scheduler-module.html</a>
</p><p>There is a plugin that integrated celery into web2py:</p><p>
<a class="ulink" href="http://code.google.com/p/web2py-celery/">http://code.google.com/p/web2py-celery/</a>
</p><p>The former uses database access to distribute tasks, and the latter uses<span class="strong"><strong> RabbitMQ</strong></span> through celery to implement enterprise message queue servers.</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec13"/>How to effectively use template blocks</h1></div></div></div><p>As you may already know, the web2py template system is very flexible, providing template inheritance, inclusions, and a recently new (and under-documented) feature called blocks.<a id="id395" class="indexterm"/>
</p><p>A<span class="strong"><strong> block</strong></span> is a way that child templates can override certain portions of their parent templates, and replace or extend the content with their own.<a id="id396" class="indexterm"/>
</p><p>For example, a typical layout template includes several places that could be overridden, based on the current page a user is located on. Examples include the title bar, portions of the navigation, perhaps a page title, or keywords.</p><p>In this example, we will consider a typical enterprise application that contains custom JavaScript on each page to handle elements local to only that page; the method of solving this will generate a base pattern for block usage.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec24"/>How to do it...</h2></div></div></div><p>First, let's handle the basic pattern of using blocks, since this also solves the issue in our example application of needing a place to put extra JavaScript blocks within the<code class="literal">&lt;head&gt;</code> element of the HTML page.</p><p>Consider the following<code class="literal"> layout.html</code> file:<a id="id397" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
&lt;!doctype html&gt;

&lt;head&gt;
	&lt;title&gt;{{block title}}My Web2py App{{end}}&lt;/title&gt;
	
	&lt;script type="text/javascript" src={{=URL(c="static/js",
		f="jquery.js")}}&gt;&lt;/script&gt;
		
	{{block head}}{{end}}
&lt;/head&gt;

&lt;body&gt;
	&lt;h1&gt;{{block body_title}}My Web2py App{{end}}&lt;/h1&gt;
	
	&lt;div id="main_content"&gt;
		{{block main_content}}
			&lt;p&gt;Page has not been defined&lt;/p&gt;
		{{end}}
	&lt;/div&gt;
&lt;/body&gt;
</pre></div><p>And the following<code class="literal"> detail.html</code> file:</p><div class="informalexample"><pre class="programlisting">
{{extend "layout.html"}}

{{block title}}Analysis Drilldown - {{super}}{{end}}

{{block head}}
	&lt;script&gt;
		$(document).ready(function() {
			$('#drill_table').sort();
	 });
	&lt;/script&gt;
{{end}}

{{block main_content}}
	&lt;table id="drill_table"&gt;
		&lt;tr&gt;
			&lt;td&gt;ABC&lt;/td&gt;
			&lt;td&gt;123&lt;/td&gt;
		&lt;/tr&gt;
		&lt;tr&gt;
			&lt;td&gt;EFG&lt;/td&gt;
			&lt;td&gt;456&lt;/td&gt;
		&lt;/tr&gt;
	&lt;/table&gt;
{{end}}
</pre></div><p>This will render the following output file:<a id="id398" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
&lt;!doctype html&gt;

&lt;head&gt;
	&lt;title&gt;Analysis Drilldown - My Web2py App&lt;/title&gt;

	&lt;script type="text/javascript" src="/static/js/jquery.js"&gt;&lt;/script&gt;

	&lt;script&gt;
		$(document).ready(function() {
			$('#drill_table').sort();
		});
	&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
	&lt;h1&gt;My Web2py App&lt;/h1&gt;
	
	&lt;div id="main_content"&gt;
		&lt;table id="drill_table"&gt;
			&lt;tr&gt;
				&lt;td&gt;ABC&lt;/td&gt;
				&lt;td&gt;123&lt;/td&gt;
			&lt;/tr&gt;
			&lt;tr&gt;
				&lt;td&gt;EFG&lt;/td&gt;
				&lt;td&gt;456&lt;/td&gt;
			&lt;/tr&gt;
		&lt;/table&gt;
	&lt;/div&gt;
&lt;/body&gt;
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec25"/>There's more...</h2></div></div></div><p>Notice the use of<code class="literal"> {{super}}</code> when overriding the title block.<code class="literal"> {{super}}</code> will take the HTML output of the parent block that it is overriding, and insert it at that position. So, in this example, the page title can retain the global sites title, but insert this unique page name into the title.</p><p>Another thing to note is that when a block is not defined in a child template, it will still render. Since there was no definition for the<code class="literal"> body_title</code> block, it still rendered<code class="literal"> My web2py App</code>.</p><p>Also, blocks deprecate the need for the old web2py<code class="literal"> {{include}}</code> helper, as the child template could just define a block that represents the location for the main content of the page. This is a design pattern used heavily in other popular template languages.<a id="id399" class="indexterm"/>
</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch11lvl1sec14"/>Making standalone applications with web2py and wxPython</h1></div></div></div><p>web2py can be used to make desktop-visual applications that doesn't require a browser or a web server. This can be useful when standalone applications are needed (that is, no web server installation), and also, this approach allows to simplify user interface programming without advanced JavaScript or CSS requirements, giving direct access to a user's machine operating system and libraries.<a id="id400" class="indexterm"/>
</p><p>This recipe shows you how to use<span class="strong"><strong> models</strong></span> and<span class="strong"><strong> helpers</strong></span> to create a sample form, to store basic person information into a database using the<span class="strong"><strong> wxPython</strong></span> GUI toolkit, in fewer than 100 lines of code, following the best practices of web2py.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec26"/>Getting ready</h2></div></div></div><p>First, you need a working Python and web2py installation, and then download and install wxPython from (<a class="ulink" href="http://www.wxpython.org/download.php"> http://www.wxpython.org/download.php</a>).<a id="id401" class="indexterm"/>
</p><p>Second, you need<span class="strong"><strong> gui2py</strong></span>, a small library that manages forms, bridging web2py and wx (http://code.google.com/p/gui2py/downloads/list).<a id="id402" class="indexterm"/>
</p><p>You can also pull the source code from the project repository using Mercurial:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>hg clone https://codegoogle.com/p/gui2py/.</strong></span>
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec27"/>How to do it...</h2></div></div></div><p>In this basic recipe, we will cover the following steps:</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Import wxPython, gui2py, and web2py.</p></li><li class="listitem"><p>Create a sample<code class="literal"> Person</code> table, with several fields and validators.</p></li><li class="listitem"><p>Create wxPython GUI objects (application, main frame window, and html browser).</p></li><li class="listitem"><p>Create a web2py SQL form for the<code class="literal"> Person</code> table.</p></li><li class="listitem"><p>Define the event handler to process the user input (validating and inserting the row).</p></li><li class="listitem"><p>Connect the event handler, show the window, and start to interact with the user.</p></li></ol></div><p>The full example follows, with a self-explained source code. Type it in, and save as a usual Python script, for example, in your home directory as<code class="literal"> my_gui2py_app.py:</code>
<a id="id403" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
#!/usr/bin/python
# -*- coding: latin-1 -*-

import sys

# import wxPython:
import wx

# import gui2py support -wxHTML FORM handling- (change the path!)
sys.path.append(r"/home/reingart/gui2py")
from gui2py.form import EVT_FORM_SUBMIT

# import web2py (change the path!)
sys.path.append(r"/home/reingart/web2py")
from gluon.dal import DAL, Field
from gluon.sqlhtml import SQLFORM
from gluon.html import INPUT, FORM, TABLE, TR, TD
from gluon.validators import IS_NOT_EMPTY, IS_EXPR, IS_NOT_IN_DB,
IS_IN_SET
from gluon.storage import Storage

# create DAL connection (and create DB if not exists)
db=DAL('sqlite://guitest.sqlite',folder=None)

# define a table 'person' (create/aster as necessary)
person = db.define_table('person',
	Field('name','string', length=100),
	Field('sex','string', length=1),
	Field('active','boolean', comment="check!"),
	Field('bio','text', comment="resume (CV)"),
)

# set sample validator (do not allow empty nor duplicate names)
db.person.name.requires = [IS_NOT_EMPTY(),
	IS_NOT_IN_DB(db, 'person.name')]
	
db.person.sex.requires = IS_IN_SET({'M': 'Male', 'F': 'Female'})

# create the wxPython GUI application instance:
app = wx.App(False)

# create a testing frame (wx "window"):
f = wx.Frame(None, title="web2py/gui2py sample app")

# create the web2py FORM based on person table
form = SQLFORM(db.person)

# create the HTML "browser" window:
html = wx.html.HtmlWindow(f, style= wx.html.HW_DEFAULT_STYLE |
	wx.TAB_TRAVERSAL)
# convert the web2py FORM to XML and display it
html.SetPage(form.xml())

def on_form_submit(evt):
	"Handle submit button user action"
	global form
	print "Submitting to %s via %s with args %s"% (evt.form.action,
		evt.form.method, evt.args)
	if form.accepts(evt.args, formname=None, keepvalues=False, dbio=False):
		print "accepted!"
	# insert the record in the table (if dbio=True this is done by web2py):
	db.person.insert(name=form.vars.name,
		sex=form.vars.sex,
		active=form.vars.active,
		bio=form.vars.bio,
		)
	# don't forget to commit, we aren't inside a web2py controller!
	db.commit()
	elif form.errors:
		print "errors", form.errors
	# refresh the form (show web2py errors)
	html.SetPage(form.xml())
	
# connect the FORM event with the HTML browser
html.Bind(EVT_FORM_SUBMIT, on_form_submit)

# show the main window
f.Show()
# start the wx main-loop to interact with the user
app.MainLoop()
</pre></div><p>Remember to change<code class="literal"> /home/reingart/web2py /home/reingart/gui2py</code> to your web2py and gui2py installation paths.</p><p>Once you have saved the file, run it:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>python my_gui2py_app.py</strong></span>
</pre></div><p>You should see the application window ready to receive data, and test it! It should work as a usual web2py application:<a id="id404" class="indexterm"/>
</p><div class="mediaobject"><img src="images/5467OS_11_49.jpg" alt="How to do it..."/></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec28"/>How it works...</h2></div></div></div><p>This recipe uses basic wxPython objects, in this case, the<code class="literal"> wx.HTML</code> control (you can see the original<code class="literal"> form_example.zip</code> that is the base to gui2py):</p><p>
<a class="ulink" href="http://wiki.wxpython.org/wxHTML">http://wiki.wxpython.org/wxHTML</a>
</p><p>
<code class="literal">wx.HTML</code> is basically the<span class="strong"><strong> wxPython</strong></span> browser, and it can display simple HTML markup (mainly intended to show help pages, reports, and do simple printing). It can be extended to render custom HTML tags (FORM,<code class="literal"> INPUT, TEXTAREA</code>, and so on), emulating a normal browser.</p><p>First, the program should import the required libraries, define the models, and create a<code class="literal"> wx</code> application and a basic window (a<code class="literal"> Frame</code> in the<code class="literal"> wx</code> world). Once the<code class="literal"> wx.HTML</code> control is created inside the main window, the event handler should be connected to tell<code class="literal"> wx</code> how to respond to user actions. The event handler receives the form data already parsed, it does the standard form validation and inserts the row data using DAL (in a similar way to web2py controllers). Finally, this is a GUI application, so it must call the<code class="literal"> MainLoop</code>. It runs forever, waiting for the user events, and calling the appropriate event handlers.<a id="id405" class="indexterm"/>
</p><p>The main advantage is that<code class="literal"> wx.HTML</code> removes the need of a JavaScript engine, so the events can be programmed directly in Python, and it also assures the same results in different platforms where<code class="literal"> wxPython</code> runs, without the troubles of HTML compatibility issues.</p><p>As the code is a standard Python program, you can access advanced features directly in the user machine, such as opening files or socket connections, or using libraries to interact with webcams, USB devices or legacy hardware.</p><p>Also, this approach allows to reuse your web2py knowledge (DAL, models, helpers, built-in validation, and so on), speeding up the development of standalone visual GUI applications, following the best practices of web development.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch11lvl2sec29"/>There's more...</h2></div></div></div><p>This recipe could be further extended with more advanced wxPython controls, such as<code class="literal"> wx.ListCtrl</code> or<code class="literal"> wx.Grid</code>, enabling to make responsive fully-featured applications with spreadsheets capabilities, custom cell editors, virtual rows to browse huge quantities of records, and so on.</p><p>Also,<code class="literal"> wx.AUI</code> <span class="strong"><strong>(Advanced User Interface)</strong></span> allows to build modern looking applications with docking toolbars and panels, visual styles, and so on.</p><p>You can see more<a id="id406" class="indexterm"/>
</p></div></div></div></div>
</body></html>