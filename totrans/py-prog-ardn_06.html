<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Storing and Plotting Arduino Data"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Storing and Plotting Arduino Data</h1></div></div></div><p>Sensors that are connected to Arduino produce lots of analog and digital data. Analog sensors produce data points as numerical information while digital sensors produce Boolean values, that is, 1 (on) or 0 (off). Until now, we printed this data as a string on the command prompt or displayed it in a GUI. The data was being printed in real time and it was not being saved for any further analysis. Instead of using the string format, if the data is printed as a plot or graph, it will provide useful information for us to rapidly understand it and derive conclusions. Plots are even more useful for real-time applications as they can provide information regarding the system's behavior for better understanding of the data.</p><p>This chapter is organized around two major sections: storing the Arduino sensor data and plotting this data. We will start by creating and manipulating files using Python. After that, we will work with methods for storing Arduino data in the CSV file format. In the second section, you will be introduced to the Python plotting library, <code class="literal">matplotlib</code>. Then, we will work with examples that deal with plotting data from a saved file and also from real-time sensor readings. In the end, we will try to integrate the <code class="literal">matplotlib</code> plots with the <code class="literal">Tkinter</code> window that we created in the previous chapter.</p><p>In terms of hardware components, we will be working with familiar sensors such as a potentiometer and the PIR motion sensor, which we used in the previous chapters, so, you will not have to learn or buy any additional sensors for this chapter.</p><div class="section" title="Working with files in Python"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec41"/>Working with files in Python</h1></div></div></div><p>Python provides<a id="id538" class="indexterm"/> built-in methods to create and modify files. File-related Python operations are useful in a large number of programming exercises. These methods are provided by standard Python modules and do not require installation of additional packages.</p><div class="section" title="The open() method"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec78"/>The open() method</h2></div></div></div><p>The <code class="literal">open()</code> method is a<a id="id539" class="indexterm"/> default method that is available in Python and it is one of the most widely <a id="id540" class="indexterm"/>used functions to manipulate files. Now, the first step of dealing with a file is to open it:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; f = open('test.txt', 'w')</strong></span>
</pre></div><p>This command will create a <code class="literal">test.txt</code> file in the same folder in which you started the Python interpreter or the location from where the code is being executed. The preceding command uses the <code class="literal">w</code> mode that opens a file for writing or creates a new one if it doesn't exist. The other modes that can be used with the <code class="literal">open()</code> function are displayed in the <a id="id541" class="indexterm"/>following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Mode</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">w</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This opens or creates a file for writing only. It overwrites an existing file.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">w+</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This opens or creates a file for writing and reading. It overwrites an existing file.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">r</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This opens a file for reading only.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">r+</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This opens a file for reading and writing.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">a</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This opens a file for appending. It starts appending from the end of the document.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">a+</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This opens a file for appending and reading. It starts appending from the end of the document.</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note38"/>Note</h3><p>Make sure that you have the proper read and write permissions for the files if you are utilizing these modes in a Unix or Linux environment.</p></div></div></div><div class="section" title="The write() method"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec79"/>The write() method</h2></div></div></div><p>Once the file is open in one of the writing or appending modes, you can start writing to the file object using this method. The <code class="literal">write()</code> method only takes a string as <a id="id542" class="indexterm"/>an input argument. Any other data format needs to be converted into a string before it is <a id="id543" class="indexterm"/>written:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; f.write("Hello World!\n")</strong></span>
</pre></div><p>In this example, we are writing the <code class="literal">Hello World!</code> string that ends with a new line character, <code class="literal">\n</code>. This new line character has been explained in the previous chapter and you can obtain more information about it at <a class="ulink" href="http://en.wikipedia.org/wiki/Newline">http://en.wikipedia.org/wiki/Newline</a>.</p><p>You can also use the <code class="literal">writelines()</code> method if you want to write a sequence of strings to the file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; sq = ["Python programming for Arduino\n", "Bye\n"]</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; f.writelines(sq)</strong></span>
</pre></div></div><div class="section" title="The close() method"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec80"/>The close() method</h2></div></div></div><p>The <code class="literal">close()</code> method <a id="id544" class="indexterm"/>closes the file and free system resources that are occupied by the file. Once<a id="id545" class="indexterm"/> they are closed, you can't use the file object as it has been flushed already. It is a good practice to close the file once you are done working with a file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; f.close()</strong></span>
</pre></div></div><div class="section" title="The read() method"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec81"/>The read() method</h2></div></div></div><p>This <code class="literal">read()</code> method<a id="id546" class="indexterm"/> reads the content of an opened file from the beginning to the end. To <a id="id547" class="indexterm"/>use this method, you need to open the file with one of the reading compatible modes such as <code class="literal">w+</code>, <code class="literal">r</code>, <code class="literal">r+</code>, or <code class="literal">a+</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; f = open('test.txt', 'r')</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; f.read()</strong></span>
<span class="strong"><strong>'Hello World!\nPython programming for Arduino\nBye\n'</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; f.close()</strong></span>
</pre></div><p>As the <code class="literal">read()</code> method grabs the entire contents of the file into memory, you can use it with the <a id="id548" class="indexterm"/>optional size parameter to avoid any memory congestion while working with large files. As an alternative method, you can use the <code class="literal">readlines()</code> method to read the content of <a id="id549" class="indexterm"/>an opened file line by line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; f = open('test.txt', 'r')</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; l = f.readlines()</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; print l</strong></span>
<span class="strong"><strong>['Hello World!\n', 'Python programming for Arduino\n', 'Bye\n']</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; f.close()</strong></span>
</pre></div><p>As you can see in the preceding example, each string is printed as an element of a list that you can access individually. You can play around with these methods to get familiar with creating and modifying files. These exercises will be handy for the upcoming coding exercises.</p></div><div class="section" title="The with statement – Python context manager"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec82"/>The with statement – Python context manager</h2></div></div></div><p>Although the <code class="literal">with</code> statement can be used to cover the execution of a code block that is defined by<a id="id550" class="indexterm"/> a context manager, it is widely used in Python to deal with files. Execute the following <a id="id551" class="indexterm"/>command on the Python interactive prompt, assuming that you have already executed the previous commands and have the <code class="literal">test.txt</code> file with some data:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; with open('test.txt', 'r') as f:</strong></span>
<span class="strong"><strong>  lines = f.readlines()</strong></span>
<span class="strong"><strong>  for l in lines:</strong></span>
<span class="strong"><strong>    print l</strong></span>
</pre></div><p>On execution, you will be able to see each line of the file printed on the command prompt. The <code class="literal">with</code> statement while used with the <code class="literal">open()</code> method creates a context manager, which executes the wrapped code while automatically taking care of closing the file. This is the recommended method to work with files in Python and we will be utilizing it in all of our exercises. You can learn more about the Python context manager<a id="id552" class="indexterm"/> on the following websites:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="https://docs.python.org/2/reference/compound_stmts.html#with">https://docs.python.org/2/reference/compound_stmts.html#with</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://preshing.com/20110920/the-python-with-statement-by-example/">http://preshing.com/20110920/the-python-with-statement-by-example/</a></li></ul></div></div></div></div>
<div class="section" title="Using CSV files to store data"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec42"/>Using CSV files to store data</h1></div></div></div><p>Now you know methods to open, manipulate, and close files using Python. In the previous examples, we <a id="id553" class="indexterm"/>used the Python interpreter and string data to get familiar with these methods. But when it comes to saving a large number of numerical values from sensor data, the <span class="strong"><strong>comma separated values</strong></span> (<span class="strong"><strong>CSV</strong></span>) file format is one of the most widely used file formats other than text. As the name states, values are separated and stored using <a id="id554" class="indexterm"/>commas or other delimiters such as a space or tab. Python has a built-in module to deal with CSV files.</p><p>To begin with, use the following code snippet to create a Python file and run your first CSV program:</p><div class="informalexample"><pre class="programlisting">import csv
data = [[1, 2, 3], ['a', 'b', 'c'], ['Python', 'Arduino', 'Programming']]

with open('example.csv', 'w') as f:
  w = csv.writer(f)
  for row in data:
    w.writerow(row)</pre></div><p>You can also open the <code class="literal">csvWriter.py</code> file from this chapter's code folder, which contains the same code. After executing the code, you will be able to find a file named <code class="literal">example.csv</code> in the same location as this file, which will contain the data separated with commas.</p><p>As you can see in the code, the CSV module offers the <code class="literal">writer()</code> function on the opened file that initializes a <code class="literal">writer</code> object. The <code class="literal">writer</code> object takes a sequence or array of data (integer, float, string, and so on) as input and joins the values of this array using the delimiter character:</p><div class="informalexample"><pre class="programlisting">w = csv.writer(f)</pre></div><p>In the preceding example, since we are not using a delimiter option, the program will take the default character comma as the delimiter. If you want to use space as the delimiter character, you can use the following <code class="literal">writer()</code> option:</p><div class="informalexample"><pre class="programlisting">w = csv.writer(f, delimiter=' ')</pre></div><p>To write each element of a list to a new line of this <code class="literal">writer</code> object, we use the <code class="literal">writerow()</code> method.</p><p>Similarly, Python CSV module also provides the <code class="literal">reader()</code> function to read a CSV file. Check out the following example to learn more about this function, or you can open the <code class="literal">csvReader.py</code> file from the next chapter's code folder:</p><div class="informalexample"><pre class="programlisting">import csv
with open('example.csv', 'r') as file:
    r = csv.reader(file)
    for row in r:
        print row</pre></div><p>The <code class="literal">reader()</code> function creates a <code class="literal">reader</code> object to iterate over lines in the opened CSV file. The<a id="id555" class="indexterm"/> reader object retrieves each element of a row by splitting it using the delimiter. You can access each line of the file by iterating over the object using the <code class="literal">for</code> loop as displayed in the preceding code snippet, or use the <code class="literal">next()</code> method every time you want to access the next line. On execution of the previous code, you will be able to see three separate array lists that are printed with three individual elements.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip09"/>Tip</h3><p>To open the CSV files externally, you can use a spreadsheet program such as Microsoft Excel, OpenOffice Calc, or Apple Numbers.</p></div></div></div>
<div class="section" title="Storing Arduino data in a CSV file"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec43"/>Storing Arduino data in a CSV file</h1></div></div></div><p>In the previous two sections, you learned methods to store values in a CSV file. Although the <a id="id556" class="indexterm"/>data required for the file was already initialized in the code, the same code could be modified <a id="id557" class="indexterm"/>to store Arduino input data.</p><p>To begin with storing Arduino data, let's create a circuit that produces these values for us. We used a motion sensor in the project of <a class="link" href="ch03.html" title="Chapter 3. The First Project – Motion-triggered LEDs">Chapter 3</a>, <span class="emphasis"><em>The First Project – Motion-triggered LEDs</em></span>, and a potentiometer in the exercise of <a class="link" href="ch04.html" title="Chapter 4. Diving into Python-Arduino Prototyping">Chapter 4</a>, <span class="emphasis"><em>Diving into Python-Arduino Prototyping</em></span>. We will be using these two sensors to provide us with digital and analog input values respectively. To develop the circuit required for this exercise, connect the potentiometer to the analog pin 0 and the PIR motion sensor to digital pin 11, as displayed in the following diagram:</p><div class="mediaobject"><img src="graphics/5938OS_06_01.jpg" alt="Storing Arduino data in a CSV file"/></div><p>Connect other <a id="id558" class="indexterm"/>Arduino pins such as 5V and the ground, as shown in the preceding Fritzing diagram. As we <a id="id559" class="indexterm"/>are going to use <code class="literal">pyFirmata</code> to interface Python with the Arduino board, you will have to upload the <span class="strong"><strong>StandardFirmata</strong></span> sketch to the Arduino board using the method described in <a class="link" href="ch03.html" title="Chapter 3. The First Project – Motion-triggered LEDs">Chapter 3</a>, <span class="emphasis"><em>The First Project – Motion-triggered LEDs</em></span>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note39"/>Note</h3><p>When you are working with prototyping, you really don't need large, powerful, and computation-intensive databases to deal with information. The easiest and quickest way to work with sensor data in this phase is by using CSV files.</p></div></div><p>Once you have your Arduino board ready with the appropriate connections, use the following code snippet to create a Python file and run it. You can also open the <code class="literal">csvArduinoStore.py</code> file from this chapter's code folder:</p><div class="informalexample"><pre class="programlisting">import csv
import pyfirmata
from time import sleep

port = '/dev/cu.usbmodemfa1331'
board = pyfirmata.Arduino(port)

it = pyfirmata.util.Iterator(board)
it.start()

pirPin = board.get_pin('d:11:i')
a0 = board.get_pin('a:0:i')

with open('SensorDataStore.csv', 'w') as f:
    w = csv.writer(f)
    w.writerow(["Number", "Potentiometer", "Motion sensor"])
    i = 0
    pirData = pirPin.read()
    potData = a0.read()
    while i &lt; 25:
        sleep(1)
        if pirData is not None:
            i += 1
            row = [i, potData, pirData]
            w.writerow(row)
    print "Done. CSV file is ready!"

board.exit()</pre></div><p>While the <a id="id560" class="indexterm"/>code is running, rotate the knob of the potentiometer and wave your hand in front of the motion <a id="id561" class="indexterm"/>sensors. This action will help you to generate and measure distinct values from these sensors. Meanwhile, the program will log this data in the <code class="literal">SensorDataStore.csv</code> file. When complete, open the <code class="literal">SensorDataStore.csv</code> file using any text viewer or spreadsheet program and you will be able to see these sensor values stored in the file. Now, let's try to understand the program.</p><p>As you can observe from the code, we are not utilizing a new module to interface the Arduino board or store sensor values to the file. Instead, we have utilized the same methods that we used in the previous exercises. The code has two distinct components: Python-Arduino interfacing and storing data to a CSV file. By skipping the explanation of <code class="literal">pyFirmata</code> methods to interface the Arduino board, let's focus on the code that is associated with storing the sensor data. The first line that we will write to the CSV file using <code class="literal">writerow()</code> is the header line that explains the content of the columns:</p><div class="informalexample"><pre class="programlisting">w.writerow(["Number", "Potentiometer", "Motion sensor"])</pre></div><p>Later, we will obtain the readings from the sensors and write them to the CSV file, as shown in the following code snippet. We will repeat this process 25 times as defined by the variable, <code class="literal">i</code>. You can change the value of <code class="literal">i</code> according to your requirements.</p><div class="informalexample"><pre class="programlisting">while i &lt; 25:
    sleep(1)
    if pirData is not None:
        i += 1
        row = [i, potData, pirData]
        w.writerow(row)</pre></div><p>The next <a id="id562" class="indexterm"/>question is <a id="id563" class="indexterm"/>how can you utilize this coding exercise in your custom projects? The program has three main sections that can be customized to accomplish your project requirements, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Arduino pins</strong></span>: You can change the Arduino pin numbers and the number of pins to be utilized. You can do this by adding additional sensor values to the row object.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The CSV file</strong></span>: The name of the file and its location can be changed from <code class="literal">SensorDataStore.csv</code> to the one that is specific to your application.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The number of data points</strong></span>: We have collected 25 different pairs of data points while running the <code class="literal">while</code> loop for 25 iterations. You can change this value. You can also change the time delay between each successive point from one second, as used in the program, to the value that you need.</li></ul></div></div>
<div class="section" title="Getting started with matplotlib"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec44"/>Getting started with matplotlib</h1></div></div></div><p>The <code class="literal">matplotlib</code> library is one of the most popular and widely supported Python plotting libraries. Although <code class="literal">matplotlib</code> is inspired by MATLAB, it is independent of MATLAB. Similar<a id="id564" class="indexterm"/> to other Python libraries that we have been using, it is an open source Python library. The <code class="literal">matplotlib</code> library assists in creating 2D plots from simple lines of code from easy to use built-in functions and methods. The <code class="literal">matplotlib</code> library is extensively used in Python-based applications for data visualization and analysis. It utilizes <code class="literal">NumPy</code> (the short form of numerical Python) and <code class="literal">SciPy</code> (short form of scientific Python) packages for mathematical calculations for the analysis. These packages are major dependencies for <code class="literal">matplotlib</code> including <code class="literal">freetype</code> and <code class="literal">pyparsing</code>. Make sure that you have these packages preinstalled on your system if you are using any other installation methods besides the ones mentioned in the next section. You can obtain more information about the <code class="literal">matplotlib</code> library from its <a id="id565" class="indexterm"/>official website (<a class="ulink" href="http://matplotlib.org/">http://matplotlib.org/</a>).</p><div class="section" title="Configuring matplotlib on Windows"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec83"/>Configuring matplotlib on Windows</h2></div></div></div><p>Before we install <code class="literal">matplotlib</code> on Windows, make sure that you have your Windows <a id="id566" class="indexterm"/>operating <a id="id567" class="indexterm"/>system with the latest version of Python 2.x distribution. In <a class="link" href="ch01.html" title="Chapter 1. Getting Started with Python and Arduino">Chapter 1</a>, <span class="emphasis"><em>Getting Started with Python and Arduino</em></span>, we installed Setuptools to download and install additional Python packages. Make sure that you have Setuptools installed and configured properly. Before we advance further, we will have to install dependencies for <code class="literal">matplotlib</code>. Open the command prompt and use the following command to install the <code class="literal">dateutil</code> and <code class="literal">pyparsing</code> packages:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt; easy_install.exe python_dateutil</strong></span>
<span class="strong"><strong>&gt; easy_install.exe pyparsing</strong></span>
</pre></div><p>Once you have successfully installed these packages, download and install the precompiled <a id="id568" class="indexterm"/>
<code class="literal">NumPy</code> package from <a class="ulink" href="http://sourceforge.net/projects/numpy/">http://sourceforge.net/projects/numpy/</a>. Make sure that you choose the appropriate installation files for Python 2.7 and the type of your Windows operating system.</p><p>Now, your computer should have satisfied all the prerequisites for <code class="literal">matplotlib</code>. Download and install the <a id="id569" class="indexterm"/>precompiled <code class="literal">matplotlib</code> package from <a class="ulink" href="http://matplotlib.org/downloads.html">http://matplotlib.org/downloads.html</a>.</p><p>In this installation process, we have avoided the usage of Setuptools for <code class="literal">NumPy</code> and <code class="literal">matplotlib</code> because of some known issues related to <code class="literal">matplotlib</code> in the Windows operating system. If you can figure out ways to install these packages using Setuptools, then you can skip the preceding manual steps.</p></div><div class="section" title="Configuring matplotlib on Mac OS X"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec84"/>Configuring matplotlib on Mac OS X</h2></div></div></div><p>Installation of <code class="literal">matplotlib</code> on Mac OS X can be difficult depending upon the version <a id="id570" class="indexterm"/>of Mac OS X and the availability of dependencies. Make sure that you have Setuptools <a id="id571" class="indexterm"/>installed as described in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with Python and Arduino">Chapter 1</a>, <span class="emphasis"><em>Getting Started with Python and Arduino</em></span>. Assuming that you already have Setuptools and <code class="literal">pip</code>, run the following command on the terminal:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo pip install matplotlib</strong></span>
</pre></div><p>Executing this command will lead to one of the following three possibilities:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Successful installation of the latest <code class="literal">matplotlib</code> version</li><li class="listitem" style="list-style-type: disc">Notification that the requirements are already satisfied but the installed version is older than the current version, which is 1.3 at the moment</li><li class="listitem" style="list-style-type: disc">Error while installing the <code class="literal">matplotlib</code> package</li></ul></div><p>If you encounter the first possibility, then you can advance to the next section; otherwise <a id="id572" class="indexterm"/>follow the <a id="id573" class="indexterm"/>troubleshooting instructions. You can check your <code class="literal">matplotlib</code> version using the following commands on the Python interactive prompt:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; import matplotlib</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; matplotlib.__version__</strong></span>
</pre></div><div class="section" title="Upgrading matplotlib"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec50"/>Upgrading matplotlib</h3></div></div></div><p>If you encounter the second possibility, which states that the existing version of the <code class="literal">matplotlib</code> is older than the current version, use the following command to upgrade<a id="id574" class="indexterm"/> the <code class="literal">matplotlib</code> package:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo pip install –-upgrade matplotlib</strong></span>
</pre></div><p>Go through the next section in case you end up with errors during this upgrade.</p></div><div class="section" title="Troubleshooting installation errors"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec51"/>Troubleshooting installation errors</h3></div></div></div><p>If you encounter <a id="id575" class="indexterm"/>any errors during the <code class="literal">matplotlib</code> installation via <code class="literal">pip</code>, it is most likely that you are missing some dependency packages. Follow these steps one by one to troubleshoot the errors.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>After every step, use one of the following commands to check whether the error is resolved:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo pip install matplotlib</strong></span>
<span class="strong"><strong>$ sudo pip install –-upgrade matplotlib</strong></span>
</pre></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install Xcode from Apple's App Store. Open Xcode and navigate to the <span class="strong"><strong>Download</strong></span> tab in <span class="strong"><strong>Preferences…</strong></span>. Download and install <span class="strong"><strong>Command Line Tools</strong></span> from <span class="strong"><strong>Preferences…</strong></span>. This step should solve any compilation-related errors.</li><li class="listitem">Install <code class="literal">homebrew</code> using the following command in the terminal:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ruby -e "$("$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)")"</strong></span>
</pre></div></li><li class="listitem">Install the following packages using <code class="literal">homebrew</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ brew install freetype</strong></span>
<span class="strong"><strong>$ brew install pkg-config</strong></span>
</pre></div><p>If you still receive an error with the <code class="literal">freetype</code> package, try to create a link for <code class="literal">freetype</code> using<a id="id576" class="indexterm"/> the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ brew link freetype</strong></span>
<span class="strong"><strong>$ ln -s /usr/local/opt/freetype/include/freetype2 /usr/local/include/freetype</strong></span>
</pre></div><p>If you receive any further errors after performing the preceding steps, go to the <a id="id577" class="indexterm"/>
<code class="literal">matplotlib</code> forums at <a class="ulink" href="http://matplotlib.1069221.n5.nabble.com/">http://matplotlib.1069221.n5.nabble.com/</a> for those specific errors.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note40"/>Note</h3><p>If you use <code class="literal">matplotlib</code> in Mac OS X, you need to set up the appropriate drawing backend as shown in the following code snippet:</p><div class="informalexample"><pre class="programlisting">import matplotlib
matplotlib.use('TkAgg''')</pre></div><p>You can learn more about drawing backends for <code class="literal">matplotlib</code> at <a class="ulink" href="http://matplotlib.org/faq/usage_faq.html#what-is-a-backend">http://matplotlib.org/faq/usage_faq.html#what-is-a-backend</a>.</p></div></div></li></ol></div></div></div><div class="section" title="Setting up matplotlib on Ubuntu"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec85"/>Setting up matplotlib on Ubuntu</h2></div></div></div><p>The installation of <code class="literal">matplotlib</code> and the required dependencies is a very straightforward <a id="id578" class="indexterm"/>process on Ubuntu. We can perform this operation without using <a id="id579" class="indexterm"/>Setuptools and with the help of the Ubuntu package manager. The following simple command should do the trick for you:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install python-matplotlib</strong></span>
</pre></div><p>When prompted to select dependencies, click on <span class="strong"><strong>Yes</strong></span> to install them all. You should be able to find the <code class="literal">matplotlib</code> package in other popular Linux distributions too.</p></div></div>
<div class="section" title="Plotting random numbers using matplotlib"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec45"/>Plotting random numbers using matplotlib</h1></div></div></div><p>The <code class="literal">matplotlib</code> library provides a collection of basic plotting-related functions and methods <a id="id580" class="indexterm"/>via the <a id="id581" class="indexterm"/>
<code class="literal">pyplot</code> framework. The <code class="literal">pyplot</code> framework contains functions for creating figures, drawing plots, setting up titles, setting up axes, and many additional plotting methods. One of the import functions provided by <code class="literal">pyplot</code> is <code class="literal">figure()</code>. This initializes <a id="id582" class="indexterm"/>an empty figure canvas that can be selected for your plot or a set of plots:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>fig1 = pyplot.figure(1)</strong></span>
</pre></div><p>You can similarly create multiple figures by specifying a number as the parameter, that is, <code class="literal">figure(2)</code>. If a figure with this number already exists, the method activates the existing figure that can then be further used for plotting.</p><p>The <code class="literal">matplotlib</code> library provides the <code class="literal">plot()</code> method to create line charts. The <code class="literal">plot()</code> method takes a list or an array data structure that is made up of integer or floating point numbers as input. If two arrays are used as inputs, <code class="literal">plot()</code> utilizes them as values for the <span class="emphasis"><em>x</em></span> axis and the <span class="emphasis"><em>y</em></span> axis. If only one list or array is provided, <code class="literal">plot()</code> assumes it to be the sequence values for the <span class="emphasis"><em>y</em></span> axis and uses auto-generated incremental values for the <span class="emphasis"><em>x</em></span> axis:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>pyplot.plot(x, y)</strong></span>
</pre></div><p>The third <a id="id583" class="indexterm"/>optional parameter that is supported by the <code class="literal">plot()</code> method is for the format string. These parameters help users to change the style of line and markers with different colors. In our example, we are using the solid line style. So, the <code class="literal">plot()</code> function for our plot looks like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>pyplot.plot(x, y, '-')</strong></span>
</pre></div><p>The <code class="literal">plot()</code> function<a id="id584" class="indexterm"/> provides a selection from a large collection of styles and colors. To find more information about these parameters, use Python's <code class="literal">help()</code> function on the <code class="literal">plot()</code> function of <code class="literal">matplotlib</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; import matplotlib</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; help(matplotlib.pyplot.plot)</strong></span>
</pre></div><p>This <code class="literal">help()</code> function<a id="id585" class="indexterm"/> will provide the necessary information to create plotting styles with different markers, line styles, and colors. You can exit this help menu by typing <code class="literal">q</code> at the prompt.</p><p>Now, as we have explored plotting sufficiently, let's create your first Python plot using the following code snippet. The program containing this code is also located in this chapter's code folder with the name <code class="literal">plotBasic.py</code>:</p><div class="informalexample"><pre class="programlisting">from matplotlib import pyplot
import random

x = range(0,25)
y = [random.randint(0,100) for r in range(0,25)]

fig1 = pyplot.figure()
pyplot.plot(x, y, '-')
pyplot.title('First Plot - Random integers')
pyplot.xlabel('X Axis')
pyplot.ylabel('Y Axis')

pyplot.show()</pre></div><p>In the previous exercise, we randomly generated a dataset for the <span class="emphasis"><em>y</em></span> axis using the <code class="literal">randint()</code> method. You can see a plot depicting this data with the solid line style in an opened window after running the program. As you can see in the code snippet, we used the additional <code class="literal">pyplot</code> methods such as <code class="literal">title()</code>, <code class="literal">xlabel()</code>, <code class="literal">ylabel()</code>, and <code class="literal">plot()</code>. These <a id="id586" class="indexterm"/>methods are self-explanatory and they are largely used to make your plots more informative and meaningful.</p><p>At end of the example, we used one of the most important <code class="literal">pyplot</code> methods called <code class="literal">show()</code>. The <code class="literal">show()</code> method<a id="id587" class="indexterm"/> displays the generated plots in a figure. This method is not mandatory to display figures when running from Python's interactive prompt. The following screenshot illustrates the plot of randomly generated values using <code class="literal">matplotlib</code>:</p><div class="mediaobject"><img src="graphics/5938OS_06_02.jpg" alt="Plotting random numbers using matplotlib"/></div></div>
<div class="section" title="Plotting data from a CSV file"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec46"/>Plotting data from a CSV file</h1></div></div></div><p>At the beginning <a id="id588" class="indexterm"/>of the chapter, we created a CSV file from Arduino data. We will be using that <code class="literal">SensorDataStore.csv</code> file for this section. If you recall, we used two different sensors<a id="id589" class="indexterm"/> to log the data. Hence, we have two arrays of values, one from a digital sensor and another from the analog one. Now, in the previous example, we just plotted one set of values for the <span class="emphasis"><em>y</em></span> axis. So, how are we going to plot two arrays separately and in a meaningful way?</p><p>Let's start by creating a new Python program using the following lines of code or by opening the <code class="literal">plotCSV.py</code> file <a id="id590" class="indexterm"/>from this chapter's code folder:</p><div class="informalexample"><pre class="programlisting">import csv
from matplotlib import pyplot

i = []
mValues = []
pValues = []

with open('SensorDataStore.csv', 'r') as f:
    reader = csv.reader(f)
    header = next(reader, None)
    for row in reader:
        i.append(int(row[0]))
        pValues.append(float(row[1]))
        if row[2] == 'True':
            mValues.append(1)
        else:
            mValues.append(0)

pyplot.subplot(2, 1, 1)
pyplot.plot(i, pValues, '-')
pyplot.title('Line plot - ' + header[1])
pyplot.xlim([1, 25])
pyplot.xlabel('X Axis')
pyplot.ylabel('Y Axis')

pyplot.subplot(2, 1, 2)
pyplot.bar(i, mValues)
pyplot.title('Bar chart - ' + header[2])
pyplot.xlim([1, 25])
pyplot.xlabel('X Axis')
pyplot.ylabel('Y Axis')

pyplot.tight_layout()

pyplot.show()</pre></div><p>In this program, we <a id="id591" class="indexterm"/>have created two arrays of sensor values—<code class="literal">pValues</code> and <code class="literal">mValues</code>—by reading the <code class="literal">SensorDataStore.csv</code> file row by row. Here, <code class="literal">pValues</code> and <code class="literal">mValues</code> represent the sensor data for the potentiometer and the motion sensor respectively. Once we had these two lists, we plotted them using the <code class="literal">matplotlib</code> methods.</p><p>The <code class="literal">matplotlib</code> library provides various ways to plot different arrays of values. You can individually plot them in two different figures using <code class="literal">figure()</code>, that is, <code class="literal">figure(1)</code> and <code class="literal">figure(2)</code>, or plot both in a single plot in which they overlay each other. The <code class="literal">pyplot</code> method also offers a third meaningful alternative by allowing multiple plots in a <a id="id592" class="indexterm"/>single figure via the <code class="literal">subplot()</code> method:</p><div class="informalexample"><pre class="programlisting">pyplot.subplot(2,1,1)</pre></div><p>This method is <a id="id593" class="indexterm"/>structured as <code class="literal">subplot(nrows, ncols, plot_number)</code>, which creates grids on the figure canvas using row and column numbers, that is, <code class="literal">nrows</code> and <code class="literal">ncols</code> respectively. This method places the plot on the specific cell that is provided by the <code class="literal">plot_number</code> parameter. For example, through <code class="literal">subplot(2, 1, 1)</code>, we created a table of two rows and one column and placed the first subplot in the first cell of the table. Similarly, the next set of values was used for the second subplot and was placed in the second cell, that is, row 2 and column 1:</p><div class="informalexample"><pre class="programlisting">pyplot.subplot(2, 1, 2)</pre></div><p>In the first subplot, we have used the <code class="literal">plot()</code> method to create a plot using the analog value from the potentiometer, that is, <code class="literal">pValues</code>. While in the second subplot, we created a bar chart instead of a line chart to display the digital values from the motion sensor. The bar chart functionality was provided by the <code class="literal">bar()</code> method.</p><p>As you can see in the code snippet, we have utilized an additional <code class="literal">pyplot()</code> method called <code class="literal">xlim()</code>. The <code class="literal">xlim([x_minimum, x_maximum])</code> or <code class="literal">ylim([y_minimum, y_maximum])</code> methods are used to confine the plot between the given maximum and minimum values of the particular axes.</p><p>Before we displayed these subplots in the figure using the <code class="literal">show()</code> method, we used the <code class="literal">tight_layout()</code> function to organize the title and label texts in the figure. The <code class="literal">tight_layout()</code> function is a very important <code class="literal">matplotlib</code> module that nicely fit the subplot parameters in one figure. You can check the effects of this module by commenting that line and running the code again. The following screenshot shows these subplots with labels and a title in one figure object:</p><div class="mediaobject"><img src="graphics/5938OS_06_03.jpg" alt="Plotting data from a CSV file"/></div></div>
<div class="section" title="Plotting real-time Arduino data"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec47"/>Plotting real-time Arduino data</h1></div></div></div><p>In the previous chapter, while dealing with GUI and Arduino data, you must have noticed that the code was updating the interface with every new value that was obtained from <a id="id594" class="indexterm"/>the Arduino sensors. Similarly, in this exercise, we will be redrawing the plot every time we receive new values from Arduino. Basically, we will be plotting and updating a real-time chart instead of plotting the entire set of sensor values as we did in the previous exercise.</p><p>We will be using the same Arduino circuit that you built in the previous exercises. Here, we will utilize only the potentiometer section of the circuit to obtain the analog sensor values. Now, before we explain the new methods used in this exercise, let's first open the program file for this exercise. You can find the program file from this chapter's folder; it is named <code class="literal">plotLive.py</code>. In the code, change the appropriate parameters for the Arduino board and execute the code. While the code is running, rotate the knob of the potentiometer to observe the real-time changes in the plot.</p><p>On running the program, you will get a screen similar to the following screenshot that shows a plot from real-time Arduino data.</p><div class="mediaobject"><img src="graphics/5938OS_06_04.jpg" alt="Plotting real-time Arduino data"/></div><p>One can make <a id="id595" class="indexterm"/>various conclusions about the potentiometer's knob rotation or some other sensor behavior by just looking at the plot. These types of plots are widely used in the graphical dashboard for real-time monitoring applications. Now, let's try to understand the methods that are used in the following code snippet to make this possible.</p><div class="informalexample"><pre class="programlisting">import sys, csv
from matplotlib import pyplot
import pyfirmata
from time import sleep
import numpy as np

# Associate port and board with pyFirmata
port = '/dev/cu.usbmodemfa1321''
board = pyfirmata.Arduino(port)

# Using iterator thread to avoid buffer overflow
it = pyfirmata.util.Iterator(board)
it.start()

# Assign a role and variable to analog pin 0
a0 = board.get_pin(''a:0:i'')

# Initialize interactive mode
pyplot.ion()

pData = [0] * 25
fig = pyplot.figure()
pyplot.title(''Real-time Potentiometer reading'')
ax1 = pyplot.axes()
l1, = pyplot.plot(pData)
pyplot.ylim([0,1])

# real-time plotting loop
while True:
    try:
        sleep(1)
        pData.append(float(a0.read()))
        pyplot.ylim([0, 1])
        del pData[0]
        l1.set_xdata([i for i in xrange(25)])
        l1.set_ydata(pData)  # update the data
        pyplot.draw()  # update the plot
    except KeyboardInterrupt:
        board.exit()
        break</pre></div><p>The real-time <a id="id596" class="indexterm"/>plotting in this exercise is achieved by using a combination of the <code class="literal">pyplot</code> functions <code class="literal">ion()</code>, <code class="literal">draw()</code>, <code class="literal">set_xdata()</code>, and <code class="literal">set_data()</code>. The <code class="literal">ion()</code> method initializes the interactive mode of <code class="literal">pyplot</code>. The interactive mode helps to dynamically change the <span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>y</em></span> values of the plots in the figure:</p><div class="informalexample"><pre class="programlisting">pyplot.ion()</pre></div><p>Once the interactive mode is set to <code class="literal">True</code>, the plot will only be drawn when the <code class="literal">draw()</code> method is called.</p><p>Just like the previous Arduino interfacing exercises, at the beginning of the code, we initialized the Arduino board using <code class="literal">pyFirmata</code> and the setup pins to obtain the sensor values. As you can see in the following line of code, after setting up the Arduino board and <code class="literal">pyplot</code> interactive mode, we initialized the plot with a set of blank data, <code class="literal">0</code> in our case:</p><div class="informalexample"><pre class="programlisting">pData = [0] * 25</pre></div><p>This array for <span class="emphasis"><em>y</em></span> values, <code class="literal">pData</code>, is then used to append values from the sensor in the <code class="literal">while</code> loop. The <code class="literal">while</code> loop keeps appending the newest values to this data array and redraws <a id="id597" class="indexterm"/>the plot with these updated arrays for the <span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>y</em></span> values. In this example, we are appending new sensor values at the end of the array while simultaneously removing the first element of the array to limit the size of the array:</p><div class="informalexample"><pre class="programlisting">pData.append(float(a0.read()))
del pData[0]</pre></div><p>The <code class="literal">set_xdata()</code> and <code class="literal">set_ydata()</code> methods are used to update the <span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>y</em></span> axes data from these arrays. These updated values are plotted using the <code class="literal">draw()</code> method on each iteration of the <code class="literal">while</code> loop:</p><div class="informalexample"><pre class="programlisting">l1.set_xdata([i for i in xrange(25)])
l1.set_ydata(pData)  # update the data
pyplot.draw()  # update the plot</pre></div><p>You will also notice that we are utilizing an <code class="literal">xrange()</code> function to generate a range of values according to the provided length, which is <code class="literal">25</code> in our case. The code snippet, <code class="literal">[i for i in xrange(25)]</code>, will generate a list of 25 integer numbers that start incrementally at 0 and end at 24.</p></div>
<div class="section" title="Integrating plots in the Tkinter window"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec48"/>Integrating plots in the Tkinter window</h1></div></div></div><p>Due to the powerful integration capabilities of Python, it is very convenient to interface the plots generated by the <code class="literal">matplotlib</code> library with the <code class="literal">Tkinter</code> graphical interface. In <a id="id598" class="indexterm"/>the last exercise of the previous chapter, we integrated <code class="literal">Tkinter</code> with <code class="literal">pyFirmata</code> to implement the project of <a class="link" href="ch03.html" title="Chapter 3. The First Project – Motion-triggered LEDs">Chapter 3</a>, <span class="emphasis"><em>The First Project – Motion-triggered LEDs</em></span>, with the GUI. In this exercise, we will extend this integration further by utilizing <code class="literal">matplotlib</code>. We will perform this action by utilizing the same Arduino circuit that we have been using in this chapter and expand the code that we used in the previous exercise. Meanwhile, we are not introducing any new methods in this exercise; instead we will be utilizing what you learned until now. Open the <code class="literal">plotTkinter.py</code> file from this chapter's code folder.</p><p>As mentioned earlier, the program utilizes three major Python libraries and interfaces them with each other to develop an excellent Python-Arduino application. The first interfacing point is between <code class="literal">Tkinter</code> and <code class="literal">matplotlib</code>. As you can see in the following lines of code, we have initialized three button objects, <code class="literal">startButton</code>, <code class="literal">pauseButton</code>, and <code class="literal">exitButton</code>, for the <span class="strong"><strong>Start</strong></span>, <span class="strong"><strong>Pause</strong></span>, and <span class="strong"><strong>Exit</strong></span> buttons respectively:</p><div class="informalexample"><pre class="programlisting">startButton = Tkinter.Button(top,
                             text="Start",
                             command=onStartButtonPress)
startButton.grid(column=1, row=2)
pauseButton = Tkinter.Button(top,
                             text="Pause",
                             command=onPauseButtonPress)
pauseButton.grid(column=2, row=2)
exitButton = Tkinter.Button(top,
                            text="Exit",
                            command=onExitButtonPress)
exitButton.grid(column=3, row=2)</pre></div><p>The <span class="strong"><strong>Start</strong></span> and <span class="strong"><strong>Exit</strong></span> buttons provide control points for <code class="literal">matplotlib</code> operations such as updating<a id="id599" class="indexterm"/> the plot and closing the plot through their respective <code class="literal">onStartButtonPress()</code> and <code class="literal">onExitButtonPress()</code> functions. The <code class="literal">onStartButtonPress()</code> function also consists of the interfacing point between the <code class="literal">matplotlib</code> and <code class="literal">pyFirmata</code> libraries. As you can observe from the following code snippet, we will start updating the plot using the <code class="literal">draw()</code> method and the <code class="literal">Tkinter</code> window using the <code class="literal">update()</code> method for each observation from the analog pin a0, which is obtained using the <code class="literal">read()</code> method:</p><div class="informalexample"><pre class="programlisting">def onStartButtonPress():
    while True:
        if flag.get():
            sleep(1)
            pData.append(float(a0.read()))
            pyplot.ylim([0, 1])
            del pData[0]
            l1.set_xdata([i for i in xrange(25)])
            l1.set_ydata(pData)  # update the data
            pyplot.draw()  # update the plot
            top.update()
        else:
            flag.set(True)
            break</pre></div><p>The <code class="literal">onExitButtonPress()</code> function implements the <code class="literal">exit</code> function as described by the name itself. It closes the <code class="literal">pyplot</code> figure and the <code class="literal">Tkinter</code> window before disengaging the Arduino board from the serial port.</p><p>Now, execute the program after making the appropriate changes to the Arduino port parameter. You should be able to see a window on your screen that is similar to the one displayed in the following screenshot. With this code, you can now control your real-time plots using the <span class="strong"><strong>Start</strong></span> and <span class="strong"><strong>Pause</strong></span> buttons. Click on the <span class="strong"><strong>Start</strong></span> button and start rotating the potentiometer knob. When you click on the <span class="strong"><strong>Pause</strong></span> button, you can observe that the program has stopped plotting new values. While <span class="strong"><strong>Pause</strong></span> is pressed, even rotating the knob will not result in any updates to the plot. </p><p>As soon as you click on the <span class="strong"><strong>Start</strong></span> button again, you will again see the plot get updated with <a id="id600" class="indexterm"/>real-time values, discarding the values generated while paused. Click on the <span class="strong"><strong>Exit</strong></span> button to safely close the program:</p><div class="mediaobject"><img src="graphics/5938OS_06_05.jpg" alt="Integrating plots in the Tkinter window"/></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec49"/>Summary</h1></div></div></div><p>In this chapter, we introduced two major Python programming paradigms: creating, reading, and writing files using Python while also storing data into these files and plotting sensor values and updating plots in real time. We also explored methods to store and plot real-time Arduino sensor data. Besides helping you in your Arduino projects, these methods can also be used in your everyday Python projects. Throughout the chapter, using simple exercises, we interfaced the newly learned CSV and <code class="literal">matplotlib</code> modules with the <code class="literal">Tkinter</code> and <code class="literal">pyFirmata</code> modules that we learned in the previous chapters. In the next chapter, you will be introduced to your second project—a portable unit that measures and displays environmental data such as temperature, humidity, and ambient light. We will be utilizing the concepts that we have learned so far to build this project.</p></div></body></html>